<meta charset="UTF-8"><meta http-equiv="content-type" content="text/html;charset=UTF-8"><meta name="viewport" content="width=600, initial-scale=1"><style>body{max-width:680px;margin:auto;padding:20px;text-align:justify;line-height:140%; -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-smoothing:antialiased;color:#222;font-family:Palatino,Georgia,"Times New Roman",serif}</style><style>@media print{*{-webkit-print-color-adjust:exact;text-shadow:none !important}}body{counter-reset: h1 h2 h3 h4 h5 h6 paragraph}@page{margin:0;size:auto}#mdContextMenu{position:absolute;background:#383838;cursor:default;border:1px solid #999;color:#fff;padding:4px 0px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,"Helvetica Neue",sans-serif;font-size:85%;font-weight:600;border-radius:4px;box-shadow:0px 3px 10px rgba(0,0,0,35%)}#mdContextMenu div{padding:0px 20px}#mdContextMenu div:hover{background:#1659d1}.md code,.md pre{font-family:Menlo,Consolas,monospace;font-size:98%;text-align:left;line-height:140%}.md .mediumToc code,.md longToc code,.md .shortToc code,.md h1 code,.md h2 code,.md h3 code,.md h4 code,.md h5 code,.md h6 code{font-size:unset}.md div.title{font-size:26px;font-weight:800;line-height:120%;text-align:center}.md div.afterTitles{height:10px}.md div.subtitle{text-align:center}.md iframe.textinsert, .md object.textinsert,.md iframe:not(.markdeep){display:block;margin-top:10px;margin-bottom:10px;width:100%;height:75vh;border:1px solid #000;border-radius:4px;background:#f5f5f4}.md .image{display:inline-block}.md img{max-width:100%;page-break-inside:avoid}.md li{text-align:left;text-indent:0}.md pre.listing {width:100%;tab-size:4;-moz-tab-size:4;-o-tab-size:4;counter-reset:line;overflow-x:auto;resize:horizontal}.md pre.listing .linenumbers span.line:before{width:30px;margin-left:-28px;font-size:80%;text-align:right;counter-increment:line;content:counter(line);display:inline-block;padding-right:13px;margin-right:8px;color:#ccc}.md div.tilde{margin:20px 0 -10px;text-align:center}.md .imagecaption,.md .tablecaption,.md .listingcaption{display:inline-block;margin:7px 5px 12px;text-align:justify;font-style:italic}.md img.pixel{image-rendering:-moz-crisp-edges;image-rendering:pixelated}.md blockquote.fancyquote{margin:25px 0 25px;text-align:left;line-height:160%}.md blockquote.fancyquote::before{content:"“";color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-right:6px;vertical-align:-0.3em}.md span.fancyquote{font-size:118%;color:#777;font-style:italic}.md span.fancyquote::after{content:"”";font-style:normal;color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-left:6px;vertical-align:-0.3em}.md blockquote.fancyquote .author{width:100%;margin-top:10px;display:inline-block;text-align:right}.md small{font-size:60%}.md big{font-size:150%}.md div.title,contents,.md .tocHeader,.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .shortTOC,.md .mediumTOC,.nonumberh1,.nonumberh2,.nonumberh3,.nonumberh4,.nonumberh5,.nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;margin:13.4px 0 13.4px;padding:15px 0 3px;border-top:none;clear:both}.md .tocTop {display:none}.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .nonumberh1,.md .nonumberh2,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{page-break-after:avoid;break-after:avoid}.md svg.diagram{display:block;font-family:Menlo,Consolas,monospace;font-size:98%;text-align:center;stroke-linecap:round;stroke-width:2px;page-break-inside:avoid;stroke:#000;fill:#000}.md svg.diagram .opendot{fill:#fff}.md svg.diagram .shadeddot{fill:#CCC}.md svg.diagram .dotteddot{stroke:#000;stroke-dasharray:4;fill:none}.md svg.diagram text{stroke:none}@media print{@page{margin:1in 5mm;transform: scale(150%)}}@media print{.md .pagebreak{page-break-after:always;visibility:hidden}}.md a{font-family:Georgia,Palatino,'Times New Roman'}.md h1,.md .tocHeader,.md .nonumberh1{border-bottom:3px solid;font-size:20px;font-weight:bold;}.md h1,.md .nonumberh1{counter-reset: h2 h3 h4 h5 h6}.md h2,.md .nonumberh2{counter-reset: h3 h4 h5 h6;border-bottom:2px solid #999;color:#555;font-weight:bold;font-size:18px;}.md h3,.md h4,.md h5,.md h6,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;color:#555;font-size:16px;}.md h3{counter-reset:h4 h5 h6}.md h4{counter-reset:h5 h6}.md h5{counter-reset:h6}.md div.table{margin:16px 0 16px 0}.md table{border-collapse:collapse;line-height:140%;page-break-inside:avoid}.md table.table{margin:auto}.md table.calendar{width:100%;margin:auto;font-size:11px;font-family:Verdana,Helvetica,Arial,sans-serif}.md table.calendar th{font-size:16px}.md .today{background:#ECF8FA}.md .calendar .parenthesized{color:#999;font-style:italic}.md table.table th{color:#FFF;background-color:#AAA;border:1px solid #888;padding:8px 15px 8px 15px}.md table.table td{padding:5px 15px 5px 15px;border:1px solid #888}.md table.table tr:nth-child(even){background:#EEE}.md pre.tilde{border-top: 1px solid #CCC;border-bottom: 1px solid #CCC;padding: 5px 0 5px 20px;margin:0 0 0 0;background:#FCFCFC;page-break-inside:avoid}.md a.target{width:0px;height:0px;visibility:hidden;font-size:0px;display:inline-block}.md a:link, .md a:visited{color:#38A;text-decoration:none}.md a:link:hover{text-decoration:underline}.md dt{font-weight:700}.md dl>dd{margin-top:-8px; margin-bottom:8px}.md dl>table{margin:35px 0 30px}.md code{page-break-inside:avoid;} @media print{.md .listing code{white-space:pre-wrap}}.md .endnote{font-size:13px;line-height:15px;padding-left:10px;text-indent:-10px}.md .bib{padding-left:80px;text-indent:-80px;text-align:left}.markdeepFooter{font-size:9px;text-align:right;padding-top:80px;color:#999}.md .mediumTOC{float:right;font-size:12px;line-height:15px;border-left:1px solid #CCC;padding-left:15px;margin:15px 0px 15px 25px}.md .mediumTOC .level1{font-weight:600}.md .longTOC .level1{font-weight:600;display:block;padding-top:12px;margin:0 0 -20px}.md .shortTOC{text-align:center;font-weight:bold;margin-top:15px;font-size:14px}.md .admonition{position:relative;margin:1em 0;padding:.4rem 1rem;border-radius:.2rem;border-left:2.5rem solid rgba(68,138,255,.4);background-color:rgba(68,138,255,.15);}.md .admonition-title{font-weight:bold;border-bottom:solid 1px rgba(68,138,255,.4);padding-bottom:4px;margin-bottom:4px;margin-left: -1rem;padding-left:1rem;margin-right:-1rem;border-color:rgba(68,138,255,.4)}.md .admonition.tip{border-left:2.5rem solid rgba(50,255,90,.4);background-color:rgba(50,255,90,.15)}.md .admonition.tip::before{content:"\24d8";font-weight:bold;font-size:150%;position:relative;top:3px;color:rgba(26,128,46,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.tip>.admonition-title{border-color:rgba(50,255,90,.4)}.md .admonition.warn,.md .admonition.warning{border-left:2.5rem solid rgba(255,145,0,.4);background-color:rgba(255,145,0,.15)}.md .admonition.warn::before,.md .admonition.warning::before{content:"\26A0";font-weight:bold;font-size:150%;position:relative;top:2px;color:rgba(128,73,0,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.warn>.admonition-title,.md .admonition.warning>.admonition-title{border-color:rgba(255,145,0,.4)}.md .admonition.error{border-left: 2.5rem solid rgba(255,23,68,.4);background-color:rgba(255,23,68,.15)}.md .admonition.error>.admonition-title{border-color:rgba(255,23,68,.4)}.md .admonition.error::before{content: "\2612";font-family:"Arial";font-size:200%;position:relative;color:rgba(128,12,34,.8);top:-2px;left:-3rem;display:block;width:0;height:0}.md .admonition p:last-child{margin-bottom:0}.md li.checked,.md li.unchecked{list-style:none;overflow:visible;text-indent:-1.2em}.md li.checked:before,.md li.unchecked:before{content:"\2611";display:block;float:left;width:1em;font-size:120%}.md li.unchecked:before{content:"\2610"}</style><style>.md h1::before {
content:counter(h1) " ";
counter-increment: h1;margin-right:10px}.md h2::before {
content:counter(h1) "."counter(h2) " ";
counter-increment: h2;margin-right:10px}.md h3::before {
content:counter(h1) "."counter(h2) "."counter(h3) " ";
counter-increment: h3;margin-right:10px}.md h4::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) " ";
counter-increment: h4;margin-right:10px}.md h5::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) " ";
counter-increment: h5;margin-right:10px}.md h6::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) "."counter(h6) " ";
counter-increment: h6;margin-right:10px}</style><style>.hljs{display:block;overflow-x:auto;padding:0.5em;background:#fff;color:#000;-webkit-text-size-adjust:none}.hljs-comment{color:#006a00}.hljs-keyword{color:#02E}.hljs-literal,.nginx .hljs-title{color:#aa0d91}.method,.hljs-list .hljs-title,.hljs-tag .hljs-title,.setting .hljs-value,.hljs-winutils,.tex .hljs-command,.http .hljs-title,.hljs-request,.hljs-status,.hljs-name{color:#008}.hljs-envvar,.tex .hljs-special{color:#660}.hljs-string{color:#c41a16}.hljs-tag .hljs-value,.hljs-cdata,.hljs-filter .hljs-argument,.hljs-attr_selector,.apache .hljs-cbracket,.hljs-date,.hljs-regexp{color:#080}.hljs-sub .hljs-identifier,.hljs-pi,.hljs-tag,.hljs-tag .hljs-keyword,.hljs-decorator,.ini .hljs-title,.hljs-shebang,.hljs-prompt,.hljs-hexcolor,.hljs-rule .hljs-value,.hljs-symbol,.hljs-symbol .hljs-string,.hljs-number,.css .hljs-function,.hljs-function .hljs-title,.coffeescript .hljs-attribute{color:#A0C}.hljs-function .hljs-title{font-weight:bold;color:#000}.hljs-class .hljs-title,.smalltalk .hljs-class,.hljs-type,.hljs-typename,.hljs-tag .hljs-attribute,.hljs-doctype,.hljs-class .hljs-id,.hljs-built_in,.setting,.hljs-params,.clojure .hljs-attribute{color:#5c2699}.hljs-variable{color:#3f6e74}.css .hljs-tag,.hljs-rule .hljs-property,.hljs-pseudo,.hljs-subst{color:#000}.css .hljs-class,.css .hljs-id{color:#9b703f}.hljs-value .hljs-important{color:#ff7700;font-weight:bold}.hljs-rule .hljs-keyword{color:#c5af75}.hljs-annotation,.apache .hljs-sqbracket,.nginx .hljs-built_in{color:#9b859d}.hljs-preprocessor,.hljs-preprocessor *,.hljs-pragma{color:#643820}.tex .hljs-formula{background-color:#eee;font-style:italic}.diff .hljs-header,.hljs-chunk{color:#808080;font-weight:bold}.diff .hljs-change{background-color:#bccff9}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-comment .hljs-doctag{font-weight:bold}.method .hljs-id{color:#000}</style><style>div.title { padding-top: 40px; } div.afterTitles { height: 15px; }</style><meta charset="utf-8">
<link rel="stylesheet" href="../css/style.css">

<script type="text/x-mathjax-config">MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });</script><span style="display:none">$$\newcommand{\n}{\hat{n}}\newcommand{\thetai}{\theta_\mathrm{i}}\newcommand{\thetao}{\theta_\mathrm{o}}\newcommand{\d}[1]{\mathrm{d}#1}\newcommand{\w}{\hat{\omega}}\newcommand{\wi}{\w_\mathrm{i}}\newcommand{\wo}{\w_\mathrm{o}}\newcommand{\wh}{\w_\mathrm{h}}\newcommand{\Li}{L_\mathrm{i}}\newcommand{\Lo}{L_\mathrm{o}}\newcommand{\Le}{L_\mathrm{e}}\newcommand{\Lr}{L_\mathrm{r}}\newcommand{\Lt}{L_\mathrm{t}}\newcommand{\O}{\mathrm{O}}\newcommand{\degrees}{{^{\large\circ}}}\newcommand{\T}{\mathsf{T}}\newcommand{\mathset}[1]{\mathbb{#1}}\newcommand{\Real}{\mathset{R}}\newcommand{\Integer}{\mathset{Z}}\newcommand{\Boolean}{\mathset{B}}\newcommand{\Complex}{\mathset{C}}\newcommand{\un}[1]{\,\mathrm{#1}}$$
</span>
<span class="md"><p><title>Day 9. Variable-Pitch Sine Wave Output</title><div class="title"> Day 9. Variable-Pitch Sine Wave Output </div>

<div class="afterTitles"></div>
<em class="underscore">Video Length (includig Q&A): <a href="https://hero.handmade.network/episode/code/day009/">2h03</a></em>

</p><p>

Welcome to &ldquo;Handmade Hero Notes&rdquo;, the book where we follow the footsteps of <a href="https://handmadehero.org/">Handmade Hero</a> in making the complete game from scratch, with now external libraries. If you'd like to follow along, preorder the game on <a href="https://handmadehero.org/">handmadehero.org</a>, and you will receive access to the GitHub repository, containing complete source code (tagged day-by-day) as well as a variety of other useful resources.

</p><p>

Today we are going to be finishing our sound program. We'll need to have another go at the sound output code that we made: inspect it, and make sure we don't have bugs in there. As we already mentioned, DirectSound is a bit finicky the way you have to use it, so some double-checking is in place. 

</p>
<div class="longTOC"><p align="center">
    <span align="right"><a href="day8.html">Day 8</a></span>
    <a href="../index.html"><img src = "../media/logo.png"></a>
    <span align="left"><a href="day10.html">Day 10</a></span>
</p><p><a href="#" class="tocTop">(Top)</a><br/>
<a href="#reviewwritingtodirectsound" class="level1"><span class="tocNumber">1&nbsp; </span>Review Writing to DirectSound</a><br/>
&nbsp;&nbsp;<a href="#reviewwritingtodirectsound/startplayingafterfillingoutthebuffer" class="level2"><span class="tocNumber">1.1&nbsp; </span>Start Playing after Filling out the Buffer</a><br/>
&nbsp;&nbsp;<a href="#reviewwritingtodirectsound/aboutdebuggingsound" class="level2"><span class="tocNumber">1.2&nbsp; </span>About Debugging Sound</a><br/>
&nbsp;&nbsp;<a href="#reviewwritingtodirectsound/debugcursorposition" class="level2"><span class="tocNumber">1.3&nbsp; </span>Debug Cursor Position</a><br/>
<a href="#generateasinewave" class="level1"><span class="tocNumber">2&nbsp; </span>Generate a Sine Wave</a><br/>
&nbsp;&nbsp;<a href="#generateasinewave/startworkingwiththefloatingpointmath" class="level2"><span class="tocNumber">2.1&nbsp; </span>Start Working with the Floating Point Math</a><br/>
&nbsp;&nbsp;<a href="#generateasinewave/modifysamplesgeneration" class="level2"><span class="tocNumber">2.2&nbsp; </span>Modify Samples Generation</a><br/>
&nbsp;&nbsp;<a href="#generateasinewave/calculatet" class="level2"><span class="tocNumber">2.3&nbsp; </span>Calculate <code>t</code></a><br/>
<a href="#deepsounddebugging" class="level1"><span class="tocNumber">3&nbsp; </span>Deep Sound Debugging</a><br/>
&nbsp;&nbsp;<a href="#deepsounddebugging/verifythesinewave" class="level2"><span class="tocNumber">3.1&nbsp; </span>Verify the Sine Wave</a><br/>
&nbsp;&nbsp;<a href="#deepsounddebugging/stepthroughthecode" class="level2"><span class="tocNumber">3.2&nbsp; </span>Step Through the Code</a><br/>
&nbsp;&nbsp;<a href="#deepsounddebugging/refactorthecode" class="level2"><span class="tocNumber">3.3&nbsp; </span>Refactor the Code</a><br/>
<a href="#linkthepitchtouserinput" class="level1"><span class="tocNumber">4&nbsp; </span>Link the Pitch to User Input</a><br/>
&nbsp;&nbsp;<a href="#linkthepitchtouserinput/straightupchange" class="level2"><span class="tocNumber">4.1&nbsp; </span>Straight Up Change</a><br/>
&nbsp;&nbsp;<a href="#linkthepitchtouserinput/storepositioninthesinewave" class="level2"><span class="tocNumber">4.2&nbsp; </span>Store Position in the Sine Wave</a><br/>
&nbsp;&nbsp;<a href="#linkthepitchtouserinput/mapthepitchtothesticks" class="level2"><span class="tocNumber">4.3&nbsp; </span>Map the Pitch to the Sticks</a><br/>
&nbsp;&nbsp;<a href="#linkthepitchtouserinput/lowerthelatency" class="level2"><span class="tocNumber">4.4&nbsp; </span>Lower the Latency</a><br/>
<a href="#recap" class="level1"><span class="tocNumber">5&nbsp; </span>Recap</a><br/>
<a href="#exercises" class="level1"><span class="tocNumber">6&nbsp; </span>Exercises</a><br/>
&nbsp;&nbsp;<a href="#exercises/mapthetonechangetokeyboard" class="level2"><span class="tocNumber">6.1&nbsp; </span>Map the Tone Change to Keyboard</a><br/>
<a href="#programmingnotions" class="level1"><span class="tocNumber">7&nbsp; </span>Programming Notions</a><br/>
&nbsp;&nbsp;<a href="#programmingnotions/introtofloatingpoint" class="level2"><span class="tocNumber">7.1&nbsp; </span>Intro to Floating Point</a><br/>
<a href="#sideconsiderations" class="level1"><span class="tocNumber">8&nbsp; </span>Side Considerations</a><br/>
&nbsp;&nbsp;<a href="#sideconsiderations/thefirstgamejam" class="level2"><span class="tocNumber">8.1&nbsp; </span>The First Game Jam</a><br/>
&nbsp;&nbsp;<a href="#sideconsiderations/bitshiftingandregisters" class="level2"><span class="tocNumber">8.2&nbsp; </span>Bit Shifting and Registers</a><br/>
&nbsp;&nbsp;<a href="#sideconsiderations/fix:deadzoneforcontrollersticks" class="level2"><span class="tocNumber">8.3&nbsp; </span>Fix: Dead Zone for Controller Sticks</a><br/>
<a href="#navigation" class="level1"><span class="tocNumber">9&nbsp; </span>Navigation</a><br/>
</p></div><a class="target" name="reviewwritingtodirectsound">&nbsp;</a><a class="target" name="reviewwritingtodirectsound">&nbsp;</a><a class="target" name="toc1">&nbsp;</a><h1>Review Writing to DirectSound</h1>
<p>


As you remember, we learned how to <em class="underscore">lock</em> our (secondary) DirectSound buffer, basically meaning that we asked DirectSound to write into it to update the contents that's being outputted by the sound card. At the end of it, we were <em class="underscore">unlocking</em> the buffer back, allowing DirectSound to play. 

</p>
<a class="target" name="startplayingafterfillingoutthebuffer">&nbsp;</a><a class="target" name="reviewwritingtodirectsound/startplayingafterfillingoutthebuffer">&nbsp;</a><a class="target" name="toc1.1">&nbsp;</a><h2>Start Playing after Filling out the Buffer</h2>
<p>


One thing that would be logical is starting to play after we filled our buffer for the first time. Right now, we're playing from the program start, immediately after we initialized DirectSound:

</p><pre class="listing tilde"><code><span class="line">Win32InitDSound(Window, SamplesPerSecond, SamplesPerSecond * <span class="hljs-number">2</span> * BytesPerSample);</span>
<span class="line">GlobalSecondaryBuffer-&gt;Play(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, DSBPLAY_LOOPING);</span></code></pre><p>

You'll notice that this results in a delay before your sound starts playing. Let's introduce a boolean that checks if sound is playing and, if not, start playing! 

</p><pre class="listing tilde"><code><span class="line">Win32InitDSound(Window, SamplesPerSecond, SamplesPerSecond * <span class="hljs-number">2</span> * BytesPerSample);</span><div class=" delete"><span class="line">GlobalSecondaryBuffer-&gt;Play(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, DSBPLAY_LOOPING);</span></div><div class=" add"><span class="line">b32 SoundIsPlaying = <span class="hljs-literal">false</span>;</span></div><span class="line"><span class="hljs-comment">// ... </span></span>
<span class="line"><span class="hljs-keyword">if</span>(SUCCEEDED(GlobalSecondaryBuffer-&gt;GetCurrentPosition(&amp;PlayCursor, &amp;WriteCursor)))</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-keyword">if</span>(SUCCEEDED(GlobalSecondaryBuffer-&gt;Lock(...)))</span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// Writing our samples</span></span>
<span class="line">        <span class="hljs-comment">// ... </span></span>
<span class="line">        GlobalSecondaryBuffer-&gt;Unlock(...);</span>
<span class="line">    }</span>
<span class="line">}</span><div class=" add"><span class="line"><span class="hljs-keyword">if</span> (!SoundIsPlaying)</span>
<span class="line">{</span>
<span class="line">    GlobalSecondaryBuffer-&gt;Play(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, DSBPLAY_LOOPING);</span>
<span class="line">    SoundIsPlaying = <span class="hljs-literal">true</span>;</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;1:</b> <file>[win32_handmade.cpp > WinMain]</file> Starting playing with a shorter delay.</div></center>

<a class="target" name="aboutdebuggingsound">&nbsp;</a><a class="target" name="reviewwritingtodirectsound/aboutdebuggingsound">&nbsp;</a><a class="target" name="toc1.2">&nbsp;</a><h2>About Debugging Sound</h2>
<p>


Another issue that we have is that <em class="underscore">square wave</em> is a rather harsh wave. It's a bit harder if there any any bugs in the sound output, so today we're going to implement another wave: a sine wave! 

</p><p>

The sound is an extremely finicky thing, and it might be very hard to find bugs in it, even to realize that there are. Here is a story to illustrate the point. You can read it in its entirety in subsection  <a href="#toc8.1">8.1</a>, but the gist of it is the following: you would be surprised at how much variance there is in the sound that comes out from speakers or headphones when you plug them in. The more &ldquo;pure&rdquo;, responsive to frequency headphones might yield you a world of a difference and show you the bugs and artifacts that on a different hardware you might miss entirely.

</p><p>

In the code that we've written yesterday there's a <em class="underscore">lot</em> of moving parts, things that we have to think about. It might be complex approaching the sound debugging. Let's look at what we're doing again. When we come through our program the first time, we:

</p><p>

<ol start=1>
<li class="number">Initialize DirectSound and create the sound buffer.
</li>
<li class="number">Give the sound buffer something to output. 
</li>
<li class="number">Start Playing.</li></ol>

</p><p>

This means that the play cursor (the thing that we are &ldquo;chasing&rdquo;), starts moving through the buffer and, as it moves, send to DirectSound whatever it finds in that buffer.

</p>
<a class="target" name="debugcursorposition">&nbsp;</a><a class="target" name="reviewwritingtodirectsound/debugcursorposition">&nbsp;</a><a class="target" name="toc1.3">&nbsp;</a><h2>Debug Cursor Position</h2>
<p>


So where do we start? Let's look at the very beginning and look at our <code>ByteToLock</code> and <code>BytesToWrite</code> calculations.

</p><p>

Right now, we're comparing whether the <code>ByteToLock</code> is greater or not the <code>PlayCursor</code>. This means that, if both are at <code>0</code>, the <code>BytesToWrite</code> will be <code>0</code> as well. We could simply say that, if <code>ByteToLock</code> and the <code>PlayCursor</code> are both equal, <code>BytesToWrite</code> would amount to the whole buffer (i.e. <code>SecondaryBufferSize</code>). However, our <code>RunningSampleIndex</code> would have advanced through the whole buffer, and we'd end up at the same place again on our next loop. 

</p><p>

We'd have to fill the buffer again, which is totally wrong, since the buffer only now started playing. We could well be on a system which has an inaccurate play cursor position. 

</p><p>

What is the play cursor, anyway? 

</p><p>

The play cursor is an <em class="underscore">estimate</em> of where the sound card is playing the sound on the speakers. However, we don't know the details on how this amount is computed. This highly depends on what the sound output chip on your computer, what the drivers are doing, and many other factors. We have no idea what's going on here. Of course, today the updates probably happen much more frequently than it was back in the day, but it's still possible that the play cursor doesn't advance before our next iteration. 

</p><p>

We'll probably eventually need to write something more intelligent that would keep track of whether the PlayCursor advanced or not. And say something like &ldquo;don't take any action until you see that cursor move&rdquo;. For now, let's simply add the lines we mentioned with a little TODO for posterity:

</p><pre class="listing tilde"><code><span class="line">DWORD ByteToLock = (RunningSampleIndex * BytesPerSample) % SecondaryBufferSize;</span>
<span class="line">DWORD BytesToWrite;</span><div class=" add"><span class="line"><span class="hljs-comment">// TODO(casey): We need a more accurate check than ByteToLock == PlayCursor</span></span>
<span class="line"><span class="hljs-keyword">if</span> (ByteToLock == PlayCursor)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// Play cursor is at the same spot</span></span>
<span class="line">    BytesToWrite = SecondaryBufferSize;</span>
<span class="line">}</span></div><div class=" edit"><span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(ByteToLock &gt; PlayCursor)</span></div><span class="line">{</span>
<span class="line">    <span class="hljs-comment">// Play cursor is behind</span></span>
<span class="line">    BytesToWrite = SecondaryBufferSize - ByteToLock; <span class="hljs-comment">// region 1</span></span>
<span class="line">    BytesToWrite += PlayCursor;                      <span class="hljs-comment">// region 2</span></span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span></span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// Play cursor is in front</span></span>
<span class="line">    BytesToWrite = PlayCursor - ByteToLock;          <span class="hljs-comment">// region 1</span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;2:</b> <file>[win32_handmade.cpp > WinMain]</file> Updating <code>BytesToWrite</code> calculations.</div></center>

<a class="target" name="generateasinewave">&nbsp;</a><a class="target" name="generateasinewave">&nbsp;</a><a class="target" name="toc2">&nbsp;</a><h1>Generate a Sine Wave</h1>
<p>


We've already said it several times: square wave is sure is a simple wave, but it's not a good wave for hearing errors. And you can see just by looking at it: it's completely harsh cut, which is quite unnatural. It's not something that you are really going to see in the real world. Sound is a lot smoother normally, and we don't intuitively know what this should sound like. 

</p><p>

We're going to implement a <a href="https://en.wikipedia.org/wiki/Sine_wave">sine wave</a> instead. A sine wave should be familiar for many: it's a smooth continuous wave oscillating between its minimum and maximum indefinitely. A good sine wave sounds as a clear, pure tone to a human ear, with no harmonics. A perfect tone with no noise or harshness. So switching to a sine wave will allow us to have a much easier time in finding the errors in our sound output.

</p><p>

<center><div class="image" style=""><a href="../media/day9/sine.png" target="_blank"><img class="markdeep" src="../media/day9/sine.png" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;1:</b> A Sine Wave.</span></center></div></center>

</p><p>

In order to transition away from the square wave, let's rename the references to it in our code: <code>SquareWavePeriod</code> will become <code>WavePeriod</code>, while <code>HalfSquareWavePeriod</code> to <code>HalfWavePeriod</code>. We leave the actual renaming as the exercise for the reader.

</p>
<a class="target" name="startworkingwiththefloatingpointmath">&nbsp;</a><a class="target" name="generateasinewave/startworkingwiththefloatingpointmath">&nbsp;</a><a class="target" name="toc2.1">&nbsp;</a><h2>Start Working with the Floating Point Math</h2>
<p>


For the purposes of testing, let's add a <code>math.h</code> library. The math functions to calculate things like sine, cosine, tangent, etc., functions that are built into C Runtime Library. Sometimes they are even built into the CPU! However, not all of of these functions are built into the CPU, plus we said over and over again that we are not going to use any libraries. So eventually we want to reach to a point to implement some of these on our own. It might be a <em class="underscore">bit</em> of an overkill though, we'll see.

</p><p>

So, at the moment, since we're using that sine function and that's all test code, we'll add in the <code>math.h</code> library. We can also add a TODO to get rid of it eventually: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;xinput.h&gt;</span></span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dsound.h&gt;</span></span></span><div class=" add"><span class="line"><span class="hljs-comment">// TODO(casey): Implement sine ourselves</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;math.h&gt;</span></span></span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;3:</b> <file>[win32_handmade.cpp]</file> Including the math library.</div></center>
<p>




<div class="admonition tip">When you're working on a specific platform, always use whatever that platform gives to get your test code up and running. That is always fine, and in general using libraries is fine, too. 

</p><p>

    The purpose of this course is not to prevent people from using libraries. We aren't using any to show how everything's done, and how to build your own stuff</div>

</p><p>

The functions in <code>math.h</code> mostly operate on the <a href="https://en.wikipedia.org/wiki/Floating-point_arithmetic">floating point numbers</a>. This will be the first time we'll see them on this course. If you're unfamiliar with how floating point numbers work or want a refresher, please read <a href="#introtofloatingpoint">Intro to Floating Point</a> subsection. 

</p><p>

For our convenience, let's add a type definition for <code>float</code> and <code>double</code> to our types so that we can start thinking about them in terms of their size in bits: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int8_t</span> s8;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int16_t</span> s16;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int32_t</span> s32;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int64_t</span> s64;</span>
<span class="line"><span class="hljs-keyword">typedef</span> s32 b32;</span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint8_t</span> u8;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint16_t</span> u16;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint32_t</span> u32;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint64_t</span> u64;</span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">float</span> f32;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">double</span> f64;</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;4:</b> <file>[win32_handmade.cpp]</file> Defining floating point types.</div></center>

<a class="target" name="modifysamplesgeneration">&nbsp;</a><a class="target" name="generateasinewave/modifysamplesgeneration">&nbsp;</a><a class="target" name="toc2.2">&nbsp;</a><h2>Modify Samples Generation</h2>
<p>


Right now, we have the following code to generate our samples: 

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line"><span class="hljs-symbol">s16</span> *SampleOut = (<span class="hljs-built_in">s16</span> *)Region1<span class="hljs-comment">;</span></span>
<span class="line"><span class="hljs-symbol">DWORD</span> Region1SampleCount = Region1Size / <span class="hljs-keyword">BytesPerSample;</span>
<span class="line"></span><span class="hljs-symbol">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span><span class="hljs-comment">;</span></span>
<span class="line">        SampleIndex &lt; Region1SampleCount<span class="hljs-comment">;</span></span>
<span class="line">        ++SampleIndex)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-built_in">s16</span> SampleValue = ((RunningSampleIndex++ / HalfWavePeriod) % <span class="hljs-number">2</span>) ?  ToneVolume : - ToneVolume<span class="hljs-comment">;</span></span>
<span class="line">    </span>
<span class="line">    *SampleOut++ = SampleValue<span class="hljs-comment">;</span></span>
<span class="line">    *SampleOut++ = SampleValue<span class="hljs-comment">;</span></span>
<span class="line">}</span>
<span class="line"></span>
<span class="line"><span class="hljs-symbol">SampleOut</span> = (<span class="hljs-built_in">s16</span> *)Region2<span class="hljs-comment">;</span></span>
<span class="line"><span class="hljs-symbol">DWORD</span> Region2SampleCount = Region2Size / <span class="hljs-keyword">BytesPerSample;</span>
<span class="line"></span><span class="hljs-symbol">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span><span class="hljs-comment">;</span></span>
<span class="line">        SampleIndex &lt; Region2SampleCount<span class="hljs-comment">;</span></span>
<span class="line">        ++SampleIndex)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-built_in">s16</span> SampleValue = ((RunningSampleIndex++ / HalfWavePeriod) % <span class="hljs-number">2</span>) ?  ToneVolume : - ToneVolume<span class="hljs-comment">;</span></span>
<span class="line">    </span>
<span class="line">    *SampleOut++ = SampleValue<span class="hljs-comment">;</span></span>
<span class="line">    *SampleOut++ = SampleValue<span class="hljs-comment">;</span></span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;5:</b> <file>[win32_handmade.cpp > WinMain]</file> The state of our sample writing code. If you made the exercises for <a href="day8.html">day 8</a>, you'll have them in a separate function.</div></center>
<p>


We need to change how we generate our <code>SampleValue</code>, that is currently calculating our square wave. In order to generate the sine wave we'll need to use the Sine function.

</p><p>

If you remember from your trigonometry classes, the Sine function works by taking an angle (usually expressed in radians) and returning a <em class="underscore">real number</em> from <code>-1</code> to <code>1</code>. Obviously, an integer that can be <code>-1</code>, <code>0</code> or <code>1</code>, with nothing in between, wouldn't be very useful here. We need all those values in between to generate a nice sine wave. Of course, you could take the values from ~<code>-2,000,000,000</code> to ~<code>2,000,000,000</code> (the approximate range of a signed 32-bit integer) and do some mathy things to get the same result, but since <code>math.h</code> is usually used in the scientific environment, it's usually implemented straight in the floating point numbers directly. That's what we're going to do.

</p><p>

<code>Math.h</code> offers <a href="https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/sin-sinf-sinl?view=vs-2019">several functions</a> to calculate a Sine. There's <code>sinf</code> which takes a <code>float</code> (<code>f32</code>) and returns a <code>float</code>. There's <code>sin</code> which takes a <code>double</code> (<code>f64</code>) and returns a <code>double</code>. There's even <code>sinl</code> which takes a <code>long double</code> and returns it, although size and precision-wise in MSVC compiler it's the same as <code>double</code>. 

</p><p>

We will almost never use 64-bit floating-point numbers in our game. Whenever we'll be using floating-point numbers, speed will be of the essence, and double-precision numbers are always slower than single-precision ones. Even with the modern processors, it only makes sense using <code>double</code>s when you <em class="underscore">know</em> you need that extra precision. In case of our sine wave (and in most cases in general) you don't. 

</p><p>

So we're going to call <code>sinf</code>. For simplicity for now, let's say that we're going to be in some &ldquo;SinePosition&rdquo; when we'll be writing the <code>SampleValue</code>. In math, the running time value is usually designated with the letter <code>t</code>, and we'll need to compute whatever that is, and we'll return to it in a second. 

</p><p>

Now, as we said above, <code>sinf</code> returns a sine value between <code>-1</code> and <code>1</code>. We however want it to be between <code>-ToneVolume</code> and <code>ToneVolume</code>. So what we'll need to do is to <em class="underscore">cast</em> to an <code>s16</code> our <code>SineValue</code> multipled by <code>ToneVolume</code>. This will <em class="underscore">scale</em> our sine to the desired volume in the 16-bit space and will result in our <code>SampleValue</code>. 

</p><p>

Again, as we were saying last time, <code>Region1</code> and <code>Region2</code> calculations are identical, so we'll need to repeat it twice.

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line"><span class="hljs-symbol">s16</span> *SampleOut = (<span class="hljs-built_in">s16</span> *)Region1<span class="hljs-comment">;</span></span>
<span class="line"><span class="hljs-symbol">DWORD</span> Region1SampleCount = Region1Size / <span class="hljs-keyword">BytesPerSample;</span>
<span class="line"></span><span class="hljs-symbol">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span><span class="hljs-comment">;</span></span>
<span class="line">        SampleIndex &lt; Region1SampleCount<span class="hljs-comment">;</span></span>
<span class="line">        ++SampleIndex)</span>
<span class="line">{</span></div><div class=" add"><span class="line">    f32 t = ; <span class="hljs-comment">// TODO!</span></span>
<span class="line">    f32 SineValue = sinf(t);</span>
<span class="line">    s16 SampleValue = SineValue * ToneVolume;</span></div><div class=" delete"><span class="line">    s16 SampleValue = ((RunningSampleIndex++ / HalfWavePeriod) % <span class="hljs-number">2</span>) ?  ToneVolume : - ToneVolume;</span></div><span class="line">    </span>
<span class="line">    *SampleOut++ = SampleValue;</span>
<span class="line">    *SampleOut++ = SampleValue;</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">SampleOut = (s16 *)Region2;</span>
<span class="line">DWORD Region2SampleCount = Region2Size / BytesPerSample;</span>
<span class="line"><span class="hljs-keyword">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line">        SampleIndex &lt; Region2SampleCount;</span>
<span class="line">        ++SampleIndex)</span>
<span class="line">{</span><div class=" add"><span class="line">    f32 t = ; <span class="hljs-comment">// TODO!</span></span>
<span class="line">    f32 SineValue = sinf(t);</span>
<span class="line">    s16 SampleValue = SineValue * ToneVolume;</span></div><div class=" delete"><span class="line">    s16 SampleValue = ((RunningSampleIndex++ / HalfWavePeriod) % <span class="hljs-number">2</span>) ?  ToneVolume : - ToneVolume;</span></div><span class="line">    </span>
<span class="line">    *SampleOut++ = SampleValue;</span>
<span class="line">    *SampleOut++ = SampleValue;</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;6:</b> <file>[win32_handmade.cpp > WinMain]</file> Calculating the Sample Value.</div></center>

<a class="target" name="calculatet">&nbsp;</a><a class="target" name="generateasinewave/calculatet">&nbsp;</a><a class="target" name="toc2.3">&nbsp;</a><h2>Calculate <code>t</code></h2>
<p>


In order to calculate <code>t</code> for the wave, we'll need to use our <code>RunningSampleIndex</code> which just keeps going up and up and up. Since we know that the period of a sine wave is always \(2\pi\), we multiply this value by our <code>RunningSampleIndex</code> and then divide it by our desired <code>WavePeriod</code> to get the final <code>t</code>.

</p><p>

<center><div class="image" style=""><a href="../media/day9/Sine_one_period.svg" target="_blank"><img class="markdeep" src="../media/day9/Sine_one_period.svg" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;2:</b> Sine wave period (<a href="https://commons.wikimedia.org/wiki/File:Sine_one_period.svg">Wikipedia</a>). </span></center></div></center>

</p><p>

By making this calculation for each sample, we will be able to find an approximate value corresponding to the related percentage of the volume. The closer the <code>SineValue</code> will be to <code>-1</code> or <code>1</code>, the closer the value will be to the negative or positive <code>ToneVolume</code>.

</p><p>

If you look at the figure below, you will see that, over time, all those numbers trace something that resembles a wave. Sure, this wave is not exactly smooth, but that's what the thousands of samples per second are for!

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="368" width="552" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 8,16 L 8,80 " style="fill:none;"/>
<path d="M 200,16 L 200,80 " style="fill:none;"/>
<path d="M 264,16 L 264,128 " style="fill:none;"/>
<path d="M 296,16 L 296,128 " style="fill:none;"/>
<path d="M 312,208 L 312,240 " style="fill:none;"/>
<path d="M 328,16 L 328,128 " style="fill:none;"/>
<path d="M 344,176 L 344,208 " style="fill:none;"/>
<path d="M 360,16 L 360,128 " style="fill:none;"/>
<path d="M 376,176 L 376,224 " style="fill:none;"/>
<path d="M 392,16 L 392,128 " style="fill:none;"/>
<path d="M 408,224 L 408,272 " style="fill:none;"/>
<path d="M 424,16 L 424,128 " style="fill:none;"/>
<path d="M 440,272 L 440,320 " style="fill:none;"/>
<path d="M 456,16 L 456,128 " style="fill:none;"/>
<path d="M 472,256 L 472,320 " style="fill:none;"/>
<path d="M 488,16 L 488,128 " style="fill:none;"/>
<path d="M 8,16 L 200,16 " style="fill:none;"/>
<path d="M 248,16 L 504,16 " style="fill:none;"/>
<path d="M 24,48 L 184,48 " style="fill:none;"/>
<path d="M 208,48 L 224,48 " style="fill:none;"/>
<path d="M 8,80 L 200,80 " style="fill:none;"/>
<path d="M 264,80 L 488,80 " style="fill:none;"/>
<path d="M 104,160 L 240,160 " style="fill:none;"/>
<path d="M 344,176 L 376,176 " style="fill:none;"/>
<path d="M 312,208 L 344,208 " style="fill:none;"/>
<path d="M 376,224 L 408,224 " style="fill:none;"/>
<path d="M 32,240 L 216,240 " style="fill:none;"/>
<path d="M 280,240 L 312,240 " style="fill:none;"/>
<path d="M 408,272 L 440,272 " style="fill:none;"/>
<path d="M 440,320 L 472,320 " style="fill:none;"/>
<path d="M 104,336 L 240,336 " style="fill:none;"/>
<path d="M 264,128 L 272,144 " style="fill:none;"/>
<path d="M 296,128 L 304,144 " style="fill:none;"/>
<path d="M 328,128 L 336,144 " style="fill:none;"/>
<path d="M 360,128 L 368,144 " style="fill:none;"/>
<path d="M 392,128 L 400,144 " style="fill:none;"/>
<path d="M 424,128 L 432,144 " style="fill:none;"/>
<path d="M 456,128 L 464,144 " style="fill:none;"/>
<path d="M 288,144 L 296,128 " style="fill:none;"/>
<path d="M 320,144 L 328,128 " style="fill:none;"/>
<path d="M 352,144 L 360,128 " style="fill:none;"/>
<path d="M 384,144 L 392,128 " style="fill:none;"/>
<path d="M 416,144 L 424,128 " style="fill:none;"/>
<path d="M 448,144 L 456,128 " style="fill:none;"/>
<path d="M 480,144 L 488,128 " style="fill:none;"/>
<polygon points="512,16 500,10.4 500,21.6 "  style="stroke:none" transform="rotate(0,504,16 )"/>
<polygon points="248,336 236,330.4 236,341.6 "  style="stroke:none" transform="rotate(0,240,336 )"/>
<polygon points="248,160 236,154.4 236,165.6 "  style="stroke:none" transform="rotate(0,240,160 )"/>
<polygon points="232,48 220,42.4 220,53.6 "  style="stroke:none" transform="rotate(0,224,48 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="312" y="4">R</text><text text-anchor="middle" x="320" y="4">u</text><text text-anchor="middle" x="328" y="4">n</text><text text-anchor="middle" x="336" y="4">n</text><text text-anchor="middle" x="344" y="4">i</text><text text-anchor="middle" x="352" y="4">n</text><text text-anchor="middle" x="360" y="4">g</text><text text-anchor="middle" x="368" y="4">S</text><text text-anchor="middle" x="376" y="4">a</text><text text-anchor="middle" x="384" y="4">m</text><text text-anchor="middle" x="392" y="4">p</text><text text-anchor="middle" x="400" y="4">l</text><text text-anchor="middle" x="408" y="4">e</text><text text-anchor="middle" x="416" y="4">I</text><text text-anchor="middle" x="424" y="4">n</text><text text-anchor="middle" x="432" y="4">d</text><text text-anchor="middle" x="440" y="4">e</text><text text-anchor="middle" x="448" y="4">x</text><text text-anchor="middle" x="512" y="20">.</text><text text-anchor="middle" x="520" y="20">.</text><text text-anchor="middle" x="528" y="20">.</text><text text-anchor="middle" x="16" y="36">R</text><text text-anchor="middle" x="24" y="36">u</text><text text-anchor="middle" x="32" y="36">n</text><text text-anchor="middle" x="40" y="36">n</text><text text-anchor="middle" x="48" y="36">i</text><text text-anchor="middle" x="56" y="36">n</text><text text-anchor="middle" x="64" y="36">g</text><text text-anchor="middle" x="72" y="36">S</text><text text-anchor="middle" x="80" y="36">a</text><text text-anchor="middle" x="88" y="36">m</text><text text-anchor="middle" x="96" y="36">p</text><text text-anchor="middle" x="104" y="36">l</text><text text-anchor="middle" x="112" y="36">e</text><text text-anchor="middle" x="120" y="36">I</text><text text-anchor="middle" x="128" y="36">n</text><text text-anchor="middle" x="136" y="36">d</text><text text-anchor="middle" x="144" y="36">e</text><text text-anchor="middle" x="152" y="36">x</text><text text-anchor="middle" x="168" y="36">·</text><text text-anchor="middle" x="184" y="36">2</text><text text-anchor="middle" x="192" y="36">π</text><text text-anchor="middle" x="240" y="52">t</text><text text-anchor="middle" x="280" y="52">0</text><text text-anchor="middle" x="312" y="52">1</text><text text-anchor="middle" x="344" y="52">2</text><text text-anchor="middle" x="376" y="52">3</text><text text-anchor="middle" x="408" y="52">4</text><text text-anchor="middle" x="440" y="52">5</text><text text-anchor="middle" x="472" y="52">6</text><text text-anchor="middle" x="512" y="52">.</text><text text-anchor="middle" x="520" y="52">.</text><text text-anchor="middle" x="528" y="52">.</text><text text-anchor="middle" x="56" y="68">W</text><text text-anchor="middle" x="64" y="68">a</text><text text-anchor="middle" x="72" y="68">v</text><text text-anchor="middle" x="80" y="68">e</text><text text-anchor="middle" x="88" y="68">P</text><text text-anchor="middle" x="96" y="68">e</text><text text-anchor="middle" x="104" y="68">r</text><text text-anchor="middle" x="112" y="68">i</text><text text-anchor="middle" x="120" y="68">o</text><text text-anchor="middle" x="128" y="68">d</text><text text-anchor="middle" x="16" y="116">S</text><text text-anchor="middle" x="24" y="116">i</text><text text-anchor="middle" x="32" y="116">n</text><text text-anchor="middle" x="40" y="116">e</text><text text-anchor="middle" x="48" y="116">V</text><text text-anchor="middle" x="56" y="116">a</text><text text-anchor="middle" x="64" y="116">l</text><text text-anchor="middle" x="72" y="116">u</text><text text-anchor="middle" x="80" y="116">e</text><text text-anchor="middle" x="96" y="116">(</text><text text-anchor="middle" x="104" y="116">s</text><text text-anchor="middle" x="112" y="116">i</text><text text-anchor="middle" x="120" y="116">n</text><text text-anchor="middle" x="128" y="116">e</text><text text-anchor="middle" x="144" y="116">(</text><text text-anchor="middle" x="152" y="116">t</text><text text-anchor="middle" x="160" y="116">)</text><text text-anchor="middle" x="168" y="116">)</text><text text-anchor="middle" x="280" y="116">0</text><text text-anchor="middle" x="304" y="116">.</text><text text-anchor="middle" x="312" y="116">8</text><text text-anchor="middle" x="320" y="116">4</text><text text-anchor="middle" x="336" y="116">.</text><text text-anchor="middle" x="344" y="116">9</text><text text-anchor="middle" x="352" y="116">0</text><text text-anchor="middle" x="368" y="116">.</text><text text-anchor="middle" x="376" y="116">1</text><text text-anchor="middle" x="384" y="116">4</text><text text-anchor="middle" x="400" y="116">-</text><text text-anchor="middle" x="408" y="116">.</text><text text-anchor="middle" x="416" y="116">7</text><text text-anchor="middle" x="432" y="116">-</text><text text-anchor="middle" x="440" y="116">.</text><text text-anchor="middle" x="448" y="116">9</text><text text-anchor="middle" x="464" y="116">-</text><text text-anchor="middle" x="472" y="116">.</text><text text-anchor="middle" x="480" y="116">2</text><text text-anchor="middle" x="512" y="116">.</text><text text-anchor="middle" x="520" y="116">.</text><text text-anchor="middle" x="528" y="116">.</text><text text-anchor="middle" x="16" y="164">T</text><text text-anchor="middle" x="24" y="164">o</text><text text-anchor="middle" x="32" y="164">n</text><text text-anchor="middle" x="40" y="164">e</text><text text-anchor="middle" x="48" y="164">V</text><text text-anchor="middle" x="56" y="164">o</text><text text-anchor="middle" x="64" y="164">l</text><text text-anchor="middle" x="72" y="164">u</text><text text-anchor="middle" x="80" y="164">m</text><text text-anchor="middle" x="88" y="164">e</text><text text-anchor="middle" x="264" y="164">-</text><text text-anchor="middle" x="280" y="164">┊</text><text text-anchor="middle" x="296" y="164">-</text><text text-anchor="middle" x="312" y="164">┊</text><text text-anchor="middle" x="328" y="164">-</text><text text-anchor="middle" x="344" y="164">┊</text><text text-anchor="middle" x="360" y="164">-</text><text text-anchor="middle" x="376" y="164">┊</text><text text-anchor="middle" x="392" y="164">-</text><text text-anchor="middle" x="408" y="164">┊</text><text text-anchor="middle" x="424" y="164">-</text><text text-anchor="middle" x="440" y="164">┊</text><text text-anchor="middle" x="456" y="164">-</text><text text-anchor="middle" x="472" y="164">┊</text><text text-anchor="middle" x="488" y="164">-</text><text text-anchor="middle" x="504" y="164">-</text><text text-anchor="middle" x="520" y="164">-</text><text text-anchor="middle" x="280" y="180">┊</text><text text-anchor="middle" x="312" y="180">┊</text><text text-anchor="middle" x="408" y="180">┊</text><text text-anchor="middle" x="440" y="180">┊</text><text text-anchor="middle" x="472" y="180">┊</text><text text-anchor="middle" x="280" y="196">┊</text><text text-anchor="middle" x="312" y="196">┊</text><text text-anchor="middle" x="408" y="196">┊</text><text text-anchor="middle" x="440" y="196">┊</text><text text-anchor="middle" x="472" y="196">┊</text><text text-anchor="middle" x="280" y="212">┊</text><text text-anchor="middle" x="408" y="212">┊</text><text text-anchor="middle" x="440" y="212">┊</text><text text-anchor="middle" x="472" y="212">┊</text><text text-anchor="middle" x="280" y="228">┊</text><text text-anchor="middle" x="440" y="228">┊</text><text text-anchor="middle" x="472" y="228">┊</text><text text-anchor="middle" x="16" y="244">0</text><text text-anchor="middle" x="232" y="244">-</text><text text-anchor="middle" x="248" y="244">-</text><text text-anchor="middle" x="264" y="244">-</text><text text-anchor="middle" x="328" y="244">-</text><text text-anchor="middle" x="352" y="244">-</text><text text-anchor="middle" x="376" y="244">-</text><text text-anchor="middle" x="440" y="244">┊</text><text text-anchor="middle" x="472" y="244">┊</text><text text-anchor="middle" x="480" y="244">.</text><text text-anchor="middle" x="488" y="244">.</text><text text-anchor="middle" x="496" y="244">.</text><text text-anchor="middle" x="512" y="244">-</text><text text-anchor="middle" x="528" y="244">-</text><text text-anchor="middle" x="440" y="260">┊</text><text text-anchor="middle" x="8" y="340">-</text><text text-anchor="middle" x="16" y="340">T</text><text text-anchor="middle" x="24" y="340">o</text><text text-anchor="middle" x="32" y="340">n</text><text text-anchor="middle" x="40" y="340">e</text><text text-anchor="middle" x="48" y="340">V</text><text text-anchor="middle" x="56" y="340">o</text><text text-anchor="middle" x="64" y="340">l</text><text text-anchor="middle" x="72" y="340">u</text><text text-anchor="middle" x="80" y="340">m</text><text text-anchor="middle" x="88" y="340">e</text><text text-anchor="middle" x="256" y="340">-</text><text text-anchor="middle" x="272" y="340">-</text><text text-anchor="middle" x="288" y="340">-</text><text text-anchor="middle" x="304" y="340">-</text><text text-anchor="middle" x="320" y="340">-</text><text text-anchor="middle" x="336" y="340">-</text><text text-anchor="middle" x="352" y="340">-</text><text text-anchor="middle" x="368" y="340">-</text><text text-anchor="middle" x="384" y="340">-</text><text text-anchor="middle" x="400" y="340">-</text><text text-anchor="middle" x="416" y="340">-</text><text text-anchor="middle" x="432" y="340">-</text><text text-anchor="middle" x="448" y="340">-</text><text text-anchor="middle" x="464" y="340">-</text><text text-anchor="middle" x="480" y="340">-</text><text text-anchor="middle" x="496" y="340">-</text><text text-anchor="middle" x="512" y="340">-</text></g></g></svg>

</p><p>

Now, there's one last thing. In order to have full division correctly, we should cast both <code>RunningSampleIndex</code> and <code>WavePeriod</code> to <code>f32</code> <em class="underscore">before</em> the division. This way, both numbers will be considered real numbers immediately, and the fraction will not be discarded.

</p><p>

We also need to advance the <code>RunningSampleIndex</code>.

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line"><span class="hljs-symbol">s16</span> *SampleOut = (<span class="hljs-built_in">s16</span> *)Region1<span class="hljs-comment">;</span></span>
<span class="line"><span class="hljs-symbol">DWORD</span> Region1SampleCount = Region1Size / <span class="hljs-keyword">BytesPerSample;</span>
<span class="line"></span><span class="hljs-symbol">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span><span class="hljs-comment">;</span></span>
<span class="line">        SampleIndex &lt; Region1SampleCount<span class="hljs-comment">;</span></span>
<span class="line">        ++SampleIndex)</span>
<span class="line">{</span></div><div class=" add"><span class="line">    f32 t = <span class="hljs-number">2.0f</span> * Pi32 * (f32)RunningSampleIndex / (f32)WavePeriod;</span></div><span class="line">    f32 SineValue = sinf(t);</span>
<span class="line">    s16 SampleValue = SineValue * ToneVolume;</span>
<span class="line">    </span>
<span class="line">    *SampleOut++ = SampleValue;</span>
<span class="line">    *SampleOut++ = SampleValue;</span><div class=" add"><span class="line">    ++RunningSampleIndex;</span></div><span class="line">}</span>
<span class="line"></span>
<span class="line">SampleOut = (s16 *)Region2;</span>
<span class="line">DWORD Region2SampleCount = Region2Size / BytesPerSample;</span>
<span class="line"><span class="hljs-keyword">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line">        SampleIndex &lt; Region2SampleCount;</span>
<span class="line">        ++SampleIndex)</span>
<span class="line">{</span><div class=" add"><span class="line">    f32 t = <span class="hljs-number">2.0f</span> * Pi32 * (f32)RunningSampleIndex / (f32)WavePeriod;</span></div><span class="line">    f32 SineValue = sinf(t);</span>
<span class="line">    s16 SampleValue = SineValue * ToneVolume;</span>
<span class="line">    </span>
<span class="line">    *SampleOut++ = SampleValue;</span>
<span class="line">    *SampleOut++ = SampleValue;</span><div class=" add"><span class="line">    ++RunningSampleIndex;</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;7:</b> <file>[win32_handmade.cpp > WinMain]</file> Calculating <code>t</code>.</div></center>
<p>


To recap, what we are doing here is transforming the wave period of the running sample index into the period of sine. We're calling sine, and then multiplying the sine with the tone volume, and that's our sample value. 

</p><p>

We don't have the <code>Pi32</code> right now, so let's quickly define it on top of <code>win32_handmade.cpp</code>.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> internal static</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> local_persist static</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> global_variable static</span></span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> Pi32 3.14159265359f</span></span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;8:</b> <file>[win32_handmade.cpp]</file> Defining <code>Pi32</code>.</div></center>
<p>


We also don't really need <code>HalfWavePeriod</code> any more, so we can get rid of it. 

</p><pre class="listing tilde"><code><span class="line">u32 RunningSampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line"><span class="hljs-keyword">int</span> ToneHz = <span class="hljs-number">256</span>;</span>
<span class="line"><span class="hljs-keyword">int</span> ToneVolume = <span class="hljs-number">3000</span>;</span>
<span class="line"><span class="hljs-keyword">int</span> WavePeriod = SamplesPerSecond / ToneHz;</span><div class=" delete"><span class="line"><span class="hljs-keyword">int</span> HalfWavePeriod = WavePeriod / <span class="hljs-number">2</span>;</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;9:</b> <file>[win32_handmade.cpp > WinMain]</file> Cleaning up.</div></center>

<a class="target" name="deepsounddebugging">&nbsp;</a><a class="target" name="deepsounddebugging">&nbsp;</a><a class="target" name="toc3">&nbsp;</a><h1>Deep Sound Debugging</h1>
<p>


If you compile and run now... you won't hear the purest of sounds. There will probably be a lot of clicking and &ldquo;scratchiness&rdquo;. Of course, we could get this by having our sample value calculated incorrectly, or some other issue. We'll need to find it out. 

</p><p>

What's not working properly is probably one of the following: 

</p><p>

<ul>
<li class="asterisk">The sine wave might not be synthetized correctly. We have just finished implementing the wave, so it might have some errors in it.
</li>
<li class="asterisk">The way we are filling regions might not be correct. We haven't really tested what happens in the sound regions once we get them back, assuming we're getting them correctly.
</li>
<li class="asterisk">Our <code>ByteToLock</code>/<code>BytesToWrite</code> might be updating incorrectly. Skips can be introduced that should not be here when we start filling out the buffer incrementally.</li></ul>

</p><p>

Of course, there might be other places as well, so we'll need to go hunting for them.

</p><p>

The hunt for the sound bugs is now open!

</p>
<a class="target" name="verifythesinewave">&nbsp;</a><a class="target" name="deepsounddebugging/verifythesinewave">&nbsp;</a><a class="target" name="toc3.1">&nbsp;</a><h2>Verify the Sine Wave</h2>
<p>


Verifying that our sine wave is calculated correctly is a relatively low-hanging fruit, so let's do that first.

</p><p>

If you recall, our <code>GlobalSecondaryBuffer</code> is 2-second long. That's a lot. So we could write to it only once and never fill it again. If reproducing the same buffer forever won't lead to the same result, our error lies elsewhere.

</p><p>

We can do it quite simply by testing if <code>SoundIsPlaying</code>. The first time we write to the sound buffer, the sound will not be playing, so we can write, toggle the boolean, and prevent any additional buffer editing. Let's add an additional condition to <code>GetCurrentPosition</code> test. As a reminder, we can chain several tests with the logical AND operator (<code>&amp;&amp;</code>): 

</p><pre class="listing tilde"><code><span class="line">DWORD PlayCursor;</span>
<span class="line">DWORD WriteCursor;</span><div class=" add"><span class="line"><span class="hljs-keyword">if</span> (!SoundIsPlaying &amp;&amp;</span></div><div class=" edit"><span class="line">    SUCCEEDED(GlobalSecondaryBuffer-&gt;GetCurrentPosition(&amp;PlayCursor, &amp;WriteCursor)))</span></div><span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ... lock and write to our buffer</span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;10:</b> <file>[win32_handmade.cpp > WinMain]</file> Filling out buffer only once.</div></center>
<p>


Another way of testing it would be simply having this whole block run outside of the <code>Running</code> loop. If you factored this code away to a separate function you might try this as an exercise!

</p><p>

In any case, after we compile we should only hear a single click every two seconds, accompanied by a smooth, clean sound. This means that our wave is fine! Let's revert our test back: 

</p><pre class="listing tilde"><code><span class="line">DWORD PlayCursor;</span>
<span class="line">DWORD WriteCursor;</span><div class=" delete"><span class="line"><span class="hljs-keyword">if</span> !SoundIsPlaying &amp;&amp;</span></div><div class=" edit"><span class="line"><span class="hljs-keyword">if</span> (SUCCEEDED(GlobalSecondaryBuffer-&gt;GetCurrentPosition(&amp;PlayCursor, &amp;WriteCursor)))</span></div><span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ... lock and write to our buffer</span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;11:</b> <file>[win32_handmade.cpp > WinMain]</file> Filling out buffer only once.</div></center>

<a class="target" name="stepthroughthecode">&nbsp;</a><a class="target" name="deepsounddebugging/stepthroughthecode">&nbsp;</a><a class="target" name="toc3.2">&nbsp;</a><h2>Step Through the Code</h2>
<p>


We have now determined, rather definitively, that it's not the sine wave that's responsible for all the artifacts. This means there is a bug in our wave output. As the next step of our investigation, let's look through the code and verify what we know.

</p><p>

If we step through the code from the very start of our sound initialization (place a breakpoint in the debugger by pressing <code>F9</code> and then step through with <code>F10</code>), we can inspect the various fields we initialize. 

</p><p>

<ol start=1>
<li class="number">We know we have a buffer which is 48000 samples big, times 4 (the size of our bytes per sample) times 2 (so that we have 2 seconds). This amounts to 384,000 samples. Verify that's exactly what we are passing to <code>Win32InitDSound</code> as <code>SecondaryBufferSize</code>, as well as 48000 as <code>SamplesPerSecond</code>. 
</li>
<li class="number">We can skip ahead to <code>GetCurrentPosition</code> call. You can simply set another breakpoint there and <code>F5</code> your way until the breakpoint. 
</li>
<li class="number">We then calculate the <code>ByteToLock</code>. Now, here we have chained two operations, a multiplication followed by remainder calculation. We want to multiply the sample index per bytes per sample <em class="underscore">and then</em> get the remainder. <a href="https://en.cppreference.com/w/c/language/operator_precedence">Operator Precedence</a> rules assure us this operation should go as we intend it to, but let's make sure they are executed in sequence we want by adding parenthesis:</li></ol>

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">if</span> (SUCCEEDED(GlobalSecondaryBuffer-&gt;GetCurrentPosition(...)))</span>
<span class="line">{</span><div class=" edit"><span class="line">    DWORD ByteToLock = (RunningSampleIndex * BytesPerSample) % SecondaryBufferSize;</span></div><span class="line">    DWORD BytesToWrite;</span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;12:</b> <file>[win32_handmade.cpp > WinMain]</file> Securing intended operator precedence.</div></center>
<p>


Usually you shouldn't rely on your memory to memorize the operator precedence. Memory may fault, rules may change, and adding parenthesis to make things clearer will never hurt.

</p><p>

Other than that... <code>ByteToLock</code> computation looks fine. We say &ldquo;wherever our sample index was, times the number of bytes per sample, modded by the entire buffer size, should be where we are in the buffer&rdquo;. Looks like a solid and straightforward computation. 

</p><p>

<ol start=4>
<li class="number">We can also verify that <code>ByteToLock</code> is computed as <code>0</code> during the first and the second run. At the beginning, the <code>RunningSampleIndex</code> is <code>0</code>, so we lock byte <code>0</code> and write the entire buffer, but then the modded value is at <code>0</code> again since we've written the entire buffer exactly once by that point. If we set our breakpoint to <code>ByteToWrite</code> and run until the breakpoint (<code>F5</code>), we will see that our <code>ByteToLock</code> shouldn't change.
</li>
<li class="number">If the <code>ByteToLock</code> equals to the <code>PlayCursor</code>, we say that we need to write the entire buffer size. That should happen only one time at the beginning, so let's set a breakpoint inside that block and verify it happens one time only... oh no.</li></ol>

</p><p>

<center><div class="image" style=""><a href="../media/day9/debug0.jpg" target="_blank"><img class="markdeep" src="../media/day9/debug0.jpg" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;3:</b> Debugging <code>ByteToWrite</code> calculations.</span></center></div></center>

</p><p>

We said that this part should be secured better, and it definitely seems the case. What we intended was that both <code>ByteToLock</code> and <code>PlayCursor</code> should be equal all the time, but this doesn't seem the case. It seems that the write cursor advances roughly the same distance as the <code>RunningSampleIndex</code>, causing us to overwrite the whole buffer again. It is <em class="underscore">a</em> bug (not necessarily <em class="underscore">the</em> bug, we'll see it later) because that means that we writing under the write cursor, so we'll need to fix it!

</p>
<a class="target" name="refactorthecode">&nbsp;</a><a class="target" name="deepsounddebugging/refactorthecode">&nbsp;</a><a class="target" name="toc3.3">&nbsp;</a><h2>Refactor the Code</h2>
<p>


The time has come to compress all the sound variables into one struct and extract the sound samples. If you haven't done so already, this is how we approach it.

</p><p>

First, let's define a struct somewhere outside our functions. It will fit all the constants we initialize at the beginning, so we'll call it as <code>win32_sound_output</code>:

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">win32_window_dimension</span></span>
<span class="line">{</span></span>
<span class="line">    <span class="hljs-keyword">int</span> Width;</span>
<span class="line">    <span class="hljs-keyword">int</span> Height;</span>
<span class="line">};</span></div><div class=" add"><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">win32_sound_output</span></span>
<span class="line">{</span></span>
<span class="line">    <span class="hljs-keyword">int</span> SamplesPerSecond;</span>
<span class="line">    <span class="hljs-keyword">int</span> BytesPerSample;</span>
<span class="line">    <span class="hljs-keyword">int</span> SecondaryBufferSize;</span>
<span class="line">    u32 RunningSampleIndex;</span>
<span class="line">    <span class="hljs-keyword">int</span> ToneHz;</span>
<span class="line">    <span class="hljs-keyword">int</span> ToneVolume;</span>
<span class="line">    <span class="hljs-keyword">int</span> WavePeriod;</span>
<span class="line">};</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;13:</b> <file>[win32_handmade.cpp]</file> Introducing <code>wi32_sound_output</code>.</div></center>
<p>


We will then update our constants to be members of this struct:

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line">// NOTE(casey): Sound <span class="hljs-built_in">test</span></span></div><div class=" add"><span class="line">win32_sound_output SoundOutput = {};</span></div><div class=" edit"><span class="line">SoundOutput.SamplesPerSecond = <span class="hljs-number">48000</span>;</span>
<span class="line">SoundOutput.BytesPerSample = <span class="hljs-keyword">sizeof</span>(s16) * <span class="hljs-number">2</span>;</span>
<span class="line">SoundOutput.SecondaryBufferSize = <span class="hljs-number">2</span> * SoundOutput.SamplesPerSecond * SoundOutput.BytesPerSample;</span>
<span class="line">SoundOutput.RunningSampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line">SoundOutput.ToneHz = <span class="hljs-number">256</span>;</span>
<span class="line">SoundOutput.ToneVolume = <span class="hljs-number">3000</span>;</span>
<span class="line">SoundOutput.WavePeriod = SoundOutput.SamplesPerSecond / SoundOutput.ToneHz;</span>
<span class="line">Win32InitDSound(Window, SoundOutput.SamplesPerSecond, SoundOutput.SecondaryBufferSize);</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;14:</b> <file>[win32_handmade.cpp]</file> Using <code>wi32_sound_output</code>.</div></center>
<p>


We will then be in a good position to extract the sound reproduction code (which we mostly verified works fine)  in a separate function, and pass a pointer to our new structure. We will also pass the <code>ByteToLock</code> and <code>BytesToWrite</code> so we'll have better control at what part of the buffer we are writing to. 

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">Win32FillSoundBuffer</span><span class="hljs-params">(win32_sound_output *SoundOutput, DWORD ByteToLock, DWORD BytesToWrite)</span></span>
<span class="line"></span>{</span>
<span class="line">    VOID *Region1;</span>
<span class="line">    DWORD Region1Size;</span>
<span class="line">    VOID *Region2;</span>
<span class="line">    DWORD Region2Size;</span>
<span class="line">    <span class="hljs-keyword">if</span>(SUCCEEDED(GlobalSecondaryBuffer-&gt;Lock(ByteToLock, BytesToWrite,</span>
<span class="line">                                             &amp;Region1, &amp;Region1Size,</span>
<span class="line">                                             &amp;Region2, &amp;Region2Size,</span>
<span class="line">                                             <span class="hljs-number">0</span>)))</span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// TODO(casey): assert that Region1Size/Region2Size are valid</span></span>
<span class="line">        s16 *SampleOut = (s16 *)Region1;</span>
<span class="line">        DWORD Region1SampleCount = Region1Size / SoundOutput-&gt;BytesPerSample;</span>
<span class="line">        <span class="hljs-keyword">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line">             SampleIndex &lt; Region1SampleCount;</span>
<span class="line">             ++SampleIndex)</span>
<span class="line">        {</span>
<span class="line">            f32 t = <span class="hljs-number">2.0f</span> * Pi32 * (f32)SoundOutput-&gt;RunningSampleIndex / (f32)SoundOutput-&gt;WavePeriod;</span>
<span class="line">            f32 SineValue = sinf(t);</span>
<span class="line">            s16 SampleValue = (s16)(SineValue * SoundOutput-&gt;ToneVolume);</span>
<span class="line">            </span>
<span class="line">            *SampleOut++ = SampleValue;</span>
<span class="line">            *SampleOut++ = SampleValue;</span>
<span class="line">            </span>
<span class="line">            ++SoundOutput-&gt;RunningSampleIndex;</span>
<span class="line">        }</span>
<span class="line">        </span>
<span class="line">        SampleOut = (s16 *)Region2;</span>
<span class="line">        DWORD Region2SampleCount = Region2Size / SoundOutput-&gt;BytesPerSample;</span>
<span class="line">        <span class="hljs-keyword">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line">             SampleIndex &lt; Region2SampleCount;</span>
<span class="line">             ++SampleIndex)</span>
<span class="line">        {</span>
<span class="line">            f32 t = <span class="hljs-number">2.0f</span> * Pi32 * (f32)SoundOutput-&gt;RunningSampleIndex / (f32)SoundOutput-&gt;WavePeriod;</span>
<span class="line">            f32 SineValue = sinf(t);</span>
<span class="line">            s16 SampleValue = (s16)(SineValue * SoundOutput-&gt;ToneVolume);</span>
<span class="line">            </span>
<span class="line">            *SampleOut++ = SampleValue;</span>
<span class="line">            *SampleOut++ = SampleValue;</span>
<span class="line">            </span>
<span class="line">            ++SoundOutput-&gt;RunningSampleIndex;</span>
<span class="line">        }</span>
<span class="line">        </span>
<span class="line">        GlobalSecondaryBuffer-&gt;Unlock(Region1, Region1Size, Region2, Region2Size);</span>
<span class="line">    }</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;15:</b> <file>[win32_handmade.cpp]</file> Introducing <code>Win32FillSoundBuffer</code>.</div></center>
<p>


Last step of refactoring, we can place the call to this function in place of the code in <code>WinMain</code>.

</p><pre class="listing tilde"><code><span class="line">DWORD PlayCursor;</span>
<span class="line">DWORD WriteCursor;</span>
<span class="line"><span class="hljs-keyword">if</span> (SUCCEEDED(GlobalSecondaryBuffer-&gt;GetCurrentPosition(&amp;PlayCursor, &amp;WriteCursor)))</span>
<span class="line">{</span>
<span class="line">    DWORD ByteToLock = (SoundOutput.RunningSampleIndex * SoundOutput.BytesPerSample) % SoundOutput.SecondaryBufferSize;</span>
<span class="line">    DWORD BytesToWrite;</span>
<span class="line">    <span class="hljs-comment">// TODO(casey): We need a more accurate check than ByteToLock == PlayCursor</span></span>
<span class="line">    <span class="hljs-keyword">if</span> (ByteToLock == PlayCursor)</span>
<span class="line">    {</span>
<span class="line">        BytesToWrite = SoundOutput.SecondaryBufferSize;</span>
<span class="line">    }</span>
<span class="line">    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(ByteToLock &gt; PlayCursor)</span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// Play cursor is behind</span></span>
<span class="line">        BytesToWrite = SoundOutput.SecondaryBufferSize - ByteToLock; <span class="hljs-comment">// region 1</span></span>
<span class="line">        BytesToWrite += PlayCursor;                      <span class="hljs-comment">// region 2</span></span>
<span class="line">    }</span>
<span class="line">    <span class="hljs-keyword">else</span></span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// Play cursor is in front</span></span>
<span class="line">        BytesToWrite = PlayCursor - ByteToLock;          <span class="hljs-comment">// region 1</span></span>
<span class="line">    }</span><div class=" delete"><span class="line">    VOID *Region1;</span>
<span class="line">    DWORD Region1Size;</span>
<span class="line">    VOID *Region2;</span>
<span class="line">    DWORD Region2Size;</span>
<span class="line">    <span class="hljs-keyword">if</span>(SUCCEEDED(GlobalSecondaryBuffer-&gt;Lock(ByteToLock, BytesToWrite,</span>
<span class="line">                                                &amp;Region1, &amp;Region1Size,</span>
<span class="line">                                                &amp;Region2, &amp;Region2Size,</span>
<span class="line">                                                <span class="hljs-number">0</span>)))</span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// TODO(casey): assert that Region1Size/Region2Size are valid</span></span>
<span class="line">        s16 *SampleOut = (s16 *)Region1;</span>
<span class="line">        DWORD Region1SampleCount = Region1Size / BytesPerSample;</span>
<span class="line">        <span class="hljs-keyword">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line">                SampleIndex &lt; Region1SampleCount;</span>
<span class="line">                ++SampleIndex)</span>
<span class="line">        {</span>
<span class="line">            f32 t = <span class="hljs-number">2.0f</span> * Pi32 * (f32)RunningSampleIndex / (f32)WavePeriod;</span>
<span class="line">            f32 SineValue = sinf(t);</span>
<span class="line">            s16 SampleValue = (s16)(SineValue * ToneVolume);</span>
<span class="line">            </span>
<span class="line">            *SampleOut++ = SampleValue;</span>
<span class="line">            *SampleOut++ = SampleValue;</span>
<span class="line">            </span>
<span class="line">            ++RunningSampleIndex;</span>
<span class="line">        }</span>
<span class="line">        </span>
<span class="line">        SampleOut = (s16 *)Region2;</span>
<span class="line">        DWORD Region2SampleCount = Region2Size / BytesPerSample;</span>
<span class="line">        <span class="hljs-keyword">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line">                SampleIndex &lt; Region2SampleCount;</span>
<span class="line">                ++SampleIndex)</span>
<span class="line">        {</span>
<span class="line">            f32 t = <span class="hljs-number">2.0f</span> * Pi32 * (f32)RunningSampleIndex / (f32)WavePeriod;</span>
<span class="line">            f32 SineValue = sinf(t);</span>
<span class="line">            s16 SampleValue = (s16)(SineValue * ToneVolume);</span>
<span class="line">            </span>
<span class="line">            *SampleOut++ = SampleValue;</span>
<span class="line">            *SampleOut++ = SampleValue;</span>
<span class="line">            </span>
<span class="line">            ++RunningSampleIndex;</span>
<span class="line">        }</span>
<span class="line">        </span>
<span class="line">        GlobalSecondaryBuffer-&gt;Unlock(Region1, Region1Size, Region2, Region2Size);</span>
<span class="line">    }</span></div><div class=" add"><span class="line">    Win32FillSoundBuffer(&amp;SoundOutput, ByteToLock, BytesToWrite);</span></div><div class=" C++ "><span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;16:</b> <file>[win32_handmade.cpp > WinMain]</file> Adding the call to <code>Win32FillSoundBuffer</code>.</div></center>
<p>


If you compile and run, you should now be at the same point as before. We still have the same bug, we just have extracted some code out for potential reuse.

</p><p>

This allows us to use this code elsewhere. For instance, we can say that we want to fill out the sound buffer and start playing immediately after initializing DirectSound, thus getting rid of <code>SoundIsPlaying</code>. We will fill the full buffer, from <code>0</code> to our <code>SecondaryBufferSize</code>. 

</p><pre class="listing tilde"><code><span class="line">Win32InitDSound(Window, SoundOutput.SamplesPerSecond, SoundOutput.SecondaryBufferSize);</span><div class=" delete"><span class="line">b32 SoundIsPlaying = <span class="hljs-literal">false</span>;</span></div><div class=" add"><span class="line">Win32FillSoundBuffer(&amp;SoundOutput, <span class="hljs-number">0</span>, SoundOutput.SecondaryBufferSize);</span>
<span class="line">GlobalSecondaryBuffer-&gt;Play(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, DSBPLAY_LOOPING);</span></div><span class="line"><span class="hljs-comment">// ... </span></span><div class=" delete"><span class="line"><span class="hljs-keyword">if</span> (!SoundIsPlaying)</span>
<span class="line">{</span>
<span class="line">    GlobalSecondaryBuffer-&gt;Play(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, DSBPLAY_LOOPING);</span>
<span class="line">    SoundIsPlaying = <span class="hljs-literal">true</span>;</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;17:</b> <file>[win32_handmade.cpp > WinMain]</file> Prefilling and starting playing before the main loop.</div></center>
<p>



Now, we can try and fix our bug. We don't need to pre-fill our buffer in the main loop any more, so let's simply say: if our <code>ByteToLock</code> stands in the same position as <code>PlayCursor</code>, do nothing and set <code>BytesToWrite</code> to <code>0</code>:

</p><pre class="listing tilde"><code><span class="line">DWORD BytesToWrite;</span>
<span class="line"><span class="hljs-comment">// TODO(casey): We need a more accurate check than ByteToLock == PlayCursor</span></span>
<span class="line"><span class="hljs-keyword">if</span> (ByteToLock == PlayCursor)</span>
<span class="line">{</span><div class=" edit"><span class="line">    BytesToWrite = <span class="hljs-number">0</span>;</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;18:</b> <file>[win32_handmade.cpp > WinMain]</file> Trying to fix our bug.</div></center>
<p>


Compile, run... and the clicking should be gone! You should be left with the perfectly sounding, pure tone.

</p><p>

It worked! One of the reasons trying to pull the code out, making things cleaner, is that cleaner code has less obscure and banal mistakes in it. Even further yet, we don't need <code>ByteToLock == PlayCursor</code> any longer, we added it to be able to preload our buffer. the <code>else</code> block should handle it. We can also get rid of our TODO.

</p><pre class="listing tilde"><code><span class="line">DWORD BytesToWrite;</span><div class=" delete"><span class="line"><span class="hljs-comment">// TODO(casey): We need a more accurate check than ByteToLock == PlayCursor</span></span>
<span class="line"><span class="hljs-keyword">if</span> (ByteToLock == PlayCursor)</span>
<span class="line">{</span>
<span class="line">    BytesToWrite = <span class="hljs-number">0</span>;</span>
<span class="line">}</span></div><div class=" edit"><span class="line"><span class="hljs-keyword">if</span>(ByteToLock &gt; PlayCursor)</span></div><span class="line">{</span>
<span class="line">    <span class="hljs-comment">// Play cursor is behind</span></span>
<span class="line">    BytesToWrite = SoundOutput.SecondaryBufferSize - ByteToLock;</span>
<span class="line">    BytesToWrite += PlayCursor;</span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span></span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// Play cursor is in front or equal</span></span>
<span class="line">    BytesToWrite = PlayCursor - ByteToLock;</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;19:</b> <file>[win32_handmade.cpp > WinMain]</file> Simplifying <code>BytesToWrite</code> calculation.</div></center>
<p>



That said, the compiler should warn us about many of the things, and it can. We just don't have the necessary setting enabled. We'll need to think about warnings and assertions quite soon now.

</p>
<a class="target" name="linkthepitchtouserinput">&nbsp;</a><a class="target" name="linkthepitchtouserinput">&nbsp;</a><a class="target" name="toc4">&nbsp;</a><h1>Link the Pitch to User Input</h1>
<p>


Let's have some fun! We will change the tone pitch based on the input from the controller. Let's explore how we can make this happen.

</p>
<a class="target" name="straightupchange">&nbsp;</a><a class="target" name="linkthepitchtouserinput/straightupchange">&nbsp;</a><a class="target" name="toc4.1">&nbsp;</a><h2>Straight Up Change</h2>
<p>


The simplest and the most intuitive solution would be simply changing the tone Hz and recalculating the Wave Period. Let's say if you press &ldquo;A&rdquo; button on your gamepad, you increase the pitch to <code>512</code>, and if you press &ldquo;B&rdquo; button it reverts back to <code>256</code>:

</p><pre class="listing tilde"><code><span class="line">s16 StickX = Pad-&gt;sThumbLX;</span>
<span class="line">s16 StickY = Pad-&gt;sThumbLY;</span>
<span class="line"></span>
<span class="line">XOffset += StickX &gt;&gt; <span class="hljs-number">12</span>;</span>
<span class="line">YOffset += StickY &gt;&gt; <span class="hljs-number">12</span>;</span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-keyword">if</span>(AButton)</span>
<span class="line">{</span>
<span class="line">    SoundOutput.ToneHz = <span class="hljs-number">512</span>;</span>
<span class="line">    SoundOutput.WavePeriod = SoundOutput.SamplesPerSecond / SoundOutput.ToneHz;</span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (BButton)</span>
<span class="line">{</span>
<span class="line">    SoundOutput.ToneHz = <span class="hljs-number">512</span>;</span>
<span class="line">    SoundOutput.WavePeriod = SoundOutput.SamplesPerSecond / SoundOutput.ToneHz;</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;20:</b> <file>[win32_handmade.cpp > WinMain]</file> Trying out naïve approach.</div></center>
<p>


This will work, and you will hear the tone change. But this also will introduce a new bug into the system: there will be a click at the moment of change. This is because we recalculate where we are in the sine wave every time. 

</p>
<a class="target" name="storepositioninthesinewave">&nbsp;</a><a class="target" name="linkthepitchtouserinput/storepositioninthesinewave">&nbsp;</a><a class="target" name="toc4.2">&nbsp;</a><h2>Store Position in the Sine Wave</h2>
<p>


Right now, we take our running sample index and divide it by the wave period every time. That means our sound will only be continuous only if the wave period was continuous. If the latter suddenly changes to something else, we will have a sound glitch right at the point of change.

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="176" width="584" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 208,96 L 208,112 " style="fill:none;"/>
<path d="M 240,16 L 240,32 " style="fill:none;"/>
<path d="M 272,96 L 272,112 " style="fill:none;"/>
<path d="M 368,16 L 368,32 " style="fill:none;"/>
<path d="M 176,16 L 520,16 " style="fill:none;"/>
<path d="M 168,80 L 176,80 " style="fill:none;"/>
<path d="M 208,112 L 272,112 " style="fill:none;"/>
<path d="M 208,48 C 191.2,48 192,64 192,64 " style="fill:none;"/>
<path d="M 208,48 C 224.8,48 224,64 224,64 " style="fill:none;"/>
<path d="M 272,48 C 255.2,48 256,64 256,64 " style="fill:none;"/>
<path d="M 272,48 C 288.8,48 288,64 288,64 " style="fill:none;"/>
<path d="M 336,48 C 319.2,48 320,64 320,64 " style="fill:none;"/>
<path d="M 336,48 C 352.8,48 352,64 352,64 " style="fill:none;"/>
<path d="M 400,48 C 383.2,48 384,64 384,64 " style="fill:none;"/>
<path d="M 400,48 C 416.8,48 416,64 416,64 " style="fill:none;"/>
<path d="M 464,48 C 447.2,48 448,64 448,64 " style="fill:none;"/>
<path d="M 464,48 C 480.8,48 480,64 480,64 " style="fill:none;"/>
<path d="M 176,80 C 192.8,80 192,64 192,64 " style="fill:none;"/>
<path d="M 240,80 C 223.2,80 224,64 224,64 " style="fill:none;"/>
<path d="M 240,80 C 256.8,80 256,64 256,64 " style="fill:none;"/>
<path d="M 304,80 C 287.2,80 288,64 288,64 " style="fill:none;"/>
<path d="M 304,80 C 320.8,80 320,64 320,64 " style="fill:none;"/>
<path d="M 368,80 C 351.2,80 352,64 352,64 " style="fill:none;"/>
<path d="M 368,80 C 384.8,80 384,64 384,64 " style="fill:none;"/>
<path d="M 432,80 C 415.2,80 416,64 416,64 " style="fill:none;"/>
<path d="M 432,80 C 448.8,80 448,64 448,64 " style="fill:none;"/>
<path d="M 496,80 C 479.2,80 480,64 480,64 " style="fill:none;"/>
<polygon points="528,16 516,10.4 516,21.6 "  style="stroke:none" transform="rotate(0,520,16 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="16" y="20">R</text><text text-anchor="middle" x="24" y="20">u</text><text text-anchor="middle" x="32" y="20">n</text><text text-anchor="middle" x="40" y="20">n</text><text text-anchor="middle" x="48" y="20">i</text><text text-anchor="middle" x="56" y="20">n</text><text text-anchor="middle" x="64" y="20">g</text><text text-anchor="middle" x="72" y="20">S</text><text text-anchor="middle" x="80" y="20">a</text><text text-anchor="middle" x="88" y="20">m</text><text text-anchor="middle" x="96" y="20">p</text><text text-anchor="middle" x="104" y="20">l</text><text text-anchor="middle" x="112" y="20">e</text><text text-anchor="middle" x="120" y="20">I</text><text text-anchor="middle" x="128" y="20">n</text><text text-anchor="middle" x="136" y="20">d</text><text text-anchor="middle" x="144" y="20">e</text><text text-anchor="middle" x="152" y="20">x</text><text text-anchor="middle" x="168" y="20">0</text><text text-anchor="middle" x="528" y="20">.</text><text text-anchor="middle" x="536" y="20">.</text><text text-anchor="middle" x="544" y="20">.</text><text text-anchor="middle" x="240" y="52">┊</text><text text-anchor="middle" x="368" y="52">┊</text><text text-anchor="middle" x="208" y="68">┊</text><text text-anchor="middle" x="240" y="68">┊</text><text text-anchor="middle" x="272" y="68">┊</text><text text-anchor="middle" x="368" y="68">┊</text><text text-anchor="middle" x="208" y="84">┊</text><text text-anchor="middle" x="272" y="84">┊</text><text text-anchor="middle" x="504" y="84">.</text><text text-anchor="middle" x="512" y="84">.</text><text text-anchor="middle" x="208" y="132">w</text><text text-anchor="middle" x="216" y="132">a</text><text text-anchor="middle" x="224" y="132">v</text><text text-anchor="middle" x="232" y="132">e</text><text text-anchor="middle" x="248" y="132">p</text><text text-anchor="middle" x="256" y="132">e</text><text text-anchor="middle" x="264" y="132">r</text><text text-anchor="middle" x="272" y="132">i</text><text text-anchor="middle" x="280" y="132">o</text><text text-anchor="middle" x="288" y="132">d</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;4:</b> Currently, we recount our position in the sine wave from point 0 to <code>RunningSampleIndex</code>. Each point on the wave has a corresponding <code>RunningSampleIndex</code>.</div></center>

</p><p>

This direct mapping from the running sample index means that we're incredibly rigid in how this wave looks. If it changes just a bit (like doubling the length of the wave), the whole map changes, and we suddenly find ourselves in a completely different position on the wave:

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="304" width="584" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 168,16 L 168,224 " style="fill:none;"/>
<path d="M 208,128 L 208,168 " style="fill:none;"/>
<path d="M 208,224 L 208,240 " style="fill:none;"/>
<path d="M 272,120 L 272,168 " style="fill:none;"/>
<path d="M 272,224 L 272,240 " style="fill:none;"/>
<path d="M 312,152 L 312,224 " style="fill:none;"/>
<path d="M 336,128 L 336,160 " style="fill:none;"/>
<path d="M 360,216 L 360,240 " style="fill:none;"/>
<path d="M 400,128 L 400,168 " style="fill:none;"/>
<path d="M 456,216 L 456,240 " style="fill:none;"/>
<path d="M 464,120 L 464,160 " style="fill:none;"/>
<path d="M 168,48 L 176,48 " style="fill:none;"/>
<path d="M 208,80 L 224,80 " style="fill:none;"/>
<path d="M 304,80 L 320,80 " style="fill:none;"/>
<path d="M 400,80 L 416,80 " style="fill:none;"/>
<path d="M 496,80 L 512,80 " style="fill:none;"/>
<path d="M 168,112 L 176,112 " style="fill:none;"/>
<path d="M 256,112 L 272,112 " style="fill:none;"/>
<path d="M 352,112 L 368,112 " style="fill:none;"/>
<path d="M 448,112 L 464,112 " style="fill:none;"/>
<path d="M 168,144 L 528,144 " style="fill:none;"/>
<path d="M 312,176 L 320,176 " style="fill:none;"/>
<path d="M 400,176 L 416,176 " style="fill:none;"/>
<path d="M 496,176 L 512,176 " style="fill:none;"/>
<path d="M 168,208 L 176,208 " style="fill:none;"/>
<path d="M 304,208 L 312,208 " style="fill:none;"/>
<path d="M 352,208 L 368,208 " style="fill:none;"/>
<path d="M 448,208 L 464,208 " style="fill:none;"/>
<path d="M 208,240 L 272,240 " style="fill:none;"/>
<path d="M 360,240 L 456,240 " style="fill:none;"/>
<path d="M 208,16 C 191.2,16 192,32 192,32 " style="fill:none;"/>
<path d="M 208,16 C 224.8,16 224,32 224,32 " style="fill:none;"/>
<path d="M 272,16 C 255.2,16 256,32 256,32 " style="fill:none;"/>
<path d="M 272,16 C 288.8,16 288,32 288,32 " style="fill:none;"/>
<path d="M 336,16 C 319.2,16 320,32 320,32 " style="fill:none;"/>
<path d="M 336,16 C 352.8,16 352,32 352,32 " style="fill:none;"/>
<path d="M 400,16 C 383.2,16 384,32 384,32 " style="fill:none;"/>
<path d="M 400,16 C 416.8,16 416,32 416,32 " style="fill:none;"/>
<path d="M 464,16 C 447.2,16 448,32 448,32 " style="fill:none;"/>
<path d="M 464,16 C 480.8,16 480,32 480,32 " style="fill:none;"/>
<path d="M 176,48 C 192.8,48 192,32 192,32 " style="fill:none;"/>
<path d="M 240,48 C 223.2,48 224,32 224,32 " style="fill:none;"/>
<path d="M 240,48 C 256.8,48 256,32 256,32 " style="fill:none;"/>
<path d="M 304,48 C 287.2,48 288,32 288,32 " style="fill:none;"/>
<path d="M 304,48 C 320.8,48 320,32 320,32 " style="fill:none;"/>
<path d="M 368,48 C 351.2,48 352,32 352,32 " style="fill:none;"/>
<path d="M 368,48 C 384.8,48 384,32 384,32 " style="fill:none;"/>
<path d="M 432,48 C 415.2,48 416,32 416,32 " style="fill:none;"/>
<path d="M 432,48 C 448.8,48 448,32 448,32 " style="fill:none;"/>
<path d="M 496,48 C 479.2,48 480,32 480,32 " style="fill:none;"/>
<path d="M 496,48 C 512.8,48 512,32 512,32 " style="fill:none;"/>
<path d="M 208,80 C 191.2,80 192,96 192,96 " style="fill:none;"/>
<path d="M 224,80 C 240.8,80 240,96 240,96 " style="fill:none;"/>
<path d="M 304,80 C 287.2,80 288,96 288,96 " style="fill:none;"/>
<path d="M 320,80 C 336.8,80 336,96 336,96 " style="fill:none;"/>
<path d="M 400,80 C 383.2,80 384,96 384,96 " style="fill:none;"/>
<path d="M 416,80 C 432.8,80 432,96 432,96 " style="fill:none;"/>
<path d="M 496,80 C 479.2,80 480,96 480,96 " style="fill:none;"/>
<path d="M 512,80 C 528.8,80 528,96 528,96 " style="fill:none;"/>
<path d="M 176,112 C 192.8,112 192,96 192,96 " style="fill:none;"/>
<path d="M 256,112 C 239.2,112 240,96 240,96 " style="fill:none;"/>
<path d="M 272,112 C 288.8,112 288,96 288,96 " style="fill:none;"/>
<path d="M 352,112 C 335.2,112 336,96 336,96 " style="fill:none;"/>
<path d="M 368,112 C 384.8,112 384,96 384,96 " style="fill:none;"/>
<path d="M 448,112 C 431.2,112 432,96 432,96 " style="fill:none;"/>
<path d="M 464,112 C 480.8,112 480,96 480,96 " style="fill:none;"/>
<path d="M 208,176 C 191.2,176 192,192 192,192 " style="fill:none;"/>
<path d="M 208,176 C 224.8,176 224,192 224,192 " style="fill:none;"/>
<path d="M 272,176 C 255.2,176 256,192 256,192 " style="fill:none;"/>
<path d="M 272,176 C 288.8,176 288,192 288,192 " style="fill:none;"/>
<path d="M 320,176 C 336.8,176 336,192 336,192 " style="fill:none;"/>
<path d="M 400,176 C 383.2,176 384,192 384,192 " style="fill:none;"/>
<path d="M 416,176 C 432.8,176 432,192 432,192 " style="fill:none;"/>
<path d="M 496,176 C 479.2,176 480,192 480,192 " style="fill:none;"/>
<path d="M 512,176 C 528.8,176 528,192 528,192 " style="fill:none;"/>
<path d="M 176,208 C 192.8,208 192,192 192,192 " style="fill:none;"/>
<path d="M 240,208 C 223.2,208 224,192 224,192 " style="fill:none;"/>
<path d="M 240,208 C 256.8,208 256,192 256,192 " style="fill:none;"/>
<path d="M 304,208 C 287.2,208 288,192 288,192 " style="fill:none;"/>
<path d="M 352,208 C 335.2,208 336,192 336,192 " style="fill:none;"/>
<path d="M 368,208 C 384.8,208 384,192 384,192 " style="fill:none;"/>
<path d="M 448,208 C 431.2,208 432,192 432,192 " style="fill:none;"/>
<path d="M 464,208 C 480.8,208 480,192 480,192 " style="fill:none;"/>
<polygon points="536,144 524,138.4 524,149.6 "  style="stroke:none" transform="rotate(0,528,144 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="168" y="4">0</text><text text-anchor="middle" x="520" y="20">.</text><text text-anchor="middle" x="528" y="20">.</text><text text-anchor="middle" x="536" y="20">.</text><text text-anchor="middle" x="112" y="36">w</text><text text-anchor="middle" x="120" y="36">a</text><text text-anchor="middle" x="128" y="36">v</text><text text-anchor="middle" x="136" y="36">e</text><text text-anchor="middle" x="152" y="36">x</text><text text-anchor="middle" x="208" y="36">┊</text><text text-anchor="middle" x="272" y="36">┊</text><text text-anchor="middle" x="336" y="36">┊</text><text text-anchor="middle" x="400" y="36">┊</text><text text-anchor="middle" x="464" y="36">┊</text><text text-anchor="middle" x="208" y="52">┊</text><text text-anchor="middle" x="272" y="52">┊</text><text text-anchor="middle" x="336" y="52">┊</text><text text-anchor="middle" x="400" y="52">┊</text><text text-anchor="middle" x="464" y="52">┊</text><text text-anchor="middle" x="208" y="68">┊</text><text text-anchor="middle" x="272" y="68">┊</text><text text-anchor="middle" x="336" y="68">┊</text><text text-anchor="middle" x="400" y="68">┊</text><text text-anchor="middle" x="464" y="68">┊</text><text text-anchor="middle" x="272" y="84">┊</text><text text-anchor="middle" x="464" y="84">┊</text><text text-anchor="middle" x="112" y="100">w</text><text text-anchor="middle" x="120" y="100">a</text><text text-anchor="middle" x="128" y="100">v</text><text text-anchor="middle" x="136" y="100">e</text><text text-anchor="middle" x="152" y="100">y</text><text text-anchor="middle" x="208" y="100">┊</text><text text-anchor="middle" x="272" y="100">┊</text><text text-anchor="middle" x="400" y="100">┊</text><text text-anchor="middle" x="464" y="100">┊</text><text text-anchor="middle" x="536" y="100">.</text><text text-anchor="middle" x="544" y="100">.</text><text text-anchor="middle" x="552" y="100">.</text><text text-anchor="middle" x="208" y="116">┊</text><text text-anchor="middle" x="400" y="116">┊</text><text text-anchor="middle" x="16" y="148">R</text><text text-anchor="middle" x="24" y="148">u</text><text text-anchor="middle" x="32" y="148">n</text><text text-anchor="middle" x="40" y="148">n</text><text text-anchor="middle" x="48" y="148">i</text><text text-anchor="middle" x="56" y="148">n</text><text text-anchor="middle" x="64" y="148">g</text><text text-anchor="middle" x="72" y="148">S</text><text text-anchor="middle" x="80" y="148">a</text><text text-anchor="middle" x="88" y="148">m</text><text text-anchor="middle" x="96" y="148">p</text><text text-anchor="middle" x="104" y="148">l</text><text text-anchor="middle" x="112" y="148">e</text><text text-anchor="middle" x="120" y="148">I</text><text text-anchor="middle" x="128" y="148">n</text><text text-anchor="middle" x="136" y="148">d</text><text text-anchor="middle" x="144" y="148">e</text><text text-anchor="middle" x="152" y="148">x</text><text text-anchor="middle" x="536" y="148">.</text><text text-anchor="middle" x="544" y="148">.</text><text text-anchor="middle" x="552" y="148">.</text><text text-anchor="middle" x="72" y="196">f</text><text text-anchor="middle" x="80" y="196">i</text><text text-anchor="middle" x="88" y="196">n</text><text text-anchor="middle" x="96" y="196">a</text><text text-anchor="middle" x="104" y="196">l</text><text text-anchor="middle" x="120" y="196">b</text><text text-anchor="middle" x="128" y="196">l</text><text text-anchor="middle" x="136" y="196">e</text><text text-anchor="middle" x="144" y="196">n</text><text text-anchor="middle" x="152" y="196">d</text><text text-anchor="middle" x="208" y="196">┊</text><text text-anchor="middle" x="272" y="196">┊</text><text text-anchor="middle" x="536" y="196">.</text><text text-anchor="middle" x="544" y="196">.</text><text text-anchor="middle" x="552" y="196">.</text><text text-anchor="middle" x="208" y="212">┊</text><text text-anchor="middle" x="272" y="212">┊</text><text text-anchor="middle" x="184" y="260">w</text><text text-anchor="middle" x="192" y="260">a</text><text text-anchor="middle" x="200" y="260">v</text><text text-anchor="middle" x="208" y="260">e</text><text text-anchor="middle" x="224" y="260">p</text><text text-anchor="middle" x="232" y="260">e</text><text text-anchor="middle" x="240" y="260">r</text><text text-anchor="middle" x="248" y="260">i</text><text text-anchor="middle" x="256" y="260">o</text><text text-anchor="middle" x="264" y="260">d</text><text text-anchor="middle" x="280" y="260">X</text><text text-anchor="middle" x="360" y="260">w</text><text text-anchor="middle" x="368" y="260">a</text><text text-anchor="middle" x="376" y="260">v</text><text text-anchor="middle" x="384" y="260">e</text><text text-anchor="middle" x="400" y="260">p</text><text text-anchor="middle" x="408" y="260">e</text><text text-anchor="middle" x="416" y="260">r</text><text text-anchor="middle" x="424" y="260">i</text><text text-anchor="middle" x="432" y="260">o</text><text text-anchor="middle" x="440" y="260">d</text><text text-anchor="middle" x="456" y="260">Y</text></g></g></svg>

</p><p>

*
*

</p><p>

To be able to fix this issue, we need to keep track of our position in the sine wave, the <code>t</code> of the sine, and then gradulally increase it by whichever amount we'd like to advance. And we want to advance by a single increment (as opposed to the whole <code>RunningSampleIndex</code>) multiplied by \(2/pi\) and divided by the wave period:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">win32_sound_output</span></span>
<span class="line">{</span></span>
<span class="line">    <span class="hljs-keyword">int</span> SamplesPerSecond;</span>
<span class="line">    <span class="hljs-keyword">int</span> BytesPerSample;</span>
<span class="line">    <span class="hljs-keyword">int</span> SecondaryBufferSize;</span>
<span class="line">    u32 RunningSampleIndex;</span>
<span class="line">    <span class="hljs-keyword">int</span> ToneHz;</span>
<span class="line">    <span class="hljs-keyword">int</span> ToneVolume;</span>
<span class="line">    <span class="hljs-keyword">int</span> WavePeriod;</span><div class=" add"><span class="line">    f32 tSine;</span></div><span class="line">};</span></code></pre><p>
~~~~~~~ C++
s16 <em class="asterisk">SampleOut = (s16 </em>)Region1;
DWORD Region1SampleCount = Region1Size / SoundOutput->BytesPerSample;
for (DWORD SampleIndex = 0;
        SampleIndex < Region1SampleCount;
        ++SampleIndex)
{
</p><pre class="listing tilde"><code><div class=" delete"><span class="line">    f32 t = <span class="hljs-number">2.0f</span> * Pi32 * (f32)SoundOutput-&gt;RunningSampleIndex / (f32)SoundOutput-&gt;WavePeriod;</span></div><div class=" edit"><span class="line">    f32 SineValue = sinf(SoundOutput-&gt;tSine);</span></div><div class=" C++ "><span class="line">    s16 SampleValue = (s16)(SineValue * SoundOutput-&gt;ToneVolume);</span>
<span class="line">    </span>
<span class="line">    *SampleOut++ = SampleValue;</span>
<span class="line">    *SampleOut++ = SampleValue;</span>
<span class="line">    </span></div><div class=" add"><span class="line">    SoundOutput-&gt;tSine += (<span class="hljs-number">2.0f</span> * Pi32 * <span class="hljs-number">1.0f</span>) / (f32)SoundOutput-&gt;WavePeriod;</span></div><span class="line">    ++SoundOutput-&gt;RunningSampleIndex;</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">SampleOut = (s16 *)Region2;</span>
<span class="line">DWORD Region2SampleCount = Region2Size / SoundOutput-&gt;BytesPerSample;</span>
<span class="line"><span class="hljs-keyword">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line">        SampleIndex &lt; Region2SampleCount;</span>
<span class="line">        ++SampleIndex)</span>
<span class="line">{</span><div class=" delete"><span class="line">    f32 t = <span class="hljs-number">2.0f</span> * Pi32 * (f32)SoundOutput-&gt;RunningSampleIndex / (f32)SoundOutput-&gt;WavePeriod;</span></div><div class=" edit"><span class="line">    f32 SineValue = sinf(SoundOutput-&gt;tSine);</span></div><div class=" C++ "><span class="line">    s16 SampleValue = (s16)(SineValue * SoundOutput-&gt;ToneVolume);</span>
<span class="line">    </span>
<span class="line">    *SampleOut++ = SampleValue;</span>
<span class="line">    *SampleOut++ = SampleValue;</span>
<span class="line">    </span></div><div class=" add"><span class="line">    SoundOutput-&gt;tSine += (<span class="hljs-number">2.0f</span> * Pi32 * <span class="hljs-number">1.0f</span>) / (f32)SoundOutput-&gt;WavePeriod;</span></div><span class="line">    ++SoundOutput-&gt;RunningSampleIndex;</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;21:</b> <file>[win32_handmade.cpp; win32_handmade.cpp > Win32FillSoundBuffer]</file> Storing the <code>tSine</code> to be able to vary the sine wave on the fly.</div></center>
<p>


If you recompile now, you'll note that this solves this bug.

</p>
<a class="target" name="mapthepitchtothesticks">&nbsp;</a><a class="target" name="linkthepitchtouserinput/mapthepitchtothesticks">&nbsp;</a><a class="target" name="toc4.3">&nbsp;</a><h2>Map the Pitch to the Sticks</h2>
<p>


Let's go crazy. We can say &ldquo;Our pitch depends on whatever the current input from a controller stick is&rdquo;. Keep in mind that the value from the sticks right now can go up to 65565, so we'll need to tune it down a bit. We'll do all the math in floating point and then will cast down to int.

</p><pre class="listing tilde"><code><div class=" delete"><span class="line"><span class="hljs-keyword">if</span>(AButton)</span>
<span class="line">{</span>
<span class="line">    SoundOutput.ToneHz = <span class="hljs-number">512</span>;</span>
<span class="line">    SoundOutput.WavePeriod = SoundOutput.SamplesPerSecond / SoundOutput.ToneHz;</span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (BButton)</span>
<span class="line">{</span>
<span class="line">    SoundOutput.ToneHz = <span class="hljs-number">512</span>;</span>
<span class="line">    SoundOutput.WavePeriod = SoundOutput.SamplesPerSecond / SoundOutput.ToneHz;</span>
<span class="line">}</span></div><div class=" add"><span class="line">SoundOutput.ToneHz = <span class="hljs-number">512</span> + (<span class="hljs-keyword">int</span>)(<span class="hljs-number">256.0f</span> * ((f32)StickY / <span class="hljs-number">30000.0f</span>));</span>
<span class="line">SoundOutput.WavePeriod = SoundOutput.SamplesPerSecond / SoundOutput.ToneHz;</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;22:</b> <file>[win32_handmade.cpp > WinMain]</file> Using the StickY to change our pitch.</div></center>

<a class="target" name="lowerthelatency">&nbsp;</a><a class="target" name="linkthepitchtouserinput/lowerthelatency">&nbsp;</a><a class="target" name="toc4.4">&nbsp;</a><h2>Lower the Latency</h2>
<p>


Ok, we've now seen that two second buffer creates a bit too much of a delay. Right now we're writing with a whole buffer latency, so let's try to lower it down.

</p><p>

Let's introduce a latency sample count which would stand for how much ahead of the cursor we'd want to be. For now, let's say it's \(\dfrac{1}{15}\) of a second, and we can adjust it later in case. Eventually we'll want it to be much higher, like \(\dfrac{1}{60}\) of a second. 

</p><p>

On our first run, we'll fill our buffer only by whatever the <code>LatencySampleCount</code> is (multiplied by <code>BytesPerSample</code>).

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">win32_sound_output</span></span>
<span class="line">{</span></span>
<span class="line">    <span class="hljs-keyword">int</span> SamplesPerSecond;</span>
<span class="line">    <span class="hljs-keyword">int</span> BytesPerSample;</span>
<span class="line">    <span class="hljs-keyword">int</span> SecondaryBufferSize;</span>
<span class="line">    u32 RunningSampleIndex;</span>
<span class="line">    <span class="hljs-keyword">int</span> ToneHz;</span>
<span class="line">    <span class="hljs-keyword">int</span> ToneVolume;</span>
<span class="line">    <span class="hljs-keyword">int</span> WavePeriod;</span>
<span class="line">    f32 tSine;</span><div class=" add"><span class="line">    <span class="hljs-keyword">int</span> LatencySampleCount;</span></div><span class="line">};</span></code></pre><p>
~~~~~~~ C++ 
SoundOutput.SamplesPerSecond = 48000;
SoundOutput.BytesPerSample = sizeof(s16) * 2;
SoundOutput.SecondaryBufferSize = 2 * SoundOutput.SamplesPerSecond * SoundOutput.BytesPerSample;
SoundOutput.RunningSampleIndex = 0;
SoundOutput.ToneHz = 256;
SoundOutput.ToneVolume = 3000;
SoundOutput.WavePeriod = SoundOutput.SamplesPerSecond / SoundOutput.ToneHz;
</p><pre class="listing tilde"><code><div class=" add"><span class="line">SoundOutput.LatencySampleCount = SoundOutput.SamplesPerSecond / <span class="hljs-number">15</span>;</span></div><div class=" C++ "><span class="line">Win32InitDSound(Window, SoundOutput.SamplesPerSecond, SoundOutput.SecondaryBufferSize);</span></div><div class=" edit"><span class="line">Win32FillSoundBuffer(&amp;SoundOutput, <span class="hljs-number">0</span>, (SoundOutput.LatencySampleCount * SoundOutput.BytesPerSample));</span></div><span class="line">GlobalSecondaryBuffer-&gt;Play(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, DSBPLAY_LOOPING);</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;23:</b> <file>[win32_handmade.cpp; win32_handmade.cpp > WinMain]</file> Introducing and Defining <code>LatencySampleCount</code>.</div></center>
<p>


We can then introduce a &ldquo;target cursor&rdquo; that will offset our <code>PlayCursor</code> by whatever our <code>LatencySampleCount</code> is (multiplied by <code>BytesPerPixel</code>). We'll then use the <code>TargetCursor</code> wherever we were using the <code>PlayCursor</code> before:

</p><pre class="listing tilde"><code><span class="line">DWORD ByteToLock = (SoundOutput.RunningSampleIndex * SoundOutput.BytesPerSample) % SoundOutput.SecondaryBufferSize;</span><div class=" add"><span class="line">DWORD TargetCursor = PlayCursor + (SoundOutput.LatencySampleCount * SoundOutput.BytesPerSample);</span></div><span class="line">DWORD BytesToWrite;</span><div class=" edit"><span class="line"><span class="hljs-keyword">if</span>(ByteToLock &gt; TargetCursor)</span></div><span class="line">{</span>
<span class="line">    BytesToWrite = SoundOutput.SecondaryBufferSize - ByteToLock;</span><div class=" edit"><span class="line">    BytesToWrite += TargetCursor;</span></div><span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span></span>
<span class="line">{</span><div class=" edit"><span class="line">    BytesToWrite = TargetCursor - ByteToLock;</span></div><span class="line">}</span>
<span class="line"></span>
<span class="line">Win32FillSoundBuffer(&amp;SoundOutput, ByteToLock, BytesToWrite);</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;24:</b> <file>[win32_handmade.cpp; win32_handmade.cpp > WinMain]</file> Introducing <code>TargetCursor</code>.</div></center>
<p>


This however introduces a bug: there're occasional skips here and there. 

</p><p>

In the past couple lessons we talked so much about the circular buffers, that you might have noticed already what the problem is: we didn't account for the fact when the <code>PlayCursor</code> wraps around, and there not enough space for the <code>TargetCursor</code>. To fix that, we simply need to mod the result of our <code>TargetCursor</code> calculation with the <code>SecondaryBufferSize</code> as we did for our <code>ByteToLock</code> above. 

</p><p>

Remember to account for operator precedence! We want multiplication &rarr; addition &rarr; modulation, and addition is the &ldquo;weaker&rdquo; operation, so we need to wrap the operations accordingly.

</p><pre class="listing tilde"><code><span class="line">DWORD ByteToLock = (SoundOutput.RunningSampleIndex * SoundOutput.BytesPerSample) % SoundOutput.SecondaryBufferSize;</span><div class=" edit"><span class="line">DWORD TargetCursor = ((PlayCursor + (SoundOutput.LatencySampleCount * SoundOutput.BytesPerSample))</span>
<span class="line">                                          % SoundOutput.SecondaryBufferSize);</span></div><span class="line">DWORD BytesToWrite;</span>
<span class="line"><span class="hljs-comment">//...</span></span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;25:</b> <file>[win32_handmade.cpp; win32_handmade.cpp > WinMain]</file> Fixing <code>TargetCursor</code>.</div></center>

<a class="target" name="recap">&nbsp;</a><a class="target" name="recap">&nbsp;</a><a class="target" name="toc5">&nbsp;</a><h1>Recap</h1>
<p>


We achieved our today's objective of debugging the sound buffer, and even went further! 

</p><p>

For now though, we're happy with our sound so next time we'll get to implementing a new and exciting feature: timers!

</p>
<a class="target" name="exercises">&nbsp;</a><a class="target" name="exercises">&nbsp;</a><a class="target" name="toc6">&nbsp;</a><h1>Exercises</h1>

<a class="target" name="mapthetonechangetokeyboard">&nbsp;</a><a class="target" name="exercises/mapthetonechangetokeyboard">&nbsp;</a><a class="target" name="toc6.1">&nbsp;</a><h2>Map the Tone Change to Keyboard</h2>
<p>


If you don't have access to controllers (or want an extra challenge), you might want to do what we described in section  <a href="#toc4">4</a> using keyboard. It might be more complex since you currently don't have access to <code>SoundOutput</code> in the <code>Win32MainWindowCallback</code>. What will you do?

</p>
<a class="target" name="programmingnotions">&nbsp;</a><a class="target" name="programmingnotions">&nbsp;</a><a class="target" name="toc7">&nbsp;</a><h1>Programming Notions</h1>

<a class="target" name="introtofloatingpoint">&nbsp;</a><a class="target" name="programmingnotions/introtofloatingpoint">&nbsp;</a><a class="target" name="toc7.1">&nbsp;</a><h2>Intro to Floating Point</h2>
<p>


<a href="https://en.wikipedia.org/wiki/Floating-point_arithmetic">Floating point numbers</a> are a way to represent in computer systems the <em class="underscore">real numbers</em> (i.e. the numbers which have a fraction, like the \(\pi\) number). In C and C++, these are expressed in <code>float</code> and <code>double</code> built-in types, for 32-bit and 64-bit accuracy, respectively. 

</p><p>

Now, contrary to <code>int</code> or <code>short</code> or <code>long</code>, floating-point types <code>float</code> and <code>double</code> usually have a defined width accross the board. This is because floating point numbers are so complex, there's a whole Standard established for them (called <a href="https://en.wikipedia.org/wiki/IEEE_754">IEEE 754</a>). It's a very rigorously defined thing. There's not a lot of ambiguity as to how these numbers operate, and there are reasons behind all of it. During this course we'll be referring to some of it, but many of the minutia defined we'll never really get to. These minutia are useful in the scientific computing or some very delicate numeric algorithms. For instance, you might care if something is <em class="underscore">positive</em> or <em class="underscore">negative</em> zero (which is a thing). 

</p><p>

For now you only need to know a few things: floating point number is a number which allows setting up a fraction. Also, by default the compiler assumes that you're writing a 64-bit fraction, so if you want to use a 32-bit fraction, you should add an <code>f</code> at the end, so your numbers end like this: <code>3.14159f</code>.

</p><p>

We are also going to mostly do our math in the floating point because the modern processors have a lot of horsepower designed to facilitate the floating point math, and we want to take advantage of that. That was not always the case, by the way: old home computers often didn't have the expensive Floating Point Unit (the FPU), and all the math was done in integers simulating floating point behaviour. This of course was quite <em class="underscore">expensive</em> and taking a lot of processor power away. 

</p><p>

<div class="admonition warning">Some additional expansion on the matter and some math follows. This will help you to understand how numbers work in computers!</div>

</p><p>

Often this was done using what's called the <em class="underscore">fixed point</em>. Let's visualize the two to understand the difference. 

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="144" width="600" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 40,16 L 40,48 " style="fill:none;"/>
<path d="M 40,80 L 40,96 " style="fill:none;"/>
<path d="M 56,16 L 56,48 " style="fill:none;"/>
<path d="M 72,16 L 72,48 " style="fill:none;"/>
<path d="M 88,16 L 88,48 " style="fill:none;"/>
<path d="M 104,16 L 104,48 " style="fill:none;"/>
<path d="M 120,16 L 120,48 " style="fill:none;"/>
<path d="M 136,16 L 136,48 " style="fill:none;"/>
<path d="M 152,16 L 152,48 " style="fill:none;"/>
<path d="M 168,16 L 168,48 " style="fill:none;"/>
<path d="M 168,80 L 168,96 " style="fill:none;"/>
<path d="M 184,16 L 184,48 " style="fill:none;"/>
<path d="M 200,16 L 200,48 " style="fill:none;"/>
<path d="M 216,16 L 216,48 " style="fill:none;"/>
<path d="M 232,16 L 232,48 " style="fill:none;"/>
<path d="M 248,16 L 248,48 " style="fill:none;"/>
<path d="M 264,16 L 264,48 " style="fill:none;"/>
<path d="M 280,16 L 280,48 " style="fill:none;"/>
<path d="M 296,16 L 296,48 " style="fill:none;"/>
<path d="M 296,80 L 296,96 " style="fill:none;"/>
<path d="M 312,16 L 312,48 " style="fill:none;"/>
<path d="M 328,16 L 328,48 " style="fill:none;"/>
<path d="M 344,16 L 344,48 " style="fill:none;"/>
<path d="M 360,16 L 360,48 " style="fill:none;"/>
<path d="M 376,16 L 376,48 " style="fill:none;"/>
<path d="M 392,16 L 392,48 " style="fill:none;"/>
<path d="M 408,16 L 408,48 " style="fill:none;"/>
<path d="M 424,16 L 424,48 " style="fill:none;"/>
<path d="M 424,80 L 424,96 " style="fill:none;"/>
<path d="M 440,16 L 440,48 " style="fill:none;"/>
<path d="M 456,16 L 456,48 " style="fill:none;"/>
<path d="M 472,16 L 472,48 " style="fill:none;"/>
<path d="M 488,16 L 488,48 " style="fill:none;"/>
<path d="M 504,16 L 504,48 " style="fill:none;"/>
<path d="M 520,16 L 520,48 " style="fill:none;"/>
<path d="M 536,16 L 536,48 " style="fill:none;"/>
<path d="M 552,16 L 552,48 " style="fill:none;"/>
<path d="M 552,80 L 552,96 " style="fill:none;"/>
<path d="M 40,16 L 552,16 " style="fill:none;"/>
<path d="M 40,48 L 552,48 " style="fill:none;"/>
<path d="M 40,96 L 552,96 " style="fill:none;"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="16" y="4">3</text><text text-anchor="middle" x="24" y="4">1</text><text text-anchor="middle" x="32" y="4">s</text><text text-anchor="middle" x="40" y="4">t</text><text text-anchor="middle" x="56" y="4">b</text><text text-anchor="middle" x="64" y="4">i</text><text text-anchor="middle" x="72" y="4">t</text><text text-anchor="middle" x="528" y="4">0</text><text text-anchor="middle" x="536" y="4">t</text><text text-anchor="middle" x="544" y="4">h</text><text text-anchor="middle" x="560" y="4">b</text><text text-anchor="middle" x="568" y="4">i</text><text text-anchor="middle" x="576" y="4">t</text><text text-anchor="middle" x="80" y="116">b</text><text text-anchor="middle" x="88" y="116">y</text><text text-anchor="middle" x="96" y="116">t</text><text text-anchor="middle" x="104" y="116">e</text><text text-anchor="middle" x="120" y="116">3</text><text text-anchor="middle" x="216" y="116">b</text><text text-anchor="middle" x="224" y="116">y</text><text text-anchor="middle" x="232" y="116">t</text><text text-anchor="middle" x="240" y="116">e</text><text text-anchor="middle" x="256" y="116">2</text><text text-anchor="middle" x="344" y="116">b</text><text text-anchor="middle" x="352" y="116">y</text><text text-anchor="middle" x="360" y="116">t</text><text text-anchor="middle" x="368" y="116">e</text><text text-anchor="middle" x="384" y="116">1</text><text text-anchor="middle" x="464" y="116">b</text><text text-anchor="middle" x="472" y="116">y</text><text text-anchor="middle" x="480" y="116">t</text><text text-anchor="middle" x="488" y="116">e</text><text text-anchor="middle" x="504" y="116">0</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;5:</b> 32-bit integer</div></center>

</p><p>

If you take this 32-bit integer, you can imagine various ways into how it can be divided. So far, we were assuming that the integer is one of the following: 

</p><p>

<ul>
<li class="asterisk"><strong class="asterisk">Unsigned</strong>: All of the bits act together to give you one value. You have all the bits set each representing a multiple of 2, you add them all together and you end up with a number. For instance, if you have the bottom 3 bits set, you know that your value is \(1 + 2 + 4 = 7\).
</li>
<li class="asterisk"><strong class="asterisk">Signed</strong>: We've been using negative numbers, and the negative numbers use a system called <a href="https://en.wikipedia.org/wiki/Two%27s_complement">Two's complement</a>. The high bit determines the <em class="underscore">sign</em> of the number: if it's set, it's a negative number. The rest of the numbers are encoded in such a way that the math works out anyway even if they are negative. They are interpreted slightly differently, and we will touch this at some point.</li></ul>

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="368" width="784" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 96,32 L 96,64 " style="fill:none;"/>
<path d="M 96,96 L 96,128 " style="fill:none;"/>
<path d="M 96,176 L 96,208 " style="fill:none;"/>
<path d="M 96,304 L 96,336 " style="fill:none;"/>
<path d="M 104,216 L 104,296 " style="fill:none;"/>
<path d="M 112,32 L 112,64 " style="fill:none;"/>
<path d="M 112,96 L 112,128 " style="fill:none;"/>
<path d="M 112,176 L 112,208 " style="fill:none;"/>
<path d="M 112,304 L 112,336 " style="fill:none;"/>
<path d="M 128,32 L 128,64 " style="fill:none;"/>
<path d="M 128,96 L 128,128 " style="fill:none;"/>
<path d="M 128,176 L 128,208 " style="fill:none;"/>
<path d="M 128,304 L 128,336 " style="fill:none;"/>
<path d="M 144,32 L 144,64 " style="fill:none;"/>
<path d="M 144,96 L 144,128 " style="fill:none;"/>
<path d="M 144,176 L 144,208 " style="fill:none;"/>
<path d="M 144,304 L 144,336 " style="fill:none;"/>
<path d="M 160,32 L 160,64 " style="fill:none;"/>
<path d="M 160,96 L 160,128 " style="fill:none;"/>
<path d="M 160,176 L 160,208 " style="fill:none;"/>
<path d="M 160,304 L 160,336 " style="fill:none;"/>
<path d="M 176,32 L 176,64 " style="fill:none;"/>
<path d="M 176,96 L 176,128 " style="fill:none;"/>
<path d="M 176,176 L 176,208 " style="fill:none;"/>
<path d="M 176,304 L 176,336 " style="fill:none;"/>
<path d="M 192,32 L 192,64 " style="fill:none;"/>
<path d="M 192,96 L 192,128 " style="fill:none;"/>
<path d="M 192,176 L 192,208 " style="fill:none;"/>
<path d="M 192,304 L 192,336 " style="fill:none;"/>
<path d="M 208,32 L 208,64 " style="fill:none;"/>
<path d="M 208,96 L 208,128 " style="fill:none;"/>
<path d="M 208,176 L 208,208 " style="fill:none;"/>
<path d="M 208,304 L 208,336 " style="fill:none;"/>
<path d="M 224,32 L 224,64 " style="fill:none;"/>
<path d="M 224,96 L 224,128 " style="fill:none;"/>
<path d="M 224,176 L 224,208 " style="fill:none;"/>
<path d="M 224,304 L 224,336 " style="fill:none;"/>
<path d="M 240,32 L 240,64 " style="fill:none;"/>
<path d="M 240,96 L 240,128 " style="fill:none;"/>
<path d="M 240,176 L 240,208 " style="fill:none;"/>
<path d="M 240,304 L 240,336 " style="fill:none;"/>
<path d="M 256,32 L 256,64 " style="fill:none;"/>
<path d="M 256,96 L 256,128 " style="fill:none;"/>
<path d="M 256,176 L 256,208 " style="fill:none;"/>
<path d="M 256,304 L 256,336 " style="fill:none;"/>
<path d="M 272,32 L 272,64 " style="fill:none;"/>
<path d="M 272,96 L 272,128 " style="fill:none;"/>
<path d="M 272,176 L 272,208 " style="fill:none;"/>
<path d="M 272,304 L 272,336 " style="fill:none;"/>
<path d="M 288,32 L 288,64 " style="fill:none;"/>
<path d="M 288,96 L 288,128 " style="fill:none;"/>
<path d="M 288,176 L 288,208 " style="fill:none;"/>
<path d="M 288,304 L 288,336 " style="fill:none;"/>
<path d="M 304,32 L 304,64 " style="fill:none;"/>
<path d="M 304,96 L 304,128 " style="fill:none;"/>
<path d="M 304,176 L 304,208 " style="fill:none;"/>
<path d="M 304,304 L 304,336 " style="fill:none;"/>
<path d="M 320,32 L 320,64 " style="fill:none;"/>
<path d="M 320,96 L 320,128 " style="fill:none;"/>
<path d="M 320,176 L 320,208 " style="fill:none;"/>
<path d="M 320,304 L 320,336 " style="fill:none;"/>
<path d="M 336,32 L 336,64 " style="fill:none;"/>
<path d="M 336,96 L 336,128 " style="fill:none;"/>
<path d="M 336,176 L 336,208 " style="fill:none;"/>
<path d="M 336,304 L 336,336 " style="fill:none;"/>
<path d="M 352,32 L 352,64 " style="fill:none;"/>
<path d="M 352,96 L 352,128 " style="fill:none;"/>
<path d="M 352,176 L 352,208 " style="fill:none;"/>
<path d="M 352,304 L 352,336 " style="fill:none;"/>
<path d="M 368,32 L 368,64 " style="fill:none;"/>
<path d="M 368,96 L 368,128 " style="fill:none;"/>
<path d="M 368,176 L 368,208 " style="fill:none;"/>
<path d="M 368,304 L 368,336 " style="fill:none;"/>
<path d="M 384,32 L 384,64 " style="fill:none;"/>
<path d="M 384,96 L 384,128 " style="fill:none;"/>
<path d="M 384,176 L 384,208 " style="fill:none;"/>
<path d="M 384,304 L 384,336 " style="fill:none;"/>
<path d="M 400,32 L 400,64 " style="fill:none;"/>
<path d="M 400,96 L 400,128 " style="fill:none;"/>
<path d="M 400,176 L 400,208 " style="fill:none;"/>
<path d="M 400,304 L 400,336 " style="fill:none;"/>
<path d="M 416,32 L 416,64 " style="fill:none;"/>
<path d="M 416,96 L 416,128 " style="fill:none;"/>
<path d="M 416,176 L 416,208 " style="fill:none;"/>
<path d="M 416,304 L 416,336 " style="fill:none;"/>
<path d="M 432,32 L 432,64 " style="fill:none;"/>
<path d="M 432,96 L 432,128 " style="fill:none;"/>
<path d="M 432,176 L 432,208 " style="fill:none;"/>
<path d="M 432,304 L 432,336 " style="fill:none;"/>
<path d="M 448,32 L 448,64 " style="fill:none;"/>
<path d="M 448,96 L 448,128 " style="fill:none;"/>
<path d="M 448,176 L 448,208 " style="fill:none;"/>
<path d="M 448,304 L 448,336 " style="fill:none;"/>
<path d="M 464,32 L 464,64 " style="fill:none;"/>
<path d="M 464,96 L 464,128 " style="fill:none;"/>
<path d="M 464,176 L 464,208 " style="fill:none;"/>
<path d="M 464,304 L 464,336 " style="fill:none;"/>
<path d="M 480,32 L 480,64 " style="fill:none;"/>
<path d="M 480,96 L 480,128 " style="fill:none;"/>
<path d="M 480,176 L 480,208 " style="fill:none;"/>
<path d="M 480,304 L 480,336 " style="fill:none;"/>
<path d="M 496,32 L 496,64 " style="fill:none;"/>
<path d="M 496,96 L 496,128 " style="fill:none;"/>
<path d="M 496,176 L 496,208 " style="fill:none;"/>
<path d="M 496,304 L 496,336 " style="fill:none;"/>
<path d="M 512,32 L 512,64 " style="fill:none;"/>
<path d="M 512,96 L 512,128 " style="fill:none;"/>
<path d="M 512,176 L 512,208 " style="fill:none;"/>
<path d="M 512,304 L 512,336 " style="fill:none;"/>
<path d="M 528,32 L 528,64 " style="fill:none;"/>
<path d="M 528,96 L 528,128 " style="fill:none;"/>
<path d="M 528,176 L 528,208 " style="fill:none;"/>
<path d="M 528,304 L 528,336 " style="fill:none;"/>
<path d="M 544,32 L 544,64 " style="fill:none;"/>
<path d="M 544,96 L 544,128 " style="fill:none;"/>
<path d="M 544,176 L 544,208 " style="fill:none;"/>
<path d="M 544,304 L 544,336 " style="fill:none;"/>
<path d="M 560,32 L 560,64 " style="fill:none;"/>
<path d="M 560,96 L 560,128 " style="fill:none;"/>
<path d="M 560,176 L 560,208 " style="fill:none;"/>
<path d="M 560,304 L 560,336 " style="fill:none;"/>
<path d="M 576,32 L 576,64 " style="fill:none;"/>
<path d="M 576,96 L 576,128 " style="fill:none;"/>
<path d="M 576,176 L 576,208 " style="fill:none;"/>
<path d="M 576,304 L 576,336 " style="fill:none;"/>
<path d="M 592,32 L 592,64 " style="fill:none;"/>
<path d="M 592,96 L 592,128 " style="fill:none;"/>
<path d="M 592,176 L 592,208 " style="fill:none;"/>
<path d="M 592,304 L 592,336 " style="fill:none;"/>
<path d="M 608,32 L 608,64 " style="fill:none;"/>
<path d="M 608,96 L 608,128 " style="fill:none;"/>
<path d="M 608,176 L 608,208 " style="fill:none;"/>
<path d="M 608,304 L 608,336 " style="fill:none;"/>
<path d="M 96,32 L 608,32 " style="fill:none;"/>
<path d="M 624,48 L 640,48 " style="fill:none;"/>
<path d="M 96,64 L 608,64 " style="fill:none;"/>
<path d="M 96,96 L 608,96 " style="fill:none;"/>
<path d="M 624,112 L 640,112 " style="fill:none;"/>
<path d="M 96,128 L 608,128 " style="fill:none;"/>
<path d="M 96,176 L 608,176 " style="fill:none;"/>
<path d="M 624,192 L 640,192 " style="fill:none;"/>
<path d="M 96,208 L 608,208 " style="fill:none;"/>
<path d="M 88,256 L 104,256 " style="fill:none;"/>
<path d="M 96,304 L 608,304 " style="fill:none;"/>
<path d="M 624,320 L 640,320 " style="fill:none;"/>
<path d="M 96,336 L 608,336 " style="fill:none;"/>
<polygon points="648,320 636,314.4 636,325.6 "  style="stroke:none" transform="rotate(0,640,320 )"/>
<polygon points="648,192 636,186.4 636,197.6 "  style="stroke:none" transform="rotate(0,640,192 )"/>
<polygon points="648,112 636,106.4 636,117.6 "  style="stroke:none" transform="rotate(0,640,112 )"/>
<polygon points="648,48 636,42.4 636,53.6 "  style="stroke:none" transform="rotate(0,640,48 )"/>
<polygon points="112,296 100,290.4 100,301.6 "  style="stroke:none" transform="rotate(90,104,296 )"/>
<polygon points="112,216 100,210.4 100,221.6 "  style="stroke:none" transform="rotate(270,104,216 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="64" y="4">3</text><text text-anchor="middle" x="72" y="4">1</text><text text-anchor="middle" x="80" y="4">s</text><text text-anchor="middle" x="88" y="4">t</text><text text-anchor="middle" x="104" y="4">b</text><text text-anchor="middle" x="112" y="4">i</text><text text-anchor="middle" x="120" y="4">t</text><text text-anchor="middle" x="576" y="4">0</text><text text-anchor="middle" x="584" y="4">t</text><text text-anchor="middle" x="592" y="4">h</text><text text-anchor="middle" x="608" y="4">b</text><text text-anchor="middle" x="616" y="4">i</text><text text-anchor="middle" x="624" y="4">t</text><text text-anchor="middle" x="272" y="20">U</text><text text-anchor="middle" x="280" y="20">N</text><text text-anchor="middle" x="288" y="20">S</text><text text-anchor="middle" x="296" y="20">I</text><text text-anchor="middle" x="304" y="20">G</text><text text-anchor="middle" x="312" y="20">N</text><text text-anchor="middle" x="320" y="20">E</text><text text-anchor="middle" x="328" y="20">D</text><text text-anchor="middle" x="344" y="20">3</text><text text-anchor="middle" x="352" y="20">2</text><text text-anchor="middle" x="360" y="20">-</text><text text-anchor="middle" x="368" y="20">B</text><text text-anchor="middle" x="376" y="20">I</text><text text-anchor="middle" x="384" y="20">T</text><text text-anchor="middle" x="400" y="20">I</text><text text-anchor="middle" x="408" y="20">N</text><text text-anchor="middle" x="416" y="20">T</text><text text-anchor="middle" x="424" y="20">E</text><text text-anchor="middle" x="432" y="20">G</text><text text-anchor="middle" x="440" y="20">E</text><text text-anchor="middle" x="448" y="20">R</text><text text-anchor="middle" x="104" y="52">0</text><text text-anchor="middle" x="120" y="52">0</text><text text-anchor="middle" x="136" y="52">0</text><text text-anchor="middle" x="152" y="52">0</text><text text-anchor="middle" x="168" y="52">0</text><text text-anchor="middle" x="184" y="52">0</text><text text-anchor="middle" x="200" y="52">0</text><text text-anchor="middle" x="216" y="52">0</text><text text-anchor="middle" x="232" y="52">0</text><text text-anchor="middle" x="248" y="52">0</text><text text-anchor="middle" x="264" y="52">0</text><text text-anchor="middle" x="280" y="52">0</text><text text-anchor="middle" x="296" y="52">0</text><text text-anchor="middle" x="312" y="52">0</text><text text-anchor="middle" x="328" y="52">0</text><text text-anchor="middle" x="344" y="52">0</text><text text-anchor="middle" x="360" y="52">0</text><text text-anchor="middle" x="376" y="52">0</text><text text-anchor="middle" x="392" y="52">0</text><text text-anchor="middle" x="408" y="52">0</text><text text-anchor="middle" x="424" y="52">0</text><text text-anchor="middle" x="440" y="52">0</text><text text-anchor="middle" x="456" y="52">0</text><text text-anchor="middle" x="472" y="52">0</text><text text-anchor="middle" x="488" y="52">0</text><text text-anchor="middle" x="504" y="52">0</text><text text-anchor="middle" x="520" y="52">0</text><text text-anchor="middle" x="536" y="52">0</text><text text-anchor="middle" x="552" y="52">0</text><text text-anchor="middle" x="568" y="52">1</text><text text-anchor="middle" x="584" y="52">1</text><text text-anchor="middle" x="600" y="52">1</text><text text-anchor="middle" x="656" y="52">7</text><text text-anchor="middle" x="104" y="116">1</text><text text-anchor="middle" x="120" y="116">1</text><text text-anchor="middle" x="136" y="116">1</text><text text-anchor="middle" x="152" y="116">1</text><text text-anchor="middle" x="168" y="116">1</text><text text-anchor="middle" x="184" y="116">1</text><text text-anchor="middle" x="200" y="116">1</text><text text-anchor="middle" x="216" y="116">1</text><text text-anchor="middle" x="232" y="116">1</text><text text-anchor="middle" x="248" y="116">1</text><text text-anchor="middle" x="264" y="116">1</text><text text-anchor="middle" x="280" y="116">1</text><text text-anchor="middle" x="296" y="116">1</text><text text-anchor="middle" x="312" y="116">1</text><text text-anchor="middle" x="328" y="116">1</text><text text-anchor="middle" x="344" y="116">1</text><text text-anchor="middle" x="360" y="116">1</text><text text-anchor="middle" x="376" y="116">1</text><text text-anchor="middle" x="392" y="116">1</text><text text-anchor="middle" x="408" y="116">1</text><text text-anchor="middle" x="424" y="116">1</text><text text-anchor="middle" x="440" y="116">1</text><text text-anchor="middle" x="456" y="116">1</text><text text-anchor="middle" x="472" y="116">1</text><text text-anchor="middle" x="488" y="116">1</text><text text-anchor="middle" x="504" y="116">1</text><text text-anchor="middle" x="520" y="116">1</text><text text-anchor="middle" x="536" y="116">1</text><text text-anchor="middle" x="552" y="116">1</text><text text-anchor="middle" x="568" y="116">0</text><text text-anchor="middle" x="584" y="116">0</text><text text-anchor="middle" x="600" y="116">0</text><text text-anchor="middle" x="656" y="116">4</text><text text-anchor="middle" x="664" y="116">,</text><text text-anchor="middle" x="672" y="116">2</text><text text-anchor="middle" x="680" y="116">9</text><text text-anchor="middle" x="688" y="116">4</text><text text-anchor="middle" x="696" y="116">,</text><text text-anchor="middle" x="704" y="116">9</text><text text-anchor="middle" x="712" y="116">6</text><text text-anchor="middle" x="720" y="116">7</text><text text-anchor="middle" x="728" y="116">,</text><text text-anchor="middle" x="736" y="116">2</text><text text-anchor="middle" x="744" y="116">8</text><text text-anchor="middle" x="752" y="116">8</text><text text-anchor="middle" x="280" y="164">S</text><text text-anchor="middle" x="288" y="164">I</text><text text-anchor="middle" x="296" y="164">G</text><text text-anchor="middle" x="304" y="164">N</text><text text-anchor="middle" x="312" y="164">E</text><text text-anchor="middle" x="320" y="164">D</text><text text-anchor="middle" x="336" y="164">3</text><text text-anchor="middle" x="344" y="164">2</text><text text-anchor="middle" x="352" y="164">-</text><text text-anchor="middle" x="360" y="164">B</text><text text-anchor="middle" x="368" y="164">I</text><text text-anchor="middle" x="376" y="164">T</text><text text-anchor="middle" x="392" y="164">I</text><text text-anchor="middle" x="400" y="164">N</text><text text-anchor="middle" x="408" y="164">T</text><text text-anchor="middle" x="416" y="164">E</text><text text-anchor="middle" x="424" y="164">G</text><text text-anchor="middle" x="432" y="164">E</text><text text-anchor="middle" x="440" y="164">R</text><text text-anchor="middle" x="72" y="196">+</text><text text-anchor="middle" x="104" y="196">0</text><text text-anchor="middle" x="120" y="196">0</text><text text-anchor="middle" x="136" y="196">0</text><text text-anchor="middle" x="152" y="196">0</text><text text-anchor="middle" x="168" y="196">0</text><text text-anchor="middle" x="184" y="196">0</text><text text-anchor="middle" x="200" y="196">0</text><text text-anchor="middle" x="216" y="196">0</text><text text-anchor="middle" x="232" y="196">0</text><text text-anchor="middle" x="248" y="196">0</text><text text-anchor="middle" x="264" y="196">0</text><text text-anchor="middle" x="280" y="196">0</text><text text-anchor="middle" x="296" y="196">0</text><text text-anchor="middle" x="312" y="196">0</text><text text-anchor="middle" x="328" y="196">0</text><text text-anchor="middle" x="344" y="196">0</text><text text-anchor="middle" x="360" y="196">0</text><text text-anchor="middle" x="376" y="196">0</text><text text-anchor="middle" x="392" y="196">0</text><text text-anchor="middle" x="408" y="196">0</text><text text-anchor="middle" x="424" y="196">0</text><text text-anchor="middle" x="440" y="196">0</text><text text-anchor="middle" x="456" y="196">0</text><text text-anchor="middle" x="472" y="196">0</text><text text-anchor="middle" x="488" y="196">0</text><text text-anchor="middle" x="504" y="196">0</text><text text-anchor="middle" x="520" y="196">0</text><text text-anchor="middle" x="536" y="196">0</text><text text-anchor="middle" x="552" y="196">0</text><text text-anchor="middle" x="568" y="196">1</text><text text-anchor="middle" x="584" y="196">1</text><text text-anchor="middle" x="600" y="196">1</text><text text-anchor="middle" x="656" y="196">7</text><text text-anchor="middle" x="16" y="260">s</text><text text-anchor="middle" x="24" y="260">i</text><text text-anchor="middle" x="32" y="260">g</text><text text-anchor="middle" x="40" y="260">n</text><text text-anchor="middle" x="56" y="260">b</text><text text-anchor="middle" x="64" y="260">i</text><text text-anchor="middle" x="72" y="260">t</text><text text-anchor="middle" x="72" y="324">-</text><text text-anchor="middle" x="104" y="324">1</text><text text-anchor="middle" x="120" y="324">1</text><text text-anchor="middle" x="136" y="324">1</text><text text-anchor="middle" x="152" y="324">1</text><text text-anchor="middle" x="168" y="324">1</text><text text-anchor="middle" x="184" y="324">1</text><text text-anchor="middle" x="200" y="324">1</text><text text-anchor="middle" x="216" y="324">1</text><text text-anchor="middle" x="232" y="324">1</text><text text-anchor="middle" x="248" y="324">1</text><text text-anchor="middle" x="264" y="324">1</text><text text-anchor="middle" x="280" y="324">1</text><text text-anchor="middle" x="296" y="324">1</text><text text-anchor="middle" x="312" y="324">1</text><text text-anchor="middle" x="328" y="324">1</text><text text-anchor="middle" x="344" y="324">1</text><text text-anchor="middle" x="360" y="324">1</text><text text-anchor="middle" x="376" y="324">1</text><text text-anchor="middle" x="392" y="324">1</text><text text-anchor="middle" x="408" y="324">1</text><text text-anchor="middle" x="424" y="324">1</text><text text-anchor="middle" x="440" y="324">1</text><text text-anchor="middle" x="456" y="324">1</text><text text-anchor="middle" x="472" y="324">1</text><text text-anchor="middle" x="488" y="324">1</text><text text-anchor="middle" x="504" y="324">1</text><text text-anchor="middle" x="520" y="324">1</text><text text-anchor="middle" x="536" y="324">1</text><text text-anchor="middle" x="552" y="324">1</text><text text-anchor="middle" x="568" y="324">0</text><text text-anchor="middle" x="584" y="324">0</text><text text-anchor="middle" x="600" y="324">0</text><text text-anchor="middle" x="656" y="324">-</text><text text-anchor="middle" x="664" y="324">8</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;6:</b> Signed vs. Unsigned integers.</div></center>

</p><p>

There's something else that we could have done with our 32 bits. Let's say we want to have a number that, as in mathematics, has a decimal point that comes after it. To make it happen, we could reserve some bits for the number and some for the fraction. We can arbitrarily decide which part takes how many bits. For instance, we can say that the bottom 8 bits of a 32 bits are the fraction, while the rest will be used to represent the number. This is what is called &ldquo;Fixed Point Math&rdquo;:

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="224" width="600" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 40,16 L 40,48 " style="fill:none;"/>
<path d="M 40,80 L 40,96 " style="fill:none;"/>
<path d="M 40,144 L 40,160 " style="fill:none;"/>
<path d="M 56,16 L 56,48 " style="fill:none;"/>
<path d="M 72,16 L 72,48 " style="fill:none;"/>
<path d="M 88,16 L 88,48 " style="fill:none;"/>
<path d="M 104,16 L 104,48 " style="fill:none;"/>
<path d="M 120,16 L 120,48 " style="fill:none;"/>
<path d="M 136,16 L 136,48 " style="fill:none;"/>
<path d="M 152,16 L 152,48 " style="fill:none;"/>
<path d="M 168,16 L 168,48 " style="fill:none;"/>
<path d="M 168,80 L 168,96 " style="fill:none;"/>
<path d="M 184,16 L 184,48 " style="fill:none;"/>
<path d="M 200,16 L 200,48 " style="fill:none;"/>
<path d="M 216,16 L 216,48 " style="fill:none;"/>
<path d="M 232,16 L 232,48 " style="fill:none;"/>
<path d="M 248,16 L 248,48 " style="fill:none;"/>
<path d="M 264,16 L 264,48 " style="fill:none;"/>
<path d="M 280,16 L 280,48 " style="fill:none;"/>
<path d="M 296,16 L 296,48 " style="fill:none;"/>
<path d="M 296,80 L 296,96 " style="fill:none;"/>
<path d="M 312,16 L 312,48 " style="fill:none;"/>
<path d="M 328,16 L 328,48 " style="fill:none;"/>
<path d="M 344,16 L 344,48 " style="fill:none;"/>
<path d="M 360,16 L 360,48 " style="fill:none;"/>
<path d="M 376,16 L 376,48 " style="fill:none;"/>
<path d="M 392,16 L 392,48 " style="fill:none;"/>
<path d="M 408,16 L 408,48 " style="fill:none;"/>
<path d="M 424,16 L 424,48 " style="fill:none;"/>
<path d="M 424,80 L 424,96 " style="fill:none;"/>
<path d="M 424,144 L 424,160 " style="fill:none;"/>
<path d="M 440,16 L 440,48 " style="fill:none;"/>
<path d="M 456,16 L 456,48 " style="fill:none;"/>
<path d="M 472,16 L 472,48 " style="fill:none;"/>
<path d="M 488,16 L 488,48 " style="fill:none;"/>
<path d="M 504,16 L 504,48 " style="fill:none;"/>
<path d="M 520,16 L 520,48 " style="fill:none;"/>
<path d="M 536,16 L 536,48 " style="fill:none;"/>
<path d="M 552,16 L 552,48 " style="fill:none;"/>
<path d="M 552,80 L 552,96 " style="fill:none;"/>
<path d="M 552,144 L 552,160 " style="fill:none;"/>
<path d="M 40,16 L 552,16 " style="fill:none;"/>
<path d="M 40,48 L 552,48 " style="fill:none;"/>
<path d="M 40,96 L 552,96 " style="fill:none;"/>
<path d="M 40,160 L 552,160 " style="fill:none;"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="16" y="4">3</text><text text-anchor="middle" x="24" y="4">1</text><text text-anchor="middle" x="32" y="4">s</text><text text-anchor="middle" x="40" y="4">t</text><text text-anchor="middle" x="56" y="4">b</text><text text-anchor="middle" x="64" y="4">i</text><text text-anchor="middle" x="72" y="4">t</text><text text-anchor="middle" x="528" y="4">0</text><text text-anchor="middle" x="536" y="4">t</text><text text-anchor="middle" x="544" y="4">h</text><text text-anchor="middle" x="560" y="4">b</text><text text-anchor="middle" x="568" y="4">i</text><text text-anchor="middle" x="576" y="4">t</text><text text-anchor="middle" x="80" y="116">b</text><text text-anchor="middle" x="88" y="116">y</text><text text-anchor="middle" x="96" y="116">t</text><text text-anchor="middle" x="104" y="116">e</text><text text-anchor="middle" x="120" y="116">3</text><text text-anchor="middle" x="216" y="116">b</text><text text-anchor="middle" x="224" y="116">y</text><text text-anchor="middle" x="232" y="116">t</text><text text-anchor="middle" x="240" y="116">e</text><text text-anchor="middle" x="256" y="116">2</text><text text-anchor="middle" x="344" y="116">b</text><text text-anchor="middle" x="352" y="116">y</text><text text-anchor="middle" x="360" y="116">t</text><text text-anchor="middle" x="368" y="116">e</text><text text-anchor="middle" x="384" y="116">1</text><text text-anchor="middle" x="464" y="116">b</text><text text-anchor="middle" x="472" y="116">y</text><text text-anchor="middle" x="480" y="116">t</text><text text-anchor="middle" x="488" y="116">e</text><text text-anchor="middle" x="504" y="116">0</text><text text-anchor="middle" x="184" y="180">n</text><text text-anchor="middle" x="192" y="180">u</text><text text-anchor="middle" x="200" y="180">m</text><text text-anchor="middle" x="208" y="180">b</text><text text-anchor="middle" x="216" y="180">e</text><text text-anchor="middle" x="224" y="180">r</text><text text-anchor="middle" x="232" y="180">,</text><text text-anchor="middle" x="248" y="180">w</text><text text-anchor="middle" x="448" y="180">f</text><text text-anchor="middle" x="456" y="180">r</text><text text-anchor="middle" x="464" y="180">a</text><text text-anchor="middle" x="472" y="180">c</text><text text-anchor="middle" x="480" y="180">t</text><text text-anchor="middle" x="488" y="180">i</text><text text-anchor="middle" x="496" y="180">o</text><text text-anchor="middle" x="504" y="180">n</text><text text-anchor="middle" x="512" y="180">,</text><text text-anchor="middle" x="528" y="180">f</text><text text-anchor="middle" x="176" y="196">0</text><text text-anchor="middle" x="192" y="196">-</text><text text-anchor="middle" x="208" y="196">1</text><text text-anchor="middle" x="216" y="196">6</text><text text-anchor="middle" x="224" y="196">'</text><text text-anchor="middle" x="232" y="196">7</text><text text-anchor="middle" x="240" y="196">7</text><text text-anchor="middle" x="248" y="196">7</text><text text-anchor="middle" x="256" y="196">'</text><text text-anchor="middle" x="264" y="196">2</text><text text-anchor="middle" x="272" y="196">1</text><text text-anchor="middle" x="280" y="196">5</text><text text-anchor="middle" x="472" y="196">0</text><text text-anchor="middle" x="480" y="196">-</text><text text-anchor="middle" x="488" y="196">2</text><text text-anchor="middle" x="496" y="196">5</text><text text-anchor="middle" x="504" y="196">5</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;7:</b> Mentally dividing a 32-bit value in number and fraction.</div></center>

</p><p>

Considering the value of our fraction (<code>f</code>) can be anywhere from 0 to 255, the actual number can be calculated in the following way: 

</p><p>

\begin{equation}
N = w + \frac{f}{255}
\end{equation}

</p><p>

Even further, if we only want to know what the total number is, you can do it by simply shifting the number <code>w</code> down by 8 (<code>w &gt;&gt; 8</code>). This is what's called <em class="underscore">truncation</em>, we get rid of the bits before the point we're interested in. 

</p><p>

<div class="admonition ">We dive even deeper in how shifting happens in subsection  <a href="#toc8.2">8.2</a>.</div>

</p><p>

You can do more fun stuff with fixed fraction point. You could do rounding  by adding <code>127</code> (<code>255 / 2</code>) to your fraction and then truncating. This would increase the number by one if the fraction were less than 128, thus rounding the fraction (if it wasn't, the add would of course not impact the number). In code this would look in roughly the following way: 

</p><pre class="listing tilde"><code><span class="line">N = w &gt;&gt; <span class="hljs-number">8</span>;             <span class="hljs-comment">// Truncation</span></span>
<span class="line">N = (w + f / <span class="hljs-number">2</span>) &gt;&gt; <span class="hljs-number">8</span>;   <span class="hljs-comment">// Rounding</span></span>
<span class="line">N = (w &gt;&gt; <span class="hljs-number">8</span>) + f / <span class="hljs-number">255</span>; <span class="hljs-comment">// Exact fraction calculation</span></span></code></pre><p>

There're more tricks you can do, but you should get the point by now. You divide your bits in full number and fraction, and then do some math and play around with it as you want. And this is what people did back in the day in order to avoid expensive floating point math. 

</p><p>

What is floating point anyway? 

</p><p>

You see that in fixed point we arbitrarily decide at what point we stop our whole number and start the number. This has a number of limits as well. In the example above, if we take our 8 bits for fraction, we can never have more than 256 levels of fraction, and you can never have numbers higher than ~16 million if we only ever have 24 bits. Sure you can move the imaginary line left or right to better adjust to your specific needs, but whatever bit you're fixating as the &ldquo;divider&rdquo;, all the numbers should follow that boundary. 

</p><p>

In floating point... well, the decimal point floats. It's a different way of dividing up your bits, and floating point works <em class="underscore">completely differently</em> from what fixed point is conceptually, or from what you might imagine. It's divided roughly in the following way: 

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="144" width="600" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 40,16 L 40,48 " style="fill:none;"/>
<path d="M 40,80 L 40,96 " style="fill:none;"/>
<path d="M 56,16 L 56,48 " style="fill:none;"/>
<path d="M 56,80 L 56,96 " style="fill:none;"/>
<path d="M 72,16 L 72,48 " style="fill:none;"/>
<path d="M 88,16 L 88,48 " style="fill:none;"/>
<path d="M 104,16 L 104,48 " style="fill:none;"/>
<path d="M 120,16 L 120,48 " style="fill:none;"/>
<path d="M 136,16 L 136,48 " style="fill:none;"/>
<path d="M 152,16 L 152,48 " style="fill:none;"/>
<path d="M 168,16 L 168,48 " style="fill:none;"/>
<path d="M 184,16 L 184,48 " style="fill:none;"/>
<path d="M 184,80 L 184,96 " style="fill:none;"/>
<path d="M 200,16 L 200,48 " style="fill:none;"/>
<path d="M 216,16 L 216,48 " style="fill:none;"/>
<path d="M 232,16 L 232,48 " style="fill:none;"/>
<path d="M 248,16 L 248,48 " style="fill:none;"/>
<path d="M 264,16 L 264,48 " style="fill:none;"/>
<path d="M 280,16 L 280,48 " style="fill:none;"/>
<path d="M 296,16 L 296,48 " style="fill:none;"/>
<path d="M 312,16 L 312,48 " style="fill:none;"/>
<path d="M 328,16 L 328,48 " style="fill:none;"/>
<path d="M 344,16 L 344,48 " style="fill:none;"/>
<path d="M 360,16 L 360,48 " style="fill:none;"/>
<path d="M 376,16 L 376,48 " style="fill:none;"/>
<path d="M 392,16 L 392,48 " style="fill:none;"/>
<path d="M 408,16 L 408,48 " style="fill:none;"/>
<path d="M 424,16 L 424,48 " style="fill:none;"/>
<path d="M 440,16 L 440,48 " style="fill:none;"/>
<path d="M 456,16 L 456,48 " style="fill:none;"/>
<path d="M 472,16 L 472,48 " style="fill:none;"/>
<path d="M 488,16 L 488,48 " style="fill:none;"/>
<path d="M 504,16 L 504,48 " style="fill:none;"/>
<path d="M 520,16 L 520,48 " style="fill:none;"/>
<path d="M 536,16 L 536,48 " style="fill:none;"/>
<path d="M 552,16 L 552,48 " style="fill:none;"/>
<path d="M 552,80 L 552,96 " style="fill:none;"/>
<path d="M 40,16 L 552,16 " style="fill:none;"/>
<path d="M 40,48 L 552,48 " style="fill:none;"/>
<path d="M 40,96 L 552,96 " style="fill:none;"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="16" y="4">3</text><text text-anchor="middle" x="24" y="4">1</text><text text-anchor="middle" x="32" y="4">s</text><text text-anchor="middle" x="40" y="4">t</text><text text-anchor="middle" x="56" y="4">b</text><text text-anchor="middle" x="64" y="4">i</text><text text-anchor="middle" x="72" y="4">t</text><text text-anchor="middle" x="528" y="4">0</text><text text-anchor="middle" x="536" y="4">t</text><text text-anchor="middle" x="544" y="4">h</text><text text-anchor="middle" x="560" y="4">b</text><text text-anchor="middle" x="568" y="4">i</text><text text-anchor="middle" x="576" y="4">t</text><text text-anchor="middle" x="32" y="116">s</text><text text-anchor="middle" x="40" y="116">i</text><text text-anchor="middle" x="48" y="116">g</text><text text-anchor="middle" x="56" y="116">n</text><text text-anchor="middle" x="88" y="116">e</text><text text-anchor="middle" x="96" y="116">x</text><text text-anchor="middle" x="104" y="116">p</text><text text-anchor="middle" x="112" y="116">o</text><text text-anchor="middle" x="120" y="116">n</text><text text-anchor="middle" x="128" y="116">e</text><text text-anchor="middle" x="136" y="116">n</text><text text-anchor="middle" x="144" y="116">t</text><text text-anchor="middle" x="320" y="116">m</text><text text-anchor="middle" x="328" y="116">a</text><text text-anchor="middle" x="336" y="116">n</text><text text-anchor="middle" x="344" y="116">t</text><text text-anchor="middle" x="352" y="116">i</text><text text-anchor="middle" x="360" y="116">s</text><text text-anchor="middle" x="368" y="116">s</text><text text-anchor="middle" x="376" y="116">a</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;8:</b> &ldquo;Single-precision&rdquo;, 32-bit floating point value structure.</div></center>

</p><p>

Floating point allows you to have a much greater flexibility at the cost of having the precision of your operations wary, depending on the values involved. It's subdivided in the following manner: 

</p><p>

<ul>
<li class="asterisk"><strong class="asterisk">Mantissa</strong> (sometimes called as &ldquo;Signifcand field&rdquo;) represents <em class="underscore">a</em> fraction. It's not the number you want to store just yet!
</li>
<li class="asterisk"><strong class="asterisk">Exponent</strong> is the power of <code>2</code>, indicating how big the number is. In other words, if the value stored in these bits is \(n\), exponent is \(2^n\).
</li>
<li class="asterisk"><strong class="asterisk">Sign</strong> bit it simple. It stores if the value is positive or negative.</li></ul>

</p><p>

This allows you to separate degree of precision you have in specifying the number (which is always going to be the size of the mantissa) from the <em class="underscore">scale</em> of the value, which is specified in the exponent. The bigger the exponent, the smaller is the <em class="underscore">number</em> part, and the smaller is the <em class="underscore">fraction</em>, and the contrary. 

</p><p>

And here we come back to the discussion on the precision. If the exponent is very high or very low, information will be lost. Imagine that you have 23 bits of mantissa (which translate to a 7-digit decimal number), with a giant exponent like \(2^{50}\) (which is <em class="underscore">a lot</em>) you end up with some value with a lot of zeroes at the end. On the other hand, if the exponent were negative (say, $2^{-50}), the mantissa is pushed down, and the final value becomes something like \(0.0000000001\). 

</p><p>

In short, the role of the exponent is to <em class="underscore">slide</em> the decimal around. 

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="80" width="416" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 160,48 L 184,48 " style="fill:none;"/>
<path d="M 216,48 L 248,48 " style="fill:none;"/>
<path d="M 184,48 C 200.8,48 200,32 200,32 " style="fill:none;"/>
<path d="M 216,48 C 199.2,48 200,32 200,32 " style="fill:none;"/>
<polygon points="256,48 244,42.4 244,53.6 "  style="stroke:none" transform="rotate(0,248,48 )"/>
<polygon points="168,48 156,42.4 156,53.6 "  style="stroke:none" transform="rotate(180,160,48 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="192" y="4">1</text><text text-anchor="middle" x="200" y="4">.</text><text text-anchor="middle" x="208" y="4">2</text><text text-anchor="middle" x="216" y="4">5</text><text text-anchor="middle" x="224" y="4">6</text><text text-anchor="middle" x="232" y="4">5</text><text text-anchor="middle" x="240" y="4">6</text><text text-anchor="middle" x="248" y="4">4</text><text text-anchor="middle" x="256" y="4">6</text><text text-anchor="middle" x="200" y="20">┊</text><text text-anchor="middle" x="152" y="36">-</text><text text-anchor="middle" x="160" y="36">e</text><text text-anchor="middle" x="168" y="36">x</text><text text-anchor="middle" x="176" y="36">p</text><text text-anchor="middle" x="224" y="36">+</text><text text-anchor="middle" x="232" y="36">e</text><text text-anchor="middle" x="240" y="36">x</text><text text-anchor="middle" x="248" y="36">p</text><text text-anchor="middle" x="8" y="52">0</text><text text-anchor="middle" x="16" y="52">.</text><text text-anchor="middle" x="24" y="52">0</text><text text-anchor="middle" x="32" y="52">0</text><text text-anchor="middle" x="40" y="52">0</text><text text-anchor="middle" x="48" y="52">0</text><text text-anchor="middle" x="56" y="52">0</text><text text-anchor="middle" x="64" y="52">2</text><text text-anchor="middle" x="72" y="52">5</text><text text-anchor="middle" x="80" y="52">6</text><text text-anchor="middle" x="88" y="52">5</text><text text-anchor="middle" x="96" y="52">6</text><text text-anchor="middle" x="104" y="52">4</text><text text-anchor="middle" x="112" y="52">6</text><text text-anchor="middle" x="128" y="52">.</text><text text-anchor="middle" x="136" y="52">.</text><text text-anchor="middle" x="144" y="52">.</text><text text-anchor="middle" x="264" y="52">.</text><text text-anchor="middle" x="272" y="52">.</text><text text-anchor="middle" x="280" y="52">.</text><text text-anchor="middle" x="296" y="52">2</text><text text-anchor="middle" x="304" y="52">5</text><text text-anchor="middle" x="312" y="52">6</text><text text-anchor="middle" x="320" y="52">5</text><text text-anchor="middle" x="328" y="52">6</text><text text-anchor="middle" x="336" y="52">4</text><text text-anchor="middle" x="344" y="52">6</text><text text-anchor="middle" x="352" y="52">0</text><text text-anchor="middle" x="360" y="52">0</text><text text-anchor="middle" x="368" y="52">0</text><text text-anchor="middle" x="376" y="52">0</text><text text-anchor="middle" x="384" y="52">0</text><text text-anchor="middle" x="392" y="52">.</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;9:</b> The &ldquo;point&rdquo; of the mantissa &ldquo;floats&rdquo; higher (number becomes smaller) if the exponent is negative, and vice versa. If the exponent pushes the value outside of the so-called &ldquo;significant figures&rdquo;, only zeroes remain.</div></center>

</p><p>

<em class="underscore">(Back to subsection  <a href="#toc2.1">2.1</a>)</em>

</p>
<a class="target" name="sideconsiderations">&nbsp;</a><a class="target" name="sideconsiderations">&nbsp;</a><a class="target" name="toc8">&nbsp;</a><h1>Side Considerations</h1>

<a class="target" name="thefirstgamejam">&nbsp;</a><a class="target" name="sideconsiderations/thefirstgamejam">&nbsp;</a><a class="target" name="toc8.1">&nbsp;</a><h2>The First Game Jam</h2>
<p>


What follows below is a <a href="https://caseymuratori.com/">Casey</a>'s recounting of the First Game Jam.

</p><p>

A long time ago, we used to do something that was called "<a href="http://www.indiegamejam.com/">Indie Game Jam</a>". And it was it, it was the very first game jam in existence. It was hosted by <a href="https://nothings.org/">Sean Barrett</a> and <a href="https://www.chrishecker.com/Homepage">Chris Hecker</a> and was called &ldquo;0th Indie Game Jam&rdquo;. It was held in a <em class="underscore">barn</em> in Oakland, California. 

</p><p>

<center><div class="image" style=""><a href="../media/day9/igj0.jpg" target="_blank"><img class="markdeep" src="../media/day9/igj0.jpg" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;10:</b> The 0th Indie Game Jam, 2002.</span></center></div></center>

</p><p>

It all started from an email conversation where the various programmers were talking that the computers were just getting powerful enough to draw maybe 100,000 sprites visible on the screen. Just oldschool sprites (animated 2D bitmaps), but still. So the talk started to revolve from &ldquo;What kind of games might someone make using this kind of power? 100,000 guys visible on a screen is a lot&rdquo; to &ldquo;Why don't we get the friendly game developers that we know and see for ourselves?&rdquo; 

</p><p>

At the time, everyone was working on the so-called <em class="underscore">AAA</em> games (large studio games) at a time. The year was 2001, there was no Unity engine, no App Store, it was 6 years before the first alpha of Minecraft appeared on the internet... There was no such thing as the indie scene. And the invite was &ldquo;If all these programmers come down for a long weekend, how many games can they make to just play around with the idea of having 100,000 guys? 

</p><p>

Casey worked on the core engine for this jam. He took care mainly of the camera code and the loading of the <a href="https://en.wikipedia.org/wiki/Doom_modding">WAD</a> files which contained the actual sprites and other game data. Sean Barrett was doing the rendering, so when everyone got there they could go ahead and start making games with it. 

</p><p>

And so that was it, the first game jam that ever was. Since then, that idea of having a <em class="underscore">theme</em> and a jam, where everyone just packs in and makes a bunch of games in a weekend, has caught on, and there were many others of any kind. Keep in mind that, at the time, the engine had to be prepared beforehand, so that the jammers would show up and just focus on writing the game. People would volunteer to work on the engine, etc.

</p><p>

A couple of years down the line, the fourth and final instalment of the series, Indie Game Jam 3, was centered around <em class="underscore">audio</em>. The game was going to be oriented around audio, so the engine should have been prepared accordingly. The engine was designed by Atman Binstock (currently chief architect at Oculus VR).

</p><p>

<center><div class="image" style=""><a href="../media/day9/igj3.jpg" target="_blank"><img class="markdeep" src="../media/day9/igj3.jpg" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;11:</b> Indie Game Jam 3, 2005. Photo by <a href="https://www.flickr.com/photos/sklathill/561082443">Vincent Diamante</a></span></center></div></center>

</p><p>

Before the engine was complete, Casey went to visit Atman and had a chance to see the engine in action. It was a busy café in Japan, and they had to listen to the audio using headphones. Now, at the time Casey had extremely precise, professional-grade headphones by <a href="https://www.etymotic.com/consumer/earphones.html">Etymotic</a>, so he started listening to the audio the engine was reproducing through those headphones. Suddenly, he realized: Atman had a <em class="underscore">bug</em> somewhere. He wasn't aligned on buffer or something. He could hear it, some clicking going on. 

</p><p>

At this point, Atman switched the headphones, plugged his cheaper headphones and, after listening for a while, said: &ldquo;I don't know what you're talking about, it sounds right&rdquo;. So Casey gave him his headphones, so he switched, listened for a couple seconds, and concluded: &ldquo;I got to buy myself a better set of headphones&rdquo;. 

</p><p>

The moral of the story is the following: different kinds of effects happen to the sound on the way out. When you plug in subpar headphones/speakers, or even good speakers that go through a system designed to have the sound be &ldquo;better&rdquo;, &ldquo;smoother&rdquo;, &ldquo;warmer&rdquo; or whatever you want it to call it. The mutation that happens may make the result sound better (or worse), obscures the truth of what is actually getting of what is actually put out by the computer. So if you have a subtle bug or artifacts in the sound, it's entirely possible you might be oblivious to them as your sound setup wouldn't allow you to hear them. 

</p><p>

This is how finicky sound is. And if you really, <em class="underscore">really</em> want to know if you have a sound bug, beyond actually inspecting the code and trying to verify as much as you can, you have to invest in a pair of highly responsive headphones because you may miss those bugs entirely.

</p><p>

<em class="underscore">(Back to subsection  <a href="#toc1.2">1.2</a>)</em>

</p>
<a class="target" name="bitshiftingandregisters">&nbsp;</a><a class="target" name="sideconsiderations/bitshiftingandregisters">&nbsp;</a><a class="target" name="toc8.2">&nbsp;</a><h2>Bit Shifting and Registers</h2>
<p>


Bit shifting works by actually moving the bits of the value left or right, thus increasing or decreasing the value by a factor of two per bit. But is it possible to shift too far so that the value &ldquo;spills&rdquo; to another adjacent variable? 

</p><p>

The answer is no, because bit shifting doesn't happen in memory. All the operations happen in registers, and then the result is stored in memory.

</p><p>

What are the registers anyway? 

</p><p>

A register is the physically closest &ldquo;memory&rdquo; location to the processor, the location which is used for processor operations directly. What happens when any instruction is executed, the machine takes one or more values from memory, stores it in the register and then returns the result to memory. You can quickly test it by declaring an <code>int x = 1;</code> and then bit shifting it multiple times, like that: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">int</span> x = <span class="hljs-number">1</span>;</span>
<span class="line">x &lt;&lt;= <span class="hljs-number">1</span>;</span>
<span class="line">x &lt;&lt;= <span class="hljs-number">1</span>;</span>
<span class="line">x &lt;&lt;= <span class="hljs-number">1</span>;</span>
<span class="line">x &lt;&lt;= <span class="hljs-number">1</span>;</span>
<span class="line">x &lt;&lt;= <span class="hljs-number">1</span>;</span>
<span class="line">x &lt;&lt;= <span class="hljs-number">1</span>;</span>
<span class="line">x &lt;&lt;= <span class="hljs-number">1</span>;</span></code></pre><p>

If you go to the debugger and open disassembly, you will see that each each shift/assignment operation translates to three instructions: 

</p><p>

<ol start=1>
<li class="number"><code>mov eax, ptr</code>: Load the value to <code>eax</code> register.
</li>
<li class="number"><code>shl eax, 1</code>: Shift Left the <code>eax</code> by 1.
</li>
<li class="number"><code>mov ptr, eax</code>: Load the value from <code>eax</code> register back.</li></ol>

</p><p>

You can actually see the shifting happening if you open your <code>Registers</code> window or simply type <code>rax</code> in the <code>Watch</code> window. Even further yet, if you type <code>rax,b</code> in the <code>Watch</code> window, you'll be able to see <code>rax</code> register (64-bit version of <code>eax</code>) in bits, so you can see the shifting visually.

</p><p>

<center><div class="image" style=""><a href="../media/day9/registers.jpg" target="_blank"><img class="markdeep" src="../media/day9/registers.jpg" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;12:</b> Inspecting the disassembly and registers window. In the Registers window, <code>RAX</code> hasn't been initialized yet so it contains previous values it worked with. The two breakpoints mark two consecutive instructions in C code.</span></center></div></center>

</p><p>

In conclusion, even if you go outside the type boundary in the register, when the value is copied to the memory it remains within its limits.

</p>
<a class="target" name="fix:deadzoneforcontrollersticks">&nbsp;</a><a class="target" name="sideconsiderations/fix:deadzoneforcontrollersticks">&nbsp;</a><a class="target" name="toc8.3">&nbsp;</a><h2>Fix: Dead Zone for Controller Sticks</h2>
<p>


If you recall, we tried to account for our controller's dead zone by shifting down by 12. This is quite bad code, even for a quick example.

</p><pre class="listing tilde"><code><span class="line">XOffset += StickX &gt;&gt; <span class="hljs-number">12</span>;</span>
<span class="line">YOffset += StickY &gt;&gt; <span class="hljs-number">12</span>;                        </span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;26:</b> <file>[win32_handmade.cpp > WinMain]</file> The offending piece of code.</div></center>
<p>


Now, shifting down by 12 is the same that dividing by \(2^{12}\), right? Well, there's a catch. The catch occurs when there's a negative number. By default, if you shift in C, it does what's called &ldquo;sign extension&rdquo;. What that means is if the number was negative, and you shift it down, it continues shifting the high bit, so you end up (in binary) with a number like <code>1111111111111111</code> which translates to <code>-1</code> where in reality we'd expect a <code>0</code>. This might cause persistent scroll even if you don't provide any input (and you can also hear it if you hooked up your sound to it).

</p><p>

What you want to do instead in such a case is actually dividing by a high number. Let's say 4096:
</p><pre class="listing tilde"><code><span class="line">XOffset += StickX / <span class="hljs-number">4096</span>;</span>
<span class="line">YOffset += StickY / <span class="hljs-number">4096</span>;                        </span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;27:</b> <file>[win32_handmade.cpp > WinMain]</file> Fixing dead zone.</div></center>
<p>



Well shifting down by 12

</p>
<a class="target" name="navigation">&nbsp;</a><a class="target" name="navigation">&nbsp;</a><a class="target" name="toc9">&nbsp;</a><h1>Navigation</h1>
<p>


Previous: <a href="day8.html">Day 8. Writing a Square Wave to DirectSound</a>

</p><p>

Up Next: <a href="day10.html">Day 10. QueryPerformanceCounter and RDTSC</a>

</p><p>

<a href="../index.md.html">Back to Index</a>

</p>
<div class="nonumberh1">Glossary</div>
<p>


<ul>
<li class="asterisk">Fixed-point numbers
</li>
<li class="asterisk">Floating-point numbers
</li>
<li class="asterisk">Real numbers
</li>
<li class="asterisk">Truncation</li></ul>

</p>
<div class="nonumberh1">References</div>

<div class="nonumberh1">Articles</div>
<p>


<a href="https://en.wikipedia.org/wiki/IEEE_754">IEEE 754</a>

</p><p>

<a href="https://en.wikipedia.org/wiki/Fixed-point_arithmetic">Fixed Point Numbers</a>

</p><p>

<a href="https://en.wikipedia.org/wiki/Floating-point_arithmetic">Floating Point Numbers</a>

</p><p>

<a href="https://en.cppreference.com/w/c/language/operator_precedence">Operator Precedence</a>

</p><p>

<a href="https://en.wikipedia.org/wiki/Sine_wave">Sine Wave</a>

</p><p>

<a href="https://en.wikipedia.org/wiki/Two%27s_complement">Two's Complement</a>

</p>
<div class="nonumberh1">MSDN</div>
<p>


<a href="https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/sin-sinf-sinl?view=vs-2019">Sine</a>

</p>
<div class="nonumberh1">Other</div>
<p>


<a href="http://www.indiegamejam.com/">Indie Game Jam</a>

</p><p>

<a href="https://nothings.org/">Sean Barrett's homepage</a>

</p><p>

<a href="https://www.chrishecker.com/Homepage">Chris Hecker's homepage</a>

</p><p>

<a href="https://en.wikipedia.org/wiki/Doom_modding">WAD files</a>

</p><p>

<a href="https://www.etymotic.com/consumer/earphones.html">Etymotic</a>

</p><p>

<style class="fallback">
  body {
    visibility: hidden;
    font-family: sans-serif;
  }
</style>

</p><p>

<script>markdeepOptions = { tocStyle: 'long' }; window.alreadyProcessedMarkdeep || (document.body.style.visibility = 'visible');</script>
</math.h></dsound.h></xinput.h></stdint.h></windows.h></p></span><div id="mdContextMenu" style="visibility:hidden"></div><div class="markdeepFooter"><i>formatted by <a href="https://casual-effects.com/markdeep" style="color:#999">Markdeep&nbsp;1.10&nbsp;&nbsp;</a></i><div style="display:inline-block;font-size:13px;font-family:'Times New Roman',serif;vertical-align:middle;transform:translate(-3px,-1px)rotate(135deg);">&#x2712;</div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>