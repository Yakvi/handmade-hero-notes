<meta charset="UTF-8"><meta http-equiv="content-type" content="text/html;charset=UTF-8"><meta name="viewport" content="width=600, initial-scale=1"><style>body{max-width:680px;margin:auto;padding:20px;text-align:justify;line-height:140%; -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-smoothing:antialiased;color:#222;font-family:Palatino,Georgia,"Times New Roman",serif}</style><style>@media print{*{-webkit-print-color-adjust:exact;text-shadow:none !important}}body{counter-reset: h1 h2 h3 h4 h5 h6 paragraph}@page{margin:0;size:auto}#mdContextMenu{position:absolute;background:#383838;cursor:default;border:1px solid #999;color:#fff;padding:4px 0px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,"Helvetica Neue",sans-serif;font-size:85%;font-weight:600;border-radius:4px;box-shadow:0px 3px 10px rgba(0,0,0,35%)}#mdContextMenu div{padding:0px 20px}#mdContextMenu div:hover{background:#1659d1}.md code,.md pre{font-family:Menlo,Consolas,monospace;font-size:98%;text-align:left;line-height:140%}.md .mediumToc code,.md longToc code,.md .shortToc code,.md h1 code,.md h2 code,.md h3 code,.md h4 code,.md h5 code,.md h6 code{font-size:unset}.md div.title{font-size:26px;font-weight:800;line-height:120%;text-align:center}.md div.afterTitles{height:10px}.md div.subtitle{text-align:center}.md iframe.textinsert, .md object.textinsert,.md iframe:not(.markdeep){display:block;margin-top:10px;margin-bottom:10px;width:100%;height:75vh;border:1px solid #000;border-radius:4px;background:#f5f5f4}.md .image{display:inline-block}.md img{max-width:100%;page-break-inside:avoid}.md li{text-align:left;text-indent:0}.md pre.listing {width:100%;tab-size:4;-moz-tab-size:4;-o-tab-size:4;counter-reset:line;overflow-x:auto;resize:horizontal}.md pre.listing .linenumbers span.line:before{width:30px;margin-left:-28px;font-size:80%;text-align:right;counter-increment:line;content:counter(line);display:inline-block;padding-right:13px;margin-right:8px;color:#ccc}.md div.tilde{margin:20px 0 -10px;text-align:center}.md .imagecaption,.md .tablecaption,.md .listingcaption{display:inline-block;margin:7px 5px 12px;text-align:justify;font-style:italic}.md img.pixel{image-rendering:-moz-crisp-edges;image-rendering:pixelated}.md blockquote.fancyquote{margin:25px 0 25px;text-align:left;line-height:160%}.md blockquote.fancyquote::before{content:"“";color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-right:6px;vertical-align:-0.3em}.md span.fancyquote{font-size:118%;color:#777;font-style:italic}.md span.fancyquote::after{content:"”";font-style:normal;color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-left:6px;vertical-align:-0.3em}.md blockquote.fancyquote .author{width:100%;margin-top:10px;display:inline-block;text-align:right}.md small{font-size:60%}.md big{font-size:150%}.md div.title,contents,.md .tocHeader,.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .shortTOC,.md .mediumTOC,.nonumberh1,.nonumberh2,.nonumberh3,.nonumberh4,.nonumberh5,.nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;margin:13.4px 0 13.4px;padding:15px 0 3px;border-top:none;clear:both}.md .tocTop {display:none}.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .nonumberh1,.md .nonumberh2,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{page-break-after:avoid;break-after:avoid}.md svg.diagram{display:block;font-family:Menlo,Consolas,monospace;font-size:98%;text-align:center;stroke-linecap:round;stroke-width:2px;page-break-inside:avoid;stroke:#000;fill:#000}.md svg.diagram .opendot{fill:#fff}.md svg.diagram .shadeddot{fill:#CCC}.md svg.diagram .dotteddot{stroke:#000;stroke-dasharray:4;fill:none}.md svg.diagram text{stroke:none}@media print{@page{margin:1in 5mm;transform: scale(150%)}}@media print{.md .pagebreak{page-break-after:always;visibility:hidden}}.md a{font-family:Georgia,Palatino,'Times New Roman'}.md h1,.md .tocHeader,.md .nonumberh1{border-bottom:3px solid;font-size:20px;font-weight:bold;}.md h1,.md .nonumberh1{counter-reset: h2 h3 h4 h5 h6}.md h2,.md .nonumberh2{counter-reset: h3 h4 h5 h6;border-bottom:2px solid #999;color:#555;font-weight:bold;font-size:18px;}.md h3,.md h4,.md h5,.md h6,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;color:#555;font-size:16px;}.md h3{counter-reset:h4 h5 h6}.md h4{counter-reset:h5 h6}.md h5{counter-reset:h6}.md div.table{margin:16px 0 16px 0}.md table{border-collapse:collapse;line-height:140%;page-break-inside:avoid}.md table.table{margin:auto}.md table.calendar{width:100%;margin:auto;font-size:11px;font-family:Verdana,Helvetica,Arial,sans-serif}.md table.calendar th{font-size:16px}.md .today{background:#ECF8FA}.md .calendar .parenthesized{color:#999;font-style:italic}.md table.table th{color:#FFF;background-color:#AAA;border:1px solid #888;padding:8px 15px 8px 15px}.md table.table td{padding:5px 15px 5px 15px;border:1px solid #888}.md table.table tr:nth-child(even){background:#EEE}.md pre.tilde{border-top: 1px solid #CCC;border-bottom: 1px solid #CCC;padding: 5px 0 5px 20px;margin:0 0 0 0;background:#FCFCFC;page-break-inside:avoid}.md a.target{width:0px;height:0px;visibility:hidden;font-size:0px;display:inline-block}.md a:link, .md a:visited{color:#38A;text-decoration:none}.md a:link:hover{text-decoration:underline}.md dt{font-weight:700}.md dl>dd{margin-top:-8px; margin-bottom:8px}.md dl>table{margin:35px 0 30px}.md code{page-break-inside:avoid;} @media print{.md .listing code{white-space:pre-wrap}}.md .endnote{font-size:13px;line-height:15px;padding-left:10px;text-indent:-10px}.md .bib{padding-left:80px;text-indent:-80px;text-align:left}.markdeepFooter{font-size:9px;text-align:right;padding-top:80px;color:#999}.md .mediumTOC{float:right;font-size:12px;line-height:15px;border-left:1px solid #CCC;padding-left:15px;margin:15px 0px 15px 25px}.md .mediumTOC .level1{font-weight:600}.md .longTOC .level1{font-weight:600;display:block;padding-top:12px;margin:0 0 -20px}.md .shortTOC{text-align:center;font-weight:bold;margin-top:15px;font-size:14px}.md .admonition{position:relative;margin:1em 0;padding:.4rem 1rem;border-radius:.2rem;border-left:2.5rem solid rgba(68,138,255,.4);background-color:rgba(68,138,255,.15);}.md .admonition-title{font-weight:bold;border-bottom:solid 1px rgba(68,138,255,.4);padding-bottom:4px;margin-bottom:4px;margin-left: -1rem;padding-left:1rem;margin-right:-1rem;border-color:rgba(68,138,255,.4)}.md .admonition.tip{border-left:2.5rem solid rgba(50,255,90,.4);background-color:rgba(50,255,90,.15)}.md .admonition.tip::before{content:"\24d8";font-weight:bold;font-size:150%;position:relative;top:3px;color:rgba(26,128,46,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.tip>.admonition-title{border-color:rgba(50,255,90,.4)}.md .admonition.warn,.md .admonition.warning{border-left:2.5rem solid rgba(255,145,0,.4);background-color:rgba(255,145,0,.15)}.md .admonition.warn::before,.md .admonition.warning::before{content:"\26A0";font-weight:bold;font-size:150%;position:relative;top:2px;color:rgba(128,73,0,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.warn>.admonition-title,.md .admonition.warning>.admonition-title{border-color:rgba(255,145,0,.4)}.md .admonition.error{border-left: 2.5rem solid rgba(255,23,68,.4);background-color:rgba(255,23,68,.15)}.md .admonition.error>.admonition-title{border-color:rgba(255,23,68,.4)}.md .admonition.error::before{content: "\2612";font-family:"Arial";font-size:200%;position:relative;color:rgba(128,12,34,.8);top:-2px;left:-3rem;display:block;width:0;height:0}.md .admonition p:last-child{margin-bottom:0}.md li.checked,.md li.unchecked{list-style:none;overflow:visible;text-indent:-1.2em}.md li.checked:before,.md li.unchecked:before{content:"\2611";display:block;float:left;width:1em;font-size:120%}.md li.unchecked:before{content:"\2610"}</style><style>.md h1::before {
content:counter(h1) " ";
counter-increment: h1;margin-right:10px}.md h2::before {
content:counter(h1) "."counter(h2) " ";
counter-increment: h2;margin-right:10px}.md h3::before {
content:counter(h1) "."counter(h2) "."counter(h3) " ";
counter-increment: h3;margin-right:10px}.md h4::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) " ";
counter-increment: h4;margin-right:10px}.md h5::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) " ";
counter-increment: h5;margin-right:10px}.md h6::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) "."counter(h6) " ";
counter-increment: h6;margin-right:10px}</style><style>.hljs{display:block;overflow-x:auto;padding:0.5em;background:#fff;color:#000;-webkit-text-size-adjust:none}.hljs-comment{color:#006a00}.hljs-keyword{color:#02E}.hljs-literal,.nginx .hljs-title{color:#aa0d91}.method,.hljs-list .hljs-title,.hljs-tag .hljs-title,.setting .hljs-value,.hljs-winutils,.tex .hljs-command,.http .hljs-title,.hljs-request,.hljs-status,.hljs-name{color:#008}.hljs-envvar,.tex .hljs-special{color:#660}.hljs-string{color:#c41a16}.hljs-tag .hljs-value,.hljs-cdata,.hljs-filter .hljs-argument,.hljs-attr_selector,.apache .hljs-cbracket,.hljs-date,.hljs-regexp{color:#080}.hljs-sub .hljs-identifier,.hljs-pi,.hljs-tag,.hljs-tag .hljs-keyword,.hljs-decorator,.ini .hljs-title,.hljs-shebang,.hljs-prompt,.hljs-hexcolor,.hljs-rule .hljs-value,.hljs-symbol,.hljs-symbol .hljs-string,.hljs-number,.css .hljs-function,.hljs-function .hljs-title,.coffeescript .hljs-attribute{color:#A0C}.hljs-function .hljs-title{font-weight:bold;color:#000}.hljs-class .hljs-title,.smalltalk .hljs-class,.hljs-type,.hljs-typename,.hljs-tag .hljs-attribute,.hljs-doctype,.hljs-class .hljs-id,.hljs-built_in,.setting,.hljs-params,.clojure .hljs-attribute{color:#5c2699}.hljs-variable{color:#3f6e74}.css .hljs-tag,.hljs-rule .hljs-property,.hljs-pseudo,.hljs-subst{color:#000}.css .hljs-class,.css .hljs-id{color:#9b703f}.hljs-value .hljs-important{color:#ff7700;font-weight:bold}.hljs-rule .hljs-keyword{color:#c5af75}.hljs-annotation,.apache .hljs-sqbracket,.nginx .hljs-built_in{color:#9b859d}.hljs-preprocessor,.hljs-preprocessor *,.hljs-pragma{color:#643820}.tex .hljs-formula{background-color:#eee;font-style:italic}.diff .hljs-header,.hljs-chunk{color:#808080;font-weight:bold}.diff .hljs-change{background-color:#bccff9}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-comment .hljs-doctag{font-weight:bold}.method .hljs-id{color:#000}</style><style>div.title { padding-top: 40px; } div.afterTitles { height: 15px; }</style><meta charset="utf-8">
<link rel="stylesheet" href="../css/style.css">

<script type="text/x-mathjax-config">MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });</script><span style="display:none">$$\newcommand{\n}{\hat{n}}\newcommand{\thetai}{\theta_\mathrm{i}}\newcommand{\thetao}{\theta_\mathrm{o}}\newcommand{\d}[1]{\mathrm{d}#1}\newcommand{\w}{\hat{\omega}}\newcommand{\wi}{\w_\mathrm{i}}\newcommand{\wo}{\w_\mathrm{o}}\newcommand{\wh}{\w_\mathrm{h}}\newcommand{\Li}{L_\mathrm{i}}\newcommand{\Lo}{L_\mathrm{o}}\newcommand{\Le}{L_\mathrm{e}}\newcommand{\Lr}{L_\mathrm{r}}\newcommand{\Lt}{L_\mathrm{t}}\newcommand{\O}{\mathrm{O}}\newcommand{\degrees}{{^{\large\circ}}}\newcommand{\T}{\mathsf{T}}\newcommand{\mathset}[1]{\mathbb{#1}}\newcommand{\Real}{\mathset{R}}\newcommand{\Integer}{\mathset{Z}}\newcommand{\Boolean}{\mathset{B}}\newcommand{\Complex}{\mathset{C}}\newcommand{\un}[1]{\,\mathrm{#1}}$$
</span>
<span class="md"><p><title>Day 8. Writing a Square Wave to DirectSound</title><div class="title"> Day 8. Writing a Square Wave to DirectSound </div>

<div class="afterTitles"></div>
<em class="underscore">Video Length (includig Q&A): <a href="https://hero.handmade.network/episode/code/day008/">1h33</a></em>

</p><p>

<div class="admonition ">&ldquo;Handmade Hero Notes&rdquo; contains code from <a href="https://handmadehero.org/">Handmade Hero</a>. Preorder the game on <a href="https://handmadehero.org/">handmadehero.org</a>, and you will receive access to the GitHub repository, containing complete source code (tagged day-by-day) as well as a variety of other useful resources.</div>

</p><p>

<hr/>

</p><p>

We are currently in the middle of setting up our sound support. Last time, we pretty much finished setting up DirectSound and the buffers. Today, we're going to focus on outputting the sound. For this purpose, we're also going to write a simple square wave sound to make sure the system works properly.

</p>
<div class="longTOC">
    <p align="center">
        <span align="left"><a href="day7.html">Day 7</a></span>
        <img src = "../media/logo.png">
        <span align="right"><a href="day9.html">Day 9</a></span>
    </p>
    <p><a href="#" class="tocTop">(Top)</a><br/>
<a href="#directsoundinitreview" class="level1"><span class="tocNumber">1&nbsp; </span>DirectSound Init Review</a><br/>
<a href="#planthesoundoutput" class="level1"><span class="tocNumber">2&nbsp; </span>Plan the Sound Output</a><br/>
&nbsp;&nbsp;<a href="#planthesoundoutput/determinethesoundtooutput" class="level2"><span class="tocNumber">2.1&nbsp; </span>Determine the Sound to Output</a><br/>
&nbsp;&nbsp;<a href="#planthesoundoutput/visualizecircularbuffer" class="level2"><span class="tocNumber">2.2&nbsp; </span>Visualize Circular Buffer</a><br/>
<a href="#fillthebuffer" class="level1"><span class="tocNumber">3&nbsp; </span>Fill the Buffer</a><br/>
&nbsp;&nbsp;<a href="#fillthebuffer/fillthebufferregions" class="level2"><span class="tocNumber">3.1&nbsp; </span>Fill the buffer regions</a><br/>
&nbsp;&nbsp;<a href="#fillthebuffer/implementthesquarewave" class="level2"><span class="tocNumber">3.2&nbsp; </span>Implement the Square Wave</a><br/>
&nbsp;&nbsp;<a href="#fillthebuffer/getcursorpositionandregionsize" class="level2"><span class="tocNumber">3.3&nbsp; </span>Get Cursor Position and Region Size</a><br/>
&nbsp;&nbsp;<a href="#fillthebuffer/simplifysquarewave" class="level2"><span class="tocNumber">3.4&nbsp; </span>Simplify Square Wave</a><br/>
&nbsp;&nbsp;<a href="#fillthebuffer/lockandstartplaying" class="level2"><span class="tocNumber">3.5&nbsp; </span>Lock and Start Playing</a><br/>
<a href="#recap" class="level1"><span class="tocNumber">4&nbsp; </span>Recap</a><br/>
<a href="#exercises" class="level1"><span class="tocNumber">5&nbsp; </span>Exercises</a><br/>
&nbsp;&nbsp;<a href="#exercises/practiceraiionsoundbuffer" class="level2"><span class="tocNumber">5.1&nbsp; </span>Practice RAII on Sound Buffer</a><br/>
&nbsp;&nbsp;<a href="#exercises/extractyoursoundfunctions" class="level2"><span class="tocNumber">5.2&nbsp; </span>Extract Your Sound Functions</a><br/>
<a href="#programmingnotions" class="level1"><span class="tocNumber">6&nbsp; </span>Programming Notions</a><br/>
&nbsp;&nbsp;<a href="#programmingnotions/introtodigitalsoundtheory" class="level2"><span class="tocNumber">6.1&nbsp; </span>Intro to Digital Sound Theory</a><br/>
&nbsp;&nbsp;<a href="#programmingnotions/compression-orientedprogramming" class="level2"><span class="tocNumber">6.2&nbsp; </span>Compression-Oriented Programming</a><br/>
<a href="#navigation" class="level1"><span class="tocNumber">7&nbsp; </span>Navigation</a><br/>
</p></div><a class="target" name="directsoundinitreview">&nbsp;</a><a class="target" name="directsoundinitreview">&nbsp;</a><a class="target" name="toc1">&nbsp;</a><h1>DirectSound Init Review</h1>
<p>


Our <code>Win32InitDSound</code> function currently does the following things: 

</p><p>

<ol start=1>
<li class="number">Load <code>dsound.dll</code> library. 
</li>
<li class="number">Get the address of the function <code>DirectSoundCreate</code>. 
<ul>
    <li class="asterisk">This is the only function that we need to pull directly from <code>dsound.dll</code>.
</li></ul>
<li class="number">Create <code>DirectSound</code> object. 
</li>
<li class="number">Set up the sound format. Variable frequency aside, we know that our sound will have the following properties:
<ul>
    <li class="asterisk">Stereo (2 channels)
</li>
    <li class="asterisk">16 bits per sample (Audio CD quality)
</li>
    <li class="asterisk">We also calculate other things required by the API
</li>
    <li class="asterisk">We requested the sound to be of 48kHz because this seems to be the most common native format for sound output. You can also set it to be 44.1kHz, another common format and the one used in Audio CDs.
</li></ul>
<li class="number">Set the &ldquo;cooperative level&rdquo; of our window to be priority. 
<ul>
    <li class="asterisk">This will allow us to later set up the format of the primary buffer.
</li></ul>
<li class="number">Create Primary Buffer.
<ul>
    <li class="asterisk">In order to do that, we need to <em class="underscore">describe</em> our buffer in the <code>DSBUFFERDESC</code> structure.
</li></ul>
<li class="number">Set the format of the buffer based on the <code>WAVEFORMATEX</code> structure we defined in step 4.
<ul>
    <li class="asterisk">We really only needed to create primary buffer for this. 
</li>
    <li class="asterisk">In theory, you could skip steps 5-7, but then you don't have guarantee that your sound wouldn't be up/downsampled by Windows.
</li></ul>
<li class="number">Create Secondary Buffer. 
<ul>
    <li class="asterisk">We need a buffer description here as well. Among other things we pass a buffer size. We want our buffer to be 2 seconds long to avoid bad jumps on skipped frames.
</li>
    <li class="asterisk">We don't need to set the format separately here, as it can be passed directly inside <code>BufferDescription</code>.</li></ul></li></ol>

</p><p>

And... that's it! The secondary buffer is the only thing that we'll be using from here on. We can't write to the primary buffer anymore as you used to be able in the early days of Windows. Nowadays Windows doesn't give exclusive privileges to write to the sound card: one has to write in the secondary buffer, and the kernel will take all the programs writing to their secondary buffers, mix them together and output to the sound card. 

</p><p>

Since we're going to use this secondary buffer, we will elevate it to our globals. Let's cut it out from <code>Win32InitDSound</code> and paste it as a <code>global_variable</code> next to its peers. We will also add it a <code>Global</code> prefix to its name, in line with the other globals.

</p><pre class="listing tilde"><code><span class="line">global_variable <span class="hljs-keyword">bool</span> GlobalRunning;</span>
<span class="line">global_variable win32_offscreen_buffer GlobalBackbuffer;</span><div class=" add"><span class="line">global_variable IDirectSoundBuffer *GlobalSecondaryBuffer;</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;1:</b> <file>[win32_handmade.cpp]</file></div></center>
<pre class="listing tilde"><code><div class=" delete"><span class="line">IDirectSoundBuffer *SecondaryBuffer;</span></div><div class=" edit"><span class="line"><span class="hljs-keyword">if</span>(SUCCEEDED(DirectSound-&gt;CreateSoundBuffer(&amp;BufferDescription, &amp;GlobalSecondaryBuffer, <span class="hljs-number">0</span>)))</span></div><span class="line">{</span>
<span class="line">    OutputDebugStringA(<span class="hljs-string">"Secondary buffer created successfully.\n"</span>);</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;2:</b> <file>[win32_handmade.cpp > Win32InitDSound]</file> &ldquo;Globalizing&rdquo; the Secondary Buffer pointer.</div></center>
<p>


Again, we could eventually remove it as it's not a good idea having too many globals. In a <em class="underscore">platform layer</em> it's usually not that big of a deal because the code is kind of isolated from the rest of your program. At the same time, you want to be aware of it, as the globals can be modified by anyone, and sometimes it creates a bit of a <em class="underscore">stringiness</em> in your code (or spaghettinnes, if you prefer). Be aware of what you do global, make sure to understand a) why it's global, b) if it should stay global, and c) if there should be only one of these globals around. If any of these things aren't true, don't do it.

</p>
<a class="target" name="planthesoundoutput">&nbsp;</a><a class="target" name="planthesoundoutput">&nbsp;</a><a class="target" name="toc2">&nbsp;</a><h1>Plan the Sound Output</h1>
<p>


You might have noticed by now that we always try to lay out what we're about to do. If you so prefer, you can skim through this part, do the implementation, and return later to fully understand why we took the decisions we took.

</p><p>

That said, you should try and avoid thinking too much ahead. During the implementation new things that you might not have thought through will appear, and if your plan was too tight, it will fall apart or become very ugly very quickly.

</p>
<a class="target" name="determinethesoundtooutput">&nbsp;</a><a class="target" name="planthesoundoutput/determinethesoundtooutput">&nbsp;</a><a class="target" name="toc2.1">&nbsp;</a><h2>Determine the Sound to Output</h2>
<p>


Once we get our buffer, we will be able to output sound from it. In order to do that, we only need to ask where the <code>write</code> cursor is and fill in some memory with the sound.

</p><p>

Now, which sound do we want to reproduce? We can't load audio <code>.wav</code> files just yet, so we're going to generate a sound on the fly. It's going to be a really annoying sound, called <a href="https://en.wikipedia.org/wiki/Square_wave">Square wave</a>. It is however the simplest sound we can generate, so it will do. Its name comes from a very characteristic waveform in which the high, positive signal is immediately followed by a low, negative signal, with nothing inbetween. It looks something like that.

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="96" width="304" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 16,0 L 16,64 " style="fill:none;"/>
<path d="M 48,0 L 48,64 " style="fill:none;"/>
<path d="M 80,0 L 80,64 " style="fill:none;"/>
<path d="M 112,0 L 112,64 " style="fill:none;"/>
<path d="M 144,0 L 144,64 " style="fill:none;"/>
<path d="M 176,0 L 176,64 " style="fill:none;"/>
<path d="M 208,0 L 208,64 " style="fill:none;"/>
<path d="M 240,0 L 240,64 " style="fill:none;"/>
<path d="M 272,0 L 272,64 " style="fill:none;"/>
<path d="M 16,0 L 48,0 " style="fill:none;"/>
<path d="M 80,0 L 112,0 " style="fill:none;"/>
<path d="M 144,0 L 176,0 " style="fill:none;"/>
<path d="M 208,0 L 240,0 " style="fill:none;"/>
<path d="M 272,0 L 288,0 " style="fill:none;"/>
<path d="M 0,64 L 16,64 " style="fill:none;"/>
<path d="M 48,64 L 80,64 " style="fill:none;"/>
<path d="M 112,64 L 144,64 " style="fill:none;"/>
<path d="M 176,64 L 208,64 " style="fill:none;"/>
<path d="M 240,64 L 272,64 " style="fill:none;"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="0" y="36">-</text><text text-anchor="middle" x="32" y="36">-</text><text text-anchor="middle" x="64" y="36">-</text><text text-anchor="middle" x="96" y="36">-</text><text text-anchor="middle" x="128" y="36">-</text><text text-anchor="middle" x="160" y="36">-</text><text text-anchor="middle" x="192" y="36">-</text><text text-anchor="middle" x="224" y="36">-</text><text text-anchor="middle" x="256" y="36">-</text><text text-anchor="middle" x="288" y="36">-</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;1:</b> Square wave.</div></center>

</p>
<a class="target" name="visualizecircularbuffer">&nbsp;</a><a class="target" name="planthesoundoutput/visualizecircularbuffer">&nbsp;</a><a class="target" name="toc2.2">&nbsp;</a><h2>Visualize Circular Buffer</h2>
<p>


Let's review what our buffer actually represents. We said last time that the sound buffer we initialized is a <em class="underscore">circular buffer</em>. If our remember our rendering backbuffer, it was a simple chunk of memory that we agreed was a 2D representation of a bitmap. We would fill the entire buffer, and then pass it to be rendered on screen, again in its entirety. Rinse and repeat. 

</p><p>

We decided not to do it with the sound buffer. Instead, we agreed that our sound buffer would be a 2-second stream of data that we will be constantly updating to make sure the most up to date sounds are played. And, instead of filling it from the beginning to the end, we will write only from a specific point for a while using a &ldquo;cursor&rdquo; which will constantly run from the beginning to the end of the buffer. 

</p><p>

Behind our writing cursor, another one will be running. Like a vacuum cleaner picking up the dust we drop in front of it, it will be reading our bytes and passing them to the sound card for playing. 

</p><p>

Play and Write cursor, in a constant chase of cat and mouse around the buffer.

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="208" width="336" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 24,16 L 24,32 " style="fill:none;"/>
<path d="M 24,112 L 24,144 " style="fill:none;"/>
<path d="M 80,128 L 80,160 " style="fill:none;"/>
<path d="M 168,96 L 168,112 " style="fill:none;"/>
<path d="M 296,16 L 296,32 " style="fill:none;"/>
<path d="M 304,112 L 304,144 " style="fill:none;"/>
<path d="M 40,0 L 280,0 " style="fill:none;"/>
<path d="M 40,48 L 280,48 " style="fill:none;"/>
<path d="M 24,128 L 72,128 " style="fill:none;"/>
<path d="M 88,128 L 160,128 " style="fill:none;"/>
<path d="M 176,128 L 304,128 " style="fill:none;"/>
<path d="M 40,0 C 23.2,0 24,16 24,16 " style="fill:none;"/>
<path d="M 280,0 C 296.8,0 296,16 296,16 " style="fill:none;"/>
<polygon points="288,48 276,42.4 276,53.6 "  style="stroke:none" transform="rotate(0,280,48 )"/>
<polygon points="176,112 164,106.4 164,117.6 "  style="stroke:none" transform="rotate(90,168,112 )"/>
<polygon points="88,160 76,154.4 76,165.6 "  style="stroke:none" transform="rotate(90,80,160 )"/>
<polygon points="32,32 20,26.4 20,37.6 "  style="stroke:none" transform="rotate(90,24,32 )"/>
<circle cx="80" cy="128" r="6" class="closeddot"/><circle cx="168" cy="128" r="6" class="closeddot"/><g transform="translate(0,0)"><text text-anchor="middle" x="64" y="36">c</text><text text-anchor="middle" x="72" y="36">u</text><text text-anchor="middle" x="80" y="36">r</text><text text-anchor="middle" x="88" y="36">s</text><text text-anchor="middle" x="96" y="36">o</text><text text-anchor="middle" x="104" y="36">r</text><text text-anchor="middle" x="120" y="36">m</text><text text-anchor="middle" x="128" y="36">o</text><text text-anchor="middle" x="136" y="36">v</text><text text-anchor="middle" x="144" y="36">e</text><text text-anchor="middle" x="152" y="36">m</text><text text-anchor="middle" x="160" y="36">e</text><text text-anchor="middle" x="168" y="36">n</text><text text-anchor="middle" x="176" y="36">t</text><text text-anchor="middle" x="192" y="36">d</text><text text-anchor="middle" x="200" y="36">i</text><text text-anchor="middle" x="208" y="36">r</text><text text-anchor="middle" x="216" y="36">e</text><text text-anchor="middle" x="224" y="36">c</text><text text-anchor="middle" x="232" y="36">t</text><text text-anchor="middle" x="240" y="36">i</text><text text-anchor="middle" x="248" y="36">o</text><text text-anchor="middle" x="256" y="36">n</text><text text-anchor="middle" x="16" y="84">b</text><text text-anchor="middle" x="24" y="84">u</text><text text-anchor="middle" x="32" y="84">f</text><text text-anchor="middle" x="40" y="84">f</text><text text-anchor="middle" x="48" y="84">e</text><text text-anchor="middle" x="56" y="84">r</text><text text-anchor="middle" x="168" y="84">🎼</text><text text-anchor="middle" x="272" y="84">b</text><text text-anchor="middle" x="280" y="84">u</text><text text-anchor="middle" x="288" y="84">f</text><text text-anchor="middle" x="296" y="84">f</text><text text-anchor="middle" x="304" y="84">e</text><text text-anchor="middle" x="312" y="84">r</text><text text-anchor="middle" x="16" y="100">s</text><text text-anchor="middle" x="24" y="100">t</text><text text-anchor="middle" x="32" y="100">a</text><text text-anchor="middle" x="40" y="100">r</text><text text-anchor="middle" x="48" y="100">t</text><text text-anchor="middle" x="280" y="100">e</text><text text-anchor="middle" x="288" y="100">n</text><text text-anchor="middle" x="296" y="100">d</text><text text-anchor="middle" x="24" y="164">0</text><text text-anchor="middle" x="80" y="180">🔊</text><text text-anchor="middle" x="296" y="180">2</text><text text-anchor="middle" x="304" y="180">s</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_circular">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;2:</b> Play and Write cursors moving through the circular buffer.</div></center>

</p><p>

You could imagine this buffer as if you were infinitely adding a new buffer to the end of the existing one. Thing is, you can't really write ahead infinitely. Once you hit the Play cursor's position right now, you should stop, otherwise the newly written sounds will overwrite whatever the Play cursor wants to read on the current iteration.

</p><p>

For instance, if we write our square wave to the buffer, this how it would look in an &ldquo;unwrapped&rdquo; state:

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="176" width="480" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 24,64 L 24,96 " style="fill:none;"/>
<path d="M 48,48 L 48,112 " style="fill:none;"/>
<path d="M 72,48 L 72,112 " style="fill:none;"/>
<path d="M 80,112 L 80,128 " style="fill:none;"/>
<path d="M 96,48 L 96,112 " style="fill:none;"/>
<path d="M 120,48 L 120,112 " style="fill:none;"/>
<path d="M 144,48 L 144,112 " style="fill:none;"/>
<path d="M 168,32 L 168,112 " style="fill:none;"/>
<path d="M 304,64 L 304,96 " style="fill:none;"/>
<path d="M 352,0 L 352,128 " style="fill:none;"/>
<path d="M 368,48 L 368,112 " style="fill:none;"/>
<path d="M 392,48 L 392,112 " style="fill:none;"/>
<path d="M 416,48 L 416,112 " style="fill:none;"/>
<path d="M 440,32 L 440,112 " style="fill:none;"/>
<path d="M 72,48 L 96,48 " style="fill:none;"/>
<path d="M 120,48 L 144,48 " style="fill:none;"/>
<path d="M 352,48 L 368,48 " style="fill:none;"/>
<path d="M 392,48 L 416,48 " style="fill:none;"/>
<path d="M 24,80 L 72,80 " style="fill:none;"/>
<path d="M 88,80 L 160,80 " style="fill:none;"/>
<path d="M 176,80 L 304,80 " style="fill:none;"/>
<path d="M 48,112 L 72,112 " style="fill:none;"/>
<path d="M 96,112 L 120,112 " style="fill:none;"/>
<path d="M 144,112 L 168,112 " style="fill:none;"/>
<path d="M 368,112 L 392,112 " style="fill:none;"/>
<path d="M 416,112 L 440,112 " style="fill:none;"/>
<polygon points="448,56 436,50.4 436,61.6 "  style="stroke:none" transform="rotate(90,440,56 )"/>
<polygon points="360,128 348,122.4 348,133.6 "  style="stroke:none" transform="rotate(90,352,128 )"/>
<polygon points="176,56 164,50.4 164,61.6 "  style="stroke:none" transform="rotate(90,168,56 )"/>
<polygon points="88,128 76,122.4 76,133.6 "  style="stroke:none" transform="rotate(90,80,128 )"/>
<circle cx="80" cy="80" r="6" class="closeddot"/><circle cx="168" cy="80" r="6" class="closeddot"/><circle cx="352" cy="80" r="6" class="closeddot"/><circle cx="440" cy="80" r="6" class="closeddot"/><g transform="translate(0,0)"><text text-anchor="middle" x="16" y="20">b</text><text text-anchor="middle" x="24" y="20">u</text><text text-anchor="middle" x="32" y="20">f</text><text text-anchor="middle" x="40" y="20">f</text><text text-anchor="middle" x="48" y="20">e</text><text text-anchor="middle" x="56" y="20">r</text><text text-anchor="middle" x="168" y="20">🎼</text><text text-anchor="middle" x="280" y="20">b</text><text text-anchor="middle" x="288" y="20">u</text><text text-anchor="middle" x="296" y="20">f</text><text text-anchor="middle" x="304" y="20">f</text><text text-anchor="middle" x="312" y="20">e</text><text text-anchor="middle" x="320" y="20">r</text><text text-anchor="middle" x="440" y="20">🎼</text><text text-anchor="middle" x="16" y="36">s</text><text text-anchor="middle" x="24" y="36">t</text><text text-anchor="middle" x="32" y="36">a</text><text text-anchor="middle" x="40" y="36">r</text><text text-anchor="middle" x="48" y="36">t</text><text text-anchor="middle" x="288" y="36">e</text><text text-anchor="middle" x="296" y="36">n</text><text text-anchor="middle" x="304" y="36">d</text><text text-anchor="middle" x="176" y="52">┄</text><text text-anchor="middle" x="184" y="52">┄</text><text text-anchor="middle" x="192" y="52">.</text><text text-anchor="middle" x="216" y="52">.</text><text text-anchor="middle" x="224" y="52">┄</text><text text-anchor="middle" x="232" y="52">┄</text><text text-anchor="middle" x="240" y="52">.</text><text text-anchor="middle" x="264" y="52">.</text><text text-anchor="middle" x="272" y="52">┄</text><text text-anchor="middle" x="280" y="52">┄</text><text text-anchor="middle" x="288" y="52">.</text><text text-anchor="middle" x="312" y="52">.</text><text text-anchor="middle" x="320" y="52">┄</text><text text-anchor="middle" x="328" y="52">┄</text><text text-anchor="middle" x="336" y="52">.</text><text text-anchor="middle" x="192" y="68">┊</text><text text-anchor="middle" x="216" y="68">┊</text><text text-anchor="middle" x="240" y="68">┊</text><text text-anchor="middle" x="264" y="68">┊</text><text text-anchor="middle" x="288" y="68">┊</text><text text-anchor="middle" x="312" y="68">┊</text><text text-anchor="middle" x="336" y="68">┊</text><text text-anchor="middle" x="312" y="84">┄</text><text text-anchor="middle" x="320" y="84">┄</text><text text-anchor="middle" x="328" y="84">┄</text><text text-anchor="middle" x="336" y="84">┄</text><text text-anchor="middle" x="344" y="84">┄</text><text text-anchor="middle" x="360" y="84">┄</text><text text-anchor="middle" x="376" y="84">┄</text><text text-anchor="middle" x="384" y="84">┄</text><text text-anchor="middle" x="400" y="84">┄</text><text text-anchor="middle" x="408" y="84">┄</text><text text-anchor="middle" x="424" y="84">┄</text><text text-anchor="middle" x="432" y="84">┄</text><text text-anchor="middle" x="448" y="84">.</text><text text-anchor="middle" x="456" y="84">.</text><text text-anchor="middle" x="464" y="84">.</text><text text-anchor="middle" x="192" y="100">┊</text><text text-anchor="middle" x="216" y="100">┊</text><text text-anchor="middle" x="240" y="100">┊</text><text text-anchor="middle" x="264" y="100">┊</text><text text-anchor="middle" x="288" y="100">┊</text><text text-anchor="middle" x="312" y="100">┊</text><text text-anchor="middle" x="336" y="100">┊</text><text text-anchor="middle" x="192" y="116">'</text><text text-anchor="middle" x="200" y="116">┄</text><text text-anchor="middle" x="208" y="116">┄</text><text text-anchor="middle" x="216" y="116">'</text><text text-anchor="middle" x="240" y="116">'</text><text text-anchor="middle" x="248" y="116">┄</text><text text-anchor="middle" x="256" y="116">┄</text><text text-anchor="middle" x="264" y="116">'</text><text text-anchor="middle" x="288" y="116">'</text><text text-anchor="middle" x="296" y="116">┄</text><text text-anchor="middle" x="304" y="116">┄</text><text text-anchor="middle" x="312" y="116">'</text><text text-anchor="middle" x="336" y="116">'</text><text text-anchor="middle" x="344" y="116">┄</text><text text-anchor="middle" x="24" y="148">0</text><text text-anchor="middle" x="80" y="148">🔊</text><text text-anchor="middle" x="296" y="148">2</text><text text-anchor="middle" x="304" y="148">s</text><text text-anchor="middle" x="352" y="148">🔊</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_unwrapped">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;3:</b> Square wave inside an &ldquo;unwrapped&rdquo; circular buffer. Don't write past the Play cursor!</div></center>

</p><p>

In summary, once the Play cursor passes an area, it becomes available to write new sounds to it. On the other hand, the Write cursor marks the minimum <em class="underscore">safe</em> area. Anything before that risks to produce distorted sounds.

</p><p>

Now, before writing to the buffer, we will need to lock an area that we will specify. We will get in return either one or two regions. Looking at the <a href="#figure_unwrapped">Figure&nbsp;3</a> again, it's easy to see why: you either get one region if all the desired size fits before the end of the buffer, or two regions if it doesn't. 

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="544" width="568" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 16,0 L 16,48 " style="fill:none;"/>
<path d="M 16,256 L 16,304 " style="fill:none;"/>
<path d="M 24,128 L 24,144 " style="fill:none;"/>
<path d="M 24,368 L 24,384 " style="fill:none;"/>
<path d="M 64,480 L 64,496 " style="fill:none;"/>
<path d="M 136,0 L 136,48 " style="fill:none;"/>
<path d="M 136,112 L 136,128 " style="fill:none;"/>
<path d="M 136,256 L 136,304 " style="fill:none;"/>
<path d="M 328,352 L 328,368 " style="fill:none;"/>
<path d="M 432,128 L 432,144 " style="fill:none;"/>
<path d="M 432,368 L 432,384 " style="fill:none;"/>
<path d="M 472,448 L 472,496 " style="fill:none;"/>
<path d="M 16,0 L 136,0 " style="fill:none;"/>
<path d="M 16,48 L 136,48 " style="fill:none;"/>
<path d="M 152,64 L 216,64 " style="fill:none;"/>
<path d="M 248,64 L 312,64 " style="fill:none;"/>
<path d="M 24,144 L 128,144 " style="fill:none;"/>
<path d="M 144,144 L 432,144 " style="fill:none;"/>
<path d="M 152,192 L 216,192 " style="fill:none;"/>
<path d="M 248,192 L 312,192 " style="fill:none;"/>
<path d="M 16,256 L 136,256 " style="fill:none;"/>
<path d="M 16,304 L 136,304 " style="fill:none;"/>
<path d="M 344,304 L 408,304 " style="fill:none;"/>
<path d="M 440,304 L 504,304 " style="fill:none;"/>
<path d="M 24,384 L 320,384 " style="fill:none;"/>
<path d="M 336,384 L 432,384 " style="fill:none;"/>
<path d="M 40,432 L 48,432 " style="fill:none;"/>
<path d="M 80,432 L 96,432 " style="fill:none;"/>
<path d="M 344,432 L 368,432 " style="fill:none;"/>
<path d="M 400,432 L 416,432 " style="fill:none;"/>
<path d="M 448,432 L 456,432 " style="fill:none;"/>
<path d="M 488,432 L 504,432 " style="fill:none;"/>
<path d="M 80,512 L 456,512 " style="fill:none;"/>
<path d="M 152,64 C 135.2,64 136,80 136,80 " style="fill:none;"/>
<path d="M 216,64 C 232.8,64 232,48 232,48 " style="fill:none;"/>
<path d="M 248,64 C 231.2,64 232,48 232,48 " style="fill:none;"/>
<path d="M 312,64 C 328.8,64 328,80 328,80 " style="fill:none;"/>
<path d="M 152,192 C 135.2,192 136,176 136,176 " style="fill:none;"/>
<path d="M 216,192 C 232.8,192 232,208 232,208 " style="fill:none;"/>
<path d="M 248,192 C 231.2,192 232,208 232,208 " style="fill:none;"/>
<path d="M 312,192 C 328.8,192 328,176 328,176 " style="fill:none;"/>
<path d="M 344,304 C 327.2,304 328,320 328,320 " style="fill:none;"/>
<path d="M 408,304 C 424.8,304 424,288 424,288 " style="fill:none;"/>
<path d="M 440,304 C 423.2,304 424,288 424,288 " style="fill:none;"/>
<path d="M 504,304 C 520.8,304 520,320 520,320 " style="fill:none;"/>
<path d="M 40,432 C 23.2,432 24,416 24,416 " style="fill:none;"/>
<path d="M 48,432 C 64.8,432 64,448 64,448 " style="fill:none;"/>
<path d="M 80,432 C 63.2,432 64,448 64,448 " style="fill:none;"/>
<path d="M 96,432 C 112.8,432 112,416 112,416 " style="fill:none;"/>
<path d="M 344,432 C 327.2,432 328,416 328,416 " style="fill:none;"/>
<path d="M 368,432 C 384.8,432 384,448 384,448 " style="fill:none;"/>
<path d="M 400,432 C 383.2,432 384,448 384,448 " style="fill:none;"/>
<path d="M 416,432 C 432.8,432 432,416 432,416 " style="fill:none;"/>
<path d="M 448,432 C 431.2,432 432,416 432,416 " style="fill:none;"/>
<path d="M 456,432 C 472.8,432 472,448 472,448 " style="fill:none;"/>
<path d="M 488,432 C 471.2,432 472,448 472,448 " style="fill:none;"/>
<path d="M 504,432 C 520.8,432 520,416 520,416 " style="fill:none;"/>
<path d="M 80,512 C 63.2,512 64,496 64,496 " style="fill:none;"/>
<path d="M 456,512 C 472.8,512 472,496 472,496 " style="fill:none;"/>
<polygon points="336,368 324,362.4 324,373.6 "  style="stroke:none" transform="rotate(90,328,368 )"/>
<polygon points="144,128 132,122.4 132,133.6 "  style="stroke:none" transform="rotate(90,136,128 )"/>
<polygon points="72,480 60,474.4 60,485.6 "  style="stroke:none" transform="rotate(270,64,480 )"/>
<circle cx="136" cy="144" r="6" class="closeddot"/><circle cx="328" cy="384" r="6" class="closeddot"/><g transform="translate(0,0)"><text text-anchor="middle" x="24" y="20">R</text><text text-anchor="middle" x="32" y="20">e</text><text text-anchor="middle" x="40" y="20">q</text><text text-anchor="middle" x="48" y="20">u</text><text text-anchor="middle" x="56" y="20">e</text><text text-anchor="middle" x="64" y="20">s</text><text text-anchor="middle" x="72" y="20">t</text><text text-anchor="middle" x="80" y="20">e</text><text text-anchor="middle" x="88" y="20">d</text><text text-anchor="middle" x="104" y="20">s</text><text text-anchor="middle" x="112" y="20">i</text><text text-anchor="middle" x="120" y="20">z</text><text text-anchor="middle" x="128" y="20">e</text><text text-anchor="middle" x="24" y="36">f</text><text text-anchor="middle" x="32" y="36">i</text><text text-anchor="middle" x="40" y="36">t</text><text text-anchor="middle" x="48" y="36">s</text><text text-anchor="middle" x="64" y="36">i</text><text text-anchor="middle" x="72" y="36">n</text><text text-anchor="middle" x="88" y="36">b</text><text text-anchor="middle" x="96" y="36">u</text><text text-anchor="middle" x="104" y="36">f</text><text text-anchor="middle" x="112" y="36">f</text><text text-anchor="middle" x="120" y="36">e</text><text text-anchor="middle" x="128" y="36">r</text><text text-anchor="middle" x="184" y="36">d</text><text text-anchor="middle" x="192" y="36">e</text><text text-anchor="middle" x="200" y="36">s</text><text text-anchor="middle" x="208" y="36">i</text><text text-anchor="middle" x="216" y="36">r</text><text text-anchor="middle" x="224" y="36">e</text><text text-anchor="middle" x="232" y="36">d</text><text text-anchor="middle" x="248" y="36">s</text><text text-anchor="middle" x="256" y="36">i</text><text text-anchor="middle" x="264" y="36">z</text><text text-anchor="middle" x="272" y="36">e</text><text text-anchor="middle" x="16" y="100">b</text><text text-anchor="middle" x="24" y="100">u</text><text text-anchor="middle" x="32" y="100">f</text><text text-anchor="middle" x="40" y="100">f</text><text text-anchor="middle" x="48" y="100">e</text><text text-anchor="middle" x="56" y="100">r</text><text text-anchor="middle" x="136" y="100">🎼</text><text text-anchor="middle" x="328" y="100">┊</text><text text-anchor="middle" x="416" y="100">b</text><text text-anchor="middle" x="424" y="100">u</text><text text-anchor="middle" x="432" y="100">f</text><text text-anchor="middle" x="440" y="100">f</text><text text-anchor="middle" x="448" y="100">e</text><text text-anchor="middle" x="456" y="100">r</text><text text-anchor="middle" x="16" y="116">s</text><text text-anchor="middle" x="24" y="116">t</text><text text-anchor="middle" x="32" y="116">a</text><text text-anchor="middle" x="40" y="116">r</text><text text-anchor="middle" x="48" y="116">t</text><text text-anchor="middle" x="328" y="116">┊</text><text text-anchor="middle" x="424" y="116">e</text><text text-anchor="middle" x="432" y="116">n</text><text text-anchor="middle" x="440" y="116">d</text><text text-anchor="middle" x="328" y="132">┊</text><text text-anchor="middle" x="136" y="164">┊</text><text text-anchor="middle" x="328" y="164">┊</text><text text-anchor="middle" x="200" y="228">r</text><text text-anchor="middle" x="208" y="228">e</text><text text-anchor="middle" x="216" y="228">g</text><text text-anchor="middle" x="224" y="228">i</text><text text-anchor="middle" x="232" y="228">o</text><text text-anchor="middle" x="240" y="228">n</text><text text-anchor="middle" x="256" y="228">1</text><text text-anchor="middle" x="24" y="276">R</text><text text-anchor="middle" x="32" y="276">e</text><text text-anchor="middle" x="40" y="276">q</text><text text-anchor="middle" x="48" y="276">u</text><text text-anchor="middle" x="56" y="276">e</text><text text-anchor="middle" x="64" y="276">s</text><text text-anchor="middle" x="72" y="276">t</text><text text-anchor="middle" x="80" y="276">e</text><text text-anchor="middle" x="88" y="276">d</text><text text-anchor="middle" x="104" y="276">s</text><text text-anchor="middle" x="112" y="276">i</text><text text-anchor="middle" x="120" y="276">z</text><text text-anchor="middle" x="128" y="276">e</text><text text-anchor="middle" x="376" y="276">d</text><text text-anchor="middle" x="384" y="276">e</text><text text-anchor="middle" x="392" y="276">s</text><text text-anchor="middle" x="400" y="276">i</text><text text-anchor="middle" x="408" y="276">r</text><text text-anchor="middle" x="416" y="276">e</text><text text-anchor="middle" x="424" y="276">d</text><text text-anchor="middle" x="440" y="276">s</text><text text-anchor="middle" x="448" y="276">i</text><text text-anchor="middle" x="456" y="276">z</text><text text-anchor="middle" x="464" y="276">e</text><text text-anchor="middle" x="32" y="292">d</text><text text-anchor="middle" x="40" y="292">o</text><text text-anchor="middle" x="48" y="292">e</text><text text-anchor="middle" x="56" y="292">s</text><text text-anchor="middle" x="64" y="292">n</text><text text-anchor="middle" x="72" y="292">'</text><text text-anchor="middle" x="80" y="292">t</text><text text-anchor="middle" x="96" y="292">f</text><text text-anchor="middle" x="104" y="292">i</text><text text-anchor="middle" x="112" y="292">t</text><text text-anchor="middle" x="16" y="340">b</text><text text-anchor="middle" x="24" y="340">u</text><text text-anchor="middle" x="32" y="340">f</text><text text-anchor="middle" x="40" y="340">f</text><text text-anchor="middle" x="48" y="340">e</text><text text-anchor="middle" x="56" y="340">r</text><text text-anchor="middle" x="328" y="340">🎼</text><text text-anchor="middle" x="416" y="340">b</text><text text-anchor="middle" x="424" y="340">u</text><text text-anchor="middle" x="432" y="340">f</text><text text-anchor="middle" x="440" y="340">f</text><text text-anchor="middle" x="448" y="340">e</text><text text-anchor="middle" x="456" y="340">r</text><text text-anchor="middle" x="520" y="340">┊</text><text text-anchor="middle" x="16" y="356">s</text><text text-anchor="middle" x="24" y="356">t</text><text text-anchor="middle" x="32" y="356">a</text><text text-anchor="middle" x="40" y="356">r</text><text text-anchor="middle" x="48" y="356">t</text><text text-anchor="middle" x="424" y="356">e</text><text text-anchor="middle" x="432" y="356">n</text><text text-anchor="middle" x="440" y="356">d</text><text text-anchor="middle" x="520" y="356">┊</text><text text-anchor="middle" x="520" y="372">┊</text><text text-anchor="middle" x="440" y="388">┄</text><text text-anchor="middle" x="448" y="388">┄</text><text text-anchor="middle" x="456" y="388">┄</text><text text-anchor="middle" x="464" y="388">┄</text><text text-anchor="middle" x="472" y="388">┄</text><text text-anchor="middle" x="480" y="388">┄</text><text text-anchor="middle" x="488" y="388">┄</text><text text-anchor="middle" x="496" y="388">┄</text><text text-anchor="middle" x="504" y="388">┄</text><text text-anchor="middle" x="512" y="388">┄</text><text text-anchor="middle" x="520" y="388">┄</text><text text-anchor="middle" x="528" y="388">┄</text><text text-anchor="middle" x="536" y="388">┄</text><text text-anchor="middle" x="544" y="388">.</text><text text-anchor="middle" x="552" y="388">.</text><text text-anchor="middle" x="24" y="404">┊</text><text text-anchor="middle" x="112" y="404">┊</text><text text-anchor="middle" x="328" y="404">┊</text><text text-anchor="middle" x="432" y="404">┊</text><text text-anchor="middle" x="520" y="404">┊</text><text text-anchor="middle" x="40" y="468">r</text><text text-anchor="middle" x="48" y="468">e</text><text text-anchor="middle" x="56" y="468">g</text><text text-anchor="middle" x="64" y="468">i</text><text text-anchor="middle" x="72" y="468">o</text><text text-anchor="middle" x="80" y="468">n</text><text text-anchor="middle" x="96" y="468">2</text><text text-anchor="middle" x="352" y="468">r</text><text text-anchor="middle" x="360" y="468">e</text><text text-anchor="middle" x="368" y="468">g</text><text text-anchor="middle" x="376" y="468">i</text><text text-anchor="middle" x="384" y="468">o</text><text text-anchor="middle" x="392" y="468">n</text><text text-anchor="middle" x="408" y="468">1</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_regions">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;4:</b> Locking one or two regions of the buffer. Note that the desired size and the buffer size are the same, what changes is only the Write cursor position at the moment of lock (represented by 🎼), thus impacting the produced regions.</div></center>

</p><p>

This is the gist of it. Now, let's think about a few other details before we're ready to make it happen: 

</p><p>

<ul>
<li class="asterisk">We will write to our <code>GlobalSecondaryBuffer</code> so we will use this <em class="underscore">object</em> to call its <em class="underscore">methods</em>.
</li>
<li class="asterisk">We want to get the Play cursor position.
</li>
<li class="asterisk">We will ignore the actual Write cursor position. Instead, we will calculate ourselves the point from which to lock our region/s.
</li>
<li class="asterisk">Windows wants to know when we're start and stop writing to our sound buffer. This is done by <code>Lock</code>ing and <code>Unlock</code>ing the sound buffer.
</li>
<li class="asterisk">The amount of bytes to write will correspond to the distance from our byte to lock to the Read cursor (wrapping around if necessary).
</li>
<li class="asterisk">We will presume that the sound buffer is unwrapped. This can be achieved by getting a running sample index which will always increase, modulate our position against the secondary buffer size and thus calculating byte to lock.
</li>
<li class="asterisk">Last, we should of course start playing our sound.</li></ul>

</p><p>

Now, luckily DirectSound knows that its buffers are often used in a circular manner, so it accounts for the probability that we can receive in return up to <em class="underscore">two</em> regions. The internal logic of the API in that case is the following:

</p><p>

<ol start=1>
<li class="number">Receive a request to lock a region of a specific size, bigger than the remaining space in the buffer (from the write cursor position to the end).
</li>
<li class="number">Calculate how much extra space is required.
<ul>
    <li class="asterisk">Cannot return the memory outside the buffer!
</li></ul>
<li class="number">Lock the overrun amount at the beginning of the buffer.
</li>
<li class="number">Return the two regions to us.</li></ol>

</p><p>

Of course, this doesn't always happen. The whole region we've requested might fit well within the borders of the borders of the buffer.

</p><p>

We should be prepared to handle both of these cases, whether we get the requested memory in one block, or two. It's easy to do, but it's important to understand the idea before implementing it.

</p>
<a class="target" name="fillthebuffer">&nbsp;</a><a class="target" name="fillthebuffer">&nbsp;</a><a class="target" name="toc3">&nbsp;</a><h1>Fill the Buffer</h1>
<p>


Let's get to coding this down. Inside our <code>WinMain</code>, we'll clear some space and get ready to output our buffer, say, right after we render our gradient:

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line"><span class="hljs-comment">// ...</span></span>
<span class="line">RenderWeirdGradient(&amp;GlobalBackbuffer, XOffset, YOffset);</span>
<span class="line">                </span></div><div class=" add"><span class="line"><span class="hljs-comment">// NOTE(casey): DirectSound output test</span></span></div><div class=" C++ "><span class="line"></span>
<span class="line">win32_window_dimension Dimension = Win32GetWindowDimension(Window);</span>
<span class="line">Win32DisplayBufferInWindow(&amp;GlobalBackbuffer, DeviceContext, Dimension.Width, Dimension.Height);</span>
<span class="line">// ...</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;3:</b> <file>[win32_handmade.cpp > WinMain]</file> Finding a suitable place for our code to live.</div></center>
<p>


Locking is achieved by calling <a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/mt708932(v=vs.85)">Lock</a> method from our <code>GlobalSecondaryBuffer</code> object (if you recall, we call methods any functions which are retrieved from objects, as opposed to straight from the source file). This is what the <code>Lock</code>'s signature looks like: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">HRESULT <span class="hljs-title">Lock</span><span class="hljs-params">( </span>
<span class="line">  DWORD   dwWriteCursor,   <span class="hljs-comment">// Input </span></span>
<span class="line">  DWORD   dwWriteBytes,    <span class="hljs-comment">// Input</span></span>
<span class="line">  LPVOID  lplpvAudioPtr1,  <span class="hljs-comment">// Output</span></span>
<span class="line">  LPDWORD lpdwAudioBytes1, <span class="hljs-comment">// Output </span></span>
<span class="line">  LPVOID  lplpvAudioPtr2,  <span class="hljs-comment">// Output</span></span>
<span class="line">  LPDWORD lpdwAudioBytes2, <span class="hljs-comment">// Output </span></span>
<span class="line">  DWORD   dwFlags          <span class="hljs-comment">// Input</span></span>
<span class="line">)</span></span>;</span></code></pre><center><div class="listingcaption tilde"><file>[MSDN]</file> <code>IDirectSoundBuffer::Lock</code> method syntax.</div></center>
<p>


There're a few interesting things to note. First, the method returns an <code>HRESULT</code> which, as we remember from the <a href="day7.html">last time</a>, can (and really, should) be tested with <code>SUCCEEDED</code> macro. As for its parameters, we have a big amount of output values which roughly correspond to what we said. 

</p><p>

<ul>
<li class="asterisk"><code>dwWriteCursor</code>: The starting address of our write pointer. Let's say we will have a certain <code>ByteToLock</code> which we will lock. We'll return to it a bit later.
</li>
<li class="asterisk"><code>dwWriteBytes</code>: How many bytes we intend to write to, i.e. our &ldquo;desired size&rdquo;. Let's say we're going to write some <code>BytesToWrite</code> value that we will come up with later.
</li>
<li class="asterisk"><code>lplpvAudioPtr1</code>, <code>lpdwAudioBytes1</code>: Address of a pointer and a size variable for the first region you will receive back.
</li>
<li class="asterisk"><code>lplpvAudioPtr2</code>, <code>lpdwAudioBytes2</code>: Address of a pointer and a size variable for the potential second region, if any. 
</li>
<li class="asterisk"><code>dwFlags</code>: There a couple flags that we could pass here. We don't really need them, so just pass <code>0</code>.</li></ul>

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line">// NOTE(casey): DirectSound output <span class="hljs-built_in">test</span></span></div><div class=" add"><span class="line">DWORD ByteToLock = ;   <span class="hljs-comment">// TODO!</span></span>
<span class="line">DWORD BytesToWrite = ; <span class="hljs-comment">// TODO!</span></span>
<span class="line"></span>
<span class="line">VOID *Region1;</span>
<span class="line">DWORD Region1Size;</span>
<span class="line">VOID *Region2;</span>
<span class="line">DWORD Region2Size;</span>
<span class="line"><span class="hljs-keyword">if</span> (SUCCEEDED(GlobalSecondaryBuffer-&gt;Lock(ByteToLock, BytesToWrite,</span>
<span class="line">                                          &amp;Region1, &amp;Region1Size,</span>
<span class="line">                                          &amp;Region2, &amp;Region2Size, </span>
<span class="line">                                          <span class="hljs-number">0</span>)))</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// All good, we can write to the buffer</span></span>
<span class="line">}</span>
<span class="line"></span></div><div class=" C++ "><span class="line">// ... </span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;4:</b> <file>[win32_handmade.cpp > WinMain]</file> Locking our buffer for writing.</div></center>
<p>


<code>Region1, Region1Size, Region2</code> and <code>Region2Size</code> will be filled out by the buffer, so we can leave them as that. As for <code>ByteToLock</code> and <code>BytesToWrite</code>, these will need to come from <em class="underscore">somewhere</em>. We'll return to them in a minute, for now lets move on.

</p>
<a class="target" name="fillthebufferregions">&nbsp;</a><a class="target" name="fillthebuffer/fillthebufferregions">&nbsp;</a><a class="target" name="toc3.1">&nbsp;</a><h2>Fill the buffer regions</h2>
<p>


Now that we have our buffer ready and willing to accept our samples, let's think about how exactly will we write to it. our graphics backbuffer was accepting 32-bit Pixels in a specific format. Similarly, we'll be writing sound in Samples, each 16-bit sample alternating between two channels. 

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="208" width="440" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 16,80 L 16,112 " style="fill:none;"/>
<path d="M 16,144 L 16,160 " style="fill:none;"/>
<path d="M 48,80 L 48,112 " style="fill:none;"/>
<path d="M 48,144 L 48,160 " style="fill:none;"/>
<path d="M 80,16 L 80,48 " style="fill:none;"/>
<path d="M 80,80 L 80,112 " style="fill:none;"/>
<path d="M 112,80 L 112,112 " style="fill:none;"/>
<path d="M 144,16 L 144,48 " style="fill:none;"/>
<path d="M 144,80 L 144,112 " style="fill:none;"/>
<path d="M 176,80 L 176,112 " style="fill:none;"/>
<path d="M 208,16 L 208,48 " style="fill:none;"/>
<path d="M 208,80 L 208,112 " style="fill:none;"/>
<path d="M 240,80 L 240,112 " style="fill:none;"/>
<path d="M 272,16 L 272,48 " style="fill:none;"/>
<path d="M 272,80 L 272,112 " style="fill:none;"/>
<path d="M 304,80 L 304,112 " style="fill:none;"/>
<path d="M 336,16 L 336,48 " style="fill:none;"/>
<path d="M 336,80 L 336,112 " style="fill:none;"/>
<path d="M 368,80 L 368,112 " style="fill:none;"/>
<path d="M 400,80 L 400,112 " style="fill:none;"/>
<path d="M 16,32 L 408,32 " style="fill:none;"/>
<path d="M 16,80 L 400,80 " style="fill:none;"/>
<path d="M 16,112 L 400,112 " style="fill:none;"/>
<path d="M 16,160 L 48,160 " style="fill:none;"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="32" y="20">L</text><text text-anchor="middle" x="40" y="20">E</text><text text-anchor="middle" x="48" y="20">F</text><text text-anchor="middle" x="56" y="20">T</text><text text-anchor="middle" x="96" y="20">R</text><text text-anchor="middle" x="104" y="20">I</text><text text-anchor="middle" x="112" y="20">G</text><text text-anchor="middle" x="120" y="20">H</text><text text-anchor="middle" x="128" y="20">T</text><text text-anchor="middle" x="160" y="20">L</text><text text-anchor="middle" x="168" y="20">E</text><text text-anchor="middle" x="176" y="20">F</text><text text-anchor="middle" x="184" y="20">T</text><text text-anchor="middle" x="224" y="20">R</text><text text-anchor="middle" x="232" y="20">I</text><text text-anchor="middle" x="240" y="20">G</text><text text-anchor="middle" x="248" y="20">H</text><text text-anchor="middle" x="256" y="20">T</text><text text-anchor="middle" x="288" y="20">L</text><text text-anchor="middle" x="296" y="20">E</text><text text-anchor="middle" x="304" y="20">F</text><text text-anchor="middle" x="312" y="20">T</text><text text-anchor="middle" x="352" y="20">R</text><text text-anchor="middle" x="360" y="20">I</text><text text-anchor="middle" x="368" y="20">G</text><text text-anchor="middle" x="376" y="20">H</text><text text-anchor="middle" x="384" y="20">T</text><text text-anchor="middle" x="416" y="36">.</text><text text-anchor="middle" x="424" y="36">.</text><text text-anchor="middle" x="40" y="52">s</text><text text-anchor="middle" x="48" y="52">1</text><text text-anchor="middle" x="56" y="52">6</text><text text-anchor="middle" x="104" y="52">s</text><text text-anchor="middle" x="112" y="52">1</text><text text-anchor="middle" x="120" y="52">6</text><text text-anchor="middle" x="168" y="52">s</text><text text-anchor="middle" x="176" y="52">1</text><text text-anchor="middle" x="184" y="52">6</text><text text-anchor="middle" x="232" y="52">s</text><text text-anchor="middle" x="240" y="52">1</text><text text-anchor="middle" x="248" y="52">6</text><text text-anchor="middle" x="296" y="52">s</text><text text-anchor="middle" x="304" y="52">1</text><text text-anchor="middle" x="312" y="52">6</text><text text-anchor="middle" x="360" y="52">s</text><text text-anchor="middle" x="368" y="52">1</text><text text-anchor="middle" x="376" y="52">6</text><text text-anchor="middle" x="408" y="100">.</text><text text-anchor="middle" x="416" y="100">.</text><text text-anchor="middle" x="424" y="100">.</text><text text-anchor="middle" x="16" y="180">1</text><text text-anchor="middle" x="32" y="180">b</text><text text-anchor="middle" x="40" y="180">y</text><text text-anchor="middle" x="48" y="180">t</text><text text-anchor="middle" x="56" y="180">e</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;5:</b> The structure of our sound output in memory.</div></center>

</p><p>

You can quickly realize that it will be simpler for us to think about samples in terms of a single <code>Left-Right</code> unit, instead of <code>Left</code> or <code>Right</code> separate things. There's no sense in writing to the <code>Left</code> channel if we aren't writing to the <code>Right</code> channel, and vice versa. Therefore, we could abstract this even further and think of a <code>Left-Right</code> pair as a single, 32-bit wide, <code>Sample</code>. The name might be confusing with the individual <code>Left</code> or <code>Right</code> samples, but we'll be calling those <code>Channels</code> from here on.

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="176" width="440" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 16,112 L 16,144 " style="fill:none;"/>
<path d="M 48,112 L 48,144 " style="fill:none;"/>
<path d="M 80,64 L 80,80 " style="fill:none;"/>
<path d="M 80,112 L 80,144 " style="fill:none;"/>
<path d="M 112,112 L 112,144 " style="fill:none;"/>
<path d="M 144,48 L 144,80 " style="fill:none;"/>
<path d="M 144,112 L 144,144 " style="fill:none;"/>
<path d="M 176,112 L 176,144 " style="fill:none;"/>
<path d="M 208,64 L 208,80 " style="fill:none;"/>
<path d="M 208,112 L 208,144 " style="fill:none;"/>
<path d="M 240,112 L 240,144 " style="fill:none;"/>
<path d="M 272,48 L 272,80 " style="fill:none;"/>
<path d="M 272,112 L 272,144 " style="fill:none;"/>
<path d="M 304,112 L 304,144 " style="fill:none;"/>
<path d="M 336,64 L 336,80 " style="fill:none;"/>
<path d="M 336,112 L 336,144 " style="fill:none;"/>
<path d="M 368,112 L 368,144 " style="fill:none;"/>
<path d="M 400,112 L 400,144 " style="fill:none;"/>
<path d="M 32,32 L 64,32 " style="fill:none;"/>
<path d="M 96,32 L 128,32 " style="fill:none;"/>
<path d="M 160,32 L 192,32 " style="fill:none;"/>
<path d="M 224,32 L 256,32 " style="fill:none;"/>
<path d="M 288,32 L 320,32 " style="fill:none;"/>
<path d="M 352,32 L 384,32 " style="fill:none;"/>
<path d="M 16,64 L 408,64 " style="fill:none;"/>
<path d="M 16,112 L 400,112 " style="fill:none;"/>
<path d="M 16,144 L 400,144 " style="fill:none;"/>
<path d="M 32,32 C 15.2,32 16,48 16,48 " style="fill:none;"/>
<path d="M 64,32 C 80.8,32 80,16 80,16 " style="fill:none;"/>
<path d="M 96,32 C 79.2,32 80,16 80,16 " style="fill:none;"/>
<path d="M 128,32 C 144.8,32 144,48 144,48 " style="fill:none;"/>
<path d="M 160,32 C 143.2,32 144,48 144,48 " style="fill:none;"/>
<path d="M 192,32 C 208.8,32 208,16 208,16 " style="fill:none;"/>
<path d="M 224,32 C 207.2,32 208,16 208,16 " style="fill:none;"/>
<path d="M 256,32 C 272.8,32 272,48 272,48 " style="fill:none;"/>
<path d="M 288,32 C 271.2,32 272,48 272,48 " style="fill:none;"/>
<path d="M 320,32 C 336.8,32 336,16 336,16 " style="fill:none;"/>
<path d="M 352,32 C 335.2,32 336,16 336,16 " style="fill:none;"/>
<path d="M 384,32 C 400.8,32 400,48 400,48 " style="fill:none;"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="64" y="4">S</text><text text-anchor="middle" x="72" y="4">a</text><text text-anchor="middle" x="80" y="4">m</text><text text-anchor="middle" x="88" y="4">p</text><text text-anchor="middle" x="96" y="4">l</text><text text-anchor="middle" x="104" y="4">e</text><text text-anchor="middle" x="192" y="4">S</text><text text-anchor="middle" x="200" y="4">a</text><text text-anchor="middle" x="208" y="4">m</text><text text-anchor="middle" x="216" y="4">p</text><text text-anchor="middle" x="224" y="4">l</text><text text-anchor="middle" x="232" y="4">e</text><text text-anchor="middle" x="320" y="4">S</text><text text-anchor="middle" x="328" y="4">a</text><text text-anchor="middle" x="336" y="4">m</text><text text-anchor="middle" x="344" y="4">p</text><text text-anchor="middle" x="352" y="4">l</text><text text-anchor="middle" x="360" y="4">e</text><text text-anchor="middle" x="32" y="52">L</text><text text-anchor="middle" x="40" y="52">E</text><text text-anchor="middle" x="48" y="52">F</text><text text-anchor="middle" x="56" y="52">T</text><text text-anchor="middle" x="96" y="52">R</text><text text-anchor="middle" x="104" y="52">I</text><text text-anchor="middle" x="112" y="52">G</text><text text-anchor="middle" x="120" y="52">H</text><text text-anchor="middle" x="128" y="52">T</text><text text-anchor="middle" x="160" y="52">L</text><text text-anchor="middle" x="168" y="52">E</text><text text-anchor="middle" x="176" y="52">F</text><text text-anchor="middle" x="184" y="52">T</text><text text-anchor="middle" x="224" y="52">R</text><text text-anchor="middle" x="232" y="52">I</text><text text-anchor="middle" x="240" y="52">G</text><text text-anchor="middle" x="248" y="52">H</text><text text-anchor="middle" x="256" y="52">T</text><text text-anchor="middle" x="288" y="52">L</text><text text-anchor="middle" x="296" y="52">E</text><text text-anchor="middle" x="304" y="52">F</text><text text-anchor="middle" x="312" y="52">T</text><text text-anchor="middle" x="352" y="52">R</text><text text-anchor="middle" x="360" y="52">I</text><text text-anchor="middle" x="368" y="52">G</text><text text-anchor="middle" x="376" y="52">H</text><text text-anchor="middle" x="384" y="52">T</text><text text-anchor="middle" x="416" y="68">.</text><text text-anchor="middle" x="424" y="68">.</text><text text-anchor="middle" x="40" y="84">s</text><text text-anchor="middle" x="48" y="84">1</text><text text-anchor="middle" x="56" y="84">6</text><text text-anchor="middle" x="104" y="84">s</text><text text-anchor="middle" x="112" y="84">1</text><text text-anchor="middle" x="120" y="84">6</text><text text-anchor="middle" x="168" y="84">s</text><text text-anchor="middle" x="176" y="84">1</text><text text-anchor="middle" x="184" y="84">6</text><text text-anchor="middle" x="232" y="84">s</text><text text-anchor="middle" x="240" y="84">1</text><text text-anchor="middle" x="248" y="84">6</text><text text-anchor="middle" x="296" y="84">s</text><text text-anchor="middle" x="304" y="84">1</text><text text-anchor="middle" x="312" y="84">6</text><text text-anchor="middle" x="360" y="84">s</text><text text-anchor="middle" x="368" y="84">1</text><text text-anchor="middle" x="376" y="84">6</text><text text-anchor="middle" x="408" y="132">.</text><text text-anchor="middle" x="416" y="132">.</text><text text-anchor="middle" x="424" y="132">.</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;6:</b> Abstracting Stereo Channels.</div></center>

</p><p>

We can also say with certainty that our cursor and <code>BytesToWrite</code> will always be an even multiple of a Sample size (which is, under this logic, 4 bytes long). We can't really output less than that because it wouldn't make sense for our stereo sound. 

</p><p>

So when <code>Region1Size</code> or <code>Region2Size</code> come back, they'd better be even multiple of a Sample size as well. Because if it's not the case, something weird has happened. 

</p><p>

<div class="admonition ">This would be a good place to <em class="underscore">assert</em> that this assumption is <em class="underscore">always</em> true.

</p><p>

    We will skip the talk about assertions for now, because it's a pretty important topic and must be handled separately. For now we can leave a TODO for future us:

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line"><span class="hljs-keyword">if</span> (SUCCEEDED(GlobalSecondaryBuffer-&gt;Lock(...)))</span>
<span class="line">{</span>
<span class="line"><span class="hljs-comment">// All good, we can write to the buffer</span></span></div><div class=" add"><span class="line"><span class="hljs-comment">// TODO(casey): assert that Region1Size/Region2Size are valid </span></span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;5:</b> <file>[win32_handmade.cpp > WinMain]</file> Thinking about the future.</div></center></div>

</p><p>

<p>



So, now that we know how to think about this next part, let's implement it. There're many ways approaching it, let's do the most explicit one. 

</p><p>

As with our rendering, we'll throw in a couple of <code>for</code> loops. First, we will iterate over <code>Region1</code> and then, if <code>Region2Size</code> is anything greater than <code>0</code>, over <code>Region2</code>. Since we get <code>0</code> in <code>Region2Size</code> if the <code>Region2</code> isn't necessary, we don't need to put any extra <code>if</code> statements: the second loop will simply not go off.

</p><p>

We will be iterating over a value called <code>SampleCount</code> for regions 1 and 2. This will be our actual region size divided by the <code>BytesPerSample</code> value we calculated last time.

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line">GlobalSecondaryBuffer-&gt;Lock(...);</span>
<span class="line"><span class="hljs-comment">// TODO(casey): assert that Region1Size/Region2Size are valid </span></span></div><div class=" add"><span class="line">DWORD Region1SampleCount = Region1Size / BytesPerSample;</span>
<span class="line"><span class="hljs-keyword">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line">     SampleIndex &lt; Region1SampleCount;</span>
<span class="line">     ++SampleIndex)</span>
<span class="line">{</span>
<span class="line">}</span>
<span class="line">DWORD Region2SampleCount = Region2Size / BytesPerSample;</span>
<span class="line"><span class="hljs-keyword">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line">     SampleIndex &lt; Region2SampleCount;</span>
<span class="line">     ++SampleIndex)</span>
<span class="line">{</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;6:</b> <file>[win32_handmade.cpp > WinMain]</file> Iterating over buffer regions.</div></center>
<p>


Please note that contrary to the &ldquo;2D&rdquo; render buffer loop we only need to iterate once inside each &ldquo;1D&rdquo; sound buffer loop. The two different loops we typed in are consecutive for two different regions that we might get. 

</p><p>

As with <code>Pixel</code>, we'll have our <code>SampleOut</code>. We'll make it the sound of a single channel (16 bit) and use to iterate over our regions. This means that we initialize it pointing at the region beginning, and will be slowly advancing it as we write down our samples. 

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line"><span class="hljs-keyword">if</span> (SUCCEEDED(GlobalSecondaryBuffer-&gt;Lock(...)))</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// TODO(casey): assert that Region1Size/Region2Size are valid </span></span></div><div class=" add"><span class="line">    s16 *SampleOut = (s16 *)Region1;</span></div><span class="line">    DWORD Region1SampleCount = Region1Size / BytesPerSample;</span>
<span class="line">    <span class="hljs-keyword">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line">        SampleIndex &lt; Region1SampleCount;</span>
<span class="line">        ++SampleIndex)</span>
<span class="line">    {</span><div class=" add"><span class="line">*SampleOut++ = LEFT;</span>
<span class="line">*SampleOut++ = RIGHT;</span></div><span class="line">    }</span>
<span class="line"></span><div class=" add"><span class="line">    SampleOut = (s16 *)Region2;</span></div><span class="line">    DWORD Region2SampleCount = Region2Size / BytesPerSample;</span>
<span class="line">    <span class="hljs-keyword">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line">         SampleIndex &lt; Region2SampleCount;</span>
<span class="line">        ++SampleIndex)</span>
<span class="line">    {</span><div class=" add"><span class="line">    *SampleOut++ = LEFT;</span>
<span class="line">    *SampleOut++ = RIGHT;</span></div><span class="line">    }</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;7:</b> <file>[win32_handmade.cpp > WinMain]</file> SampleOut.</div></center>

<a class="target" name="implementthesquarewave">&nbsp;</a><a class="target" name="fillthebuffer/implementthesquarewave">&nbsp;</a><a class="target" name="toc3.2">&nbsp;</a><h2>Implement the Square Wave</h2>
<p>


We assume that you have some basic knowledge how digital sound sampling works. If not, check out subsection  <a href="#toc6.1">6.1</a>. 

</p><p>

Now, square wave is super simple (that's why we're implementing it). Its samples are either at their maximum or their minimum, with no inbetween. So in practice we should only know when flip the sign, and what the &ldquo;maximum&rdquo; and &ldquo;minimum&rdquo; values are. It's calculated in the following way:

</p><p>

A few things can be precalculated before we enter our main loop: 

</p><p>

<ol start=1>
<li class="number">Determine our tone, in Hertz, that we want our square wave to have.
<ul>
    <li class="asterisk">Supposedly, we want a value around &ldquo;Middle C&rdquo;, i.e. 261Hz. 
</li>
    <li class="asterisk">Let's round it down to 256. 
</li></ul>
<li class="number">Determine the wave period or <em class="underscore">wavelength</em> of our wave, <code>SquareWavePeriod</code>.
<ul>
    <li class="asterisk">Simply take our <code>SamplesPerSecond</code> and divide it by desired <code>ToneHz</code>. 
</li></ul>
<li class="number">Take a half of that <code>SquareWavePeriod</code>. 
</li>
<li class="number">Set up sound pitch (i.e. Tone Volume) to be, let's say, 3000. We can always adjust it later on.
</li>
<li class="number">Set up a sample counter. 
<ul>
    <li class="asterisk">Each time the sample counter reaches zero, we'll reset it back to <code>SquareWavePeriod</code>. 
</li>
    <li class="asterisk">At the end of each sample iteration, decrease sample counter by 1.</li></ul></li></ol>

</p><p>

The actual wave sampling will of course happen inside the main loop: 

</p><p>

<ol start=6>
<li class="number">Calculate <code>SampleValue</code>. If our <code>SquareWaveCounter</code> is greater than our <code>HalfSquareWavePeriod</code>, it will be <code>SoundPitch</code>. If not, <code>-SoundPitch</code>.
<ul>
    <li class="asterisk">In other words, half of the wave will be positive, the other one will be negative
</li></ul>
<li class="number">Write the <code>SampleValue</code> to the left and right channels.</li></ol>

</p><p>

Try to implement it all yourself! You will find our implementation below: 

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-comment">// NOTE(casey): Sound test constants</span></span></div><span class="line"><span class="hljs-keyword">int</span> SamplesPerSecond = <span class="hljs-number">48000</span>;</span>
<span class="line"><span class="hljs-keyword">int</span> BytesPerSample = <span class="hljs-keyword">sizeof</span>(s16) * <span class="hljs-number">2</span>;</span>
<span class="line"><span class="hljs-keyword">int</span> SecondaryBufferSize = <span class="hljs-number">2</span> * SamplesPerSecond * BytesPerSample;</span><div class=" add"><span class="line"><span class="hljs-keyword">int</span> ToneHz = <span class="hljs-number">256</span>; </span>
<span class="line"><span class="hljs-keyword">int</span> SquareWavePeriod = SamplesPerSecond / ToneHz; </span>
<span class="line"><span class="hljs-keyword">int</span> HalfSquareWavePeriod = SquareWavePeriod / <span class="hljs-number">2</span>; </span>
<span class="line"><span class="hljs-keyword">int</span> ToneVolume = <span class="hljs-number">3000</span>;</span>
<span class="line"><span class="hljs-keyword">int</span> SquareWaveCounter = <span class="hljs-number">0</span>;</span></div><span class="line"></span>
<span class="line">GlobalRunning = <span class="hljs-literal">true</span>;</span>
<span class="line"><span class="hljs-keyword">while</span> (GlobalRunning)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// Main game loop</span></span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): DirectSound output test</span></span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">    s16 *SampleOut = (s16 *)Region1;</span>
<span class="line">    DWORD Region1SampleCount = Region1Size / BytesPerSample;</span>
<span class="line">    <span class="hljs-keyword">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line">         SampleIndex &lt; Region1SampleCount;</span>
<span class="line">         ++SampleIndex)</span>
<span class="line">    {</span><div class=" add"><span class="line">        <span class="hljs-keyword">if</span>(!SquareWaveCounter)</span>
<span class="line">        {</span>
<span class="line">            SquareWaveCounter = SquareWavePeriod;</span>
<span class="line">        }</span>
<span class="line">        s16 SampleValue = (SquareWaveCounter &gt; HalfSquareWavePeriod) ? ToneVolume : -ToneVolume;</span></div><div class=" edit"><span class="line">        *SampleOut++ = SampleValue;</span>
<span class="line">        *SampleOut++ = SampleValue;</span></div><div class=" add"><span class="line">        --SquareWaveCounter;</span></div><div class=" C++ "><span class="line"></span>
<span class="line">    }</span>
<span class="line">    SampleOut = (s16 *)Region2;</span>
<span class="line">    DWORD Region2SampleCount = Region2Size / BytesPerSample;</span>
<span class="line">    for (DWORD SampleIndex = 0;</span>
<span class="line">         SampleIndex &lt; Region2SampleCount;</span>
<span class="line">         ++SampleIndex)</span>
<span class="line">    {</span></div><div class=" add"><span class="line">        <span class="hljs-keyword">if</span>(!SquareWaveCounter)</span>
<span class="line">        {</span>
<span class="line">            SquareWaveCounter = SquareWavePeriod;</span>
<span class="line">        }</span>
<span class="line">        s16 SampleValue = (SquareWaveCounter &gt; HalfSquareWavePeriod) ? ToneVolume : -ToneVolume;</span></div><div class=" edit"><span class="line">        *SampleOut++ = SampleValue;</span>
<span class="line">        *SampleOut++ = SampleValue;</span></div><div class=" add"><span class="line">        --SquareWaveCounter;</span></div><div class=" C++ "><span class="line">    }</span>
<span class="line">    // ...</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;8:</b> <file>[win32_handmade.cpp > WinMain]</file> Implementing the Square Wave.</div></center>
<p>




<div class="admonition note"><div class="admonition-title"> Ternary Operator</div>

</p><p>

    You will notice the following line in our implementation:

</p><pre class="listing tilde"><code><span class="line">s16 SampleValue = (SquareWaveCounter &gt; HalfSquareWavePeriod) ? ToneVolume : -ToneVolume;</span></code></pre><p>
    
    Simply put, it's an assignment based on a test. It's a shortand for the following: 

</p><pre class="listing tilde"><code><span class="line">s16 SampleValue;</span>
<span class="line"><span class="hljs-keyword">if</span> (SquareWaveCounter &gt; HalfSquareWavePeriod)</span>
<span class="line">{</span>
<span class="line">    SampleValue = ToneVolume;</span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span></span>
<span class="line">{</span>
<span class="line">    SampleValue = -ToneVolume;</span>
<span class="line">}     </span></code></pre><p>

    The syntax for Ternary Operator is <code>variable = condition ? value_if_true : value_if_false;</code>.</div>

</p>
<a class="target" name="getcursorpositionandregionsize">&nbsp;</a><a class="target" name="fillthebuffer/getcursorpositionandregionsize">&nbsp;</a><a class="target" name="toc3.3">&nbsp;</a><h2>Get Cursor Position and Region Size</h2>
<p>


If you try and build now, you should remain with only have two errors remaining. (Plus remember, we'll also need to unlock the buffer once we are done with it, and start playing!) 

</p><p>

If you recall, we left <code>ByteToLock</code> and <code>BytesToWrite</code> as stubs, now let's think where we can get them from. <code>ByteToLock</code> will tell DirectSound where to start writing from, while <code>BytesToWrite</code> will specify the size of our desired region. 

</p><p>

As we said at the beginning, in order to calculate <code>ByteToLock</code> we need to &ldquo;unwrap&rdquo; our buffer. We will do it by introducing an <em class="underscore">unsigned</em> integer which will keep track of the Samples we write. We will then calculate <code>ByteToLock</code> by multiplying the running sample index by the <code>BytesPerSample</code> and getting the remainder of division by the secondary buffer size. The latter can be easily produced by using the <em class="underscore">modulo operator</em> (<code>%</code>).

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="288" width="592" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 8,0 L 8,64 " style="fill:none;"/>
<path d="M 8,144 L 8,192 " style="fill:none;"/>
<path d="M 312,0 L 312,64 " style="fill:none;"/>
<path d="M 328,144 L 328,192 " style="fill:none;"/>
<path d="M 344,64 L 344,96 " style="fill:none;"/>
<path d="M 376,176 L 376,192 " style="fill:none;"/>
<path d="M 408,64 L 408,96 " style="fill:none;"/>
<path d="M 416,160 L 416,176 " style="fill:none;"/>
<path d="M 472,64 L 472,96 " style="fill:none;"/>
<path d="M 504,176 L 504,192 " style="fill:none;"/>
<path d="M 536,64 L 536,96 " style="fill:none;"/>
<path d="M 8,0 L 312,0 " style="fill:none;"/>
<path d="M 24,32 L 296,32 " style="fill:none;"/>
<path d="M 344,32 L 552,32 " style="fill:none;"/>
<path d="M 8,64 L 312,64 " style="fill:none;"/>
<path d="M 296,80 L 328,80 " style="fill:none;"/>
<path d="M 344,96 L 536,96 " style="fill:none;"/>
<path d="M 8,144 L 328,144 " style="fill:none;"/>
<path d="M 8,192 L 328,192 " style="fill:none;"/>
<path d="M 376,192 L 408,192 " style="fill:none;"/>
<path d="M 424,192 L 504,192 " style="fill:none;"/>
<path d="M 392,224 L 424,224 " style="fill:none;"/>
<path d="M 456,224 L 488,224 " style="fill:none;"/>
<path d="M 472,96 L 504,160 " style="fill:none;"/>
<path d="M 376,160 L 408,96 " style="fill:none;"/>
<path d="M 392,224 C 375.2,224 376,208 376,208 " style="fill:none;"/>
<path d="M 424,224 C 440.8,224 440,240 440,240 " style="fill:none;"/>
<path d="M 456,224 C 439.2,224 440,240 440,240 " style="fill:none;"/>
<path d="M 488,224 C 504.8,224 504,208 504,208 " style="fill:none;"/>
<polygon points="560,32 548,26.4 548,37.6 "  style="stroke:none" transform="rotate(0,552,32 )"/>
<polygon points="424,176 412,170.4 412,181.6 "  style="stroke:none" transform="rotate(90,416,176 )"/>
<polygon points="336,80 324,74.4 324,85.6 "  style="stroke:none" transform="rotate(0,328,80 )"/>
<circle cx="416" cy="192" r="6" class="closeddot"/><g transform="translate(0,0)"><text text-anchor="middle" x="24" y="20">R</text><text text-anchor="middle" x="32" y="20">u</text><text text-anchor="middle" x="40" y="20">n</text><text text-anchor="middle" x="48" y="20">n</text><text text-anchor="middle" x="56" y="20">i</text><text text-anchor="middle" x="64" y="20">n</text><text text-anchor="middle" x="72" y="20">g</text><text text-anchor="middle" x="80" y="20">S</text><text text-anchor="middle" x="88" y="20">a</text><text text-anchor="middle" x="96" y="20">m</text><text text-anchor="middle" x="104" y="20">p</text><text text-anchor="middle" x="112" y="20">l</text><text text-anchor="middle" x="120" y="20">e</text><text text-anchor="middle" x="128" y="20">I</text><text text-anchor="middle" x="136" y="20">n</text><text text-anchor="middle" x="144" y="20">d</text><text text-anchor="middle" x="152" y="20">e</text><text text-anchor="middle" x="160" y="20">x</text><text text-anchor="middle" x="176" y="20">·</text><text text-anchor="middle" x="192" y="20">B</text><text text-anchor="middle" x="200" y="20">y</text><text text-anchor="middle" x="208" y="20">t</text><text text-anchor="middle" x="216" y="20">e</text><text text-anchor="middle" x="224" y="20">s</text><text text-anchor="middle" x="232" y="20">P</text><text text-anchor="middle" x="240" y="20">e</text><text text-anchor="middle" x="248" y="20">r</text><text text-anchor="middle" x="256" y="20">S</text><text text-anchor="middle" x="264" y="20">a</text><text text-anchor="middle" x="272" y="20">m</text><text text-anchor="middle" x="280" y="20">p</text><text text-anchor="middle" x="288" y="20">l</text><text text-anchor="middle" x="296" y="20">e</text><text text-anchor="middle" x="376" y="20">R</text><text text-anchor="middle" x="384" y="20">u</text><text text-anchor="middle" x="392" y="20">n</text><text text-anchor="middle" x="400" y="20">n</text><text text-anchor="middle" x="408" y="20">i</text><text text-anchor="middle" x="416" y="20">n</text><text text-anchor="middle" x="424" y="20">g</text><text text-anchor="middle" x="432" y="20">S</text><text text-anchor="middle" x="440" y="20">a</text><text text-anchor="middle" x="448" y="20">m</text><text text-anchor="middle" x="456" y="20">p</text><text text-anchor="middle" x="464" y="20">l</text><text text-anchor="middle" x="472" y="20">e</text><text text-anchor="middle" x="480" y="20">I</text><text text-anchor="middle" x="488" y="20">n</text><text text-anchor="middle" x="496" y="20">d</text><text text-anchor="middle" x="504" y="20">e</text><text text-anchor="middle" x="512" y="20">x</text><text text-anchor="middle" x="560" y="36">.</text><text text-anchor="middle" x="568" y="36">.</text><text text-anchor="middle" x="576" y="36">.</text><text text-anchor="middle" x="80" y="52">S</text><text text-anchor="middle" x="88" y="52">e</text><text text-anchor="middle" x="96" y="52">c</text><text text-anchor="middle" x="104" y="52">o</text><text text-anchor="middle" x="112" y="52">n</text><text text-anchor="middle" x="120" y="52">d</text><text text-anchor="middle" x="128" y="52">a</text><text text-anchor="middle" x="136" y="52">r</text><text text-anchor="middle" x="144" y="52">y</text><text text-anchor="middle" x="152" y="52">B</text><text text-anchor="middle" x="160" y="52">u</text><text text-anchor="middle" x="168" y="52">f</text><text text-anchor="middle" x="176" y="52">f</text><text text-anchor="middle" x="184" y="52">e</text><text text-anchor="middle" x="192" y="52">r</text><text text-anchor="middle" x="200" y="52">S</text><text text-anchor="middle" x="208" y="52">i</text><text text-anchor="middle" x="216" y="52">z</text><text text-anchor="middle" x="224" y="52">e</text><text text-anchor="middle" x="344" y="52">┊</text><text text-anchor="middle" x="408" y="52">┊</text><text text-anchor="middle" x="472" y="52">┊</text><text text-anchor="middle" x="536" y="52">┊</text><text text-anchor="middle" x="376" y="68">0</text><text text-anchor="middle" x="440" y="68">1</text><text text-anchor="middle" x="504" y="68">2</text><text text-anchor="middle" x="560" y="68">.</text><text text-anchor="middle" x="568" y="68">.</text><text text-anchor="middle" x="576" y="68">.</text><text text-anchor="middle" x="192" y="84">F</text><text text-anchor="middle" x="200" y="84">u</text><text text-anchor="middle" x="208" y="84">l</text><text text-anchor="middle" x="216" y="84">l</text><text text-anchor="middle" x="232" y="84">b</text><text text-anchor="middle" x="240" y="84">u</text><text text-anchor="middle" x="248" y="84">f</text><text text-anchor="middle" x="256" y="84">f</text><text text-anchor="middle" x="264" y="84">e</text><text text-anchor="middle" x="272" y="84">r</text><text text-anchor="middle" x="280" y="84">s</text><text text-anchor="middle" x="176" y="100">(</text><text text-anchor="middle" x="184" y="100">w</text><text text-anchor="middle" x="192" y="100">e</text><text text-anchor="middle" x="208" y="100">d</text><text text-anchor="middle" x="216" y="100">o</text><text text-anchor="middle" x="224" y="100">n</text><text text-anchor="middle" x="232" y="100">'</text><text text-anchor="middle" x="240" y="100">t</text><text text-anchor="middle" x="256" y="100">c</text><text text-anchor="middle" x="264" y="100">a</text><text text-anchor="middle" x="272" y="100">r</text><text text-anchor="middle" x="280" y="100">e</text><text text-anchor="middle" x="288" y="100">)</text><text text-anchor="middle" x="400" y="148">B</text><text text-anchor="middle" x="408" y="148">y</text><text text-anchor="middle" x="416" y="148">t</text><text text-anchor="middle" x="424" y="148">e</text><text text-anchor="middle" x="432" y="148">T</text><text text-anchor="middle" x="440" y="148">o</text><text text-anchor="middle" x="448" y="148">L</text><text text-anchor="middle" x="456" y="148">o</text><text text-anchor="middle" x="464" y="148">c</text><text text-anchor="middle" x="472" y="148">k</text><text text-anchor="middle" x="24" y="164">(</text><text text-anchor="middle" x="32" y="164">R</text><text text-anchor="middle" x="40" y="164">u</text><text text-anchor="middle" x="48" y="164">n</text><text text-anchor="middle" x="56" y="164">n</text><text text-anchor="middle" x="64" y="164">i</text><text text-anchor="middle" x="72" y="164">n</text><text text-anchor="middle" x="80" y="164">g</text><text text-anchor="middle" x="88" y="164">S</text><text text-anchor="middle" x="96" y="164">a</text><text text-anchor="middle" x="104" y="164">m</text><text text-anchor="middle" x="112" y="164">p</text><text text-anchor="middle" x="120" y="164">l</text><text text-anchor="middle" x="128" y="164">e</text><text text-anchor="middle" x="136" y="164">I</text><text text-anchor="middle" x="144" y="164">n</text><text text-anchor="middle" x="152" y="164">d</text><text text-anchor="middle" x="160" y="164">e</text><text text-anchor="middle" x="168" y="164">x</text><text text-anchor="middle" x="184" y="164">·</text><text text-anchor="middle" x="200" y="164">B</text><text text-anchor="middle" x="208" y="164">y</text><text text-anchor="middle" x="216" y="164">t</text><text text-anchor="middle" x="224" y="164">e</text><text text-anchor="middle" x="232" y="164">s</text><text text-anchor="middle" x="240" y="164">P</text><text text-anchor="middle" x="248" y="164">e</text><text text-anchor="middle" x="256" y="164">r</text><text text-anchor="middle" x="264" y="164">S</text><text text-anchor="middle" x="272" y="164">a</text><text text-anchor="middle" x="280" y="164">m</text><text text-anchor="middle" x="288" y="164">p</text><text text-anchor="middle" x="296" y="164">l</text><text text-anchor="middle" x="304" y="164">e</text><text text-anchor="middle" x="312" y="164">)</text><text text-anchor="middle" x="432" y="164">(</text><text text-anchor="middle" x="440" y="164">w</text><text text-anchor="middle" x="448" y="164">e</text><text text-anchor="middle" x="464" y="164">n</text><text text-anchor="middle" x="472" y="164">e</text><text text-anchor="middle" x="480" y="164">e</text><text text-anchor="middle" x="488" y="164">d</text><text text-anchor="middle" x="496" y="164">)</text><text text-anchor="middle" x="144" y="180">%</text><text text-anchor="middle" x="160" y="180">S</text><text text-anchor="middle" x="168" y="180">e</text><text text-anchor="middle" x="176" y="180">c</text><text text-anchor="middle" x="184" y="180">o</text><text text-anchor="middle" x="192" y="180">n</text><text text-anchor="middle" x="200" y="180">d</text><text text-anchor="middle" x="208" y="180">a</text><text text-anchor="middle" x="216" y="180">r</text><text text-anchor="middle" x="224" y="180">y</text><text text-anchor="middle" x="232" y="180">B</text><text text-anchor="middle" x="240" y="180">u</text><text text-anchor="middle" x="248" y="180">f</text><text text-anchor="middle" x="256" y="180">f</text><text text-anchor="middle" x="264" y="180">e</text><text text-anchor="middle" x="272" y="180">r</text><text text-anchor="middle" x="280" y="180">S</text><text text-anchor="middle" x="288" y="180">i</text><text text-anchor="middle" x="296" y="180">z</text><text text-anchor="middle" x="304" y="180">e</text><text text-anchor="middle" x="368" y="260">S</text><text text-anchor="middle" x="376" y="260">e</text><text text-anchor="middle" x="384" y="260">c</text><text text-anchor="middle" x="392" y="260">o</text><text text-anchor="middle" x="400" y="260">n</text><text text-anchor="middle" x="408" y="260">d</text><text text-anchor="middle" x="416" y="260">a</text><text text-anchor="middle" x="424" y="260">r</text><text text-anchor="middle" x="432" y="260">y</text><text text-anchor="middle" x="440" y="260">B</text><text text-anchor="middle" x="448" y="260">u</text><text text-anchor="middle" x="456" y="260">f</text><text text-anchor="middle" x="464" y="260">f</text><text text-anchor="middle" x="472" y="260">e</text><text text-anchor="middle" x="480" y="260">r</text><text text-anchor="middle" x="488" y="260">S</text><text text-anchor="middle" x="496" y="260">i</text><text text-anchor="middle" x="504" y="260">z</text><text text-anchor="middle" x="512" y="260">e</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_bufferindex">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;7:</b> Division vs. Remainder calculation. We multiply by <code>BytesPerSample</code> because we test how many full samples fit (or don't) inside our buffer.</div></center>

</p><p>

<div class="admonition note"><div class="admonition-title"> Integer overflow</div>

</p><p>

    Why Unsigned Integer? It has to do with the number overflow. 

</p><p>

    A 32-bit signed integer goes from \(−2,147,483,648 (−2^{31})\) through \(2,147,483,647 (2^{31} − 1)\), while unsigned 32-bit goes from \(0\) through \(4,294,967,295 (2^{32} − 1)\). That's simply how much 32 binary digits can store. 

</p><p>

    If you go one past the maximum value, the number <em class="underscore">overflows</em>, i.e. restarts from the minimum number. However, while for unsigned integers this means restarting from \(0\), for signed integers it means start from the lowest negative number (\(−2,147,483,648\) for 32-bit integers). We'd really rather not have it here.</div>

</p><p>

As for the <code>BytesToWrite</code>, we don't want to write immediately past the Play cursor, so we need to know whether it's before or after the byte we're locking. 

</p><p>

To do that, we should find the position of the Play cursor, and we can do it by calling another buffer method, <a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/mt708925(v=vs.85)">GetCurrentPosition</a>. <code>GetCurrentPosition</code> returns an <code>HRESULT</code> and takes two pointers. These will be returned by the method as <em class="underscore">the offsets in bytes</em> to the <code>PlayCursor</code> and <code>WriteCursor</code> <em class="underscore">from the beginning of the buffer</em>. Again, we need to test whether or not this method <code>SUCCEEDED</code>. If <code>SUCCEEDED</code>, this means that something bad happened, and we should not try to output sounds to it. Let's <em class="underscore">wrap</em> the whole sound output code block that we've written, and only execute it if we got current position correctly.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">int</span> SamplesPerSecond = <span class="hljs-number">48000</span>;</span>
<span class="line"><span class="hljs-keyword">int</span> BytesPerSample = <span class="hljs-keyword">sizeof</span>(s16) * <span class="hljs-number">2</span>;</span>
<span class="line"><span class="hljs-keyword">int</span> SecondaryBufferSize = <span class="hljs-number">2</span> * SamplesPerSecond * BytesPerSample;</span><div class=" add"><span class="line">u32 RunningSampleIndex = <span class="hljs-number">0</span>;</span></div><span class="line"><span class="hljs-keyword">int</span> ToneHz = <span class="hljs-number">256</span>; </span>
<span class="line"><span class="hljs-keyword">int</span> SquareWavePeriod = SamplesPerSecond / ToneHz; </span>
<span class="line"><span class="hljs-keyword">int</span> ToneVolume = <span class="hljs-number">3000</span>;</span>
<span class="line"><span class="hljs-keyword">int</span> SquareWaveCounter = <span class="hljs-number">0</span>;</span>
<span class="line"><span class="hljs-comment">// ... </span></span>
<span class="line">GlobalRunning = <span class="hljs-literal">true</span>;</span>
<span class="line"><span class="hljs-keyword">while</span> (GlobalRunning)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// Main game loop</span></span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): DirectSound output test</span></span><div class=" add"><span class="line">    DWORD PlayCursor;</span>
<span class="line">    DWORD WriteCursor;</span>
<span class="line">    <span class="hljs-keyword">if</span>(SUCCEEDED(GlobalSecondaryBuffer-&gt;GetCurrentPosition(&amp;PlayCursor, &amp;WriteCursor)))</span>
<span class="line">    {</span></div><div class=" edit"><span class="line">        DWORD ByteToLock = RunningSampleIndex * BytesPerSample % SecondaryBufferSize;</span></div><span class="line">        DWORD BytesToWrite = ;</span>
<span class="line"></span>
<span class="line">        VOID *Region1;</span>
<span class="line">        DWORD Region1Size;</span>
<span class="line">        VOID *Region2;</span>
<span class="line">        DWORD Region2Size;</span>
<span class="line">        <span class="hljs-keyword">if</span>(SUCCEEDED(GlobalSecondaryBuffer-&gt;Lock(...)))</span>
<span class="line">        {</span>
<span class="line">           <span class="hljs-comment">// ... </span></span>
<span class="line">           </span>
<span class="line">    </span>
<span class="line">        }</span><div class=" add"><span class="line">    }</span></div><span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;9:</b> <file>[win32_handmade.cpp > WinMain]</file> Getting <code>PlayCursor</code> position and calculating <code>ByteToLock</code>. As we said previously, we won't really need the <code>WriteCursor</code> even if it's given to us here for free.</div></center>
<p>


If you recall <a href="#figure_regions">Figure&nbsp;4</a>, we need to account for two scenarios: if the <code>PlayCursor</code> is after <code>ByteToLock</code> (requested size will fit in the buffer), and if it's before (we'll need to add second region at the beginning). What we don't know is our &ldquo;desired size&rdquo;, and that's what <code>BytesToWrite</code> will represent.

</p><p>

Since both the <code>PlayCursor</code> and <code>ByteToLock</code> are expressed in <em class="underscore">bytes</em>, calculation of the bytes to write will be pretty straightforward. 

</p><pre class="listing tilde"><code><span class="line">DWORD ByteToLock = RunningSampleIndex * BytesPerSample % SecondaryBufferSize;</span><div class=" edit"><span class="line">DWORD BytesToWrite;</span></div><div class=" add"><span class="line"><span class="hljs-keyword">if</span>(ByteToLock &gt; PlayCursor)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// Play cursor is behind</span></span>
<span class="line">    BytesToWrite = SecondaryBufferSize - ByteToLock; <span class="hljs-comment">// region 1</span></span>
<span class="line">    BytesToWrite += PlayCursor;                      <span class="hljs-comment">// region 2</span></span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span></span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// Play cursor is in front</span></span>
<span class="line">    BytesToWrite = PlayCursor - ByteToLock;          <span class="hljs-comment">// region 1</span></span>
<span class="line">}</span></div><div class=" C++ "><span class="line"></span>
<span class="line">VOID *Region1;</span>
<span class="line">DWORD Region1Size;</span>
<span class="line">VOID *Region2;</span>
<span class="line">DWORD Region2Size;</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;10:</b> <file>[win32_handmade.cpp > WinMain]</file> Calculating <code>BytesToWrite</code>. You could use ternary operator as well here!</div></center>

<a class="target" name="simplifysquarewave">&nbsp;</a><a class="target" name="fillthebuffer/simplifysquarewave">&nbsp;</a><a class="target" name="toc3.4">&nbsp;</a><h2>Simplify Square Wave</h2>
<p>


Now that we have our running buffer index, we can simplify our square wave significantly. We no longer need the <code>SquareWaveCounter</code>, as we can derive the position of the wave from the <code>RunningSampleIndex</code>. 

</p><p>

To do that, instead of comparing <code>SquareWaveCounter</code> with <code>HalfSquareWavePeriod</code>, we will divide our <code>RunningSampleIndex</code> by <code>HalfSquareWavePeriod</code>, and get the remainder of division by <code>2</code> (&ldquo;modulo 2", or <code>% 2</code>). This will give us <code>0</code> or <code>1</code> which we can use to determine whether we're on a positive pitch, or negative one.

</p><p>

In other words, <code>SquareWaveCounter &gt; HalfSquareWavePeriod</code> becomes <code>(RunningSampleIndex / HalfSquareWavePeriod) % 2</code>. We also want to advance our <code>RunningSampleIndex</code> (so, you know, it keeps running), se we can increment it in the same line, as well. 

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="336" width="584" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 208,48 L 208,192 " style="fill:none;"/>
<path d="M 240,80 L 240,192 " style="fill:none;"/>
<path d="M 240,224 L 240,288 " style="fill:none;"/>
<path d="M 272,48 L 272,192 " style="fill:none;"/>
<path d="M 272,224 L 272,288 " style="fill:none;"/>
<path d="M 304,80 L 304,192 " style="fill:none;"/>
<path d="M 304,224 L 304,288 " style="fill:none;"/>
<path d="M 336,48 L 336,192 " style="fill:none;"/>
<path d="M 336,224 L 336,288 " style="fill:none;"/>
<path d="M 368,80 L 368,192 " style="fill:none;"/>
<path d="M 368,224 L 368,288 " style="fill:none;"/>
<path d="M 400,48 L 400,192 " style="fill:none;"/>
<path d="M 400,224 L 400,288 " style="fill:none;"/>
<path d="M 432,80 L 432,192 " style="fill:none;"/>
<path d="M 432,224 L 432,288 " style="fill:none;"/>
<path d="M 464,48 L 464,192 " style="fill:none;"/>
<path d="M 464,224 L 464,288 " style="fill:none;"/>
<path d="M 496,80 L 496,192 " style="fill:none;"/>
<path d="M 496,224 L 496,288 " style="fill:none;"/>
<path d="M 528,48 L 528,192 " style="fill:none;"/>
<path d="M 528,224 L 528,288 " style="fill:none;"/>
<path d="M 160,16 L 192,16 " style="fill:none;"/>
<path d="M 208,16 L 544,16 " style="fill:none;"/>
<path d="M 8,32 L 144,32 " style="fill:none;"/>
<path d="M 208,80 L 528,80 " style="fill:none;"/>
<path d="M 208,144 L 528,144 " style="fill:none;"/>
<path d="M 104,224 L 184,224 " style="fill:none;"/>
<path d="M 240,224 L 272,224 " style="fill:none;"/>
<path d="M 304,224 L 336,224 " style="fill:none;"/>
<path d="M 368,224 L 400,224 " style="fill:none;"/>
<path d="M 432,224 L 464,224 " style="fill:none;"/>
<path d="M 496,224 L 528,224 " style="fill:none;"/>
<path d="M 104,288 L 184,288 " style="fill:none;"/>
<path d="M 208,288 L 240,288 " style="fill:none;"/>
<path d="M 272,288 L 304,288 " style="fill:none;"/>
<path d="M 336,288 L 368,288 " style="fill:none;"/>
<path d="M 400,288 L 432,288 " style="fill:none;"/>
<path d="M 464,288 L 496,288 " style="fill:none;"/>
<path d="M 528,288 L 552,288 " style="fill:none;"/>
<polygon points="552,16 540,10.4 540,21.6 "  style="stroke:none" transform="rotate(0,544,16 )"/>
<polygon points="200,16 188,10.4 188,21.6 "  style="stroke:none" transform="rotate(0,192,16 )"/>
<polygon points="192,288 180,282.4 180,293.6 "  style="stroke:none" transform="rotate(0,184,288 )"/>
<polygon points="192,224 180,218.4 180,229.6 "  style="stroke:none" transform="rotate(0,184,224 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="8" y="20">R</text><text text-anchor="middle" x="16" y="20">u</text><text text-anchor="middle" x="24" y="20">n</text><text text-anchor="middle" x="32" y="20">n</text><text text-anchor="middle" x="40" y="20">i</text><text text-anchor="middle" x="48" y="20">n</text><text text-anchor="middle" x="56" y="20">g</text><text text-anchor="middle" x="64" y="20">S</text><text text-anchor="middle" x="72" y="20">a</text><text text-anchor="middle" x="80" y="20">m</text><text text-anchor="middle" x="88" y="20">p</text><text text-anchor="middle" x="96" y="20">l</text><text text-anchor="middle" x="104" y="20">e</text><text text-anchor="middle" x="112" y="20">I</text><text text-anchor="middle" x="120" y="20">n</text><text text-anchor="middle" x="128" y="20">d</text><text text-anchor="middle" x="136" y="20">e</text><text text-anchor="middle" x="144" y="20">x</text><text text-anchor="middle" x="552" y="20">.</text><text text-anchor="middle" x="560" y="20">.</text><text text-anchor="middle" x="568" y="20">.</text><text text-anchor="middle" x="208" y="36">┊</text><text text-anchor="middle" x="272" y="36">┊</text><text text-anchor="middle" x="336" y="36">┊</text><text text-anchor="middle" x="400" y="36">┊</text><text text-anchor="middle" x="464" y="36">┊</text><text text-anchor="middle" x="528" y="36">┊</text><text text-anchor="middle" x="16" y="52">S</text><text text-anchor="middle" x="24" y="52">q</text><text text-anchor="middle" x="32" y="52">u</text><text text-anchor="middle" x="40" y="52">a</text><text text-anchor="middle" x="48" y="52">r</text><text text-anchor="middle" x="56" y="52">e</text><text text-anchor="middle" x="64" y="52">W</text><text text-anchor="middle" x="72" y="52">a</text><text text-anchor="middle" x="80" y="52">v</text><text text-anchor="middle" x="88" y="52">e</text><text text-anchor="middle" x="96" y="52">P</text><text text-anchor="middle" x="104" y="52">e</text><text text-anchor="middle" x="112" y="52">r</text><text text-anchor="middle" x="120" y="52">i</text><text text-anchor="middle" x="128" y="52">o</text><text text-anchor="middle" x="136" y="52">d</text><text text-anchor="middle" x="240" y="52">0</text><text text-anchor="middle" x="304" y="52">1</text><text text-anchor="middle" x="368" y="52">2</text><text text-anchor="middle" x="432" y="52">3</text><text text-anchor="middle" x="496" y="52">4</text><text text-anchor="middle" x="552" y="52">.</text><text text-anchor="middle" x="560" y="52">.</text><text text-anchor="middle" x="568" y="52">.</text><text text-anchor="middle" x="8" y="116">H</text><text text-anchor="middle" x="16" y="116">a</text><text text-anchor="middle" x="24" y="116">l</text><text text-anchor="middle" x="32" y="116">f</text><text text-anchor="middle" x="40" y="116">S</text><text text-anchor="middle" x="48" y="116">q</text><text text-anchor="middle" x="56" y="116">u</text><text text-anchor="middle" x="64" y="116">a</text><text text-anchor="middle" x="72" y="116">r</text><text text-anchor="middle" x="80" y="116">e</text><text text-anchor="middle" x="88" y="116">W</text><text text-anchor="middle" x="96" y="116">a</text><text text-anchor="middle" x="104" y="116">v</text><text text-anchor="middle" x="112" y="116">e</text><text text-anchor="middle" x="120" y="116">P</text><text text-anchor="middle" x="128" y="116">e</text><text text-anchor="middle" x="136" y="116">r</text><text text-anchor="middle" x="144" y="116">i</text><text text-anchor="middle" x="152" y="116">o</text><text text-anchor="middle" x="160" y="116">d</text><text text-anchor="middle" x="224" y="116">0</text><text text-anchor="middle" x="256" y="116">1</text><text text-anchor="middle" x="288" y="116">2</text><text text-anchor="middle" x="320" y="116">3</text><text text-anchor="middle" x="352" y="116">4</text><text text-anchor="middle" x="384" y="116">5</text><text text-anchor="middle" x="416" y="116">6</text><text text-anchor="middle" x="448" y="116">7</text><text text-anchor="middle" x="480" y="116">8</text><text text-anchor="middle" x="512" y="116">9</text><text text-anchor="middle" x="552" y="116">.</text><text text-anchor="middle" x="560" y="116">.</text><text text-anchor="middle" x="568" y="116">.</text><text text-anchor="middle" x="8" y="180">H</text><text text-anchor="middle" x="16" y="180">a</text><text text-anchor="middle" x="24" y="180">l</text><text text-anchor="middle" x="32" y="180">f</text><text text-anchor="middle" x="40" y="180">S</text><text text-anchor="middle" x="48" y="180">q</text><text text-anchor="middle" x="56" y="180">u</text><text text-anchor="middle" x="64" y="180">a</text><text text-anchor="middle" x="72" y="180">r</text><text text-anchor="middle" x="80" y="180">e</text><text text-anchor="middle" x="88" y="180">W</text><text text-anchor="middle" x="96" y="180">a</text><text text-anchor="middle" x="104" y="180">v</text><text text-anchor="middle" x="112" y="180">e</text><text text-anchor="middle" x="120" y="180">P</text><text text-anchor="middle" x="128" y="180">e</text><text text-anchor="middle" x="136" y="180">r</text><text text-anchor="middle" x="144" y="180">i</text><text text-anchor="middle" x="152" y="180">o</text><text text-anchor="middle" x="160" y="180">d</text><text text-anchor="middle" x="176" y="180">%</text><text text-anchor="middle" x="192" y="180">2</text><text text-anchor="middle" x="224" y="180">0</text><text text-anchor="middle" x="256" y="180">1</text><text text-anchor="middle" x="288" y="180">0</text><text text-anchor="middle" x="320" y="180">1</text><text text-anchor="middle" x="352" y="180">0</text><text text-anchor="middle" x="384" y="180">1</text><text text-anchor="middle" x="416" y="180">0</text><text text-anchor="middle" x="448" y="180">1</text><text text-anchor="middle" x="480" y="180">0</text><text text-anchor="middle" x="512" y="180">1</text><text text-anchor="middle" x="552" y="180">.</text><text text-anchor="middle" x="560" y="180">.</text><text text-anchor="middle" x="568" y="180">.</text><text text-anchor="middle" x="208" y="212">┊</text><text text-anchor="middle" x="240" y="212">┊</text><text text-anchor="middle" x="272" y="212">┊</text><text text-anchor="middle" x="304" y="212">┊</text><text text-anchor="middle" x="336" y="212">┊</text><text text-anchor="middle" x="368" y="212">┊</text><text text-anchor="middle" x="400" y="212">┊</text><text text-anchor="middle" x="432" y="212">┊</text><text text-anchor="middle" x="464" y="212">┊</text><text text-anchor="middle" x="496" y="212">┊</text><text text-anchor="middle" x="528" y="212">┊</text><text text-anchor="middle" x="16" y="228">T</text><text text-anchor="middle" x="24" y="228">o</text><text text-anchor="middle" x="32" y="228">n</text><text text-anchor="middle" x="40" y="228">e</text><text text-anchor="middle" x="48" y="228">V</text><text text-anchor="middle" x="56" y="228">o</text><text text-anchor="middle" x="64" y="228">l</text><text text-anchor="middle" x="72" y="228">u</text><text text-anchor="middle" x="80" y="228">m</text><text text-anchor="middle" x="88" y="228">e</text><text text-anchor="middle" x="208" y="228">┊</text><text text-anchor="middle" x="208" y="244">┊</text><text text-anchor="middle" x="176" y="260">0</text><text text-anchor="middle" x="192" y="260">-</text><text text-anchor="middle" x="208" y="260">┊</text><text text-anchor="middle" x="224" y="260">-</text><text text-anchor="middle" x="256" y="260">-</text><text text-anchor="middle" x="288" y="260">-</text><text text-anchor="middle" x="320" y="260">-</text><text text-anchor="middle" x="352" y="260">-</text><text text-anchor="middle" x="384" y="260">-</text><text text-anchor="middle" x="416" y="260">-</text><text text-anchor="middle" x="448" y="260">-</text><text text-anchor="middle" x="480" y="260">-</text><text text-anchor="middle" x="512" y="260">-</text><text text-anchor="middle" x="544" y="260">-</text><text text-anchor="middle" x="208" y="276">┊</text><text text-anchor="middle" x="8" y="292">-</text><text text-anchor="middle" x="16" y="292">T</text><text text-anchor="middle" x="24" y="292">o</text><text text-anchor="middle" x="32" y="292">n</text><text text-anchor="middle" x="40" y="292">e</text><text text-anchor="middle" x="48" y="292">V</text><text text-anchor="middle" x="56" y="292">o</text><text text-anchor="middle" x="64" y="292">l</text><text text-anchor="middle" x="72" y="292">u</text><text text-anchor="middle" x="80" y="292">m</text><text text-anchor="middle" x="88" y="292">e</text><text text-anchor="middle" x="560" y="292">.</text><text text-anchor="middle" x="568" y="292">.</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_runningindex">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;8:</b> Calculating period based on the running sample index. Note that the <code>RunningSampleIndex</code> is the only variable that changes here, the rest are constants.</div></center>

</p><pre class="listing tilde"><code><div class=" delete"><span class="line"><span class="hljs-keyword">int</span> SquareWaveCounter = <span class="hljs-number">0</span>;</span></div><span class="line"><span class="hljs-comment">// ... </span></span>
<span class="line">s16 *SampleOut = (s16 *)Region1;</span>
<span class="line">DWORD Region1SampleCount = Region1Size / BytesPerSample;</span>
<span class="line"><span class="hljs-keyword">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line">        SampleIndex &lt; Region1SampleCount;</span>
<span class="line">        ++SampleIndex)</span>
<span class="line">{</span><div class=" delete"><span class="line">        <span class="hljs-keyword">if</span>(!SquareWaveCounter)</span>
<span class="line">        {</span>
<span class="line">            SquareWaveCounter = SquareWavePeriod;</span>
<span class="line">        }</span></div><div class=" edit"><span class="line">        s16 SampleValue = ((RunningSampleIndex++ / HalfSquareWavePeriod) % <span class="hljs-number">2</span>) ? ToneVolume : -ToneVolume;</span></div><span class="line">        *SampleOut++ = SampleValue;</span>
<span class="line">        *SampleOut++ = SampleValue;</span><div class=" delete"><span class="line">        --SquareWaveCounter;</span></div><div class=" C++ "><span class="line">}</span>
<span class="line">SampleOut = (s16 *)Region2;</span>
<span class="line">DWORD Region2SampleCount = Region2Size / BytesPerSample;</span>
<span class="line">for (DWORD SampleIndex = 0;</span>
<span class="line">        SampleIndex &lt; Region2SampleCount;</span>
<span class="line">        ++SampleIndex)</span>
<span class="line">{</span></div><div class=" delete"><span class="line">        <span class="hljs-keyword">if</span>(!SquareWaveCounter)</span>
<span class="line">        {</span>
<span class="line">            SquareWaveCounter = SquareWavePeriod;</span>
<span class="line">        }</span></div><div class=" edit"><span class="line">        s16 SampleValue = ((RunningSampleIndex++ / HalfSquareWavePeriod) % <span class="hljs-number">2</span>) ? ToneVolume : -ToneVolume;</span></div><span class="line">        *SampleOut++ = SampleValue;</span>
<span class="line">        *SampleOut++ = SampleValue;</span><div class=" delete"><span class="line">        --SquareWaveCounter;</span></div><div class=" C++ "><span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;11:</b> <file>[win32_handmade.cpp > WinMain]</file> Simplifying the Square Wave.</div></center>

<a class="target" name="lockandstartplaying">&nbsp;</a><a class="target" name="fillthebuffer/lockandstartplaying">&nbsp;</a><a class="target" name="toc3.5">&nbsp;</a><h2>Lock and Start Playing</h2>
<p>


We need to clean up a couple of things before we're ready to reproduce our beautiful square wave. First, we need to unlock the buffer so that Windows can read again from it. The method we're after is simply <a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/mt708941(v=vs.85)">Unlock</a>, and we pass to it the same <code>Region</code>s and <code>RegionSize</code>s that we received from <code>Lock</code>:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">if</span>(SUCCEEDED(GlobalSecondaryBuffer-&gt;Lock(ByteToLock, BytesToWrite,</span>
<span class="line">                                         &amp;Region1, &amp;Region1Size,</span>
<span class="line">                                         &amp;Region2, &amp;Region2Size,</span>
<span class="line">                                         <span class="hljs-number">0</span>)))</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">    <span class="hljs-comment">// Write all our samples</span></span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">    </span><div class=" add"><span class="line">    GlobalSecondaryBuffer-&gt;Unlock(Region1, Region1Size, Region2, Region2Size);</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;12:</b> <file>[win32_handmade.cpp > WinMain]</file> Unlocking the buffer.</div></center>
<p>


We also need to start playing. You do it by calling <a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/mt708933(v=vs.85)">Play</a> method of the buffer. Usually you want to start playing only after initially filling out the buffer; for the sake of our test, for now we'll do it immediately after we initialized the buffer.

</p><p>

As parameters for <code>Play</code>, we really don't have many options. As you can see from the <a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/mt708933(v=vs.85)">documentation</a>, both the first and second parameter can only be <code>0</code>, while <code>dwFlags</code> allows us to seet up looping of the buffer. That's what we're interested in, so we'll pass the <code>DSBPLAY_LOOPING</code> flag along: 

</p><pre class="listing tilde"><code><span class="line">Win32InitDSound(Window, SamplesPerSecond, SamplesPerSecond * <span class="hljs-number">2</span> * BytesPerSample);</span><div class=" add"><span class="line">GlobalSecondaryBuffer-&gt;Play(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, DSBPLAY_LOOPING);</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;13:</b> <file>[win32_handmade.cpp > WinMain]</file> Start playing.</div></center>
<p>


Compile, set your speakers to a low volume and listen to the beauty of your work! If you've done everything right, you should hear a continuous, uninterrupted sound, without any noticeable &ldquo;clicking&rdquo;.

</p><p>

<center><div class="image" style=""><audio class="markdeep" controls ><source src="https://upload.wikimedia.org/wikipedia/commons/9/92/Square_wave_1000.ogg"></audio><center><span class="imagecaption">1000Hz Square Wave example from <a href="https://en.wikipedia.org/wiki/File:Square_wave_1000.ogg">Wikipedia</a>. If you change your <code>ToneHz</code> to the same frequency, you should hear the same sound.</span></center></div></center>

</p>
<a class="target" name="recap">&nbsp;</a><a class="target" name="recap">&nbsp;</a><a class="target" name="toc4">&nbsp;</a><h1>Recap</h1>
<p>


Today, we've written most of DirectSound-related code. It will largely remain the same, ready to output whatever samples we'll pass to it.

</p><p>

The code we've written today will definitely contain some bugs. Compressing a &ldquo;flat&rdquo; linear buffer into a circular one is always somewhat complex. Next time, we are going to challenge it more, by implementing some more advanced wave types. We will also look at the buffer and verify that it looks like it should.

</p><p>

We hope that you enjoyed following along in the beautiful world of circular buffer coding. If you struggle with some parts, take regular breaks and return to the code when you are ready to rumble!

</p>
<a class="target" name="exercises">&nbsp;</a><a class="target" name="exercises">&nbsp;</a><a class="target" name="toc5">&nbsp;</a><h1>Exercises</h1>

<a class="target" name="practiceraiionsoundbuffer">&nbsp;</a><a class="target" name="exercises/practiceraiionsoundbuffer">&nbsp;</a><a class="target" name="toc5.1">&nbsp;</a><h2>Practice RAII on Sound Buffer</h2>
<p>


If you remember, &ldquo;Resource Acquisition Is Initialization&rdquo; is a practice to acquire and release resources in one command. C++ allows to do it via Constructors and Destructors. We've discussed RAII in <a href="day4.html">day 4</a>. 

</p><p>

Practice your RAII by dynamically locking and unlocking the sound buffer! 

</p>
<a class="target" name="extractyoursoundfunctions">&nbsp;</a><a class="target" name="exercises/extractyoursoundfunctions">&nbsp;</a><a class="target" name="toc5.2">&nbsp;</a><h2>Extract Your Sound Functions</h2>
<p>


You might have noticed that we're writing our sound code directly in <code>WinMain</code>. Try <em class="underscore">extracting</em> this code to a separate function, say <code>Win32UpdateDSound</code>, and passing the constants we defined above as its parameters.

</p>
<a class="target" name="programmingnotions">&nbsp;</a><a class="target" name="programmingnotions">&nbsp;</a><a class="target" name="toc6">&nbsp;</a><h1>Programming Notions</h1>

<a class="target" name="introtodigitalsoundtheory">&nbsp;</a><a class="target" name="programmingnotions/introtodigitalsoundtheory">&nbsp;</a><a class="target" name="toc6.1">&nbsp;</a><h2>Intro to Digital Sound Theory</h2>
<p>


Let's quickly go over what we need for our sound to be played. <a href="https://en.wikipedia.org/wiki/Sound">Sound</a> is produced by receiving a vibration of an &ldquo;acoustic wave&rdquo;. In our case, such a wave is produced by speakers or headphones. As a wave, it has a specific <em class="underscore">frequency</em> (i.e. how many times does it repeats in a second), which determines a sound's <em class="underscore">pitch</em>, and <em class="underscore">amplitude</em>, which determines its intensity and therefore loudness (volume).

</p><p>

The frequency is measured in Hertz (㎐), i.e. cycles per second. A cycle is how long it takes for a wave to go from a position (e.g. a peak) to the next iteration of the same position (next peak).

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="192" width="480" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 72,128 L 72,144 " style="fill:none;"/>
<path d="M 232,128 L 232,144 " style="fill:none;"/>
<path d="M 56,16 L 88,16 " style="fill:none;"/>
<path d="M 216,16 L 248,16 " style="fill:none;"/>
<path d="M 376,16 L 408,16 " style="fill:none;"/>
<path d="M 8,64 L 24,64 " style="fill:none;"/>
<path d="M 40,64 L 64,64 " style="fill:none;"/>
<path d="M 80,64 L 104,64 " style="fill:none;"/>
<path d="M 120,64 L 184,64 " style="fill:none;"/>
<path d="M 200,64 L 224,64 " style="fill:none;"/>
<path d="M 240,64 L 264,64 " style="fill:none;"/>
<path d="M 280,64 L 344,64 " style="fill:none;"/>
<path d="M 360,64 L 424,64 " style="fill:none;"/>
<path d="M 440,64 L 456,64 " style="fill:none;"/>
<path d="M 136,112 L 168,112 " style="fill:none;"/>
<path d="M 296,112 L 328,112 " style="fill:none;"/>
<path d="M 72,144 L 232,144 " style="fill:none;"/>
<path d="M 88,16 L 136,112 " style="fill:none;"/>
<path d="M 248,16 L 296,112 " style="fill:none;"/>
<path d="M 408,16 L 432,64 " style="fill:none;"/>
<path d="M 32,64 L 56,16 " style="fill:none;"/>
<path d="M 168,112 L 216,16 " style="fill:none;"/>
<path d="M 328,112 L 376,16 " style="fill:none;"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="72" y="36">┊</text><text text-anchor="middle" x="232" y="36">┊</text><text text-anchor="middle" x="72" y="52">┊</text><text text-anchor="middle" x="232" y="52">┊</text><text text-anchor="middle" x="72" y="68">┊</text><text text-anchor="middle" x="232" y="68">┊</text><text text-anchor="middle" x="72" y="84">┊</text><text text-anchor="middle" x="232" y="84">┊</text><text text-anchor="middle" x="72" y="100">┊</text><text text-anchor="middle" x="232" y="100">┊</text><text text-anchor="middle" x="72" y="116">┊</text><text text-anchor="middle" x="232" y="116">┊</text><text text-anchor="middle" x="128" y="164">1</text><text text-anchor="middle" x="144" y="164">c</text><text text-anchor="middle" x="152" y="164">y</text><text text-anchor="middle" x="160" y="164">c</text><text text-anchor="middle" x="168" y="164">l</text><text text-anchor="middle" x="176" y="164">e</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;9:</b> Wave cycles.</div></center>

</p><p>

In other words, a wave oscillating between maximum and minimum values at a certain amplitude and frequency produces sound. The frequency should be within a specific range (~20Hz to ~20kHz) and propagate through suitable media (e.g. air) to be perceived by the human ear.

</p><p>

We write our sound by &ldquo;sampling&rdquo; it many many many times (48000 times per second as of right now), and telling the DirectSound what the value of our wave at that sample point is. These samples are then used to reconstruct the actual waves as the sound output device emits vibrations corresponding to the value of each sample.

</p><p>

<center><div class="image" style=""><a href="../media/day8/pcm.svg" target="_blank"><img class="markdeep" src="../media/day8/pcm.svg" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;10:</b> Sound wave sampling, also known as &ldquo;Pulse Code Modulation&rdquo;. The vertical lines correspond to individual samples. (<a href="https://en.wikipedia.org/wiki/File:Pcm.svg">Wikimedia</a>)</span></center></div></center>

</p><p>

<em class="underscore">(Back to subsection  <a href="#toc6.1">6.1</a>)</em>

</p>
<a class="target" name="compression-orientedprogramming">&nbsp;</a><a class="target" name="programmingnotions/compression-orientedprogramming">&nbsp;</a><a class="target" name="toc6.2">&nbsp;</a><h2>Compression-Oriented Programming</h2>
<p>


You will notice that today we wrote something that we though was good, then went in and it turned out we could write it better. This is what we call &ldquo;compression-oriented programming&rdquo;. When you write down some code which is somewhat complicated and finnicky, you first keep writing whatever the simpler thing is. You then start pulling things out that are common.

</p><p>

Eventually, a pattern emerges, and you start seeing where this code even go eventually! For instance, our two region loops are the same, so that can probably be boiled down. 

</p><p>

This is the best way to end up with nice working code that does exactly what you want it to do. 

</p>
<a class="target" name="navigation">&nbsp;</a><a class="target" name="navigation">&nbsp;</a><a class="target" name="toc7">&nbsp;</a><h1>Navigation</h1>
<p>


Previous: <a href="day7.html">Day 7. Initializing DirectSound</a>

</p><p>

Up Next: <a href="day9.html">Day 9. Variable-Pitch Sine Wave Output</a>

</p><p>

<a href="../index.md.html">Back to Index</a>

</p>
<div class="nonumberh1">Glossary</div>
<p>


<ul>
<li class="asterisk">Modulo Operator
</li>
<li class="asterisk">Sound Frequency
</li>
<li class="asterisk">Sound
</li>
<li class="asterisk">Ternary Operator
</li>
<li class="asterisk">Wavelength</li></ul>

</p>
<div class="nonumberh1">References</div>

<div class="nonumberh1">Articles</div>
<p>


<a href="https://en.wikipedia.org/wiki/Sound">Sound</a>

</p><p>

<a href="https://en.wikipedia.org/wiki/Square_wave">Square Wave</a>

</p>
<div class="nonumberh1">MSDN</div>
<p>


<a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/mt708925(v=vs.85)">GetCurrentPosition</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/mt708932(v=vs.85)">Lock</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/mt708933(v=vs.85)">Play</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/mt708941(v=vs.85)">Unlock</a>

</p><p>

<style class="fallback">
  body {
    visibility: hidden;
    font-family: sans-serif;
  }
</style>

</p><p>

<script>markdeepOptions = { tocStyle: 'long' }; window.alreadyProcessedMarkdeep || (document.body.style.visibility = 'visible');</script>

</p><p>

</p></span><div id="mdContextMenu" style="visibility:hidden"></div><div class="markdeepFooter"><i>formatted by <a href="https://casual-effects.com/markdeep" style="color:#999">Markdeep&nbsp;1.10&nbsp;&nbsp;</a></i><div style="display:inline-block;font-size:13px;font-family:'Times New Roman',serif;vertical-align:middle;transform:translate(-3px,-1px)rotate(135deg);">&#x2712;</div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>