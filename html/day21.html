<meta charset="UTF-8">
<meta http-equiv="content-type" content="text/html;charset=UTF-8">
<meta name="viewport" content="width=600, initial-scale=1">
<link rel="stylesheet" href="../css/html-style.css">
<link rel="stylesheet" href="../css/style.css">

<span class="md"><p><title>Day 21. Loading Game Code Dynamically</title><div class="title"> Day 21. Loading Game Code Dynamically </div>

<div class="afterTitles"></div>
<em class="underscore">Video Length (including Q&A): <a href="https://hero.handmade.network/episode/code/day021/">1h43</a></em> 

</p><p>

Welcome to &ldquo;Handmade Hero Notes&rdquo;, the book where we follow the footsteps of <a href="https://handmadehero.org/">Handmade Hero</a> in making the complete game from scratch, with no external libraries. If you'd like to follow along, preorder the game on <a href="https://handmadehero.org/">handmadehero.org</a>, and you will receive access to the GitHub repository, containing complete source code (tagged day-by-day) as well as a variety of other useful resources.

</p><p>

People often ask: are we going to use a scripting language for Handmade Hero? We definitely won't use an existing one, maybe will eventually develop one. But the correct question is: is it a great idea in first place? 

</p>
<div class="longTOC"><p align="center">
    <span align="right"><a href="day20.html">Day 20</a></span>
    <a href="../index.html"><img src = "../media/logo.png"></a>
    <span align="left"><a href="day22.html">Day 22</a></span>
</p><p><a href="#" class="tocTop">(Top)</a><br/>
<a href="#planfortoday" class="level1"><span class="tocNumber">1&nbsp; </span>Plan For Today</a><br/>
&nbsp;&nbsp;<a href="#planfortoday/aboutscriptinglanguages" class="level2"><span class="tocNumber">1.1&nbsp; </span>About Scripting Languages</a><br/>
&nbsp;&nbsp;<a href="#planfortoday/hotreloading" class="level2"><span class="tocNumber">1.2&nbsp; </span>Hot Reloading</a><br/>
<a href="#changebuild.bat" class="level1"><span class="tocNumber">2&nbsp; </span>Change <code>build.bat</code></a><br/>
&nbsp;&nbsp;<a href="#changebuild.bat/cleanupbuildvariables" class="level2"><span class="tocNumber">2.1&nbsp; </span>Clean Up Build Variables</a><br/>
&nbsp;&nbsp;<a href="#changebuild.bat/requesthandmade.dllcompilation" class="level2"><span class="tocNumber">2.2&nbsp; </span>Request <code>handmade.dll</code> Compilation</a><br/>
&nbsp;&nbsp;<a href="#changebuild.bat/exportfunctions" class="level2"><span class="tocNumber">2.3&nbsp; </span>Export Functions</a><br/>
<a href="#separategamefromplatform" class="level1"><span class="tocNumber">3&nbsp; </span>Separate Game from Platform</a><br/>
&nbsp;&nbsp;<a href="#separategamefromplatform/movesharedtypes" class="level2"><span class="tocNumber">3.1&nbsp; </span>Move Shared Types</a><br/>
&nbsp;&nbsp;<a href="#separategamefromplatform/updateapi" class="level2"><span class="tocNumber">3.2&nbsp; </span>Update API</a><br/>
&nbsp;&nbsp;<a href="#separategamefromplatform/inspectlinkererrors" class="level2"><span class="tocNumber">3.3&nbsp; </span>Inspect Linker Errors</a><br/>
&nbsp;&nbsp;<a href="#separategamefromplatform/loadgamecode" class="level2"><span class="tocNumber">3.4&nbsp; </span>Load Game Code</a><br/>
&nbsp;&nbsp;<a href="#separategamefromplatform/servicestothegame" class="level2"><span class="tocNumber">3.5&nbsp; </span>Services to the Game</a><br/>
&nbsp;&nbsp;<a href="#separategamefromplatform/guardagainstnamemangling" class="level2"><span class="tocNumber">3.6&nbsp; </span>Guard Against Name Mangling</a><br/>
<a href="#dynamicreloading" class="level1"><span class="tocNumber">4&nbsp; </span>Dynamic Reloading</a><br/>
&nbsp;&nbsp;<a href="#dynamicreloading/unloadgamecode" class="level2"><span class="tocNumber">4.1&nbsp; </span>Unload Game Code</a><br/>
&nbsp;&nbsp;<a href="#dynamicreloading/slowdownreloading" class="level2"><span class="tocNumber">4.2&nbsp; </span>Slow Down Reloading</a><br/>
&nbsp;&nbsp;<a href="#dynamicreloading/allowdllrewriting" class="level2"><span class="tocNumber">4.3&nbsp; </span>Allow DLL Rewriting</a><br/>
<a href="#recap" class="level1"><span class="tocNumber">5&nbsp; </span>Recap</a><br/>
<a href="#sidedebugging" class="level1"><span class="tocNumber">6&nbsp; </span>Side Debugging</a><br/>
&nbsp;&nbsp;<a href="#sidedebugging/fixsoundissue" class="level2"><span class="tocNumber">6.1&nbsp; </span>Fix Sound Issue</a><br/>
<a href="#navigation" class="level1"><span class="tocNumber">7&nbsp; </span>Navigation</a><br/>
</p></div><a class="target" name="planfortoday">&nbsp;</a><a class="target" name="planfortoday">&nbsp;</a><a class="target" name="toc1">&nbsp;</a><h1>Plan For Today</h1>

<a class="target" name="aboutscriptinglanguages">&nbsp;</a><a class="target" name="planfortoday/aboutscriptinglanguages">&nbsp;</a><a class="target" name="toc1.1">&nbsp;</a><h2>About Scripting Languages</h2>
<p>


To answer this question, we need to determine why we'd be using a scripting language and whether it covers the downsides. And the downsides, if you look closely, are many:

</p><p>

<ul>
<li class="asterisk">You need to optimize that scripting language and ensure it's performant.
</li>
<li class="asterisk">You need to develop a debugging solution if there isn't one readily available. 
</li>
<li class="asterisk">There might be other tools you potentially need to develop.</li></ul>

</p><p>

If you look at these, it's not really a matter of 'scripting languages are <em class="underscore">bad</em>'. However, it takes a lot of time to get all those things right, so such use should just be evaluated on a case-by-case basis. For Handmade Hero, it's definitely a no-go. 

</p><p>

But maybe we can get all the benefits without having to do all the hard work? When you think of a scripting language, these benefits come to your mind (compared to the programming language the engine is developed on):

</p><p>

<ul>
<li class="asterisk"><strong class="underscore">It's perceived to be easier to write in a scripting language</strong>.</li></ul>

</p><p>

This is a debatable point, really. Instead, it seems to be coming from lousy API practices in the programming languages rather than the scripting ones' strengths. Since we're going to really focus on writing a good API for our game, we should be fine in C.

</p><p>

<ul>
<li class="asterisk"><strong class="underscore">You can edit the script while the game is running</strong>.</li></ul>

</p><p>

Now, this is a great tool to have. When it comes to fine-tuning the game, having our program running while you modify its values can save a lot of time. Otherwise, you need to exit debugging, change the necessary values, recompile, restart the game, jump to whatever encounter you were tuning, realize the edit wasn't perfect, jump back... This indeed can become very old very quickly.

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="768" width="336" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 40,48 L 40,688 " style="fill:none;"/>
<path d="M 80,16 L 80,48 " style="fill:none;"/>
<path d="M 80,96 L 80,144 " style="fill:none;"/>
<path d="M 80,192 L 80,224 " style="fill:none;"/>
<path d="M 80,272 L 80,320 " style="fill:none;"/>
<path d="M 80,368 L 80,400 " style="fill:none;"/>
<path d="M 80,448 L 80,496 " style="fill:none;"/>
<path d="M 80,544 L 80,592 " style="fill:none;"/>
<path d="M 80,640 L 80,672 " style="fill:none;"/>
<path d="M 144,48 L 144,88 " style="fill:none;"/>
<path d="M 144,144 L 144,184 " style="fill:none;"/>
<path d="M 144,224 L 144,264 " style="fill:none;"/>
<path d="M 144,320 L 144,360 " style="fill:none;"/>
<path d="M 144,400 L 144,440 " style="fill:none;"/>
<path d="M 144,496 L 144,536 " style="fill:none;"/>
<path d="M 144,592 L 144,632 " style="fill:none;"/>
<path d="M 144,672 L 144,688 " style="fill:none;"/>
<path d="M 216,16 L 216,48 " style="fill:none;"/>
<path d="M 216,96 L 216,144 " style="fill:none;"/>
<path d="M 216,192 L 216,224 " style="fill:none;"/>
<path d="M 216,272 L 216,320 " style="fill:none;"/>
<path d="M 216,368 L 216,400 " style="fill:none;"/>
<path d="M 216,448 L 216,496 " style="fill:none;"/>
<path d="M 216,544 L 216,592 " style="fill:none;"/>
<path d="M 216,640 L 216,672 " style="fill:none;"/>
<path d="M 80,16 L 216,16 " style="fill:none;"/>
<path d="M 56,32 L 72,32 " style="fill:none;"/>
<path d="M 80,48 L 216,48 " style="fill:none;"/>
<path d="M 80,96 L 216,96 " style="fill:none;"/>
<path d="M 80,144 L 216,144 " style="fill:none;"/>
<path d="M 80,192 L 216,192 " style="fill:none;"/>
<path d="M 80,224 L 216,224 " style="fill:none;"/>
<path d="M 80,272 L 216,272 " style="fill:none;"/>
<path d="M 80,320 L 216,320 " style="fill:none;"/>
<path d="M 80,368 L 216,368 " style="fill:none;"/>
<path d="M 80,400 L 216,400 " style="fill:none;"/>
<path d="M 80,448 L 216,448 " style="fill:none;"/>
<path d="M 80,496 L 216,496 " style="fill:none;"/>
<path d="M 80,544 L 216,544 " style="fill:none;"/>
<path d="M 80,592 L 216,592 " style="fill:none;"/>
<path d="M 80,640 L 216,640 " style="fill:none;"/>
<path d="M 80,672 L 216,672 " style="fill:none;"/>
<path d="M 56,704 L 128,704 " style="fill:none;"/>
<path d="M 56,32 C 39.2,32 40,48 40,48 " style="fill:none;"/>
<path d="M 56,704 C 39.2,704 40,688 40,688 " style="fill:none;"/>
<path d="M 128,704 C 144.8,704 144,688 144,688 " style="fill:none;"/>
<polygon points="152,632 140,626.4 140,637.6 "  style="stroke:none" transform="rotate(90,144,632 )"/>
<polygon points="152,536 140,530.4 140,541.6 "  style="stroke:none" transform="rotate(90,144,536 )"/>
<polygon points="152,440 140,434.4 140,445.6 "  style="stroke:none" transform="rotate(90,144,440 )"/>
<polygon points="152,360 140,354.4 140,365.6 "  style="stroke:none" transform="rotate(90,144,360 )"/>
<polygon points="152,264 140,258.4 140,269.6 "  style="stroke:none" transform="rotate(90,144,264 )"/>
<polygon points="152,184 140,178.4 140,189.6 "  style="stroke:none" transform="rotate(90,144,184 )"/>
<polygon points="152,88 140,82.4 140,93.6 "  style="stroke:none" transform="rotate(90,144,88 )"/>
<polygon points="80,32 68,26.4 68,37.6 "  style="stroke:none" transform="rotate(0,72,32 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="96" y="36">S</text><text text-anchor="middle" x="104" y="36">t</text><text text-anchor="middle" x="112" y="36">a</text><text text-anchor="middle" x="120" y="36">r</text><text text-anchor="middle" x="128" y="36">t</text><text text-anchor="middle" x="144" y="36">t</text><text text-anchor="middle" x="152" y="36">h</text><text text-anchor="middle" x="160" y="36">e</text><text text-anchor="middle" x="176" y="36">g</text><text text-anchor="middle" x="184" y="36">a</text><text text-anchor="middle" x="192" y="36">m</text><text text-anchor="middle" x="200" y="36">e</text><text text-anchor="middle" x="112" y="116">S</text><text text-anchor="middle" x="120" y="116">k</text><text text-anchor="middle" x="128" y="116">i</text><text text-anchor="middle" x="136" y="116">p</text><text text-anchor="middle" x="152" y="116">t</text><text text-anchor="middle" x="160" y="116">o</text><text text-anchor="middle" x="176" y="116">t</text><text text-anchor="middle" x="184" y="116">h</text><text text-anchor="middle" x="192" y="116">e</text><text text-anchor="middle" x="104" y="132">d</text><text text-anchor="middle" x="112" y="132">e</text><text text-anchor="middle" x="120" y="132">s</text><text text-anchor="middle" x="128" y="132">i</text><text text-anchor="middle" x="136" y="132">r</text><text text-anchor="middle" x="144" y="132">e</text><text text-anchor="middle" x="152" y="132">d</text><text text-anchor="middle" x="168" y="132">l</text><text text-anchor="middle" x="176" y="132">e</text><text text-anchor="middle" x="184" y="132">v</text><text text-anchor="middle" x="192" y="132">e</text><text text-anchor="middle" x="200" y="132">l</text><text text-anchor="middle" x="120" y="212">P</text><text text-anchor="middle" x="128" y="212">l</text><text text-anchor="middle" x="136" y="212">a</text><text text-anchor="middle" x="144" y="212">y</text><text text-anchor="middle" x="152" y="212">t</text><text text-anchor="middle" x="160" y="212">e</text><text text-anchor="middle" x="168" y="212">s</text><text text-anchor="middle" x="176" y="212">t</text><text text-anchor="middle" x="104" y="292">F</text><text text-anchor="middle" x="112" y="292">i</text><text text-anchor="middle" x="120" y="292">n</text><text text-anchor="middle" x="128" y="292">d</text><text text-anchor="middle" x="144" y="292">a</text><text text-anchor="middle" x="160" y="292">v</text><text text-anchor="middle" x="168" y="292">a</text><text text-anchor="middle" x="176" y="292">l</text><text text-anchor="middle" x="184" y="292">u</text><text text-anchor="middle" x="192" y="292">e</text><text text-anchor="middle" x="128" y="308">t</text><text text-anchor="middle" x="136" y="308">o</text><text text-anchor="middle" x="152" y="308">f</text><text text-anchor="middle" x="160" y="308">i</text><text text-anchor="middle" x="168" y="308">x</text><text text-anchor="middle" x="96" y="388">S</text><text text-anchor="middle" x="104" y="388">t</text><text text-anchor="middle" x="112" y="388">o</text><text text-anchor="middle" x="120" y="388">p</text><text text-anchor="middle" x="136" y="388">t</text><text text-anchor="middle" x="144" y="388">h</text><text text-anchor="middle" x="152" y="388">e</text><text text-anchor="middle" x="168" y="388">g</text><text text-anchor="middle" x="176" y="388">a</text><text text-anchor="middle" x="184" y="388">m</text><text text-anchor="middle" x="192" y="388">e</text><text text-anchor="middle" x="112" y="468">G</text><text text-anchor="middle" x="120" y="468">o</text><text text-anchor="middle" x="136" y="468">t</text><text text-anchor="middle" x="144" y="468">o</text><text text-anchor="middle" x="160" y="468">t</text><text text-anchor="middle" x="168" y="468">h</text><text text-anchor="middle" x="176" y="468">e</text><text text-anchor="middle" x="112" y="484">g</text><text text-anchor="middle" x="120" y="484">a</text><text text-anchor="middle" x="128" y="484">m</text><text text-anchor="middle" x="136" y="484">e</text><text text-anchor="middle" x="152" y="484">c</text><text text-anchor="middle" x="160" y="484">o</text><text text-anchor="middle" x="168" y="484">d</text><text text-anchor="middle" x="176" y="484">e</text><text text-anchor="middle" x="112" y="564">F</text><text text-anchor="middle" x="120" y="564">i</text><text text-anchor="middle" x="128" y="564">x</text><text text-anchor="middle" x="144" y="564">d</text><text text-anchor="middle" x="152" y="564">e</text><text text-anchor="middle" x="160" y="564">s</text><text text-anchor="middle" x="168" y="564">i</text><text text-anchor="middle" x="176" y="564">r</text><text text-anchor="middle" x="184" y="564">e</text><text text-anchor="middle" x="192" y="564">d</text><text text-anchor="middle" x="136" y="580">v</text><text text-anchor="middle" x="144" y="580">a</text><text text-anchor="middle" x="152" y="580">l</text><text text-anchor="middle" x="160" y="580">u</text><text text-anchor="middle" x="168" y="580">e</text><text text-anchor="middle" x="112" y="660">R</text><text text-anchor="middle" x="120" y="660">e</text><text text-anchor="middle" x="128" y="660">c</text><text text-anchor="middle" x="136" y="660">o</text><text text-anchor="middle" x="144" y="660">m</text><text text-anchor="middle" x="152" y="660">p</text><text text-anchor="middle" x="160" y="660">i</text><text text-anchor="middle" x="168" y="660">l</text><text text-anchor="middle" x="176" y="660">e</text><text text-anchor="middle" x="24" y="724">r</text><text text-anchor="middle" x="32" y="724">e</text><text text-anchor="middle" x="40" y="724">p</text><text text-anchor="middle" x="48" y="724">e</text><text text-anchor="middle" x="56" y="724">a</text><text text-anchor="middle" x="64" y="724">t</text><text text-anchor="middle" x="80" y="724">u</text><text text-anchor="middle" x="88" y="724">n</text><text text-anchor="middle" x="96" y="724">t</text><text text-anchor="middle" x="104" y="724">i</text><text text-anchor="middle" x="112" y="724">l</text><text text-anchor="middle" x="128" y="724">h</text><text text-anchor="middle" x="136" y="724">a</text><text text-anchor="middle" x="144" y="724">p</text><text text-anchor="middle" x="152" y="724">p</text><text text-anchor="middle" x="160" y="724">y</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;1:</b> A nightmare game tuning session.</div></center>

</p><p>

Of course, some debuggers, like Visual Studio, have &ldquo;Edit and Continue&rdquo; functionality, where you could set a breakpoint, edit a variable, and continue from where you left. Unfortunately, this functionality is usually quite limited and doesn't really work in more complex situations.

</p><p>

Maybe we could implement our own fool-proof version of &ldquo;Edit and Continue&rdquo;? Something that would allow us to replicate the same functionality of &ldquo;Change the code live&rdquo; &rarr; &ldquo;Recompile&rdquo; without breaking or exiting the game! 

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="688" width="336" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 40,224 L 40,608 " style="fill:none;"/>
<path d="M 80,16 L 80,48 " style="fill:none;"/>
<path d="M 80,96 L 80,144 " style="fill:none;"/>
<path d="M 80,192 L 80,224 " style="fill:none;"/>
<path d="M 80,272 L 80,320 " style="fill:none;"/>
<path d="M 80,368 L 80,416 " style="fill:none;"/>
<path d="M 80,464 L 80,512 " style="fill:none;"/>
<path d="M 80,560 L 80,592 " style="fill:none;"/>
<path d="M 144,48 L 144,88 " style="fill:none;"/>
<path d="M 144,144 L 144,184 " style="fill:none;"/>
<path d="M 144,224 L 144,264 " style="fill:none;"/>
<path d="M 144,320 L 144,360 " style="fill:none;"/>
<path d="M 144,416 L 144,456 " style="fill:none;"/>
<path d="M 144,512 L 144,552 " style="fill:none;"/>
<path d="M 144,592 L 144,608 " style="fill:none;"/>
<path d="M 216,16 L 216,48 " style="fill:none;"/>
<path d="M 216,96 L 216,144 " style="fill:none;"/>
<path d="M 216,192 L 216,224 " style="fill:none;"/>
<path d="M 216,272 L 216,320 " style="fill:none;"/>
<path d="M 216,368 L 216,416 " style="fill:none;"/>
<path d="M 216,464 L 216,512 " style="fill:none;"/>
<path d="M 216,560 L 216,592 " style="fill:none;"/>
<path d="M 80,16 L 216,16 " style="fill:none;"/>
<path d="M 80,48 L 216,48 " style="fill:none;"/>
<path d="M 80,96 L 216,96 " style="fill:none;"/>
<path d="M 80,144 L 216,144 " style="fill:none;"/>
<path d="M 80,192 L 216,192 " style="fill:none;"/>
<path d="M 56,208 L 72,208 " style="fill:none;"/>
<path d="M 80,224 L 216,224 " style="fill:none;"/>
<path d="M 80,272 L 216,272 " style="fill:none;"/>
<path d="M 80,320 L 216,320 " style="fill:none;"/>
<path d="M 80,368 L 216,368 " style="fill:none;"/>
<path d="M 80,416 L 216,416 " style="fill:none;"/>
<path d="M 80,464 L 216,464 " style="fill:none;"/>
<path d="M 80,512 L 216,512 " style="fill:none;"/>
<path d="M 80,560 L 216,560 " style="fill:none;"/>
<path d="M 80,592 L 216,592 " style="fill:none;"/>
<path d="M 56,624 L 128,624 " style="fill:none;"/>
<path d="M 56,208 C 39.2,208 40,224 40,224 " style="fill:none;"/>
<path d="M 56,624 C 39.2,624 40,608 40,608 " style="fill:none;"/>
<path d="M 128,624 C 144.8,624 144,608 144,608 " style="fill:none;"/>
<polygon points="152,552 140,546.4 140,557.6 "  style="stroke:none" transform="rotate(90,144,552 )"/>
<polygon points="152,456 140,450.4 140,461.6 "  style="stroke:none" transform="rotate(90,144,456 )"/>
<polygon points="152,360 140,354.4 140,365.6 "  style="stroke:none" transform="rotate(90,144,360 )"/>
<polygon points="152,264 140,258.4 140,269.6 "  style="stroke:none" transform="rotate(90,144,264 )"/>
<polygon points="152,184 140,178.4 140,189.6 "  style="stroke:none" transform="rotate(90,144,184 )"/>
<polygon points="152,88 140,82.4 140,93.6 "  style="stroke:none" transform="rotate(90,144,88 )"/>
<polygon points="80,208 68,202.4 68,213.6 "  style="stroke:none" transform="rotate(0,72,208 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="96" y="36">S</text><text text-anchor="middle" x="104" y="36">t</text><text text-anchor="middle" x="112" y="36">a</text><text text-anchor="middle" x="120" y="36">r</text><text text-anchor="middle" x="128" y="36">t</text><text text-anchor="middle" x="144" y="36">t</text><text text-anchor="middle" x="152" y="36">h</text><text text-anchor="middle" x="160" y="36">e</text><text text-anchor="middle" x="176" y="36">g</text><text text-anchor="middle" x="184" y="36">a</text><text text-anchor="middle" x="192" y="36">m</text><text text-anchor="middle" x="200" y="36">e</text><text text-anchor="middle" x="112" y="116">S</text><text text-anchor="middle" x="120" y="116">k</text><text text-anchor="middle" x="128" y="116">i</text><text text-anchor="middle" x="136" y="116">p</text><text text-anchor="middle" x="152" y="116">t</text><text text-anchor="middle" x="160" y="116">o</text><text text-anchor="middle" x="176" y="116">t</text><text text-anchor="middle" x="184" y="116">h</text><text text-anchor="middle" x="192" y="116">e</text><text text-anchor="middle" x="104" y="132">d</text><text text-anchor="middle" x="112" y="132">e</text><text text-anchor="middle" x="120" y="132">s</text><text text-anchor="middle" x="128" y="132">i</text><text text-anchor="middle" x="136" y="132">r</text><text text-anchor="middle" x="144" y="132">e</text><text text-anchor="middle" x="152" y="132">d</text><text text-anchor="middle" x="168" y="132">l</text><text text-anchor="middle" x="176" y="132">e</text><text text-anchor="middle" x="184" y="132">v</text><text text-anchor="middle" x="192" y="132">e</text><text text-anchor="middle" x="200" y="132">l</text><text text-anchor="middle" x="120" y="212">P</text><text text-anchor="middle" x="128" y="212">l</text><text text-anchor="middle" x="136" y="212">a</text><text text-anchor="middle" x="144" y="212">y</text><text text-anchor="middle" x="152" y="212">t</text><text text-anchor="middle" x="160" y="212">e</text><text text-anchor="middle" x="168" y="212">s</text><text text-anchor="middle" x="176" y="212">t</text><text text-anchor="middle" x="104" y="292">F</text><text text-anchor="middle" x="112" y="292">i</text><text text-anchor="middle" x="120" y="292">n</text><text text-anchor="middle" x="128" y="292">d</text><text text-anchor="middle" x="144" y="292">a</text><text text-anchor="middle" x="160" y="292">v</text><text text-anchor="middle" x="168" y="292">a</text><text text-anchor="middle" x="176" y="292">l</text><text text-anchor="middle" x="184" y="292">u</text><text text-anchor="middle" x="192" y="292">e</text><text text-anchor="middle" x="128" y="308">t</text><text text-anchor="middle" x="136" y="308">o</text><text text-anchor="middle" x="152" y="308">f</text><text text-anchor="middle" x="160" y="308">i</text><text text-anchor="middle" x="168" y="308">x</text><text text-anchor="middle" x="112" y="388">G</text><text text-anchor="middle" x="120" y="388">o</text><text text-anchor="middle" x="136" y="388">t</text><text text-anchor="middle" x="144" y="388">o</text><text text-anchor="middle" x="160" y="388">t</text><text text-anchor="middle" x="168" y="388">h</text><text text-anchor="middle" x="176" y="388">e</text><text text-anchor="middle" x="112" y="404">g</text><text text-anchor="middle" x="120" y="404">a</text><text text-anchor="middle" x="128" y="404">m</text><text text-anchor="middle" x="136" y="404">e</text><text text-anchor="middle" x="152" y="404">c</text><text text-anchor="middle" x="160" y="404">o</text><text text-anchor="middle" x="168" y="404">d</text><text text-anchor="middle" x="176" y="404">e</text><text text-anchor="middle" x="112" y="484">F</text><text text-anchor="middle" x="120" y="484">i</text><text text-anchor="middle" x="128" y="484">x</text><text text-anchor="middle" x="144" y="484">d</text><text text-anchor="middle" x="152" y="484">e</text><text text-anchor="middle" x="160" y="484">s</text><text text-anchor="middle" x="168" y="484">i</text><text text-anchor="middle" x="176" y="484">r</text><text text-anchor="middle" x="184" y="484">e</text><text text-anchor="middle" x="192" y="484">d</text><text text-anchor="middle" x="136" y="500">v</text><text text-anchor="middle" x="144" y="500">a</text><text text-anchor="middle" x="152" y="500">l</text><text text-anchor="middle" x="160" y="500">u</text><text text-anchor="middle" x="168" y="500">e</text><text text-anchor="middle" x="112" y="580">R</text><text text-anchor="middle" x="120" y="580">e</text><text text-anchor="middle" x="128" y="580">c</text><text text-anchor="middle" x="136" y="580">o</text><text text-anchor="middle" x="144" y="580">m</text><text text-anchor="middle" x="152" y="580">p</text><text text-anchor="middle" x="160" y="580">i</text><text text-anchor="middle" x="168" y="580">l</text><text text-anchor="middle" x="176" y="580">e</text><text text-anchor="middle" x="24" y="644">r</text><text text-anchor="middle" x="32" y="644">e</text><text text-anchor="middle" x="40" y="644">p</text><text text-anchor="middle" x="48" y="644">e</text><text text-anchor="middle" x="56" y="644">a</text><text text-anchor="middle" x="64" y="644">t</text><text text-anchor="middle" x="80" y="644">u</text><text text-anchor="middle" x="88" y="644">n</text><text text-anchor="middle" x="96" y="644">t</text><text text-anchor="middle" x="104" y="644">i</text><text text-anchor="middle" x="112" y="644">l</text><text text-anchor="middle" x="128" y="644">h</text><text text-anchor="middle" x="136" y="644">a</text><text text-anchor="middle" x="144" y="644">p</text><text text-anchor="middle" x="152" y="644">p</text><text text-anchor="middle" x="160" y="644">y</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;2:</b> Our ideal debugging session. No more start-stop for us!</div></center>

</p>
<a class="target" name="hotreloading">&nbsp;</a><a class="target" name="planfortoday/hotreloading">&nbsp;</a><a class="target" name="toc1.2">&nbsp;</a><h2>Hot Reloading</h2>
<p>


We're just out of a very complex sound debugging part, so it's about time for us to do something fun! Let's see if we can use Windows to help us do it.

</p><p>

If you review our game code structure so far, you'll see that it's already quite neatly separating Windows (platform-specific layer) from our core game functionality. So, to start implementing the live code editing, we first should ask ourselves: could we split those two things apart entirely? You'll have the platform code (containing WinMain and other platform-specific code) compiled separately from the game code. 

</p><p>

And then, will it be possible to unload the game part without killing the executable? 

</p><p>

The answer is &ldquo;yes&rdquo; to both of these questions. We already have the ability of loading libraries that we implemented for our XInput code when we were working on the controller input: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">Win32LoadXInput</span><span class="hljs-params">()</span></span>
<span class="line"></span>{</span>
<span class="line">    HMODULE XInputLibrary = LoadLibraryA(<span class="hljs-string">"Xinput1_4.dll"</span>);</span>
<span class="line">    <span class="hljs-keyword">if</span>(!XInputLibrary)</span>
<span class="line">    {</span>
<span class="line">        XInputLibrary = LoadLibraryA(<span class="hljs-string">"Xinput1_3.dll"</span>);</span>
<span class="line">    }</span>
<span class="line">    <span class="hljs-keyword">if</span>(!XInputLibrary)</span>
<span class="line">    {</span>
<span class="line">        XInputLibrary = LoadLibraryA(<span class="hljs-string">"Xinput9_1_0.dll"</span>);</span>
<span class="line">    }</span>
<span class="line">    </span>
<span class="line">    <span class="hljs-keyword">if</span>(XInputLibrary)</span>
<span class="line">    {</span>
<span class="line">        XInputGetState = (x_input_get_state *)GetProcAddress(XInputLibrary, <span class="hljs-string">"XInputGetState"</span>);</span>
<span class="line">        XInputSetState = (x_input_set_state *)GetProcAddress(XInputLibrary, <span class="hljs-string">"XInputSetState"</span>);</span>
<span class="line">    }    </span>
<span class="line">}</span></code></pre><p>

Here, we first call <code>LoadLibraryA</code> to load a DLL. After we ensure that the operation succeeded we retrieve the necessary functions using <code>GetProcAddress</code> and use them as usual. 

</p><p>

If we want, we can just do it with our own code. Instead of compiling our program <a href="https://en.wikipedia.org/wiki/Monolithic_application">monolithically</a>, we will build the program as two separate <em class="underscore">translation units</em>. In simpler terms, we will run our compilation on two different code chunks separately: one for the platform and one for the game. The platform-independent code will be loaded as a <code>.dll</code> to do whatever we need. 

</p><p>

After that, it's simple. When we change our game code, we will simply unload, rebuild, and reload the DLL without killing the executable. It should just work! 

</p><p>

What really enables us to do it this way is passing memory to the game in a single chunk. We said in the past that there're many good reasons for doing it, well, that's one of them. Our platform layer reserves the memory and passes the whole chunk to the game. When the game is done doing its work, the memory is preserved for the main loop's next iteration. This allows us to unload the game, swap the game code with the new version, and give it the memory the previous guy was using. And poof! The game will keep running as before. 

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="288" width="472" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 8,80 L 8,208 " style="fill:none;"/>
<path d="M 112,80 L 112,208 " style="fill:none;"/>
<path d="M 224,32 L 224,80 " style="fill:none;"/>
<path d="M 224,144 L 224,160 " style="fill:none;"/>
<path d="M 224,208 L 224,256 " style="fill:none;"/>
<path d="M 344,80 L 344,208 " style="fill:none;"/>
<path d="M 448,80 L 448,208 " style="fill:none;"/>
<path d="M 8,80 L 112,80 " style="fill:none;"/>
<path d="M 344,80 L 448,80 " style="fill:none;"/>
<path d="M 128,96 L 176,96 " style="fill:none;"/>
<path d="M 272,96 L 320,96 " style="fill:none;"/>
<path d="M 128,112 L 176,112 " style="fill:none;"/>
<path d="M 272,112 L 320,112 " style="fill:none;"/>
<path d="M 128,128 L 176,128 " style="fill:none;"/>
<path d="M 272,128 L 320,128 " style="fill:none;"/>
<path d="M 128,176 L 176,176 " style="fill:none;"/>
<path d="M 272,176 L 328,176 " style="fill:none;"/>
<path d="M 128,192 L 176,192 " style="fill:none;"/>
<path d="M 272,192 L 328,192 " style="fill:none;"/>
<path d="M 8,208 L 112,208 " style="fill:none;"/>
<path d="M 344,208 L 448,208 " style="fill:none;"/>
<polygon points="328,128 316,122.4 316,133.6 "  style="stroke:none" transform="rotate(0,320,128 )"/>
<polygon points="328,112 316,106.4 316,117.6 "  style="stroke:none" transform="rotate(0,320,112 )"/>
<polygon points="328,96 316,90.4 316,101.6 "  style="stroke:none" transform="rotate(0,320,96 )"/>
<polygon points="280,192 268,186.4 268,197.6 "  style="stroke:none" transform="rotate(180,272,192 )"/>
<polygon points="280,176 268,170.4 268,181.6 "  style="stroke:none" transform="rotate(180,272,176 )"/>
<polygon points="184,128 172,122.4 172,133.6 "  style="stroke:none" transform="rotate(0,176,128 )"/>
<polygon points="184,112 172,106.4 172,117.6 "  style="stroke:none" transform="rotate(0,176,112 )"/>
<polygon points="184,96 172,90.4 172,101.6 "  style="stroke:none" transform="rotate(0,176,96 )"/>
<polygon points="136,192 124,186.4 124,197.6 "  style="stroke:none" transform="rotate(180,128,192 )"/>
<polygon points="136,176 124,170.4 124,181.6 "  style="stroke:none" transform="rotate(180,128,176 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="176" y="4">C</text><text text-anchor="middle" x="184" y="4">r</text><text text-anchor="middle" x="192" y="4">o</text><text text-anchor="middle" x="200" y="4">s</text><text text-anchor="middle" x="208" y="4">s</text><text text-anchor="middle" x="216" y="4">-</text><text text-anchor="middle" x="224" y="4">p</text><text text-anchor="middle" x="232" y="4">l</text><text text-anchor="middle" x="240" y="4">a</text><text text-anchor="middle" x="248" y="4">t</text><text text-anchor="middle" x="256" y="4">f</text><text text-anchor="middle" x="264" y="4">o</text><text text-anchor="middle" x="272" y="4">r</text><text text-anchor="middle" x="280" y="4">m</text><text text-anchor="middle" x="184" y="20">A</text><text text-anchor="middle" x="192" y="20">P</text><text text-anchor="middle" x="200" y="20">I</text><text text-anchor="middle" x="216" y="20">b</text><text text-anchor="middle" x="224" y="20">o</text><text text-anchor="middle" x="232" y="20">u</text><text text-anchor="middle" x="240" y="20">n</text><text text-anchor="middle" x="248" y="20">d</text><text text-anchor="middle" x="256" y="20">a</text><text text-anchor="middle" x="264" y="20">r</text><text text-anchor="middle" x="272" y="20">y</text><text text-anchor="middle" x="208" y="100">I</text><text text-anchor="middle" x="216" y="100">n</text><text text-anchor="middle" x="224" y="100">p</text><text text-anchor="middle" x="232" y="100">u</text><text text-anchor="middle" x="240" y="100">t</text><text text-anchor="middle" x="32" y="116">P</text><text text-anchor="middle" x="40" y="116">l</text><text text-anchor="middle" x="48" y="116">a</text><text text-anchor="middle" x="56" y="116">t</text><text text-anchor="middle" x="64" y="116">f</text><text text-anchor="middle" x="72" y="116">o</text><text text-anchor="middle" x="80" y="116">r</text><text text-anchor="middle" x="88" y="116">m</text><text text-anchor="middle" x="200" y="116">F</text><text text-anchor="middle" x="208" y="116">i</text><text text-anchor="middle" x="216" y="116">l</text><text text-anchor="middle" x="224" y="116">e</text><text text-anchor="middle" x="240" y="116">I</text><text text-anchor="middle" x="248" y="116">/</text><text text-anchor="middle" x="256" y="116">O</text><text text-anchor="middle" x="384" y="116">G</text><text text-anchor="middle" x="392" y="116">a</text><text text-anchor="middle" x="400" y="116">m</text><text text-anchor="middle" x="408" y="116">e</text><text text-anchor="middle" x="24" y="132">e</text><text text-anchor="middle" x="32" y="132">x</text><text text-anchor="middle" x="40" y="132">e</text><text text-anchor="middle" x="48" y="132">c</text><text text-anchor="middle" x="56" y="132">u</text><text text-anchor="middle" x="64" y="132">t</text><text text-anchor="middle" x="72" y="132">a</text><text text-anchor="middle" x="80" y="132">b</text><text text-anchor="middle" x="88" y="132">l</text><text text-anchor="middle" x="96" y="132">e</text><text text-anchor="middle" x="208" y="132">M</text><text text-anchor="middle" x="216" y="132">e</text><text text-anchor="middle" x="224" y="132">m</text><text text-anchor="middle" x="232" y="132">o</text><text text-anchor="middle" x="240" y="132">r</text><text text-anchor="middle" x="248" y="132">y</text><text text-anchor="middle" x="376" y="132">L</text><text text-anchor="middle" x="384" y="132">i</text><text text-anchor="middle" x="392" y="132">b</text><text text-anchor="middle" x="400" y="132">r</text><text text-anchor="middle" x="408" y="132">a</text><text text-anchor="middle" x="416" y="132">r</text><text text-anchor="middle" x="424" y="132">y</text><text text-anchor="middle" x="200" y="180">G</text><text text-anchor="middle" x="208" y="180">r</text><text text-anchor="middle" x="216" y="180">a</text><text text-anchor="middle" x="224" y="180">p</text><text text-anchor="middle" x="232" y="180">h</text><text text-anchor="middle" x="240" y="180">i</text><text text-anchor="middle" x="248" y="180">c</text><text text-anchor="middle" x="256" y="180">s</text><text text-anchor="middle" x="208" y="196">S</text><text text-anchor="middle" x="216" y="196">o</text><text text-anchor="middle" x="224" y="196">u</text><text text-anchor="middle" x="232" y="196">n</text><text text-anchor="middle" x="240" y="196">d</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;3:</b> The API boundary will now be complete.</div></center>

</p><p>

Now, there're a couple of caveats where the magic won't work in all places. For instance, if the structures have changed (members were added or removed), this can potentially affect the layout of the memory using those structures, so the game wouldn't be able to read old memory anymore and require a restart. However, it's a simple way of envisioning how such a code would work, at least for the time being.

</p><p>

Another issue that one can think about are the compile times. Some projects are notoriously slow to build, but this comes from lousy programming practices rather than a codebase's complexity. If your code takes more than 10 seconds to compile, you're doing it wrong! 

</p>
<a class="target" name="changebuild.bat">&nbsp;</a><a class="target" name="changebuild.bat">&nbsp;</a><a class="target" name="toc2">&nbsp;</a><h1>Change <code>build.bat</code></h1>
<p>


The first step on our journey would be updating our <code>build.bat</code>. 

</p>
<a class="target" name="cleanupbuildvariables">&nbsp;</a><a class="target" name="changebuild.bat/cleanupbuildvariables">&nbsp;</a><a class="target" name="toc2.1">&nbsp;</a><h2>Clean Up Build Variables</h2>
<p>


<a href="../html/day16.html">Last time</a>, we might have gone a little bit overboard with the variables. Our <code>cl</code> line currently looks like this: 

</p><pre class="listing tilde"><code><span class="line">cl -Od %compiler% -DHANDMADE_WIN32=1 %defines% %debug% -Fmwin32_handmade.map %code_path%win32_handmade.cpp %win32_libs% /link %win32_link%</span></code></pre><p>

where: 

</p><p>

<ul>
<li class="asterisk"><code>%compiler%</code> contains various compiler flags.
</li>
<li class="asterisk"><code>%defines%</code> stands for the defines for <code>-DHANDMADE_INTERNAL=1</code> and <code>-DHANDMADE_SLOW=1</code>.
</li>
<li class="asterisk"><code>%debug%</code> adds a couple flags for debug mode (<code>-FC</code> and <code>-Z7</code>).
</li>
<li class="asterisk"><code>%code_path% is a shortcut to our code path, should it change.
* </code>%win32_libs%<code> contains all the libraries we need to compile on Windows.
* </code>%win32_link%` contains a couple switches to pass to the linker.</li></ul>

</p><p>

Now, the last one can be reworked. We only have 1 Windows-specific flag, the subsystem, which we can pass directly instead of a variable, while the common linker flags can be grouped and expanded together. We want to add <code>-incremental:no</code> flag to the linker flags, simply to make sure we do the complete recompile each time.

</p><pre class="listing tilde"><code><span class="line">:: WIN32 PLATFORM LIBRARIES</span>
<span class="line">set win32_libs=             user32.lib</span>
<span class="line">set win32_libs=%win32_libs% gdi32.lib</span>
<span class="line">set win32_libs=%win32_libs% winmm.lib</span><div class=" add"><span class="line">:: COMMON LINKER SWITCHES</span>
<span class="line">set link=                   -opt:ref               &amp;:: Remove unused functions</span>
<span class="line">set link=%link%             -incremental:no        &amp;:: Perform full link each time</span></div><div class=" delete"><span class="line">:: WIN32 LINKER SWITCHES</span>
<span class="line">set win32_link=             -subsystem:windows,5.2 &amp;:: subsystem, 5.1 for x86</span>
<span class="line">set win32_link=%win32_link% -opt:ref               &amp;:: Remove unused functions</span></div><span class="line"></span>
<span class="line">:: No optimizations (slow): -Od; all optimizations (fast): -O2</span>
<span class="line"></span><div class=" edit"><span class="line">cl -Od %compiler% -DHANDMADE_WIN32=1 %defines% %debug% -Fmwin32_handmade.map %code_path%win32_handmade.cpp %win32_libs% /link %link% -subsystem:windows,5.2</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;1:</b> <file>[build.bat]</file> Updating linker flag variables.</div></center>
<p>


Remember that you still need to add <code>/link</code> so that the compiler knows it needs to pass the flags that follow to the linker.

</p><p>

Feel free to expand or change the variables as you feel appropriate to your workflow.

</p>
<a class="target" name="requesthandmade.dllcompilation">&nbsp;</a><a class="target" name="changebuild.bat/requesthandmade.dllcompilation">&nbsp;</a><a class="target" name="toc2.2">&nbsp;</a><h2>Request <code>handmade.dll</code> Compilation</h2>
<p>


Because we want to make two separate <em class="underscore">things</em>, we want to call the compiler, <code>cl</code>, twice. This will, in return, produce two files (aside from a bunch of debug files and build artifacts): 

</p><p>

<ul>
<li class="asterisk"><code>win32_handmade.exe</code> will contain the Windows platform code.
</li>
<li class="asterisk"><code>handmade.dll</code> will contain the cross-platform game code.</li></ul>

</p><p>

In the new line, we can specify: 

</p><p>

<ul>
<li class="asterisk">Most of the shared compiler flags we already do for <code>win32_handmade.cpp</code>.
</li>
<li class="asterisk">As the file name, we'll pass our <code>handmade.cpp</code>'; the map file will also have a different name.
</li>
<li class="asterisk">A special flag [-LD] for building a DLL instead of an executable. 
</li>
<li class="asterisk">The common linker flags we just highlighted out.</li></ul>

</p><pre class="listing tilde"><code><span class="line">:: No optimizations (slow): -Od; all optimizations (fast): -O2</span>
<span class="line"></span><div class=" add"><span class="line">cl -Od %compiler% %defines% %debug% -Fmhandmade.map %code_path%handmade.cpp -LD /link %link%</span></div><span class="line">cl -Od %compiler% -DHANDMADE_WIN32=1 %defines% %debug% -Fmwin32_handmade.map %code_path%win32_handmade.cpp %win32_libs% /link %link% -subsystem:windows,5.2</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;2:</b> <file>[build.bat]</file> Requesting to build <code>handmade.dll</code>.</div></center>
<p>


We miss one last step here.

</p>
<a class="target" name="exportfunctions">&nbsp;</a><a class="target" name="changebuild.bat/exportfunctions">&nbsp;</a><a class="target" name="toc2.3">&nbsp;</a><h2>Export Functions</h2>
<p>


DLL is not much different from an EXE. It essentially contains executable code, like an <code>.exe</code>. Contrary to the latter, though, a DLL has a specific table of functions. These functions can be called from outside the DLL by whoever asks for them. It's this table that a function <code>GetProcAddress</code> goes to read in an attempt to find a specific location to call. This allows linking at runtime, dynamically (hence the name Dynamically Linked Library, or DLL for short). 

</p><p>

To allow such functionality, we need to tell the linker which functions we're exporting. There're a couple of ways to do this: 

</p><p>

<ul>
<li class="asterisk">You can prefix the function you're exporting with a specific attribute. In Visual Studio, this is <code>__declspec(dllexport)</code>. 
</li>
<li class="asterisk">You can simply specify the exports at compile-time, in our case inside <code>build.bat</code>.</li></ul>

</p><p>

The first method seems quite simple, except it has several drawbacks. The attribute is not standardized, so different operating systems (and even different compilers!) have their own designations. Using a specific one inside the code file, we're essentially tying ourselves to the Microsoft's compiler, and that's not necessarily something that we'd love to do.

</p><p>

We don't have many functions to export. We only want to export <code>GameUpdateAndRender</code> and <code>GameGetSoundSamples</code>, so let's go with the second option. 

</p><p>

The keyword we're after is?. Inside the <code>build.bat</code> file, you can write directly on the compile line, or you can add another variable to use for simpler reading later on, as we did below. 

</p><pre class="listing tilde"><code><span class="line">:: COMMON LINKER SWITCHES</span>
<span class="line">set link=                   -opt:ref               &amp;:: Remove unused functions</span>
<span class="line">set link=%link%             -incremental:no        &amp;:: Perform full link each time</span><div class=" add"><span class="line">:: DLL LINKER SWITCHES</span>
<span class="line">set dll_link=               /EXPORT:GameUpdateAndRender</span>
<span class="line">set dll_link=%dll_link%     /EXPORT:GameGetSoundSamples</span></div><span class="line"></span>
<span class="line">:: No optimizations (slow): -Od; all optimizations (fast): -O2</span>
<span class="line"></span><div class=" edit"><span class="line">cl -Od %compiler% %defines% %debug% -Fmhandmade.map %code_path%handmade.cpp -LD /link %link% %dll_link%</span></div><span class="line">cl -Od %compiler% -DHANDMADE_WIN32=1 %defines% %debug% -Fmwin32_handmade.map %code_path%win32_handmade.cpp %win32_libs% /link %link% -subsystem:windows,5.2</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;3:</b> <file>[build.bat]</file> Adding functions to export.</div></center>
<p>


Of course, if we try to build now, the compiler will complain loudly of all the things it doesn't like. Let's get to finishing separating the two layers.

</p>
<a class="target" name="separategamefromplatform">&nbsp;</a><a class="target" name="separategamefromplatform">&nbsp;</a><a class="target" name="toc3">&nbsp;</a><h1>Separate Game from Platform</h1>
<p>


Up until now, we were building the game as one big monolithic block. Our platform layer and the game were compiled as a single translation unit, even if we separated the two semantically. We have some shared items that we have between the two, but we also have some components that should never talk with each other. 

</p><p>

Let's unify the shared and separate even further specific code.

</p>
<a class="target" name="movesharedtypes">&nbsp;</a><a class="target" name="separategamefromplatform/movesharedtypes">&nbsp;</a><a class="target" name="toc3.1">&nbsp;</a><h2>Move Shared Types</h2>
<p>


The first step would be to move the type definitions and common includes away from <code>win32_handmade.cpp</code> header. We also want to remove any reference from <code>handmade.cpp</code>:

</p><pre class="listing tilde"><code><div class=" delete"><span class="line"><span class="hljs-comment">// TODO(casey): Implement sine ourselves</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;math.h&gt;</span></span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int8_t</span> s8;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int16_t</span> s16;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int32_t</span> s32;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int64_t</span> s64;</span>
<span class="line"><span class="hljs-keyword">typedef</span> s32 b32;</span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint8_t</span> u8;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint16_t</span> u16;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint32_t</span> u32;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint64_t</span> u64;</span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">float</span> f32;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">double</span> f64;</span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> internal static</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> local_persist static</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> global_variable static</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> Pi32 3.14159265359f</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"handmade.cpp"</span></span></span></div><div class=" add"><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"handmade.h"</span></span></span></div><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;xinput.h&gt;</span></span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dsound.h&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"win32_handmade.h"</span></span></span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;4:</b> <file>[win32_handmade.cpp]</file> Removing non-Windows specific <code>typedef</code>s and <code>#include</code>s.</div></center>
<p>


Our <code>handmade.h</code> currently fulfills the role of a common interface quite nicely. Let's move all this cut code on top of the file (except <code>handmade.cpp</code> include, we don't want circular includes!).

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> !defined(HANDMADE_H)</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-comment">/*</span>
<span class="line">NOTE(casey):</span>
<span class="line"></span>
<span class="line">HANDMADE_INTERNAL:</span>
<span class="line">0 - Build for public release</span>
<span class="line">1 - Build for developer only</span>
<span class="line"></span>
<span class="line">HANDMADE_SLOW:</span>
<span class="line">0 - No slow code allowed!</span>
<span class="line">1 - Slow code welcome.</span>
<span class="line">*/</span></span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-comment">// TODO(casey): Implement sine ourselves</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;math.h&gt;</span></span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int8_t</span> s8;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int16_t</span> s16;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int32_t</span> s32;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int64_t</span> s64;</span>
<span class="line"><span class="hljs-keyword">typedef</span> s32 b32;</span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint8_t</span> u8;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint16_t</span> u16;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint32_t</span> u32;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint64_t</span> u64;</span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">float</span> f32;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">double</span> f64;</span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> internal static</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> local_persist static</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> global_variable static</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> Pi32 3.14159265359f</span></span></div><span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> HANDMADE_SLOW</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> Assert(Expression) <span class="hljs-meta-keyword">if</span> (!(Expression)) { *(int *)0 = 0; }</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> Assert(Expression)</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span>
<span class="line"></span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;5:</b> <file>[handmade.h]</file> Adding common <code>#define</code>s, <code>typedef</code>s and <code>#include</code>s.</div></center>

<a class="target" name="updateapi">&nbsp;</a><a class="target" name="separategamefromplatform/updateapi">&nbsp;</a><a class="target" name="toc3.2">&nbsp;</a><h2>Update API</h2>
<p>


Let's try to compile and let the compiler errors guide us. The first error that we get is actually a compiler warning! It's a good thing that we increased our warning level and asked the compiler to treat all warnings as errors:

</p><pre class="listing tilde"><code><span class="line">handmade.h(178) : warning C4505: 'GameUpdateAndRender' : unreferenced local function has been removed</span>
<span class="line">handmade.h(178) : warning C4505: 'GameGetSoundSamples' : unreferenced local function has been removed</span></code></pre><p>

That's a good warning to catch! The keyword we're looking at here is <code>local</code>. We already asked <code>build.bat</code> to export these functions as publicly available, but in our code we still mark them as <code>internal</code> (or <code>static</code> if we go back to <code>internal</code> definition). Let's fix that! We need to update both <code>handmade.h</code> and <code>handmade.cpp</code>: 

</p><pre class="listing tilde"><code><div class=" edit"><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">GameUpdateAndRender</span><span class="hljs-params">(game_memory *Memory, game_input *Input, game_offscreen_buffer* Buffer)</span></span>;</span></div><span class="line"></span>
<span class="line"><span class="hljs-comment">// NOTE(casey): At the moment, this has to be a very fast function, it cannot be</span></span>
<span class="line"><span class="hljs-comment">// more than a millisecond or so.</span></span>
<span class="line"><span class="hljs-comment">// TODO(casey): Reduce the pressure on this function's performance by measuring it</span></span>
<span class="line"><span class="hljs-comment">// or asking about it, etc.</span></span><div class=" edit"><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">GameGetSoundSamples</span><span class="hljs-params">(game_memory *Memory, game_sound_output_buffer *SoundBuffer)</span></span>;</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;6:</b> <file>[handmade.h]</file> Removing <code>internal</code> from the function declarations.</div></center>
<pre class="listing tilde"><code><div class=" edit"><span class="line"><span class="hljs-keyword">void</span></span></div><span class="line">GameUpdateAndRender(game_memory* Memory, game_input *Input, game_offscreen_buffer* Buffer)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">//...</span></span>
<span class="line">}</span>
<span class="line"></span><div class=" edit"><span class="line"><span class="hljs-keyword">void</span></span></div><span class="line">GameGetSoundSamples(game_memory* Memory, game_sound_output_buffer *SoundBuffer)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;7:</b> <file>[handmade.cpp]</file> Removing <code>internal</code> from the function definitions.</div></center>
<p>


If we look at the compiler errors further down, you'll see that we have similar warnings for the debug services we provide to the game: for now, it's only file I/O (reading/writing files), but this might change in the future. Let's update make them non-static, as well. 

</p><pre class="listing tilde"><code><div class=" edit"><span class="line"><span class="hljs-function">debug_read_file_result <span class="hljs-title">DEBUGPlatformReadEntireFile</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *Filename)</span></span>;</span>
<span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DEBUGPlatformFreeFileMemory</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *Memory)</span></span>;</span>
<span class="line"><span class="hljs-function">b32 <span class="hljs-title">DEBUGPlatformWriteEntireFile</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *Filename, u32 MemorySize, <span class="hljs-keyword">void</span> *Memory)</span></span>;</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;8:</b> <file>[handmade.h]</file> Updating debug services declarations.</div></center>
<pre class="listing tilde"><code><div class=" edit"><span class="line"><span class="hljs-keyword">void</span></span></div><span class="line">DEBUGPlatformFreeFileMemory(<span class="hljs-keyword">void</span> *Memory)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">}</span>
<span class="line"></span><div class=" edit"><span class="line">debug_read_file_result</span></div><span class="line">DEBUGPlatformReadEntireFile(<span class="hljs-keyword">char</span> *Filename)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">//...</span></span>
<span class="line">}</span>
<span class="line"></span><div class=" edit"><span class="line">b32</span></div><span class="line">DEBUGPlatformWriteEntireFile(<span class="hljs-keyword">char</span> *Filename, u32 MemorySize, <span class="hljs-keyword">void</span> *Memory)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;9:</b> <file>[win32_handmade.cpp]</file> Updating debug services definitions.</div></center>
<p>


We don't need to export these functions through <code>build.bat</code>. We'll do something else to pass them to the game further down the line. 

</p>
<a class="target" name="inspectlinkererrors">&nbsp;</a><a class="target" name="separategamefromplatform/inspectlinkererrors">&nbsp;</a><a class="target" name="toc3.3">&nbsp;</a><h2>Inspect Linker Errors</h2>
<p>


If you've done everything correctly, the compiler will spit out something scary-looking like this: 

</p><pre class="listing tilde"><code><span class="line">handmade.cpp</span>
<span class="line">handmade.obj : error LNK2019: unresolved external symbol "struct debug_read_file_result __cdecl DEBUGPlatformReadEntireFile(char *)" (?DEBUGPlatformReadEntireFile@@YA?AUdebug_read_file_result@@PEAD@Z) referenced in function "void __cdecl GameUpdateAndRender(struct game_memory *,struct game_input *,struct game_offscreen_buffer *)" (?GameUpdateAndRender@@YAXPEAUgame_memory@@PEAUgame_input@@PEAUgame_offscreen_buffer@@@Z)</span>
<span class="line">handmade.obj : error LNK2019: unresolved external symbol "void __cdecl DEBUGPlatformFreeFileMemory(void *)" (?DEBUGPlatformFreeFileMemory@@YAXPEAX@Z) referenced in function "void __cdecl GameUpdateAndRender(struct game_memory *,struct game_input *,struct game_offscreen_buffer *)" (?GameUpdateAndRender@@YAXPEAUgame_memory@@PEAUgame_input@@PEAUgame_offscreen_buffer@@@Z)</span>
<span class="line">handmade.obj : error LNK2019: unresolved external symbol "int __cdecl DEBUGPlatformWriteEntireFile(char *,unsigned int,void *)" (?DEBUGPlatformWriteEntireFile@@YAHPEADIPEAX@Z) referenced in function "void __cdecl GameUpdateAndRender(struct game_memory *,struct game_input *,struct game_offscreen_buffer *)" (?GameUpdateAndRender@@YAXPEAUgame_memory@@PEAUgame_input@@PEAUgame_offscreen_buffer@@@Z)</span>
<span class="line">handmade.dll : fatal error LNK1120: 3 unresolved externals</span></code></pre><p>

Don't worry, these are simply linker errors, and it's good news for us! First, it means that compiler doesn't have anything to complain about, and it passed the work to the linker. Linker, on the other hand, has its own set of errors marked by <code>LNK[error number]</code>. 

</p><p>

In this case, each error says: 
<blockquote class="fancyquote"><span class="fancyquote">Hey, you tried to call this function &ldquo;bla bla bla&rdquo; 
 (symbol name %@scary#looking#something!%!), 
 you even declared it here: &ldquo;bla bla bla&rdquo; 
 (more scary symbols), but I didn't find it anywhere. Where is it?</span><span class="author">
      &mdash; Linker</span></blockquote>
These are the places where the two halves of our code call each other, and they cannot find the respective code to execute. We have to find a way to resolve these.

</p>
<a class="target" name="loadgamecode">&nbsp;</a><a class="target" name="separategamefromplatform/loadgamecode">&nbsp;</a><a class="target" name="toc3.4">&nbsp;</a><h2>Load Game Code</h2>
<p>


On <code>win32_handmade.cpp</code> side, we pretty much have the infrastructure ready to load the game code: we'll simply replicate the behavior of <code>Win32LoadXInput</code> function and repeat the magic of the stub functions.

</p><p>

Let's start with the stub functions first. If you remember, this is what we needed to do: 

</p><p>

<ul>
<li class="asterisk"><code>#define</code> a macro creating functions of a specific <em class="underscore">signature</em> (&ldquo;if I say in code <code>FUNCTION(FunctionName)</code> I really mean <code>void FunctionName(int something)</code>"). 
</li>
<li class="asterisk"><code>typedef</code> a new type of this exact signature.
</li>
<li class="asterisk">Create a stub function of this signature which does nothing.</li></ul>

</p><p>

We can do it for both <code>GameUpdateAndRender</code> and <code>GameGetSoundSamples</code>. Also, we can remove the function declarations we had earlier because they are no longer necessary.

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> GAME_UPDATE_AND_RENDER(name) void name(game_memory *Memory, game_input *Input, game_offscreen_buffer* Buffer)</span></span>
<span class="line"><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">GAME_UPDATE_AND_RENDER</span><span class="hljs-params">(game_update_and_render)</span></span>;</span>
<span class="line">GAME_UPDATE_AND_RENDER(GameUpdateAndRenderStub) { }</span></div><div class=" delete"><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">GameUpdateAndRender</span><span class="hljs-params">(game_memory *Memory, game_input *Input, game_offscreen_buffer* Buffer)</span></span>;</span></div><span class="line"><span class="hljs-comment">// NOTE(casey): At the moment, this has to be a very fast function, it cannot be</span></span>
<span class="line"><span class="hljs-comment">// more than a millisecond or so.</span></span>
<span class="line"><span class="hljs-comment">// TODO(casey): Reduce the pressure on this function's performance by measuring it</span></span>
<span class="line"><span class="hljs-comment">// or asking about it, etc.</span></span><div class=" add"><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> GAME_GET_SOUND_SAMPLES(name) void name(game_memory *Memory, game_sound_output_buffer *SoundBuffer)</span></span>
<span class="line"><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">GAME_GET_SOUND_SAMPLES</span><span class="hljs-params">(game_get_sound_samples)</span></span>;</span>
<span class="line">GAME_GET_SOUND_SAMPLES(GameGetSoundSamplesStub) { }</span></div><div class=" delete"><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">GameGetSoundSamples</span><span class="hljs-params">(game_memory *Memory, game_sound_output_buffer *SoundBuffer)</span></span>;</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;10:</b> <file>[handmade.h]</file> Implementing stub functions for game functions.</div></center>
<p>


We now also have an added benefit in that, should our function signature ever change, we only need to modify it in one place (instead of editing both the <code>.h</code> file and the <code>.cpp</code> file.). Let's edit our <code>GameUpdateAndRender</code> and <code>GameGetSoundSamples</code> function declarations one last time to enable this: 

</p><pre class="listing tilde"><code><div class=" edit"><span class="line">GAME_UPDATE_AND_RENDER(GameUpdateAndRender)</span></div><span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">}</span>
<span class="line"></span><div class=" edit"><span class="line">GAME_GET_SOUND_SAMPLES(GameGetSoundSamples)</span></div><span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;11:</b> <file>[handmade.cpp]</file> Using signature shortcuts.</div></center>
<p>


Hopefully, you can see what's going on here. Instead of writing <code>void GameUpdateAndRender(...)</code> we say <code>GAME_UPDATE_AND_RENDER(GameUpdateAndRender)</code> and define the actual function signature elsewhere.

</p><p>

Now that we have the necessary types and stubs, we can easily use them in our platform code. Let's write a function to load the game code.

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">Win32LoadGameCode</span><span class="hljs-params">()</span></span>
<span class="line"></span>{</span>
<span class="line">    HMODULE GameCodeDLL = LoadLibraryA(<span class="hljs-string">"handmade.dll"</span>);</span>
<span class="line">    <span class="hljs-keyword">if</span>(GameCodeDLL)</span>
<span class="line">    {</span>
<span class="line">        GameUpdateAndRender = (game_update_and_render *)GetProcAddress(GameCodeDLL, <span class="hljs-string">"GameUpdateAndRender"</span>);</span>
<span class="line">        GameGetSoundSamples = (game_get_sound_samples *)GetProcAddress(GameCodeDLL, <span class="hljs-string">"GameGetSoundSamples"</span>);</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"></span></div><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">Win32LoadXInput</span><span class="hljs-params">()</span></span></span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;12:</b> <file>[win32_handmade.cpp]</file> Loading game code from the DLL.</div></center>
<p>


For XInput, we used global variables to store the function calls. Let's try something different this time. Instead of using globals, we can think of a <code>win_game_code</code> structure that initialized and returned directly from this function. Furthermore, this allows us to store the DLL module handle and a failsafe to ensure our code is valid. Let's add all this to <code>win32_handmade.h</code>: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">win32_debug_time_marker</span></span>
<span class="line">{</span></span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">};</span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">win32_game_code</span></span>
<span class="line">{</span></span>
<span class="line">    HMODULE GameCodeDLL;</span>
<span class="line">    game_update_and_render *UpdateAndRender;</span>
<span class="line">    game_get_sound_samples *GetSoundSamples;</span>
<span class="line">    </span>
<span class="line">    b32 IsValid;</span>
<span class="line">};</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;13:</b> <file>[win32_handmade.h]</file> Introducing <code>win32_game_code</code>.</div></center>
<p>


We can now use this new structure in <code>Win32LoadGameCode</code>: we will return it as the result of our function, and we'll also make sure that this result is valid. 

</p><p>

The validity will be determined by whether or not we successfully load the functions. If <code>GetProcAddress</code> returns 0 at least for one of the exports, the whole <code>win32_game_code</code> will be flagged as invalid.

</p><pre class="listing tilde"><code><div class=" edit"><span class="line">internal win32_game_code</span></div><span class="line">Win32LoadGameCode()</span>
<span class="line">{</span><div class=" add"><span class="line">    win32_game_code Result = {};</span></div><div class=" edit"><span class="line">    Result.GameCodeDLL = LoadLibraryA(<span class="hljs-string">"handmade.dll"</span>);</span>
<span class="line">    <span class="hljs-keyword">if</span>(Result.GameCodeDLL)</span></div><span class="line">    {</span><div class=" edit"><span class="line">        Result.UpdateAndRender = </span>
<span class="line">            (game_update_and_render *)GetProcAddress(Result.GameCodeDLL, <span class="hljs-string">"GameUpdateAndRender"</span>);</span>
<span class="line">        Result.GetSoundSamples = </span>
<span class="line">            (game_get_sound_samples *)GetProcAddress(Result.GameCodeDLL, <span class="hljs-string">"GameGetSoundSamples"</span>);</span>
<span class="line"></span></div><div class=" add"><span class="line">        Result.IsValid = Result.GetSoundSamples &amp;&amp; Result.UpdateAndRender;</span></div><span class="line">    }</span>
<span class="line"></span><div class=" add"><span class="line">    <span class="hljs-keyword">if</span> (!Result.IsValid)</span>
<span class="line">    {</span>
<span class="line">        Result.UpdateAndRender = GameUpdateAndRenderStub;</span>
<span class="line">        Result.GetSoundSamples = GameGetSoundSamplesStub;</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line">    <span class="hljs-keyword">return</span>(Result);</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;14:</b> <file>[win32_handmade.cpp]</file> Using <code>win32_game_code</code>.</div></center>
<p>

Let's load the game code before going into <code>GlobalRunning</code>. Later we might need to move it since we'll be swapping it on the fly, but for the time being, it should suffice. We'll then replace the previous calls to the game code we had to use our <code>Game</code>. 

</p><p>

While we're at it, let's remove our debug code for determining sound update frequency. 

</p><pre class="listing tilde"><code><div class=" delete"><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> 0</span></span>
<span class="line"><span class="hljs-comment">// NOTE(casey): This tests the PlayCursor/WriteCursor update frequency</span></span>
<span class="line"><span class="hljs-comment">// On the Handmade Hero machine, it was 480 samples.</span></span>
<span class="line"><span class="hljs-keyword">while</span> (GlobalRunning)</span>
<span class="line">{</span>
<span class="line">    DWORD PlayCursor;</span>
<span class="line">    DWORD WriteCursor;</span>
<span class="line">    GlobalSecondaryBuffer-&gt;GetCurrentPosition(&amp;PlayCursor, &amp;WriteCursor);</span>
<span class="line">    </span>
<span class="line">    <span class="hljs-keyword">char</span> TextBuffer[<span class="hljs-number">256</span>];</span>
<span class="line">    _snprintf_s(TextBuffer, <span class="hljs-keyword">sizeof</span>(TextBuffer),</span>
<span class="line">                <span class="hljs-string">"PC:%u WC:%u\n"</span>, PlayCursor, WriteCursor);</span>
<span class="line">    OutputDebugStringA(TextBuffer);</span>
<span class="line">}</span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span></div><div class=" add"><span class="line">win32_game_code Game = Win32LoadGameCode();</span></div><span class="line">                </span>
<span class="line">u64 LastCycleCount = __rdtsc();</span>
<span class="line"><span class="hljs-keyword">while</span> (GlobalRunning)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">    game_offscreen_buffer Buffer = {};</span>
<span class="line">    Buffer.Memory = GlobalBackbuffer.Memory;</span>
<span class="line">    Buffer.Width = GlobalBackbuffer.Width;</span>
<span class="line">    Buffer.Height = GlobalBackbuffer.Height;</span>
<span class="line">    Buffer.Pitch = GlobalBackbuffer.Pitch;</span><div class=" edit"><span class="line">    Game.UpdateAndRender(&amp;GameMemory, NewInput, &amp;Buffer);</span></div><span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line"></span>
<span class="line">    game_sound_output_buffer SoundBuffer = {};</span>
<span class="line">    SoundBuffer.SamplesPerSecond = SoundOutput.SamplesPerSecond;</span>
<span class="line">    SoundBuffer.SampleCount = BytesToWrite / SoundOutput.BytesPerSample;</span>
<span class="line">    SoundBuffer.Samples = Samples;</span>
<span class="line">    </span><div class=" edit"><span class="line">    Game.GetSoundSamples(&amp;GameMemory, &amp;SoundBuffer);</span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;15:</b> <file>[win32_handmade.cpp > WinMain]</file> Loading Game Code during the game's execution.</div></center>
<p>


Now our Win32 platform layer should compile correctly. When compiling you should see the output like this: 

</p><pre class="listing tilde"><code><span class="line">handmade.cpp</span>
<span class="line">   Creating library handmade.lib and object handmade.exp</span>
<span class="line">handmade.obj : error LNK2019: [linker error description]</span>
<span class="line">handmade.obj : error LNK2019: [linker error description]</span>
<span class="line">handmade.obj : error LNK2019: [linker error description]</span>
<span class="line">handmade.dll : fatal error LNK1120: 3 unresolved externals</span>
<span class="line">win32_handmade.cpp</span></code></pre><p>

This means that we couldn't compile <code>handmade.dll</code> because there were 3 linker errors. On the other hand, <code>win32_handmade.cpp</code> compiled without any issues.

</p><p>

<code>Win32_handmade.exe</code> will be loading game code if the latter is available. But, if you run it, the program should execute its main loop anyway. It display only the debug sound lines because these are all calculated on the platform side. Of course, all the DLL-side functionality will be missing: you'll also a distinct lack of the gradient or sound, and the lines will eventually overlap because we don't clear the screen to black at each frame.

</p>
<a class="target" name="servicestothegame">&nbsp;</a><a class="target" name="separategamefromplatform/servicestothegame">&nbsp;</a><a class="target" name="toc3.5">&nbsp;</a><h2>Services to the Game</h2>
<p>


We have a significant roadblock to overcome for what might concern the game code: how would we load platform-specific services (like reading and writing files)?

</p><p>

We could load the executable in the DLL, load a handle for it and then reverse call the functions. But is it indispensable?

</p><p>

The thing is, when we call <code>GameUpdateAndRender</code> or <code>GameGetSoundSamples</code>, we pass a bunch of different services: things like memory or the buffers to fill. We could simply pass the pointers to whichever platform function the game might want to call. We've seen this already: if you think about the DirectSound buffers, they also come with the respective function pointers to call (things like the famous <code>SecondaryBuffer-&gt;GetCurrentPosition(...)</code>). 

</p><p>

In practice, this will result in the exact same syntax we have for things like XInput or GameUpdateAndRender. Except for this time, instead of calling Windows' function <code>GetProcAddress</code>, we'll straight up pass the function pointers to the game.

</p><p>

As an added benefit, we won't even need the stub functions. 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> HANDMADE_INTERNAL</span></span>
<span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">debug_read_file_result</span></span>
<span class="line">{</span></span>
<span class="line">    u32 ContentsSize;</span>
<span class="line">    <span class="hljs-keyword">void</span> *Contents;</span>
<span class="line">};</span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DEBUG_PLATFORM_FREE_FILE_MEMORY(name) void name (void *Memory)</span></span>
<span class="line"><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">DEBUG_PLATFORM_FREE_FILE_MEMORY</span><span class="hljs-params">(debug_platform_free_file_memory)</span></span>;</span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DEBUG_PLATFORM_READ_ENTIRE_FILE(name) debug_read_file_result name (char *Filename)</span></span>
<span class="line"><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">DEBUG_PLATFORM_READ_ENTIRE_FILE</span><span class="hljs-params">(debug_platform_read_entire_file)</span></span>;</span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DEBUG_PLATFORM_WRITE_ENTIRE_FILE(name) b32 name (char *Filename, u32 MemorySize, void *Memory)</span></span>
<span class="line"><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">DEBUG_PLATFORM_WRITE_ENTIRE_FILE</span><span class="hljs-params">(debug_platform_write_entire_file)</span></span>;</span>
<span class="line"></span></div><div class=" delete"><span class="line"><span class="hljs-function">debug_read_file_result <span class="hljs-title">DEBUGPlatformReadEntireFile</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *Filename)</span></span>;</span>
<span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DEBUGPlatformFreeFileMemory</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *Memory)</span></span>;</span>
<span class="line"><span class="hljs-function">b32 <span class="hljs-title">DEBUGPlatformWriteEntireFile</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *Filename, u32 MemorySize, <span class="hljs-keyword">void</span> *Memory)</span></span>;</span></div><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;16:</b> <file>[handmade.h]</file> Introducing types for our file signatures.</div></center>
<p>


These somewhat verbose names should, however, be quite descriptive in what they do. They are Debug, so they shouldn't be used in user-facing code, They're platform-independent, and they do a specific operation, like reading a file, writing to a file, or freeing its memory.

</p><p>

This allows passing the function pointers as if they were other types: <code>int</code>, <code>DWORD</code>, <code>u32</code>... <code>debug_platform_write_entire_file</code> has now become just another <em class="underscore">type</em>.

</p><p>

Again, as an optional step to potentially prevent headaches in the future, let's replace the signature of the function definitions in <code>win32_handmade.cpp</code> with our macros: 

</p><pre class="listing tilde"><code><div class=" edit"><span class="line">DEBUG_PLATFORM_FREE_FILE_MEMORY(DEBUGPlatformFreeFileMemory)</span></div><span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">}</span>
<span class="line"></span><div class=" edit"><span class="line">DEBUG_PLATFORM_READ_ENTIRE_FILE(DEBUGPlatformReadEntireFile)</span></div><span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">}</span>
<span class="line"></span><div class=" edit"><span class="line">DEBUG_PLATFORM_WRITE_ENTIRE_FILE(DEBUGPlatformWriteEntireFile)</span></div><span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;17:</b> <file>[win32_handmade.cpp]</file> Using signature shortcuts.</div></center>
<p>


Now, how do we pass these to the game? Well, we are passing the memory by packaging it in <code>game_memory</code> structure. We can expand it to include the pointers to these functions as follows: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">game_memory</span></span>
<span class="line">{</span></span>
<span class="line">    u64 PermanentStorageSize;</span>
<span class="line">    <span class="hljs-keyword">void</span> *PermanentStorage;</span>
<span class="line">    u64 TransientStorageSize;</span>
<span class="line">    <span class="hljs-keyword">void</span> *TransientStorage;</span>
<span class="line">    b32 IsInitialized;</span>
<span class="line">    </span><div class=" add"><span class="line">    debug_platform_free_file_memory *DEBUGPlatformFreeFileMemory;</span>
<span class="line">    debug_platform_read_entire_file *DEBUGPlatformReadEntireFile;</span>
<span class="line">    debug_platform_write_entire_file *DEBUGPlatformWriteEntireFile;</span></div><span class="line">};</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;18:</b> <file>[handmade.h]</file> Introducing type pointers for our file signatures.</div></center>
<p>


Of course, we should remember to actually pass the pointers so that we don't crash and burn painfully (Attempting to call a function located at sector 0 is a good way to crash, that's how we do our <code>Assert</code> right now).

</p><pre class="listing tilde"><code><span class="line">game_memory GameMemory = {};</span>
<span class="line">GameMemory.PermanentStorageSize = Megabytes(<span class="hljs-number">64</span>);</span>
<span class="line">GameMemory.TransientStorageSize = Gigabytes(<span class="hljs-number">1</span>);</span><div class=" add"><span class="line">GameMemory.DEBUGPlatformFreeFileMemory = DEBUGPlatformFreeFileMemory;</span>
<span class="line">GameMemory.DEBUGPlatformReadEntireFile = DEBUGPlatformReadEntireFile;</span>
<span class="line">GameMemory.DEBUGPlatformWriteEntireFile = DEBUGPlatformWriteEntireFile;</span></div><span class="line">u64 TotalStorageSize = (GameMemory.PermanentStorageSize + GameMemory.TransientStorageSize);</span>
<span class="line"></span>
<span class="line">GameMemory.PermanentStorage = VirtualAlloc(BaseAddress, (<span class="hljs-keyword">size_t</span>)TotalStorageSize,</span>
<span class="line">                                            MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);</span>
<span class="line">GameMemory.TransientStorage = ((u8 *)GameMemory.PermanentStorage +</span>
<span class="line">                                GameMemory.PermanentStorageSize);</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;19:</b> <file>[win32_handmade.cpp]</file> Passing function pointers.</div></center>
<p>

Finally, we need to actually use these functions in the game. We aren't doing anything useful with them right now, we simply have this block for testing: 

</p><pre class="listing tilde"><code><span class="line">debug_read_file_result FileData = DEBUGPlatformReadEntireFile(__FILE__);</span>
<span class="line"><span class="hljs-keyword">if</span> (FileData.Contents)</span>
<span class="line">{</span>
<span class="line">    DEBUGPlatformWriteEntireFile(<span class="hljs-string">"test.out"</span>, FileData.ContentsSize, FileData.Contents);</span>
<span class="line">    DEBUGPlatformFreeFileMemory(FileData.Contents);</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><file>[handmade.cpp]</file></div></center>
<p>


We pass <code>game_memory</code> as a pointer named <code>Memory</code>. So, in order to use the functions we will simply <em class="underscore">dereference</em> them from the pointer (with the <code>-&gt;</code> operator).

</p><pre class="listing tilde"><code><div class=" edit"><span class="line">debug_read_file_result FileData = Memory-&gt;DEBUGPlatformReadEntireFile(__FILE__);</span></div><span class="line"><span class="hljs-keyword">if</span> (FileData.Contents)</span>
<span class="line">{</span><div class=" edit"><span class="line">    Memory-&gt;DEBUGPlatformWriteEntireFile(<span class="hljs-string">"test.out"</span>, FileData.ContentsSize, FileData.Contents);</span>
<span class="line">    Memory-&gt;DEBUGPlatformFreeFileMemory(FileData.Contents);</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;20:</b> <file>[handmade.cpp]</file> Using function pointers.</div></center>
<p>
  
And... that's it.

</p><p>

What we did here is a much simpler version of something called a VTable in C++, almost a Memory Dispatch of sorts. The major difference is that, in C++, all of this happens under the hood. Here, we remove this functionality from its proverbial black box so that we can see what it does and do whatever we want with it. 

</p><p>

But there's still one caveat we haven't discussed yet: name mangling.

</p>
<a class="target" name="guardagainstnamemangling">&nbsp;</a><a class="target" name="separategamefromplatform/guardagainstnamemangling">&nbsp;</a><a class="target" name="toc3.6">&nbsp;</a><h2>Guard Against Name Mangling</h2>
<p>


If you remember, we recently encountered the absolutely out-of-the-world names in our linker errors: something like <code>GameUpdateAndRender@@YAXPEAUgame_memory@@PEAUgame_input@@PEAUgame_offscreen_buffer@@@Z</code>. As we discussed on <a href="../html/day16.html">day 16</a>, this is called <a href="https://en.wikipedia.org/wiki/Name_mangling">name mangling</a>, and it's a compiler technique to distinguish functions with the same name but different signatures. It becomes even more necessary in a universe where you have classes and namespaces; each may have multiple instances of the same function name... Something that you see a lot in C++.

</p><p>

We don't need any of this, even less so in our exported functions. Luckily, there's a way to disable name mangling for specific functions (or even bigger code blocks). To do that, you need to use a very unique function prefix <code>extern &quot;C&quot;</code>. This effectively regresses whatever code block you're using from C++ to C, and the latter doesn't support function overloading nor allows name mangling. Problem solved, right? 

</p><p>

Well, yes and no. You see, now this code cannot be compiled in C anymore. So what you need to do is verify first if the program is being compiled in C++ mode! The final code becomes like this: 

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined __cplusplus</span></span>
<span class="line"><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span></div><span class="line">GAME_UPDATE_AND_RENDER(GameUpdateAndRender)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">}</span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined __cplusplus</span></span>
<span class="line"><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span></div><span class="line">GAME_GET_SOUND_SAMPLES(GameGetSoundSamples)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;20:</b> <file>[handmade.cpp]</file> Avoiding name mangling.</div></center>
<p>

Finally, we can compile everything without errors. If you want to verify that the necessary functions are exported correctly, Visual Studio packages the utility <code>dumpbin</code> that you can call for this exact purpose. Simply type `dumpbin /exports [path-to-dll]/handmade.dll in your console to hopefully see the following: 

</p><pre class="listing tilde"><code><div class=" add"><span class="line">W:\handmade&gt;dumpbin /exports build\handmade.dll</span></div><span class="line">Microsoft (R) COFF/PE Dumper Version XX.XX.XXXXX.X</span>
<span class="line">Copyright (C) Microsoft Corporation.  All rights reserved.</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">Dump of file build\handmade.dll</span>
<span class="line"></span>
<span class="line">File Type: DLL</span>
<span class="line"></span>
<span class="line">  Section contains the following exports for handmade.dll</span>
<span class="line"></span>
<span class="line">    00000000 characteristics</span>
<span class="line">    FFFFFFFF time date stamp</span>
<span class="line">        0.00 version</span>
<span class="line">           1 ordinal base</span>
<span class="line">           2 number of functions</span>
<span class="line">           2 number of names</span>
<span class="line"></span>
<span class="line">    ordinal hint RVA      name</span>
<span class="line"></span>
<span class="line">          1    0 000014D0 GameGetSoundSamples = GameGetSoundSamples</span>
<span class="line">          2    1 00001270 GameUpdateAndRender = GameUpdateAndRender</span>
<span class="line"></span>
<span class="line">  Summary</span>
<span class="line"></span>
<span class="line">        2000 .data</span>
<span class="line">        1000 .pdata</span>
<span class="line">        A000 .rdata</span>
<span class="line">        1000 .reloc</span>
<span class="line">        C000 .text</span>
<span class="line">        1000 _RDATA</span></code></pre><center><div class="listingcaption tilde"><file>[Command Prompt]</file></div></center>
<p>

If you see the exported functions <code>GameUpdateAndRender</code> and <code>GameGetSoundSamples</code>, great! If not, the game will not see them and <code>GetProcAddress</code> will fail. In such case verify if, for example, you included <code>%dll_link%</code> in your <code>build.bat</code> file.

</p><p>

If everything's in order, run the game. Success!

</p>
<a class="target" name="dynamicreloading">&nbsp;</a><a class="target" name="dynamicreloading">&nbsp;</a><a class="target" name="toc4">&nbsp;</a><h1>Dynamic Reloading</h1>
<p>


So far, we didn't do a whole lot. We basically replicated the functionality that we already had of the game functions loading with the rest of the game. Now we can add the thing we set off doing in the first place: dynamic code reloading!

</p><p>

Today we won't make the entire thing. Some parts of it will need to be fleshed out next time, we'll just make the quick and dirty change.

</p>
<a class="target" name="unloadgamecode">&nbsp;</a><a class="target" name="dynamicreloading/unloadgamecode">&nbsp;</a><a class="target" name="toc4.1">&nbsp;</a><h2>Unload Game Code</h2>
<p>


To load a new version of the DLL (and even try to recompile it), we need to unload the old version first. You can imagine it by simply calling a function like <code>Win32UnloadGameCode</code>.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">internal win32_game_code</span>
<span class="line"><span class="hljs-title">Win32LoadGameCode</span><span class="hljs-params">()</span></span>
<span class="line"></span>{</span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">}</span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">Win32UnloadGameCode</span><span class="hljs-params">(win32_game_code *GameCode)</span></span>
<span class="line"></span>{</span>
<span class="line">    <span class="hljs-keyword">if</span> (GameCode-&gt;GameCodeDLL)</span>
<span class="line">    {</span>
<span class="line">        FreeLibrary(GameCode-&gt;GameCodeDLL);</span>
<span class="line">        GameCode-&gt;GameCodeDLL = <span class="hljs-number">0</span>;</span>
<span class="line">    }</span>
<span class="line">    </span>
<span class="line">    GameCode-&gt;IsValid = <span class="hljs-literal">false</span>;</span>
<span class="line">    GameCode-&gt;UpdateAndRender = GameUpdateAndRenderStub;</span>
<span class="line">    GameCode-&gt;GetSoundSamples = GameGetSoundSamplesStub;</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;21:</b> <file>[win32_handmade.cpp]</file> Introducing <code>Win32UnloadGameCode</code>.</div></center>
<p>


Let's do something ridiculous and do the game loading and unloading at each frame.

</p><pre class="listing tilde"><code><span class="line">win32_game_code Game = Win32LoadGameCode();</span>
<span class="line">            </span>
<span class="line">u64 LastCycleCount = __rdtsc();</span>
<span class="line"><span class="hljs-keyword">while</span> (GlobalRunning)</span>
<span class="line">{</span><div class=" add"><span class="line">    Win32UnloadGameCode(&amp;Game);</span>
<span class="line">    Game = Win32LoadGameCode();</span></div>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;22:</b> <file>[win32_handmade.cpp]</file> Reloading the game code at each frame.</div></center>
<p>


It works! Somewhat. We still cannot reap the benefits since the change happens so quickly that we don't have time to recompile the code. Also, you might uncover a sound bug. Let's investigate it. 

</p><p>

<div class="admonition warning"><div class="admonition-title"> </div>

</p><p>

    Feel free to find the bug yourself and then check the solution in subsection  <a href="#toc6.1">6.1</a>.</div>

</p>
<a class="target" name="slowdownreloading">&nbsp;</a><a class="target" name="dynamicreloading/slowdownreloading">&nbsp;</a><a class="target" name="toc4.2">&nbsp;</a><h2>Slow Down Reloading</h2>
<p>


Right now we are reloading our DLL 30 times per second. That's a lot of unnecessary I/O. In the future, we'll try to find a way to detect changes in the DLL, but for now, let's simply add a timer, so that the DLL reload attempt happens only every few seconds: 

</p><pre class="listing tilde"><code><span class="line">win32_game_code Game = Win32LoadGameCode();</span><div class=" add "><span class="line">u32 LoadCounter = <span class="hljs-number">0</span>;</span></div><span class="line"></span>
<span class="line">u64 LastCycleCount = __rdtsc();</span>
<span class="line"><span class="hljs-keyword">while</span> (GlobalRunning)</span>
<span class="line">{</span><div class=" add"><span class="line">    <span class="hljs-keyword">if</span> (LoadCounter++ &gt; <span class="hljs-number">120</span>)</span>
<span class="line">    {</span></div><span class="line">        Win32UnloadGameCode(&amp;Game);</span>
<span class="line">        Game = Win32LoadGameCode();</span><div class=" add"><span class="line">        LoadCounter = <span class="hljs-number">0</span>;</span>
<span class="line">    }</span></div><span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;23:</b> <file>[win32_handmade.cpp > WinMain]</file> Adding <code>LoadCounter</code>.</div></center>

<a class="target" name="allowdllrewriting">&nbsp;</a><a class="target" name="dynamicreloading/allowdllrewriting">&nbsp;</a><a class="target" name="toc4.3">&nbsp;</a><h2>Allow DLL Rewriting</h2>
<p>


Even if the reloading is happening every few seconds, we still can't recompile the DLL because unloading and loading occur back to back.

</p><p>

We can add a quick and dirty solution now and flesh it out next time. This solution won't work inside the debugger for several reasons, but it will work if you simply run <code>win32_handmade.exe</code> directly from Windows.

</p><p>

The solution is simply to copy our DLL to another location and load it from there. To do this, we'll use the aptly named <code>CopyFile</code> function (<a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-copyfile">MSDN</a> reference) inside <code>Win32LoadGameCode</code>: 

</p><pre class="listing tilde"><code><span class="line">win32_game_code Result = {};</span>
<span class="line">    </span><div class=" add"><span class="line">CopyFile(<span class="hljs-string">"handmade.dll"</span>, <span class="hljs-string">"handmade_temp.dll"</span>, FALSE);</span></div><div class=" edit"><span class="line">Result.GameCodeDLL = LoadLibraryA(<span class="hljs-string">"handmade_temp.dll"</span>);</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;24:</b> <file>[win32_handmade.cpp > Win32LoadGameCode]</file> Copying file for loading.</div></center>
<p>


If you've done everything correctly, you can now do live code editing as on the video below!

</p><p>

<center><div class="image" style=""><a href="../media/day21/live_editing.gif" target="_blank"><img class="markdeep" src="../media/day21/live_editing.gif" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;4:</b> Live code editing!</span></center></div></center> 

</p>
<a class="target" name="recap">&nbsp;</a><a class="target" name="recap">&nbsp;</a><a class="target" name="toc5">&nbsp;</a><h1>Recap</h1>
<p>


We can now edit our game on the fly, and the state is preserved! We don't need to do anything, almost as good as having a scripting language.

</p><p>

The system is not perfect yet, though. For the time being, we can't use our debugger; besides, there're other things to potentially tune up (like waiting 4 seconds before reloading).

</p><p>

We'll do it all next time.

</p>
<a class="target" name="sidedebugging">&nbsp;</a><a class="target" name="sidedebugging">&nbsp;</a><a class="target" name="toc6">&nbsp;</a><h1>Side Debugging</h1>

<a class="target" name="fixsoundissue">&nbsp;</a><a class="target" name="sidedebugging/fixsoundissue">&nbsp;</a><a class="target" name="toc6.1">&nbsp;</a><h2>Fix Sound Issue</h2>
<p>


Let's inspect our sound code inside <code>handmade.cpp</code>:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">GameSoundOutput</span><span class="hljs-params">(game_sound_output_buffer *SoundBuffer, <span class="hljs-keyword">int</span> ToneHz)</span></span>
<span class="line"></span>{</span>
<span class="line">    local_persist f32 tSine;</span>
<span class="line">    s16 ToneVolume = <span class="hljs-number">3000</span>;</span>
<span class="line">    <span class="hljs-keyword">int</span> WavePeriod = SoundBuffer-&gt;SamplesPerSecond / ToneHz;</span>
<span class="line">    </span>
<span class="line">    s16 *SampleOut = SoundBuffer-&gt;Samples;</span>
<span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> SampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line">         SampleIndex &lt; SoundBuffer-&gt;SampleCount;</span>
<span class="line">         ++SampleIndex)</span>
<span class="line">    {</span>
<span class="line">        f32 SineValue = sinf(tSine);</span>
<span class="line">        s16 SampleValue = (s16)(SineValue * ToneVolume);</span>
<span class="line">        </span>
<span class="line">        *SampleOut++ = SampleValue;</span>
<span class="line">        *SampleOut++ = SampleValue;</span>
<span class="line">        tSine += <span class="hljs-number">2.0f</span> * Pi32 * <span class="hljs-number">1.0f</span> / (f32)WavePeriod;</span>
<span class="line">        </span>
<span class="line">        <span class="hljs-keyword">if</span> (tSine &gt; <span class="hljs-number">2.0f</span> * Pi32)</span>
<span class="line">        {</span>
<span class="line">            tSine -= <span class="hljs-number">2.0f</span> * Pi32;</span>
<span class="line">        }</span>
<span class="line">    }</span>
<span class="line">}</span></code></pre><p>

After a short inspection, it's clear to us that the culprit is <code>tSine</code>, a variable we use to calculate the sound oscillation in our debug code. It's a static variable (<code>local_persist</code>), and, as such, it has its own block of memory allocated on the stack. When the DLL is reloaded, all of its static data is reset, <code>tSine</code> resets to zero, thus producing sound bug.

</p><p>

It's time for our <code>tSine</code> to move to <code>GameState</code>, the dedicated block of memory that we take from the persistent memory and use for our game code. 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">game_state</span></span>
<span class="line">{</span></span>
<span class="line">    <span class="hljs-keyword">int</span> ToneHz;</span><div class=" add"><span class="line">    f32 tSine;</span></div><span class="line"></span>
<span class="line">    <span class="hljs-keyword">int</span> XOffset;</span>
<span class="line">    <span class="hljs-keyword">int</span> YOffset;   </span>
<span class="line">};</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;25:</b> <file>[handmade.h]</file> Updating <code>game_state</code> structure.</div></center>
<p>


Now we can change our <code>GameSoundOutput</code> code to actually use the correct <code>tSine</code>. We also need to pass the pointer to the game state, which you'll grow to do by default as this course progresses.

</p><pre class="listing tilde"><code><span class="line">internal <span class="hljs-keyword">void</span></span><div class=" edit"><span class="line">GameSoundOutput(game_state *GameState, game_sound_output_buffer *SoundBuffer, <span class="hljs-keyword">int</span> ToneHz)</span></div><span class="line">{</span><div class=" delete"><span class="line">    local_persist f32 tSine;</span></div><span class="line">    s16 ToneVolume = <span class="hljs-number">3000</span>;</span>
<span class="line">    <span class="hljs-keyword">int</span> WavePeriod = SoundBuffer-&gt;SamplesPerSecond / ToneHz;</span>
<span class="line">    </span>
<span class="line">    s16 *SampleOut = SoundBuffer-&gt;Samples;</span>
<span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> SampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line">         SampleIndex &lt; SoundBuffer-&gt;SampleCount;</span>
<span class="line">         ++SampleIndex)</span>
<span class="line">    {</span><div class=" edit"><span class="line">        f32 SineValue = sinf(GameState-&gt;tSine);</span></div><span class="line">        s16 SampleValue = (s16)(SineValue * ToneVolume);</span>
<span class="line">        </span>
<span class="line">        *SampleOut++ = SampleValue;</span>
<span class="line">        *SampleOut++ = SampleValue;</span><div class=" edit"><span class="line">        GameState-&gt;tSine += <span class="hljs-number">2.0f</span> * Pi32 * <span class="hljs-number">1.0f</span> / (f32)WavePeriod;</span>
<span class="line">        </span>
<span class="line">        <span class="hljs-keyword">if</span> (GameState-&gt;tSine &gt; <span class="hljs-number">2.0f</span> * Pi32)</span>
<span class="line">        {</span>
<span class="line">            GameState-&gt;tSine -= <span class="hljs-number">2.0f</span> * Pi32;</span>
<span class="line">        }</span></div><span class="line">    }</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line"><span class="hljs-comment">// ... </span></span>
<span class="line"></span>
<span class="line">GAME_GET_SOUND_SAMPLES(GameGetSoundSamples)</span>
<span class="line">{</span>
<span class="line">    game_state *GameState = (game_state*)Memory;</span><div class=" edit"><span class="line">    GameSoundOutput(GameState, SoundBuffer, GameState-&gt;ToneHz);</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;26:</b> <file>[handmade.cpp]</file> Using <code>tSine</code> stored in the game state.</div></center>
<p>


Once the code is recompiled, you'll notice that the sound bug has gone away. Modern computers are <em class="underscore">fast</em> (and our code is small)!

</p><p>

<em class="underscore">(Continue to Subsection  <a href="#toc4.2">4.2</a>)</em>

</p>
<a class="target" name="navigation">&nbsp;</a><a class="target" name="navigation">&nbsp;</a><a class="target" name="toc7">&nbsp;</a><h1>Navigation</h1>
<p>


Previous: <a href="../html/day20.html">Day 20. Debugging the Audio Sync</a>

</p><p>

Up Next: <a href="../html/day21.html">Day 21. Instantaneous Live Code Editing</a>

</p><p>

<a href="../index.md.html">Back to Index</a>

</p>
<div class="nonumberh1">Glossary </div>
<p>


<ul>
<li class="asterisk">Memory dispatch
</li>
<li class="asterisk">Monolithic
</li>
<li class="asterisk">Name Mangling
</li>
<li class="asterisk">Translation unit
</li>
<li class="asterisk">Exported functions</li></ul>

</p>
<div class="nonumberh1">MSDN</div>
<p>


<a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-copyfile">CopyFile</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/cpp/build/reference/export-exports-a-function?view=msvc-160">/EXPORT linker switch</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/cpp/build/reference/md-mt-ld-use-run-time-library?view=msvc-160">/LD compiler switch</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary">FreeLibrary</a>

</p>
<div class="nonumberh1">Terms and definitions</div>
<p>


<a href="https://en.wikipedia.org/wiki/Monolithic_application">Monolithic architecture</a>

</p><p>

<a href="https://en.wikipedia.org/wiki/Name_mangling">Name Mangling</a>

</p><p>

<style class="fallback">
  body {
    visibility: hidden;
    font-family: sans-serif;
  }
</style>

</p><p>

<script>
  markdeepOptions = { tocStyle: 'long' };
  window.alreadyProcessedMarkdeep ||
    (document.body.style.visibility = 'visible');
</script>
</stdint.h></math.h></dsound.h></xinput.h></stdio.h></windows.h></stdint.h></math.h></p></span><div id="mdContextMenu" style="visibility:hidden"></div><div class="markdeepFooter"><i>formatted by <a href="https://casual-effects.com/markdeep" style="color:#999">Markdeep&nbsp;1.10&nbsp;&nbsp;</a></i><div style="display:inline-block;font-size:13px;font-family:'Times New Roman',serif;vertical-align:middle;transform:translate(-3px,-1px)rotate(135deg);">&#x2712;</div></div>