<meta charset="UTF-8"><meta http-equiv="content-type" content="text/html;charset=UTF-8"><meta name="viewport" content="width=600, initial-scale=1"><style>body{max-width:680px;margin:auto;padding:20px;text-align:justify;line-height:140%; -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-smoothing:antialiased;color:#222;font-family:Palatino,Georgia,"Times New Roman",serif}</style><style>@media print{*{-webkit-print-color-adjust:exact;text-shadow:none !important}}body{counter-reset: h1 h2 h3 h4 h5 h6 paragraph}@page{margin:0;size:auto}#mdContextMenu{position:absolute;background:#383838;cursor:default;border:1px solid #999;color:#fff;padding:4px 0px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,"Helvetica Neue",sans-serif;font-size:85%;font-weight:600;border-radius:4px;box-shadow:0px 3px 10px rgba(0,0,0,35%)}#mdContextMenu div{padding:0px 20px}#mdContextMenu div:hover{background:#1659d1}.md code,.md pre{font-family:Menlo,Consolas,monospace;font-size:98%;text-align:left;line-height:140%}.md .mediumToc code,.md longToc code,.md .shortToc code,.md h1 code,.md h2 code,.md h3 code,.md h4 code,.md h5 code,.md h6 code{font-size:unset}.md div.title{font-size:26px;font-weight:800;line-height:120%;text-align:center}.md div.afterTitles{height:10px}.md div.subtitle{text-align:center}.md iframe.textinsert, .md object.textinsert,.md iframe:not(.markdeep){display:block;margin-top:10px;margin-bottom:10px;width:100%;height:75vh;border:1px solid #000;border-radius:4px;background:#f5f5f4}.md .image{display:inline-block}.md img{max-width:100%;page-break-inside:avoid}.md li{text-align:left;text-indent:0}.md pre.listing {width:100%;tab-size:4;-moz-tab-size:4;-o-tab-size:4;counter-reset:line;overflow-x:auto;resize:horizontal}.md pre.listing .linenumbers span.line:before{width:30px;margin-left:-28px;font-size:80%;text-align:right;counter-increment:line;content:counter(line);display:inline-block;padding-right:13px;margin-right:8px;color:#ccc}.md div.tilde{margin:20px 0 -10px;text-align:center}.md .imagecaption,.md .tablecaption,.md .listingcaption{display:inline-block;margin:7px 5px 12px;text-align:justify;font-style:italic}.md img.pixel{image-rendering:-moz-crisp-edges;image-rendering:pixelated}.md blockquote.fancyquote{margin:25px 0 25px;text-align:left;line-height:160%}.md blockquote.fancyquote::before{content:"“";color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-right:6px;vertical-align:-0.3em}.md span.fancyquote{font-size:118%;color:#777;font-style:italic}.md span.fancyquote::after{content:"”";font-style:normal;color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-left:6px;vertical-align:-0.3em}.md blockquote.fancyquote .author{width:100%;margin-top:10px;display:inline-block;text-align:right}.md small{font-size:60%}.md big{font-size:150%}.md div.title,contents,.md .tocHeader,.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .shortTOC,.md .mediumTOC,.nonumberh1,.nonumberh2,.nonumberh3,.nonumberh4,.nonumberh5,.nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;margin:13.4px 0 13.4px;padding:15px 0 3px;border-top:none;clear:both}.md .tocTop {display:none}.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .nonumberh1,.md .nonumberh2,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{page-break-after:avoid;break-after:avoid}.md svg.diagram{display:block;font-family:Menlo,Consolas,monospace;font-size:98%;text-align:center;stroke-linecap:round;stroke-width:2px;page-break-inside:avoid;stroke:#000;fill:#000}.md svg.diagram .opendot{fill:#fff}.md svg.diagram .shadeddot{fill:#CCC}.md svg.diagram .dotteddot{stroke:#000;stroke-dasharray:4;fill:none}.md svg.diagram text{stroke:none}@media print{@page{margin:1in 5mm;transform: scale(150%)}}@media print{.md .pagebreak{page-break-after:always;visibility:hidden}}.md a{font-family:Georgia,Palatino,'Times New Roman'}.md h1,.md .tocHeader,.md .nonumberh1{border-bottom:3px solid;font-size:20px;font-weight:bold;}.md h1,.md .nonumberh1{counter-reset: h2 h3 h4 h5 h6}.md h2,.md .nonumberh2{counter-reset: h3 h4 h5 h6;border-bottom:2px solid #999;color:#555;font-weight:bold;font-size:18px;}.md h3,.md h4,.md h5,.md h6,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;color:#555;font-size:16px;}.md h3{counter-reset:h4 h5 h6}.md h4{counter-reset:h5 h6}.md h5{counter-reset:h6}.md div.table{margin:16px 0 16px 0}.md table{border-collapse:collapse;line-height:140%;page-break-inside:avoid}.md table.table{margin:auto}.md table.calendar{width:100%;margin:auto;font-size:11px;font-family:Verdana,Helvetica,Arial,sans-serif}.md table.calendar th{font-size:16px}.md .today{background:#ECF8FA}.md .calendar .parenthesized{color:#999;font-style:italic}.md table.table th{color:#FFF;background-color:#AAA;border:1px solid #888;padding:8px 15px 8px 15px}.md table.table td{padding:5px 15px 5px 15px;border:1px solid #888}.md table.table tr:nth-child(even){background:#EEE}.md pre.tilde{border-top: 1px solid #CCC;border-bottom: 1px solid #CCC;padding: 5px 0 5px 20px;margin:0 0 0 0;background:#FCFCFC;page-break-inside:avoid}.md a.target{width:0px;height:0px;visibility:hidden;font-size:0px;display:inline-block}.md a:link, .md a:visited{color:#38A;text-decoration:none}.md a:link:hover{text-decoration:underline}.md dt{font-weight:700}.md dl>dd{margin-top:-8px; margin-bottom:8px}.md dl>table{margin:35px 0 30px}.md code{page-break-inside:avoid;} @media print{.md .listing code{white-space:pre-wrap}}.md .endnote{font-size:13px;line-height:15px;padding-left:10px;text-indent:-10px}.md .bib{padding-left:80px;text-indent:-80px;text-align:left}.markdeepFooter{font-size:9px;text-align:right;padding-top:80px;color:#999}.md .mediumTOC{float:right;font-size:12px;line-height:15px;border-left:1px solid #CCC;padding-left:15px;margin:15px 0px 15px 25px}.md .mediumTOC .level1{font-weight:600}.md .longTOC .level1{font-weight:600;display:block;padding-top:12px;margin:0 0 -20px}.md .shortTOC{text-align:center;font-weight:bold;margin-top:15px;font-size:14px}.md .admonition{position:relative;margin:1em 0;padding:.4rem 1rem;border-radius:.2rem;border-left:2.5rem solid rgba(68,138,255,.4);background-color:rgba(68,138,255,.15);}.md .admonition-title{font-weight:bold;border-bottom:solid 1px rgba(68,138,255,.4);padding-bottom:4px;margin-bottom:4px;margin-left: -1rem;padding-left:1rem;margin-right:-1rem;border-color:rgba(68,138,255,.4)}.md .admonition.tip{border-left:2.5rem solid rgba(50,255,90,.4);background-color:rgba(50,255,90,.15)}.md .admonition.tip::before{content:"\24d8";font-weight:bold;font-size:150%;position:relative;top:3px;color:rgba(26,128,46,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.tip>.admonition-title{border-color:rgba(50,255,90,.4)}.md .admonition.warn,.md .admonition.warning{border-left:2.5rem solid rgba(255,145,0,.4);background-color:rgba(255,145,0,.15)}.md .admonition.warn::before,.md .admonition.warning::before{content:"\26A0";font-weight:bold;font-size:150%;position:relative;top:2px;color:rgba(128,73,0,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.warn>.admonition-title,.md .admonition.warning>.admonition-title{border-color:rgba(255,145,0,.4)}.md .admonition.error{border-left: 2.5rem solid rgba(255,23,68,.4);background-color:rgba(255,23,68,.15)}.md .admonition.error>.admonition-title{border-color:rgba(255,23,68,.4)}.md .admonition.error::before{content: "\2612";font-family:"Arial";font-size:200%;position:relative;color:rgba(128,12,34,.8);top:-2px;left:-3rem;display:block;width:0;height:0}.md .admonition p:last-child{margin-bottom:0}.md li.checked,.md li.unchecked{list-style:none;overflow:visible;text-indent:-1.2em}.md li.checked:before,.md li.unchecked:before{content:"\2611";display:block;float:left;width:1em;font-size:120%}.md li.unchecked:before{content:"\2610"}</style><style>.md h1::before {
content:counter(h1) " ";
counter-increment: h1;margin-right:10px}.md h2::before {
content:counter(h1) "."counter(h2) " ";
counter-increment: h2;margin-right:10px}.md h3::before {
content:counter(h1) "."counter(h2) "."counter(h3) " ";
counter-increment: h3;margin-right:10px}.md h4::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) " ";
counter-increment: h4;margin-right:10px}.md h5::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) " ";
counter-increment: h5;margin-right:10px}.md h6::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) "."counter(h6) " ";
counter-increment: h6;margin-right:10px}</style><style>.hljs{display:block;overflow-x:auto;padding:0.5em;background:#fff;color:#000;-webkit-text-size-adjust:none}.hljs-comment{color:#006a00}.hljs-keyword{color:#02E}.hljs-literal,.nginx .hljs-title{color:#aa0d91}.method,.hljs-list .hljs-title,.hljs-tag .hljs-title,.setting .hljs-value,.hljs-winutils,.tex .hljs-command,.http .hljs-title,.hljs-request,.hljs-status,.hljs-name{color:#008}.hljs-envvar,.tex .hljs-special{color:#660}.hljs-string{color:#c41a16}.hljs-tag .hljs-value,.hljs-cdata,.hljs-filter .hljs-argument,.hljs-attr_selector,.apache .hljs-cbracket,.hljs-date,.hljs-regexp{color:#080}.hljs-sub .hljs-identifier,.hljs-pi,.hljs-tag,.hljs-tag .hljs-keyword,.hljs-decorator,.ini .hljs-title,.hljs-shebang,.hljs-prompt,.hljs-hexcolor,.hljs-rule .hljs-value,.hljs-symbol,.hljs-symbol .hljs-string,.hljs-number,.css .hljs-function,.hljs-function .hljs-title,.coffeescript .hljs-attribute{color:#A0C}.hljs-function .hljs-title{font-weight:bold;color:#000}.hljs-class .hljs-title,.smalltalk .hljs-class,.hljs-type,.hljs-typename,.hljs-tag .hljs-attribute,.hljs-doctype,.hljs-class .hljs-id,.hljs-built_in,.setting,.hljs-params,.clojure .hljs-attribute{color:#5c2699}.hljs-variable{color:#3f6e74}.css .hljs-tag,.hljs-rule .hljs-property,.hljs-pseudo,.hljs-subst{color:#000}.css .hljs-class,.css .hljs-id{color:#9b703f}.hljs-value .hljs-important{color:#ff7700;font-weight:bold}.hljs-rule .hljs-keyword{color:#c5af75}.hljs-annotation,.apache .hljs-sqbracket,.nginx .hljs-built_in{color:#9b859d}.hljs-preprocessor,.hljs-preprocessor *,.hljs-pragma{color:#643820}.tex .hljs-formula{background-color:#eee;font-style:italic}.diff .hljs-header,.hljs-chunk{color:#808080;font-weight:bold}.diff .hljs-change{background-color:#bccff9}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-comment .hljs-doctag{font-weight:bold}.method .hljs-id{color:#000}</style><style>div.title { padding-top: 40px; } div.afterTitles { height: 15px; }</style><meta charset="utf-8">
<link rel="stylesheet" href="../css/style.css">

<script>Object.defineProperty(screen, "availTop", { value: 0 });
Object.defineProperty(screen, "availLeft", { value: 0 });
Object.defineProperty(screen, "availWidth", { value: 1920 });
Object.defineProperty(screen, "availHeight", { value: 1080 });
Object.defineProperty(screen, "colorDepth", { value: 24 });
Object.defineProperty(screen, "pixelDepth", { value: 24 });
Object.defineProperty(navigator, "hardwareConcurrency", { value: 8 });
Object.defineProperty(navigator, "userAgent", { value: "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:78.0) Gecko/20100101 Firefox/78.0" });
Object.defineProperty(navigator, "appVersion", { value: "5.0 (Windows)" });
Object.defineProperty(navigator, "doNotTrack", { value: "unspecified" });
window.screenY = 1072
window.screenTop = 1072

                try {
                    window.top.window.outerHeight = 1066

                } catch (e) {}
            window.screenX = 1912
window.screenLeft = 1912

                try {
                    window.top.window.outerWidth = 1936

                } catch (e) {}
            </script><script>Object.defineProperty(screen, "availTop", { value: 0 });
Object.defineProperty(screen, "availLeft", { value: 0 });
Object.defineProperty(screen, "availWidth", { value: 1920 });
Object.defineProperty(screen, "availHeight", { value: 1080 });
Object.defineProperty(screen, "colorDepth", { value: 24 });
Object.defineProperty(screen, "pixelDepth", { value: 24 });
Object.defineProperty(navigator, "hardwareConcurrency", { value: 8 });
Object.defineProperty(navigator, "userAgent", { value: "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:78.0) Gecko/20100101 Firefox/78.0" });
Object.defineProperty(navigator, "appVersion", { value: "5.0 (Windows)" });
Object.defineProperty(navigator, "doNotTrack", { value: "unspecified" });
window.screenY = 1072
window.screenTop = 1072

                try {
                    window.top.window.outerHeight = 1066

                } catch (e) {}
            window.screenX = 1912
window.screenLeft = 1912

                try {
                    window.top.window.outerWidth = 1936

                } catch (e) {}
            </script><script>Object.defineProperty(screen, "availTop", { value: 0 });
Object.defineProperty(screen, "availLeft", { value: 0 });
Object.defineProperty(screen, "availWidth", { value: 1920 });
Object.defineProperty(screen, "availHeight", { value: 1080 });
Object.defineProperty(screen, "colorDepth", { value: 24 });
Object.defineProperty(screen, "pixelDepth", { value: 24 });
Object.defineProperty(navigator, "hardwareConcurrency", { value: 8 });
Object.defineProperty(navigator, "userAgent", { value: "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:78.0) Gecko/20100101 Firefox/78.0" });
Object.defineProperty(navigator, "appVersion", { value: "5.0 (Windows)" });
Object.defineProperty(navigator, "doNotTrack", { value: "unspecified" });
window.screenY = 1072
window.screenTop = 1072

                try {
                    window.top.window.outerHeight = 1066

                } catch (e) {}
            window.screenX = 1912
window.screenLeft = 1912

                try {
                    window.top.window.outerWidth = 1936

                } catch (e) {}
            </script><script>Object.defineProperty(screen, "availTop", { value: 0 });
Object.defineProperty(screen, "availLeft", { value: 0 });
Object.defineProperty(screen, "availWidth", { value: 1920 });
Object.defineProperty(screen, "availHeight", { value: 1080 });
Object.defineProperty(screen, "colorDepth", { value: 24 });
Object.defineProperty(screen, "pixelDepth", { value: 24 });
Object.defineProperty(navigator, "hardwareConcurrency", { value: 8 });
Object.defineProperty(navigator, "userAgent", { value: "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:78.0) Gecko/20100101 Firefox/78.0" });
Object.defineProperty(navigator, "appVersion", { value: "5.0 (Windows)" });
Object.defineProperty(navigator, "doNotTrack", { value: "unspecified" });
window.screenY = 1072
window.screenTop = 1072

                try {
                    window.top.window.outerHeight = 1066

                } catch (e) {}
            window.screenX = 1912
window.screenLeft = 1912

                try {
                    window.top.window.outerWidth = 1936

                } catch (e) {}
            </script><span class="md"><p><title>Day 11. The Basics of Platform API Design</title><div class="title"> Day 11. The Basics of Platform API Design </div>

<div class="afterTitles"></div>
<em class="underscore">Video Length (including Q&A): <a href="https://hero.handmade.network/episode/code/day011/">1h42</a></em>

</p><p>

Welcome to &ldquo;Handmade Hero Notes&rdquo;, the book where we follow the footsteps of <a href="https://handmadehero.org/">Handmade Hero</a> in making the complete game from scratch, with no external libraries. If you'd like to follow along, preorder the game on <a href="https://handmadehero.org/">handmadehero.org</a>, and you will receive access to the GitHub repository, containing complete source code (tagged day-by-day) as well as a variety of other useful resources.

</p><p>

Our program has come a long way since we first begun, yet we are only getting started. Tonight we have a very interesting and important topic to look at: cross-platform setup. 

</p><p>

Of course, for now we don't have any platform-specific code. So far we've been working to have our <em class="underscore">bootstrap</em> code up and running. So we'll need to talk about how the code can be architectured first, and maybe even start making some changes.

</p>
<div class="longTOC"><p align="center">
    <span align="right"><a href="day10.html">Day 10</a></span>
    <a href="../index.html"><img src = "../media/logo.png"></a>
    <span align="left"><a href="day12.html">Day 12</a></span>
</p><p><a href="#" class="tocTop">(Top)</a><br/>
&nbsp;&nbsp;<a href="#/sourcefilesnamingconvention" class="level2"><span class="tocNumber">0.1&nbsp; </span>Source Files Naming Convention</a><br/>
&nbsp;&nbsp;<a href="#/win32platformlayersofar" class="level2"><span class="tocNumber">0.2&nbsp; </span>Win32 Platform Layer So Far</a><br/>
<a href="#aboutcodearchitecture" class="level1"><span class="tocNumber">1&nbsp; </span>About Code Architecture</a><br/>
&nbsp;&nbsp;<a href="#aboutcodearchitecture/cross-platformviapreprocessordirectives" class="level2"><span class="tocNumber">1.1&nbsp; </span>Cross-Platform via Preprocessor Directives</a><br/>
&nbsp;&nbsp;<a href="#aboutcodearchitecture/cross-platformviaseparateplatformfiles" class="level2"><span class="tocNumber">1.2&nbsp; </span>Cross-Platform via Separate Platform Files</a><br/>
<a href="#platformusagephilosophies" class="level1"><span class="tocNumber">2&nbsp; </span>Platform Usage Philosophies</a><br/>
&nbsp;&nbsp;<a href="#platformusagephilosophies/virtualizeplatformtothegame" class="level2"><span class="tocNumber">2.1&nbsp; </span>Virtualize Platform to the Game</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#platformusagephilosophies/virtualizeplatformtothegame/exampleimplementation" class="level3"><span class="tocNumber">2.1.1&nbsp; </span>Example Implementation</a><br/>
&nbsp;&nbsp;<a href="#platformusagephilosophies/gameaserviceforthesystem" class="level2"><span class="tocNumber">2.2&nbsp; </span>Game a Service for the System</a><br/>
<a href="#implementthegameasservicesystem" class="level1"><span class="tocNumber">3&nbsp; </span>Implement the Game as Service System</a><br/>
<a href="#recap" class="level1"><span class="tocNumber">4&nbsp; </span>Recap</a><br/>
<a href="#programmingnotions" class="level1"><span class="tocNumber">5&nbsp; </span>Programming Notions</a><br/>
&nbsp;&nbsp;<a href="#programmingnotions/headerfiles" class="level2"><span class="tocNumber">5.1&nbsp; </span>Header Files</a><br/>
<a href="#sideconsiderations" class="level1"><span class="tocNumber">6&nbsp; </span>Side Considerations</a><br/>
&nbsp;&nbsp;<a href="#sideconsiderations/unitybuilds" class="level2"><span class="tocNumber">6.1&nbsp; </span>Unity Builds</a><br/>
&nbsp;&nbsp;<a href="#sideconsiderations/cleanupwin32_handmade.cpp&ldquo;header&rdquo;" class="level2"><span class="tocNumber">6.2&nbsp; </span>Clean Up <code>win32_handmade.cpp</code> &ldquo;Header&rdquo;</a><br/>
<a href="#navigation" class="level1"><span class="tocNumber">7&nbsp; </span>Navigation</a><br/>
</p></div><a class="target" name="sourcefilesnamingconvention">&nbsp;</a><a class="target" name="/sourcefilesnamingconvention">&nbsp;</a><a class="target" name="toc0.1">&nbsp;</a><h2>Source Files Naming Convention</h2>
<p>


Up until now, we've only been doing everything in Windows, and specifically in one source file: <code>win32_handmade.cpp</code>. If you look in your <code>handmade\code</code> directory, you'll see that it only contains the file <code>win32_handmade.cpp</code>. It's a good idea to always clearly separate and mark the code relating to a specific platform (e.g. Windows, Linux, etc.), and that's what we did here: <code>win32_</code> is a prefix to signify that this code relates strictly to Windows platform. 

</p><p>

On the other hand, the code with no prefix is generic and would compile anywhere. Whoever tried to port something would tell you that it's always a challenge just to find the code to port in first place. Here, we're already setting them up for success: anyone trying to port the code to another platform would only need to look for files marked as the origin platform (in our case, <code>win32_</code>). 

</p>
<a class="target" name="win32platformlayersofar">&nbsp;</a><a class="target" name="/win32platformlayersofar">&nbsp;</a><a class="target" name="toc0.2">&nbsp;</a><h2>Win32 Platform Layer So Far</h2>
<p>


Of course, for now we don't have any platform-independent code. We've been working to have our <em class="underscore">bootstrap</em> code up and running, and one thing should be clear: all the things we've done are not final! Platform layer should be a solid foundation full of plenty a useful feature, and what we have there so far is a bare minimum to get a few things necessary to
move away from Win32 API: 

</p><p>

<ul>
<li class="asterisk">A graphics buffer that we can write directly into. 
</li>
<li class="asterisk">A sound buffer that we can write directly into. 
</li>
<li class="asterisk">Rudimentary input handling with the gamepad and keyboard. 
</li>
<li class="asterisk">Timing: knowing how long things take.</li></ul>

</p><p>

One thing that we're still planning to do here is a simple file i/o system. We'll get to it a bit later. That said, later on, once we're happy and ready to get the game to a &ldquo;shippable&rdquo; state, that's when we'll revisit our Win32 layer to maximize our compatibility, performance, etc. We're not going to do this now. There're many many things all requiring our attention now that we need to address first, before we can go back and do some thing X properly on Windows. We could however start drafting a big TO DO list, so that we remember what we need to do for our platform code... at least. Let's start typing it <em class="underscore">at the very top</em> of our <code>win32_handmade.cpp</code> file: 

</p><pre class="listing tilde"><code><div class=" add "><span class="line hljs-comment">/* </span>
<span class="line hljs-comment">  TODO(casey): THIS IS NOT A FINAL PLATFORM LAYER!!!</span>
<span class="line hljs-comment"></span>
<span class="line hljs-comment">  - Saved game locations</span>
<span class="line hljs-comment">  - Getting a handle to our own executable file</span>
<span class="line hljs-comment">  - Asset loading path</span>
<span class="line hljs-comment">  - Multithreading (launch a thread)</span>
<span class="line hljs-comment">  - Raw Input (support for multiple keyboards)</span>
<span class="line hljs-comment">  - Sleep/timeBeginPeriod</span>
<span class="line hljs-comment">  - ClipCursor() (for multi-monitor support)</span>
<span class="line hljs-comment">  - Fullscreen support</span>
<span class="line hljs-comment">  - QueryCancelAutoplay</span>
<span class="line hljs-comment">  - WM_SETCURSOR (control cursor visibility)</span>
<span class="line hljs-comment">  - WM_ACTIVATEAPP (for when we are not the active application)</span>
<span class="line hljs-comment">  - Blit speed improvements (BitBlt)</span>
<span class="line hljs-comment">  - Hardware acceleration (OpenGL or Direct3D or both??)</span>
<span class="line hljs-comment">  - GetKeyboardLayout (for French keyboards, international WASD support)</span>
<span class="line hljs-comment">*/</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> ... </span></span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;1:</b> <file>[win32_handmade.cpp]</file> Creating the master To-do list for our platform layer.</div></center>
<p>


Hopefully, this give you an idea of how much stuff we really need to do if we want to put the things into the complete, shipping-ready, state. For a lot of these things we don't have to worry for a long time, since for what we are doing now is a very simple layer to be able to develop the game. Later on, some of these things, like multithreading we'll actually <em class="underscore">need</em> in our development, so we'll hook them in, but the others we'll do at the very end when we're getting ready to ship the game. 

</p>
<a class="target" name="aboutcodearchitecture">&nbsp;</a><a class="target" name="aboutcodearchitecture">&nbsp;</a><a class="target" name="toc1">&nbsp;</a><h1>About Code Architecture</h1>
<p>


Code architecture considerations are critical if you want to make your program as easy to cross-platform as possible. We want the majority of the code, as much as possible, to be platform-independent. We thus can draw two goals:

</p><p>

<ol start=1>
<li class="number">Getting our code running at all on another platform. We've written our code on Windows and then we want to port it to e.g. Raspberry Pi, or to Linux, or to whatever. Just the act of getting it working should be as easy as possible. 
</li>
<li class="number">Getting our code to a point on those platforms where it's performant. This means, for instance, having a reasonable framerate for what one might expect to run on that platform. So in order for the game to be running at, say, 60 frames per second, there are many optimizations to be made on that platform to be able to enable this goal. There're many ways to achieve this but we want the easiest one.</li></ol>

</p><p>

The ultimate goal is therefore &ldquo;How easy can we make the life for someone who has to port your code to another platform?&rdquo; Of course, in this case it's going to be future us who'll be doing all those ports, so really, we're going to work to make easier our lives. In a bigger company however you might have someone expert in platform X who would be doing port to that platform, so you really want to keep that person in mind to make their life and their job easier. This applies not only to the initial implementation of the port, but also to its maintenance: if you do some changes to your source, will that require them to completely rewrite their port? What's it going to mean? 

</p><p>

There're many things to consider here, to keep in mind and to think about. We are going to discuss the ways of both making it easier and harder today. Hopefully, by the end of this lesson you will see that certain decisions can cause problems in the long run, and why you shouldn't make those decisions and opt for things that, in the long term, will make your life a little bit easier. 

</p>
<a class="target" name="cross-platformviapreprocessordirectives">&nbsp;</a><a class="target" name="aboutcodearchitecture/cross-platformviapreprocessordirectives">&nbsp;</a><a class="target" name="toc1.1">&nbsp;</a><h2>Cross-Platform via Preprocessor Directives</h2>
<p>


Let's start from the past. In general, the most prevalent way of doing cross-platformness in the past used to be using the preprocessor directives. 

</p><p>

Often you used to have a file, which would be doing some work not dissimilar from what our <code>win32_handmade.cpp</code> file would be doing, until the program would hit some code for, let's say opening a window. 

</p><p>

If you look at our code for opening the window, you will see that there was some work that we had to do to make it happen: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> CALLBACK</span>
<span class="line"><span class="hljs-title">WinMain</span><span class="hljs-params">(HINSTANCE Instance,</span>
<span class="line">        HINSTANCE PrevInstance,</span>
<span class="line">        LPSTR     CommandLine,</span>
<span class="line">        <span class="hljs-keyword">int</span>       ShowCode)</span></span>
<span class="line"></span>{</span>
<span class="line">    LARGE_INTEGER PerfCountFrequencyResult;</span>
<span class="line">    QueryPerformanceFrequency(&amp;PerfCountFrequencyResult);</span>
<span class="line">    s64 PerfCountFrequency = PerfCountFrequencyResult.QuadPart;</span>
<span class="line">    </span>
<span class="line">    Win32LoadXInput();</span>
<span class="line">    </span>
<span class="line">    Win32ResizeDIBSection(&amp;GlobalBackbuffer, <span class="hljs-number">1280</span>, <span class="hljs-number">720</span>);</span>
<span class="line">    </span>
<span class="line">    WNDCLASS WindowClass = {<span class="hljs-number">0</span>};</span>
<span class="line">    WindowClass.style = ... ;</span>
<span class="line">    </span>
<span class="line">    <span class="hljs-keyword">if</span> (RegisterClass(&amp;WindowClass))</span>
<span class="line">    {</span>
<span class="line">        HWND Window = CreateWindowEx(...);</span>
<span class="line">        <span class="hljs-keyword">if</span> (Window)</span>
<span class="line">        {</span>
<span class="line">          <span class="hljs-comment">// We now have our window, do work in it</span></span>
<span class="line">          <span class="hljs-comment">// ...</span></span>
<span class="line">        }</span>
<span class="line">    }</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde">Work to open the window.</div></center>
<p>



We've seen a few preprocessor directives already: those begin with keywords like <code>#include</code>, <code>#define</code> and ask compiler (actually its part called &ldquo;preprocessor&rdquo;) to do some work <em class="underscore">before</em> the code interpreting (actual compiling) starts. 

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="400" width="384" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 0,272 L 0,288 " style="fill:none;"/>
<path d="M 96,272 L 96,288 " style="fill:none;"/>
<path d="M 120,16 L 120,64 " style="fill:none;"/>
<path d="M 120,112 L 120,160 " style="fill:none;"/>
<path d="M 120,208 L 120,256 " style="fill:none;"/>
<path d="M 120,304 L 120,352 " style="fill:none;"/>
<path d="M 176,64 L 176,104 " style="fill:none;"/>
<path d="M 176,160 L 176,200 " style="fill:none;"/>
<path d="M 176,256 L 176,296 " style="fill:none;"/>
<path d="M 232,16 L 232,64 " style="fill:none;"/>
<path d="M 232,112 L 232,160 " style="fill:none;"/>
<path d="M 232,208 L 232,256 " style="fill:none;"/>
<path d="M 232,304 L 232,352 " style="fill:none;"/>
<path d="M 120,16 L 232,16 " style="fill:none;"/>
<path d="M 120,64 L 232,64 " style="fill:none;"/>
<path d="M 264,64 L 352,64 " style="fill:none;"/>
<path d="M 192,80 L 248,80 " style="fill:none;"/>
<path d="M 264,96 L 352,96 " style="fill:none;"/>
<path d="M 120,112 L 232,112 " style="fill:none;"/>
<path d="M 120,160 L 232,160 " style="fill:none;"/>
<path d="M 264,160 L 352,160 " style="fill:none;"/>
<path d="M 192,176 L 248,176 " style="fill:none;"/>
<path d="M 264,192 L 352,192 " style="fill:none;"/>
<path d="M 120,208 L 232,208 " style="fill:none;"/>
<path d="M 16,256 L 80,256 " style="fill:none;"/>
<path d="M 120,256 L 232,256 " style="fill:none;"/>
<path d="M 264,256 L 352,256 " style="fill:none;"/>
<path d="M 96,272 L 160,272 " style="fill:none;"/>
<path d="M 192,272 L 248,272 " style="fill:none;"/>
<path d="M 264,288 L 352,288 " style="fill:none;"/>
<path d="M 16,304 L 80,304 " style="fill:none;"/>
<path d="M 120,304 L 232,304 " style="fill:none;"/>
<path d="M 120,352 L 232,352 " style="fill:none;"/>
<path d="M 264,64 C 247.2,64 248,80 248,80 " style="fill:none;"/>
<path d="M 352,64 C 368.8,64 368,80 368,80 " style="fill:none;"/>
<path d="M 264,96 C 247.2,96 248,80 248,80 " style="fill:none;"/>
<path d="M 352,96 C 368.8,96 368,80 368,80 " style="fill:none;"/>
<path d="M 264,160 C 247.2,160 248,176 248,176 " style="fill:none;"/>
<path d="M 352,160 C 368.8,160 368,176 368,176 " style="fill:none;"/>
<path d="M 264,192 C 247.2,192 248,176 248,176 " style="fill:none;"/>
<path d="M 352,192 C 368.8,192 368,176 368,176 " style="fill:none;"/>
<path d="M 16,256 C -0.8000000000000007,256 0,272 0,272 " style="fill:none;"/>
<path d="M 80,256 C 96.8,256 96,272 96,272 " style="fill:none;"/>
<path d="M 264,256 C 247.2,256 248,272 248,272 " style="fill:none;"/>
<path d="M 352,256 C 368.8,256 368,272 368,272 " style="fill:none;"/>
<path d="M 264,288 C 247.2,288 248,272 248,272 " style="fill:none;"/>
<path d="M 352,288 C 368.8,288 368,272 368,272 " style="fill:none;"/>
<path d="M 16,304 C -0.8000000000000007,304 0,288 0,288 " style="fill:none;"/>
<path d="M 80,304 C 96.8,304 96,288 96,288 " style="fill:none;"/>
<polygon points="200,272 188,266.4 188,277.6 "  style="stroke:none" transform="rotate(180,192,272 )"/>
<polygon points="200,176 188,170.4 188,181.6 "  style="stroke:none" transform="rotate(180,192,176 )"/>
<polygon points="200,80 188,74.4 188,85.6 "  style="stroke:none" transform="rotate(180,192,80 )"/>
<polygon points="184,296 172,290.4 172,301.6 "  style="stroke:none" transform="rotate(90,176,296 )"/>
<polygon points="184,200 172,194.4 172,205.6 "  style="stroke:none" transform="rotate(90,176,200 )"/>
<polygon points="184,104 172,98.4 172,109.6 "  style="stroke:none" transform="rotate(90,176,104 )"/>
<polygon points="168,272 156,266.4 156,277.6 "  style="stroke:none" transform="rotate(0,160,272 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="136" y="36">S</text><text text-anchor="middle" x="144" y="36">o</text><text text-anchor="middle" x="152" y="36">u</text><text text-anchor="middle" x="160" y="36">r</text><text text-anchor="middle" x="168" y="36">c</text><text text-anchor="middle" x="176" y="36">e</text><text text-anchor="middle" x="192" y="36">c</text><text text-anchor="middle" x="200" y="36">o</text><text text-anchor="middle" x="208" y="36">d</text><text text-anchor="middle" x="216" y="36">e</text><text text-anchor="middle" x="136" y="52">(</text><text text-anchor="middle" x="144" y="52">.</text><text text-anchor="middle" x="152" y="52">c</text><text text-anchor="middle" x="160" y="52">p</text><text text-anchor="middle" x="168" y="52">p</text><text text-anchor="middle" x="184" y="52">f</text><text text-anchor="middle" x="192" y="52">i</text><text text-anchor="middle" x="200" y="52">l</text><text text-anchor="middle" x="208" y="52">e</text><text text-anchor="middle" x="216" y="52">)</text><text text-anchor="middle" x="264" y="84">P</text><text text-anchor="middle" x="272" y="84">r</text><text text-anchor="middle" x="280" y="84">e</text><text text-anchor="middle" x="288" y="84">p</text><text text-anchor="middle" x="296" y="84">r</text><text text-anchor="middle" x="304" y="84">o</text><text text-anchor="middle" x="312" y="84">c</text><text text-anchor="middle" x="320" y="84">e</text><text text-anchor="middle" x="328" y="84">s</text><text text-anchor="middle" x="336" y="84">s</text><text text-anchor="middle" x="344" y="84">o</text><text text-anchor="middle" x="352" y="84">r</text><text text-anchor="middle" x="136" y="132">P</text><text text-anchor="middle" x="144" y="132">r</text><text text-anchor="middle" x="152" y="132">e</text><text text-anchor="middle" x="160" y="132">p</text><text text-anchor="middle" x="168" y="132">r</text><text text-anchor="middle" x="176" y="132">o</text><text text-anchor="middle" x="184" y="132">c</text><text text-anchor="middle" x="192" y="132">e</text><text text-anchor="middle" x="200" y="132">s</text><text text-anchor="middle" x="208" y="132">s</text><text text-anchor="middle" x="216" y="132">e</text><text text-anchor="middle" x="224" y="132">d</text><text text-anchor="middle" x="136" y="148">S</text><text text-anchor="middle" x="144" y="148">o</text><text text-anchor="middle" x="152" y="148">u</text><text text-anchor="middle" x="160" y="148">r</text><text text-anchor="middle" x="168" y="148">c</text><text text-anchor="middle" x="176" y="148">e</text><text text-anchor="middle" x="192" y="148">c</text><text text-anchor="middle" x="200" y="148">o</text><text text-anchor="middle" x="208" y="148">d</text><text text-anchor="middle" x="216" y="148">e</text><text text-anchor="middle" x="280" y="180">C</text><text text-anchor="middle" x="288" y="180">o</text><text text-anchor="middle" x="296" y="180">m</text><text text-anchor="middle" x="304" y="180">p</text><text text-anchor="middle" x="312" y="180">i</text><text text-anchor="middle" x="320" y="180">l</text><text text-anchor="middle" x="328" y="180">e</text><text text-anchor="middle" x="336" y="180">r</text><text text-anchor="middle" x="136" y="228">O</text><text text-anchor="middle" x="144" y="228">b</text><text text-anchor="middle" x="152" y="228">j</text><text text-anchor="middle" x="160" y="228">e</text><text text-anchor="middle" x="168" y="228">c</text><text text-anchor="middle" x="176" y="228">t</text><text text-anchor="middle" x="192" y="228">c</text><text text-anchor="middle" x="200" y="228">o</text><text text-anchor="middle" x="208" y="228">d</text><text text-anchor="middle" x="216" y="228">e</text><text text-anchor="middle" x="136" y="244">(</text><text text-anchor="middle" x="144" y="244">.</text><text text-anchor="middle" x="152" y="244">o</text><text text-anchor="middle" x="160" y="244">b</text><text text-anchor="middle" x="168" y="244">j</text><text text-anchor="middle" x="184" y="244">f</text><text text-anchor="middle" x="192" y="244">i</text><text text-anchor="middle" x="200" y="244">l</text><text text-anchor="middle" x="208" y="244">e</text><text text-anchor="middle" x="216" y="244">)</text><text text-anchor="middle" x="16" y="276">E</text><text text-anchor="middle" x="24" y="276">x</text><text text-anchor="middle" x="32" y="276">t</text><text text-anchor="middle" x="40" y="276">e</text><text text-anchor="middle" x="48" y="276">r</text><text text-anchor="middle" x="56" y="276">n</text><text text-anchor="middle" x="64" y="276">a</text><text text-anchor="middle" x="72" y="276">l</text><text text-anchor="middle" x="288" y="276">L</text><text text-anchor="middle" x="296" y="276">i</text><text text-anchor="middle" x="304" y="276">n</text><text text-anchor="middle" x="312" y="276">k</text><text text-anchor="middle" x="320" y="276">e</text><text text-anchor="middle" x="328" y="276">r</text><text text-anchor="middle" x="16" y="292">l</text><text text-anchor="middle" x="24" y="292">i</text><text text-anchor="middle" x="32" y="292">b</text><text text-anchor="middle" x="40" y="292">r</text><text text-anchor="middle" x="48" y="292">a</text><text text-anchor="middle" x="56" y="292">r</text><text text-anchor="middle" x="64" y="292">i</text><text text-anchor="middle" x="72" y="292">e</text><text text-anchor="middle" x="80" y="292">s</text><text text-anchor="middle" x="136" y="324">E</text><text text-anchor="middle" x="144" y="324">x</text><text text-anchor="middle" x="152" y="324">e</text><text text-anchor="middle" x="160" y="324">c</text><text text-anchor="middle" x="168" y="324">u</text><text text-anchor="middle" x="176" y="324">t</text><text text-anchor="middle" x="184" y="324">a</text><text text-anchor="middle" x="192" y="324">b</text><text text-anchor="middle" x="200" y="324">l</text><text text-anchor="middle" x="208" y="324">e</text><text text-anchor="middle" x="136" y="340">(</text><text text-anchor="middle" x="144" y="340">.</text><text text-anchor="middle" x="152" y="340">e</text><text text-anchor="middle" x="160" y="340">x</text><text text-anchor="middle" x="168" y="340">e</text><text text-anchor="middle" x="184" y="340">f</text><text text-anchor="middle" x="192" y="340">i</text><text text-anchor="middle" x="200" y="340">l</text><text text-anchor="middle" x="208" y="340">e</text><text text-anchor="middle" x="216" y="340">)</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;1:</b> Compilation process.</div></center>

</p><p>

Among other things, preprocessor allows to use <code>#if</code>, <code>#elif</code> (&ldquo;else if&rdquo;), <code>#else</code> and <code>#endif</code> statements which would, depending on if some value is zero or not, include or not specific pieces of code into the compilation.

</p><p>

This allows you having something like <code>#if _WIN32</code> to execute some Windows-specific code:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> _WIN32</span></span>
<span class="line"><span class="hljs-comment">// Stuff in here happens when _WIN32 is not zero</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span></span>
<span class="line"><span class="hljs-comment">// Stuff in here happens when that thing is zero</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span></code></pre><center><div class="listingcaption tilde">Example.</div></center>
<p>


This thing <code>_WIN32</code> would be the &ldquo;macro variable&rdquo; controlling certain parts of the compilation, allowing the programmer to knock out certain parts of the compilation and bring others in on certain platforms.

</p><p>

People would <code>#define</code> these macro variables, in our case say <code>HANDMADE_WIN32</code>, to transform the code in something like this: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> HANDMADE_WIN32</span></span>
<span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> CALLBACK</span>
<span class="line"><span class="hljs-title">WinMain</span><span class="hljs-params">(HINSTANCE Instance,</span>
<span class="line">        HINSTANCE PrevInstance,</span>
<span class="line">        LPSTR     CommandLine,</span>
<span class="line">        <span class="hljs-keyword">int</span>       ShowCode)</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> HANDMADE_LINUX </span></span>
<span class="line"><span class="hljs-comment">// WinMain doesn't work on Linux</span></span>
<span class="line"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">int</span>** argv)</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> HANDMADE_MACOSX</span></span>
<span class="line"><span class="hljs-comment">// ...  </span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span> </span></span>
<span class="line"></span>{</span>
<span class="line">    <span class="hljs-comment">//...</span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde">Work to open the window.</div></center>
<p>


Thus you would slot in everything platform-specific in these directives. If you would then compile the program on Windows, you would then go into your build file and define something called a &ldquo;compile-time define&rdquo;. Compiler allows you to put argument <code>-D</code>, after which you would &ldquo;inject&rdquo; the define for that specific platform:

</p><pre class="listing tilde"><code><span class="line">@echo off</span>
<span class="line"></span>
<span class="line">if not exist build (mkdir build)</span>
<span class="line">pushd build</span>
<span class="line"></span><div class=" edit"><span class="line">cl -DHANDMADE_WIN32=1 -FC -Zi ..\code\win32_handmade.cpp user32.lib gdi32.lib</span></div><span class="line"></span>
<span class="line">popd</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;2:</b> <file>[build.bat]</file> Injecting <code>HANDMADE_WIN32</code> define.</div></center>
<p>


If you compile it this way, you'll notice that it will compile fine. But if you for example replace <code>DHANDMADE_WIN32=1</code> with, let's say, <code>DHANDMADE_LINUX=1</code> you will start getting all sorts of errors, and the code won't work anymore. At that point you'd need to <code>#if</code> <em class="underscore">all</em> the Windows code, put <code>#else</code>s around it, so that the correct calls for Linux can be made, and so on.

</p><p>

This way of structuring the code presents a set of problems. Sure enough, it defeats the primary objective we set above: it doesn't make the job easy for whoever needs to do the port. They would need to go through all the code looking for all the places where we use Win32 code and <code>#if</code> that code around like we showed. But then there're other issues:

</p><p>

<ol start=1>
<li class="number">You can't see where the Win32 code is. You need to learn how the whole codebase operates before you can even start thinking about how to port it. 
</li>
<li class="number">The code structured in such a way becomes very difficult to read very quickly. You would need to resort to the special editors features which would automatically collapse unrelated <code>#ifs</code> for you.</li></ol>

</p><p>

Imagine that it's not only Windows and Linux, it's every platform to which our program will be ported to, and you have <code>#if</code>s over <code>#if</code>s for any single function call. Pretty soon you will <em class="underscore">require</em> a development environment that can understand which <code>#if</code>s you have set and show you only the code related to that, otherwise you won't even be able to read that code at all! Such a functionality is hard to find in editors and, if it's there, it might be pretty <em class="underscore">janky</em> to use. 

</p><p>

The things above are inconvenient, time-consuming and error-prone, sure, but they pale in comparison with the final consideration. Unless you absolutely have to, you don't want to write the code this way because: 

</p><p>

<ol start=3>
<li class="number">It dictates that the control flow of the program must be the same for all platforms.</li></ol>

</p><p>

What does it mean? If you do cross-platform code this way, it means that the <em class="underscore">control flow</em> of your program is shared across all the platforms you will ever ship on. Specifically, you go and <code>#if</code> specific lines of code, then you end up with the same set of functions, <code>#if</code> statements, <code>while</code> loops, etc. However, because each platform has its own platform quirks, you will inevitably end up with a set of &ldquo;escape mechanisms&rdquo; for each platform, enabling them to go and do the thing that they wanted to do at the time that they needed to do it. 

</p><p>

Furthermore, such an approach will become even more problematic when you start speaking about the platforms which have <em class="underscore">conceptually different approaches</em> to how they expect initialization and platform services setup. 

</p><p>

Let's say you want to set up a background asset streaming system in your game. You want to load bitmaps out from your resource file, and do it while the game is running, without stopping or pausing the game to load. On one platform this would be maybe best accomplished with a separate thread. On another, with overlapped I/O. On another again, maybe with the memory mapped files. Who knows? Each one of these things may dictate a very different structure for how the game starts up, how it continues running, how it handles things like messages coming from the operating system, etc. 

</p><p>

For these reasons we don't recommend writing code this way and, in general, this is no longer the way the cross-platform code is built in the industry. So we'd like you to remember that structuring your code in such a manner is <em class="underscore">very</em> inefficient. 

</p><p>

There is a very limited space however where this trick comes in handy, and we'll see to it later. So let's revert all the changes back to where we started from (if you made any changes to your code so far) but leave the <code>DHANDMADE_WIN32=1</code> in the <code>build.bat</code> file. We won't use it in the sense described above, but there might be other occasions where this define might become useful. 

</p>
<a class="target" name="cross-platformviaseparateplatformfiles">&nbsp;</a><a class="target" name="aboutcodearchitecture/cross-platformviaseparateplatformfiles">&nbsp;</a><a class="target" name="toc1.2">&nbsp;</a><h2>Cross-Platform via Separate Platform Files</h2>
<p>


So this is the way we don't want to pursue. So which is the way? Well, nowadays there are two prevalent schools of thought that we'll see in the next section, and both revolve about the idea of having separate platform code in the separate source code files. 

</p><p>

We have our <code>win32_handmade.cpp</code> file. We created it with the assumption that, at some point, someone will come in and create a file called <code>linux_handmade.cpp</code>. <code>macosx_handmade.cpp</code>. And so on, and so forth. 

</p><p>

<div class="admonition ">That someone is probably going be us at some point, but it's really not important. In a larger project it would be the platform expert for Linux or what have you.</div>

</p><p>

This way, all of the Windows code will go into those <code>win32_</code> files (it doesn't need to be necessarily one file), and all the Linux code will go into <code>linux_</code> files.

</p><p>

How will it work from here on? We will create a single shared <em class="underscore">header</em> file called <code>handmade.h</code>. Let's go ahead and create it now inside our <code>code</code> folder: 

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> !defined(HANDMADE_H)</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-comment">// Contents of the header file</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> HANDMADE_H</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;3:</b> <file>[handmade.h]</file> Creating our first header file.</div></center>
<p>




<div class="admonition ">To learn more about header files and what we does the code we inserted means, head over to subsection  <a href="#toc5.1">5.1</a>.</div>

</p><p>

This single shared header file will include the operations that the platform layer should be able to perform on behalf of the cross-platform code. We will basically create our own platform instruction API in this header file, and all of our platform non-specific code will call into it this way.

</p><p>

Let's say, for example, we have something that we want to load the file with. In <code>handmade.h</code> we'll have something like this:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> !defined(HANDMADE_H)</span></span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">PlatformLoadFile</span><span class="hljs-params">(<span class="hljs-keyword">char</span>* Filename)</span></span>;<span class="hljs-comment">// Not the actual API! Just an example</span></span></div><span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> HANDMADE_H</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span></code></pre><center><div class="listingcaption tilde"><file>[handmade.h]</file></div></center>
<p>


(<code>Platform</code> at the beginning marks for us that this is a platform-specific code, so we know that we ask the platform for something.)

</p><p>

There will be only a single declaration inside here. What happens next is that in our <em class="underscore">platform</em> code (like <code>win32_handmade.cpp</code> or <code>linux_handmade.cpp</code>) we define these functions. Thus, in <code>win32_handmade.cpp</code> you'd have the following code: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> *</span>
<span class="line"><span class="hljs-title">PlatformLoadFile</span><span class="hljs-params">(<span class="hljs-keyword">char</span>* Filename)</span></span>
<span class="line"></span>{</span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): Implements the Win32 file loading</span></span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">    <span class="hljs-keyword">return</span> (<span class="hljs-number">0</span>);</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><file>[win32_handmade.cpp]</file></div></center>
<p>


while in <code>linux_handmade.cpp</code> you'd have code like this: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> *</span>
<span class="line"><span class="hljs-title">PlatformLoadFile</span><span class="hljs-params">(<span class="hljs-keyword">char</span>* Filename)</span></span>
<span class="line"></span>{</span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): Implements the Linux file loading</span></span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">    <span class="hljs-keyword">return</span> (<span class="hljs-number">0</span>);</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><file>[linux_handmade.cpp]</file></div></center>
<p>


So, in your <code>handmade.cpp</code> file (go ahead and create the file inside your <code>code</code> directory right now), you wouldn't want any code relying on Windows platform (or any platform for that matter). After including your header file, you'd simply call the file and pass it the file name:

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"handmade.h"</span></span></span>
<span class="line"></span>
<span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> </span>
<span class="line"><span class="hljs-title">MainLoop</span><span class="hljs-params">()</span></span>
<span class="line"></span>{</span>
<span class="line">    <span class="hljs-keyword">void</span> *FileContents = PlatformLoadFile(<span class="hljs-string">"assets.bmp"</span>);</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;4:</b> <file>[handmade.cpp]</file> Introducing <code>handmade.cpp</code></div></center>
<p>


You'll ask to load the file, you'll capture the contents in the <code>void *</code>, and you cannot care less what did the platform do to make it happen. 

</p><p>

At the same time, we will <code>#include</code> this new <code>handmade.cpp</code> inside our platform file, and call <code>MainLoop</code> from some point in our program execution: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> internal static</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> local_persist static</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> global_variable static</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> Pi32 3.14159265359f</span></span><div class=" add"><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"handmade.cpp"</span></span></span></div><span class="line"><span class="hljs-comment">//...</span></span>
<span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> CALLBACK</span>
<span class="line"><span class="hljs-title">WinMain</span><span class="hljs-params">(...)</span></span>
<span class="line"></span>{</span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">    <span class="hljs-keyword">while</span> (GlobalRunning)</span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// ...</span></span>
<span class="line">        win32_window_dimension Dimension = Win32GetWindowDimension(Window);</span>
<span class="line">        Win32DisplayBufferInWindow(...);</span>
<span class="line">               </span><div class=" add"><span class="line">        MainLoop();</span></div><span class="line">        <span class="hljs-comment">// ... </span></span>
<span class="line">    }</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;5:</b> <file>[win32_handmade.cpp]</file> Calling platform-independent code.</div></center>
<p>




<div class="admonition note"><div class="admonition-title"> <code>#include &quot;file&quot;</code> vs. <code>#include &lt;file&gt;</code></div>

</p><p>

    You might have noticed that we <code>#include &lt;windows.h&gt;</code> but we <code>#include &quot;handmade.cpp&quot;</code> This is because, depending on the type of quotation marks used, the compiler will start searching for the file to include in different places. <code>#include &quot;file&quot;</code> will be searched for starting from the same folder as the source file that's being included, while <code>#include &lt;file&gt;</code> will start search from the folders in the system's include path. 

</p><p>

    You might also notice that we decided to <code>#include</code> a <code>.cpp</code> file instead of building it separately. This is because, as our building philosophy, we use the so-called Unity Builds, i.e. building everything in one go. You can read more in the subsection  <a href="#toc6.1">6.1</a>.</div>

</p><p>

This is the structure that we're going to use from now on:

</p><p>

<ol start=1>
<li class="number">We'll be starting off in the platform-specific layer controlling the initialization process. For Win32, we'll continue doing all the Windows-startup stuff we were doing already (and more to come).
</li>
<li class="number">When the platform is ready to do the <em class="underscore">game</em> work, we call in the platform-independent layer of our code. In here, all the rest of our code will live. 
</li>
<li class="number">Whenever the game code gets to the point where it needs to do something that only the platform knows how to do (e.g., load a file, speak with the network, display graphics, etc.), it's going to call out to the platform layer. This will go right back in to the platform layer. The platform layer executes whatever it needs to execute to satisfy the request and returns the result back to the game.</li></ol>

</p>
<a class="target" name="platformusagephilosophies">&nbsp;</a><a class="target" name="platformusagephilosophies">&nbsp;</a><a class="target" name="toc2">&nbsp;</a><h1>Platform Usage Philosophies</h1>
<p>


So far, we've touched on the common notions of separating different platforms in different files. Nowadays, it's generally agreed upon that this is a good way of structuring cross-platform code, preferable to <code>#if</code>s everywhere.

</p><p>

Now, there're two different philosophical camps for how the platform code should be written, and there're heated debates on which one is better. We generally prefer the second idea, many people like the first. If you don't have an opinion yet, we recommend trying out and see which suits your personal taste.

</p>
<a class="target" name="virtualizeplatformtothegame">&nbsp;</a><a class="target" name="platformusagephilosophies/virtualizeplatformtothegame">&nbsp;</a><a class="target" name="toc2.1">&nbsp;</a><h2>Virtualize Platform to the Game</h2>
<p>


One prevalent line of thought is that of virtualizing the platform to the game. This means that, instead of thinking of the game as an isolated entity that the platform code is working with, you end up with abstracting the specific operation of the platform to &ldquo;virtual&rdquo; set of functions that the game can call as if it was running an ideal operating system. 

</p><p>

This would look like in the following manner: 

</p><p>

<ul>
<li class="asterisk">After you enter your <code>WinMain</code> (or its analog on another system) you call something called <code>GameMain();</code> (inside your <code>handmade.cpp</code> you'd have your <code>GameMain</code> function). Inside <code>GameMain</code>, you'll start calling the platform layer to do various things: 
<ul>
    <li class="asterisk"><code>PlatformOpenWindow</code>: would open you a window of a specific size and get back a handle to it. You would store the result in a generic <code>struct</code> called <code>platform_window</code> which every platform would be responsible for defining. 
</li>
    <li class="asterisk"><code>PlatformOpenSoundDevice</code>: to get a <code>platform_sound_device</code> struct of some sort.
</li></ul>
<li class="asterisk">At the end you would have <code>GameShutdown</code> which would do the same things like:
<ul>
    <li class="asterisk"><code>PlatformCloseWindow</code>
</li>
    <li class="asterisk"><code>PlatformCloseSoundDevice</code> etc.</li></ul></li></ul>

</p><p>

We're making all of these names up on the fly but it's basically it. You will go through and essentially tell the operating system what it needs to do. However, instead of calling the actual operating system and asking all these things, you'd go through your &ldquo;virtual&rdquo; operating system that you've made up and defined in some <code>.h</code> file, which would be responsible for doing the actual work on actual windows, sound devices, etc. on the real operating systems. 

</p><p>

It's quite straightforward to do, and you probably won't run into a lot of problems if you try to do it yourself. It's not necessarily a bad approach, either, give it a try and see if you like it. 

</p><p>

<div class="admonition warning">You should always try and see for yourself all the various things you do in your programs. Only because someone said &ldquo;don't do it&rdquo;, it doesn't necessarily mean you shouldn't.</div>

</p>
<a class="target" name="exampleimplementation">&nbsp;</a><a class="target" name="platformusagephilosophies/virtualizeplatformtothegame/exampleimplementation">&nbsp;</a><a class="target" name="toc2.1.1">&nbsp;</a><h3>Example Implementation</h3>
<p>


In case you want to pick this particular method, here's how you do it: 

</p><p>

<ol start=1>
<li class="number">Inside <code>handmade.h</code>, only make the declarations of the functions you're interested in:</li></ol>

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> !defined(HANDMADE_H)</span></span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">platform_window</span>;</span></span>
<span class="line"><span class="hljs-function">platform_window *<span class="hljs-title">PlatformOpenWindow</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *Title)</span></span>;</span>
<span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">PlatformCloseWindow</span><span class="hljs-params">(platform_window * Window)</span></span>;</span></div><span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> HANDMADE_H</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span></code></pre><center><div class="listingcaption tilde"><file>[handmade.h]</file></div></center>
<p>



<ol start=2>
<li class="number">inside the platform-specific file, you'd define the actual struct and functions.</li></ol>

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-comment">// somewhere inside the file</span></span><div class=" add"><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">platform_window</span></span>
<span class="line">{</span></span>
<span class="line">    HWND Handle;</span>
<span class="line">};</span>
<span class="line"></span>
<span class="line"><span class="hljs-function">platform_window *<span class="hljs-title">PlatformOpenWindow</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *Title)</span></span>
<span class="line"></span>{</span>
<span class="line">    platform_window Result = allocate the memory...;</span>
<span class="line">    Result-&gt;Handle = Result of create window...;</span>
<span class="line">    <span class="hljs-keyword">return</span>(Result);</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">PlatformCloseWindow</span><span class="hljs-params">(platform_window * Window)</span></span>
<span class="line"></span>{</span>
<span class="line">    <span class="hljs-keyword">if</span>(Window)</span>
<span class="line">    {</span>
<span class="line">        CloseWindow(Window-&gt;Handle);</span>
<span class="line">    }</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><file>[win32_handmade.cpp]</file></div></center>
<p>


You need to remember that Win32 code will only be compile on Windows, while Linux code will only be compiled on Linux. That means we can actually have two different definitions for <code>platform_window</code> struct that don't have to be the same. So we have <code>HWND</code> inside our Win32 code, but we'll have <code>Window</code> on X (the most common window-handling platform on Linux). 

</p><p>

The bottom line is that you create the API with high level of control on the init code, while maintaining clean separation from the actual nitty-gritty of that code. 

</p><p>

<div class="admonition ">The code above was made purely for demo purposes. Remember to clean it up if you were following along!</div>

</p>
<a class="target" name="gameaserviceforthesystem">&nbsp;</a><a class="target" name="platformusagephilosophies/gameaserviceforthesystem">&nbsp;</a><a class="target" name="toc2.2">&nbsp;</a><h2>Game a Service for the System</h2>
<p>


There are a few reasons why you wouldn't want to use the approach above. For instance, such an interface is more expressive than necessary. 

</p><p>

An operating system is designed for all sorts of applications: 

</p><p>

<ul>
<li class="asterisk">Applications that want more than one window.
</li>
<li class="asterisk">Applications that don't want a window.
</li>
<li class="asterisk">Applications that constantly open and close windows. 
</li>
<li class="asterisk">Applications that show up in the start menu or in the taskbar. 
</li>
<li class="asterisk">Applications that use Component Object Model. 
</li>
<li class="asterisk">Applications that embed themselves in other applications, use object linking embedding, register themselves in the registry, integrate into the shell.....</li></ul>

</p><p>

An operating system supports a <em class="underscore">huge</em> amount of flexibility and one could argue that it's <em class="underscore">fine</em>, that's probably the operating system's job. But when it comes to a game, we have to ask ourselves: do we need such a flexibility? Is our game going to open multiple windows or do all these crazy things... of its own volition? Does our game need to know what a window even is? Does it care what a window is, at all? Does the game need to know about the sound devices, or it only should give us a stream of sounds? 

</p><p>

The argument we're making here is that you don't usually need to have all this complexity unless you have to. Rather, you'd want to define things the other way around: instead of the platform layer being a series of services provided to the game (that the game constructs a running application out of), we can think of the game as services for the operating system level to produce the graphics and sound necessary to play the game. 

</p><p>

If you look at the platform code that we've already written, there isn't much reason to abstract it and make it callable from the game level. In fact, there might be reason not to do that. Why? When we start tighten the platform code and prepare it for release, there might be a lot of very complicated logic that we need to compute in order to most carefully adhere to the standards of that platform. There may be tons of device messages like the platform telling us to move to a different monitor or something. Even further, every platform is different, and the code and edge cases you have to account for are different. So what we'd rather do is to leave all this entanglement to the platform layer, and what the game does is simply responding to a few very simple requests like: 

</p><p>

<ul>
<li class="asterisk">Here is the bitmap you want to draw to.
</li>
<li class="asterisk">Here is the sound buffer you want to play to. 
</li>
<li class="asterisk">Here is the user's input.</li></ul>

</p><p>

On the back channel, the game will request two very simple things such as: 

</p><p>

<ul>
<li class="asterisk">Send this out to the network for me.
</li>
<li class="asterisk">Read or write from a file now.</li></ul>

</p><p>

Not a whole lot there, so you can drastically simplify the degree by which the game inherits the complexity of the operating system, by not forcing to pass all the logic to the game and round-trip the logical operations through it. 

</p>
<a class="target" name="implementthegameasservicesystem">&nbsp;</a><a class="target" name="implementthegameasservicesystem">&nbsp;</a><a class="target" name="toc3">&nbsp;</a><h1>Implement the Game as Service System</h1>
<p>


In order to implement this latter approach, we simply need to isolate a few specific locations of the code where the platform layer wants the services of the game, and other places in the game where the game wants the services from the platform layer. 

</p><p>

Let's start from our <code>WinMain</code>. Our <code>GlobalRunning</code> loop that we wrote processes the system messages the program gets and gets input from the gamepad. This was test code, but it's not far off from the regular code that one could ship. 

</p><p>

We have already suggested in a way what should go on: our <code>RenderWeirdGradient</code> call is our renderer! Of course, for now we have <code>faux-code</code> just sitting there and drawing a weird gradient, but that's the thing that renders for the game. 

</p><p>

So we can say right there that here we'll call the game code be responsible for game update and render. We can also remove our <code>RenderWeirdGradient</code> call since we want to bring it to the game layer.

</p><pre class="listing tilde"><code><div class=" add"><span class="line">GameUpdateAndRender();</span></div><div class=" delete"><span class="line">RenderWeirdGradient(&amp;GlobalBackbuffer, XOffset, YOffset);</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;6:</b> <file>[win32_handmade.cpp > WinMain]</file> Setting Game Update. If you added the call to <code>MainLoop</code>, remember to remove it, as well!</div></center>
<p>


We can also go ahead and add it to our <code>handmade.h</code>. We could pre-suppose how our API would work and fill those parts in but this would be getting ahead of ourselves, and we don't want that. So let's just simply leave a note to the place where we <em class="underscore">will</em> store the services going the other way for now.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> !defined(HANDMADE_H)</span></span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-comment">// TODO(casey): Services that the platform layer provides to the game.</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-comment">// NOTE(casey): Services that the game provides to the platform layer.</span></span>
<span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">GameUpdateAndRender</span><span class="hljs-params">()</span></span>;</span></div><span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> HANDMADE_H</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;7:</b> <file>[handmade.h]</file> Starting Platform API.</div></center>
<p>


Last, we want to actually define <code>GameUpdateAndRender</code> inside <code>handmade.cpp</code> (again, if you've written test code there, remember to clean it up!):

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">GameUpdateAndRender</span><span class="hljs-params">()</span></span>
<span class="line"></span>{</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;8:</b> <file>[handmade.cpp]</file> Defining our first platform-independent function.</div></center>
<p>


Last thing, let's disable the framerate output code for now, so that it doesn't spam our <code>Output</code> window. We do it by simply putting <code>#if 0</code> and <code>#endif</code> around the piece of code that we don't want to execute, but you can also comment it out or simply delete it:

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> 0</span></span>
<span class="line"><span class="hljs-keyword">char</span> Buffer[<span class="hljs-number">256</span>];</span>
<span class="line"><span class="hljs-built_in">sprintf</span>(Buffer, <span class="hljs-string">"%.02fms/f, %.02ff/s, %.02fMc/f\n"</span>, MSPerFrame, FPS, MegaCyclesPerFrame);</span>
<span class="line">OutputDebugStringA(Buffer);</span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;9:</b> <file>[win32_handmade.cpp > WinMain]</file> Disabling timer diagnostics.</div></center>
<p>


For our <code>GameUpdateAndRender</code> you'll probably want to pass the bitmap to render, the sound buffer to play the sound to, as well as the input and the frame timer. So we'll essentially need to pass it four things. This may expand in the future, the calls count may go from one to three or something.

</p><p>

Anyway, if you compile and run the game now, you'll see that we went one step back, because we removed the <code>RenderWeirdGradient</code> call without putting it anywhere. That said, if you inspect the <code>RenderWeirdGradient</code> code, you'll notice that it's largely platform-independent code, with the sole exception of the <code>win32_offscreen_buffer *</code> that we pass to it. Let's cut it straight out of <code>win32_handmade.cpp</code> and drop it into <code>handmade.cpp</code>:

</p><pre class="listing tilde"><code><div class=" delete"><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">RenderWeirdGradient</span><span class="hljs-params">(win32_offscreen_buffer *Buffer, <span class="hljs-keyword">int</span> XOffset, <span class="hljs-keyword">int</span> YOffset)</span></span>
<span class="line"></span>{</span>
<span class="line">    u8 *Row = (u8 *)Buffer-&gt;Memory;</span>
<span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> Y = <span class="hljs-number">0</span>;</span>
<span class="line">         Y &lt; Buffer-&gt;Height;</span>
<span class="line">         ++Y)</span>
<span class="line">    {</span>
<span class="line">        u32 *Pixel = (u32  *)Row;</span>
<span class="line">        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> X = <span class="hljs-number">0</span>;</span>
<span class="line">            X &lt; Buffer-&gt;Width;</span>
<span class="line">            ++X)</span>
<span class="line">        {</span>
<span class="line">            u8 Blue = (u8)(X + XOffset);</span>
<span class="line">            u8 Green = (u8)(Y + YOffset);</span>
<span class="line">            u8 Red = <span class="hljs-number">0</span>;</span>
<span class="line">            </span>
<span class="line">            *Pixel++ = Red &lt;&lt; <span class="hljs-number">16</span> | Green &lt;&lt; <span class="hljs-number">8</span> | Blue; <span class="hljs-comment">// &lt;&lt; 0</span></span>
<span class="line">        }</span>
<span class="line">        Row += Buffer-&gt;Pitch;</span>
<span class="line">    }</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;10:</b> <file>[win32_handmade.cpp]</file></div></center>
<pre class="listing tilde"><code><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"handmade.h"</span></span></span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">RenderWeirdGradient</span><span class="hljs-params">(win32_offscreen_buffer *Buffer, <span class="hljs-keyword">int</span> XOffset, <span class="hljs-keyword">int</span> YOffset)</span></span>
<span class="line"></span>{</span>
<span class="line">    u8 *Row = (u8 *)Buffer-&gt;Memory;</span>
<span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> Y = <span class="hljs-number">0</span>;</span>
<span class="line">         Y &lt; Buffer-&gt;Height;</span>
<span class="line">         ++Y)</span>
<span class="line">    {</span>
<span class="line">        u32 *Pixel = (u32  *)Row;</span>
<span class="line">        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> X = <span class="hljs-number">0</span>;</span>
<span class="line">            X &lt; Buffer-&gt;Width;</span>
<span class="line">            ++X)</span>
<span class="line">        {</span>
<span class="line">            u8 Blue = (u8)(X + XOffset);</span>
<span class="line">            u8 Green = (u8)(Y + YOffset);</span>
<span class="line">            u8 Red = <span class="hljs-number">0</span>;</span>
<span class="line">            </span>
<span class="line">            *Pixel++ = Red &lt;&lt; <span class="hljs-number">16</span> | Green &lt;&lt; <span class="hljs-number">8</span> | Blue; <span class="hljs-comment">// &lt;&lt; 0</span></span>
<span class="line">        }</span>
<span class="line">        Row += Buffer-&gt;Pitch;</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"></span></div><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">GameUpdateAndRender</span><span class="hljs-params">()</span></span>
<span class="line"></span>{</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;11:</b> <file>[handmade.cpp]</file> Pulling out <code>RenderWeirdGradient</code>.</div></center>
<p>




<div class="admonition tip">If you use <code>4coder</code>, you can quickly switch between files using <code>Ctrl-I</code> hotkey. 

</p><p>

    If you use <code>vscode, you can do the same by using </code>Ctrl-P` hotkey and typing the file name.</div>

</p><p>

Now, regarding the <code>win32_offscreen_buffer</code>, we can simply change it to something like <code>game_offscreen_buffer</code>. If you take its definition from <code>win32_handmade.cpp</code>, you'll see that it's largely platform-independent, with the sole exception of that <code>BITMAPINFO</code>. So we can simply remove it from the <code>game_offscreen_buffer</code> definition and simply pass it to our <code>GameUpdateAndRender</code> as follows:

</p><p>

<ol start=1>
<li class="number">In <code>handmade.cpp</code>, we change the signature of <code>RenderWeirdGradient</code> and call it from <code>GameUpdateAndRender</code>. We will also use dummy values for the <code>XOffset</code> and <code>YOffset</code> for now.</li></ol>

</p><pre class="listing tilde"><code><div class=" edit"><span class="line">RenderWeirdGradient(game_offscreen_buffer *Buffer, <span class="hljs-keyword">int</span> XOffset, <span class="hljs-keyword">int</span> YOffset)</span></div><span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">}</span>
<span class="line"></span>
<span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">GameUpdateAndRender</span><span class="hljs-params">(game_offscreen_buffer *Buffer)</span></span>
<span class="line"></span>{</span>
<span class="line">    <span class="hljs-keyword">int</span> XOffset = <span class="hljs-number">0</span>;</span>
<span class="line">    <span class="hljs-keyword">int</span> YOffset = <span class="hljs-number">0</span>;</span>
<span class="line">    RenderWeirdGradient(Buffer, XOffset, YOffset);</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;12:</b> <file>[handmade.cpp]</file> Adding graphics back into our game, step 1.</div></center>
<p>



<ol start=2>
<li class="number">In <code>handmade.h</code>, we add the definition for <code>GameUpdateAndRender</code> and introduce <code>game_offscreen_buffer</code>:</li></ol>

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">game_offscreen_buffer</span></span>
<span class="line">{</span></span>
<span class="line">    <span class="hljs-keyword">void</span> *Memory;</span>
<span class="line">    <span class="hljs-keyword">int</span> Width;</span>
<span class="line">    <span class="hljs-keyword">int</span> Height;</span>
<span class="line">    <span class="hljs-keyword">int</span> Pitch;</span>
<span class="line">};</span></div><span class="line"><span class="hljs-comment">// TODO(casey): Services that the platform layer provides to the game.</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-comment">// NOTE(casey): Services that the game provides to the platform layer.</span></span><div class=" edit"><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">GameUpdateAndRender</span><span class="hljs-params">(game_offscreen_buffer *Buffer)</span></span>;</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;13:</b> <file>[handmade.h]</file> Adding graphics back into our game, step 2.</div></center>
<p>



<ol start=3>
<li class="number">Last, in <code>win32_handmade.cpp</code> we simply create and fill out the <code>game_offscreen_buffer</code> based on our <code>GlobalBackbuffer</code>:</li></ol>

</p><pre class="listing tilde"><code><div class=" add"><span class="line">game_offscreen_buffer Buffer = {}; <span class="hljs-comment">// clear to zero!</span></span>
<span class="line">Buffer.Memory = GlobalBackbuffer.Memory;</span>
<span class="line">Buffer.Width = GlobalBackbuffer.Width;</span>
<span class="line">Buffer.Height = GlobalBackbuffer.Height;</span>
<span class="line">Buffer.Pitch = GlobalBackbuffer.Pitch;</span></div><div class=" edit"><span class="line">GameUpdateAndRender(&amp;Buffer);</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;14:</b> <file>[win32_handmade.cpp]</file> Adding graphics back into our game, step 3.</div></center>
<p>


If you have done all the steps correctly, you should now compile, run and see the good old weird gradient (albeit not moving). We're almost at the feature parity (the place where we were before)!

</p><p>

Now, if you really want to achieve feature parity, you can pass <code>XOffset</code> and <code>YOffset</code> directly from the Win32 platform layer. We'll leave this as an exercise for the reader.

</p>
<a class="target" name="recap">&nbsp;</a><a class="target" name="recap">&nbsp;</a><a class="target" name="toc4">&nbsp;</a><h1>Recap</h1>
<p>


We hope that you can see how easy this was. It's quite straightforward, even if you're not that familiar with programming. We'll have to do a bit more and clean up the things next time, but in substance you only need to define a rigid boundary and then move the things across that boundary. Pretty soon you'll realize that all the code you write will be on the non-specific side anyway, and you won't need to write any more Windows code. 

</p><p>

Next time, we'll continue bringing things over, and continue fulfilling the promises to the game we set above.

</p>
<a class="target" name="programmingnotions">&nbsp;</a><a class="target" name="programmingnotions">&nbsp;</a><a class="target" name="toc5">&nbsp;</a><h1>Programming Notions</h1>

<a class="target" name="headerfiles">&nbsp;</a><a class="target" name="programmingnotions/headerfiles">&nbsp;</a><a class="target" name="toc5.1">&nbsp;</a><h2>Header Files</h2>
<p>


You might have noticed that, in our <code>win32_handmade.cpp</code> file, we basically divided the code in two parts. On top, we store all our <code>typedef</code>s, <code>struct</code>s and the like. In the bottom, we have the code which actually operates on them. 

</p><p>

C programming language has actually created a solution to separate the code part from the declarations part. It's simply another text file called &ldquo;Header File&rdquo; (as opposed to the &ldquo;Source File&rdquo; such a <code>.cpp</code>). 

</p><p>

You've seen Header files already: we <code>#include</code>d them to speak with the various parts of the operating system. Header files usually have <code>.h</code> extension. 

</p><p>

What do you put in the header files? Well, as with the source file we've seen so far: whatever makes your code compile and run, as well as keep yourself and your code organized. You then <code>#include</code> at the beginning of your source files as if they were always part of it.

</p><p>

There's more to header files and the extensions that relies mainly on established conventions. For instance, usually you want to <em class="underscore">guard</em> your header file with a couple of preprocessor directives. This way, if your header file is <code>#include</code>d more than once into your code, the successive includes are ignored and there are no naming conflicts. To do that, we use the following structure: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> !defined(Header_file_unique_name)</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-comment">// ...</span></span>
<span class="line"><span class="hljs-comment">// ... header file contents</span></span>
<span class="line"><span class="hljs-comment">// ...</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> Header_file_unique_name</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span></code></pre><p>

Hopefully you can see what's going on here: We wrap the whole code inside one big <code>#if</code> directive, and only &ldquo;read&rdquo; it if it's the first time we read this file (when the unique name is not defined). Once we arrive to the end, we <code>#define</code> the unique name that prevents us from accessing the contents of the file again.

</p><p>

<div class="admonition ">You can also find that some files use <code>#ifndef Header_file_unique_name</code> preprocessor directive instead of <code>#if !defined(Header_file_unique_name)</code> which accomplishes the same thing. You can use the one at your preference.</div>

</p><p>

For more information on Translation Units, Function Pointers, Compilation, Linking and Execution, watch this?.

</p><p>

<em class="underscore">(Back to subsection  <a href="#toc1.2">1.2</a>)</em>

</p>
<a class="target" name="sideconsiderations">&nbsp;</a><a class="target" name="sideconsiderations">&nbsp;</a><a class="target" name="toc6">&nbsp;</a><h1>Side Considerations</h1>

<a class="target" name="unitybuilds">&nbsp;</a><a class="target" name="sideconsiderations/unitybuilds">&nbsp;</a><a class="target" name="toc6.1">&nbsp;</a><h2>Unity Builds</h2>
<p>


It's usual that, in your build environment you will find yourself with more than one file. And usually, what ends up happening is that you start adding those files to the <code>cl</code> line of your <code>build.bat</code>:

</p><pre class="listing tilde"><code><span class="line">`cl -DHANDMADE_WIN32=1 -FC -Zi ..\code\win32_handmade.cpp ..\code\handmade.cpp ..\code\file1.cpp ..\code\file2.cpp ... user32.lib gdi32.lib</span></code></pre><p>

Of course, this becomes quite messy quite quickly, so most people end up with complicated make systems which list various files they need, call <code>cl</code> on them multiple times, pass specific options to them... all sorts of things. We will never touch these build systems on this course, but there's a whole world to discover if that's your cup of tea!

</p><p>

The bottom line is that, even if you used manual system like <code>build.bat</code> we use, you'd often have to come in and add more files to build. This is not something we do. One noticeable thing is that it takes longer to compile, so instead we use the approach that many people call the &ldquo;Unity Build&rdquo;.

</p><p>

Unity Build (not to be confused with Unity 3D, the game engine, or Unity, the Microsoft Unity Framework for C#) is the concept that you have only one <em class="underscore">translation unit</em> in your entire project (i.e. a single &ldquo;file&rdquo; after <code>#include</code> files were already included, and <code>#define</code> macros have been already expanded). What that means is that <code>win32_handmade.cpp</code> is the only file you'll ever compile for Win32 platform (and <code>linux_handmade.cpp</code> will be only file you'll compile on Linux). 

</p><p>

Why is it a good thing?
1. Compiling on a new platform is as easy as it gets. You literally only have to type the compile command and the file name, and it builds. That's it. There's nothing else that can go wrong. (Ok, it's not as easy. You might want to add some compile-time defines like we did with <code>-DHANDMADE_WIN32=1</code> and maybe some other compiler option but that's it). 
2. You never have to <em class="underscore">forward declare</em> (let compiler know about something's existence before you define it) almost anything. Usually you really should focus on keeping your header files clean, so that you can <code>#include</code> them into this or that translation unit. In our case, <code>.h</code> files are largely optional: since everything is in the same unit, if you stack things up roughly in the order you expect them to be called, it just kinda works. This allows you to get rid of the duplicate typing of the forward declarations.
3. It is <em class="underscore">crazy</em> fast compared to how long it takes to compile things the &ldquo;traditional&rdquo; way. There's a lot of startup time for the compiler, a lot of overhead to <code>#include</code> things... things that you simply don't experience if you only compile one thing. 

</p><p>

So this mostly the end of it, this is how we're going to do our builds pretty much until the end of the project.

</p><p>

<em class="underscore">(Continue to section  <a href="#toc2">2</a>)</em>

</p>
<a class="target" name="cleanupwin32_handmade.cpp%22header%22">&nbsp;</a><a class="target" name="sideconsiderations/cleanupwin32_handmade.cpp&ldquo;header&rdquo;">&nbsp;</a><a class="target" name="toc6.2">&nbsp;</a><h2>Clean Up <code>win32_handmade.cpp</code> &ldquo;Header&rdquo;</h2>
<p>


One thing that you might want to do is to clean up the <code>win32_handmade.cpp</code> header. Simply shuffle things around, so that <code>#include &lt;windows.h&gt;</code> is at the very bottom. It's a sensible thing to do if you don't trust yourself, or if you do, if you don't trust Windows code. It's not unreasonable: for instance, Windows might overwrite your macros with some of their own and you'll never know why your program doesn't work.

</p><pre class="listing tilde"><code><div class=" edit"><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int8_t</span> s8;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int16_t</span> s16;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int32_t</span> s32;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int64_t</span> s64;</span>
<span class="line"><span class="hljs-keyword">typedef</span> s32 b32;</span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint8_t</span> u8;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint16_t</span> u16;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint32_t</span> u32;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint64_t</span> u64;</span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">float</span> f32;</span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">double</span> f64;</span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> internal static</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> local_persist static</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> global_variable static</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> Pi32 3.14159265359f</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"handmade.cpp"</span></span></span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;xinput.h&gt;</span></span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dsound.h&gt;</span></span></span>
<span class="line"><span class="hljs-comment">// TODO(casey): Implement sine ourselves</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;math.h&gt;</span></span></span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;15:</b> <file>[win32_handmade.cpp]</file> Including the platform headers at the end.</div></center>
<p>


Again, we don't want our game to know anything about Windows, so including it before <code>windows.h</code> only makes sense.

</p>
<a class="target" name="navigation">&nbsp;</a><a class="target" name="navigation">&nbsp;</a><a class="target" name="toc7">&nbsp;</a><h1>Navigation</h1>
<p>


Previous: <a href="../html/day10.html">Day 10. QueryPerformanceCounter and RDTSC</a>

</p><p>

<a href="../index.md.html">Back to Index</a>

</p>
<div class="nonumberh1">Glossary</div>
<p>


<ul>
<li class="asterisk">Control flow
</li>
<li class="asterisk">Header files
</li>
<li class="asterisk">Header guards
</li>
<li class="asterisk">Platform
</li>
<li class="asterisk">Preprocessor
</li>
<li class="asterisk">Translation Units</li></ul>

</p>
<div class="nonumberh1">References</div>
<p>

<div class="nonumberh1">Talks</div>
<p>

    <a href="https://hero.handmade.network/episode/chat/chat013">Translation Units, Function Pointers, Compilation, Linking and Execution</a>

</p><p>

<style class="fallback">
  body {
    visibility: hidden;
    font-family: sans-serif;
  }
</style>

</p><p>

<script>markdeepOptions = { tocStyle: 'long' }; window.alreadyProcessedMarkdeep || (document.body.style.visibility = 'visible');</script>
</math.h></dsound.h></xinput.h></stdio.h></windows.h></stdint.h></windows.h></file></windows.h></file></p></span><div id="mdContextMenu" style="visibility:hidden"></div><div class="markdeepFooter"><i>formatted by <a href="https://casual-effects.com/markdeep" style="color:#999">Markdeep&nbsp;1.10&nbsp;&nbsp;</a></i><div style="display:inline-block;font-size:13px;font-family:'Times New Roman',serif;vertical-align:middle;transform:translate(-3px,-1px)rotate(135deg);">&#x2712;</div></div>