<meta charset="UTF-8">
<meta http-equiv="content-type" content="text/html;charset=UTF-8">
<meta name="viewport" content="width=600, initial-scale=1">
<link rel="stylesheet" href="../css/html-style.css">
<link rel="stylesheet" href="../css/style.css">

<span class="md"><p><title>Day 18. Enforcing a Video Frame Rate</title><div class="title"> Day 18. Enforcing a Video Frame Rate </div>

<div class="afterTitles"></div>
<em class="underscore">Video Length (including Q&A): <a href="https://hero.handmade.network/episode/code/day018/">1h27</a></em> 

</p><p>

Welcome to &ldquo;Handmade Hero Notes&rdquo;, the book where we follow the footsteps of <a href="https://handmadehero.org/">Handmade Hero</a> in making the complete game from scratch, with no external libraries. If you'd like to follow along, preorder the game on <a href="https://handmadehero.org/">handmadehero.org</a>, and you will receive access to the GitHub repository, containing complete source code (tagged day-by-day) as well as a variety of other useful resources.

</p><p>

We have a pretty big to-do item pending, that we will attempt at handling: we don't have a proper synchronized timing loop to drive our game. We want to tackle this item as soon as possible because all the decisions that we will be taking in game will be driven on the frame timing. So if we have that clocking wrong in the platform layer, we are at risk of getting a lot of tuning things incorrect, and we'll be forced to return and retune those things from the ground up. Let's make sure we won't need to do that.

</p>
<div class="longTOC"><p align="center">
    <span align="right"><a href="day17.html">Day 17</a></span>
    <a href="../index.html"><img src = "../media/logo.png"></a>
    <span align="left"><a href="day19.html">Day 19</a></span>
</p><p><a href="#" class="tocTop">(Top)</a><br/>
<a href="#setthegoals" class="level1"><span class="tocNumber">1&nbsp; </span>Set the Goals</a><br/>
&nbsp;&nbsp;<a href="#setthegoals/hardwareconcern" class="level2"><span class="tocNumber">1.1&nbsp; </span>Hardware Concern</a><br/>
&nbsp;&nbsp;<a href="#setthegoals/variableframeratemonitors" class="level2"><span class="tocNumber">1.2&nbsp; </span>Variable Framerate Monitors</a><br/>
&nbsp;&nbsp;<a href="#setthegoals/audio" class="level2"><span class="tocNumber">1.3&nbsp; </span>Audio</a><br/>
&nbsp;&nbsp;<a href="#setthegoals/conclusion" class="level2"><span class="tocNumber">1.4&nbsp; </span>Conclusion</a><br/>
<a href="#implementenforcedvideoframerate" class="level1"><span class="tocNumber">2&nbsp; </span>Implement Enforced Video Frame Rate</a><br/>
&nbsp;&nbsp;<a href="#implementenforcedvideoframerate/(not)getmonitorframerate" class="level2"><span class="tocNumber">2.1&nbsp; </span>(Not) Get Monitor Framerate</a><br/>
&nbsp;&nbsp;<a href="#implementenforcedvideoframerate/codeeverythingdown" class="level2"><span class="tocNumber">2.2&nbsp; </span>Code Everything Down</a><br/>
&nbsp;&nbsp;<a href="#implementenforcedvideoframerate/refactorclockingstats" class="level2"><span class="tocNumber">2.3&nbsp; </span>Refactor Clocking Stats</a><br/>
&nbsp;&nbsp;<a href="#implementenforcedvideoframerate/checkformissedtarget" class="level2"><span class="tocNumber">2.4&nbsp; </span>Check for Missed Target</a><br/>
<a href="#sleep" class="level1"><span class="tocNumber">3&nbsp; </span>Sleep</a><br/>
&nbsp;&nbsp;<a href="#sleep/setwindowsschedulergranularity" class="level2"><span class="tocNumber">3.1&nbsp; </span>Set Windows Scheduler Granularity</a><br/>
&nbsp;&nbsp;<a href="#sleep/testthechanges" class="level2"><span class="tocNumber">3.2&nbsp; </span>Test the Changes</a><br/>
<a href="#recap" class="level1"><span class="tocNumber">4&nbsp; </span>Recap</a><br/>
<a href="#navigation" class="level1"><span class="tocNumber">5&nbsp; </span>Navigation</a><br/>
</p></div><a class="target" name="setthegoals">&nbsp;</a><a class="target" name="setthegoals">&nbsp;</a><a class="target" name="toc1">&nbsp;</a><h1>Set the Goals</h1>
<p>


Before we start doing any coding, we need to understand what we want to achieve. If you remember, this is how we were representing our game work over time:

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="256" width="344" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 24,80 L 24,112 " style="fill:none;"/>
<path d="M 24,144 L 24,176 " style="fill:none;"/>
<path d="M 80,80 L 80,112 " style="fill:none;"/>
<path d="M 112,32 L 112,48 " style="fill:none;"/>
<path d="M 136,80 L 136,112 " style="fill:none;"/>
<path d="M 168,32 L 168,48 " style="fill:none;"/>
<path d="M 192,80 L 192,120 " style="fill:none;"/>
<path d="M 192,144 L 192,176 " style="fill:none;"/>
<path d="M 248,80 L 248,112 " style="fill:none;"/>
<path d="M 48,48 L 56,48 " style="fill:none;"/>
<path d="M 104,48 L 112,48 " style="fill:none;"/>
<path d="M 160,48 L 168,48 " style="fill:none;"/>
<path d="M 216,48 L 224,48 " style="fill:none;"/>
<path d="M 24,96 L 304,96 " style="fill:none;"/>
<path d="M 80,144 L 96,176 " style="fill:none;"/>
<path d="M 136,144 L 152,176 " style="fill:none;"/>
<path d="M 216,32 L 224,48 " style="fill:none;"/>
<path d="M 56,48 L 64,32 " style="fill:none;"/>
<path d="M 232,176 L 248,144 " style="fill:none;"/>
<path d="M 48,48 C 31.2,48 32,64 32,64 " style="fill:none;"/>
<path d="M 56,48 C 72.8,48 72,64 72,64 " style="fill:none;"/>
<path d="M 104,48 C 87.2,48 88,64 88,64 " style="fill:none;"/>
<path d="M 112,48 C 128.8,48 128,64 128,64 " style="fill:none;"/>
<path d="M 160,48 C 143.2,48 144,64 144,64 " style="fill:none;"/>
<path d="M 168,48 C 184.8,48 184,64 184,64 " style="fill:none;"/>
<path d="M 216,48 C 199.2,48 200,64 200,64 " style="fill:none;"/>
<path d="M 224,48 C 240.8,48 240,64 240,64 " style="fill:none;"/>
<polygon points="312,96 300,90.4 300,101.6 "  style="stroke:none" transform="rotate(0,304,96 )"/>
<polygon points="256,144 244,138.4 244,149.6 "  style="stroke:none" transform="rotate(296.565051177078,248,144 )"/>
<polygon points="200,144 188,138.4 188,149.6 "  style="stroke:none" transform="rotate(270,192,144 )"/>
<polygon points="144,144 132,138.4 132,149.6 "  style="stroke:none" transform="rotate(243.43494882292202,136,144 )"/>
<polygon points="88,144 76,138.4 76,149.6 "  style="stroke:none" transform="rotate(243.43494882292202,80,144 )"/>
<polygon points="32,144 20,138.4 20,149.6 "  style="stroke:none" transform="rotate(270,24,144 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="72" y="4">G</text><text text-anchor="middle" x="80" y="4">a</text><text text-anchor="middle" x="88" y="4">m</text><text text-anchor="middle" x="96" y="4">e</text><text text-anchor="middle" x="104" y="4">U</text><text text-anchor="middle" x="112" y="4">p</text><text text-anchor="middle" x="120" y="4">d</text><text text-anchor="middle" x="128" y="4">a</text><text text-anchor="middle" x="136" y="4">t</text><text text-anchor="middle" x="144" y="4">e</text><text text-anchor="middle" x="152" y="4">A</text><text text-anchor="middle" x="160" y="4">n</text><text text-anchor="middle" x="168" y="4">d</text><text text-anchor="middle" x="176" y="4">R</text><text text-anchor="middle" x="184" y="4">e</text><text text-anchor="middle" x="192" y="4">n</text><text text-anchor="middle" x="200" y="4">d</text><text text-anchor="middle" x="208" y="4">e</text><text text-anchor="middle" x="216" y="4">r</text><text text-anchor="middle" x="96" y="20">d</text><text text-anchor="middle" x="104" y="20">o</text><text text-anchor="middle" x="112" y="20">e</text><text text-anchor="middle" x="120" y="20">s</text><text text-anchor="middle" x="136" y="20">i</text><text text-anchor="middle" x="144" y="20">t</text><text text-anchor="middle" x="152" y="20">s</text><text text-anchor="middle" x="168" y="20">w</text><text text-anchor="middle" x="176" y="20">o</text><text text-anchor="middle" x="184" y="20">r</text><text text-anchor="middle" x="192" y="20">k</text><text text-anchor="middle" x="296" y="84">t</text><text text-anchor="middle" x="304" y="84">i</text><text text-anchor="middle" x="312" y="84">m</text><text text-anchor="middle" x="320" y="84">e</text><text text-anchor="middle" x="24" y="132">0</text><text text-anchor="middle" x="80" y="132">1</text><text text-anchor="middle" x="136" y="132">2</text><text text-anchor="middle" x="184" y="132">.</text><text text-anchor="middle" x="192" y="132">.</text><text text-anchor="middle" x="200" y="132">.</text><text text-anchor="middle" x="248" y="132">N</text><text text-anchor="middle" x="16" y="196">g</text><text text-anchor="middle" x="24" y="196">a</text><text text-anchor="middle" x="32" y="196">m</text><text text-anchor="middle" x="40" y="196">e</text><text text-anchor="middle" x="104" y="196">n</text><text text-anchor="middle" x="112" y="196">e</text><text text-anchor="middle" x="120" y="196">x</text><text text-anchor="middle" x="128" y="196">t</text><text text-anchor="middle" x="144" y="196">f</text><text text-anchor="middle" x="152" y="196">r</text><text text-anchor="middle" x="160" y="196">a</text><text text-anchor="middle" x="168" y="196">m</text><text text-anchor="middle" x="176" y="196">e</text><text text-anchor="middle" x="192" y="196">i</text><text text-anchor="middle" x="200" y="196">s</text><text text-anchor="middle" x="216" y="196">d</text><text text-anchor="middle" x="224" y="196">i</text><text text-anchor="middle" x="232" y="196">s</text><text text-anchor="middle" x="240" y="196">p</text><text text-anchor="middle" x="248" y="196">l</text><text text-anchor="middle" x="256" y="196">a</text><text text-anchor="middle" x="264" y="196">y</text><text text-anchor="middle" x="272" y="196">e</text><text text-anchor="middle" x="280" y="196">d</text><text text-anchor="middle" x="16" y="212">s</text><text text-anchor="middle" x="24" y="212">t</text><text text-anchor="middle" x="32" y="212">a</text><text text-anchor="middle" x="40" y="212">r</text><text text-anchor="middle" x="48" y="212">t</text><text text-anchor="middle" x="56" y="212">s</text><text text-anchor="middle" x="16" y="228">r</text><text text-anchor="middle" x="24" y="228">u</text><text text-anchor="middle" x="32" y="228">n</text><text text-anchor="middle" x="40" y="228">n</text><text text-anchor="middle" x="48" y="228">i</text><text text-anchor="middle" x="56" y="228">n</text><text text-anchor="middle" x="64" y="228">g</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;1:</b> Game work over time.</div></center>

</p><p>

We can even say that there's time before 0. Game starts running and does all the prep work: creates window, loads assets, reserves memory, etc., before entering into the main loop. At one point we will hit our first <code>QueryPerformanceCounter</code>, which will effectively be the spot for time counting for us: the frame zero.

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="272" width="496" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 8,80 L 8,112 " style="fill:none;"/>
<path d="M 8,144 L 8,176 " style="fill:none;"/>
<path d="M 136,80 L 136,112 " style="fill:none;"/>
<path d="M 136,144 L 136,176 " style="fill:none;"/>
<path d="M 192,80 L 192,112 " style="fill:none;"/>
<path d="M 224,32 L 224,48 " style="fill:none;"/>
<path d="M 248,80 L 248,112 " style="fill:none;"/>
<path d="M 280,32 L 280,48 " style="fill:none;"/>
<path d="M 304,80 L 304,120 " style="fill:none;"/>
<path d="M 304,144 L 304,176 " style="fill:none;"/>
<path d="M 360,80 L 360,112 " style="fill:none;"/>
<path d="M 416,96 L 416,112 " style="fill:none;"/>
<path d="M 416,144 L 416,176 " style="fill:none;"/>
<path d="M 32,48 L 56,48 " style="fill:none;"/>
<path d="M 88,48 L 112,48 " style="fill:none;"/>
<path d="M 160,48 L 168,48 " style="fill:none;"/>
<path d="M 216,48 L 224,48 " style="fill:none;"/>
<path d="M 272,48 L 280,48 " style="fill:none;"/>
<path d="M 328,48 L 336,48 " style="fill:none;"/>
<path d="M 8,96 L 456,96 " style="fill:none;"/>
<path d="M 192,144 L 208,176 " style="fill:none;"/>
<path d="M 248,144 L 264,176 " style="fill:none;"/>
<path d="M 328,32 L 336,48 " style="fill:none;"/>
<path d="M 168,48 L 176,32 " style="fill:none;"/>
<path d="M 344,176 L 360,144 " style="fill:none;"/>
<path d="M 32,48 C 15.2,48 16,64 16,64 " style="fill:none;"/>
<path d="M 56,48 C 72.8,48 72,32 72,32 " style="fill:none;"/>
<path d="M 88,48 C 71.2,48 72,32 72,32 " style="fill:none;"/>
<path d="M 112,48 C 128.8,48 128,64 128,64 " style="fill:none;"/>
<path d="M 160,48 C 143.2,48 144,64 144,64 " style="fill:none;"/>
<path d="M 168,48 C 184.8,48 184,64 184,64 " style="fill:none;"/>
<path d="M 216,48 C 199.2,48 200,64 200,64 " style="fill:none;"/>
<path d="M 224,48 C 240.8,48 240,64 240,64 " style="fill:none;"/>
<path d="M 272,48 C 255.2,48 256,64 256,64 " style="fill:none;"/>
<path d="M 280,48 C 296.8,48 296,64 296,64 " style="fill:none;"/>
<path d="M 328,48 C 311.2,48 312,64 312,64 " style="fill:none;"/>
<path d="M 336,48 C 352.8,48 352,64 352,64 " style="fill:none;"/>
<polygon points="464,96 452,90.4 452,101.6 "  style="stroke:none" transform="rotate(0,456,96 )"/>
<polygon points="424,144 412,138.4 412,149.6 "  style="stroke:none" transform="rotate(270,416,144 )"/>
<polygon points="368,144 356,138.4 356,149.6 "  style="stroke:none" transform="rotate(296.565051177078,360,144 )"/>
<polygon points="312,144 300,138.4 300,149.6 "  style="stroke:none" transform="rotate(270,304,144 )"/>
<polygon points="256,144 244,138.4 244,149.6 "  style="stroke:none" transform="rotate(243.43494882292202,248,144 )"/>
<polygon points="200,144 188,138.4 188,149.6 "  style="stroke:none" transform="rotate(243.43494882292202,192,144 )"/>
<polygon points="144,144 132,138.4 132,149.6 "  style="stroke:none" transform="rotate(270,136,144 )"/>
<polygon points="16,144 4,138.4 4,149.6 "  style="stroke:none" transform="rotate(270,8,144 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="184" y="4">G</text><text text-anchor="middle" x="192" y="4">a</text><text text-anchor="middle" x="200" y="4">m</text><text text-anchor="middle" x="208" y="4">e</text><text text-anchor="middle" x="216" y="4">U</text><text text-anchor="middle" x="224" y="4">p</text><text text-anchor="middle" x="232" y="4">d</text><text text-anchor="middle" x="240" y="4">a</text><text text-anchor="middle" x="248" y="4">t</text><text text-anchor="middle" x="256" y="4">e</text><text text-anchor="middle" x="264" y="4">A</text><text text-anchor="middle" x="272" y="4">n</text><text text-anchor="middle" x="280" y="4">d</text><text text-anchor="middle" x="288" y="4">R</text><text text-anchor="middle" x="296" y="4">e</text><text text-anchor="middle" x="304" y="4">n</text><text text-anchor="middle" x="312" y="4">d</text><text text-anchor="middle" x="320" y="4">e</text><text text-anchor="middle" x="328" y="4">r</text><text text-anchor="middle" x="16" y="20">L</text><text text-anchor="middle" x="24" y="20">a</text><text text-anchor="middle" x="32" y="20">n</text><text text-anchor="middle" x="40" y="20">d</text><text text-anchor="middle" x="48" y="20">s</text><text text-anchor="middle" x="64" y="20">B</text><text text-anchor="middle" x="72" y="20">e</text><text text-anchor="middle" x="80" y="20">f</text><text text-anchor="middle" x="88" y="20">o</text><text text-anchor="middle" x="96" y="20">r</text><text text-anchor="middle" x="104" y="20">e</text><text text-anchor="middle" x="120" y="20">T</text><text text-anchor="middle" x="128" y="20">i</text><text text-anchor="middle" x="136" y="20">m</text><text text-anchor="middle" x="144" y="20">e</text><text text-anchor="middle" x="208" y="20">d</text><text text-anchor="middle" x="216" y="20">o</text><text text-anchor="middle" x="224" y="20">e</text><text text-anchor="middle" x="232" y="20">s</text><text text-anchor="middle" x="248" y="20">i</text><text text-anchor="middle" x="256" y="20">t</text><text text-anchor="middle" x="264" y="20">s</text><text text-anchor="middle" x="280" y="20">w</text><text text-anchor="middle" x="288" y="20">o</text><text text-anchor="middle" x="296" y="20">r</text><text text-anchor="middle" x="304" y="20">k</text><text text-anchor="middle" x="448" y="84">t</text><text text-anchor="middle" x="456" y="84">i</text><text text-anchor="middle" x="464" y="84">m</text><text text-anchor="middle" x="472" y="84">e</text><text text-anchor="middle" x="136" y="132">0</text><text text-anchor="middle" x="192" y="132">1</text><text text-anchor="middle" x="248" y="132">2</text><text text-anchor="middle" x="296" y="132">.</text><text text-anchor="middle" x="304" y="132">.</text><text text-anchor="middle" x="312" y="132">.</text><text text-anchor="middle" x="360" y="132">N</text><text text-anchor="middle" x="8" y="196">g</text><text text-anchor="middle" x="16" y="196">a</text><text text-anchor="middle" x="24" y="196">m</text><text text-anchor="middle" x="32" y="196">e</text><text text-anchor="middle" x="128" y="196">f</text><text text-anchor="middle" x="136" y="196">i</text><text text-anchor="middle" x="144" y="196">r</text><text text-anchor="middle" x="152" y="196">s</text><text text-anchor="middle" x="160" y="196">t</text><text text-anchor="middle" x="200" y="196">N</text><text text-anchor="middle" x="208" y="196">e</text><text text-anchor="middle" x="216" y="196">x</text><text text-anchor="middle" x="224" y="196">t</text><text text-anchor="middle" x="240" y="196">f</text><text text-anchor="middle" x="248" y="196">r</text><text text-anchor="middle" x="256" y="196">a</text><text text-anchor="middle" x="264" y="196">m</text><text text-anchor="middle" x="272" y="196">e</text><text text-anchor="middle" x="288" y="196">i</text><text text-anchor="middle" x="296" y="196">s</text><text text-anchor="middle" x="312" y="196">d</text><text text-anchor="middle" x="320" y="196">i</text><text text-anchor="middle" x="328" y="196">s</text><text text-anchor="middle" x="336" y="196">p</text><text text-anchor="middle" x="344" y="196">l</text><text text-anchor="middle" x="352" y="196">a</text><text text-anchor="middle" x="360" y="196">y</text><text text-anchor="middle" x="368" y="196">e</text><text text-anchor="middle" x="376" y="196">d</text><text text-anchor="middle" x="416" y="196">g</text><text text-anchor="middle" x="424" y="196">a</text><text text-anchor="middle" x="432" y="196">m</text><text text-anchor="middle" x="440" y="196">e</text><text text-anchor="middle" x="8" y="212">s</text><text text-anchor="middle" x="16" y="212">t</text><text text-anchor="middle" x="24" y="212">a</text><text text-anchor="middle" x="32" y="212">r</text><text text-anchor="middle" x="40" y="212">t</text><text text-anchor="middle" x="48" y="212">s</text><text text-anchor="middle" x="128" y="212">t</text><text text-anchor="middle" x="136" y="212">i</text><text text-anchor="middle" x="144" y="212">m</text><text text-anchor="middle" x="152" y="212">e</text><text text-anchor="middle" x="248" y="212">&quot;</text><text text-anchor="middle" x="256" y="212">f</text><text text-anchor="middle" x="264" y="212">r</text><text text-anchor="middle" x="272" y="212">a</text><text text-anchor="middle" x="280" y="212">m</text><text text-anchor="middle" x="288" y="212">e</text><text text-anchor="middle" x="304" y="212">f</text><text text-anchor="middle" x="312" y="212">l</text><text text-anchor="middle" x="320" y="212">i</text><text text-anchor="middle" x="328" y="212">p</text><text text-anchor="middle" x="336" y="212">&quot;</text><text text-anchor="middle" x="416" y="212">e</text><text text-anchor="middle" x="424" y="212">x</text><text text-anchor="middle" x="432" y="212">i</text><text text-anchor="middle" x="440" y="212">t</text><text text-anchor="middle" x="448" y="212">s</text><text text-anchor="middle" x="8" y="228">r</text><text text-anchor="middle" x="16" y="228">u</text><text text-anchor="middle" x="24" y="228">n</text><text text-anchor="middle" x="32" y="228">n</text><text text-anchor="middle" x="40" y="228">i</text><text text-anchor="middle" x="48" y="228">n</text><text text-anchor="middle" x="56" y="228">g</text><text text-anchor="middle" x="128" y="228">m</text><text text-anchor="middle" x="136" y="228">e</text><text text-anchor="middle" x="144" y="228">a</text><text text-anchor="middle" x="152" y="228">s</text><text text-anchor="middle" x="160" y="228">u</text><text text-anchor="middle" x="168" y="228">r</text><text text-anchor="middle" x="176" y="228">e</text><text text-anchor="middle" x="184" y="228">m</text><text text-anchor="middle" x="192" y="228">e</text><text text-anchor="middle" x="200" y="228">n</text><text text-anchor="middle" x="208" y="228">t</text><text text-anchor="middle" x="128" y="244">(</text><text text-anchor="middle" x="136" y="244">u</text><text text-anchor="middle" x="144" y="244">s</text><text text-anchor="middle" x="152" y="244">i</text><text text-anchor="middle" x="160" y="244">n</text><text text-anchor="middle" x="168" y="244">g</text><text text-anchor="middle" x="184" y="244">Q</text><text text-anchor="middle" x="192" y="244">u</text><text text-anchor="middle" x="200" y="244">e</text><text text-anchor="middle" x="208" y="244">r</text><text text-anchor="middle" x="216" y="244">y</text><text text-anchor="middle" x="224" y="244">P</text><text text-anchor="middle" x="232" y="244">e</text><text text-anchor="middle" x="240" y="244">r</text><text text-anchor="middle" x="248" y="244">f</text><text text-anchor="middle" x="256" y="244">o</text><text text-anchor="middle" x="264" y="244">r</text><text text-anchor="middle" x="272" y="244">m</text><text text-anchor="middle" x="280" y="244">a</text><text text-anchor="middle" x="288" y="244">n</text><text text-anchor="middle" x="296" y="244">c</text><text text-anchor="middle" x="304" y="244">e</text><text text-anchor="middle" x="312" y="244">C</text><text text-anchor="middle" x="320" y="244">o</text><text text-anchor="middle" x="328" y="244">u</text><text text-anchor="middle" x="336" y="244">n</text><text text-anchor="middle" x="344" y="244">t</text><text text-anchor="middle" x="352" y="244">e</text><text text-anchor="middle" x="360" y="244">r</text><text text-anchor="middle" x="368" y="244">)</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;2:</b> Actual game lifetime.</div></center>

</p><p>

During frame 0 (and, of course, before that) the game will display <em class="underscore">nothing</em>. If anything, we've just cleared our window to blackness while we're working on frame 1. This technically allows us to push our count of frames to start <em class="underscore">after</em> we start displaying something.... it's something we can decide at a later point. 

</p><p>

If we zoom in a bit, we can see that during frame 0, we compute game's audio and video, after which we request &ldquo;frame flip&rdquo;. In an ideal world, during frame 1 we'll see and hear what we computed.

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="192" width="392" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 56,0 L 56,112 " style="fill:none;"/>
<path d="M 200,0 L 200,112 " style="fill:none;"/>
<path d="M 344,0 L 344,120 " style="fill:none;"/>
<path d="M 56,48 L 344,48 " style="fill:none;"/>
<path d="M 24,96 L 368,96 " style="fill:none;"/>
<polygon points="376,96 364,90.4 364,101.6 "  style="stroke:none" transform="rotate(0,368,96 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="16" y="20">W</text><text text-anchor="middle" x="24" y="20">O</text><text text-anchor="middle" x="32" y="20">R</text><text text-anchor="middle" x="40" y="20">K</text><text text-anchor="middle" x="72" y="20">c</text><text text-anchor="middle" x="80" y="20">o</text><text text-anchor="middle" x="88" y="20">m</text><text text-anchor="middle" x="96" y="20">p</text><text text-anchor="middle" x="104" y="20">u</text><text text-anchor="middle" x="112" y="20">t</text><text text-anchor="middle" x="120" y="20">e</text><text text-anchor="middle" x="136" y="20">f</text><text text-anchor="middle" x="144" y="20">r</text><text text-anchor="middle" x="152" y="20">a</text><text text-anchor="middle" x="160" y="20">m</text><text text-anchor="middle" x="168" y="20">e</text><text text-anchor="middle" x="184" y="20">0</text><text text-anchor="middle" x="216" y="20">c</text><text text-anchor="middle" x="224" y="20">o</text><text text-anchor="middle" x="232" y="20">m</text><text text-anchor="middle" x="240" y="20">p</text><text text-anchor="middle" x="248" y="20">u</text><text text-anchor="middle" x="256" y="20">t</text><text text-anchor="middle" x="264" y="20">e</text><text text-anchor="middle" x="280" y="20">f</text><text text-anchor="middle" x="288" y="20">r</text><text text-anchor="middle" x="296" y="20">a</text><text text-anchor="middle" x="304" y="20">m</text><text text-anchor="middle" x="312" y="20">e</text><text text-anchor="middle" x="328" y="20">1</text><text text-anchor="middle" x="72" y="36">a</text><text text-anchor="middle" x="80" y="36">u</text><text text-anchor="middle" x="88" y="36">d</text><text text-anchor="middle" x="96" y="36">i</text><text text-anchor="middle" x="104" y="36">o</text><text text-anchor="middle" x="120" y="36">a</text><text text-anchor="middle" x="128" y="36">n</text><text text-anchor="middle" x="136" y="36">d</text><text text-anchor="middle" x="152" y="36">v</text><text text-anchor="middle" x="160" y="36">i</text><text text-anchor="middle" x="168" y="36">d</text><text text-anchor="middle" x="176" y="36">e</text><text text-anchor="middle" x="184" y="36">o</text><text text-anchor="middle" x="216" y="36">a</text><text text-anchor="middle" x="224" y="36">u</text><text text-anchor="middle" x="232" y="36">d</text><text text-anchor="middle" x="240" y="36">i</text><text text-anchor="middle" x="248" y="36">o</text><text text-anchor="middle" x="264" y="36">a</text><text text-anchor="middle" x="272" y="36">n</text><text text-anchor="middle" x="280" y="36">d</text><text text-anchor="middle" x="296" y="36">v</text><text text-anchor="middle" x="304" y="36">i</text><text text-anchor="middle" x="312" y="36">d</text><text text-anchor="middle" x="320" y="36">e</text><text text-anchor="middle" x="328" y="36">o</text><text text-anchor="middle" x="8" y="68">O</text><text text-anchor="middle" x="16" y="68">U</text><text text-anchor="middle" x="24" y="68">T</text><text text-anchor="middle" x="32" y="68">P</text><text text-anchor="middle" x="40" y="68">U</text><text text-anchor="middle" x="48" y="68">T</text><text text-anchor="middle" x="96" y="68">B</text><text text-anchor="middle" x="104" y="68">L</text><text text-anchor="middle" x="112" y="68">A</text><text text-anchor="middle" x="120" y="68">C</text><text text-anchor="middle" x="128" y="68">K</text><text text-anchor="middle" x="136" y="68">N</text><text text-anchor="middle" x="144" y="68">E</text><text text-anchor="middle" x="152" y="68">S</text><text text-anchor="middle" x="160" y="68">S</text><text text-anchor="middle" x="208" y="68">f</text><text text-anchor="middle" x="216" y="68">r</text><text text-anchor="middle" x="224" y="68">a</text><text text-anchor="middle" x="232" y="68">m</text><text text-anchor="middle" x="240" y="68">e</text><text text-anchor="middle" x="256" y="68">0</text><text text-anchor="middle" x="272" y="68">d</text><text text-anchor="middle" x="280" y="68">i</text><text text-anchor="middle" x="288" y="68">s</text><text text-anchor="middle" x="296" y="68">p</text><text text-anchor="middle" x="304" y="68">l</text><text text-anchor="middle" x="312" y="68">a</text><text text-anchor="middle" x="320" y="68">y</text><text text-anchor="middle" x="328" y="68">e</text><text text-anchor="middle" x="336" y="68">d</text><text text-anchor="middle" x="104" y="84">s</text><text text-anchor="middle" x="112" y="84">i</text><text text-anchor="middle" x="120" y="84">l</text><text text-anchor="middle" x="128" y="84">e</text><text text-anchor="middle" x="136" y="84">n</text><text text-anchor="middle" x="144" y="84">c</text><text text-anchor="middle" x="152" y="84">e</text><text text-anchor="middle" x="216" y="84">a</text><text text-anchor="middle" x="224" y="84">u</text><text text-anchor="middle" x="232" y="84">d</text><text text-anchor="middle" x="240" y="84">i</text><text text-anchor="middle" x="248" y="84">o</text><text text-anchor="middle" x="264" y="84">r</text><text text-anchor="middle" x="272" y="84">e</text><text text-anchor="middle" x="280" y="84">p</text><text text-anchor="middle" x="288" y="84">r</text><text text-anchor="middle" x="296" y="84">o</text><text text-anchor="middle" x="304" y="84">d</text><text text-anchor="middle" x="312" y="84">u</text><text text-anchor="middle" x="320" y="84">c</text><text text-anchor="middle" x="328" y="84">e</text><text text-anchor="middle" x="336" y="84">d</text><text text-anchor="middle" x="8" y="100">.</text><text text-anchor="middle" x="16" y="100">.</text><text text-anchor="middle" x="368" y="116">t</text><text text-anchor="middle" x="56" y="132">0</text><text text-anchor="middle" x="200" y="132">0</text><text text-anchor="middle" x="208" y="132">²</text><text text-anchor="middle" x="336" y="132">.</text><text text-anchor="middle" x="344" y="132">.</text><text text-anchor="middle" x="352" y="132">.</text><text text-anchor="middle" x="32" y="148">f</text><text text-anchor="middle" x="40" y="148">i</text><text text-anchor="middle" x="48" y="148">r</text><text text-anchor="middle" x="56" y="148">s</text><text text-anchor="middle" x="64" y="148">t</text><text text-anchor="middle" x="80" y="148">l</text><text text-anchor="middle" x="88" y="148">o</text><text text-anchor="middle" x="96" y="148">o</text><text text-anchor="middle" x="104" y="148">k</text><text text-anchor="middle" x="168" y="148">f</text><text text-anchor="middle" x="176" y="148">i</text><text text-anchor="middle" x="184" y="148">r</text><text text-anchor="middle" x="192" y="148">s</text><text text-anchor="middle" x="200" y="148">t</text><text text-anchor="middle" x="216" y="148">f</text><text text-anchor="middle" x="224" y="148">r</text><text text-anchor="middle" x="232" y="148">a</text><text text-anchor="middle" x="240" y="148">m</text><text text-anchor="middle" x="248" y="148">e</text><text text-anchor="middle" x="40" y="164">a</text><text text-anchor="middle" x="48" y="164">t</text><text text-anchor="middle" x="64" y="164">Q</text><text text-anchor="middle" x="72" y="164">P</text><text text-anchor="middle" x="80" y="164">C</text><text text-anchor="middle" x="192" y="164">f</text><text text-anchor="middle" x="200" y="164">l</text><text text-anchor="middle" x="208" y="164">i</text><text text-anchor="middle" x="216" y="164">p</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;3:</b> First frames work and output.</div></center>

</p><p>

Before the first image is displayed and the first sound is played, an arbitrarily long amount of time can pass. Maybe not that much to annoy the user, but as far as the user is concerned they won't see or hear any glitches: the game is just starting up. However, for frame 0 onwards we do care about how much time has passed. Each frame will have a limited, <strong class="asterisk">fixed</strong> duration of time to compute the next one. 

</p>
<a class="target" name="hardwareconcern">&nbsp;</a><a class="target" name="setthegoals/hardwareconcern">&nbsp;</a><a class="target" name="toc1.1">&nbsp;</a><h2>Hardware Concern</h2>
<p>


We need the duration of the frame to be fixed for the game to operate properly. One of the reasons for it is in the hardware. Usually monitors operate at a fixed refresh rate: 60Hz, 90Hz, 144Hz, and so on. If our isn't fixed, or differs significantly from the monitor's, eventually we will miss a frame: 

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="304" width="496" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 144,0 L 144,32 " style="fill:none;"/>
<path d="M 144,160 L 144,192 " style="fill:none;"/>
<path d="M 152,64 L 152,80 " style="fill:none;"/>
<path d="M 184,144 L 184,192 " style="fill:none;"/>
<path d="M 200,0 L 200,32 " style="fill:none;"/>
<path d="M 200,64 L 200,80 " style="fill:none;"/>
<path d="M 224,128 L 224,192 " style="fill:none;"/>
<path d="M 256,0 L 256,32 " style="fill:none;"/>
<path d="M 256,64 L 256,144 " style="fill:none;"/>
<path d="M 264,176 L 264,192 " style="fill:none;"/>
<path d="M 304,96 L 304,192 " style="fill:none;"/>
<path d="M 312,0 L 312,32 " style="fill:none;"/>
<path d="M 344,128 L 344,192 " style="fill:none;"/>
<path d="M 368,0 L 368,32 " style="fill:none;"/>
<path d="M 424,0 L 424,32 " style="fill:none;"/>
<path d="M 144,16 L 464,16 " style="fill:none;"/>
<path d="M 256,80 L 288,80 " style="fill:none;"/>
<path d="M 144,176 L 384,176 " style="fill:none;"/>
<path d="M 280,240 L 288,240 " style="fill:none;"/>
<path d="M 320,240 L 328,240 " style="fill:none;"/>
<path d="M 152,80 L 184,144 " style="fill:none;"/>
<path d="M 200,80 L 224,128 " style="fill:none;"/>
<path d="M 256,144 L 268,168 " style="fill:none;"/>
<path d="M 312,64 L 344,128 " style="fill:none;"/>
<path d="M 288,80 C 304.8,80 304,96 304,96 " style="fill:none;"/>
<path d="M 280,240 C 263.2,240 264,224 264,224 " style="fill:none;"/>
<path d="M 288,240 C 304.8,240 304,256 304,256 " style="fill:none;"/>
<path d="M 320,240 C 303.2,240 304,256 304,256 " style="fill:none;"/>
<path d="M 328,240 C 344.8,240 344,224 344,224 " style="fill:none;"/>
<polygon points="472,16 460,10.4 460,21.6 "  style="stroke:none" transform="rotate(0,464,16 )"/>
<polygon points="392,176 380,170.4 380,181.6 "  style="stroke:none" transform="rotate(0,384,176 )"/>
<polygon points="320,64 308,58.4 308,69.6 "  style="stroke:none" transform="rotate(243.43494882292202,312,64 )"/>
<polygon points="264,64 252,58.4 252,69.6 "  style="stroke:none" transform="rotate(270,256,64 )"/>
<polygon points="208,64 196,58.4 196,69.6 "  style="stroke:none" transform="rotate(270,200,64 )"/>
<polygon points="160,64 148,58.4 148,69.6 "  style="stroke:none" transform="rotate(270,152,64 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="24" y="20">G</text><text text-anchor="middle" x="32" y="20">a</text><text text-anchor="middle" x="40" y="20">m</text><text text-anchor="middle" x="48" y="20">e</text><text text-anchor="middle" x="64" y="20">F</text><text text-anchor="middle" x="72" y="20">r</text><text text-anchor="middle" x="80" y="20">a</text><text text-anchor="middle" x="88" y="20">m</text><text text-anchor="middle" x="96" y="20">e</text><text text-anchor="middle" x="104" y="20">s</text><text text-anchor="middle" x="464" y="36">t</text><text text-anchor="middle" x="16" y="180">M</text><text text-anchor="middle" x="24" y="180">o</text><text text-anchor="middle" x="32" y="180">n</text><text text-anchor="middle" x="40" y="180">i</text><text text-anchor="middle" x="48" y="180">t</text><text text-anchor="middle" x="56" y="180">o</text><text text-anchor="middle" x="64" y="180">r</text><text text-anchor="middle" x="80" y="180">R</text><text text-anchor="middle" x="88" y="180">e</text><text text-anchor="middle" x="96" y="180">f</text><text text-anchor="middle" x="104" y="180">r</text><text text-anchor="middle" x="112" y="180">e</text><text text-anchor="middle" x="120" y="180">s</text><text text-anchor="middle" x="128" y="180">h</text><text text-anchor="middle" x="384" y="196">t</text><text text-anchor="middle" x="144" y="276">s</text><text text-anchor="middle" x="152" y="276">a</text><text text-anchor="middle" x="160" y="276">m</text><text text-anchor="middle" x="168" y="276">e</text><text text-anchor="middle" x="184" y="276">f</text><text text-anchor="middle" x="192" y="276">r</text><text text-anchor="middle" x="200" y="276">a</text><text text-anchor="middle" x="208" y="276">m</text><text text-anchor="middle" x="216" y="276">e</text><text text-anchor="middle" x="232" y="276">d</text><text text-anchor="middle" x="240" y="276">i</text><text text-anchor="middle" x="248" y="276">s</text><text text-anchor="middle" x="256" y="276">p</text><text text-anchor="middle" x="264" y="276">l</text><text text-anchor="middle" x="272" y="276">a</text><text text-anchor="middle" x="280" y="276">y</text><text text-anchor="middle" x="288" y="276">e</text><text text-anchor="middle" x="296" y="276">d</text><text text-anchor="middle" x="312" y="276">f</text><text text-anchor="middle" x="320" y="276">o</text><text text-anchor="middle" x="328" y="276">r</text><text text-anchor="middle" x="344" y="276">d</text><text text-anchor="middle" x="352" y="276">o</text><text text-anchor="middle" x="360" y="276">u</text><text text-anchor="middle" x="368" y="276">b</text><text text-anchor="middle" x="376" y="276">l</text><text text-anchor="middle" x="384" y="276">e</text><text text-anchor="middle" x="400" y="276">t</text><text text-anchor="middle" x="408" y="276">h</text><text text-anchor="middle" x="416" y="276">e</text><text text-anchor="middle" x="432" y="276">t</text><text text-anchor="middle" x="440" y="276">i</text><text text-anchor="middle" x="448" y="276">m</text><text text-anchor="middle" x="456" y="276">e</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;4:</b> Potential danger of not having the monitor's framerate.</div></center>

</p><p>

In conclusion, we want our framerate and the monitor framerate to be the same, or a multiple of it. With the same frequency, every time the monitor displays a new frame, we have a new frame for it to show. On another hand, if our game runs at 60 frames per second, and the monitor's refresh rate is 120 frames per second, this is fine since all our frames will always be two monitor's frames long. 

</p>
<a class="target" name="variableframeratemonitors">&nbsp;</a><a class="target" name="setthegoals/variableframeratemonitors">&nbsp;</a><a class="target" name="toc1.2">&nbsp;</a><h2>Variable Framerate Monitors</h2>
<p>


Of course, you might say: why not think about a variable refresh rate monitor, like the ones adopting Nvidia's G-Sync technology? These monitors display the next frame after the game/graphics card asks them to. After all, their adoption rate grows and eventually we'll all have one. Well, first, that time hasn't arrived yet. But the biggest issue is that if you don't have a fixed point of reference for your frame, your animation for that frame will be all over the place. 

</p><p>

Think of a situation where one of your frames takes 30ms to draw, another 16ms, the next one 20, and so on. If the physics engine needs to update the state of the world, it should do it for a specific amount of time:

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="144" width="432" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 144,0 L 144,32 " style="fill:none;"/>
<path d="M 144,64 L 144,80 " style="fill:none;"/>
<path d="M 216,0 L 216,32 " style="fill:none;"/>
<path d="M 216,64 L 216,80 " style="fill:none;"/>
<path d="M 256,0 L 256,32 " style="fill:none;"/>
<path d="M 256,64 L 256,80 " style="fill:none;"/>
<path d="M 304,0 L 304,32 " style="fill:none;"/>
<path d="M 304,64 L 304,80 " style="fill:none;"/>
<path d="M 360,0 L 360,32 " style="fill:none;"/>
<path d="M 360,64 L 360,80 " style="fill:none;"/>
<path d="M 144,16 L 400,16 " style="fill:none;"/>
<path d="M 144,80 L 360,80 " style="fill:none;"/>
<polygon points="408,16 396,10.4 396,21.6 "  style="stroke:none" transform="rotate(0,400,16 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="24" y="20">G</text><text text-anchor="middle" x="32" y="20">a</text><text text-anchor="middle" x="40" y="20">m</text><text text-anchor="middle" x="48" y="20">e</text><text text-anchor="middle" x="64" y="20">F</text><text text-anchor="middle" x="72" y="20">r</text><text text-anchor="middle" x="80" y="20">a</text><text text-anchor="middle" x="88" y="20">m</text><text text-anchor="middle" x="96" y="20">e</text><text text-anchor="middle" x="104" y="20">s</text><text text-anchor="middle" x="400" y="36">t</text><text text-anchor="middle" x="168" y="100">3</text><text text-anchor="middle" x="176" y="100">0</text><text text-anchor="middle" x="184" y="100">m</text><text text-anchor="middle" x="192" y="100">s</text><text text-anchor="middle" x="232" y="100">1</text><text text-anchor="middle" x="240" y="100">6</text><text text-anchor="middle" x="272" y="100">2</text><text text-anchor="middle" x="280" y="100">0</text><text text-anchor="middle" x="328" y="100">3</text><text text-anchor="middle" x="336" y="100">0</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;5:</b> Variable framerate. The actual length of a frame wouldn't be known until after the frame is shown.</div></center>

</p><p>

In a variable framerate world, if used as is the game wouldn't know how much a specific frame would take. Thus, it has to guess in some way, with more or less accuracy, and the resulting image will always be in some shape distorted. This doesn't mean we wouldn't take advantage of such technology if we found ourselves in front of it: having variable framerate would allow us to pick a fixed framerate of our preference (for performance reasons or what have you).

</p>
<a class="target" name="audio">&nbsp;</a><a class="target" name="setthegoals/audio">&nbsp;</a><a class="target" name="toc1.3">&nbsp;</a><h2>Audio</h2>
<p>


We also should consider audio. In an ideal world, we would write exactly the amount of audio for how long we expect our frame to last. However, this would create audio skips should the frame preparation take longer than expected. We have several options here:

</p><p>

<ol start=1>
<li class="number">Always get the audio there on time. Our framerate is a hard constraint, and we've written our game to never miss its framerate. 
</li>
<li class="number">Write two frames at a time (current and the next one). If we wake up and see that we hit our previous target, we simply overwrite the next frame's audio. 
</li>
<li class="number">We can simply write audio a whole frame ahead (i.e. have one frame of lag). This means that, when our graphics system works on preparing frame 0, we'd write audio for frame 1, and so on.
</li>
<li class="number">Have a separate thread check if we hit our target (a guard thread). If we didn't, it would emergency fill the audio buffer with the next frame of sound.</li></ol>

</p><p>

There may be also other methods but these are the most common. So which one would you rather pick? A simpler method (and one which forces some discipline) is just going with option 1. Always hit your framerate. 

</p><p>

It's a good mentality to force yourself into. This way you won't have any temptation to give yourself any slack and allow framerate drops. We set out target framerate to, say, 30Hz, and if we don't hit that, we optimize until we do. 

</p><p>

In reality, there's not a right answer. It's a matter of priorities, and those priorities will lead you to make a certain decision or another. 

</p>
<a class="target" name="conclusion">&nbsp;</a><a class="target" name="setthegoals/conclusion">&nbsp;</a><a class="target" name="toc1.4">&nbsp;</a><h2>Conclusion</h2>
<p>


That has been a long introduction, so let's define exactly what we want to achieve: 

</p><p>

<ul>
<li class="asterisk">A frame loop knows the framerate it wants to hit (&ldquo;Target Milliseconds&rdquo;).
</li>
<li class="asterisk">Target ms drives our physics update.
</li>
<li class="asterisk">After we complete all our update and rendering tasks, we wait until we're as close to the frame flip boundary as we can. We then go to the next iteration of the loop. 
</li>
<li class="asterisk">This system would even work if we pipeline the rendering (i.e. send it to the GPU). In this case there might be one frame of delay while the graphics card is waiting for the monitor refresh but it's still fine.
</li>
<li class="asterisk">Audio-wise, always write audio for exactly the expected frame length.</li></ul>

</p><p>

This doesn't seem too bad. Let's make it happen! Today we'll focus on the video part.

</p>
<a class="target" name="implementenforcedvideoframerate">&nbsp;</a><a class="target" name="implementenforcedvideoframerate">&nbsp;</a><a class="target" name="toc2">&nbsp;</a><h1>Implement Enforced Video Frame Rate</h1>

<a class="target" name="(not)getmonitorframerate">&nbsp;</a><a class="target" name="implementenforcedvideoframerate/(not)getmonitorframerate">&nbsp;</a><a class="target" name="toc2.1">&nbsp;</a><h2>(Not) Get Monitor Framerate</h2>
<p>


One last concern before we move on. If we want to match a specific refresh rate of a monitor, first we'll need to know what it is. Unfortunately, Win32 API doesn't provide a reliable information for the multi-monitor setup from the get-go, so you need to go and hunt for it. 

</p><p>

Win32 API does provide functions such as <a href="https://docs.microsoft.com/en-us/windows/win32/api/wingdi/nf-wingdi-getdevicecaps">GetDeviceCaps</a> or <a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-enumdisplaysettingsa">EnumDisplaySettings</a>, however the value you can get might be 0 or 1, representing the default refresh rate. It won't help us. 

</p><p>

<div class="admonition ">Technically, in that case you could try and call DirectX to get the default refresh rate, but we aren't exploring this possibility here. <a href="https://blog.getpaint.net/2017/08/12/win32-how-to-get-the-refresh-rate-for-a-window/">Further reading</a>.

</p><p>

    Additionally, <a href="https://docs.microsoft.com/en-us/windows/win32/dwm/dwm-overview">DWM API</a> also provides some avenues to resolve this issue.</div>

</p><p>

Ultimately, this matter isn't something we want to spend a lot of time on. Nowadays you often ask the graphics card to match the monitor's refresh rate, and then just time how much time passes between the frame flips to use it for the rest of your program. In the past, you used to use <a href="https://docs.microsoft.com/en-us/windows/win32/directdraw/directdraw-reference">DirectDraw</a> API. 

</p><p>

For now... we'll skip this part altogether. We'll just assume a framerate of 60 and leave a big <code>TODO</code> for a later stage. 

</p>
<a class="target" name="codeeverythingdown">&nbsp;</a><a class="target" name="implementenforcedvideoframerate/codeeverythingdown">&nbsp;</a><a class="target" name="toc2.2">&nbsp;</a><h2>Code Everything Down</h2>
<p>


At the very beginning of our <code>WinMain</code>, let's introduce a <code>MonitorRefreshHz</code> value. We'll make it the standard 60.

</p><p>

We will also introduce <code>GameUpdateHz</code> deriving from the <code>MonitorRefreshHz</code>. As we said above, our game refresh rate can be a fraction of the monitor's refresh rate and still synchronize properly, so let's say we're currently targeting half of that, i.e. 30 FPS.

</p><p>

While we're at it, we can also quickly calculate a value showing how many seconds each frame would take. This will be the actual target value we'll be using for frame timing. To calculate that, we simply need to divide 1 (second) over our target frame rate (frames per second). This will give us seconds per frame.

</p><pre class="listing tilde"><code><span class="line">LARGE_INTEGER PerfCountFrequencyResult;</span>
<span class="line">QueryPerformanceFrequency(&amp;PerfCountFrequencyResult);</span>
<span class="line">s64 PerfCountFrequency = PerfCountFrequencyResult.QuadPart;</span>
<span class="line"></span>
<span class="line">Win32LoadXInput();</span>
<span class="line"></span>
<span class="line">Win32ResizeDIBSection(&amp;GlobalBackbuffer, <span class="hljs-number">1280</span>, <span class="hljs-number">720</span>);</span>
<span class="line"></span>
<span class="line">WNDCLASS WindowClass = {<span class="hljs-number">0</span>};</span>
<span class="line"></span>
<span class="line">WindowClass.style = CS_HREDRAW | CS_VREDRAW | CS_OWNDC ;</span>
<span class="line">WindowClass.lpfnWndProc = Win32MainWindowCallback;</span>
<span class="line">WindowClass.hInstance = Instance;</span>
<span class="line"><span class="hljs-comment">// WindowClass.hIcon;</span></span>
<span class="line">WindowClass.lpszClassName = <span class="hljs-string">"HandmadeHeroWindowClass"</span>;</span>
<span class="line">    </span><div class=" add"><span class="line"><span class="hljs-comment">// TODO(casey): How do we reliably query on this on Windows?</span></span>
<span class="line"><span class="hljs-keyword">int</span> MonitorRefreshHz = <span class="hljs-number">60</span>;</span>
<span class="line"><span class="hljs-keyword">int</span> GameUpdateHz = MonitorRefreshHz / <span class="hljs-number">2</span>;</span>
<span class="line">f32 TargetSecondsPerFrame = <span class="hljs-number">1.0f</span> / (f32)GameUpdateHz;</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;1:</b> <file>[win32_handmade.cpp > WinMain]</file> Introducing target framerate.</div></center>
<p>


On the other side of <code>WinMain</code>, we were computing our debug frame timings. 

</p><pre class="listing tilde"><code><span class="line">LARGE_INTEGER EndCounter;</span>
<span class="line">QueryPerformanceCounter(&amp;EndCounter);</span>
<span class="line"></span>
<span class="line">u64 EndCycleCount = __rdtsc();</span>
<span class="line"></span>
<span class="line">s64 CounterElapsed = EndCounter.QuadPart - LastCounter.QuadPart;</span>
<span class="line">s64 CyclesElapsed = EndCycleCount - LastCycleCount;</span>
<span class="line">f32 MSPerFrame = <span class="hljs-number">1000.0f</span>*(f32)CounterElapsed / (f32)PerfCountFrequency;</span>
<span class="line">f32 FPS = (f32)PerfCountFrequency / (f32)CounterElapsed;</span>
<span class="line">f32 MegaCyclesPerFrame = (f32)CyclesElapsed / (<span class="hljs-number">1000.0f</span> * <span class="hljs-number">1000.0f</span>);</span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> 0</span></span>
<span class="line"><span class="hljs-keyword">char</span> Buffer[<span class="hljs-number">256</span>];</span>
<span class="line"><span class="hljs-built_in">sprintf</span>(Buffer, <span class="hljs-string">"%.02fms/f, %.02ff/s, %.02fMc/f\n"</span>, MSPerFrame, FPS, MegaCyclesPerFrame);</span>
<span class="line">OutputDebugStringA(Buffer);</span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span></code></pre><p>

We can use this information to compute how many seconds did it take to do all the work. What we basically want is <code>MSPerFrame</code>, except we don't need to multiply the result by 1000. 

</p><p>

Let's also rearrange our timers to see more clearly what's going on. We want <code>__rdtsc</code> snapshot at the <em class="underscore">very end</em> of our <code>GlobalRunning</code> loop, after everything else was completed. As a reminder, <code>__rdtsc</code> is very processor-specific, so we'll only use this counter for debug purposes. We aren't interested in that yet. 

</p><p>

On the other hand, <code>QueryPerformanceCounter</code> is a more user-facing solution we'll be using for timing our frames. 

</p><p>

We can also &ldquo;disable&rdquo; all the debug timing code for now, not only the output part. We aren't interested in it.

</p><pre class="listing tilde"><code><div class=" delete"><span class="line">u64 EndCycleCount = __rdtsc();</span></div><span class="line">LARGE_INTEGER EndCounter;</span>
<span class="line">QueryPerformanceCounter(&amp;EndCounter);</span><div class=" delete"><span class="line">s64 CyclesElapsed = EndCycleCount - LastCycleCount;</span></div><span class="line">s64 CounterElapsed = EndCounter.QuadPart - LastCounter.QuadPart;</span><div class=" add"><span class="line">f32 SecondsElapsedForWork = (f32)CounterElapsed / (f32)PerfCountFrequency;</span></div><div class=" add"><span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> 0</span></span>
<span class="line"><span class="hljs-comment">// debug timing output</span></span></div><span class="line"></span>
<span class="line">f32 MSPerFrame = <span class="hljs-number">1000.0f</span> * (f32)CounterElapsed / (f32)PerfCountFrequency;</span>
<span class="line">f32 FPS = (f32)PerfCountFrequency / (f32)CounterElapsed;</span>
<span class="line">f32 MegaCyclesPerFrame = (f32)CyclesElapsed / (<span class="hljs-number">1000.0f</span> * <span class="hljs-number">1000.0f</span>);</span><div class=" delete"><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> 0</span></span></div><span class="line"><span class="hljs-keyword">char</span> Buffer[<span class="hljs-number">256</span>];</span>
<span class="line"><span class="hljs-built_in">sprintf</span>(Buffer, <span class="hljs-string">"%.02fms/f, %.02ff/s, %.02fMc/f\n"</span>, MSPerFrame, FPS, MegaCyclesPerFrame);</span>
<span class="line">OutputDebugStringA(Buffer);</span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span>
<span class="line"></span>
<span class="line"></span><span class="line">game_input *Temp = NewInput;</span>
<span class="line">NewInput = OldInput;</span>
<span class="line">OldInput = Temp;</span>
<span class="line"></span>
<span class="line"></span><div class=" add"><span class="line">u64 EndCycleCount = __rdtsc();</span>
<span class="line">s64 CyclesElapsed = EndCycleCount - LastCycleCount;</span></div><span class="line">LastCycleCount = EndCycleCount;</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;2:</b> <file>[win32_handmade.cpp > WinMain]</file> Calculating seconds elapsed and cleaning up.</div></center>
<p>


This value will be different from our target (hopefully smaller!). So now we have to wait until we're over our target. The simplest, CPU-melting, solution would be to simply sit in a while loop and keep asking &ldquo;Are we there yet?&rdquo; over and over and over.

</p><pre class="listing tilde"><code><span class="line">LARGE_INTEGER EndCounter;</span>
<span class="line">QueryPerformanceCounter(&amp;EndCounter);</span>
<span class="line">s64 CounterElapsed = EndCounter.QuadPart - LastCounter.QuadPart;</span>
<span class="line"></span>
<span class="line">f32 SecondsElapsedForWork = (f32)CounterElapsed / (f32)PerfCountFrequency;</span><div class=" add"><span class="line">f32 SecondsElapsedForFrame = SecondsElapsedForWork;</span>
<span class="line"><span class="hljs-keyword">while</span> (SecondsElapsedForFrame &lt; TargetSecondsPerFrame)</span>
<span class="line">{</span>
<span class="line">    QueryPerformanceCounter(&amp;EndCounter);</span>
<span class="line">    CounterElapsed = EndCounter.QuadPart - LastCounter.QuadPart;</span>
<span class="line">    SecondsElapsedForFrame = (f32)CounterElapsed / (f32)PerfCountFrequency;</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;3:</b> <file>[win32_handmade.cpp > WinMain]</file> Just keep asking.</div></center>
<p>


This works, and if you compile it, you'll notice that the game is now mostly running as previously, except now it has some pretty significant audio issues. To start fixing those, first we need to clean up our end-of-frame clocking section.

</p>
<a class="target" name="refactorclockingstats">&nbsp;</a><a class="target" name="implementenforcedvideoframerate/refactorclockingstats">&nbsp;</a><a class="target" name="toc2.3">&nbsp;</a><h2>Refactor Clocking Stats</h2>
<p>


Our current clocking part is quite opaque, and reading and understanding it can be quite tough, even it was us who wrote this thing. To render it a bit more readable, we can pull out and compress some parts of it. 

</p><p>

As a first step, we can pull out the result of the <code>QueryPerformanceFrequency</code> and have it available throughout the whole program, i.e. make it global. We can do it in the same manner as we did with the other globals: 

</p><pre class="listing tilde"><code><span class="line">global_variable <span class="hljs-keyword">bool</span> GlobalRunning;</span>
<span class="line">global_variable win32_offscreen_buffer GlobalBackbuffer;</span>
<span class="line">global_variable IDirectSoundBuffer *GlobalSecondaryBuffer;</span><div class=" add"><span class="line">global_variable s64 GlobalPerfCountFrequency;</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;4:</b> <file>[win32_handmade.cpp]</file> Making <code>PerfCountFrequency</code> a global variable.</div></center>
<p>


Next, we can start using this global variable! Let's create a couple utility functions to quickly get wall clock, as well as calculate how many seconds have elapsed:

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-function"><span class="hljs-keyword">inline</span> LARGE_INTEGER</span>
<span class="line"><span class="hljs-title">Win32GetWallClock</span><span class="hljs-params">()</span></span>
<span class="line"></span>{</span>
<span class="line">    LARGE_INTEGER Result;</span>
<span class="line">    QueryPerformanceCounter(&amp;Result);</span>
<span class="line">    <span class="hljs-keyword">return</span> (Result);</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line"><span class="hljs-function"><span class="hljs-keyword">inline</span> f32</span>
<span class="line"><span class="hljs-title">Win32GetSecondsElapsed</span><span class="hljs-params">(LARGE_INTEGER Start, LARGE_INTEGER End)</span></span>
<span class="line"></span>{</span>
<span class="line">    f32 Result = (f32)(End.QuadPart - Start.QuadPart) /</span>
<span class="line">                 (f32)GlobalPerfCountFrequency;</span>
<span class="line">    </span>
<span class="line">    <span class="hljs-keyword">return</span> (Result);</span>
<span class="line">}</span></div><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> CALLBACK <span class="hljs-title">WinMain</span><span class="hljs-params">(...)</span></span></span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;5:</b> <file>[win32_handmade.cpp]</file> Adding two utility functions for timing.</div></center>
<p>


Finally, let's go through all the WinMain and make use of these functions to clarify what's going on:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> CALLBACK <span class="hljs-title">WinMain</span><span class="hljs-params">(...)</span></span>
<span class="line"></span>{</span><span class="line">    LARGE_INTEGER PerfCountFrequencyResult;</span>
<span class="line">    QueryPerformanceFrequency(&amp;PerfCountFrequencyResult);</span><div class=" edit"><span class="line">    GlobalPerfCountFrequency = PerfCountFrequencyResult.QuadPart;</span></div><span class="line">    <span class="hljs-comment">// ... </span></span><div class=" edit"><span class="line">    LARGE_INTEGER LastCounter = Win32GetWallClock();</span></div><div class=" delete"><span class="line">    QueryPerformanceCounter(&amp;LastCounter);</span></div><span class="line">    u64 LastCycleCount = __rdtsc();</span>
<span class="line">    GlobalRunning = <span class="hljs-literal">true</span>;</span>
<span class="line">    <span class="hljs-keyword">while</span> (GlobalRunning)</span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// ... </span></span>
<span class="line">        Win32DisplayBufferInWindow(...);</span><div class=" add"><span class="line">        LARGE_INTEGER WorkCounter = Win32GetWallClock();</span>
<span class="line">        f32 WorkSecondsElapsed = Win32GetSecondsElapsed(LastCounter, WorkCounter);        </span></div><div class=" delete"><span class="line">        LARGE_INTEGER EndCounter;</span>
<span class="line">        QueryPerformanceCounter(&amp;EndCounter);</span>
<span class="line">        s64 CounterElapsed = EndCounter.QuadPart - LastCounter.QuadPart;</span>
<span class="line">        </span>
<span class="line">        f32 SecondsElapsedForWork = (f32)CounterElapsed / (f32)GlobalPerfCountFrequency;</span></div><span class="line"></span><div class=" edit"><span class="line">        f32 SecondsElapsedForFrame = WorkSecondsElapsed;</span>
<span class="line">        <span class="hljs-keyword">while</span> (SecondsElapsedForFrame &lt; TargetSecondsPerFrame)</span></div><span class="line">        {</span><div class=" add"><span class="line">            SecondsElapsedForFrame = Win32GetSecondsElapsed(LastCounter,</span>
<span class="line">                                                            Win32GetWallClock());</span></div><div class=" delete"><span class="line">            QueryPerformanceCounter(&amp;EndCounter);</span>
<span class="line">            CounterElapsed = EndCounter.QuadPart - LastCounter.QuadPart;</span>
<span class="line">            SecondsElapsedForFrame = (f32)CounterElapsed / (f32)GlobalPerfCountFrequency;</span></div><span class="line">        }</span>
<span class="line">        </span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> 0</span></span>
<span class="line">        <span class="hljs-comment">// debug timing output</span></span>
<span class="line">        <span class="hljs-comment">// ...</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span><div class=" delete"><span class="line">        LastCounter = EndCounter;</span>
<span class="line">        LastCycleCount = EndCycleCount;</span>
<span class="line"></span></div><span class="line">        game_input *Temp = NewInput;</span>
<span class="line">        NewInput = OldInput;</span>
<span class="line">        OldInput = Temp;</span>
<span class="line"></span>
<span class="line"></span><div class=" add"><span class="line">        LARGE_INTEGER EndCounter = Win32GetWallClock();</span>
<span class="line">        LastCounter = EndCounter;        </span></div><span class="line"></span>
<span class="line">        u64 EndCycleCount = __rdtsc();</span>
<span class="line">        s64 CyclesElapsed = EndCycleCount - LastCycleCount;</span>
<span class="line">        LastCycleCount = EndCycleCount;</span>
<span class="line">    }</span>
<span class="line">    <span class="hljs-comment">//... </span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;6:</b> <file>[win32_handmade.cpp > WinMain]</file> Refactoring.</div></center>
<p>


The resulting code should look much neater and be more readable! Finally, and this is important for the reasons we outlined in Section 1, we need to wait first and display the frame after, and right now we're doing the other way round. Let's quickly fix that: 

</p><pre class="listing tilde"><code><div class=" delete"><span class="line">win32_window_dimension Dimension = Win32GetWindowDimension(Window);</span>
<span class="line">Win32DisplayBufferInWindow(&amp;GlobalBackbuffer, DeviceContext, Dimension.Width, Dimension.Height);</span></div><span class="line"></span>
<span class="line">LARGE_INTEGER WorkCounter = Win32GetWallClock();</span>
<span class="line">f32 WorkSecondsElapsed = Win32GetSecondsElapsed(LastCounter, WorkCounter);</span>
<span class="line"></span>
<span class="line">f32 SecondsElapsedForFrame = WorkSecondsElapsed;</span>
<span class="line"><span class="hljs-keyword">while</span> (SecondsElapsedForFrame &lt; TargetSecondsPerFrame)</span>
<span class="line">{</span>
<span class="line">    SecondsElapsedForFrame = Win32GetSecondsElapsed(LastCounter,</span>
<span class="line">                                                    Win32GetWallClock());</span>
<span class="line">}</span>
<span class="line">                    </span><div class=" add"><span class="line">win32_window_dimension Dimension = Win32GetWindowDimension(Window);</span>
<span class="line">Win32DisplayBufferInWindow(&amp;GlobalBackbuffer, DeviceContext, Dimension.Width, Dimension.Height);</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;7:</b> <file>[win32_handmade.cpp > WinMain]</file> Displaying the frame after we finished waiting.</div></center>

<a class="target" name="checkformissedtarget">&nbsp;</a><a class="target" name="implementenforcedvideoframerate/checkformissedtarget">&nbsp;</a><a class="target" name="toc2.4">&nbsp;</a><h2>Check for Missed Target</h2>
<p>


We're now making sure that our frame lasts at least our target time. But what if the frame actually lasts longer than we intended? In that case we have a problem: We missed our framerate. We can't really deal with it just yet, but we can set the stage to be able to deal with it in the future:

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-keyword">if</span> (SecondsElapsedForFrame &lt; TargetSecondsPerFrame)</span>
<span class="line">{</span></div><span class="line">    <span class="hljs-keyword">while</span> (SecondsElapsedForFrame &lt; TargetSecondsPerFrame)</span>
<span class="line">    {</span>
<span class="line">        SecondsElapsedForFrame = Win32GetSecondsElapsed(LastCounter, Win32GetWallClock());</span>
<span class="line">    }</span><div class=" add"><span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span></span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// TODO(casey): MISSED FRAME RATE!</span></span>
<span class="line">    <span class="hljs-comment">// TODO(casey): Logging</span></span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;8:</b> <file>[win32_handmade.cpp > WinMain]</file> Making sure we haven't missed our framerate.</div></center>

<a class="target" name="sleep">&nbsp;</a><a class="target" name="sleep">&nbsp;</a><a class="target" name="toc3">&nbsp;</a><h1>Sleep</h1>
<p>


As we're standing now, we just keep spinning, making an absurd amount of wall clock checks. We're just wasting CPU time. There surely must be a better way! Ideally, we could request operating system to pause our process for the time being, and do some other useful work. Luckily, there's a <a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-sleep">function</a> in the Win32 API which does just that.

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-sleep">Sleep</a> takes an amount of milliseconds we want to wait. So, in order to calculate that, we can simply do the following operation: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">if</span> (SecondsElapsedForFrame &lt; TargetSecondsPerFrame)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-keyword">while</span> (SecondsElapsedForFrame &lt; TargetSecondsPerFrame)</span>
<span class="line">    {</span><div class=" add"><span class="line">        DWORD SleepMS = (DWORD)(<span class="hljs-number">1000.0f</span> * (TargetSecondsPerFrame - SecondsElapsedForFrame));</span>
<span class="line">        <span class="hljs-keyword">if</span> (SleepMS &gt; <span class="hljs-number">0</span>)</span>
<span class="line">        {</span>
<span class="line">            Sleep(SleepMS);</span>
<span class="line">        }</span></div><span class="line">        SecondsElapsedForFrame = Win32GetSecondsElapsed(LastCounter, Win32GetWallClock());</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span></span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// TODO(casey): MISSED FRAME RATE!</span></span>
<span class="line">    <span class="hljs-comment">// TODO(casey): Logging</span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;9:</b> <file>[win32_handmade.cpp > WinMain]</file> Adding sleep and checking again.</div></center>
<p>


There's a problem with this, however. The thread of our process will be put to sleep for the specified time but, once awake, it will have to wait a bit more until the Windows Scheduler actually assigns it to the processor to work with. 

</p>
<a class="target" name="setwindowsschedulergranularity">&nbsp;</a><a class="target" name="sleep/setwindowsschedulergranularity">&nbsp;</a><a class="target" name="toc3.1">&nbsp;</a><h2>Set Windows Scheduler Granularity</h2>
<p>


Scheduler is a part of the operating system which allows it to be multitasking. It manages various threads and decides which of them can go and do useful work in the processor right now. But the scheduler also doesn't inspect each thread all the time, so if, for example you requested to sleep for 2 milliseconds, and the scheduler only checks every 15 milliseconds, you might end up waiting the full 15 milliseconds until your turn comes around again. 

</p><p>

Can this be fixed? As it is usual in Windows, this can be fixed with some esoteric solution. Scheduler's granularity can be configured by using a function called <a href="https://docs.microsoft.com/en-us/windows/win32/api/timeapi/nf-timeapi-timebeginperiod">timeBeginPeriod</a>, and it allows resolution all the way down to 1 ms (which is fine by us). This can be set up at the beginning of the program's execution and used until we call <code>timeBeginPeriod</code> or exit. This function can also fail, so let's make sure that we have a good result before asking to sleep: 

</p><pre class="listing tilde"><code><span class="line">LARGE_INTEGER PerfCountFrequencyResult;</span>
<span class="line">QueryPerformanceFrequency(&amp;PerfCountFrequencyResult);</span>
<span class="line">GlobalPerfCountFrequency = PerfCountFrequencyResult.QuadPart;</span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-comment">// NOTE(casey): Set the Windows scheduler granularity to 1ms</span></span>
<span class="line"><span class="hljs-comment">// so that our Sleep() can be more granular</span></span>
<span class="line">UINT DesiredSchedulerMS = <span class="hljs-number">1</span>;</span>
<span class="line">b32 SleepIsGranular = (timeBeginPeriod(DesiredSchedulerMS) == TIMERR_NOERROR);</span></div><span class="line"></span>
<span class="line"><span class="hljs-comment">// ... </span></span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">while</span> (SecondsElapsedForFrame &lt; TargetSecondsPerFrame)</span>
<span class="line">    {</span><div class=" add"><span class="line">        <span class="hljs-keyword">if</span> (SleepIsGranular)</span>
<span class="line">        {</span></div><span class="line">            DWORD SleepMS = (DWORD)(<span class="hljs-number">1000.0f</span> * (TargetSecondsPerFrame - SecondsElapsedForFrame));</span>
<span class="line">            <span class="hljs-keyword">if</span> (SleepMS &gt; <span class="hljs-number">0</span>)</span>
<span class="line">            {</span>
<span class="line">                Sleep(SleepMS);</span>
<span class="line">            }</span><div class=" add"><span class="line">        }</span></div><span class="line">        SecondsElapsedForFrame = Win32GetSecondsElapsed(LastCounter, Win32GetWallClock());</span>
<span class="line">    }</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;10:</b> <file>[win32_handmade.cpp > WinMain]</file> Setting up scheduler granularity.</div></center>
<p>


However, now our program will not compile: <code>timeBeginPeriod</code> requires a multi-media library. We have to link with it in order to be compilable: 

</p><pre class="listing tilde"><code><span class="line">:: WIN32 PLATFORM LIBRARIES</span>
<span class="line">set win32_libs=             user32.lib</span>
<span class="line">set win32_libs=%win32_libs% gdi32.lib</span><div class=" add"><span class="line">set win32_libs=%win32_libs% winmm.lib</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;11:</b> <file>[build.bat]</file> Adding Windows Multi-Media Library. As usual, you can check library requirements at the end of each function's MSDN page.</div></center>

<a class="target" name="testthechanges">&nbsp;</a><a class="target" name="sleep/testthechanges">&nbsp;</a><a class="target" name="toc3.2">&nbsp;</a><h2>Test the Changes</h2>
<p>


We've made a lot of changes, our sound is all over the place (we'll take care of it next time), so let's quickly re-enable our debug output code to see if it still works. We'll need to rearrange the code a bit further and update it with the new values though: 

</p><pre class="listing tilde"><code><div class=" delete"><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> 0</span></span>
<span class="line"><span class="hljs-comment">// debug timing output</span></span>
<span class="line"></span>
<span class="line">f32 MSPerFrame = <span class="hljs-number">1000.0f</span> * WorkSecondsElapsed;</span>
<span class="line">f32 FPS = (f32)GlobalPerfCountFrequency / (f32)CounterElapsed;</span>
<span class="line">f32 MegaCyclesPerFrame = (f32)CyclesElapsed / (<span class="hljs-number">1000.0f</span> * <span class="hljs-number">1000.0f</span>);</span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">char</span> Buffer[<span class="hljs-number">256</span>];</span>
<span class="line"><span class="hljs-built_in">sprintf</span>(Buffer, <span class="hljs-string">"%.02fms/f, %.02ff/s, %.02fMc/f\n"</span>, MSPerFrame, FPS, MegaCyclesPerFrame);</span>
<span class="line">OutputDebugStringA(Buffer);</span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span></div><span class="line"></span>
<span class="line">game_input *Temp = NewInput;</span>
<span class="line">NewInput = OldInput;</span>
<span class="line">OldInput = Temp;</span>
<span class="line"></span>
<span class="line">LARGE_INTEGER EndCounter = Win32GetWallClock();</span><div class=" add"><span class="line">f32 MSPerFrame = <span class="hljs-number">1000.0f</span> * Win32GetSecondsElapsed(LastCounter, EndCounter);</span></div><span class="line">LastCounter = EndCounter;</span>
<span class="line"></span>
<span class="line">u64 EndCycleCount = __rdtsc();</span>
<span class="line">s64 CyclesElapsed = EndCycleCount - LastCycleCount;</span>
<span class="line">LastCycleCount = EndCycleCount;</span>
<span class="line">                    </span><div class=" add"><span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> 1</span></span>
<span class="line"><span class="hljs-comment">// debug timing output</span></span>
<span class="line">f32 FPS = <span class="hljs-number">0.0f</span>; <span class="hljs-comment">// To be fixed later</span></span>
<span class="line">f32 MegaCyclesPerFrame = (f32)CyclesElapsed / (<span class="hljs-number">1000.0f</span> * <span class="hljs-number">1000.0f</span>);</span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">char</span> FPSBuffer[<span class="hljs-number">256</span>];</span>
<span class="line">sprintf_s(FPSBuffer, <span class="hljs-keyword">sizeof</span>(FPSBuffer), <span class="hljs-string">"%.02fms/f, %.02ff/s, %.02fMc/f\n"</span>, MSPerFrame, FPS, MegaCyclesPerFrame);</span>
<span class="line">OutputDebugStringA(FPSBuffer);</span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;12:</b> <file>[win32_handmade.cpp > WinMain]</file> Re-enabling debug timing output.</div></center>
<p>


If you run the game now, you can see in the <code>Output</code> window of your debugger that we roughly hit 33.33 ms/frame. 

</p>
<a class="target" name="recap">&nbsp;</a><a class="target" name="recap">&nbsp;</a><a class="target" name="toc4">&nbsp;</a><h1>Recap</h1>
<p>


We laid down some of the groundwork for the correct frame timing. Now, we'll need to spend more time tuning game sound, before we're ready to move on.

</p>
<a class="target" name="navigation">&nbsp;</a><a class="target" name="navigation">&nbsp;</a><a class="target" name="toc5">&nbsp;</a><h1>Navigation</h1>
<p>


Previous: <a href="../html/day17.html">Day 17. Unified Keyboard and Gamepad Input</a>

</p><p>

Next: <a href="../html/day19.html">Day 19. Improving Audio Synchronization</a>

</p><p>

<a href="../index.md.html">Back to Index</a>

</p>
<div class="nonumberh1">Glossary </div>
<p>


<ul>
<li class="asterisk">Frame Flip
</li>
<li class="asterisk">Sleep
</li>
<li class="asterisk">Windows Scheduler</li></ul>

</p>
<div class="nonumberh1">Articles</div>
<p>


<a href="https://blog.getpaint.net/2017/08/12/win32-how-to-get-the-refresh-rate-for-a-window/">Hot to Get the Refresh Rate for a Window</a>

</p>
<div class="nonumberh1">MSDN</div>
<p>


<a href="https://docs.microsoft.com/en-us/windows/win32/directdraw/directdraw-reference">DirectDraw</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/dwm/dwm-overview">DWM API</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-enumdisplaysettingsa">EnumDisplaySettings</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/wingdi/nf-wingdi-getdevicecaps">GetDeviceCaps</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-sleep">Sleep</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/timeapi/nf-timeapi-timebeginperiod">timeBeginPeriod</a>

</p><p>

<style class="fallback">
  body {
    visibility: hidden;
    font-family: sans-serif;
  }
</style>

</p><p>

<script>
  markdeepOptions = { tocStyle: 'long' };
  window.alreadyProcessedMarkdeep ||
    (document.body.style.visibility = 'visible');
</script>

</p><p>

</p></span><div id="mdContextMenu" style="visibility:hidden"></div><div class="markdeepFooter"><i>formatted by <a href="https://casual-effects.com/markdeep" style="color:#999">Markdeep&nbsp;1.10&nbsp;&nbsp;</a></i><div style="display:inline-block;font-size:13px;font-family:'Times New Roman',serif;vertical-align:middle;transform:translate(-3px,-1px)rotate(135deg);">&#x2712;</div></div>