<meta charset="UTF-8"><meta http-equiv="content-type" content="text/html;charset=UTF-8"><meta name="viewport" content="width=600, initial-scale=1"><style>body{max-width:680px;margin:auto;padding:20px;text-align:justify;line-height:140%; -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-smoothing:antialiased;color:#222;font-family:Palatino,Georgia,"Times New Roman",serif}</style><style>@media print{*{-webkit-print-color-adjust:exact;text-shadow:none !important}}body{counter-reset: h1 h2 h3 h4 h5 h6 paragraph}@page{margin:0;size:auto}#mdContextMenu{position:absolute;background:#383838;cursor:default;border:1px solid #999;color:#fff;padding:4px 0px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,"Helvetica Neue",sans-serif;font-size:85%;font-weight:600;border-radius:4px;box-shadow:0px 3px 10px rgba(0,0,0,35%)}#mdContextMenu div{padding:0px 20px}#mdContextMenu div:hover{background:#1659d1}.md code,.md pre{font-family:Menlo,Consolas,monospace;font-size:98%;text-align:left;line-height:140%}.md .mediumToc code,.md longToc code,.md .shortToc code,.md h1 code,.md h2 code,.md h3 code,.md h4 code,.md h5 code,.md h6 code{font-size:unset}.md div.title{font-size:26px;font-weight:800;line-height:120%;text-align:center}.md div.afterTitles{height:10px}.md div.subtitle{text-align:center}.md iframe.textinsert, .md object.textinsert,.md iframe:not(.markdeep){display:block;margin-top:10px;margin-bottom:10px;width:100%;height:75vh;border:1px solid #000;border-radius:4px;background:#f5f5f4}.md .image{display:inline-block}.md img{max-width:100%;page-break-inside:avoid}.md li{text-align:left;text-indent:0}.md pre.listing {width:100%;tab-size:4;-moz-tab-size:4;-o-tab-size:4;counter-reset:line;overflow-x:auto;resize:horizontal}.md pre.listing .linenumbers span.line:before{width:30px;margin-left:-28px;font-size:80%;text-align:right;counter-increment:line;content:counter(line);display:inline-block;padding-right:13px;margin-right:8px;color:#ccc}.md div.tilde{margin:20px 0 -10px;text-align:center}.md .imagecaption,.md .tablecaption,.md .listingcaption{display:inline-block;margin:7px 5px 12px;text-align:justify;font-style:italic}.md img.pixel{image-rendering:-moz-crisp-edges;image-rendering:pixelated}.md blockquote.fancyquote{margin:25px 0 25px;text-align:left;line-height:160%}.md blockquote.fancyquote::before{content:"“";color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-right:6px;vertical-align:-0.3em}.md span.fancyquote{font-size:118%;color:#777;font-style:italic}.md span.fancyquote::after{content:"”";font-style:normal;color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-left:6px;vertical-align:-0.3em}.md blockquote.fancyquote .author{width:100%;margin-top:10px;display:inline-block;text-align:right}.md small{font-size:60%}.md big{font-size:150%}.md div.title,contents,.md .tocHeader,.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .shortTOC,.md .mediumTOC,.nonumberh1,.nonumberh2,.nonumberh3,.nonumberh4,.nonumberh5,.nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;margin:13.4px 0 13.4px;padding:15px 0 3px;border-top:none;clear:both}.md .tocTop {display:none}.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .nonumberh1,.md .nonumberh2,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{page-break-after:avoid;break-after:avoid}.md svg.diagram{display:block;font-family:Menlo,Consolas,monospace;font-size:98%;text-align:center;stroke-linecap:round;stroke-width:2px;page-break-inside:avoid;stroke:#000;fill:#000}.md svg.diagram .opendot{fill:#fff}.md svg.diagram .shadeddot{fill:#CCC}.md svg.diagram .dotteddot{stroke:#000;stroke-dasharray:4;fill:none}.md svg.diagram text{stroke:none}@media print{@page{margin:1in 5mm;transform: scale(150%)}}@media print{.md .pagebreak{page-break-after:always;visibility:hidden}}.md a{font-family:Georgia,Palatino,'Times New Roman'}.md h1,.md .tocHeader,.md .nonumberh1{border-bottom:3px solid;font-size:20px;font-weight:bold;}.md h1,.md .nonumberh1{counter-reset: h2 h3 h4 h5 h6}.md h2,.md .nonumberh2{counter-reset: h3 h4 h5 h6;border-bottom:2px solid #999;color:#555;font-weight:bold;font-size:18px;}.md h3,.md h4,.md h5,.md h6,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;color:#555;font-size:16px;}.md h3{counter-reset:h4 h5 h6}.md h4{counter-reset:h5 h6}.md h5{counter-reset:h6}.md div.table{margin:16px 0 16px 0}.md table{border-collapse:collapse;line-height:140%;page-break-inside:avoid}.md table.table{margin:auto}.md table.calendar{width:100%;margin:auto;font-size:11px;font-family:Verdana,Helvetica,Arial,sans-serif}.md table.calendar th{font-size:16px}.md .today{background:#ECF8FA}.md .calendar .parenthesized{color:#999;font-style:italic}.md table.table th{color:#FFF;background-color:#AAA;border:1px solid #888;padding:8px 15px 8px 15px}.md table.table td{padding:5px 15px 5px 15px;border:1px solid #888}.md table.table tr:nth-child(even){background:#EEE}.md pre.tilde{border-top: 1px solid #CCC;border-bottom: 1px solid #CCC;padding: 5px 0 5px 20px;margin:0 0 0 0;background:#FCFCFC;page-break-inside:avoid}.md a.target{width:0px;height:0px;visibility:hidden;font-size:0px;display:inline-block}.md a:link, .md a:visited{color:#38A;text-decoration:none}.md a:link:hover{text-decoration:underline}.md dt{font-weight:700}.md dl>dd{margin-top:-8px; margin-bottom:8px}.md dl>table{margin:35px 0 30px}.md code{page-break-inside:avoid;} @media print{.md .listing code{white-space:pre-wrap}}.md .endnote{font-size:13px;line-height:15px;padding-left:10px;text-indent:-10px}.md .bib{padding-left:80px;text-indent:-80px;text-align:left}.markdeepFooter{font-size:9px;text-align:right;padding-top:80px;color:#999}.md .mediumTOC{float:right;font-size:12px;line-height:15px;border-left:1px solid #CCC;padding-left:15px;margin:15px 0px 15px 25px}.md .mediumTOC .level1{font-weight:600}.md .longTOC .level1{font-weight:600;display:block;padding-top:12px;margin:0 0 -20px}.md .shortTOC{text-align:center;font-weight:bold;margin-top:15px;font-size:14px}.md .admonition{position:relative;margin:1em 0;padding:.4rem 1rem;border-radius:.2rem;border-left:2.5rem solid rgba(68,138,255,.4);background-color:rgba(68,138,255,.15);}.md .admonition-title{font-weight:bold;border-bottom:solid 1px rgba(68,138,255,.4);padding-bottom:4px;margin-bottom:4px;margin-left: -1rem;padding-left:1rem;margin-right:-1rem;border-color:rgba(68,138,255,.4)}.md .admonition.tip{border-left:2.5rem solid rgba(50,255,90,.4);background-color:rgba(50,255,90,.15)}.md .admonition.tip::before{content:"\24d8";font-weight:bold;font-size:150%;position:relative;top:3px;color:rgba(26,128,46,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.tip>.admonition-title{border-color:rgba(50,255,90,.4)}.md .admonition.warn,.md .admonition.warning{border-left:2.5rem solid rgba(255,145,0,.4);background-color:rgba(255,145,0,.15)}.md .admonition.warn::before,.md .admonition.warning::before{content:"\26A0";font-weight:bold;font-size:150%;position:relative;top:2px;color:rgba(128,73,0,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.warn>.admonition-title,.md .admonition.warning>.admonition-title{border-color:rgba(255,145,0,.4)}.md .admonition.error{border-left: 2.5rem solid rgba(255,23,68,.4);background-color:rgba(255,23,68,.15)}.md .admonition.error>.admonition-title{border-color:rgba(255,23,68,.4)}.md .admonition.error::before{content: "\2612";font-family:"Arial";font-size:200%;position:relative;color:rgba(128,12,34,.8);top:-2px;left:-3rem;display:block;width:0;height:0}.md .admonition p:last-child{margin-bottom:0}.md li.checked,.md li.unchecked{list-style:none;overflow:visible;text-indent:-1.2em}.md li.checked:before,.md li.unchecked:before{content:"\2611";display:block;float:left;width:1em;font-size:120%}.md li.unchecked:before{content:"\2610"}</style><style>.md h1::before {
content:counter(h1) " ";
counter-increment: h1;margin-right:10px}.md h2::before {
content:counter(h1) "."counter(h2) " ";
counter-increment: h2;margin-right:10px}.md h3::before {
content:counter(h1) "."counter(h2) "."counter(h3) " ";
counter-increment: h3;margin-right:10px}.md h4::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) " ";
counter-increment: h4;margin-right:10px}.md h5::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) " ";
counter-increment: h5;margin-right:10px}.md h6::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) "."counter(h6) " ";
counter-increment: h6;margin-right:10px}</style><style>.hljs{display:block;overflow-x:auto;padding:0.5em;background:#fff;color:#000;-webkit-text-size-adjust:none}.hljs-comment{color:#006a00}.hljs-keyword{color:#02E}.hljs-literal,.nginx .hljs-title{color:#aa0d91}.method,.hljs-list .hljs-title,.hljs-tag .hljs-title,.setting .hljs-value,.hljs-winutils,.tex .hljs-command,.http .hljs-title,.hljs-request,.hljs-status,.hljs-name{color:#008}.hljs-envvar,.tex .hljs-special{color:#660}.hljs-string{color:#c41a16}.hljs-tag .hljs-value,.hljs-cdata,.hljs-filter .hljs-argument,.hljs-attr_selector,.apache .hljs-cbracket,.hljs-date,.hljs-regexp{color:#080}.hljs-sub .hljs-identifier,.hljs-pi,.hljs-tag,.hljs-tag .hljs-keyword,.hljs-decorator,.ini .hljs-title,.hljs-shebang,.hljs-prompt,.hljs-hexcolor,.hljs-rule .hljs-value,.hljs-symbol,.hljs-symbol .hljs-string,.hljs-number,.css .hljs-function,.hljs-function .hljs-title,.coffeescript .hljs-attribute{color:#A0C}.hljs-function .hljs-title{font-weight:bold;color:#000}.hljs-class .hljs-title,.smalltalk .hljs-class,.hljs-type,.hljs-typename,.hljs-tag .hljs-attribute,.hljs-doctype,.hljs-class .hljs-id,.hljs-built_in,.setting,.hljs-params,.clojure .hljs-attribute{color:#5c2699}.hljs-variable{color:#3f6e74}.css .hljs-tag,.hljs-rule .hljs-property,.hljs-pseudo,.hljs-subst{color:#000}.css .hljs-class,.css .hljs-id{color:#9b703f}.hljs-value .hljs-important{color:#ff7700;font-weight:bold}.hljs-rule .hljs-keyword{color:#c5af75}.hljs-annotation,.apache .hljs-sqbracket,.nginx .hljs-built_in{color:#9b859d}.hljs-preprocessor,.hljs-preprocessor *,.hljs-pragma{color:#643820}.tex .hljs-formula{background-color:#eee;font-style:italic}.diff .hljs-header,.hljs-chunk{color:#808080;font-weight:bold}.diff .hljs-change{background-color:#bccff9}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-comment .hljs-doctag{font-weight:bold}.method .hljs-id{color:#000}</style><style>div.title { padding-top: 40px; } div.afterTitles { height: 15px; }</style><meta charset="utf-8">
<link rel="stylesheet" href="../css/style.css">

<span class="md"><p><title>Day 17. Unified Keyboard and Gamepad Input</title><div class="title"> Day 17. Unified Keyboard and Gamepad Input </div>

<div class="afterTitles"></div>
<em class="underscore">Video Length (including Q&A): <a href="https://hero.handmade.network/episode/code/day017/">1h41</a></em> 

</p><p>

Welcome to &ldquo;Handmade Hero Notes&rdquo;, the book where we follow the footsteps of <a href="https://handmadehero.org/">Handmade Hero</a> in making the complete game from scratch, with no external libraries. If you'd like to follow along, preorder the game on <a href="https://handmadehero.org/">handmadehero.org</a>, and you will receive access to the GitHub repository, containing complete source code (tagged day-by-day) as well as a variety of other useful resources.

</p><p>

We were putting away the work on finalizing the input system for long enough. It's not like we don't have anything to do in our program, not at all. But time has come to tighten the screws on the keyboard and gamepad input and finalize it for our cross-platform layer. It's not going to be difficult, just a bit laborious.

</p>
<div class="longTOC"><p align="center">
    <span align="right"><a href="day16.html">Day 16</a></span>
    <a href="../index.html"><img src = "../media/logo.png"></a>
    <span align="left"><a href="day18.html">Day 18</a></span>
</p><p><a href="#" class="tocTop">(Top)</a><br/>
<a href="#implementkeyboardinputinsidewinmain" class="level1"><span class="tocNumber">1&nbsp; </span>Implement Keyboard Input Inside WinMain</a><br/>
&nbsp;&nbsp;<a href="#implementkeyboardinputinsidewinmain/windowclass,messagesandcallback" class="level2"><span class="tocNumber">1.1&nbsp; </span>Window Class, Messages and Callback</a><br/>
&nbsp;&nbsp;<a href="#implementkeyboardinputinsidewinmain/moveoutkeyboardmessages" class="level2"><span class="tocNumber">1.2&nbsp; </span>Move out Keyboard Messages</a><br/>
&nbsp;&nbsp;<a href="#implementkeyboardinputinsidewinmain/keyboardinputstorage:firstpass" class="level2"><span class="tocNumber">1.3&nbsp; </span>Keyboard Input Storage: First Pass</a><br/>
<a href="#finishdirectionalstickcode" class="level1"><span class="tocNumber">2&nbsp; </span>Finish Directional Stick Code</a><br/>
&nbsp;&nbsp;<a href="#finishdirectionalstickcode/deadzonehandling" class="level2"><span class="tocNumber">2.1&nbsp; </span>Dead Zone Handling</a><br/>
&nbsp;&nbsp;<a href="#finishdirectionalstickcode/optimizestickvaluecapture" class="level2"><span class="tocNumber">2.2&nbsp; </span>Optimize Stick Value Capture</a><br/>
&nbsp;&nbsp;<a href="#finishdirectionalstickcode/hookuptherealdpad" class="level2"><span class="tocNumber">2.3&nbsp; </span>Hook up the Real DPad</a><br/>
&nbsp;&nbsp;<a href="#finishdirectionalstickcode/addmovebuttonstokeyboard" class="level2"><span class="tocNumber">2.4&nbsp; </span>Add Move Buttons to Keyboard</a><br/>
<a href="#improvekeyboardinputprocessing" class="level1"><span class="tocNumber">3&nbsp; </span>Improve Keyboard Input Processing</a><br/>
&nbsp;&nbsp;<a href="#improvekeyboardinputprocessing/addafifthcontroller(thekeyboard)" class="level2"><span class="tocNumber">3.1&nbsp; </span>Add a Fifth Controller (the Keyboard)</a><br/>
&nbsp;&nbsp;<a href="#improvekeyboardinputprocessing/ensurekeyboardstatepersistance" class="level2"><span class="tocNumber">3.2&nbsp; </span>Ensure Keyboard State Persistance</a><br/>
&nbsp;&nbsp;<a href="#improvekeyboardinputprocessing/addisconnectedindicatortothecontroller" class="level2"><span class="tocNumber">3.3&nbsp; </span>Add <code>IsConnected</code> Indicator to the Controller</a><br/>
&nbsp;&nbsp;<a href="#improvekeyboardinputprocessing/bughunting:bufferoverrun" class="level2"><span class="tocNumber">3.4&nbsp; </span>Bug Hunting: Buffer Overrun</a><br/>
<a href="#recap" class="level1"><span class="tocNumber">4&nbsp; </span>Recap</a><br/>
<a href="#programmingnotions" class="level1"><span class="tocNumber">5&nbsp; </span>Programming Notions</a><br/>
&nbsp;&nbsp;<a href="#programmingnotions/introtofunctionalprogramming" class="level2"><span class="tocNumber">5.1&nbsp; </span>Intro to Functional Programming</a><br/>
<a href="#navigation" class="level1"><span class="tocNumber">6&nbsp; </span>Navigation</a><br/>
</p></div><a class="target" name="implementkeyboardinputinsidewinmain">&nbsp;</a><a class="target" name="implementkeyboardinputinsidewinmain">&nbsp;</a><a class="target" name="toc1">&nbsp;</a><h1>Implement Keyboard Input Inside WinMain</h1>
<p>


If you remember, up until now there was a significant difference between the gamepad input and the keyboard input: keyboard wasn't processed inside WinMain. We had to use the callback function <code>Win32MainWindowCallback</code>, a function completely separated from the rest of our program. 

</p>
<a class="target" name="windowclass,messagesandcallback">&nbsp;</a><a class="target" name="implementkeyboardinputinsidewinmain/windowclass,messagesandcallback">&nbsp;</a><a class="target" name="toc1.1">&nbsp;</a><h2>Window Class, Messages and Callback</h2>
<p>


Let's have a quick refresher on &ldquo;why&rdquo; we have this problem, so that we can find a solution to it. 

</p><p>

In order to create a window in Windows, a program must register the so-called &ldquo;Window Class&rdquo;. You might remember the structure <code>WNDCLASSA</code> that we filled out for that purpose.

</p><p>

Yes, but why? 

</p><p>

Once we register the window class, Windows will start sending it related messages. These are all sorts of things including, you guessed it, keyboard. Some of these we intercept (inside our <code>PeekMessage</code> loop), &ldquo;translate&rdquo; and send to back to Windows. 

</p><p>

However, the operating system wants to reserve itself the right to call each window process at its own accord. It might happen, for example, that the program's window becomes covered by another window. In that case Windows would need to redraw that area without really alerting the program which might not even be &ldquo;active&rdquo; at that moment. 

</p><p>

Here is where the callback function comes into play. With it, Windows &ldquo;calls us back&rdquo;, including the message type, related window handle (because a process might have many windows) and a couple parameters that each message fills out as it requires.

</p><p>

This is all nice and good, but it leaves us with the problem. The way Windows forces us to do callbacks, we have <em class="underscore">no context</em>, it all remains inside <code>WinMain</code>... So we should either use a global variable or do some tricks like using local storage on the window. The latter is actually a thing, Windows allows to store some information related to the window handle (which we get inside the loop). But it's complex, so we'll need to find another way before going for that one. 

</p>
<a class="target" name="moveoutkeyboardmessages">&nbsp;</a><a class="target" name="implementkeyboardinputinsidewinmain/moveoutkeyboardmessages">&nbsp;</a><a class="target" name="toc1.2">&nbsp;</a><h2>Move out Keyboard Messages</h2>
<p>


Windows is free to call us back when it wants to, however keyboard messages don't seem to be dispatched like that. This means that we can process them in our main loop, without bothering to go through the callback. 

</p><p>

Let's try it. These messages are dispatched in the loop, so we can &ldquo;peek&rdquo; into them and see what they are. If they're what we want, we translate them right there. And inside <code>Win32MainWindowCallback</code> we can leave an assertion that would fire if we ever catch messages we shouldn't.

</p><p>

<strong class="underscore">Step 1. Set the stage.</strong> Inside the <code>WinMain</code>, we will convert existing message handling to a <code>switch</code> statement, so that it'll have the same structure as in the <code>Win32MainWindowsCallback</code>. The <code>MSG Message</code> contains a member called <code>message</code> which is effectively the same thing you will receive in the callback, so we'll iterate over it. The <code>default</code> case (that is, unless we capture and process the message) will still be translating and dispatching it. The resulting refactoring should be compilable and work the same.

</p><pre class="listing tilde"><code><span class="line">MSG Message;</span>
<span class="line"><span class="hljs-keyword">while</span> (PeekMessageA(&amp;Message, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, PM_REMOVE))</span>
<span class="line">{</span><div class=" edit"><span class="line">    <span class="hljs-keyword">switch</span>(Message.message)</span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-keyword">case</span> WM_QUIT:</span>
<span class="line">        {</span>
<span class="line">            GlobalRunning = <span class="hljs-literal">false</span>;</span>
<span class="line">        } <span class="hljs-keyword">break</span>;</span>
<span class="line"></span>
<span class="line">        <span class="hljs-comment">// More messages will go here</span></span>
<span class="line">        </span>
<span class="line">        <span class="hljs-keyword">default</span>:</span>
<span class="line">        {</span>
<span class="line">            TranslateMessage(&amp;Message);</span>
<span class="line">            DispatchMessage(&amp;Message);</span>
<span class="line">        } <span class="hljs-keyword">break</span>;</span>
<span class="line">    }</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;1:</b> <file>[win32_handmade.cpp > WinMain]</file> Converting <code>if</code> block to a <code>switch</code>.</div></center>
<p>



<strong class="underscore">Step 2. Pull out this block to an external function, for ease of readability, and call it from the same spot.</strong> Again, no change to the code.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span> </span>
<span class="line"><span class="hljs-title">Win32ProcessPendingMessages</span><span class="hljs-params">()</span></span>
<span class="line"></span>{</span>
<span class="line">    MSG Message;</span>
<span class="line">    <span class="hljs-keyword">while</span> (PeekMessageA(&amp;Message, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, PM_REMOVE))</span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-keyword">switch</span>(Message.message)</span>
<span class="line">        {</span>
<span class="line">            <span class="hljs-keyword">case</span> WM_QUIT:</span>
<span class="line">            {</span>
<span class="line">                GlobalRunning = <span class="hljs-literal">false</span>;</span>
<span class="line">            } <span class="hljs-keyword">break</span>;</span>
<span class="line">            </span>
<span class="line">            <span class="hljs-keyword">default</span>:</span>
<span class="line">            {</span>
<span class="line">                TranslateMessage(&amp;Message);</span>
<span class="line">                DispatchMessage(&amp;Message);</span>
<span class="line">            } <span class="hljs-keyword">break</span>;</span>
<span class="line">        }</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line"><span class="hljs-comment">// ...</span></span>
<span class="line"><span class="hljs-comment">// WinMain </span></span>
<span class="line"><span class="hljs-comment">// ...</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">while</span>(GlobalRunning)</span>
<span class="line">{</span>
<span class="line">    Win32ProcessPendingMessages();</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;2:</b> <file>[win32_handmade.cpp]</file> Exporting the message loop outside of <code>WinMain</code>.</div></center>
<p>



<strong class="underscore">Step 3. Copy the key handling system.</strong> You'll notice that you're not compilable if you copy the code as is, because you don't have <code>LParam</code> and <code>WParam</code> any more. Luckily, these are also provided inside <code>MSG</code> structure. 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">switch</span>(Message.message)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-keyword">case</span> WM_QUIT:</span>
<span class="line">    {</span>
<span class="line">        GlobalRunning = <span class="hljs-literal">false</span>;</span>
<span class="line">    } <span class="hljs-keyword">break</span>;</span><div class=" add"><span class="line">    <span class="hljs-keyword">case</span> WM_SYSKEYDOWN:</span>
<span class="line">    <span class="hljs-keyword">case</span> WM_SYSKEYUP:</span>
<span class="line">    <span class="hljs-keyword">case</span> WM_KEYDOWN:</span>
<span class="line">    <span class="hljs-keyword">case</span> WM_KEYUP:</span>
<span class="line">    {</span>
<span class="line">        u32 VKCode = (u32)Message.wParam;</span>
<span class="line">        <span class="hljs-keyword">bool</span> IsDown = ((Message.lParam &amp; (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">31</span>)) == <span class="hljs-number">0</span>);</span>
<span class="line">        <span class="hljs-keyword">bool</span> WasDown = ((Message.lParam &amp; (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">30</span>)) != <span class="hljs-number">0</span>);</span>
<span class="line">        </span>
<span class="line">        <span class="hljs-keyword">if</span>(IsDown != WasDown)</span>
<span class="line">        {</span>
<span class="line">            <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'W'</span>)</span>
<span class="line">            {</span>
<span class="line">            }</span>
<span class="line">            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'A'</span>)</span>
<span class="line">            {</span>
<span class="line">            }</span>
<span class="line">            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'S'</span>)</span>
<span class="line">            {</span>
<span class="line">            }</span>
<span class="line">            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'D'</span>)</span>
<span class="line">            {</span>
<span class="line">            }</span>
<span class="line">            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'Q'</span>)</span>
<span class="line">            {</span>
<span class="line">            }</span>
<span class="line">            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'E'</span>)</span>
<span class="line">            {</span>
<span class="line">            }</span>
<span class="line">            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_UP)</span>
<span class="line">            {</span>
<span class="line">            }</span>
<span class="line">            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_DOWN)</span>
<span class="line">            {</span>
<span class="line">            }</span>
<span class="line">            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_LEFT)</span>
<span class="line">            {</span>
<span class="line">            }</span>
<span class="line">            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_RIGHT)</span>
<span class="line">            {</span>
<span class="line">            }</span>
<span class="line">            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_ESCAPE)</span>
<span class="line">            {</span>
<span class="line">                OutputDebugStringA(<span class="hljs-string">"ESCAPE: "</span>);</span>
<span class="line">                <span class="hljs-keyword">if</span> (IsDown)</span>
<span class="line">                {</span>
<span class="line">                    OutputDebugStringA(<span class="hljs-string">"IsDown "</span>);</span>
<span class="line">                }</span>
<span class="line">                <span class="hljs-keyword">if</span> (WasDown)</span>
<span class="line">                {</span>
<span class="line">                    OutputDebugStringA(<span class="hljs-string">"WasDown"</span>);</span>
<span class="line">                }</span>
<span class="line">                OutputDebugStringA(<span class="hljs-string">"\n"</span>);</span>
<span class="line">            }</span>
<span class="line">            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_SPACE)</span>
<span class="line">            {</span>
<span class="line">            }</span>
<span class="line">            </span>
<span class="line">            b32 AltKeyWasDown = ((Message.lParam &amp; (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">29</span>)) != <span class="hljs-number">0</span>);</span>
<span class="line">            <span class="hljs-keyword">if</span>((VKCode == VK_F4) &amp;&amp; AltKeyWasDown)</span>
<span class="line">            {</span>
<span class="line">                GlobalRunning = <span class="hljs-literal">false</span>;</span>
<span class="line">            }</span>
<span class="line">        }</span>
<span class="line">    } <span class="hljs-keyword">break</span>;</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;3:</b> <file>[win32_handmade.cpp > Win32ProcessPendingMessages]</file> Adding the key handling from <code>Win32MainWindowCallback</code>.</div></center>
<p>


<strong class="underscore">Step 4. Remove key handling from <code>Win32MainWindowCallback</code>.</strong> Instead we'll leave an assertion which will fire should Windows send us this type of message (which it shouldn't but we'll investigate in case).__

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">case</span> WM_ACTIVATEAPP:</span>
<span class="line">{</span>
<span class="line">    OutputDebugStringA(<span class="hljs-string">"WM_ACTIVATEAPP\n"</span>);</span>
<span class="line">} <span class="hljs-keyword">break</span>;</span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">case</span> WM_SYSKEYDOWN:</span>
<span class="line"><span class="hljs-keyword">case</span> WM_SYSKEYUP:</span>
<span class="line"><span class="hljs-keyword">case</span> WM_KEYDOWN:</span>
<span class="line"><span class="hljs-keyword">case</span> WM_KEYUP:</span>
<span class="line">{</span><div class=" add"><span class="line">    Assert(!<span class="hljs-string">"Keyboard input came in through a non-dispatch message!!!"</span>);</span></div><div class=" delete"><span class="line">    <span class="hljs-keyword">bool</span> IsDown = ((LParam &amp; (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">31</span>)) == <span class="hljs-number">0</span>);</span>
<span class="line">    <span class="hljs-keyword">bool</span> WasDown = ((LParam &amp; (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">30</span>)) != <span class="hljs-number">0</span>);</span>
<span class="line">    u32 VKCode = (u32)WParam;</span>
<span class="line">    </span>
<span class="line">    <span class="hljs-keyword">if</span>(IsDown != WasDown)</span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'W'</span>)</span>
<span class="line">        {</span>
<span class="line">        }</span>
<span class="line">        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'A'</span>)</span>
<span class="line">        {</span>
<span class="line">        }</span>
<span class="line">        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'S'</span>)</span>
<span class="line">        {</span>
<span class="line">        }</span>
<span class="line">        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'D'</span>)</span>
<span class="line">        {</span>
<span class="line">        }</span>
<span class="line">        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'Q'</span>)</span>
<span class="line">        {</span>
<span class="line">        }</span>
<span class="line">        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'E'</span>)</span>
<span class="line">        {</span>
<span class="line">        }</span>
<span class="line">        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_UP)</span>
<span class="line">        {</span>
<span class="line">        }</span>
<span class="line">        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_DOWN)</span>
<span class="line">        {</span>
<span class="line">        }</span>
<span class="line">        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_LEFT)</span>
<span class="line">        {</span>
<span class="line">        }</span>
<span class="line">        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_RIGHT)</span>
<span class="line">        {</span>
<span class="line">        }</span>
<span class="line">        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_ESCAPE)</span>
<span class="line">        {</span>
<span class="line">            OutputDebugStringA(<span class="hljs-string">"ESCAPE: "</span>);</span>
<span class="line">            <span class="hljs-keyword">if</span> (IsDown)</span>
<span class="line">            {</span>
<span class="line">                OutputDebugStringA(<span class="hljs-string">"IsDown "</span>);</span>
<span class="line">            }</span>
<span class="line">            <span class="hljs-keyword">if</span> (WasDown)</span>
<span class="line">            {</span>
<span class="line">                OutputDebugStringA(<span class="hljs-string">"WasDown"</span>);</span>
<span class="line">            }</span>
<span class="line">            OutputDebugStringA(<span class="hljs-string">"\n"</span>);</span>
<span class="line">        }</span>
<span class="line">        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_SPACE)</span>
<span class="line">        {</span>
<span class="line">        }</span>
<span class="line">        </span>
<span class="line">        b32 AltKeyWasDown = ((LParam &amp; (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">29</span>)) != <span class="hljs-number">0</span>);</span>
<span class="line">        <span class="hljs-keyword">if</span>((VKCode == VK_F4) &amp;&amp; AltKeyWasDown)</span>
<span class="line">        {</span>
<span class="line">            GlobalRunning = <span class="hljs-literal">false</span>;</span>
<span class="line">        }</span>
<span class="line">    }</span></div><span class="line">} <span class="hljs-keyword">break</span>;</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;4:</b> <file>[win32_handmade.cpp > Win32MainWindowCallback]</file> Replacing key handling with an assertion.</div></center>
<p>


We're still compilable, and we still have effectively the same functionality as before. Except now we can actually send things to the <code>Win32ProcessPendingMessages</code> function directly! That's some great progress right there.

</p>
<a class="target" name="keyboardinputstorage:firstpass">&nbsp;</a><a class="target" name="implementkeyboardinputinsidewinmain/keyboardinputstorage:firstpass">&nbsp;</a><a class="target" name="toc1.3">&nbsp;</a><h2>Keyboard Input Storage: First Pass</h2>
<p>


To get things going, let's assign some function to the buttons. Let's say <code>Escape</code> kills our game, while for the other buttons we'll mimic our gamepad handling. <code>Win32ProcessPendingMessages</code> would receive a controller structure, not dissimilar from what we used for the gamepad. For this purpose we will use another function which we'll call <code>Win32ProcessKeyboardMessages</code>. This would do the work of storing the input. 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'W'</span>)</span>
<span class="line">{</span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'A'</span>)</span>
<span class="line">{</span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'S'</span>)</span>
<span class="line">{</span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'D'</span>)</span>
<span class="line">{</span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'Q'</span>)</span>
<span class="line">{</span><div class=" add"><span class="line">    Win32ProcessKeyboardMessages(&amp;KeyboardController-&gt;LeftShoulder, IsDown);</span></div><span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'E'</span>)</span>
<span class="line">{</span><div class=" add"><span class="line">    Win32ProcessKeyboardMessages(&amp;KeyboardController-&gt;RightShoulder, IsDown);</span></div><span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_UP)</span>
<span class="line">{</span><div class=" add"><span class="line">    Win32ProcessKeyboardMessages(&amp;KeyboardController-&gt;Up, IsDown);</span></div><span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_DOWN)</span>
<span class="line">{</span><div class=" add"><span class="line">    Win32ProcessKeyboardMessages(&amp;KeyboardController-&gt;Down, IsDown);</span></div><span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_LEFT)</span>
<span class="line">{</span><div class=" add"><span class="line">    Win32ProcessKeyboardMessages(&amp;KeyboardController-&gt;Left, IsDown);</span></div><span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_RIGHT)</span>
<span class="line">{</span><div class=" add"><span class="line">    Win32ProcessKeyboardMessages(&amp;KeyboardController-&gt;Right, IsDown);</span></div><span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_ESCAPE)</span>
<span class="line">{</span><div class=" delete"><span class="line">    OutputDebugStringA(<span class="hljs-string">"ESCAPE: "</span>);</span>
<span class="line">    <span class="hljs-keyword">if</span> (IsDown)</span>
<span class="line">    {</span>
<span class="line">        OutputDebugStringA(<span class="hljs-string">"IsDown "</span>);</span>
<span class="line">    }</span>
<span class="line">    <span class="hljs-keyword">if</span> (WasDown)</span>
<span class="line">    {</span>
<span class="line">        OutputDebugStringA(<span class="hljs-string">"WasDown"</span>);</span>
<span class="line">    }</span>
<span class="line">    OutputDebugStringA(<span class="hljs-string">"\n"</span>);</span></div><div class=" add"><span class="line">    GlobalRunning = <span class="hljs-literal">false</span>;</span></div><span class="line">    </span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_SPACE)</span>
<span class="line">{</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;5:</b> <file>[win32_handmade.cpp > Win32ProcessPendingMessages]</file> Adding some functionality.</div></center>
<p>


This of course presumes that we pass the function a <code>KeyboardController</code>. Let's do it right away. We need to change the signature of the function, as well as introduce a <code>KeyboardController</code> in <code>WinMain</code>, clear it to zero and pass to our program. 

</p><p>

For now, we can use the controller 0 from our <code>NewInput</code>. In order to clear to zero however, we'll need to create a new variable of type <code>game_controller_input</code>, clear that to zero, and then use the contents of that structure to zero out the contents of the <code>KeyboardController</code>:

</p><pre class="listing tilde"><code><span class="line">internal <span class="hljs-keyword">void</span></span><div class=" edit"><span class="line">Win32ProcessPendingMessages(game_controller_input *KeyboardController)</span></div><span class="line">{</span>
<span class="line">    <span class="hljs-comment">//... </span></span>
<span class="line">}</span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">while</span> (GlobalRunning)</span>
<span class="line">{</span>
<span class="line">    game_controller_input *KeyboardController = &amp;NewInput-&gt;Controllers[<span class="hljs-number">0</span>];</span>
<span class="line">    game_controller_input ZeroController = {};</span>
<span class="line">    *KeyboardController = ZeroController;</span>
<span class="line"></span>
<span class="line">    Win32ProcessPendingMessages(KeyboardController);</span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;6:</b> <file>[win32_handmade.cpp]</file> Assigning keyboard controller.</div></center>
<p>


This is a bit wanky, so we'll need to revisit it pretty soon. 

</p><p>

One last thing that's missing is the <code>Win32ProcessKeyboardMessages</code> we assumed above. Let's create one based on <code>Win32ProcessXInputDigitalButton</code>, except it will be largely simplified: we need to do but a fraction of the work that the latter function does.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">Win32ProcessXInputDigitalButton</span><span class="hljs-params">(DWORD XInputButtonState,</span>
<span class="line">                                game_button_state *OldState, DWORD ButtonBit,</span>
<span class="line">                                game_button_state *NewState)</span></span>
<span class="line"></span>{</span>
<span class="line">    NewState-&gt;EndedDown = ((XInputButtonState &amp; ButtonBit) == ButtonBit);</span>
<span class="line">    NewState-&gt;HalfTransitionCount = (OldState-&gt;EndedDown != NewState-&gt;EndedDown) ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;</span>
<span class="line">}</span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">Win32ProcessKeyboardMessages</span><span class="hljs-params">(game_button_state *NewState, b32 IsDown)</span></span>
<span class="line"></span>{</span>
<span class="line">    NewState-&gt;EndedDown = IsDown;</span>
<span class="line">    ++NewState-&gt;HalfTransitionCount;</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;7:</b> <file>[win32_handmade.cpp]</file> Defining <code>Win32ProcessKeyboardMessages</code>.</div></center>
<p>


Finally we can compile and run. It... somewhat works. If you repeatedly press the down arrow you will notice offset changing. However, this is less than ideal: we can't zero out everything because the up/down state will be wrong. You need to repeatedly hit the button if you want the game to react to it. That's not how the games work, and we want to be able to hold down a key. This might need requiring more changes. Additionally, right now we're hacking into the existing controller system, and we want a more complete solution.

</p>
<a class="target" name="finishdirectionalstickcode">&nbsp;</a><a class="target" name="finishdirectionalstickcode">&nbsp;</a><a class="target" name="toc2">&nbsp;</a><h1>Finish Directional Stick Code</h1>
<p>


Before we can move on, we need to take a step back and return to the gamepad code which we left somewhat hanging. 

</p>
<a class="target" name="deadzonehandling">&nbsp;</a><a class="target" name="finishdirectionalstickcode/deadzonehandling">&nbsp;</a><a class="target" name="toc2.1">&nbsp;</a><h2>Dead Zone Handling</h2>
<p>


As of now, we don't do any dead zone processing for our sticks. What is a dead zone anyway? Contrary to what one might imagine, it's not a game about zombies (<a href="http://deadzonegame.com/">there is</a> one, but we aren't talking about it in this instance, anyway). Gamepad sticks are <em class="underscore">highly</em> inaccurate at the bottom level of precision. Simply put, all the values below a specific threshold are garbage, and the API itself recommends you to filter them out. It's not a bug, it's just the tolerances that a particular controller is designed around. So let's implement... a dead zone, or a region around zero where the values are zero. 

</p><p>

This region is defined to be as <code>XINPUT_GAMEPAD_LEFT_THUMB_DEADZONE</code> and <code>XINPUT_GAMEPAD_RIGHT_THUMB_DEADZONE</code>, for the left and right sticks, respectively. These are <a href="https://docs.microsoft.com/en-us/windows/win32/xinput/getting-started-with-xinput">defined</a> as 7,849 and 8,689 which, if you think that the maximum value of a 16-bit signed integer is 32,767, is not an insignificant amount.

</p><p>

Looking back at our XInput reading code inside <code>WinMain</code>: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-comment">// ...</span></span>
<span class="line"></span>
<span class="line">NewController-&gt;IsAnalog = <span class="hljs-literal">true</span>;</span>
<span class="line">NewController-&gt;StartX = OldController-&gt;EndX;</span>
<span class="line">NewController-&gt;StartY = OldController-&gt;EndY;</span>
<span class="line"></span>
<span class="line">f32 X;</span>
<span class="line"><span class="hljs-keyword">if</span>(Pad-&gt;sThumbLX &lt; <span class="hljs-number">0</span>)</span>
<span class="line">{</span>
<span class="line">    X = (f32)Pad-&gt;sThumbLX / <span class="hljs-number">32768.0f</span>;</span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span></span>
<span class="line">{</span>
<span class="line">    X = (f32)Pad-&gt;sThumbLX / <span class="hljs-number">32767.0f</span>;</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">f32 Y;</span>
<span class="line"><span class="hljs-keyword">if</span>(Pad-&gt;sThumbLY &lt; <span class="hljs-number">0</span>)</span>
<span class="line">{</span>
<span class="line">    Y = (f32)Pad-&gt;sThumbLY / <span class="hljs-number">32768.0f</span>;</span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span></span>
<span class="line">{</span>
<span class="line">    Y = (f32)Pad-&gt;sThumbLY / <span class="hljs-number">32767.0f</span>;</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line"><span class="hljs-comment">// ...</span></span></code></pre><p>

We can start off by saying that both <code>X</code> and <code>Y</code> start at 0. If the value is smaller than the negative dead zone or greater than the dead zone of the left stick, only then do any operation with it, otherwise leave it at zero: 

</p><pre class="listing tilde"><code><div class=" edit"><span class="line">f32 X = <span class="hljs-number">0</span>;</span>
<span class="line"><span class="hljs-keyword">if</span>(Pad-&gt;sThumbLX &lt; -XINPUT_GAMEPAD_LEFT_THUMB_DEADZONE)</span></div><span class="line">{</span>
<span class="line">    X = (f32)Pad-&gt;sThumbLX / <span class="hljs-number">32768.0f</span>;</span>
<span class="line">}</span><div class=" edit"><span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(Pad-&gt;sThumbLX &gt; XINPUT_GAMEPAD_LEFT_THUMB_DEADZONE)</span></div><span class="line">{</span>
<span class="line">    X = (f32)Pad-&gt;sThumbLX / <span class="hljs-number">32767.0f</span>;</span>
<span class="line">}</span>
<span class="line"></span><div class=" edit"><span class="line">f32 Y = <span class="hljs-number">0</span>;</span>
<span class="line"><span class="hljs-keyword">if</span>(Pad-&gt;sThumbLY &lt; -XINPUT_GAMEPAD_LEFT_THUMB_DEADZONE)</span></div><span class="line">{</span>
<span class="line">    Y = (f32)Pad-&gt;sThumbLY / <span class="hljs-number">32768.0f</span>;</span>
<span class="line">}</span><div class=" edit"><span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(Pad-&gt;sThumbLY &gt; XINPUT_GAMEPAD_LEFT_THUMB_DEADZONE)</span></div><span class="line">{</span>
<span class="line">    Y = (f32)Pad-&gt;sThumbLY / <span class="hljs-number">32767.0f</span>;</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;8:</b> <file>[win32_handmade.cpp > WinMain]</file> Ignoring dead zone. Note that in the &ldquo;less than&rdquo; comparison the dead zone is negative!</div></center>
<p>


The time has come to compress these two pieces into a utility function, <code>Win32ProcessXInputStickValue</code>. The code in WinMain will become: 

</p><pre class="listing tilde"><code><div class=" edit"><span class="line">f32 X = Win32ProcessXInputStickValue (Pad-&gt;sThumbLX,</span>
<span class="line">                                      XINPUT_GAMEPAD_LEFT_THUMB_DEADZONE);</span></div><div class=" delete"><span class="line"><span class="hljs-keyword">if</span>(Pad-&gt;sThumbLX &lt; -XINPUT_GAMEPAD_LEFT_THUMB_DEADZONE)</span>
<span class="line">{</span>
<span class="line">    X = (f32)Pad-&gt;sThumbLX / <span class="hljs-number">32768.0f</span>;</span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(Pad-&gt;sThumbLX &gt; XINPUT_GAMEPAD_LEFT_THUMB_DEADZONE)</span>
<span class="line">{</span>
<span class="line">    X = (f32)Pad-&gt;sThumbLX / <span class="hljs-number">32767.0f</span>;</span>
<span class="line">}</span></div><span class="line"></span><div class=" edit"><span class="line">f32 Y = Win32ProcessXInputStickValue (Pad-&gt;sThumbLY, </span>
<span class="line">                                      XINPUT_GAMEPAD_LEFT_THUMB_DEADZONE);</span></div><div class=" delete"><span class="line"><span class="hljs-keyword">if</span>(Pad-&gt;sThumbLY &lt; -XINPUT_GAMEPAD_LEFT_THUMB_DEADZONE)</span>
<span class="line">{</span>
<span class="line">    Y = (f32)Pad-&gt;sThumbLY / <span class="hljs-number">32768.0f</span>;</span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(Pad-&gt;sThumbLY &gt; XINPUT_GAMEPAD_LEFT_THUMB_DEADZONE)</span>
<span class="line">{</span>
<span class="line">    Y = (f32)Pad-&gt;sThumbLY / <span class="hljs-number">32767.0f</span>;</span>
<span class="line">}</span></div><div class=" delete"><span class="line"></span>
<span class="line"><span class="hljs-comment">// TODO(casey): Min/Max macros!!!</span></span>
<span class="line">NewController-&gt;MinX = NewController-&gt;MaxX = NewController-&gt;EndX = X;</span>
<span class="line">NewController-&gt;MinY = NewController-&gt;MaxY = NewController-&gt;EndY = Y;</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;9:</b> <file>[win32_handmade.cpp > WinMain]</file></div></center>
<pre class="listing tilde"><code><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">Win32ProcessKeyboardMessages</span><span class="hljs-params">(game_button_state *NewState, b32 IsDown)</span></span>
<span class="line"></span>{</span>
<span class="line">    NewState-&gt;EndedDown = IsDown;</span>
<span class="line">    ++NewState-&gt;HalfTransitionCount;</span>
<span class="line">}</span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-function">internal f32</span>
<span class="line"><span class="hljs-title">Win32ProcessXInputStickValue</span><span class="hljs-params">(SHORT Value, SHORT DeadZoneThreshold)</span></span>
<span class="line"></span>{</span>
<span class="line">    f32 Result = <span class="hljs-number">0</span>;</span>
<span class="line">    </span>
<span class="line">    <span class="hljs-keyword">if</span>(Value &lt; -DeadZoneThreshold)</span>
<span class="line">    {</span>
<span class="line">        Result = (f32)Value / <span class="hljs-number">32768.0f</span>;</span>
<span class="line">    }</span>
<span class="line">    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(Value &gt; DeadZoneThreshold)</span>
<span class="line">    {</span>
<span class="line">        Result = (f32)Value / <span class="hljs-number">32767.0f</span>;</span>
<span class="line">    }</span>
<span class="line">    </span>
<span class="line">    <span class="hljs-keyword">return</span> (Result);</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;10:</b> <file>[win32_handmade.cpp]</file> Pulling out stick processing code.</div></center>
<p>


At this point we can even make the code better! Looking at it this way we can see that we really should only transform the span from the dead zone end, and not from 0. This way our game will actually see values from zero to whichever point our deadzone is, just remapped in the usable area.

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="320" width="248" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 80,64 L 80,128 " style="fill:none;"/>
<path d="M 112,0 L 112,208 " style="fill:none;"/>
<path d="M 136,32 L 136,56 " style="fill:none;"/>
<path d="M 144,64 L 144,128 " style="fill:none;"/>
<path d="M 152,16 L 168,16 " style="fill:none;"/>
<path d="M 80,64 L 144,64 " style="fill:none;"/>
<path d="M 24,96 L 208,96 " style="fill:none;"/>
<path d="M 80,128 L 144,128 " style="fill:none;"/>
<path d="M 152,16 C 135.2,16 136,32 136,32 " style="fill:none;"/>
<polygon points="144,56 132,50.4 132,61.6 "  style="stroke:none" transform="rotate(90,136,56 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="184" y="4">d</text><text text-anchor="middle" x="192" y="4">e</text><text text-anchor="middle" x="200" y="4">a</text><text text-anchor="middle" x="208" y="4">d</text><text text-anchor="middle" x="184" y="20">z</text><text text-anchor="middle" x="192" y="20">o</text><text text-anchor="middle" x="200" y="20">n</text><text text-anchor="middle" x="208" y="20">e</text><text text-anchor="middle" x="144" y="164">0</text><text text-anchor="middle" x="160" y="164">-</text><text text-anchor="middle" x="176" y="164">-</text><text text-anchor="middle" x="192" y="164">-</text><text text-anchor="middle" x="208" y="164">1</text><text text-anchor="middle" x="152" y="180">u</text><text text-anchor="middle" x="160" y="180">s</text><text text-anchor="middle" x="168" y="180">a</text><text text-anchor="middle" x="176" y="180">b</text><text text-anchor="middle" x="184" y="180">l</text><text text-anchor="middle" x="192" y="180">e</text><text text-anchor="middle" x="152" y="196">v</text><text text-anchor="middle" x="160" y="196">a</text><text text-anchor="middle" x="168" y="196">l</text><text text-anchor="middle" x="176" y="196">u</text><text text-anchor="middle" x="184" y="196">e</text><text text-anchor="middle" x="192" y="196">s</text><text text-anchor="middle" x="112" y="244">0</text><text text-anchor="middle" x="128" y="244">-</text><text text-anchor="middle" x="144" y="244">-</text><text text-anchor="middle" x="160" y="244">-</text><text text-anchor="middle" x="176" y="244">-</text><text text-anchor="middle" x="192" y="244">-</text><text text-anchor="middle" x="208" y="244">1</text><text text-anchor="middle" x="112" y="260">a</text><text text-anchor="middle" x="120" y="260">c</text><text text-anchor="middle" x="128" y="260">t</text><text text-anchor="middle" x="136" y="260">u</text><text text-anchor="middle" x="144" y="260">a</text><text text-anchor="middle" x="152" y="260">l</text><text text-anchor="middle" x="168" y="260">v</text><text text-anchor="middle" x="176" y="260">a</text><text text-anchor="middle" x="184" y="260">l</text><text text-anchor="middle" x="192" y="260">u</text><text text-anchor="middle" x="200" y="260">e</text><text text-anchor="middle" x="208" y="260">s</text><text text-anchor="middle" x="56" y="276">(</text><text text-anchor="middle" x="64" y="276">g</text><text text-anchor="middle" x="72" y="276">a</text><text text-anchor="middle" x="80" y="276">m</text><text text-anchor="middle" x="88" y="276">e</text><text text-anchor="middle" x="104" y="276">n</text><text text-anchor="middle" x="112" y="276">e</text><text text-anchor="middle" x="120" y="276">v</text><text text-anchor="middle" x="128" y="276">e</text><text text-anchor="middle" x="136" y="276">r</text><text text-anchor="middle" x="152" y="276">s</text><text text-anchor="middle" x="160" y="276">e</text><text text-anchor="middle" x="168" y="276">e</text><text text-anchor="middle" x="176" y="276">s</text><text text-anchor="middle" x="192" y="276">v</text><text text-anchor="middle" x="200" y="276">a</text><text text-anchor="middle" x="208" y="276">l</text><text text-anchor="middle" x="216" y="276">u</text><text text-anchor="middle" x="224" y="276">e</text><text text-anchor="middle" x="232" y="276">s</text><text text-anchor="middle" x="96" y="292">i</text><text text-anchor="middle" x="104" y="292">n</text><text text-anchor="middle" x="120" y="292">t</text><text text-anchor="middle" x="128" y="292">h</text><text text-anchor="middle" x="136" y="292">e</text><text text-anchor="middle" x="152" y="292">d</text><text text-anchor="middle" x="160" y="292">e</text><text text-anchor="middle" x="168" y="292">a</text><text text-anchor="middle" x="176" y="292">d</text><text text-anchor="middle" x="192" y="292">z</text><text text-anchor="middle" x="200" y="292">o</text><text text-anchor="middle" x="208" y="292">n</text><text text-anchor="middle" x="216" y="292">e</text><text text-anchor="middle" x="224" y="292">)</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;1:</b> Different ways of mapping the positive X axis.</div></center>

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-function">internal f32</span>
<span class="line"><span class="hljs-title">Win32ProcessXInputStickValue</span><span class="hljs-params">(SHORT Value, SHORT DeadZoneThreshold)</span></span>
<span class="line"></span>{</span>
<span class="line">    f32 Result = <span class="hljs-number">0</span>;</span>
<span class="line">    </span>
<span class="line">    <span class="hljs-keyword">if</span>(Value &lt; -DeadZoneThreshold)</span>
<span class="line">    {</span>
<span class="line">        Result = (f32)((Value + DeadZoneThreshold) / (<span class="hljs-number">32768.0f</span> - DeadZoneThreshold));</span>
<span class="line">    }</span>
<span class="line">    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(Value &gt; DeadZoneThreshold)</span>
<span class="line">    {</span>
<span class="line">        Result = (f32)((Value - DeadZoneThreshold) / (<span class="hljs-number">32767.0f</span> - DeadZoneThreshold));</span>
<span class="line">    }</span>
<span class="line">    </span>
<span class="line">    <span class="hljs-keyword">return</span> (Result);</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;11:</b> <file>[win32_handmade.cpp]</file> Improving dead zone processing.</div></center>
<p>


If you compile and test now, you should find no differences from where we started, except now our code is more solid.

</p>
<a class="target" name="optimizestickvaluecapture">&nbsp;</a><a class="target" name="finishdirectionalstickcode/optimizestickvaluecapture">&nbsp;</a><a class="target" name="toc2.2">&nbsp;</a><h2>Optimize Stick Value Capture</h2>
<p>


If you recall, we've sketched out something that looks like quite a complicated analogue stick handling system. Four our X and Y axis, we have a <code>Start</code>, <code>Min</code>, <code>Max</code> and <code>End</code> value. The idea, of course, is that eventually we'll listen to more than one stick position per frame, and then we'll be able to give all these values to the game. Now, it might be a bit premature. What we really need for now is a single <code>Average</code> value per axis. This will be provided only if the input was marked as <code>IsAnalog</code>. At the same time, the primary values of the stick will be captured as Buttons, and any potential rapid movements will be reflected in the half-transition count. 

</p><p>

In <code>handmade.h</code>, we currently have the following structure for <code>game_controller_input</code>: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">game_controller_input</span></span>
<span class="line">{</span></span>
<span class="line">    b32 IsAnalog;</span>
<span class="line">    </span>
<span class="line">    f32 StartX;</span>
<span class="line">    f32 StartY;</span>
<span class="line">    </span>
<span class="line">    f32 MinX;</span>
<span class="line">    f32 MinY;</span>
<span class="line">    </span>
<span class="line">    f32 MaxX;</span>
<span class="line">    f32 MaxY;</span>
<span class="line">    </span>
<span class="line">    f32 EndX;</span>
<span class="line">    f32 EndY;</span>
<span class="line">    </span>
<span class="line">    <span class="hljs-keyword">union</span></span>
<span class="line">    {</span>
<span class="line">        game_button_state Buttons[<span class="hljs-number">6</span>];</span>
<span class="line">        <span class="hljs-class"><span class="hljs-keyword">struct</span></span>
<span class="line">        {</span></span>
<span class="line">            game_button_state Up;</span>
<span class="line">            game_button_state Down;</span>
<span class="line">            game_button_state Left;</span>
<span class="line">            game_button_state Right;</span>
<span class="line">            game_button_state LeftShoulder;</span>
<span class="line">            game_button_state RightShoulder;</span>
<span class="line">        };</span>
<span class="line">    };</span>
<span class="line">};</span></code></pre><p>

If we modify it as we said, this structure becomes as below (while we're at it, let's also add <code>Start</code> and <code>Back</code> buttons):

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">game_controller_input</span></span>
<span class="line">{</span></span>
<span class="line">    b32 IsAnalog;</span>
<span class="line">    </span><div class=" add"><span class="line">    f32 StickAverageX;</span>
<span class="line">    f32 StickAverageY;</span></div><div class=" delete"><span class="line">    f32 StartX;</span>
<span class="line">    f32 StartY;</span>
<span class="line">    </span>
<span class="line">    f32 MinX;</span>
<span class="line">    f32 MinY;</span>
<span class="line">    </span>
<span class="line">    f32 MaxX;</span>
<span class="line">    f32 MaxY;</span>
<span class="line">    </span>
<span class="line">    f32 EndX;</span>
<span class="line">    f32 EndY;</span></div><span class="line">    </span>
<span class="line">    <span class="hljs-keyword">union</span></span>
<span class="line">    {</span><div class=" edit"><span class="line">        game_button_state Buttons[<span class="hljs-number">12</span>];</span></div><span class="line">        <span class="hljs-class"><span class="hljs-keyword">struct</span></span>
<span class="line">        {</span></span><div class=" add"><span class="line">            game_button_state MoveUp;</span>
<span class="line">            game_button_state MoveDown;</span>
<span class="line">            game_button_state MoveLeft;</span>
<span class="line">            game_button_state MoveRight;</span>
<span class="line">            </span></div><div class=" edit"><span class="line">            game_button_state ActionUp;    <span class="hljs-comment">// previously up</span></span>
<span class="line">            game_button_state ActionDown;  <span class="hljs-comment">// previously down</span></span>
<span class="line">            game_button_state ActionLeft;  <span class="hljs-comment">// previously left</span></span>
<span class="line">            game_button_state ActionRight; <span class="hljs-comment">// previously right</span></span></div><span class="line">            </span>
<span class="line">            game_button_state LeftShoulder;</span>
<span class="line">            game_button_state RightShoulder;</span>
<span class="line"></span><div class=" add"><span class="line">            game_button_state Back;</span>
<span class="line">            game_button_state Start;</span></div><span class="line">        };</span>
<span class="line">    };</span>
<span class="line">};</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;12:</b> <file>[handmade.h]</file> Modifying <code>game_controller_input</code> structure.</div></center>
<p>




<div class="admonition note"><div class="admonition-title"> Securing yourself against modifying Buttons length</div>

</p><p>

    If want to make sure you won't forget to update <code>Buttons</code> length when adding or removing new buttons, you can add the following assertion at the beginning of the <code>GameUpdateAndRender</code>: 

</p><pre class="listing tilde"><code><div class=" add"><span class="line">Assert((&amp;Input-&gt;Controllers[<span class="hljs-number">0</span>].Start - &amp;Input-&gt;Controllers[<span class="hljs-number">0</span>].Buttons[<span class="hljs-number">0</span>]) == </span>
<span class="line">        (ArrayCount(Input-&gt;Controllers[<span class="hljs-number">0</span>].Buttons) - <span class="hljs-number">1</span>));</span></div></code></pre><p>

    We take the very last button available in the anonymous struct, subtract its address from the first one and we should receive the same value as the array count of the <code>Buttons</code> array - 1. 

</p><p>

    You could fool-proof this even further by adding a fake <code>Terminator</code> button at the very end of it and comparing against that. Then you don't even need to subtract 1 (or increase button size).

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-comment">// handmade.h &gt; game_controller_input</span></span>
<span class="line">game_button_state Buttons[<span class="hljs-number">12</span>]; <span class="hljs-comment">// don't need to increase button array size!</span></span>
<span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span></span>
<span class="line">{</span></span>
<span class="line">    game_button_state MoveUp;</span>
<span class="line">    <span class="hljs-comment">//...</span></span>
<span class="line">    game_button_state Back;</span>
<span class="line">    game_button_state Start;</span><div class=" add"><span class="line">    <span class="hljs-comment">// NOTE(casey): All buttons should be added above this line</span></span>
<span class="line"></span>
<span class="line">    game_button_state Terminator;</span></div><span class="line">};</span>
<span class="line"><span class="hljs-comment">// handmade.cpp &gt; GameUpdateAndRender</span></span>
<span class="line">Assert((&amp;Input-&gt;Controllers[<span class="hljs-number">0</span>].Terminator - &amp;Input-&gt;Controllers[<span class="hljs-number">0</span>].Buttons[<span class="hljs-number">0</span>]) == </span>
<span class="line">        (ArrayCount(Input-&gt;Controllers[<span class="hljs-number">0</span>].Buttons)));</span></code></pre><p></div>

</p><p>

We can also update the change in <code>handmade.cpp</code> right away: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">if</span> (Input0-&gt;IsAnalog)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): Use analog movement tuning</span></span><div class=" edit"><span class="line">    GameState-&gt;XOffset += (<span class="hljs-keyword">int</span>)(<span class="hljs-number">4.0f</span> * Input0-&gt;StickAverageX);</span>
<span class="line">    GameState-&gt;ToneHz = <span class="hljs-number">256</span> + (<span class="hljs-keyword">int</span>)(<span class="hljs-number">128.0f</span> * (Input0-&gt;StickAverageY));</span></div><span class="line">}</span>
<span class="line"><span class="hljs-comment">// ...</span></span><div class=" edit"><span class="line"><span class="hljs-keyword">if</span>(Input0-&gt;ActionDown.EndedDown)</span></div><span class="line">{</span>
<span class="line">    GameState-&gt;YOffset += <span class="hljs-number">1</span>;</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;13:</b> <file>[handmade.cpp > GameUpdateAndRender]</file> Applying changes to the Game code.</div></center>
<p>


As for the packing of the values, we need to think a second. Updating the now-Action buttons and Start/Back button states should be simple and straightforward: 

</p><pre class="listing tilde"><code><span class="line">Win32ProcessXInputDigitalButton(Pad-&gt;wButtons,</span><div class=" edit"><span class="line">                                &amp;OldController-&gt;ActionDown,XINPUT_GAMEPAD_A,</span>
<span class="line">                                &amp;NewController-&gt;ActionDown);</span></div><span class="line">Win32ProcessXInputDigitalButton(Pad-&gt;wButtons,</span><div class=" edit"><span class="line">                                &amp;OldController-&gt;ActionRight,XINPUT_GAMEPAD_B,</span>
<span class="line">                                &amp;NewController-&gt;ActionRight);</span></div><span class="line">Win32ProcessXInputDigitalButton(Pad-&gt;wButtons,</span><div class=" edit"><span class="line">                                &amp;OldController-&gt;ActionLeft,XINPUT_GAMEPAD_X,</span>
<span class="line">                                &amp;NewController-&gt;ActionLeft);</span></div><span class="line">Win32ProcessXInputDigitalButton(Pad-&gt;wButtons,</span><div class=" edit"><span class="line">                                &amp;OldController-&gt;ActionUp,XINPUT_GAMEPAD_Y,</span>
<span class="line">                                &amp;NewController-&gt;ActionUp);</span></div><span class="line"></span>
<span class="line">Win32ProcessXInputDigitalButton(Pad-&gt;wButtons,</span>
<span class="line">                                &amp;OldController-&gt;LeftShoulder,XINPUT_GAMEPAD_LEFT_SHOULDER,</span>
<span class="line">                                &amp;NewController-&gt;LeftShoulder);</span>
<span class="line">Win32ProcessXInputDigitalButton(Pad-&gt;wButtons,</span>
<span class="line">                                &amp;OldController-&gt;RightShoulder,XINPUT_GAMEPAD_RIGHT_SHOULDER,</span>
<span class="line">                                &amp;NewController-&gt;RightShoulder);</span>
<span class="line"></span><div class=" add"><span class="line">Win32ProcessXInputDigitalButton(Pad-&gt;wButtons,</span>
<span class="line">                                &amp;OldController-&gt;Start,XINPUT_GAMEPAD_START,</span>
<span class="line">                                &amp;NewController-&gt;Start);</span>
<span class="line">Win32ProcessXInputDigitalButton(Pad-&gt;wButtons,</span>
<span class="line">                                &amp;OldController-&gt;Back,XINPUT_GAMEPAD_BACK,</span>
<span class="line">                                &amp;NewController-&gt;Back);</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;14:</b> <file>[win32_handmade.cpp > WinMain]</file> Packing button values from the controller.</div></center>
<p>


As for the stick and Move values, we have our stick that gives us real numbers from <code>-1.0f</code> (left/down) to <code>1.0f</code> (right/up). We can say that if the stick position (after we've updated the dead zone) is above some random threshold, this button is considered pressed. Let's set the threshold to <code>0.5f</code> for now, and will be able to fine-tune it later. We'll then take this value and pack it inside our button handling code.

</p><p>

We also want to define <code>IsAnalog</code> only when the stick actually moves.

</p><pre class="listing tilde"><code><div class=" delete"><span class="line"><span class="hljs-keyword">bool</span> Up            = Pad-&gt;wButtons &amp; XINPUT_GAMEPAD_DPAD_UP;</span>
<span class="line"><span class="hljs-keyword">bool</span> Down          = Pad-&gt;wButtons &amp; XINPUT_GAMEPAD_DPAD_DOWN;</span>
<span class="line"><span class="hljs-keyword">bool</span> Left          = Pad-&gt;wButtons &amp; XINPUT_GAMEPAD_DPAD_LEFT;</span>
<span class="line"><span class="hljs-keyword">bool</span> Right         = Pad-&gt;wButtons &amp; XINPUT_GAMEPAD_DPAD_RIGHT;</span>
<span class="line"></span>
<span class="line">NewController-&gt;IsAnalog = <span class="hljs-literal">true</span>;</span>
<span class="line">NewController-&gt;StartX = OldController-&gt;EndX;</span>
<span class="line">NewController-&gt;StartY = OldController-&gt;EndY;</span>
<span class="line"></span></div><div class=" edit"><span class="line">NewController-&gt;StickAverageX = Win32ProcessXInputStickValue (</span></div><span class="line">                                Pad-&gt;sThumbLX,XINPUT_GAMEPAD_LEFT_THUMB_DEADZONE);</span><div class=" delete"><span class="line">NewController-&gt;MinX = NewController-&gt;MaxX = NewController-&gt;EndX = X;</span>
<span class="line"></span></div><div class=" edit"><span class="line">NewController-&gt;StickAverageY = Win32ProcessXInputStickValue (</span></div><span class="line">                                Pad-&gt;sThumbLY,XINPUT_GAMEPAD_LEFT_THUMB_DEADZONE);</span><div class=" delete"><span class="line">NewController-&gt;MinY = NewController-&gt;MaxY = NewController-&gt;EndY = Y;</span>
<span class="line"></span></div><div class=" add"><span class="line"><span class="hljs-keyword">if</span> ((NewController-&gt;StickAverageX != <span class="hljs-number">0.0f</span>) ||</span>
<span class="line">    (NewController-&gt;StickAverageY != <span class="hljs-number">0.0f</span>))</span>
<span class="line">{</span>
<span class="line">    NewController-&gt;IsAnalog = <span class="hljs-literal">true</span>;</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">f32 Threshold = <span class="hljs-number">0.5f</span>;</span>
<span class="line">Win32ProcessXInputDigitalButton((NewController-&gt;StickAverageX &gt; Threshold) ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>,</span>
<span class="line">                                &amp;OldController-&gt;MoveRight, <span class="hljs-number">1</span>,</span>
<span class="line">                                &amp;NewController-&gt;MoveRight);</span>
<span class="line">Win32ProcessXInputDigitalButton((NewController-&gt;StickAverageX &lt; -Threshold) ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>,</span>
<span class="line">                                &amp;OldController-&gt;MoveLeft, <span class="hljs-number">1</span>,</span>
<span class="line">                                &amp;NewController-&gt;MoveLeft);</span>
<span class="line">Win32ProcessXInputDigitalButton((NewController-&gt;StickAverageY &gt; Threshold) ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>,</span>
<span class="line">                                &amp;OldController-&gt;MoveUp, <span class="hljs-number">1</span>,</span>
<span class="line">                                &amp;NewController-&gt;MoveUp);</span>
<span class="line">Win32ProcessXInputDigitalButton((NewController-&gt;StickAverageY &lt; -Threshold) ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>,</span>
<span class="line">                                &amp;OldController-&gt;MoveDown, <span class="hljs-number">1</span>,</span>
<span class="line">                                &amp;NewController-&gt;MoveDown);</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;15:</b> <file>[win32_handmade.cpp > WinMain]</file> Updating stick/non-stick values using a &ldquo;fake DPad&rdquo;.</div></center>

<a class="target" name="hookuptherealdpad">&nbsp;</a><a class="target" name="finishdirectionalstickcode/hookuptherealdpad">&nbsp;</a><a class="target" name="toc2.3">&nbsp;</a><h2>Hook up the Real DPad</h2>
<p>


Last, we have a DPad which gives you flat <code>on/off</code> value as any other button does. Usually user uses either one or the other, so we can simply overwrite whatever values DPad had and give it to the stick, before we throw it into the fake DPad code we've added. Moreover, at that point we also want to signal to our game that the input is no longer analog.

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line"><span class="hljs-keyword">if</span> ((NewController-&gt;StickAverageX != <span class="hljs-number">0.0</span>f) ||</span>
<span class="line">    (NewController-&gt;StickAverageY != <span class="hljs-number">0.0</span>f))</span>
<span class="line">{</span>
<span class="line">    NewController-&gt;IsAnalog = <span class="hljs-keyword">true</span>;</span>
<span class="line">}</span>
<span class="line"></span></div><div class=" add"><span class="line"><span class="hljs-keyword">if</span> (Pad-&gt;wButtons &amp; XINPUT_GAMEPAD_DPAD_UP)</span>
<span class="line">{</span>
<span class="line">    NewController-&gt;StickAverageY = <span class="hljs-number">1.0f</span>;</span>
<span class="line">    NewController-&gt;IsAnalog = <span class="hljs-literal">false</span>;</span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">if</span> (Pad-&gt;wButtons &amp; XINPUT_GAMEPAD_DPAD_DOWN)</span>
<span class="line">{</span>
<span class="line">    NewController-&gt;StickAverageY = <span class="hljs-number">-1.0f</span>;</span>
<span class="line">    NewController-&gt;IsAnalog = <span class="hljs-literal">false</span>;</span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">if</span> (Pad-&gt;wButtons &amp; XINPUT_GAMEPAD_DPAD_LEFT)</span>
<span class="line">{</span>
<span class="line">    NewController-&gt;StickAverageX = <span class="hljs-number">-1.0f</span>;</span>
<span class="line">    NewController-&gt;IsAnalog = <span class="hljs-literal">false</span>;</span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">if</span> (Pad-&gt;wButtons &amp; XINPUT_GAMEPAD_DPAD_RIGHT)</span>
<span class="line">{</span>
<span class="line">    NewController-&gt;StickAverageX = <span class="hljs-number">1.0f</span>;</span>
<span class="line">    NewController-&gt;IsAnalog = <span class="hljs-literal">false</span>;</span>
<span class="line">}</span></div><span class="line"></span>
<span class="line">f32 Threshold = <span class="hljs-number">0.5f</span>;</span>
<span class="line">Win32ProcessXInputDigitalButton((NewController-&gt;StickAverageY &lt; -Threshold) ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>,</span>
<span class="line">                                &amp;OldController-&gt;MoveDown, <span class="hljs-number">1</span>,</span>
<span class="line">                                &amp;NewController-&gt;MoveDown);</span>
<span class="line">Win32ProcessXInputDigitalButton((NewController-&gt;StickAverageX &gt; Threshold) ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>,</span>
<span class="line">                                &amp;OldController-&gt;MoveRight, <span class="hljs-number">1</span>,</span>
<span class="line">                                &amp;NewController-&gt;MoveRight);</span>
<span class="line">Win32ProcessXInputDigitalButton((NewController-&gt;StickAverageX &lt; -Threshold) ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>,</span>
<span class="line">                                &amp;OldController-&gt;MoveLeft, <span class="hljs-number">1</span>,</span>
<span class="line">                                &amp;NewController-&gt;MoveLeft);</span>
<span class="line">Win32ProcessXInputDigitalButton((NewController-&gt;StickAverageY &gt; Threshold) ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>,</span>
<span class="line">                                &amp;OldController-&gt;MoveUp, <span class="hljs-number">1</span>,</span>
<span class="line">                                &amp;NewController-&gt;MoveUp);</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;16:</b> <file>[win32_handmade.cpp > WinMain]</file> Handling real DPad values.</div></center>

<a class="target" name="addmovebuttonstokeyboard">&nbsp;</a><a class="target" name="finishdirectionalstickcode/addmovebuttonstokeyboard">&nbsp;</a><a class="target" name="toc2.4">&nbsp;</a><h2>Add Move Buttons to Keyboard</h2>
<p>


Behind all these changes we come out with a free benefit! We can immediately handle keyboard's WASD keys as if they were movement buttons. Let's do it right away!

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'W'</span>)</span>
<span class="line">{</span><div class=" add"><span class="line">    Win32ProcessKeyboardMessages(&amp;KeyboardController-&gt;MoveUp, IsDown);</span></div><span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'A'</span>)</span>
<span class="line">{</span><div class=" add"><span class="line">    Win32ProcessKeyboardMessages(&amp;KeyboardController-&gt;MoveLeft, IsDown);</span></div><span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'S'</span>)</span>
<span class="line">{</span><div class=" add"><span class="line">    Win32ProcessKeyboardMessages(&amp;KeyboardController-&gt;MoveDown, IsDown);</span></div><span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'D'</span>)</span>
<span class="line">{</span><div class=" add"><span class="line">    Win32ProcessKeyboardMessages(&amp;KeyboardController-&gt;MoveRight, IsDown);</span></div><span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'Q'</span>)</span>
<span class="line">{</span>
<span class="line">    Win32ProcessKeyboardMessages(&amp;KeyboardController-&gt;LeftShoulder, IsDown);</span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'E'</span>)</span>
<span class="line">{</span>
<span class="line">    Win32ProcessKeyboardMessages(&amp;KeyboardController-&gt;RightShoulder, IsDown);</span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_UP)</span>
<span class="line">{</span><div class=" edit"><span class="line">    Win32ProcessKeyboardMessages(&amp;KeyboardController-&gt;ActionUp, IsDown);</span></div><span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_DOWN)</span>
<span class="line">{</span><div class=" edit"><span class="line">    Win32ProcessKeyboardMessages(&amp;KeyboardController-&gt;ActionDown, IsDown);</span></div><span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_LEFT)</span>
<span class="line">{</span><div class=" edit"><span class="line">    Win32ProcessKeyboardMessages(&amp;KeyboardController-&gt;ActionLeft, IsDown);</span></div><span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_RIGHT)</span>
<span class="line">{</span><div class=" edit"><span class="line">    Win32ProcessKeyboardMessages(&amp;KeyboardController-&gt;Action, IsDown);</span></div><span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_ESCAPE)</span>
<span class="line">{</span>
<span class="line">    GlobalRunning = <span class="hljs-literal">false</span>;</span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_SPACE)</span>
<span class="line">{</span><div class=" edit"><span class="line">    Win32ProcessKeyboardMessages(&amp;KeyboardController-&gt;Start, IsDown);</span></div><span class="line">}</span><div class=" add"><span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_BACK)</span>
<span class="line">{</span>
<span class="line">    Win32ProcessKeyboardMessages(&amp;KeyboardController-&gt;Back, IsDown);</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;17:</b> <file>[win32_handmade.cpp > Win32ProcessPendingMessages]</file> Adding more keyboard buttons.</div></center>
<p>


While we're at it, let's add some non-analog code to test out if it works: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">if</span> (Input0-&gt;IsAnalog)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): Use analog movement tuning</span></span>
<span class="line">    <span class="hljs-comment">//...</span></span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span></span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): Use digital movement tuning</span></span><div class=" add"><span class="line">    <span class="hljs-keyword">if</span> (Input0-&gt;MoveLeft.EndedDown)</span>
<span class="line">    {</span>
<span class="line">        GameState-&gt;XOffset -= <span class="hljs-number">1</span>;</span>
<span class="line">    }</span>
<span class="line">    </span>
<span class="line">    <span class="hljs-keyword">if</span> (Input0-&gt;MoveRight.EndedDown)</span>
<span class="line">    {</span>
<span class="line">        GameState-&gt;XOffset += <span class="hljs-number">1</span>;</span>
<span class="line">    }</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;18:</b> <file>[handmade.cpp > GameUpdateAndRender]</file> Adding non-analog movement.</div></center>
<p>


And... that's it. That just works. The keyboard now behaves effectively as if it was another controller. Let's go ahead and tighten the final screws on it.

</p>
<a class="target" name="improvekeyboardinputprocessing">&nbsp;</a><a class="target" name="improvekeyboardinputprocessing">&nbsp;</a><a class="target" name="toc3">&nbsp;</a><h1>Improve Keyboard Input Processing</h1>
<p>


We are now in position to finally start tightening down the code for the keyboard processing.

</p>
<a class="target" name="addafifthcontroller(thekeyboard)">&nbsp;</a><a class="target" name="improvekeyboardinputprocessing/addafifthcontroller(thekeyboard)">&nbsp;</a><a class="target" name="toc3.1">&nbsp;</a><h2>Add a Fifth Controller (the Keyboard)</h2>
<p>


If you recall, we have defined 4 controllers that our game would eventually loop through and pick the active one. So let's add a fifth controller which will be our keyboard. It's as simple as cranking up a number in <code>handmade.h</code>:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">game_input</span></span>
<span class="line">{</span></span><div class=" edit"><span class="line">    game_controller_input Controllers[<span class="hljs-number">5</span>];</span></div><span class="line">};</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;19:</b> <file>[handmade.h]</file> Adding an additional controller.</div></center>
<p>


We already started using keyboard as controller 0, so let's keep it at that. Meanwhile for the gamepads, we'll simply store their input in the subsequent controllers.

</p><p>

When we read input from the controllers, we'll introduce our own controller index which will be offset by one. We'll also need to offset the <code>MaxControllerCount</code> to ensure that we always have the correct amount.

</p><pre class="listing tilde"><code><div class=" edit"><span class="line">DWORD MaxControllerCount = <span class="hljs-number">1</span> + XUSER_MAX_COUNT;</span></div><span class="line"><span class="hljs-keyword">if</span>(MaxControllerCount &gt; ArrayCount(NewInput-&gt;Controllers))</span>
<span class="line">{</span>
<span class="line">    MaxControllerCount = ArrayCount(NewInput-&gt;Controllers);</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">for</span> (DWORD ControllerIndex = <span class="hljs-number">0</span>;</span>
<span class="line">        ControllerIndex &lt; MaxControllerCount;</span>
<span class="line">        ++ControllerIndex)</span>
<span class="line">{</span><div class=" add"><span class="line">    DWORD OurControllerIndex = ControllerIndex + <span class="hljs-number">1</span>;</span></div><div class=" edit"><span class="line">    game_controller_input *OldController = &amp;OldInput-&gt;Controllers[OurControllerIndex];</span>
<span class="line">    game_controller_input *NewController = &amp;NewInput-&gt;Controllers[OurControllerIndex];</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;20:</b> <file>[win32_handmade.cpp > WinMain]</file> Moving over other controllers.</div></center>
<p>


While we're at it, we could also go ahead and modify <code>handmade.cpp</code> to check input from all the controllers. For all values but <code>ToneHz</code> we're adding up, so the change should propagate automatically.

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> ControllerIndex = <span class="hljs-number">0</span>;</span>
<span class="line">         ControllerIndex &lt; ArrayCount(Input-&gt;Controllers);</span>
<span class="line">         ++ControllerIndex)</span>
<span class="line">{</span>
<span class="line">    </span></div><div class=" edit"><span class="line">    game_controller_input *Controller = &amp;Input-&gt;Controllers[ControllerIndex];</span>
<span class="line">    <span class="hljs-keyword">if</span> (Controller-&gt;IsAnalog)</span></div><span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// NOTE(casey): Use analog movement tuning</span></span><div class=" edit"><span class="line">        GameState-&gt;XOffset += (<span class="hljs-keyword">int</span>)(<span class="hljs-number">4.0f</span> * Controller-&gt;StickAverageX);</span>
<span class="line">        GameState-&gt;ToneHz = <span class="hljs-number">256</span> + (<span class="hljs-keyword">int</span>)(<span class="hljs-number">128.0f</span> * (Controller-&gt;StickAverageY));</span></div><span class="line">    }</span>
<span class="line">    <span class="hljs-keyword">else</span></span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// NOTE(casey): Use digital movement tuning</span></span><div class=" edit"><span class="line">        <span class="hljs-keyword">if</span> (Controller-&gt;MoveLeft.EndedDown)</span></div><span class="line">        {</span>
<span class="line">            GameState-&gt;XOffset -= <span class="hljs-number">1</span>;</span>
<span class="line">        }</span>
<span class="line">        </span><div class=" edit"><span class="line">        <span class="hljs-keyword">if</span> (Controller-&gt;MoveRight.EndedDown)</span></div><span class="line">        {</span>
<span class="line">            GameState-&gt;XOffset += <span class="hljs-number">1</span>;</span>
<span class="line">        }</span>
<span class="line">    }</span>
<span class="line">    </span><div class=" edit"><span class="line">    <span class="hljs-keyword">if</span>(Controller-&gt;Down.EndedDown)</span></div><span class="line">    {</span>
<span class="line">        GameState-&gt;YOffset += <span class="hljs-number">1</span>;</span>
<span class="line">    }</span><div class=" add"><span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;21:</b> <file>[handmade.cpp > GameUpdateAndRender]</file> Reading from controllers.</div></center>
<p>


To better visualize this new structure, take a look at the figure below:

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="352" width="424" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 32,144 L 32,304 " style="fill:none;"/>
<path d="M 40,48 L 40,80 " style="fill:none;"/>
<path d="M 128,48 L 128,80 " style="fill:none;"/>
<path d="M 128,144 L 128,304 " style="fill:none;"/>
<path d="M 240,80 L 240,240 " style="fill:none;"/>
<path d="M 376,80 L 376,240 " style="fill:none;"/>
<path d="M 40,48 L 128,48 " style="fill:none;"/>
<path d="M 144,64 L 160,64 " style="fill:none;"/>
<path d="M 40,80 L 128,80 " style="fill:none;"/>
<path d="M 240,80 L 376,80 " style="fill:none;"/>
<path d="M 192,96 L 224,96 " style="fill:none;"/>
<path d="M 240,112 L 376,112 " style="fill:none;"/>
<path d="M 192,128 L 224,128 " style="fill:none;"/>
<path d="M 32,144 L 128,144 " style="fill:none;"/>
<path d="M 240,144 L 376,144 " style="fill:none;"/>
<path d="M 144,160 L 160,160 " style="fill:none;"/>
<path d="M 192,160 L 224,160 " style="fill:none;"/>
<path d="M 32,176 L 128,176 " style="fill:none;"/>
<path d="M 240,176 L 376,176 " style="fill:none;"/>
<path d="M 144,192 L 160,192 " style="fill:none;"/>
<path d="M 192,192 L 224,192 " style="fill:none;"/>
<path d="M 32,208 L 128,208 " style="fill:none;"/>
<path d="M 240,208 L 376,208 " style="fill:none;"/>
<path d="M 144,224 L 160,224 " style="fill:none;"/>
<path d="M 192,224 L 224,224 " style="fill:none;"/>
<path d="M 32,240 L 128,240 " style="fill:none;"/>
<path d="M 240,240 L 376,240 " style="fill:none;"/>
<path d="M 144,256 L 160,256 " style="fill:none;"/>
<path d="M 32,272 L 128,272 " style="fill:none;"/>
<path d="M 32,304 L 128,304 " style="fill:none;"/>
<path d="M 160,64 C 176.8,64 176,80 176,80 " style="fill:none;"/>
<path d="M 192,96 C 175.2,96 176,80 176,80 " style="fill:none;"/>
<path d="M 192,128 C 175.2,128 176,144 176,144 " style="fill:none;"/>
<path d="M 160,160 C 176.8,160 176,144 176,144 " style="fill:none;"/>
<path d="M 192,160 C 175.2,160 176,176 176,176 " style="fill:none;"/>
<path d="M 160,192 C 176.8,192 176,176 176,176 " style="fill:none;"/>
<path d="M 192,192 C 175.2,192 176,208 176,208 " style="fill:none;"/>
<path d="M 160,224 C 176.8,224 176,208 176,208 " style="fill:none;"/>
<path d="M 192,224 C 175.2,224 176,240 176,240 " style="fill:none;"/>
<path d="M 160,256 C 176.8,256 176,240 176,240 " style="fill:none;"/>
<polygon points="232,224 220,218.4 220,229.6 "  style="stroke:none" transform="rotate(0,224,224 )"/>
<polygon points="232,192 220,186.4 220,197.6 "  style="stroke:none" transform="rotate(0,224,192 )"/>
<polygon points="232,160 220,154.4 220,165.6 "  style="stroke:none" transform="rotate(0,224,160 )"/>
<polygon points="232,128 220,122.4 220,133.6 "  style="stroke:none" transform="rotate(0,224,128 )"/>
<polygon points="232,96 220,90.4 220,101.6 "  style="stroke:none" transform="rotate(0,224,96 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="48" y="20">W</text><text text-anchor="middle" x="56" y="20">i</text><text text-anchor="middle" x="64" y="20">n</text><text text-anchor="middle" x="72" y="20">d</text><text text-anchor="middle" x="80" y="20">o</text><text text-anchor="middle" x="88" y="20">w</text><text text-anchor="middle" x="96" y="20">s</text><text text-anchor="middle" x="112" y="20">A</text><text text-anchor="middle" x="120" y="20">P</text><text text-anchor="middle" x="128" y="20">I</text><text text-anchor="middle" x="264" y="20">H</text><text text-anchor="middle" x="272" y="20">a</text><text text-anchor="middle" x="280" y="20">n</text><text text-anchor="middle" x="288" y="20">d</text><text text-anchor="middle" x="296" y="20">m</text><text text-anchor="middle" x="304" y="20">a</text><text text-anchor="middle" x="312" y="20">d</text><text text-anchor="middle" x="320" y="20">e</text><text text-anchor="middle" x="336" y="20">H</text><text text-anchor="middle" x="344" y="20">e</text><text text-anchor="middle" x="352" y="20">r</text><text text-anchor="middle" x="360" y="20">o</text><text text-anchor="middle" x="232" y="52">g</text><text text-anchor="middle" x="240" y="52">a</text><text text-anchor="middle" x="248" y="52">m</text><text text-anchor="middle" x="256" y="52">e</text><text text-anchor="middle" x="264" y="52">_</text><text text-anchor="middle" x="272" y="52">i</text><text text-anchor="middle" x="280" y="52">n</text><text text-anchor="middle" x="288" y="52">p</text><text text-anchor="middle" x="296" y="52">u</text><text text-anchor="middle" x="304" y="52">t</text><text text-anchor="middle" x="312" y="52">_</text><text text-anchor="middle" x="320" y="52">c</text><text text-anchor="middle" x="328" y="52">o</text><text text-anchor="middle" x="336" y="52">n</text><text text-anchor="middle" x="344" y="52">t</text><text text-anchor="middle" x="352" y="52">r</text><text text-anchor="middle" x="360" y="52">o</text><text text-anchor="middle" x="368" y="52">l</text><text text-anchor="middle" x="376" y="52">l</text><text text-anchor="middle" x="384" y="52">e</text><text text-anchor="middle" x="392" y="52">r</text><text text-anchor="middle" x="56" y="68">K</text><text text-anchor="middle" x="64" y="68">e</text><text text-anchor="middle" x="72" y="68">y</text><text text-anchor="middle" x="80" y="68">b</text><text text-anchor="middle" x="88" y="68">o</text><text text-anchor="middle" x="96" y="68">a</text><text text-anchor="middle" x="104" y="68">r</text><text text-anchor="middle" x="112" y="68">d</text><text text-anchor="middle" x="272" y="68">C</text><text text-anchor="middle" x="280" y="68">o</text><text text-anchor="middle" x="288" y="68">n</text><text text-anchor="middle" x="296" y="68">t</text><text text-anchor="middle" x="304" y="68">r</text><text text-anchor="middle" x="312" y="68">o</text><text text-anchor="middle" x="320" y="68">l</text><text text-anchor="middle" x="328" y="68">l</text><text text-anchor="middle" x="336" y="68">e</text><text text-anchor="middle" x="344" y="68">r</text><text text-anchor="middle" x="352" y="68">s</text><text text-anchor="middle" x="256" y="100">C</text><text text-anchor="middle" x="264" y="100">o</text><text text-anchor="middle" x="272" y="100">n</text><text text-anchor="middle" x="280" y="100">t</text><text text-anchor="middle" x="288" y="100">r</text><text text-anchor="middle" x="296" y="100">o</text><text text-anchor="middle" x="304" y="100">l</text><text text-anchor="middle" x="312" y="100">l</text><text text-anchor="middle" x="320" y="100">e</text><text text-anchor="middle" x="328" y="100">r</text><text text-anchor="middle" x="352" y="100">0</text><text text-anchor="middle" x="48" y="116">X</text><text text-anchor="middle" x="56" y="116">I</text><text text-anchor="middle" x="64" y="116">n</text><text text-anchor="middle" x="72" y="116">p</text><text text-anchor="middle" x="80" y="116">u</text><text text-anchor="middle" x="88" y="116">t</text><text text-anchor="middle" x="104" y="116">A</text><text text-anchor="middle" x="112" y="116">P</text><text text-anchor="middle" x="120" y="116">I</text><text text-anchor="middle" x="256" y="132">C</text><text text-anchor="middle" x="264" y="132">o</text><text text-anchor="middle" x="272" y="132">n</text><text text-anchor="middle" x="280" y="132">t</text><text text-anchor="middle" x="288" y="132">r</text><text text-anchor="middle" x="296" y="132">o</text><text text-anchor="middle" x="304" y="132">l</text><text text-anchor="middle" x="312" y="132">l</text><text text-anchor="middle" x="320" y="132">e</text><text text-anchor="middle" x="328" y="132">r</text><text text-anchor="middle" x="352" y="132">1</text><text text-anchor="middle" x="48" y="164">G</text><text text-anchor="middle" x="56" y="164">a</text><text text-anchor="middle" x="64" y="164">m</text><text text-anchor="middle" x="72" y="164">e</text><text text-anchor="middle" x="80" y="164">p</text><text text-anchor="middle" x="88" y="164">a</text><text text-anchor="middle" x="96" y="164">d</text><text text-anchor="middle" x="112" y="164">0</text><text text-anchor="middle" x="256" y="164">C</text><text text-anchor="middle" x="264" y="164">o</text><text text-anchor="middle" x="272" y="164">n</text><text text-anchor="middle" x="280" y="164">t</text><text text-anchor="middle" x="288" y="164">r</text><text text-anchor="middle" x="296" y="164">o</text><text text-anchor="middle" x="304" y="164">l</text><text text-anchor="middle" x="312" y="164">l</text><text text-anchor="middle" x="320" y="164">e</text><text text-anchor="middle" x="328" y="164">r</text><text text-anchor="middle" x="352" y="164">2</text><text text-anchor="middle" x="48" y="196">G</text><text text-anchor="middle" x="56" y="196">a</text><text text-anchor="middle" x="64" y="196">m</text><text text-anchor="middle" x="72" y="196">e</text><text text-anchor="middle" x="80" y="196">p</text><text text-anchor="middle" x="88" y="196">a</text><text text-anchor="middle" x="96" y="196">d</text><text text-anchor="middle" x="112" y="196">1</text><text text-anchor="middle" x="256" y="196">C</text><text text-anchor="middle" x="264" y="196">o</text><text text-anchor="middle" x="272" y="196">n</text><text text-anchor="middle" x="280" y="196">t</text><text text-anchor="middle" x="288" y="196">r</text><text text-anchor="middle" x="296" y="196">o</text><text text-anchor="middle" x="304" y="196">l</text><text text-anchor="middle" x="312" y="196">l</text><text text-anchor="middle" x="320" y="196">e</text><text text-anchor="middle" x="328" y="196">r</text><text text-anchor="middle" x="352" y="196">3</text><text text-anchor="middle" x="48" y="228">G</text><text text-anchor="middle" x="56" y="228">a</text><text text-anchor="middle" x="64" y="228">m</text><text text-anchor="middle" x="72" y="228">e</text><text text-anchor="middle" x="80" y="228">p</text><text text-anchor="middle" x="88" y="228">a</text><text text-anchor="middle" x="96" y="228">d</text><text text-anchor="middle" x="112" y="228">2</text><text text-anchor="middle" x="256" y="228">C</text><text text-anchor="middle" x="264" y="228">o</text><text text-anchor="middle" x="272" y="228">n</text><text text-anchor="middle" x="280" y="228">t</text><text text-anchor="middle" x="288" y="228">r</text><text text-anchor="middle" x="296" y="228">o</text><text text-anchor="middle" x="304" y="228">l</text><text text-anchor="middle" x="312" y="228">l</text><text text-anchor="middle" x="320" y="228">e</text><text text-anchor="middle" x="328" y="228">r</text><text text-anchor="middle" x="352" y="228">4</text><text text-anchor="middle" x="48" y="260">G</text><text text-anchor="middle" x="56" y="260">a</text><text text-anchor="middle" x="64" y="260">m</text><text text-anchor="middle" x="72" y="260">e</text><text text-anchor="middle" x="80" y="260">p</text><text text-anchor="middle" x="88" y="260">a</text><text text-anchor="middle" x="96" y="260">d</text><text text-anchor="middle" x="112" y="260">3</text><text text-anchor="middle" x="72" y="292">.</text><text text-anchor="middle" x="80" y="292">.</text><text text-anchor="middle" x="88" y="292">.</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;2:</b> Input Packaging scheme for our game.</div></center>

</p><p>

Truth is, if we've done our platform work correctly, game won't care if the input is coming from a keyboard, gamepad, or whichever input method we will define in the future. The game will only care about what is the value of the &ldquo;left&rdquo; or &ldquo;start&rdquo; or what have you. Maybe in the future we'll want to do something more complicated than that, but for now this system will be more than enough. 

</p>
<a class="target" name="ensurekeyboardstatepersistance">&nbsp;</a><a class="target" name="improvekeyboardinputprocessing/ensurekeyboardstatepersistance">&nbsp;</a><a class="target" name="toc3.2">&nbsp;</a><h2>Ensure Keyboard State Persistance</h2>
<p>


Now that we have a permanent place for our keyboard, let's think about its state. Currently, we clear the it to zero at the start of each frame. So if a key is hit, we receive the message, we set <code>EndedDown</code> correctly, we even pass it to the game... and then we promptly discard this value on the next pass. We want the key to appear down until the user releases the key. So what we really want to do is to only reset <code>HalfTransitionCount</code> of each button state, <code>EndedDown</code> should remain set. Let's look at our keyboard clear code again: 

</p><pre class="listing tilde"><code><span class="line">game_controller_input *KeyboardController = &amp;NewInput-&gt;Controllers[<span class="hljs-number">0</span>];</span>
<span class="line">game_controller_input ZeroController = {};</span>
<span class="line">*KeyboardController = ZeroController;</span></code></pre><p>

In our gamepad code, we were swapping and <code>OldInput</code> and <code>NewInput</code>. We can use the same structures here, as well. Simply copying over the <code>EndedDown</code> value will suffice. While we're at it, we can also get rid of the <code>ZeroController</code> and reinitialize the controller directly. It's a newer C++ feature but it should be pretty simply and straightforward in usage to prevent us any issues.

</p><pre class="listing tilde"><code><div class=" edit"><span class="line">game_controller_input *OldKeyboardController = &amp;OldInput-&gt;Controllers[<span class="hljs-number">0</span>];</span></div><div class=" add"><span class="line">game_controller_input *NewKeyboardController = &amp;NewInput-&gt;Controllers[<span class="hljs-number">0</span>];</span></div><div class=" delete"><span class="line">game_controller_input ZeroController = {};</span></div><div class=" edit"><span class="line">*NewKeyboardController = {};</span></div><div class=" add"><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> ButtonIndex = <span class="hljs-number">0</span>;</span>
<span class="line">        ButtonIndex &lt; ArrayCount(OldKeyboardController-&gt;Buttons);</span>
<span class="line">        ++ButtonIndex)</span>
<span class="line">{</span>
<span class="line">    NewKeyboardController-&gt;Buttons[ButtonIndex].EndedDown =</span>
<span class="line">        OldKeyboardController-&gt;Buttons[ButtonIndex].EndedDown;</span>
<span class="line">}</span></div><span class="line"></span><div class=" edit"><span class="line">Win32ProcessPendingMessages(NewKeyboardController);</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;22:</b> <file>[win32_handmade.cpp > WinMain]</file> Bringing over <code>EndedDown</code>.</div></center>
<p>


Hopefully you can see what's going on here. We still do the full clear of the new state but also preserve the pointer to the previous state and then copy the pieces we're interested in.

</p><p>

Now, when we come in to <code>Win32ProcessPendingMessages</code>, we will already have a structure with the previous state preserved. We also want to add an assertion to <code>Win32ProcessKeyboardMessages</code> to make sure that the two states are different.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">Win32ProcessKeyboardMessages</span><span class="hljs-params">(game_button_state *NewState, b32 IsDown)</span></span>
<span class="line"></span>{</span><div class=" add"><span class="line">    Assert(NewState-&gt;EndedDown != IsDown);</span></div><span class="line">    NewState-&gt;EndedDown = IsDown;</span>
<span class="line">    ++NewState-&gt;HalfTransitionCount;</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;23:</b> <file>[win32_handmade.cpp]</file> Adding an additional assertion.</div></center>
<p>


You can now compile and see that you can keep holding the arrow down key while your gradient will keep scrolling!

</p><p>

<div class="admonition note"><div class="admonition-title"> Why the assertion?</div>

</p><p>

    You might ask: Why do we even need to do this assertion? Isn't it double work? We already check in <code>Win32ProcessPendingMessages</code> that <code>IsDown != WasDown</code> before we even call <code>Win32ProcessKeyboardMessages</code>. 

</p><p>

    First, it doesn't cost us anything to add this assertion. During the final build of the game (when we remove <code>HANDMADE_SLOW</code> flag from the compiler) the assertions will disappear anyway. But during the development we're future-proofing our code, so that if it does change, we can catch unintended functionality right away. In this case, we want to make sure that our half-transition counts aren't messed up since recording a same event twice might lead to dire consequences in the game.</div>

</p>
<a class="target" name="addisconnectedindicatortothecontroller">&nbsp;</a><a class="target" name="improvekeyboardinputprocessing/addisconnectedindicatortothecontroller">&nbsp;</a><a class="target" name="toc3.3">&nbsp;</a><h2>Add <code>IsConnected</code> Indicator to the Controller</h2>
<p>


While we're at it, let's have a new indicator inside our <code>game_input_controller</code> structure, so that to read only from the connected controllers (and avoid the frame rate hit on older XInput libraries). We'll start from expanding our struct definition: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">game_controller_input</span></span>
<span class="line">{</span></span><div class=" add"><span class="line">    b32 IsConnected;</span></div><span class="line">    b32 IsAnalog;</span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;24:</b> <file>[handmade.h]</file> Introducing <code>IsConnected</code> to the <code>game_controller_input</code>.</div></center>
<p>


For now, our keyboard will be always connected: 

</p><pre class="listing tilde"><code><span class="line">game_controller_input *OldKeyboardController = &amp;OldInput-&gt;Controllers[<span class="hljs-number">0</span>];</span>
<span class="line">game_controller_input *NewKeyboardController = &amp;NewInput-&gt;Controllers[<span class="hljs-number">0</span>];</span>
<span class="line">*NewKeyboardController = {};</span><div class=" add"><span class="line">NewKeyboardController-&gt;IsConnected = <span class="hljs-literal">true</span>;</span></div><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> ButtonIndex = <span class="hljs-number">0</span>;</span>
<span class="line">        ButtonIndex &lt; ArrayCount(OldKeyboardController-&gt;Buttons);</span>
<span class="line">        ++ButtonIndex)</span>
<span class="line">{</span>
<span class="line">    NewKeyboardController-&gt;Buttons[ButtonIndex].EndedDown =</span>
<span class="line">        OldKeyboardController-&gt;Buttons[ButtonIndex].EndedDown;</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">Win32ProcessPendingMessages(NewKeyboardController);</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;25:</b> <file>[win32_handmade.cpp > WinMain]</file> Setting <code>IsConnected</code> for the keyboard.</div></center>
<p>


As for the gamepads, we already have a system that does the checking for us. Once we're in, we can immediately mark that controller as connected. However, because we're cycling controller states, we should also remember to mark the disconnected controllers as <code>false</code>:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">if</span> (XInputGetState(ControllerIndex, &amp;ControllerState) == ERROR_SUCCESS)</span>
<span class="line">{</span><div class=" add"><span class="line">    <span class="hljs-comment">// NOTE(casey): This controller is plugged in</span></span>
<span class="line">    NewController-&gt;IsConnected = <span class="hljs-literal">true</span>;</span></div><span class="line">    <span class="hljs-comment">// TODO(casey): See if ControllerState.dwPacketNumber increments too rapidly</span></span>
<span class="line">    XINPUT_GAMEPAD *Pad = &amp;ControllerState.Gamepad;</span>
<span class="line">    NewController-&gt;IsAnalog = <span class="hljs-literal">true</span>;    </span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span></span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): This controller is not available</span></span>
<span class="line">    NewController-&gt;IsConnected = <span class="hljs-literal">false</span>;</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;26:</b> <file>[win32_handmade.cpp > WinMain]</file> Setting <code>IsConnected</code> for the gamepads.</div></center>

<a class="target" name="bughunting:bufferoverrun">&nbsp;</a><a class="target" name="improvekeyboardinputprocessing/bughunting:bufferoverrun">&nbsp;</a><a class="target" name="toc3.4">&nbsp;</a><h2>Bug Hunting: Buffer Overrun</h2>
<p>


If you compile and run now, you'll notice that everything will behave correctly until at a certain point, when you will crash due to the buffer overrun. We'll start hunting for the error right away, but in the meantime let's make ourselves a small helper function whose purpose would be to hand out the controllers as requested, provided they are within the allocated bounds. We'll add this function in <code>handmade.h</code>: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">game_controller_input</span></span>
<span class="line">{</span></span>
<span class="line">    b32 IsConnected;</span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">};</span>
<span class="line"></span>
<span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">game_input</span></span>
<span class="line">{</span></span>
<span class="line">    game_controller_input Controllers[<span class="hljs-number">5</span>];</span>
<span class="line">};</span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-function"><span class="hljs-keyword">inline</span> game_controller_input *<span class="hljs-title">GetController</span><span class="hljs-params">(game_input *Input, <span class="hljs-keyword">int</span> ControllerIndex)</span></span>
<span class="line"></span>{</span>
<span class="line">    Assert(ControllerIndex &lt; ArrayCount (Input-&gt;Controllers));</span>
<span class="line">    game_controller_input *Result = &amp;Input-&gt;Controllers[ControllerIndex];</span>
<span class="line">    <span class="hljs-keyword">return</span> (Result);</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;27:</b> <file>[handmade.h]</file> Defining <code>GetController</code>.</div></center>
<p>


We can now go anywhere we're trying to pull the controllers from and use this function instead:

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> ControllerIndex = <span class="hljs-number">0</span>;</span>
<span class="line">         ControllerIndex &lt; ArrayCount(Input-&gt;Controllers);</span>
<span class="line">         ++ControllerIndex)</span>
<span class="line">{</span>
<span class="line">    </span></div><div class=" edit"><span class="line">    game_controller_input *Controller = GetController(Input, ControllerIndex);</span></div><div class=" C++ "><span class="line">    // ... </span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;28:</b> <file>[handmade.cpp > GameUpdateAndRender]</file></div></center>
<pre class="listing tilde"><code><div class=" edit"><span class="line">game_controller_input *OldKeyboardController = GetController(OldInput, <span class="hljs-number">0</span>);</span>
<span class="line">game_controller_input *NewKeyboardController = GetController(NewInput, <span class="hljs-number">0</span>);</span></div><span class="line">*NewKeyboardController = {};</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;29:</b> <file>[win32_handmade.cpp > WinMain]</file></div></center>
<pre class="listing tilde"><code><span class="line">DWORD OurControllerIndex = ControllerIndex + <span class="hljs-number">1</span>;</span><div class=" edit"><span class="line">game_controller_input *OldController = GetController(OldInput, OurControllerIndex);</span>
<span class="line">game_controller_input *NewController = GetController(NewInput, OurControllerIndex);</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;30:</b> <file>[win32_handmade.cpp > WinMain]</file> Using <code>GetController</code> to access controller</div></center>
<p>




<div class="admonition tip">You can temporarily rename <code>Controllers</code> in the <code>game_input</code> structure to quickly find the places where this array is used.</div>

</p><p>

Ok, we've set up our traps, now let's go bug hunting. Compile, run the game and... you'll crash right away, and at the assertion we've just set up no less! If you click up on the <code>Call Stack</code>, you'll notice that the error happened when we tried to set <code>OldController</code> but we went <em class="underscore">out of (array's) bounds</em>. If you think about what we did in the last few sections, the error should become immediately apparent to you: we've added 1 to the wrong place.

</p><p>

When we were designing our controller system, we introduced a <code>MaxControllerCount</code> to make sure that we never go outside our borders. However, in the subsection  <a href="#toc3.1">3.1</a>, when we added the keyboard controller we also bumped this maximum count by one. Once we go inside the loop, we start accessing Controllers n+1, i.e. 1, 2, 3, 4, 5. (instead of 0, 1, 2, 3). What we really intended is this: 

</p><pre class="listing tilde"><code><div class=" edit"><span class="line">DWORD MaxControllerCount = XUSER_MAX_COUNT;</span>
<span class="line"><span class="hljs-keyword">if</span>(MaxControllerCount &gt; (ArrayCount(NewInput-&gt;Controllers) - <span class="hljs-number">1</span>))</span></div><span class="line">{</span><div class=" edit"><span class="line">    MaxControllerCount = (ArrayCount(NewInput-&gt;Controllers) - <span class="hljs-number">1</span>);</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;31:</b> <file>[win32_handmade.cpp > WinMain]</file> Fixing Buffer overflow bug.</div></center>

<a class="target" name="recap">&nbsp;</a><a class="target" name="recap">&nbsp;</a><a class="target" name="toc4">&nbsp;</a><h1>Recap</h1>
<p>


Today we went through a lot of refactoring but we can finally say that our input system is solid enough to move on. We will of course return to it once we need more features but for now it will suffice. We can move on to new and exciting things next time.

</p>
<a class="target" name="programmingnotions">&nbsp;</a><a class="target" name="programmingnotions">&nbsp;</a><a class="target" name="toc5">&nbsp;</a><h1>Programming Notions</h1>

<a class="target" name="introtofunctionalprogramming">&nbsp;</a><a class="target" name="programmingnotions/introtofunctionalprogramming">&nbsp;</a><a class="target" name="toc5.1">&nbsp;</a><h2>Intro to Functional Programming</h2>
<p>


When programming, there're two prevalent <em class="underscore">programming paradigms</em> and therefore ways of treating functions. 

</p><p>

In the <em class="underscore">object-oriented</em> programming, coding revolves around the idea of &ldquo;objects&rdquo;. They are <em class="underscore">constructed</em> (mostly out of a series of structs), operate and are destroyed as if they were actual entities. 

</p><p>

In such a context, functions are used almost exclusively as &ldquo;methods&rdquo;, i.e. related to very specific usage in service of those structs. They usually only take a reference to the object they report to, maybe a few more parameters to affect it with, but what happens inside is invisible to you. State of something may change. Memory may be overwritten. You don't know what's going on. 

</p><p>

What this means is that you can overwrite something that's not visible to you. Calling the function with side effects changes the permanent data store in a program in a way that, say, if you call that function twice in a row or in different order, those calls would yield different results. 

</p><p>

As an example we have seen, think about DirectSound. You don't even see the functions you need to call: these are passed to you as pointers inside the DirectSound structs (a recurring theme in Object-Oriented Programming in and of itself). 

</p><p>

On the other hand, think about a function which doesn't have any side effects or internal repercussions. Think about a sine function: you ask it a sine of a given number, it returns the sine of that number. This value will never change if the input never changes, no matter what. A programming paradigm which is constructed on such functions is called <em class="underscore">functional programming</em>. 

</p><p>

Where possible, we will be trying to employ functional programming throughout this course. While we will still have our <em class="underscore">game state</em> which will be most likely altered in some way, it's a good ideal to thrive towards, as the limited hidden functionality (if any at all) will prevent you many a headache later down the line. The understandability and the reliability of the program will increase if you use functional programming. It's not our objective to make our code purely functional but maintaining the focus on it is important. 

</p>
<a class="target" name="navigation">&nbsp;</a><a class="target" name="navigation">&nbsp;</a><a class="target" name="toc6">&nbsp;</a><h1>Navigation</h1>
<p>


Previous: <a href="../html/day16.html">Day 16. Visual Studio Compiler Switches</a>

</p><p>

<a href="../index.md.html">Back to Index</a>

</p>
<div class="nonumberh1">Glossary </div>
<p>


<ul>
<li class="asterisk">Dead zones
</li>
<li class="asterisk">Out of Bounds</li></ul>

</p>
<div class="nonumberh1">Articles</div>
<p>


<a href="https://en.wikipedia.org/wiki/Functional_programming">Functional Programming</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/xinput/getting-started-with-xinput">Getting started with XInput</a>

</p><p>

<style class="fallback">
  body {
    visibility: hidden;
    font-family: sans-serif;
  }
</style>

</p><p>

<script>
  markdeepOptions = { tocStyle: 'long' };
  window.alreadyProcessedMarkdeep ||
    (document.body.style.visibility = 'visible');
</script>

</p><p>

</p></span><div id="mdContextMenu" style="visibility:hidden"></div><div class="markdeepFooter"><i>formatted by <a href="https://casual-effects.com/markdeep" style="color:#999">Markdeep&nbsp;1.10&nbsp;&nbsp;</a></i><div style="display:inline-block;font-size:13px;font-family:'Times New Roman',serif;vertical-align:middle;transform:translate(-3px,-1px)rotate(135deg);">&#x2712;</div></div>