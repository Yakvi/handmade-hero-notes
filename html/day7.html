<meta charset="UTF-8"><meta http-equiv="content-type" content="text/html;charset=UTF-8"><meta name="viewport" content="width=600, initial-scale=1"><style>body{max-width:680px;margin:auto;padding:20px;text-align:justify;line-height:140%; -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-smoothing:antialiased;color:#222;font-family:Palatino,Georgia,"Times New Roman",serif}</style><style>@media print{*{-webkit-print-color-adjust:exact;text-shadow:none !important}}body{counter-reset: h1 h2 h3 h4 h5 h6 paragraph}@page{margin:0;size:auto}#mdContextMenu{position:absolute;background:#383838;cursor:default;border:1px solid #999;color:#fff;padding:4px 0px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,"Helvetica Neue",sans-serif;font-size:85%;font-weight:600;border-radius:4px;box-shadow:0px 3px 10px rgba(0,0,0,35%)}#mdContextMenu div{padding:0px 20px}#mdContextMenu div:hover{background:#1659d1}.md code,.md pre{font-family:Menlo,Consolas,monospace;font-size:98%;text-align:left;line-height:140%}.md .mediumToc code,.md longToc code,.md .shortToc code,.md h1 code,.md h2 code,.md h3 code,.md h4 code,.md h5 code,.md h6 code{font-size:unset}.md div.title{font-size:26px;font-weight:800;line-height:120%;text-align:center}.md div.afterTitles{height:10px}.md div.subtitle{text-align:center}.md iframe.textinsert, .md object.textinsert,.md iframe:not(.markdeep){display:block;margin-top:10px;margin-bottom:10px;width:100%;height:75vh;border:1px solid #000;border-radius:4px;background:#f5f5f4}.md .image{display:inline-block}.md img{max-width:100%;page-break-inside:avoid}.md li{text-align:left;text-indent:0}.md pre.listing {width:100%;tab-size:4;-moz-tab-size:4;-o-tab-size:4;counter-reset:line;overflow-x:auto;resize:horizontal}.md pre.listing .linenumbers span.line:before{width:30px;margin-left:-28px;font-size:80%;text-align:right;counter-increment:line;content:counter(line);display:inline-block;padding-right:13px;margin-right:8px;color:#ccc}.md div.tilde{margin:20px 0 -10px;text-align:center}.md .imagecaption,.md .tablecaption,.md .listingcaption{display:inline-block;margin:7px 5px 12px;text-align:justify;font-style:italic}.md img.pixel{image-rendering:-moz-crisp-edges;image-rendering:pixelated}.md blockquote.fancyquote{margin:25px 0 25px;text-align:left;line-height:160%}.md blockquote.fancyquote::before{content:"“";color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-right:6px;vertical-align:-0.3em}.md span.fancyquote{font-size:118%;color:#777;font-style:italic}.md span.fancyquote::after{content:"”";font-style:normal;color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-left:6px;vertical-align:-0.3em}.md blockquote.fancyquote .author{width:100%;margin-top:10px;display:inline-block;text-align:right}.md small{font-size:60%}.md big{font-size:150%}.md div.title,contents,.md .tocHeader,.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .shortTOC,.md .mediumTOC,.nonumberh1,.nonumberh2,.nonumberh3,.nonumberh4,.nonumberh5,.nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;margin:13.4px 0 13.4px;padding:15px 0 3px;border-top:none;clear:both}.md .tocTop {display:none}.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .nonumberh1,.md .nonumberh2,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{page-break-after:avoid;break-after:avoid}.md svg.diagram{display:block;font-family:Menlo,Consolas,monospace;font-size:98%;text-align:center;stroke-linecap:round;stroke-width:2px;page-break-inside:avoid;stroke:#000;fill:#000}.md svg.diagram .opendot{fill:#fff}.md svg.diagram .shadeddot{fill:#CCC}.md svg.diagram .dotteddot{stroke:#000;stroke-dasharray:4;fill:none}.md svg.diagram text{stroke:none}@media print{@page{margin:1in 5mm;transform: scale(150%)}}@media print{.md .pagebreak{page-break-after:always;visibility:hidden}}.md a{font-family:Georgia,Palatino,'Times New Roman'}.md h1,.md .tocHeader,.md .nonumberh1{border-bottom:3px solid;font-size:20px;font-weight:bold;}.md h1,.md .nonumberh1{counter-reset: h2 h3 h4 h5 h6}.md h2,.md .nonumberh2{counter-reset: h3 h4 h5 h6;border-bottom:2px solid #999;color:#555;font-weight:bold;font-size:18px;}.md h3,.md h4,.md h5,.md h6,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;color:#555;font-size:16px;}.md h3{counter-reset:h4 h5 h6}.md h4{counter-reset:h5 h6}.md h5{counter-reset:h6}.md div.table{margin:16px 0 16px 0}.md table{border-collapse:collapse;line-height:140%;page-break-inside:avoid}.md table.table{margin:auto}.md table.calendar{width:100%;margin:auto;font-size:11px;font-family:Verdana,Helvetica,Arial,sans-serif}.md table.calendar th{font-size:16px}.md .today{background:#ECF8FA}.md .calendar .parenthesized{color:#999;font-style:italic}.md table.table th{color:#FFF;background-color:#AAA;border:1px solid #888;padding:8px 15px 8px 15px}.md table.table td{padding:5px 15px 5px 15px;border:1px solid #888}.md table.table tr:nth-child(even){background:#EEE}.md pre.tilde{border-top: 1px solid #CCC;border-bottom: 1px solid #CCC;padding: 5px 0 5px 20px;margin:0 0 0 0;background:#FCFCFC;page-break-inside:avoid}.md a.target{width:0px;height:0px;visibility:hidden;font-size:0px;display:inline-block}.md a:link, .md a:visited{color:#38A;text-decoration:none}.md a:link:hover{text-decoration:underline}.md dt{font-weight:700}.md dl>dd{margin-top:-8px; margin-bottom:8px}.md dl>table{margin:35px 0 30px}.md code{page-break-inside:avoid;} @media print{.md .listing code{white-space:pre-wrap}}.md .endnote{font-size:13px;line-height:15px;padding-left:10px;text-indent:-10px}.md .bib{padding-left:80px;text-indent:-80px;text-align:left}.markdeepFooter{font-size:9px;text-align:right;padding-top:80px;color:#999}.md .mediumTOC{float:right;font-size:12px;line-height:15px;border-left:1px solid #CCC;padding-left:15px;margin:15px 0px 15px 25px}.md .mediumTOC .level1{font-weight:600}.md .longTOC .level1{font-weight:600;display:block;padding-top:12px;margin:0 0 -20px}.md .shortTOC{text-align:center;font-weight:bold;margin-top:15px;font-size:14px}.md .admonition{position:relative;margin:1em 0;padding:.4rem 1rem;border-radius:.2rem;border-left:2.5rem solid rgba(68,138,255,.4);background-color:rgba(68,138,255,.15);}.md .admonition-title{font-weight:bold;border-bottom:solid 1px rgba(68,138,255,.4);padding-bottom:4px;margin-bottom:4px;margin-left: -1rem;padding-left:1rem;margin-right:-1rem;border-color:rgba(68,138,255,.4)}.md .admonition.tip{border-left:2.5rem solid rgba(50,255,90,.4);background-color:rgba(50,255,90,.15)}.md .admonition.tip::before{content:"\24d8";font-weight:bold;font-size:150%;position:relative;top:3px;color:rgba(26,128,46,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.tip>.admonition-title{border-color:rgba(50,255,90,.4)}.md .admonition.warn,.md .admonition.warning{border-left:2.5rem solid rgba(255,145,0,.4);background-color:rgba(255,145,0,.15)}.md .admonition.warn::before,.md .admonition.warning::before{content:"\26A0";font-weight:bold;font-size:150%;position:relative;top:2px;color:rgba(128,73,0,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.warn>.admonition-title,.md .admonition.warning>.admonition-title{border-color:rgba(255,145,0,.4)}.md .admonition.error{border-left: 2.5rem solid rgba(255,23,68,.4);background-color:rgba(255,23,68,.15)}.md .admonition.error>.admonition-title{border-color:rgba(255,23,68,.4)}.md .admonition.error::before{content: "\2612";font-family:"Arial";font-size:200%;position:relative;color:rgba(128,12,34,.8);top:-2px;left:-3rem;display:block;width:0;height:0}.md .admonition p:last-child{margin-bottom:0}.md li.checked,.md li.unchecked{list-style:none;overflow:visible;text-indent:-1.2em}.md li.checked:before,.md li.unchecked:before{content:"\2611";display:block;float:left;width:1em;font-size:120%}.md li.unchecked:before{content:"\2610"}</style><style>.md h1::before {
content:counter(h1) " ";
counter-increment: h1;margin-right:10px}.md h2::before {
content:counter(h1) "."counter(h2) " ";
counter-increment: h2;margin-right:10px}.md h3::before {
content:counter(h1) "."counter(h2) "."counter(h3) " ";
counter-increment: h3;margin-right:10px}.md h4::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) " ";
counter-increment: h4;margin-right:10px}.md h5::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) " ";
counter-increment: h5;margin-right:10px}.md h6::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) "."counter(h6) " ";
counter-increment: h6;margin-right:10px}</style><style>.hljs{display:block;overflow-x:auto;padding:0.5em;background:#fff;color:#000;-webkit-text-size-adjust:none}.hljs-comment{color:#006a00}.hljs-keyword{color:#02E}.hljs-literal,.nginx .hljs-title{color:#aa0d91}.method,.hljs-list .hljs-title,.hljs-tag .hljs-title,.setting .hljs-value,.hljs-winutils,.tex .hljs-command,.http .hljs-title,.hljs-request,.hljs-status,.hljs-name{color:#008}.hljs-envvar,.tex .hljs-special{color:#660}.hljs-string{color:#c41a16}.hljs-tag .hljs-value,.hljs-cdata,.hljs-filter .hljs-argument,.hljs-attr_selector,.apache .hljs-cbracket,.hljs-date,.hljs-regexp{color:#080}.hljs-sub .hljs-identifier,.hljs-pi,.hljs-tag,.hljs-tag .hljs-keyword,.hljs-decorator,.ini .hljs-title,.hljs-shebang,.hljs-prompt,.hljs-hexcolor,.hljs-rule .hljs-value,.hljs-symbol,.hljs-symbol .hljs-string,.hljs-number,.css .hljs-function,.hljs-function .hljs-title,.coffeescript .hljs-attribute{color:#A0C}.hljs-function .hljs-title{font-weight:bold;color:#000}.hljs-class .hljs-title,.smalltalk .hljs-class,.hljs-type,.hljs-typename,.hljs-tag .hljs-attribute,.hljs-doctype,.hljs-class .hljs-id,.hljs-built_in,.setting,.hljs-params,.clojure .hljs-attribute{color:#5c2699}.hljs-variable{color:#3f6e74}.css .hljs-tag,.hljs-rule .hljs-property,.hljs-pseudo,.hljs-subst{color:#000}.css .hljs-class,.css .hljs-id{color:#9b703f}.hljs-value .hljs-important{color:#ff7700;font-weight:bold}.hljs-rule .hljs-keyword{color:#c5af75}.hljs-annotation,.apache .hljs-sqbracket,.nginx .hljs-built_in{color:#9b859d}.hljs-preprocessor,.hljs-preprocessor *,.hljs-pragma{color:#643820}.tex .hljs-formula{background-color:#eee;font-style:italic}.diff .hljs-header,.hljs-chunk{color:#808080;font-weight:bold}.diff .hljs-change{background-color:#bccff9}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-comment .hljs-doctag{font-weight:bold}.method .hljs-id{color:#000}</style><style>div.title { padding-top: 40px; } div.afterTitles { height: 15px; }</style><meta charset="utf-8">
<link rel="stylesheet" href="../css/style.css">

<span class="md"><p><title>Day 7. Initializing DirectSound</title><div class="title"> Day 7. Initializing DirectSound </div>

<div class="afterTitles"></div>
<em class="underscore">Video Length (includig Q&A): <a href="https://hero.handmade.network/episode/code/day007/">1h32</a></em>

</p><p>

Welcome to Day 7 of &ldquo;Handmade Hero Notes&rdquo;, the book where we follow the footsteps of <a href="https://handmadehero.org/">Handmade Hero</a> in making the complete game from scratch, with no external libraries. If you'd like to follow along, preorder the game on <a href="https://handmadehero.org/">handmadehero.org</a>, and you will receive access to the GitHub repository, containing complete source code (tagged day-by-day) as well as a variety of other useful resources.

</p><p>

It's hard to believe we've already gone through <em class="underscore">7 days</em> done. We now have our own window rendering, we managed to make our input working on gamepad and keyboard, and today we'll start working on the sound. It will take us a while, so let's jump straight into it!

</p>
<div class="longTOC">
    <p align="center">
        <span align="left"><a href="day6.html">Day 6</a></span>
        <a href="../index.html"><img src = "../media/logo.png"></a>
        <span align="right"><a href="day8.html">Day 8</a></span>
    </p><p><a href="#" class="tocTop">(Top)</a><br/>
<a href="#introductiontosoundprogrammingforgames" class="level1"><span class="tocNumber">1&nbsp; </span>Introduction to Sound Programming for Games</a><br/>
<a href="#initializedirectsoundoverview" class="level1"><span class="tocNumber">2&nbsp; </span>Initialize DirectSound Overview</a><br/>
&nbsp;&nbsp;<a href="#initializedirectsoundoverview/loadthelibrary" class="level2"><span class="tocNumber">2.1&nbsp; </span>Load the Library</a><br/>
&nbsp;&nbsp;<a href="#initializedirectsoundoverview/createadirectsoundobject" class="level2"><span class="tocNumber">2.2&nbsp; </span>Create a DirectSound Object</a><br/>
&nbsp;&nbsp;<a href="#initializedirectsoundoverview/setcooperativelevel" class="level2"><span class="tocNumber">2.3&nbsp; </span>Set Cooperative Level</a><br/>
&nbsp;&nbsp;<a href="#initializedirectsoundoverview/createaprimarybuffer" class="level2"><span class="tocNumber">2.4&nbsp; </span>Create a Primary Buffer</a><br/>
&nbsp;&nbsp;<a href="#initializedirectsoundoverview/createasecondarybuffer" class="level2"><span class="tocNumber">2.5&nbsp; </span>Create a Secondary Buffer</a><br/>
<a href="#deepdive:directsoundobjects" class="level1"><span class="tocNumber">3&nbsp; </span>Deep Dive: DirectSound Objects</a><br/>
&nbsp;&nbsp;<a href="#deepdive:directsoundobjects/methods" class="level2"><span class="tocNumber">3.1&nbsp; </span>Methods</a><br/>
&nbsp;&nbsp;<a href="#deepdive:directsoundobjects/virtualfunctiontables" class="level2"><span class="tocNumber">3.2&nbsp; </span>Virtual Function Tables</a><br/>
&nbsp;&nbsp;<a href="#deepdive:directsoundobjects/cominterfaces" class="level2"><span class="tocNumber">3.3&nbsp; </span>COM Interfaces</a><br/>
&nbsp;&nbsp;<a href="#deepdive:directsoundobjects/deepdiveintothedisassembly" class="level2"><span class="tocNumber">3.4&nbsp; </span>Deep Dive into the Disassembly</a><br/>
<a href="#recap" class="level1"><span class="tocNumber">4&nbsp; </span>Recap</a><br/>
<a href="#exercises" class="level1"><span class="tocNumber">5&nbsp; </span>Exercises</a><br/>
&nbsp;&nbsp;<a href="#exercises/readonotheraudioapis" class="level2"><span class="tocNumber">5.1&nbsp; </span>Read on Other Audio APIs</a><br/>
&nbsp;&nbsp;<a href="#exercises/implementanotheraudioapi" class="level2"><span class="tocNumber">5.2&nbsp; </span>Implement Another Audio API</a><br/>
<a href="#programmingnotions" class="level1"><span class="tocNumber">6&nbsp; </span>Programming Notions</a><br/>
&nbsp;&nbsp;<a href="#programmingnotions/api" class="level2"><span class="tocNumber">6.1&nbsp; </span>API</a><br/>
<a href="#sideconsiderations" class="level1"><span class="tocNumber">7&nbsp; </span>Side Considerations</a><br/>
&nbsp;&nbsp;<a href="#sideconsiderations/aboutgameoptimization" class="level2"><span class="tocNumber">7.1&nbsp; </span>About Game Optimization</a><br/>
<a href="#navigation" class="level1"><span class="tocNumber">8&nbsp; </span>Navigation</a><br/>
</p></div><a class="target" name="introductiontosoundprogrammingforgames">&nbsp;</a><a class="target" name="introductiontosoundprogrammingforgames">&nbsp;</a><a class="target" name="toc1">&nbsp;</a><h1>Introduction to Sound Programming for Games</h1>
<p>


There are many sound APIs. Shocking, right? And the one we're about to implement is not necessarily the best the lowest-level available, or even the fastest. We're going to be using DirectSound so it will have as much compatibility as possible with the older systems. Sure, the number of users on these older systems is practically zero at this point, but there's not a lot of cost for us to have it running, at least for the majority of the code so far. 

</p><p>

Alternatives for DirectSound are many, and none of them are particularly good. Thing is, audio is <em class="underscore">complicated</em>. You've seen so far intro to video handling, input handling, and really, if you look back there's not that much code in it to make each individual piece of it work. Sound is difficult because it can never stop, and should always be as close to perfect as possible. 

</p><p>

A workflow using DirectSound starts with allocating a <em class="underscore">buffer</em> of sound. And this buffer is <em class="underscore">circular</em>: each time sound reproduction arrives to the end, it loops around to the beginning, so that it constantly goes around that buffer in circles. In other words, a <a href="https://en.wikipedia.org/wiki/Circular_buffer">circular buffer</a>.

</p><p>

Let's say we allocate a pretty long buffer, 2 seconds for instance. 

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="160" width="336" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 24,32 L 24,48 " style="fill:none;"/>
<path d="M 24,80 L 24,112 " style="fill:none;"/>
<path d="M 296,32 L 296,48 " style="fill:none;"/>
<path d="M 296,80 L 296,112 " style="fill:none;"/>
<path d="M 40,16 L 280,16 " style="fill:none;"/>
<path d="M 40,64 L 280,64 " style="fill:none;"/>
<path d="M 24,96 L 296,96 " style="fill:none;"/>
<path d="M 40,16 C 23.2,16 24,32 24,32 " style="fill:none;"/>
<path d="M 280,16 C 296.8,16 296,32 296,32 " style="fill:none;"/>
<polygon points="288,64 276,58.4 276,69.6 "  style="stroke:none" transform="rotate(0,280,64 )"/>
<polygon points="32,48 20,42.4 20,53.6 "  style="stroke:none" transform="rotate(90,24,48 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="24" y="132">0</text><text text-anchor="middle" x="296" y="132">2</text><text text-anchor="middle" x="304" y="132">s</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_diagram">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;1:</b> Sound Memory Buffer.</div></center>

</p><p>

As you might know, these days its pretty common to have 48 kHz which means that there're 48000 <em class="underscore">samples</em> per second, so our 2 second buffer would contain 96000 of the sound samples. This means that, at any given point in time, sound hardware is reading a chunk of our memory in order to reproduce the sound. This can be represented by a cursor on this buffer.

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="112" width="336" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 24,16 L 24,48 " style="fill:none;"/>
<path d="M 80,48 L 80,64 " style="fill:none;"/>
<path d="M 296,16 L 296,48 " style="fill:none;"/>
<path d="M 24,32 L 72,32 " style="fill:none;"/>
<path d="M 88,32 L 296,32 " style="fill:none;"/>
<path d="M 96,48 L 152,48 " style="fill:none;"/>
<polygon points="160,48 148,42.4 148,53.6 "  style="stroke:none" transform="rotate(0,152,48 )"/>
<polygon points="88,48 76,42.4 76,53.6 "  style="stroke:none" transform="rotate(270,80,48 )"/>
<circle cx="80" cy="32" r="6" class="closeddot"/><g transform="translate(0,0)"><text text-anchor="middle" x="168" y="52">r</text><text text-anchor="middle" x="176" y="52">e</text><text text-anchor="middle" x="184" y="52">a</text><text text-anchor="middle" x="192" y="52">d</text><text text-anchor="middle" x="208" y="52">d</text><text text-anchor="middle" x="216" y="52">i</text><text text-anchor="middle" x="224" y="52">r</text><text text-anchor="middle" x="232" y="52">e</text><text text-anchor="middle" x="240" y="52">c</text><text text-anchor="middle" x="248" y="52">t</text><text text-anchor="middle" x="256" y="52">i</text><text text-anchor="middle" x="264" y="52">o</text><text text-anchor="middle" x="272" y="52">n</text><text text-anchor="middle" x="24" y="68">0</text><text text-anchor="middle" x="296" y="84">2</text><text text-anchor="middle" x="304" y="84">s</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_diagram">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;2:</b> Hardware cursor.</div></center>

</p><p>

If our game is running at 60 frames per second, we should be producing 800 samples <em class="underscore">per frame</em> in order to line up our audio to the video. And we can't really write straight under the cursor as we risk to produce bad data as a result. This means that we need to write a bit ahead of the cursor. Let's say it's our <em class="underscore">game cursor</em>. We will be writing there our sound frames, and when hardware cursor will catch up, new sounds will be played. 

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="128" width="336" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 24,32 L 24,64 " style="fill:none;"/>
<path d="M 80,64 L 80,80 " style="fill:none;"/>
<path d="M 168,16 L 168,32 " style="fill:none;"/>
<path d="M 304,32 L 304,64 " style="fill:none;"/>
<path d="M 24,48 L 72,48 " style="fill:none;"/>
<path d="M 88,48 L 160,48 " style="fill:none;"/>
<path d="M 176,48 L 304,48 " style="fill:none;"/>
<polygon points="176,32 164,26.4 164,37.6 "  style="stroke:none" transform="rotate(90,168,32 )"/>
<polygon points="88,64 76,58.4 76,69.6 "  style="stroke:none" transform="rotate(270,80,64 )"/>
<circle cx="80" cy="48" r="6" class="closeddot"/><circle cx="168" cy="48" r="6" class="closeddot"/><g transform="translate(0,0)"><text text-anchor="middle" x="24" y="84">0</text><text text-anchor="middle" x="296" y="100">2</text><text text-anchor="middle" x="304" y="100">s</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_diagram">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;3:</b> Hardware cursor and game cursor.</div></center>

</p><p>

But not too much! Otherwise the sound <em class="underscore">lag</em> would be too noticeable to ignore. 

</p><p>

In conclusion, our objective is always be a little bit ahead of the hardware cursor. 

</p><p>

Why two seconds buffer? If we're playing the game at 60 frames per second, a 16 ms buffer should be enough! We're doing it to prevent possible &ldquo;frame drops&rdquo;. There are two possible approaches here: 

</p><p>

<ul>
<li class="asterisk">We'll be writing waaay ahead from where we are right now. This however implies a lot of potential data overwriting.
</li>
<li class="asterisk">Writing only one frame ahead of us. This would imply that we stick to 16 frames per second, and if we take too long to draw the next frame, we skip. This is the solution we're going for.</li></ul>

</p><p>

Here is where the long buffer comes into play. Normally, if you ever heard a program go &ldquo;drrrrr&rdquo; on a sound that was playing, that was because the buffer was too small, and the program was infinitely repeating it. If you have a two second buffer? You can simply stop sending samples, and the contents of the buffer (whatever happened in the past two seconds) will be playing instead. Of course, if the frame delay happens when there's a big explosion happening, you might hear that sudden jump, but the sound still will be smooth, there's a lot of sound to be playing until you come back. 

</p><p>

Having such a giant buffer proves quite effective. Even if your game for some reason is struck by some disaster, the sound will still be fine. 

</p><p>

Now there're other considerations that we'll need to take into account, like where will we put our &ldquo;page flip&rdquo;? How to keep the video and audio feed synchronized? Etc. These are all the considerations that we will <em class="underscore">not</em> deal with today. 

</p><p>

We will focus solely on simple matters like: 

</p><p>

<ol start=1>
<li class="number">Open a handle to DirectSound. 
</li>
<li class="number">Get this buffer up and running, where DirectSound would have its infinite loop on, and place the same sound over and over and over.</li></ol>

</p><p>

At the end, this is just some memory that we're writing to. As we did with the bitmap, we write sound bits to a buffer, and DirectSound fetches those bits to reproduce the sound to the speakers.

</p>
<a class="target" name="initializedirectsoundoverview">&nbsp;</a><a class="target" name="initializedirectsoundoverview">&nbsp;</a><a class="target" name="toc2">&nbsp;</a><h1>Initialize DirectSound Overview</h1>
<p>


To get started, let's <code>#include</code> DirectSound header file, <code>dsound.h</code>:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;xinput.h&gt;</span></span></span><div class=" add"><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dsound.h&gt;</span></span></span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;1:</b> <file>[win32_handmade.cpp]</file> Adding DirectSound headers.</div></center>
<p>


If you remember, we initialized XInput at the very beginning of our <code>WinMain</code>. Unfortunately, we cannot do this for DirectSound as it requires a window handle. So right after we make sure that our <code>Window</code> is a vaild handle, we'll start initializing DirectSound. Let's simply throw in function call <code>Win32InitDSound</code>:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">if</span> (Window)</span>
<span class="line">{</span>
<span class="line">    HDC DeviceContext = GetDC(Window);</span>
<span class="line">    Win32ResizeDIBSection(&amp;GlobalBackbuffer, <span class="hljs-number">1280</span>, <span class="hljs-number">720</span>);</span><div class=" add"><span class="line">    Win32InitDSound();</span></div><span class="line"></span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;2:</b> <file>[win32_handmade.cpp > WinMain]</file> Calling <code>Win32InitDSound</code>.</div></center>
<p>


Now, we don't have <code>Win32InitDSound</code> function yet, we'll need to create it. For now it won't have any return and won't have any parameters, but we can always modify the signature later if we need it. Let' define <code>Win32InitDSound</code> right after <code>Win32LoadXInput</code>.

</p><p>

What do we need to do inside this function? Well, we'll need to:

</p><p>

<ul>
<li class="asterisk">Load the library 
<ul>
    <li class="asterisk">As with the controller, absence of sound shouldn't necessarily be showstopper
</li></ul>
<li class="asterisk">&ldquo;Create&rdquo; a DirectSound object
<ul>
    <li class="asterisk">The way DirectSound is implemented is having the so-called &ldquo;objects&rdquo;. Object model was a popular programming paradigm for Windows API for some time.
</li></ul>
<li class="asterisk">Set cooperative level
<ul>
    <li class="asterisk">We need to bind the object with our window and set up specific sound settings
</li></ul>
<li class="asterisk">&ldquo;Create&rdquo; a primary buffer
<ul>
    <li class="asterisk">At this point, this is a holdover from the time when you were writing directly to the sound card. You can't access the sound card any more, but you still need to create the primary buffer so that you can set the &ldquo;mode&rdquo; of things. 
</li>
    <li class="asterisk">We will only ever use it to set our wave format.
</li></ul>
<li class="asterisk">&ldquo;Create&rdquo; a secondary buffer
<ul>
    <li class="asterisk">This is the buffer we're going to write our samples to.
</li></ul>
<li class="asterisk">Start it playing!</li></ul>

</p><p>

We'll take care of the &ldquo;playing&rdquo; part in another call. As for the initialization, let's put our steps in the function:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">Win32LoadXInput</span><span class="hljs-params">()</span></span>
<span class="line"></span>{</span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">}</span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">Win32InitDSound</span><span class="hljs-params">()</span></span>
<span class="line"></span>{</span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): Load the library </span></span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): Create a DirectSound object </span></span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): Set cooperative level</span></span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): "Create" a primary buffer</span></span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): "Create" a secondary buffer     </span></span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;3:</b> <file>[win32_handmade.cpp]</file> Drafting <code>Win32InitDSound</code>.</div></center>
<p>


In theory, this would give us sound on Windows. 

</p><p>

You'll notice that DirectSound is not as clean as XInput, which only took us a few calls to get running, and a few more to get running without crashing. Granted, sound is more complicated than a controller with a defined button set, but still.

</p>
<a class="target" name="loadthelibrary">&nbsp;</a><a class="target" name="initializedirectsoundoverview/loadthelibrary">&nbsp;</a><a class="target" name="toc2.1">&nbsp;</a><h2>Load the Library</h2>
<p>


Loading the library is the same as we did with XInput. We try to load from a <code>.dll</code> and if we succeed we do the rest. 

</p><p>

In this case, the library we're after is called <code>dsound.dll</code>. 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-comment">// NOTE(casey): Load the library </span></span><div class=" add"><span class="line">HMODULE DSoundLibrary = LoadLibraryA(<span class="hljs-string">"dsound.dll"</span>);</span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">if</span>(DSoundLibrary)</span>
<span class="line">{</span></div><span class="line">    <span class="hljs-comment">// NOTE(casey): Create a DirectSound object </span></span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): Set cooperative level</span></span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): "Create" a primary buffer</span></span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): "Create" a secondary buffer     </span></span><div class=" add"><span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;4:</b> <file>[win32_handmade.cpp > Win32InitDSound]</file> Loading the library.</div></center>

<a class="target" name="createadirectsoundobject">&nbsp;</a><a class="target" name="initializedirectsoundoverview/createadirectsoundobject">&nbsp;</a><a class="target" name="toc2.2">&nbsp;</a><h2>Create a DirectSound Object</h2>
<p>


In order to create a DirectSound object we need to call <a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/mt708921(v=vs.85)">DirectSoundCreate</a>. Again, to avoid loading a <code>.dll</code> that the user might not have, we'll need to do the same abstraction maneuver as we did last time with the XInput functions. If you remember, we did the following for the functions we wanted to retrieve: 

</p><p>

<ol start=1>
<li class="number"><code>#define</code> a function prototype with the signature we want. 
</li>
<li class="number">Make a <code>typedef</code> of that, so that you can use it as a variable.
</li>
<li class="number">Create a stub function in case we fail to properly load the actual functions.
</li>
<li class="number">Set up a global variable for that function pointer. By default it will point to the stub function.
</li>
<li class="number"><code>#define</code> the same name as the original function for that variable.</li></ol>

</p><p>

And then, in the init code:

</p><p>

<ol start=6>
<li class="number"><code>GetProcAddress</code> of the function we're interested in, and store it in the global variable.
</li>
<li class="number">If the function pointer is not valid (i.e. <code>0</code>), revert back to the stub function.</li></ol>

</p><p>

And this will finally yield a function that we can call.

</p><p>

This would be the plan.. except it would be a bit of overkill for our purposes. We're only ever calling this function once, immediately after fetching its &ldquo;ProcAddress&rdquo;. So really, we can get rid of steps 3-5 and define the variable locally.

</p><p>

Let's look at the <a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/mt708921(v=vs.85)">DirectSoundCreate</a> function syntax:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">HRESULT WINAPI <span class="hljs-title">DirectSoundCreate</span><span class="hljs-params">(LPCGUID pcGuidDevice, LPDIRECTSOUND *ppDS, LPUNKNOWN pUnkOuter)</span></span>;</span></code></pre><center><div class="listingcaption tilde"><file>[MSDN]</file></div></center>
<p>


Let's go ahead and implement the plan above. Immediately after the analagous blocks we made for XInput, we can lay down the following: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-comment">// NOTE(yakvi): XInputSetInputState</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> X_INPUT_SET_STATE(name) DWORD WINAPI name(DWORD dwUserIndex, XINPUT_VIBRATION *pVibration)</span></span>
<span class="line"><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">X_INPUT_SET_STATE</span><span class="hljs-params">(x_input_set_state)</span></span>;</span>
<span class="line">X_INPUT_SET_STATE(XInputSetStateStub) { <span class="hljs-keyword">return</span> (ERROR_DEVICE_NOT_CONNECTED); }</span>
<span class="line">global_variable x_input_set_state *XInputSetState_ = XInputSetStateStub;</span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> XInputSetState XInputSetState_</span></span><div class=" add"><span class="line"><span class="hljs-comment">// NOTE(yakvi): DirectSoundCreate</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DIRECT_SOUND_CREATE(name) HRESULT WINAPI name(LPCGUID pcGuidDevice, LPDIRECTSOUND *ppDS, LPUNKNOWN pUnkOuter)</span></span>
<span class="line"><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">DIRECT_SOUND_CREATE</span><span class="hljs-params">(direct_sound_create)</span></span>;</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;5:</b> <file>[win32_handmade.cpp]</file> Creating function prototype.</div></center>
<p>


We then can try and load the function, and if it's loaded, try to call it. <code>DirectSoundCreate</code> takes the following parameters.

</p><p>

<ul>
<li class="asterisk"><code>pcGuidDevice</code>: The id of the sound card we're trying to open. Since we don't care which device will be outputting the sound, we'll leave it at <code>0</code>.
</li>
<li class="asterisk"><code>ppDS</code>: Pointer to the pointer to a <code>IDirectSound</code> structure. We will provide it, and the function will fill in the address of this structure, similar to what we did when we were peeking messages in our <code>WinMain</code>. 
</li>
<li class="asterisk"><code>pUnkOuter</code>: Should always be <code>0</code>.</li></ul>

</p><p>

<code>DirectSoundCreate</code> returns an <code>HRESULT</code> which must be processed with <code>SUCCEEDED</code> macro which then can return <code>true</code> or <code>false</code>. 

</p><p>

If you are confused by the above, that's totally fine. Suffice to say that we need to wrap <code>DirectSoundCreate()</code> call in <code>SUCCEEDED</code>. 

</p><p>

<div class="admonition ">As of writing, <code>SUCCEEDED</code> is defined as a check whether or not the result is greater or equal to <code>0</code>.</div>

</p><p>

We could separately check for <code>if (DirectSoundCreate)</code> and then <code>if (SUCCEEDED(DirectSoundCreate(...)))</code>, or we could do it all in one go, using logical AND operator (double <code>&amp;&amp;</code>), not to be confused with the bitwise AND (single <code>&amp;</code>)!

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-comment">// NOTE(casey): Load the library </span></span>
<span class="line"><span class="hljs-comment">// ...</span></span>
<span class="line"><span class="hljs-keyword">if</span>(DSoundLibrary)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): Get a DirectSound object </span></span><div class=" add"><span class="line">    direct_sound_create *DirectSoundCreate = (direct_sound_create*)</span>
<span class="line">                                    GetProcAddress(DSoundLibrary, <span class="hljs-string">"DirectSoundCreate"</span>);</span>
<span class="line">    IDirectSound *DirectSound;</span>
<span class="line">    <span class="hljs-keyword">if</span>(DirectSoundCreate &amp;&amp; SUCCEEDED(DirectSoundCreate(<span class="hljs-number">0</span>, &amp;DirectSound, <span class="hljs-number">0</span>)))</span>
<span class="line">    {</span></div><span class="line">        <span class="hljs-comment">// NOTE(casey): Set cooperative level</span></span>
<span class="line">        <span class="hljs-comment">// NOTE(casey): "Create" a primary buffer</span></span>
<span class="line">        <span class="hljs-comment">// NOTE(casey): "Create" a secondary buffer         </span></span><div class=" add"><span class="line">    }</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;6:</b> <file>[win32_handmade.cpp > Win32InitDSound]</file> Getting a DirectSound Object.</div></center>

<a class="target" name="setcooperativelevel">&nbsp;</a><a class="target" name="initializedirectsoundoverview/setcooperativelevel">&nbsp;</a><a class="target" name="toc2.3">&nbsp;</a><h2>Set Cooperative Level</h2>
<p>


We now need to configure the DirectSound &ldquo;object&rdquo; we've got. This is enabled by setting its &ldquo;cooperative level&rdquo;. 

</p><p>

The function we're going to call is called <a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/mt708948(v=vs.85)">SetCooperativeLevel</a>. However, we aren't calling it from Windows directly. Instead, the pointer to this function is stored inside our <code>DirectSound</code>. The call takes the following parameters: 

</p><p>

<ul>
<li class="asterisk"><code>hwnd</code>: Handle to our window
</li>
<li class="asterisk"><code>dwLevel</code>: Priority level we request. Since we'd like to set up custom sound format, we need to set <code>DSSCL_PRIORITY</code>.</li></ul>

</p><p>

Again, we'll need to check whether we <code>SUCCEDEED</code> in our call. If we do, we aren't going to actually set any settings just yet. We'll return to it in our next lesson, for now let's add a todo. 

</p><pre class="listing tilde"><code><span class="line">direct_sound_create *DirectSoundCreate = (direct_sound_create*)</span>
<span class="line">                                GetProcAddress(DSoundLibrary, <span class="hljs-string">"DirectSoundCreate"</span>);</span>
<span class="line">IDirectSound *DirectSound;</span>
<span class="line"><span class="hljs-keyword">if</span>(DirectSoundCreate &amp;&amp; SUCCEEDED(DirectSoundCreate(<span class="hljs-number">0</span>, &amp;DirectSound, <span class="hljs-number">0</span>)))</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): Set cooperative level</span></span><div class=" add"><span class="line">    <span class="hljs-keyword">if</span> (SUCCEEDED(DirectSound-&gt;SetCooperativeLevel(Window, DSSCL_PRIORITY)))</span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// NOTE(casey): "Create" a primary buffer</span></span>
<span class="line">    }</span></div><span class="line">    <span class="hljs-comment">// NOTE(casey): "Create" a secondary buffer     </span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;7:</b> <file>[win32_handmade.cpp > Win32InitDSound]</file> Setting Cooperative Level.</div></center>

<a class="target" name="createaprimarybuffer">&nbsp;</a><a class="target" name="initializedirectsoundoverview/createaprimarybuffer">&nbsp;</a><a class="target" name="toc2.4">&nbsp;</a><h2>Create a Primary Buffer</h2>
<p>


Next, we're going to call <a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/mt708943(v=vs.85)">CreateSoundBuffer</a> to get our primary buffer. As a reminder, initially this was supposed to be the actual buffer on the sound card. Now, it will simply provide us a pointer to <code>DirectSoundBuffer</code> &ldquo;object&rdquo; from which our audio samples will be read. We want to set up a primary buffer explicitly because we'll thus make sure that our audio is not upsampled or downsampled by the system. It probably won't do much on newer operating systems but we'll do it just in case anyway.

</p><p>

<code>CreateSoundBuffer</code> takes the following parameters:

</p><p>

<ul>
<li class="asterisk"><code>lpcDSBufferDesc</code>: A pointer to the <a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/ee416820(v=vs.85)">DSBUFFERDESC</a> structure.
</li>
<li class="asterisk"><code>lplpDirectSoundBuffer</code>: A pointer to the pointer to an <code>IDirectSoundBuffer</code> object.
</li>
<li class="asterisk"><code>pUnkOuter</code>: We must pass <code>0</code> here</li></ul>

</p><p>

You'll notice that the parameters are almost identical to <code>DirectSoundCreate</code>. The latter two shouldn't present any problem, let's look better at the <code>DSBUFFERDESC</code> structure in a second.

</p><p>

Again, this should be wrapped inside <code>SUCCEEDED</code> macro, and again, it's the function that we call from <code>DirectSound</code> &ldquo;object&rdquo;. 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-comment">// NOTE(casey): Set cooperative level</span></span>
<span class="line"><span class="hljs-keyword">if</span> (SUCCEEDED(DirectSound-&gt;SetCooperativeLevel(Window, DSSCL_PRIORITY)))</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): "Create" a primary buffer</span></span><div class=" add"><span class="line">    DSBUFFERDESC BufferDescription = ; </span>
<span class="line"></span>
<span class="line">    IDirectSoundBuffer *PrimaryBuffer; </span>
<span class="line">    <span class="hljs-keyword">if</span>(SUCCEEDED(DirectSound-&gt;CreateSoundBuffer(&amp;BufferDescription, &amp;PrimaryBuffer, <span class="hljs-number">0</span>)))</span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// Set up primary buffer</span></span>
<span class="line">    }</span></div><span class="line">}</span>
<span class="line"><span class="hljs-comment">// NOTE(casey): "Create" a secondary buffer </span></span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;8:</b> <file>[win32_handmade.cpp > Win32InitDSound]</file> Creating primary buffer.</div></center>
<p>


Now, back to our <code>DSBUFFERDESC</code> structure. 

</p><p>

First thing of note is that it must be cleared to zero, whatever its size it. We already did it in the past, using <code>= {}</code>, so let's do it here as well. 

</p><p>

<a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/ee416820(v=vs.85)">Let's see</a> what else we need to set: 

</p><p>

<ul>
<li class="asterisk"><code>dwSize</code>: The size of the whole <code>DSBUFFERDESC</code> structure. We set it to <code>sizeof(BufferDescription)</code>.
</li>
<li class="asterisk"><code>dwFlags</code>: a bit field. Acceptable flags are specified <a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/ee416818(v=vs.85)">here</a>. Of all listed we might potentially need <code>DSBCAPS_GLOBALFOCUS</code>, but we definitely need <code>DSBCAPS_PRIMARYBUFFER</code> since it identifies the buffer as primary. 
</li>
<li class="asterisk"><code>dwBufferSize</code>: The size of the buffer that we're interested in, in bytes. Usually this would be where we specify the size, but since it's a primary buffer we pass <code>0</code>. 
<ul>
    <li class="asterisk">Since we're on the topic, let's quickly think about the secondary buffer size. While this should be a straightforward calculation, we can make this part even simpler: whoever calls <code>Win32InitDSound</code>, decides what the desired buffer size is. 
</li></ul>
<li class="asterisk"><code>dwReserved</code>: Pass <code>0</code>
</li>
<li class="asterisk"><code>lpwfxFormat</code>: Pass <code>0</code> if it's a primary buffer... 
</li>
<li class="asterisk"><code>guid3DAlgorithm</code>: settings for 3d sound emulation. we don't need it, so pass <code>0</code> to it as well.</li></ul>

</p><p>

Since all the fields are cleared to zero using <code>= {}</code>, this leaves us with only two settings that we need to set ourselves:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">if</span> (SUCCEEDED(DirectSound-&gt;SetCooperativeLevel(Window, DSSCL_PRIORITY)))</span>
<span class="line">{  </span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): "Create" a primary buffer</span></span><div class=" edit"><span class="line">    DSBUFFERDESC BufferDescription = {};</span></div><div class=" add"><span class="line">    BufferDescription.dwSize = <span class="hljs-keyword">sizeof</span>(BufferDescription);</span>
<span class="line">    BufferDescription.dwFlags = DSBCAPS_PRIMARYBUFFER;</span></div><span class="line">    IDirectSoundBuffer *PrimaryBuffer;</span>
<span class="line">    <span class="hljs-keyword">if</span>(SUCCEEDED(DirectSound-&gt;CreateSoundBuffer(&amp;BufferDescription, &amp;PrimaryBuffer, <span class="hljs-number">0</span>)))</span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// Set up primary buffer</span></span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"><span class="hljs-comment">// NOTE(casey): "Create" a secondary buffer</span></span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;9:</b> <file>[win32_handmade.cpp > Win32InitDSound]</file> Specifying buffer description.</div></center>
<p>


We're still not out of the woods yet. In order to finalize our primary buffer setup, we need to set the wave format using the <a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/mt708936(v=vs.85)">SetFormat</a> function. This function is a bit different, in that it's called from the buffer instead of <code>DirectSound</code>. 

</p><p>

As its only parameter, <code>SetFormat</code> takes a pointer to a <a href="https://docs.microsoft.com/en-us/windows/win32/api/mmeapi/ns-mmeapi-waveformatex">WAVEFORMATEX</a> structure. It has the following syntax: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tWAVEFORMATEX</span> {</span></span>
<span class="line">  WORD  wFormatTag;</span>
<span class="line">  WORD  nChannels;</span>
<span class="line">  DWORD nSamplesPerSec;</span>
<span class="line">  DWORD nAvgBytesPerSec;</span>
<span class="line">  WORD  nBlockAlign;</span>
<span class="line">  WORD  wBitsPerSample;</span>
<span class="line">  WORD  cbSize;</span>
<span class="line">} WAVEFORMATEX, *PWAVEFORMATEX, *NPWAVEFORMATEX, *LPWAVEFORMATEX;</span></code></pre><center><div class="listingcaption tilde"><file>[MSDN]</file> <code>WAVEFORMATEX</code> structure.</div></center>
<p>


Unfortunately, this structure has the members which depend upon each other, so it's imperative that we set them in a different order from how they appear here.

</p><p>

<ul>
<li class="asterisk"><code>wFormatTag</code>: The format of the waveform-audio. We're going to be working with the PCM method (i.e. Pulse-Code Modulation), so the format tag would be <code>WAVE_FORMAT_PCM</code>. 
</li>
<li class="asterisk"><code>nChannels</code>: We want stereo sound, so we pass <code>2</code>. 
</li>
<li class="asterisk"><code>nSamplesPerSecond</code>: We're going to have it passed as a parameter to our function
</li>
<li class="asterisk"><code>wBitsPerSample</code>: We want <code>16</code> bits per sample (CD quality), so that's what we're going to pass. 
</li>
<li class="asterisk"><code>nBlockAlign</code>: How many <em class="underscore">bytes</em> are there per <em class="underscore">unit</em> of samples. 
<ul>
    <li class="asterisk">Since we pass two channels in Left-Right sequence, we can simply compute <code>nChannels</code> times <code>wBitsPerSample</code>, divided by the number of bits in a byte (8). 
</li></ul>
<li class="asterisk"><code>nAvgBytesPerSec</code>: How many <em class="underscore">bytes</em> will the samples occupy in one second. We can calculate it by multiplying <code>nSamplesPerSecond</code> for <code>nBlockAlign</code>. 
</li>
<li class="asterisk"><code>cbSize</code>: Size of any extra information we might want to pass. We don't have any, so just leave it at <code>0</code>.</li></ul>

</p><p>

Pay attention at the order these things are defined! Make sure you don't use things before actually defining them. Compiler will not complain, but your sound will not be what you expect it to be.

</p><p>

<div class="admonition tip">If you're creating an API, don't do this. When designing an API, you want to avoid creating structures that should be filled in order, or with elements which depend on each other, as well as usage of uninitialized member variables.

</p><p>

    Take for instance <code>nBlockAlign</code>. This information is redundant as you can easily calculate this value inside your call directly, without introducing a potential failure point for the user, if they forgets to initialize the dependant values first. 

</p><p>

    If you really have to do this, you want the variables to be initialized in the same order they are are positioned on the struct. Help the user succeed and prevent bugs for them!

</p><p>

    Set the users up for success, don't set them up for failure.

</p><p>

    We mentioned &ldquo;API&rdquo; a lot. If you're unfamiliar what exactly this means, head over to subsection  <a href="#toc6.1">6.1</a>.</div>

</p><p>

Since we'll use it for both of our buffers, we can place the <code>WAVEFORMATEX</code> structure outside, right after we get our <code>DirectSound</code> &ldquo;object&rdquo;.

</p><p>

Finally, we call <code>SetFormat</code> function and, after we've done everything, our function will look roughly in the following way:

</p><pre class="listing tilde"><code><span class="line">internal <span class="hljs-keyword">void</span></span><div class=" edit"><span class="line">Win32InitDSound(HWND Window, s32 SamplesPerSecond, s32 BufferSize)</span></div><div class=" C++ "><span class="line">{</span>
<span class="line">    // NOTE(casey): Load the library</span>
<span class="line">    HMODULE DSoundLibrary = LoadLibraryA("dsound.dll");</span>
<span class="line">    if(DSoundLibrary)</span>
<span class="line">    {</span>
<span class="line">        // NOTE(casey): Get a DirectSound object</span>
<span class="line">        direct_sound_create *DirectSoundCreate = (direct_sound_create*)GetProcAddress(DSoundLibrary, "DirectSoundCreate");</span>
<span class="line">        IDirectSound *DirectSound;</span>
<span class="line">        if(DirectSoundCreate &amp;&amp; SUCCEEDED(DirectSoundCreate(0, &amp;DirectSound, 0)))</span>
<span class="line">        {</span></div><div class=" add"><span class="line">            WAVEFORMATEX WaveFormat = {};</span>
<span class="line">            WaveFormat.wFormatTag = WAVE_FORMAT_PCM;</span>
<span class="line">            WaveFormat.nChannels = <span class="hljs-number">2</span>;</span>
<span class="line">            WaveFormat.nSamplesPerSec = SamplesPerSecond;</span>
<span class="line">            WaveFormat.wBitsPerSample = <span class="hljs-number">16</span>;</span>
<span class="line">            WaveFormat.nBlockAlign = (WaveFormat.nChannels * WaveFormat.wBitsPerSample) / <span class="hljs-number">8</span>; <span class="hljs-comment">// 4 under current settings</span></span>
<span class="line">            WaveFormat.nAvgBytesPerSec = WaveFormat.nSamplesPerSec * WaveFormat.nBlockAlign;</span></div><span class="line"></span>
<span class="line">            if (SUCCEEDED(DirectSound-&gt;SetCooperativeLevel(Window, DSSCL_PRIORITY)))</span>
<span class="line">            {</span>
<span class="line">                // NOTE(casey): "Create" a primary buffer</span>
<span class="line">                DSBUFFERDESC BufferDescription = {};</span>
<span class="line">                BufferDescription.dwSize = sizeof(BufferDescription);</span>
<span class="line">                BufferDescription.dwFlags = DSBCAPS_PRIMARYBUFFER;</span>
<span class="line">                </span>
<span class="line">                IDirectSoundBuffer *PrimaryBuffer;</span>
<span class="line">                if(SUCCEEDED(DirectSound-&gt;CreateSoundBuffer(&amp;BufferDescription, &amp;PrimaryBuffer, 0)))</span>
<span class="line">                {</span><div class=" add"><span class="line">                    <span class="hljs-keyword">if</span> (SUCCEEDED(PrimaryBuffer-&gt;SetFormat(&amp;WaveFormat)))</span>
<span class="line">                    {</span>
<span class="line">                        <span class="hljs-comment">// NOTE(casey): We have finally set the format of the primary buffer!</span></span>
<span class="line">                    }</span></div><span class="line">                }</span>
<span class="line">            }</span>
<span class="line">            <span class="hljs-comment">// NOTE(casey): "Create" a secondary buffer</span></span>
<span class="line">            </span>
<span class="line">        }</span>
<span class="line">    }</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;10:</b> <file>[win32_handmade.cpp]</file> Specifying buffer description.</div></center>

<a class="target" name="createasecondarybuffer">&nbsp;</a><a class="target" name="initializedirectsoundoverview/createasecondarybuffer">&nbsp;</a><a class="target" name="toc2.5">&nbsp;</a><h2>Create a Secondary Buffer</h2>
<p>


Last step for <code>Win32InitDSound</code> before we can play the sound is to set up secondary buffer. We'll need to fill out a new <code>BufferDescription</code> and pass a few more parameters to it, but largely the process remains the same. We'll use the secondary buffer to write the sound samples. 

</p><p>

The code for the secondary buffer remains largely the same as for the primary buffer, we'll only need to have a different buffer description. 

</p><p>

<ul>
<li class="asterisk"><code>dwFlags</code>: since we don't really need anything, we'll just leave it at <code>0</code>.
</li>
<li class="asterisk"><code>dwBufferBytes</code>: <code>BufferSize</code> that we'll be getting from whoever calls this function.
</li>
<li class="asterisk"><code>lpwfxFormat</code>: We don't need to set format of our wave again, we can use the one we have already, so simply pass pass the address to <code>WaveFormat</code> here.</li></ul>

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">if</span> (SUCCEEDED(DirectSound-&gt;SetCooperativeLevel(Window, DSSCL_PRIORITY)))</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">}</span><div class=" add"><span class="line"><span class="hljs-comment">// NOTE(casey): "Create" a secondary buffer</span></span>
<span class="line">DSBUFFERDESC BufferDescription = {};</span>
<span class="line">BufferDescription.dwSize = <span class="hljs-keyword">sizeof</span>(BufferDescription);      </span>
<span class="line">BufferDescription.dwBufferBytes = BufferSize;</span>
<span class="line">BufferDescription.lpwfxFormat = &amp;WaveFormat;</span>
<span class="line"></span>
<span class="line">IDirectSoundBuffer *SecondaryBuffer;</span>
<span class="line"><span class="hljs-keyword">if</span>(SUCCEEDED(DirectSound-&gt;CreateSoundBuffer(&amp;BufferDescription, &amp;SecondaryBuffer, <span class="hljs-number">0</span>)))</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): All good, secondary buffer works as intended</span></span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;11:</b> <file>[win32_handmade.cpp]</file> Creating Secondary Buffer.</div></center>
<p>




<div class="admonition note"><div class="admonition-title"> Failure diagnostics</div>

</p><p>

    You'll notice we check quite a few times for <code>SUCCEEDED</code> so far. But what if you don't succeed? Usually there would be some sort of logging system in place reporting error messages. Currently we don't have any diagnostics system in place, but we might as well leave a few TODO's for the future. We leave it as the exercise for the reader.

</p><p>

    You'll quickly notice that there're many potential failure points. In a good API, you aim to reduce the failure points as much as possible, so this is something you can keep in mind for the future.</div>

</p><p>

As a final touch, let's print out a diagnostic just to see that the Primary and Secondary buffers are up and running:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">if</span> (SUCCEEDED(PrimaryBuffer-&gt;SetFormat(&amp;WaveFormat)))</span>
<span class="line">{</span><div class=" add"><span class="line">    OutputDebugStringA(<span class="hljs-string">"Primary buffer format was set.\n"</span>);</span></div><span class="line">}</span>
<span class="line"><span class="hljs-comment">// ... </span></span>
<span class="line"><span class="hljs-keyword">if</span>(SUCCEEDED(DirectSound-&gt;CreateSoundBuffer(&amp;BufferDescription, &amp;SecondaryBuffer, <span class="hljs-number">0</span>)))</span>
<span class="line">{</span><div class=" add"><span class="line">    OutputDebugStringA(<span class="hljs-string">"Secondary buffer created Successfully.\n"</span>);</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;12:</b> <file>[win32_handmade.cpp > Win32InitDSound]</file> Adding a couple debug strings.</div></center>
<p>


If you try to compile now, the compiler should let you know that you're missing parameters in your <code>Win32InitDSound</code> call. Let's fix that. 

</p><p>

<ul>
<li class="asterisk"><code>Window</code>: Pass the handle to our <code>Window</code>. 
</li>
<li class="asterisk"><code>SamplesPerSecond</code>: We've said that we want 48000 Hz frequency, so we'll pass just that. 
<ul>
    <li class="asterisk">For clarity, we'll extract it to <code>SamplesPerSecond</code> variable.
</li></ul>
<li class="asterisk"><code>BufferSize</code>: We said that we wanted a two second <code>BufferSize</code>. Since we said we wanted 16-bit samples (<code>sizeof(s16)</code>), playing in <code>2</code> channels, for <code>2</code> seconds, on <code>48000</code> frequency, the size should be the multiple all this mulitiplied together. 
<ul>
    <li class="asterisk">Let's extract part of it to the <code>BytesPerSample</code> and <code>SecondaryBufferSize</code> variables, again for clarity.</li></ul></li></ul>

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">if</span> (Window)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-keyword">int</span> XOffset = <span class="hljs-number">0</span>;</span>
<span class="line">    <span class="hljs-keyword">int</span> YOffset = <span class="hljs-number">0</span>;</span><div class=" add"><span class="line">    <span class="hljs-keyword">int</span> SamplesPerSecond = <span class="hljs-number">48000</span>;</span>
<span class="line">    <span class="hljs-keyword">int</span> BytesPerSample = <span class="hljs-keyword">sizeof</span>(s16) * <span class="hljs-number">2</span>;</span>
<span class="line">    <span class="hljs-keyword">int</span> SecondaryBufferSize = <span class="hljs-number">2</span> * SamplesPerSecond * BytesPerSample;</span>
<span class="line">    </span>
<span class="line">    Win32InitDSound(Window, SamplesPerSecond, SecondaryBufferSize);</span></div><span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;13:</b> <file>[win32_handmade.cpp > WinMain]</file> Updating <code>Win32InitDSound</code> call.</div></center>
<p>


Now, compile, run and make sure your implementation works correctly. Step into the code and make sure the values are valid. Verify that the Output messages are printed out as intended, and you're good to go.

</p>
<a class="target" name="deepdive:directsoundobjects">&nbsp;</a><a class="target" name="deepdive:directsoundobjects">&nbsp;</a><a class="target" name="toc3">&nbsp;</a><h1>Deep Dive: DirectSound Objects</h1>
<p>


We said at the beginning that DirectSound works as an object. We never called it an object because it doesn't use C++ object programming models. Instead, it implements something called &ldquo;COM Interface&rdquo;. 

</p><p>

When we call into <code>DirectSoundCreate</code> what we really get is an object with a Virtual Function Table, or <em class="underscore">vtable</em> for short. Vtables are usually something one associates with C++, and we won't be covering much of that. But a short introduction is in place to understand what really goes on here. 

</p>
<a class="target" name="methods">&nbsp;</a><a class="target" name="deepdive:directsoundobjects/methods">&nbsp;</a><a class="target" name="toc3.1">&nbsp;</a><h2>Methods</h2>
<p>


Normally, if you define a struct, you simply put some data in it: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">some_struct</span></span>
<span class="line">{</span></span>
<span class="line">    s32 X;</span>
<span class="line">    s16 Y;</span>
<span class="line">};</span>
<span class="line"></span>
<span class="line"><span class="hljs-comment">// ...</span></span>
<span class="line"></span>
<span class="line">some_struct Foo;</span>
<span class="line">Foo.x = <span class="hljs-number">0</span>; etc.</span></code></pre><p>

This signals to the compiler that it needs to prepare some memory. The things that are in the struct will come together (possibly with some padding in between them) in the order in which the occur and in the sizes that they occur. In the example above, we have a 64-byte struct: 32 bits for <code>X</code>, 16 bits for <code>Y</code> and 16 bits for padding (so that the memory is aligned to 4-byte boundary).

</p><p>

C++ allows you to do some other things inside a struct. For instance, you can do a <em class="underscore">method declaration</em> inside the struct as follows: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">some_struct</span></span>
<span class="line">{</span></span>
<span class="line">    s32 X;</span>
<span class="line">    s16 Y;</span>
<span class="line"></span><div class=" add"><span class="line">    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DoSomething</span><span class="hljs-params">()</span></span>;</span></div><span class="line">};</span></code></pre><p>

This would enable you to call that function (which in this context is called &ldquo;method&rdquo;) in the same way you access another piece of data (e.g. our <code>Foo</code> could make a call <code>Foo.DoSomething()</code>). It works as any function: you can pass parameters to it, return values, etc. Let's, for example, add an <code>int C</code> parameter to it.

</p><p>

The only difference would be syntactic: instead of defining a function as we usually did, you'll need to use the &ldquo;scoping operator&rdquo; <code>::</code>.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">some_struct</span></span>
<span class="line">{</span></span>
<span class="line">    s32 X;</span>
<span class="line">    s16 Y;</span>
<span class="line"></span><div class=" edit"><span class="line">    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DoSomething</span><span class="hljs-params">(<span class="hljs-keyword">int</span> C)</span></span>;</span></div><span class="line">};</span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">void</span> some_struct::</span>
<span class="line">DoSomething(<span class="hljs-keyword">int</span> C)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// function definiton...</span></span>
<span class="line">}</span></code></pre><p>

Thus the function, instead of being declared at the file scope, is declared in the <code>some_struct</code> object. So you can't just call it like <code>DoSomething</code>, you should always call it from one of its &ldquo;instances&rdquo;. 

</p><p>

Under the hood, compiler rewrites this function. Among other things, the compiler will insert a pointer to the struct which contains the function. The actual signature would be thus <code>void some_struct::DoSomething(some_struct *this, int C)</code>. <code>this</code> pointer will be used to reference anything that implicitly happens within the method. So like in a normal function, you can reference <code>C</code>, initialize new variables normally... but if you reference, for instance, <code>X</code>, compiler would automatically convert it to <code>this-&gt;X</code>. In any other function, <code>X</code> would be undefined, but since we declared it in our <code>some_struct</code>, we can reference it in our method. 

</p><p>

There a few other differences (again, totally syntactic) which we'll not dive deeper into since we'll not be using these. However what we described above is key to understanding what's happening with DirectSound here, as well as how the COM interfaces work in general.

</p>
<a class="target" name="virtualfunctiontables">&nbsp;</a><a class="target" name="deepdive:directsoundobjects/virtualfunctiontables">&nbsp;</a><a class="target" name="toc3.2">&nbsp;</a><h2>Virtual Function Tables</h2>
<p>


If we go one step further, we can declare our <code>DoSomething</code> method as <code>virtual</code>:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">some_struct</span></span>
<span class="line">{</span></span>
<span class="line">    s32 X;</span>
<span class="line">    s16 Y;</span>
<span class="line"></span><div class=" edit"><span class="line">    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DoSomething</span><span class="hljs-params">(<span class="hljs-keyword">int</span> C)</span></span>;</span></div><span class="line">};</span></code></pre><p>

Suddenly, <code>DoSomething</code> becomes more complicated than a regular function or even method. It's not just a syntactic thing any more, there's more than that. When compiler sees <code>virtual</code> keyword, it will insert something called &ldquo;vtable pointer&rdquo; at the top of the struct definition. At the same time, outside of the <code>some_struct</code> the compiler will create a <em class="underscore">virtual function table</em>, or <em class="underscore">vtable</em> for <code>some_struct</code>. 

</p><p>

The vtable contains several function pointers that should be called when you are using <code>some_struct</code>. So now, when you call <code>Foo.DoSomething()</code>, the program will <em class="underscore">look up</em> the address to <code>DoSomething</code> inside the vtable: 

</p><p>

<ol start=1>
<li class="number">Get the pointer on top of <code>some_struct</code> (that the compiler silently inserted)
</li>
<li class="number">Access the vtable for <code>some_struct</code>. 
</li>
<li class="number">Look at the index of vtable to which <code>DoSomething</code> corresponds. 
</li>
<li class="number">Jump to the address <code>DoSomething</code> points to. 
</li>
<li class="number">Actually call <code>DoSomething</code>.</li></ol>

</p><p>

Sounds familiar? It's pretty much what we did when we were loading XInput functions. We declared our own function pointers, assigned variables and jumped to them, so that we could call them. virtual functions work in a same manner except that, instead of single global pointers, there're global <em class="underscore">tables</em> (one per struct using virtual functions), and the only way to access the correct table is to look up the pointer inside the struct pointing to them. 

</p><p>

If it sounds complicated and a lot of extra work, it's because it is. There's double indirection going on here before the final dispatch. This leads to the fact that virtual functions come at a cost in performance which sometimes might be critical. Of course, this cost might vary based on how the compiler optimizes all this, but it's still much different than calling a regular function or method. It's not a &ldquo;zero-cost abstraction&rdquo;. 

</p>
<a class="target" name="cominterfaces">&nbsp;</a><a class="target" name="deepdive:directsoundobjects/cominterfaces">&nbsp;</a><a class="target" name="toc3.3">&nbsp;</a><h2>COM Interfaces</h2>
<p>


<b>C</b>omponent <b>O</b>bject <b>M</b>odel, or COM, is a &ldquo;binary interface&rdquo; standard introduced by Microsoft in the early '90s. What it does is just implementing <em class="underscore">vtables</em>.

</p><p>

When calling into <code>DirectSoundCreate</code>, it will return us an object with that vtable <em class="underscore">in it</em>. That's why we only had to use <code>GetProcAddress</code> only once: all the functions are already defined by windows and packaged in these objects, in a non dissimilar way from how we approached it ourselves. This allows us calling the functions off the actual objects that we got back, and the vtable allows us to call these functions. 

</p><p>

Now, where exactly is this vtable located in memory? It actually got mapped in memory when we loaded the <code>dsound.dll</code>! So the <code>.dll</code> itself had a vtable in it when it got loaded, and we're pointing to it from our <code>DirectSound</code> object, calling from that jump table inside the object.

</p>
<a class="target" name="deepdiveintothedisassembly">&nbsp;</a><a class="target" name="deepdive:directsoundobjects/deepdiveintothedisassembly">&nbsp;</a><a class="target" name="toc3.4">&nbsp;</a><h2>Deep Dive into the Disassembly</h2>
<p>


Let's go inside the debugger to see what's going on. It doesn't really matter what language you program in: CPU has to do everything, so no matter how fancy stuff looks to the language, CPU will have to do whatever work is required to make that happen. Languages sometimes make things simpler to the programmer but not necessarily to the CPU. 

</p><p>

<ol start=1>
<li class="number">Set a breakpoint on a call of a function we've defined and start debugging.
</li>
<li class="number">Once the breakpoint hits, open Disassembly. 
<ul>
    <li class="asterisk">In Visual Studio, you can right-click the line and select &ldquo;Go to Disassembly&rdquo; or press <code>Alt-G</code>.</li></ul></li></ol>

</p><p>

<center><div class="image" style=""><a href="../media/day7/disassembly.jpg" target="_blank"><img class="markdeep" src="../media/day7/disassembly.jpg" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;4:</b> Accessing Disassembly window in Visual Studio.</span></center></div></center>

</p><p>

You will see the <code>Disassembly</code> window. It might look complicated at first but it simply represents all the machine code that each line of your code generates. There's the <em class="underscore">instruction</em> address, the actual instruction (<code>mov</code>, <code>push</code>, <code>call</code>, etc.), and the parameters passed to the processor with that instruction. These can be addresses, <em class="underscore">memory registers</em>, raw values. You can further customize your Disassembly experience by right-clicking anywhere on disassembly and enabling or disabling the flags of your choice. 

</p><p>

Anyway, back to our function. If you look, for instance, at <code>Win32LoadXInput</code>, you will notice that our call corresponds to one instruction: a direct <code>call</code> of our function. It was the linker that, during the linking phase of compiler, put the address of the function directly in the code. Once we step into it, we go straight in our function. 

</p><p>

Now, every time you use a virtual function, you're incurring in much more overhead than that. If you set a breakpoint at <code>DirectSound-&gt;SetCooperativeLevel</code> call and inspect the Disassembly, you will see that it generated a more instructions. 

</p><p>

<ul>
<li class="asterisk"><code>mov rax, ptr [some memory location]</code>: First indirection, load <code>DirectSound</code>.
</li>
<li class="asterisk"><code>mov rax, ptr [rax]</code>: Second indirection, load the vtable.
</li>
<li class="asterisk"><code>mov r8d, 2</code>: Start packing the parameters (probably?)
</li>
<li class="asterisk"><code>mov rdx, ptr [Window]</code>: set register <code>rdx</code> to the value of our <code>Window</code> pointer.
</li>
<li class="asterisk"><code>mov rcx, ptr [some memory location]</code>: set register <code>rcx</code> to probably the <code>DSSCL_PRIORITY</code>'s value.
</li>
<li class="asterisk"><code>call ptr [rax]</code>: Call <code>SetCooperativeLevel</code> function pointer from the vtable.
</li>
<li class="asterisk"><code>test</code>, <code>jl</code>: test for <code>SUCCEEDED</code> and skip to another part of code if the result is <code>false</code>.</li></ul>

</p><p>

You don't really have to be an expert in the assembly language to see that it's more work than our simply function call. Sure, there're additional things like loading the parameters into the registers and testing for the result, but even the call itself goes through three steps before it actually happens. Maybe in the optimized mode these instructions would be simplified, but that is the idea. 

</p>
<a class="target" name="recap">&nbsp;</a><a class="target" name="recap">&nbsp;</a><a class="target" name="toc4">&nbsp;</a><h1>Recap</h1>
<p>


DirectSound is not a great API. However, in your programming life you will encounter all sorts of API. Some will be good, others not so much. You'll need to learn to read, understand and implement documentation. But even still, you can fit the whole function on one screen. It's not that many lines of code, and once you're done with it, you're done. 

</p><p>

Sure, writing platform code takes a couple weeks of work, but you shouldn't be afraid of doing it. The benefits of being able to quickly maintain it moving forwards are immense. 

</p><p>

Today, we've laid foundation for our sound processing. Even if we can't reproduce any sounds yet, we have DirectSound initialization out of the way. Tomorrow, we'll try to output some basic sounds using it.

</p>
<a class="target" name="exercises">&nbsp;</a><a class="target" name="exercises">&nbsp;</a><a class="target" name="toc5">&nbsp;</a><h1>Exercises</h1>

<a class="target" name="readonotheraudioapis">&nbsp;</a><a class="target" name="exercises/readonotheraudioapis">&nbsp;</a><a class="target" name="toc5.1">&nbsp;</a><h2>Read on Other Audio APIs</h2>
<p>


As we said, DirectSound is an old API. Newer API are avaialable to do the same job. Read more about them here:

</p><p>

<ul>
<li class="asterisk"><a href="https://docs.microsoft.com/en-us/windows/win32/coreaudio">Core Audio API</a>.
</li>
<li class="asterisk"><a href="https://docs.microsoft.com/en-us/windows/win32/api/mmeapi/">Multimedia API</a>.
</li>
<li class="asterisk"><a href="https://docs.microsoft.com/en-us/windows/win32/xaudio2/xaudio2-introduction">XAudio2 API</a>.</li></ul>

</p>
<a class="target" name="implementanotheraudioapi">&nbsp;</a><a class="target" name="exercises/implementanotheraudioapi">&nbsp;</a><a class="target" name="toc5.2">&nbsp;</a><h2>Implement Another Audio API</h2>
<p>


Pick one of the above and try to implement the same code that we did (audio system initialization) in that system. 

</p>
<a class="target" name="programmingnotions">&nbsp;</a><a class="target" name="programmingnotions">&nbsp;</a><a class="target" name="toc6">&nbsp;</a><h1>Programming Notions</h1>

<a class="target" name="api">&nbsp;</a><a class="target" name="programmingnotions/api">&nbsp;</a><a class="target" name="toc6.1">&nbsp;</a><h2>API</h2>
<p>


The acronym &ldquo;API&rdquo; literally stands for <b>A</b>pplication <b>P</b>rogramming <b>I</b>nterface. It can be used between different parts of the same program, between different programs, even between different operating systems and computers. 

</p><p>

If we talk about one program, you can imagine an API as a point of contact between clearly distinct different parts of code, <em class="underscore">modules</em>, where one side is the producer, and the other is the consumer. In some cases, both sides exchange the roles of producer and consumer. 

</p><p>

We've seen quite a few Windows API already: <code>Win32</code> API allows creation of windows and handling of messages, <code>GDI</code> permits device-independent handling of graphics, <code>Memory</code> takes care of, well, memory. <code>XInput</code>, <code>DirectSound</code>... and so on. These are sets of functions, structures, workflows that you must follow if you want to achieve your goals. 

</p><p>

We've also seen that not all API are created equal. Some allow a much bigger degree of freedom for the user, while the others are much more concise (and, in some ways, restrictive). Some introduce multiple failure points while the others have only a couple of things that can fail. Some follow very strict procedures while the others only are a couple function calls. 

</p><p>

An important part of every API is its documentation. So far we've only seen <code>MSDN</code> as the documentation source, but for each API there should be some docs teaching a potential user how to use it.

</p><p>

When we'll get to designing our API, several objectives might be pursued: to <em class="underscore">expose</em> some specific functionality (provide a way to access something that's normally closed), to <em class="underscore">simplify</em> something, or to <em class="underscore">communicate</em>. 

</p><p>

We'll strive to have as little in the way as possible. An ideal API is only one struct to be filled out by the user; can we achieve that?

</p><p>

<em class="underscore">(Continue to subsection  <a href="#toc2.5">2.5</a>)</em>

</p>
<a class="target" name="sideconsiderations">&nbsp;</a><a class="target" name="sideconsiderations">&nbsp;</a><a class="target" name="toc7">&nbsp;</a><h1>Side Considerations</h1>

<a class="target" name="aboutgameoptimization">&nbsp;</a><a class="target" name="sideconsiderations/aboutgameoptimization">&nbsp;</a><a class="target" name="toc7.1">&nbsp;</a><h2>About Game Optimization</h2>
<p>


In game development, game optimization matters <em class="underscore">a lot</em>. It's either you optimize your game, or you write on top of the game engine that was optimized for you. 

</p><p>

If you try to run the original &ldquo;Binding of Isaac&rdquo; (when it was the Flash game), it will still struggle on the laptop. This is because it was built on top of something that wasn't optimized to be a game engine. 

</p><p>

You really should care about optimization. Of course, some code doesn't have to be optimized, but it should be executed fast enough to not create <em class="underscore">bottlenecks</em>. And while things like graphics and sound should always be optimized, sometimes even higher level game code can be responsible for the slowdowns.

</p>
<a class="target" name="navigation">&nbsp;</a><a class="target" name="navigation">&nbsp;</a><a class="target" name="toc8">&nbsp;</a><h1>Navigation</h1>
<p>


Previous: <a href="day6.html">Day 6. Gamepad and Keyboard Input</a>

</p><p>

Up Next: <a href="day8.html">Day 8. Writing a Square Wave to DirectSound</a>

</p><p>

<a href="../index.md.html">Back to Index</a>

</p>
<div class="nonumberh1">Glossary</div>
<p>


<ul>
<li class="asterisk">API
</li>
<li class="asterisk">COM interface
</li>
<li class="asterisk">Vtable
</li>
<li class="asterisk">Methods</li></ul>

</p>
<div class="nonumberh1">References</div>

<div class="nonumberh1">Articles</div>
<p>


<a href="https://en.wikipedia.org/wiki/Circular_buffer">Circular buffer</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/coreaudio">Core Audio API</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/mmeapi/">Multimedia API</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/xaudio2/xaudio2-introduction">XAudio2 API</a>

</p>
<div class="nonumberh1">Documentation</div>
<p>


<a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/mt708943(v=vs.85)">CreateSoundBuffer</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/mt708921(v=vs.85)">DirectSoundCreate</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/ee416818(v=vs.85)">DSBCAPS</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/ee416820(v=vs.85)">DSBUFFERDESC</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/mt708948(v=vs.85)">SetCooperativeLevel</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/mt708936(v=vs.85)">SetFormat</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/mmeapi/ns-mmeapi-waveformatex">WAVEFORMATEX</a>

</p><p>

<style class="fallback">
  body {
    visibility: hidden;
    font-family: sans-serif;
  }
</style>

</p><p>

<script>markdeepOptions = { tocStyle: 'long' }; window.alreadyProcessedMarkdeep || (document.body.style.visibility = 'visible');</script>
</dsound.h></xinput.h></stdint.h></windows.h></p></span><div id="mdContextMenu" style="visibility:hidden"></div><div class="markdeepFooter"><i>formatted by <a href="https://casual-effects.com/markdeep" style="color:#999">Markdeep&nbsp;1.10&nbsp;&nbsp;</a></i><div style="display:inline-block;font-size:13px;font-family:'Times New Roman',serif;vertical-align:middle;transform:translate(-3px,-1px)rotate(135deg);">&#x2712;</div></div>