<meta charset="UTF-8"><meta http-equiv="content-type" content="text/html;charset=UTF-8"><meta name="viewport" content="width=600, initial-scale=1"><style>span.md {width: 1000;display: inline-block;}body{max-width:680px;margin:auto;padding:20px;text-align:justify;line-height:140%; -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-smoothing:antialiased;color:#222;font-family:Palatino,Georgia,"Times New Roman",serif}</style><style>@media print{*{-webkit-print-color-adjust:exact;text-shadow:none !important}}body{counter-reset: h1 h2 h3 h4 h5 h6 paragraph}@page{margin:0;size:auto}#mdContextMenu{position:absolute;background:#383838;cursor:default;border:1px solid #999;color:#fff;padding:4px 0px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,"Helvetica Neue",sans-serif;font-size:85%;font-weight:600;border-radius:4px;box-shadow:0px 3px 10px rgba(0,0,0,35%)}#mdContextMenu div{padding:0px 20px}#mdContextMenu div:hover{background:#1659d1}.md code,.md pre{font-family:Menlo,Consolas,monospace;font-size:98%;text-align:left;line-height:140%}.md .mediumToc code,.md longToc code,.md .shortToc code,.md h1 code,.md h2 code,.md h3 code,.md h4 code,.md h5 code,.md h6 code{font-size:unset}.md div.title{font-size:26px;font-weight:800;line-height:120%;text-align:center}.md div.afterTitles{height:10px}.md div.subtitle{text-align:center}.md iframe.textinsert, .md object.textinsert,.md iframe:not(.markdeep){display:block;margin-top:10px;margin-bottom:10px;width:100%;height:75vh;border:1px solid #000;border-radius:4px;background:#f5f5f4}.md .image{display:inline-block}.md img{max-width:100%;page-break-inside:avoid}.md li{text-align:left;text-indent:0}.md pre.listing {width:100%;tab-size:4;-moz-tab-size:4;-o-tab-size:4;counter-reset:line;overflow-x:auto;resize:horizontal}.md pre.listing .linenumbers span.line:before{width:30px;margin-left:-28px;font-size:80%;text-align:right;counter-increment:line;content:counter(line);display:inline-block;padding-right:13px;margin-right:8px;color:#ccc}.md div.tilde{margin:20px 0 -10px;text-align:center}.md .imagecaption,.md .tablecaption,.md .listingcaption{display:inline-block;margin:7px 5px 12px;text-align:justify;font-style:italic}.md img.pixel{image-rendering:-moz-crisp-edges;image-rendering:pixelated}.md blockquote.fancyquote{margin:25px 0 25px;text-align:left;line-height:160%}.md blockquote.fancyquote::before{content:"“";color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-right:6px;vertical-align:-0.3em}.md span.fancyquote{font-size:118%;color:#777;font-style:italic}.md span.fancyquote::after{content:"”";font-style:normal;color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-left:6px;vertical-align:-0.3em}.md blockquote.fancyquote .author{width:100%;margin-top:10px;display:inline-block;text-align:right}.md small{font-size:60%}.md big{font-size:150%}.md div.title,contents,.md .tocHeader,.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .shortTOC,.md .mediumTOC,.nonumberh1,.nonumberh2,.nonumberh3,.nonumberh4,.nonumberh5,.nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;margin:13.4px 0 13.4px;padding:15px 0 3px;border-top:none;clear:both}.md .tocTop {display:none}.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .nonumberh1,.md .nonumberh2,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{page-break-after:avoid;break-after:avoid}.md svg.diagram{display:block;font-family:Menlo,Consolas,monospace;font-size:98%;text-align:center;stroke-linecap:round;stroke-width:2px;page-break-inside:avoid;stroke:#000;fill:#000}.md svg.diagram .opendot{fill:#fff}.md svg.diagram .shadeddot{fill:#CCC}.md svg.diagram .dotteddot{stroke:#000;stroke-dasharray:4;fill:none}.md svg.diagram text{stroke:none}@media print{@page{margin:1in 5mm;transform: scale(150%)}}@media print{.md .pagebreak{page-break-after:always;visibility:hidden}}.md a{font-family:Georgia,Palatino,'Times New Roman'}.md h1,.md .tocHeader,.md .nonumberh1{border-bottom:3px solid;font-size:20px;font-weight:bold;}.md h1,.md .nonumberh1{counter-reset: h2 h3 h4 h5 h6}.md h2,.md .nonumberh2{counter-reset: h3 h4 h5 h6;border-bottom:2px solid #999;color:#555;font-weight:bold;font-size:18px;}.md h3,.md h4,.md h5,.md h6,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;color:#555;font-size:16px;}.md h3{counter-reset:h4 h5 h6}.md h4{counter-reset:h5 h6}.md h5{counter-reset:h6}.md div.table{margin:16px 0 16px 0}.md table{border-collapse:collapse;line-height:140%;page-break-inside:avoid}.md table.table{margin:auto}.md table.calendar{width:100%;margin:auto;font-size:11px;font-family:Verdana,Helvetica,Arial,sans-serif}.md table.calendar th{font-size:16px}.md .today{background:#ECF8FA}.md .calendar .parenthesized{color:#999;font-style:italic}.md table.table th{color:#FFF;background-color:#AAA;border:1px solid #888;padding:8px 15px 8px 15px}.md table.table td{padding:5px 15px 5px 15px;border:1px solid #888}.md table.table tr:nth-child(even){background:#EEE}.md pre.tilde{border-top: 1px solid #CCC;border-bottom: 1px solid #CCC;padding: 5px 0 5px 20px;margin:0 0 0 0;background:#FCFCFC;page-break-inside:avoid}.md a.target{width:0px;height:0px;visibility:hidden;font-size:0px;display:inline-block}.md a:link, .md a:visited{color:#38A;text-decoration:none}.md a:link:hover{text-decoration:underline}.md dt{font-weight:700}.md dl>dd{margin-top:-8px; margin-bottom:8px}.md dl>table{margin:35px 0 30px}.md code{page-break-inside:avoid;} @media print{.md .listing code{white-space:pre-wrap}}.md .endnote{font-size:13px;line-height:15px;padding-left:10px;text-indent:-10px}.md .bib{padding-left:80px;text-indent:-80px;text-align:left}.markdeepFooter{font-size:9px;text-align:right;padding-top:80px;color:#999}.md .mediumTOC{float:right;font-size:12px;line-height:15px;border-left:1px solid #CCC;padding-left:15px;margin:15px 0px 15px 25px}.md .mediumTOC .level1{font-weight:600}.md .longTOC .level1{font-weight:600;display:block;padding-top:12px;margin:0 0 -20px}.md .shortTOC{text-align:center;font-weight:bold;margin-top:15px;font-size:14px}.md .admonition{position:relative;margin:1em 0;padding:.4rem 1rem;border-radius:.2rem;border-left:2.5rem solid rgba(68,138,255,.4);background-color:rgba(68,138,255,.15);}.md .admonition-title{font-weight:bold;border-bottom:solid 1px rgba(68,138,255,.4);padding-bottom:4px;margin-bottom:4px;margin-left: -1rem;padding-left:1rem;margin-right:-1rem;border-color:rgba(68,138,255,.4)}.md .admonition.tip{border-left:2.5rem solid rgba(50,255,90,.4);background-color:rgba(50,255,90,.15)}.md .admonition.tip::before{content:"\24d8";font-weight:bold;font-size:150%;position:relative;top:3px;color:rgba(26,128,46,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.tip>.admonition-title{border-color:rgba(50,255,90,.4)}.md .admonition.warn,.md .admonition.warning{border-left:2.5rem solid rgba(255,145,0,.4);background-color:rgba(255,145,0,.15)}.md .admonition.warn::before,.md .admonition.warning::before{content:"\26A0";font-weight:bold;font-size:150%;position:relative;top:2px;color:rgba(128,73,0,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.warn>.admonition-title,.md .admonition.warning>.admonition-title{border-color:rgba(255,145,0,.4)}.md .admonition.error{border-left: 2.5rem solid rgba(255,23,68,.4);background-color:rgba(255,23,68,.15)}.md .admonition.error>.admonition-title{border-color:rgba(255,23,68,.4)}.md .admonition.error::before{content: "\2612";font-family:"Arial";font-size:200%;position:relative;color:rgba(128,12,34,.8);top:-2px;left:-3rem;display:block;width:0;height:0}.md .admonition p:last-child{margin-bottom:0}.md li.checked,.md li.unchecked{list-style:none;overflow:visible;text-indent:-1.2em}.md li.checked:before,.md li.unchecked:before{content:"\2611";display:block;float:left;width:1em;font-size:120%}.md li.unchecked:before{content:"\2610"}</style><style>.md h1::before {
content:counter(h1) " ";
counter-increment: h1;margin-right:10px}.md h2::before {
content:counter(h1) "."counter(h2) " ";
counter-increment: h2;margin-right:10px}.md h3::before {
content:counter(h1) "."counter(h2) "."counter(h3) " ";
counter-increment: h3;margin-right:10px}.md h4::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) " ";
counter-increment: h4;margin-right:10px}.md h5::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) " ";
counter-increment: h5;margin-right:10px}.md h6::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) "."counter(h6) " ";
counter-increment: h6;margin-right:10px}</style><style>.hljs{display:block;overflow-x:auto;padding:0.5em;background:#fff;color:#000;-webkit-text-size-adjust:none}.hljs-comment{color:#006a00}.hljs-keyword{color:#02E}.hljs-literal,.nginx .hljs-title{color:#aa0d91}.method,.hljs-list .hljs-title,.hljs-tag .hljs-title,.setting .hljs-value,.hljs-winutils,.tex .hljs-command,.http .hljs-title,.hljs-request,.hljs-status,.hljs-name{color:#008}.hljs-envvar,.tex .hljs-special{color:#660}.hljs-string{color:#c41a16}.hljs-tag .hljs-value,.hljs-cdata,.hljs-filter .hljs-argument,.hljs-attr_selector,.apache .hljs-cbracket,.hljs-date,.hljs-regexp{color:#080}.hljs-sub .hljs-identifier,.hljs-pi,.hljs-tag,.hljs-tag .hljs-keyword,.hljs-decorator,.ini .hljs-title,.hljs-shebang,.hljs-prompt,.hljs-hexcolor,.hljs-rule .hljs-value,.hljs-symbol,.hljs-symbol .hljs-string,.hljs-number,.css .hljs-function,.hljs-function .hljs-title,.coffeescript .hljs-attribute{color:#A0C}.hljs-function .hljs-title{font-weight:bold;color:#000}.hljs-class .hljs-title,.smalltalk .hljs-class,.hljs-type,.hljs-typename,.hljs-tag .hljs-attribute,.hljs-doctype,.hljs-class .hljs-id,.hljs-built_in,.setting,.hljs-params,.clojure .hljs-attribute{color:#5c2699}.hljs-variable{color:#3f6e74}.css .hljs-tag,.hljs-rule .hljs-property,.hljs-pseudo,.hljs-subst{color:#000}.css .hljs-class,.css .hljs-id{color:#9b703f}.hljs-value .hljs-important{color:#ff7700;font-weight:bold}.hljs-rule .hljs-keyword{color:#c5af75}.hljs-annotation,.apache .hljs-sqbracket,.nginx .hljs-built_in{color:#9b859d}.hljs-preprocessor,.hljs-preprocessor *,.hljs-pragma{color:#643820}.tex .hljs-formula{background-color:#eee;font-style:italic}.diff .hljs-header,.hljs-chunk{color:#808080;font-weight:bold}.diff .hljs-change{background-color:#bccff9}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-comment .hljs-doctag{font-weight:bold}.method .hljs-id{color:#000}</style><style>div.title { padding-top: 40px; } div.afterTitles { height: 15px; }</style><meta charset="utf-8">
<link rel="stylesheet" href="../css/style.css">

<script>try {
                        Object.defineProperty(screen, "availTop", { value: 0 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availLeft", { value: 0 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availWidth", { value: 1920 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availHeight", { value: 1080 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "colorDepth", { value: 24 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "pixelDepth", { value: 24 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "hardwareConcurrency", { value: 8 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "appVersion", { value: "5.0 (Windows)" });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "doNotTrack", { value: "unspecified" });
                    } catch (e) {}
                    
            try {
                window.screenY = 1072
            } catch (e) { }
        
            try {
                window.screenTop = 1072
            } catch (e) { }
        
            try {
                window.top.window.outerHeight = window.screen.height
            } catch (e) { }
        
            try {
                window.screenX = 1912
            } catch (e) { }
        
            try {
                window.screenLeft = 1912
            } catch (e) { }
        
            try {
                window.top.window.outerWidth = window.screen.width
            } catch (e) { }
        </script><script>try {
                        Object.defineProperty(screen, "availTop", { value: 0 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availLeft", { value: 0 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availWidth", { value: 1920 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availHeight", { value: 1080 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "colorDepth", { value: 24 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "pixelDepth", { value: 24 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "hardwareConcurrency", { value: 8 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "appVersion", { value: "5.0 (Windows)" });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "doNotTrack", { value: "unspecified" });
                    } catch (e) {}
                    
            try {
                window.screenY = 1072
            } catch (e) { }
        
            try {
                window.screenTop = 1072
            } catch (e) { }
        
            try {
                window.top.window.outerHeight = window.screen.height
            } catch (e) { }
        
            try {
                window.screenX = 1912
            } catch (e) { }
        
            try {
                window.screenLeft = 1912
            } catch (e) { }
        
            try {
                window.top.window.outerWidth = window.screen.width
            } catch (e) { }
        </script><script>try {
                        Object.defineProperty(screen, "availTop", { value: 0 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availLeft", { value: 0 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availWidth", { value: 1920 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availHeight", { value: 1080 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "colorDepth", { value: 24 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "pixelDepth", { value: 24 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "hardwareConcurrency", { value: 8 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "appVersion", { value: "5.0 (Windows)" });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "doNotTrack", { value: "unspecified" });
                    } catch (e) {}
                    
            try {
                window.screenY = 1072
            } catch (e) { }
        
            try {
                window.screenTop = 1072
            } catch (e) { }
        
            try {
                window.top.window.outerHeight = window.screen.height
            } catch (e) { }
        
            try {
                window.screenX = 1912
            } catch (e) { }
        
            try {
                window.screenLeft = 1912
            } catch (e) { }
        
            try {
                window.top.window.outerWidth = window.screen.width
            } catch (e) { }
        </script><script>try {
                        Object.defineProperty(screen, "availTop", { value: 0 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availLeft", { value: 0 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availWidth", { value: 1920 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availHeight", { value: 1080 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "colorDepth", { value: 24 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "pixelDepth", { value: 24 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "hardwareConcurrency", { value: 8 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "appVersion", { value: "5.0 (Windows)" });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "doNotTrack", { value: "unspecified" });
                    } catch (e) {}
                    
            try {
                window.screenY = 1072
            } catch (e) { }
        
            try {
                window.screenTop = 1072
            } catch (e) { }
        
            try {
                window.top.window.outerHeight = window.screen.height
            } catch (e) { }
        
            try {
                window.screenX = 1912
            } catch (e) { }
        
            try {
                window.screenLeft = 1912
            } catch (e) { }
        
            try {
                window.top.window.outerWidth = window.screen.width
            } catch (e) { }
        </script><script>try {
                        Object.defineProperty(screen, "availTop", { value: 0 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availLeft", { value: 0 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availWidth", { value: 1920 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availHeight", { value: 1080 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "colorDepth", { value: 24 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "pixelDepth", { value: 24 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "hardwareConcurrency", { value: 8 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "appVersion", { value: "5.0 (Windows)" });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "doNotTrack", { value: "unspecified" });
                    } catch (e) {}
                    
            try {
                window.screenY = 1072
            } catch (e) { }
        
            try {
                window.screenTop = 1072
            } catch (e) { }
        
            try {
                window.top.window.outerHeight = window.screen.height
            } catch (e) { }
        
            try {
                window.screenX = 1912
            } catch (e) { }
        
            try {
                window.screenLeft = 1912
            } catch (e) { }
        
            try {
                window.top.window.outerWidth = window.screen.width
            } catch (e) { }
        </script><span class="md"><p><title>Day 15. Platform-Independent Debug File I/O</title><div class="title"> Day 15. Platform-Independent Debug File I/O </div>

<div class="afterTitles"></div>
<em class="underscore">Video Length (including Q&A): <a href="https://hero.handmade.network/episode/code/day015/">1h33</a></em> 

</p><p>

Welcome to &ldquo;Handmade Hero Notes&rdquo;, the book where we follow the footsteps of <a href="https://handmadehero.org/">Handmade Hero</a> in making the complete game from scratch, with no external libraries. If you'd like to follow along, preorder the game on <a href="https://handmadehero.org/">handmadehero.org</a>, and you will receive access to the GitHub repository, containing complete source code (tagged day-by-day) as well as a variety of other useful resources.

</p><p>

Throughout the past four days, we were isolating what will become the platform-independent layer from our Win32 layer. Up until the present, we've been converting already existing &ldquo;systems&rdquo; but now the time has come to introduce a somewhat new one. We'll do some basic file I/O today. 

</p>
<div class="longTOC"><p align="center">
    <span align="right"><a href="day14.html">Day 14</a></span>
    <a href="../index.html"><img src = "../media/logo.png"></a>
    <span align="left"><a href="day16.html">Day 16</a></span>
</p><p><a href="#" class="tocTop">(Top)</a><br/>
<a href="#aboutfilei/oingames" class="level1"><span class="tocNumber">1&nbsp; </span>About File I/O in Games</a><br/>
&nbsp;&nbsp;<a href="#aboutfilei/oingames/defineapproach" class="level2"><span class="tocNumber">1.1&nbsp; </span>Define Approach</a><br/>
&nbsp;&nbsp;<a href="#aboutfilei/oingames/writeusagecodefirst" class="level2"><span class="tocNumber">1.2&nbsp; </span>Write Usage Code First</a><br/>
<a href="#platformimplementation" class="level1"><span class="tocNumber">2&nbsp; </span>Platform implementation</a><br/>
&nbsp;&nbsp;<a href="#platformimplementation/freefilememory" class="level2"><span class="tocNumber">2.1&nbsp; </span>Free File Memory</a><br/>
&nbsp;&nbsp;<a href="#platformimplementation/readfile" class="level2"><span class="tocNumber">2.2&nbsp; </span>Read file</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#platformimplementation/readfile/getahandle" class="level3"><span class="tocNumber">2.2.1&nbsp; </span>Get a Handle</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#platformimplementation/readfile/getfilesize" class="level3"><span class="tocNumber">2.2.2&nbsp; </span>Get File Size</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#platformimplementation/readfile/allocatefilememory" class="level3"><span class="tocNumber">2.2.3&nbsp; </span>Allocate File Memory</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#platformimplementation/readfile/readthefilecontents" class="level3"><span class="tocNumber">2.2.4&nbsp; </span>Read the File Contents</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#platformimplementation/readfile/closehandle" class="level3"><span class="tocNumber">2.2.5&nbsp; </span>Close Handle</a><br/>
&nbsp;&nbsp;<a href="#platformimplementation/writefile" class="level2"><span class="tocNumber">2.3&nbsp; </span>Write file</a><br/>
<a href="#compileandtest" class="level1"><span class="tocNumber">3&nbsp; </span>Compile and Test</a><br/>
<a href="#recap" class="level1"><span class="tocNumber">4&nbsp; </span>Recap</a><br/>
<a href="#programmingnotions" class="level1"><span class="tocNumber">5&nbsp; </span>Programming Notions</a><br/>
&nbsp;&nbsp;<a href="#programmingnotions/introtostructpacking" class="level2"><span class="tocNumber">5.1&nbsp; </span>Intro to Struct Packing</a><br/>
<a href="#sideconsiderations" class="level1"><span class="tocNumber">6&nbsp; </span>Side Considerations</a><br/>
&nbsp;&nbsp;<a href="#sideconsiderations/safetruncation" class="level2"><span class="tocNumber">6.1&nbsp; </span>Safe Truncation</a><br/>
<a href="#navigation" class="level1"><span class="tocNumber">7&nbsp; </span>Navigation</a><br/>
</p></div><a class="target" name="aboutfilei/oingames">&nbsp;</a><a class="target" name="aboutfilei/oingames">&nbsp;</a><a class="target" name="toc1">&nbsp;</a><h1>About File I/O in Games</h1>
<p>


File I/O means literally interacting with the file system (folders, files, etc.) for reading and writing files. In games, this is usually done for two distinct purposes: 

</p><p>

<ol start=1>
<li class="number">Loading game assets from read-only files. 
<ul>
    <li class="asterisk">These include music, sounds, 2D/3D art, level layouts, and much more.
</li>
    <li class="asterisk">During the game execution, you never write to these files. Writing happens at some point before the game ships, and not necessarily by the game itself. It might even be done by some third-party tool like photoshop. 
</li>
    <li class="asterisk">You read from the asset files and into the memory during the game execution. That data can be pulled from the network, an optical drive, hard drive, and so on.

</p><p>

</li></ul>
<li class="number">Reading <em class="underscore">and</em> writing configuration and save files.
<ul>
    <li class="asterisk">The data in config files might be graphics or sound settings, and potentially more.
</li>
    <li class="asterisk">The save files store the state of the progress of the player (various unlocks, player position on map, etc.)</li></ul></li></ol>

</p><p>

When we talk about game I/O we talk about these two different things. And don't take this lightly: these <em class="underscore">are</em> completely different things and they have different criteria for success. Config files are small and agile, while the asset files take potentially gigabytes of data. 

</p><p>

<div class="admonition trivia"><div class="admonition-title"> About Asset Files Loading Evolution</div>

</p><p>

    The way asset files are loaded has evolved over the years. The process used to be quite linear: you'd open a file directly as the part of execution, read N bytes to the provided buffer, do something with that buffer, read more, etc. (and when the file was no longer needed, close the file).

</p><p>

    Nowadays, thanks to the widespread of multithreading techniques, many adopt <em class="underscore">streaming</em> of assets in the background so that the user doesn't have to sit on the loading screens.</div>

</p>
<a class="target" name="defineapproach">&nbsp;</a><a class="target" name="aboutfilei/oingames/defineapproach">&nbsp;</a><a class="target" name="toc1.1">&nbsp;</a><h2>Define Approach</h2>
<p>


As usual, there're many ways to put the proverbial pants on a dog. One way would be keeping the file handle around and only reading the bytes we want at a time. This is an approach that many games adopt... but we won't, because of the issues it presents later down the line: 

</p><p>

<ul>
<li class="asterisk">You could find yourself handling more than one file at a time. This means having several handles open, several memory blocks, all nested and all ready to break at any moment. This of course can be mitigated, but it's an extra headache you'd rather not have.
</li>
<li class="asterisk">Any new read can fail at any moment (for example if user physically removes the USB stick where the data is stored).
</li>
<li class="asterisk">Such an approach is not <em class="underscore">thread safe</em> by default. We haven't touched on multithreading yet, but suffice to say that two different threads could potentially read from the same location at the same time, even if they don't want it.
</li>
<li class="asterisk">The read is <em class="underscore">synchronous</em>. No work can be done until it's completed, and hard drive is <em class="underscore">by orders of magnitude</em> the slowest thing on a computer. So we just wait until the work is done. 
</li>
<li class="asterisk">Such an API is sequentially <em class="underscore">streaming data</em>, which assumes that we pull data incrementally. If you want to read from another location in the file, it creates even further delays.</li></ul>

</p><p>

<center><div class="image" style=""><a href="../media/day15/latency.png" target="_blank"><img class="markdeep" src="../media/day15/latency.png" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;1:</b> Latency (delay) comparison using various media. To give you some context, if you scale the numbers up, reading from memory would take a couple minutes, from SSD a couple of days, and from hard drive a few <em class="underscore">months</em>.</span></center></div></center>

</p><p>

So what will be our approach? 

</p><p>

For the smaller files we'll use right now, we'll simply read them whole, and store them in memory. It's a similar structure to the above method except we don't read in small pieces. Once we're ready to stream big asset files, we'll be doing it asynchronously and from only one asset file. 

</p><p>

That said, as with anything we've done up until now, it won't be the final system. We don't want to put the cart before the horse in designing a fully-fledged asset streaming system, but we need to be able to load the files for our debugging purposes from somewhere. So today we're going to just that: put the minimal set of functions to get the game running.

</p>
<a class="target" name="writeusagecodefirst">&nbsp;</a><a class="target" name="aboutfilei/oingames/writeusagecodefirst">&nbsp;</a><a class="target" name="toc1.2">&nbsp;</a><h2>Write Usage Code First</h2>
<p>


Let's start coding. Open your <code>handmade.cpp</code> and try to imagine how would you approach reading files. Such a simple function would only need to take the path to the file (absolute or relative to our working directory) and return a <code>void *</code>, pure memory.

</p><p>

<div class="admonition warning">If you remember, during the <a href="../html/day1.html">day 1</a> we set our &ldquo;Working Directory&rdquo; to be <code>data</code>, so any relative paths in the file system will take it from there. If you skipped that step then, make sure to return and set the correct working directory!</div>

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">GameUpdateAndRender</span><span class="hljs-params">(game_memory* Memory, game_input *Input, game_offscreen_buffer* Buffer, game_sound_output_buffer *SoundBuffer)</span></span>
<span class="line"></span>{</span><div class=" add    "><span class="line">    <span class="hljs-keyword">void</span> *FileData = ReadEntireFile(<span class="hljs-string">"test.bmp"</span>);</span>
<span class="line">    <span class="hljs-keyword">if</span> (FileData)</span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// yay!</span></span>
<span class="line">    }</span></div><span class="line"><span class="hljs-comment">// ... </span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;1:</b> <file>[handmade.cpp]</file> Adding a read file function.</div></center>
<p>


We don't have any files to read yet, so let's say we want to read this file. Compiler has a handy macro called <code>__FILE__</code> which stores the path to this specific file you put this macro in (in our case, <code>handmade.cpp</code>). We'll also want to have a call to free whatever memory we get.

</p><pre class="listing tilde"><code><div class=" edit"><span class="line"><span class="hljs-keyword">void</span> *FileData = ReadEntireFile(__FILE__);</span></div><span class="line"><span class="hljs-keyword">if</span> (FileData)</span>
<span class="line">{</span><div class=" add"><span class="line">    FreeFileMemory(FileData);</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;2:</b> <file>[handmade.cpp]</file> Adding a free file memory call.</div></center>
<p>


Last, we also want to be able to write to our files. Let's imagine that, in order to write to the file, you'd want to provide a path, but also link to the data and the size. 

</p><p>

This reminds us that from a <code>Read</code> function we'd also want to get the size of the file we read. Let's store both the <code>void *</code> and the size in a struct, say <code>read_file_result</code>. <code>FreeFileMemory</code> would only need the former, so our usage would be the following.

</p><pre class="listing tilde"><code><div class=" edit"><span class="line">read_file_result FileData = ReadEntireFile(__FILE__);</span></div><span class="line"><span class="hljs-keyword">if</span> (FileData.Contents)</span>
<span class="line">{</span><div class=" add"><span class="line">    WriteEntireFile(<span class="hljs-string">"test.out"</span>, FileData.ContentsSize, FileData.Contents);</span></div><div class=" edit"><span class="line">    FreeFileMemory(FileData.Contents);</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;3:</b> <file>[handmade.cpp]</file> Adding a write file call and modifying the others.</div></center>
<p>


Looks good! Now this code differs from what we've written thus far: this is the call which happens from the game back to the platform layer, thus making the &ldquo;round trip&rdquo;. to the platform. 

</p><p>

And this is what you have if you add callbacks (for memory or anything else):
<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="464" width="360" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 32,16 L 32,416 " style="fill:none;"/>
<path d="M 72,16 L 72,416 " style="fill:none;"/>
<path d="M 256,16 L 256,416 " style="fill:none;"/>
<path d="M 296,16 L 296,416 " style="fill:none;"/>
<path d="M 32,16 L 72,16 " style="fill:none;"/>
<path d="M 256,16 L 296,16 " style="fill:none;"/>
<path d="M 88,48 L 240,48 " style="fill:none;"/>
<path d="M 88,128 L 240,128 " style="fill:none;"/>
<path d="M 96,160 L 240,160 " style="fill:none;"/>
<path d="M 88,208 L 240,208 " style="fill:none;"/>
<path d="M 96,240 L 240,240 " style="fill:none;"/>
<path d="M 88,288 L 240,288 " style="fill:none;"/>
<path d="M 96,320 L 240,320 " style="fill:none;"/>
<path d="M 88,384 L 240,384 " style="fill:none;"/>
<path d="M 32,416 L 72,416 " style="fill:none;"/>
<path d="M 256,416 L 296,416 " style="fill:none;"/>
<path d="M 96,160 C 79.2,160 80,144 80,144 " style="fill:none;"/>
<path d="M 96,240 C 79.2,240 80,224 80,224 " style="fill:none;"/>
<path d="M 96,320 C 79.2,320 80,304 80,304 " style="fill:none;"/>
<polygon points="248,320 236,314.4 236,325.6 "  style="stroke:none" transform="rotate(0,240,320 )"/>
<polygon points="248,240 236,234.4 236,245.6 "  style="stroke:none" transform="rotate(0,240,240 )"/>
<polygon points="248,160 236,154.4 236,165.6 "  style="stroke:none" transform="rotate(0,240,160 )"/>
<polygon points="248,48 236,42.4 236,53.6 "  style="stroke:none" transform="rotate(0,240,48 )"/>
<polygon points="96,384 84,378.4 84,389.6 "  style="stroke:none" transform="rotate(180,88,384 )"/>
<polygon points="96,288 84,282.4 84,293.6 "  style="stroke:none" transform="rotate(180,88,288 )"/>
<polygon points="96,208 84,202.4 84,213.6 "  style="stroke:none" transform="rotate(180,88,208 )"/>
<polygon points="96,128 84,122.4 84,133.6 "  style="stroke:none" transform="rotate(180,88,128 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="24" y="4">P</text><text text-anchor="middle" x="32" y="4">L</text><text text-anchor="middle" x="40" y="4">A</text><text text-anchor="middle" x="48" y="4">T</text><text text-anchor="middle" x="56" y="4">F</text><text text-anchor="middle" x="64" y="4">O</text><text text-anchor="middle" x="72" y="4">R</text><text text-anchor="middle" x="80" y="4">M</text><text text-anchor="middle" x="264" y="4">G</text><text text-anchor="middle" x="272" y="4">A</text><text text-anchor="middle" x="280" y="4">M</text><text text-anchor="middle" x="288" y="4">E</text><text text-anchor="middle" x="88" y="36">G</text><text text-anchor="middle" x="96" y="36">a</text><text text-anchor="middle" x="104" y="36">m</text><text text-anchor="middle" x="112" y="36">e</text><text text-anchor="middle" x="120" y="36">U</text><text text-anchor="middle" x="128" y="36">p</text><text text-anchor="middle" x="136" y="36">d</text><text text-anchor="middle" x="144" y="36">a</text><text text-anchor="middle" x="152" y="36">t</text><text text-anchor="middle" x="160" y="36">e</text><text text-anchor="middle" x="168" y="36">A</text><text text-anchor="middle" x="176" y="36">n</text><text text-anchor="middle" x="184" y="36">d</text><text text-anchor="middle" x="192" y="36">R</text><text text-anchor="middle" x="200" y="36">e</text><text text-anchor="middle" x="208" y="36">n</text><text text-anchor="middle" x="216" y="36">d</text><text text-anchor="middle" x="224" y="36">e</text><text text-anchor="middle" x="232" y="36">r</text><text text-anchor="middle" x="88" y="68">(</text><text text-anchor="middle" x="96" y="68">s</text><text text-anchor="middle" x="104" y="68">t</text><text text-anchor="middle" x="112" y="68">a</text><text text-anchor="middle" x="120" y="68">r</text><text text-anchor="middle" x="128" y="68">t</text><text text-anchor="middle" x="144" y="68">o</text><text text-anchor="middle" x="152" y="68">f</text><text text-anchor="middle" x="168" y="68">t</text><text text-anchor="middle" x="176" y="68">h</text><text text-anchor="middle" x="184" y="68">e</text><text text-anchor="middle" x="200" y="68">f</text><text text-anchor="middle" x="208" y="68">r</text><text text-anchor="middle" x="216" y="68">a</text><text text-anchor="middle" x="224" y="68">m</text><text text-anchor="middle" x="232" y="68">e</text><text text-anchor="middle" x="240" y="68">)</text><text text-anchor="middle" x="88" y="116">R</text><text text-anchor="middle" x="96" y="116">e</text><text text-anchor="middle" x="104" y="116">a</text><text text-anchor="middle" x="112" y="116">d</text><text text-anchor="middle" x="120" y="116">E</text><text text-anchor="middle" x="128" y="116">n</text><text text-anchor="middle" x="136" y="116">t</text><text text-anchor="middle" x="144" y="116">i</text><text text-anchor="middle" x="152" y="116">r</text><text text-anchor="middle" x="160" y="116">e</text><text text-anchor="middle" x="168" y="116">F</text><text text-anchor="middle" x="176" y="116">i</text><text text-anchor="middle" x="184" y="116">l</text><text text-anchor="middle" x="192" y="116">e</text><text text-anchor="middle" x="96" y="148">r</text><text text-anchor="middle" x="104" y="148">e</text><text text-anchor="middle" x="112" y="148">t</text><text text-anchor="middle" x="120" y="148">u</text><text text-anchor="middle" x="128" y="148">r</text><text text-anchor="middle" x="136" y="148">n</text><text text-anchor="middle" x="88" y="196">W</text><text text-anchor="middle" x="96" y="196">r</text><text text-anchor="middle" x="104" y="196">i</text><text text-anchor="middle" x="112" y="196">t</text><text text-anchor="middle" x="120" y="196">e</text><text text-anchor="middle" x="128" y="196">E</text><text text-anchor="middle" x="136" y="196">n</text><text text-anchor="middle" x="144" y="196">t</text><text text-anchor="middle" x="152" y="196">i</text><text text-anchor="middle" x="160" y="196">r</text><text text-anchor="middle" x="168" y="196">e</text><text text-anchor="middle" x="176" y="196">F</text><text text-anchor="middle" x="184" y="196">i</text><text text-anchor="middle" x="192" y="196">l</text><text text-anchor="middle" x="200" y="196">e</text><text text-anchor="middle" x="96" y="228">r</text><text text-anchor="middle" x="104" y="228">e</text><text text-anchor="middle" x="112" y="228">t</text><text text-anchor="middle" x="120" y="228">u</text><text text-anchor="middle" x="128" y="228">r</text><text text-anchor="middle" x="136" y="228">n</text><text text-anchor="middle" x="88" y="276">F</text><text text-anchor="middle" x="96" y="276">r</text><text text-anchor="middle" x="104" y="276">e</text><text text-anchor="middle" x="112" y="276">e</text><text text-anchor="middle" x="120" y="276">F</text><text text-anchor="middle" x="128" y="276">i</text><text text-anchor="middle" x="136" y="276">l</text><text text-anchor="middle" x="144" y="276">e</text><text text-anchor="middle" x="152" y="276">M</text><text text-anchor="middle" x="160" y="276">e</text><text text-anchor="middle" x="168" y="276">m</text><text text-anchor="middle" x="176" y="276">o</text><text text-anchor="middle" x="184" y="276">r</text><text text-anchor="middle" x="192" y="276">y</text><text text-anchor="middle" x="96" y="308">r</text><text text-anchor="middle" x="104" y="308">e</text><text text-anchor="middle" x="112" y="308">t</text><text text-anchor="middle" x="120" y="308">u</text><text text-anchor="middle" x="128" y="308">r</text><text text-anchor="middle" x="136" y="308">n</text><text text-anchor="middle" x="96" y="372">r</text><text text-anchor="middle" x="104" y="372">e</text><text text-anchor="middle" x="112" y="372">t</text><text text-anchor="middle" x="120" y="372">u</text><text text-anchor="middle" x="128" y="372">r</text><text text-anchor="middle" x="136" y="372">n</text><text text-anchor="middle" x="96" y="404">(</text><text text-anchor="middle" x="104" y="404">e</text><text text-anchor="middle" x="112" y="404">n</text><text text-anchor="middle" x="120" y="404">d</text><text text-anchor="middle" x="136" y="404">o</text><text text-anchor="middle" x="144" y="404">f</text><text text-anchor="middle" x="160" y="404">f</text><text text-anchor="middle" x="168" y="404">r</text><text text-anchor="middle" x="176" y="404">a</text><text text-anchor="middle" x="184" y="404">m</text><text text-anchor="middle" x="192" y="404">e</text><text text-anchor="middle" x="200" y="404">)</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;2:</b> Our API structure. Of course, we can call the file functions at any moment during the frame.</div></center>

</p><p>

We want to make sure that anyone using this call in the game knows it's not final, and that's it a call to the platform. We can even write it in big letters that it's all for <code>DEBUG</code> purposes. Also it's a <code>Platform</code> call, se we will add this prefix as well. 

</p><pre class="listing tilde"><code><div class=" edit"><span class="line">debug_read_file_result FileData = DEBUGPlatformReadEntireFile(__FILE__);</span></div><span class="line"><span class="hljs-keyword">if</span> (FileData.Contents)</span>
<span class="line">{</span><div class=" edit"><span class="line">    DEBUGPlatformWriteEntireFile(<span class="hljs-string">"test.out"</span>, FileData.ContentsSize, FileData.Contents);</span>
<span class="line">    DEBUGPlatformFreeFileMemory(FileData.Contents);</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;4:</b> <file>[handmade.cpp]</file> Adding prefixes.</div></center>
<p>


Now, moving to <code>handmade.h</code>, we can even further accentuate it by writing the API inside <code>#if HANDMADE_INTERNAL</code> (that we defined <a href="../html/day14.html">last time</a>). This will make so these calls only work when we're compiling with this flag set. We will define our file API inside the section we reserved for the &ldquo;services that the platform layer provides to the game&rdquo;:

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line"><span class="hljs-comment">// NOTE(casey): Services that the platform layer provides to the game.</span></span></div><div class=" add"><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> HANDMADE_INTERNAL</span></span>
<span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">debug_read_file_result</span></span>
<span class="line">{</span></span>
<span class="line">    u32 ContentsSize;</span>
<span class="line">    <span class="hljs-keyword">void</span> *Contents;</span>
<span class="line">};</span>
<span class="line"><span class="hljs-function">internal debug_read_file_result <span class="hljs-title">DEBUGPlatformReadEntireFile</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *Filename)</span></span>;</span>
<span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span> <span class="hljs-title">DEBUGPlatformFreeFileMemory</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *Memory)</span></span>;</span>
<span class="line"><span class="hljs-function">internal b32 <span class="hljs-title">DEBUGPlatformWriteEntireFile</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *Filename, u32 MemorySize, <span class="hljs-keyword">void</span> *Memory)</span></span>;</span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span></div><span class="line"></span>
<span class="line"><span class="hljs-comment">// NOTE(casey): Services that the game provides to the platform layer.</span></span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;5:</b> <file>[handmade.h]</file> Defining the API.</div></center>
<p>


Hopefully, it's clear what's going on here. We largely mirrored the usage we've thought about inside <code>GameUpdateAndRender</code>. The only difference is that our <code>Write</code> function now returns a <code>b32</code> so we can potentially check if the write was successful. 

</p>
<a class="target" name="platformimplementation">&nbsp;</a><a class="target" name="platformimplementation">&nbsp;</a><a class="target" name="toc2">&nbsp;</a><h1>Platform implementation</h1>
<p>


For each of these functions, we'll ask Windows to do exactly we mentioned in the API. It won't be anything fancy: you should strive to only write the absolute minimum necessary at this stage.

</p>
<a class="target" name="freefilememory">&nbsp;</a><a class="target" name="platformimplementation/freefilememory">&nbsp;</a><a class="target" name="toc2.1">&nbsp;</a><h2>Free File Memory</h2>
<p>


Our free file memory function will be trivial. We'll be using <code>VirtualAlloc</code> for file memory allocation, so we can simply call <a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualfree">VirtualFree</a> with <code>MEM_RELEASE</code> flag. 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DIRECT_SOUND_CREATE(name) HRESULT WINAPI name(...)</span></span>
<span class="line"><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">DIRECT_SOUND_CREATE</span><span class="hljs-params">(direct_sound_create)</span></span>;</span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">DEBUGPlatformFreeFileMemory</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *Memory)</span></span>
<span class="line"></span>{</span>
<span class="line">    <span class="hljs-keyword">if</span> (Memory)</span>
<span class="line">    {</span>
<span class="line">        VirtualFree(Memory, <span class="hljs-number">0</span>, MEM_RELEASE);</span>
<span class="line">    }</span>
<span class="line">}</span></div><span class="line"></span>
<span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">Win32LoadXInput</span><span class="hljs-params">()</span>...</span></span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;6:</b> <file>[win32_handmade.cpp]</file> Defining free file memory function.</div></center>

<a class="target" name="readfile">&nbsp;</a><a class="target" name="platformimplementation/readfile">&nbsp;</a><a class="target" name="toc2.2">&nbsp;</a><h2>Read file</h2>
<p>


Read file is a bit more involved but, again, is rather straightforward. It just involves more steps and calling Windows. This is what we need to do:

</p><p>

<ol start=1>
    <li class="number">Get the file handle by calling <a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea">CreateFileA</a> to open a file. 
</li>
    <li class="number">Get the file size using <a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-getfilesizeex">GetFileSizeEx</a>. We <em class="underscore">could</em> use <code>GetFileSize</code> but it's a bit antiquated and doesn't really work well in the 64-bit systems.
</li>
    <li class="number">Allocate memory for that size using <a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc">VirtualAlloc</a>.
</li>
    <li class="number"><a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-readfile">ReadFile</a> contents into that memory.
</li>
    <li class="number">Finally, <a href="https://docs.microsoft.com/en-us/windows/win32/api/handleapi/nf-handleapi-closehandle">CloseHandle</a> to return the file back to Windows.</li></ol>

</p><p>

We will also need to have a <code>debug_read_file_result</code> which we'll return at the end of the function.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">DEBUGPlatformFreeFileMemory</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *Memory)</span></span>
<span class="line"></span>{</span>
<span class="line">    <span class="hljs-keyword">if</span> (Memory)</span>
<span class="line">    {</span>
<span class="line">        VirtualFree(Memory, <span class="hljs-number">0</span>, MEM_RELEASE);</span>
<span class="line">    }</span>
<span class="line">}</span><div class=" add"><span class="line"><span class="hljs-function">internal debug_read_file_result </span>
<span class="line"><span class="hljs-title">DEBUGPlatformReadEntireFile</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *Filename)</span></span>
<span class="line"></span>{</span>
<span class="line">    debug_read_file_result Result = {};</span>
<span class="line"></span>
<span class="line">    CreateFileA();</span>
<span class="line">    GetFileSizeEx();</span>
<span class="line">    VirtualAlloc();</span>
<span class="line">    ReadFile();</span>
<span class="line">    CloseHandle();</span>
<span class="line"></span>
<span class="line">    <span class="hljs-keyword">return</span> (Result);</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;7:</b> <file>[win32_handmade.cpp]</file> Sketching out the read file function.</div></center>
<p>


Not a lot of mystery, and actually exactly what you'd expect from a similar function. Let's expand and complete each step.

</p><p>

<div class="admonition note"><div class="admonition-title"> About Result Definition</div>

</p><p>

    You might have noticed that, in our functions, we usually define a <code>Result</code> value at the beginning of the function and clear it to <code>0</code> (<code>false</code>/<code>{}</code> or whatever is appropriate depending on its type). We then fill it in somewhere in the middle of the function and eventually return at the very end. 

</p><p>

    While this structure is not at all necessary, it definitely helps to structure your way of thinking, so you don't lose things along the way, plus you always have a result that you can generally check against <code>0</code> to make sure the operation succeeded. It's also error-secure, clean, and helps to verify if everything's ok.</div>

</p>
<a class="target" name="getahandle">&nbsp;</a><a class="target" name="platformimplementation/readfile/getahandle">&nbsp;</a><a class="target" name="toc2.2.1">&nbsp;</a><h3>Get a Handle</h3>
<p>


Operating systems love their handles. These systems have all sorts of resources (processes, files, sockets, streams, etc.) and they need to know which one exactly are you talking about when you ask some of these. They might not want to give you the exact thing because of the opaque API or some other reasons, so they give you a handle. Internally, handles might be something like a index in some lookup table or pointers in the kernel, but we really don't care.

</p><p>

In order to get our file handle, we need to call [CreateFileA], which is a general purpose function for this thing. <code>CreateFileA</code> is used to create new files, open existing files, for all sorts of purposes, and it allows you, the programmer, specify which purpose are you after using its various parameters.
    * <code>lpFileName</code>: file name, we have our <code>Filename</code> which we simply pass. 
    * <code>dwDesiredAccess</code>: what you want to do with the file. For reading, we want a <code>GENERIC_READ</code>. 
    * <code>dwShareMode</code>: It's essentially a <em class="underscore">lock</em>. Windows uses this flag to know if many people can access the same file, and what can they do with it. We are fine with sharing the read permissions, but not writing or deletion, so that the file isn't removed from under our feet during the following operations. We thus specify the flag <code>FILE_SHARE_READ</code>.
    * <code>lpSecurityAttributes</code>: This can be used to be able to pass, for example, the handle to another process. We don't really care about it, so we pass <code>0</code> (or <code>NULL</code> if that's your cup of tea). 
    * <code>dwCreationDisposition</code>: This complicated-sounding parameter tells Windows what it should do if the file with that name already exists (or doesn't). For reading, we want to specify <code>OPEN_EXISTING</code> which will attempt to open a file if it exists. 
    * <code>dwFlagsAndAttributes</code>: Whether you want the file (if you create it) to be read-only/hidden/etc, as well as some other special system flags. We don't really care about it for reading, <code>0</code>. 
    * <code>hTemplateFile</code>: Not something we care about,<code>0</code> once again. 

</p><p>

<code>CreateFileA</code> will return <code>INVALID_HANDLE_VALUE</code> if it fails for any reason (file doesn't exist, it's locked, or what have you), so we can check the resulting handle if it's valid (and eventually handle errors if it's not).

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">internal debug_read_file_result </span>
<span class="line"><span class="hljs-title">DEBUGPlatformReadEntireFile</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *Filename)</span></span>
<span class="line"></span>{</span>
<span class="line">    debug_read_file_result Result = {};</span><div class=" edit"><span class="line">    HANDLE FileHandle = CreateFileA(Filename, GENERIC_READ, FILE_SHARE_READ, <span class="hljs-number">0</span>, OPEN_EXISTING, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);</span></div><div class=" add"><span class="line">    <span class="hljs-keyword">if</span> (FileHandle != INVALID_HANDLE_VALUE)</span>
<span class="line">    {</span></div><span class="line">        GetFileSizeEx();</span>
<span class="line">        VirtualAlloc();</span>
<span class="line">        ReadFile();</span>
<span class="line">        CloseHandle();</span><div class=" add"><span class="line">    }</span>
<span class="line">    <span class="hljs-keyword">else</span></span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// Error: handle creation failed</span></span>
<span class="line">        <span class="hljs-comment">// TODO(casey): Logging</span></span>
<span class="line">    }</span></div><span class="line">    <span class="hljs-keyword">return</span> (Result);</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;8:</b> <file>[win32_handmade.cpp > DEBUGPlatformReadEntireFile]</file> Getting the File Handle.</div></center>

<a class="target" name="getfilesize">&nbsp;</a><a class="target" name="platformimplementation/readfile/getfilesize">&nbsp;</a><a class="target" name="toc2.2.2">&nbsp;</a><h3>Get File Size</h3>
<p>


Now that we have a valid handle to the file, we can ask the system how big that file is. We will call <a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-getfilesizeex">GetFileSizeEx</a> for it. Why not <code>GetFileSize</code>? <code>GetFileSize</code> is the original version of the call which should still work with the old legacy programs. If you have a file bigger than ~4GB, you'll need to do some additional operations to get the final size. <code>GetFileSizeEx</code> (&ldquo;Ex&rdquo; standing for &ldquo;Extended&rdquo;), on the other hand, fills out a <code>LARGE_INTEGER</code> value the address of which you pass to the function. 

</p><p>

We've already seen <code>LARGE_INTEGER</code>s in <a href="../html/day10.html">day 10</a>. We're looking for the <code>FileSize.QuadPart</code> which is the combined 64-bit value representing the file size. The result of this function is a handy <code>BOOL</code> which we can use to make sure the function executed properly.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">if</span> (FileHandle != INVALID_HANDLE_VALUE)</span>
<span class="line">{</span><div class=" add"><span class="line">    LARGE_INTEGER FileSize;</span></div><div class=" edit"><span class="line">    <span class="hljs-keyword">if</span>(GetFileSizeEx(FileHandle, &amp;FileSize))</span></div><div class=" add"><span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// FileSize.QuadPart is the 64-bit value of the size.</span></span></div><span class="line">        VirtualAlloc();</span>
<span class="line">        ReadFile();</span><div class=" add"><span class="line">    }</span>
<span class="line">    <span class="hljs-keyword">else</span></span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// Error: File size evaluation failed</span></span>
<span class="line">        <span class="hljs-comment">// TODO(casey): Logging</span></span>
<span class="line">    }</span></div><span class="line">    CloseHandle(); </span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span></span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// Error: handle creation failed</span></span>
<span class="line">    <span class="hljs-comment">// TODO(casey): Logging</span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;9:</b> <file>[win32_handmade.cpp > DEBUGPlatformReadEntireFile]</file> Getting the File Size. We want to close the handle no matter what if we opened it, that's why it remains outside that block.</div></center>
<p>


We don't want to store the <code>FileSize</code> as our <code>ContentsSize</code> just yet; we'll return to it in a short while.

</p>
<a class="target" name="allocatefilememory">&nbsp;</a><a class="target" name="platformimplementation/readfile/allocatefilememory">&nbsp;</a><a class="target" name="toc2.2.3">&nbsp;</a><h3>Allocate File Memory</h3>
<p>


You should be intimately familiar with <code>VirtualAlloc</code> by now. It's exactly as simple as you can imagine: Get the file size and allocate memory for it. That said, we wouldn't want to use <code>VirtualAlloc</code> in our final code, since it only reserves memory in large chunks. But for our debug code it's perfectly fine.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">if</span>(GetFileSizeEx(FileHandle, &amp;FileSize))</span>
<span class="line">{</span><div class=" edit"><span class="line">    Result.Contents = VirtualAlloc(<span class="hljs-number">0</span>, FileSize.QuadPart, MEM_RESERVE|MEM_COMMIT, PAGE_READWRITE);</span></div><div class=" add"><span class="line">    <span class="hljs-keyword">if</span> (Result.Contents)</span>
<span class="line">    {</span></div><span class="line">        ReadFile();</span><div class=" add"><span class="line">    }</span>
<span class="line">    <span class="hljs-keyword">else</span></span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// Error: Memory allocation failed</span></span>
<span class="line">        <span class="hljs-comment">// TODO(casey): Logging</span></span>
<span class="line">    }</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;10:</b> <file>[win32_handmade.cpp > DEBUGPlatformReadEntireFile]</file> Getting the memory.</div></center>

<a class="target" name="readthefilecontents">&nbsp;</a><a class="target" name="platformimplementation/readfile/readthefilecontents">&nbsp;</a><a class="target" name="toc2.2.4">&nbsp;</a><h3>Read the File Contents</h3>
<p>


Now we finally can do what we came for... read the file. We do it using the <a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-readfile">ReadFile</a> function.

</p><p>

<ul>
    <li class="asterisk"><code>hFile</code>: Our file handle.
</li>
    <li class="asterisk"><code>lpBuffer</code>: Memory we've just reserved with <code>VirtualAlloc</code>. 
</li>
    <li class="asterisk"><code>nNumberOfBytesToRead</code>: How many bytes we want to read. We'll return to it in a second.
</li>
    <li class="asterisk"><code>lpNumberOfBytesRead</code>: pointer to a value which will store how many bytes we actually read.
</li>
    <li class="asterisk"><code>lpOverlapped</code>: an optional flag which would allow us to have this read asynchronously. We aren't there yet, so just pass <code>0</code>.

</p><p>

</li></ul>
    Function returns a <code>BOOL</code> so we can verify that the read was successful. We can then to &ldquo;further nest into success&rdquo; so that if necessary we can confirm it. While we're at it, we can also make sure that the size we want to read corresponds to the bytes we've read. Once we finished reading, we'll set the <code>ContentsSize</code> to how many bytes we've read.

</p><pre class="listing tilde"><code><span class="line">Result.Contents = VirtualAlloc(...);</span>
<span class="line"><span class="hljs-keyword">if</span> (Result.Contents)</span>
<span class="line">{</span><div class=" add"><span class="line">    DWORD BytesRead;</span></div><div class=" edit"><span class="line">    <span class="hljs-keyword">if</span> (ReadFile(FileHandle, Result.Contents, FileSize.QuadPart, &amp;BytesRead, <span class="hljs-number">0</span>) &amp;&amp;</span></div><div class=" add"><span class="line">            (FileSize.QuadPart == BytesRead))</span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// NOTE(casey): File read successfully</span></span>
<span class="line">        Result.ContentsSize = BytesRead;</span>
<span class="line">    }</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;11:</b> <file>[win32_handmade.cpp > DEBUGPlatformReadEntireFile]</file> Reading file contents.</div></center>
<p>


The read can fail (for all sorts of reasons). In such case we should free the memory we reserved just beforehand. We will also set the <code>Result.Contents</code> pointer back to <code>0</code>, since <code>DEBUGPlatformFreeMemory</code> doesn't do it for us.

</p><pre class="listing tilde"><code><span class="line">DWORD BytesRead;</span>
<span class="line"><span class="hljs-keyword">if</span> (ReadFile(...))</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// NOTE(casey): File read successfully</span></span>
<span class="line">    Result.ContentsSize = BytesRead;</span>
<span class="line">}</span><div class=" add"><span class="line"><span class="hljs-keyword">else</span></span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// Error: Read failed</span></span>
<span class="line">    DEBUGPlatformFreeFileMemory(Result.Contents);</span>
<span class="line">    Result.Contents = <span class="hljs-number">0</span>;</span>
<span class="line">    <span class="hljs-comment">// TODO(casey): Logging</span></span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;12:</b> <file>[win32_handmade.cpp > DEBUGPlatformReadEntireFile]</file> Handling read failure.</div></center>
<p>




<div class="admonition note"><div class="admonition-title"> About <code>nNumberOfBytesToRead</code></div>

</p><p>

    If you read the <a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-readfile">documentation</a> carefully, you'll notice that <code>nNumberOfBytesToRead</code> is a <code>DWORD</code>, which is a Win32 type for <code>32 unsigned int</code>. 

</p><p>

    This means that, even if we got the 64-bit file size, <code>ReadFile</code> only supports reading up to 32 bits of size (~4GB). If the file were larger than 32 bits, you'd actually need to loop over and do multiple reads. In our debug code we don't really care since we don't expect won't work with big files using debug functions. That said, we'll do the safe truncation described in subsection  <a href="#toc6.1">6.1</a>!</div>

</p>
<a class="target" name="closehandle">&nbsp;</a><a class="target" name="platformimplementation/readfile/closehandle">&nbsp;</a><a class="target" name="toc2.2.5">&nbsp;</a><h3>Close Handle</h3>
<p>


Finally, whether we succeeded in reading the file or not, we should always remember to close the handle. Failing to do so will result in all sorts of nastiness. <code>CloseHandle</code> is a simple call which only takes the handle.

</p><pre class="listing tilde"><code><span class="line">HANDLE FileHandle = CreateFileA(...);</span>
<span class="line"><span class="hljs-keyword">if</span> (FileHandle != INVALID_HANDLE_VALUE)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">//...</span></span><div class=" edit"><span class="line">    CloseHandle(FileHandle);</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;13:</b> <file>[win32_handmade.cpp > DEBUGPlatformReadEntireFile]</file> Closing the file handle.</div></center>

<a class="target" name="writefile">&nbsp;</a><a class="target" name="platformimplementation/writefile">&nbsp;</a><a class="target" name="toc2.3">&nbsp;</a><h2>Write file</h2>
<p>


<code>DEBUGPlatformWriteEntireFile</code> is quite similar to <code>ReadEntireFile</code>. In fact, we can simply copy the call and edit the things that we don't need:

</p><p>

<ul>
<li class="asterisk">When we get the file handle, we request:
<ul>
    <li class="asterisk"><code>GENERIC_WRITE</code> instead of <code>GENERIC_READ</code>
</li>
    <li class="asterisk">no file sharing (<code>0</code>)
</li>
    <li class="asterisk"><code>CREATE_ALWAYS</code> instead of <code>OPEN_EXISTING</code>
</li></ul>
<li class="asterisk">We don't need to get the file size or allocate any memory.
</li>
<li class="asterisk">Instead of <code>ReadFile</code>, we call <a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-writefile">WriteFile</a> function. It takes exactly the same parameters as <code>ReadFile</code>.

</p><p>

</li>
<li class="asterisk">If we succeeded to <code>WriteFile</code>, we'll compare whether the <code>BytesWritten</code> correspond to <code>MemorySize</code> - this comparison will produce <code>true</code> or <code>false</code> which we can capture as the result.</li></ul>

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">internal debug_read_file_result</span>
<span class="line"><span class="hljs-title">DEBUGPlatformReadEntireFile</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *Filename)</span></span>
<span class="line"></span>{</span>
<span class="line">    <span class="hljs-comment">//... </span></span>
<span class="line">}</span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-function">internal b32</span>
<span class="line"><span class="hljs-title">DEBUGPlatformWriteEntireFile</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *Filename, u32 MemorySize, <span class="hljs-keyword">void</span> *Memory)</span></span>
<span class="line"></span>{</span>
<span class="line">    b32 Result = <span class="hljs-literal">false</span>;</span>
<span class="line">    </span>
<span class="line">    HANDLE FileHandle = CreateFileA(Filename, GENERIC_WRITE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, CREATE_ALWAYS, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);</span>
<span class="line">    <span class="hljs-keyword">if</span>(FileHandle != INVALID_HANDLE_VALUE)</span>
<span class="line">    {</span>
<span class="line">        DWORD BytesWritten;</span>
<span class="line">        <span class="hljs-keyword">if</span>(WriteFile(FileHandle, Memory, MemorySize, &amp;BytesWritten, <span class="hljs-number">0</span>))</span>
<span class="line">        {</span>
<span class="line">            <span class="hljs-comment">// NOTE(casey): File written successfully</span></span>
<span class="line">            Result = (BytesWritten == MemorySize);</span>
<span class="line">        }</span>
<span class="line">        <span class="hljs-keyword">else</span></span>
<span class="line">        {</span>
<span class="line">            <span class="hljs-comment">// Error: Write failed</span></span>
<span class="line">            <span class="hljs-comment">// TODO(casey): Logging</span></span>
<span class="line">        }</span>
<span class="line">        CloseHandle(FileHandle);</span>
<span class="line">    }</span>
<span class="line">    <span class="hljs-keyword">else</span></span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// Error: Handle creation failed</span></span>
<span class="line">        <span class="hljs-comment">// TODO(casey): Logging</span></span>
<span class="line">    }</span>
<span class="line">    </span>
<span class="line">    <span class="hljs-keyword">return</span>(Result);</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;14:</b> <file>[win32_handmade.cpp]</file> Defining write file function.</div></center>
<p>




<div class="admonition warning"><div class="admonition-title"> Important</div>

</p><p>

    We said it already, but this write is NOT for doing anything in the shipping game - such a write is blocking and doesn't protect against lost data. Overwrite could fail, leaving the user with a corrupted save file. 

</p><p>

    In a similar situation what we'll want to do is to write to a different file and either have a rolling buffer scheme where you have an A and a B file, and you write to them interchangeably, or you write to a secondary temp file, release the old file and rename the new file. (Rename can also fail but at least you know you won't run out of space so it's a lesser of two evils).</div>

</p>
<a class="target" name="compileandtest">&nbsp;</a><a class="target" name="compileandtest">&nbsp;</a><a class="target" name="toc3">&nbsp;</a><h1>Compile and Test</h1>
<p>


We should now be compilable! Let's quickly test the changes.

</p><p>

<ol start=1>
<li class="number">Set the breakpoint (<code>F9</code>) at the beginning of your <code>GameUpdateAndRender</code> function. 
</li>
<li class="number">Step into (<code>F11</code>) <code>DEBUGPlatformReadEntireFile</code>.
</li>
<li class="number">Step over (<code>F10</code>) all the lines in <code>DEBUGPlatformReadEntireFile</code> until you (hopefully) arrive the its core. You should successfully read the contents of the file. 
</li>
<li class="number">Step over until the return of the function.
</li>
<li class="number">Once back in <code>GameUpdateAndRender</code>, add <code>FileData</code> to the <code>Watch</code> window. 
</li>
<li class="number">Open the structure in the Watch window, copy the value of <code>Contents</code> and paste it in the <code>Memory</code> window (some debuggers also allow typing directly the variable name, i.e. <code>FileData.Contents</code>).</li></ol>

</p><p>

<center><div class="image" style=""><a href="../media/day15/debug.jpg" target="_blank"><img class="markdeep" src="../media/day15/debug.jpg" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;3:</b> Inspecting the file memory in the debugger.</span></center></div></center>

</p><p>

<ol start=7>
<li class="number">In the <code>Memory</code> window, you should see the contents of your memory. Next to them you'll also see their conversion to ASCII (if you don't see the ascii conversion, right click on the memory window and enable it, or resize the window). You'll notice that that's your file contents!
</li>
<li class="number">Step into <code>DEBUGPlatformWriteEntireFile</code>. 
</li>
<li class="number">If you open your Command Prompt, and type <code>dir</code> inside your <code>data</code> folder after each step, you'll notice that the file <code>test.out</code> will appear, but it will have zero size up until you close the handle.</li></ol>

</p><p>

<center><div class="image" style=""><a href="../media/day15/cmd.jpg" target="_blank"><img class="markdeep" src="../media/day15/cmd.jpg" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;4:</b> Inspecting the <code>data</code> folder in the command prompt.</span></center></div></center>

</p><p>

<ol start=10>
<li class="number">Step over <code>DEBUGPlatformFreeFileMemory</code>. You'll notice that the contents of <code>FileData.Contents</code> will disappear.</li></ol>

</p>
<a class="target" name="recap">&nbsp;</a><a class="target" name="recap">&nbsp;</a><a class="target" name="toc4">&nbsp;</a><h1>Recap</h1>
<p>


We made one simple but powerful addition to our code: we can now read and write from any file we want. It's nowhere near as robust as we want it to, yet we can achieve a lot more now for our debug purposes. 

</p><p>

Our platform code is finally complete for the first pass. We now can finish &ldquo;tightening the screws&rdquo; on the API, do the general cleanup and finally transition away into our game! 

</p>
<a class="target" name="programmingnotions">&nbsp;</a><a class="target" name="programmingnotions">&nbsp;</a><a class="target" name="toc5">&nbsp;</a><h1>Programming Notions</h1>

<a class="target" name="introtostructpacking">&nbsp;</a><a class="target" name="programmingnotions/introtostructpacking">&nbsp;</a><a class="target" name="toc5.1">&nbsp;</a><h2>Intro to Struct Packing</h2>
<p>


You've seen us create a number of structs already, big and small. We'll be working on many, many more in the future. But for now, let's compare these two structs: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A</span></span>
<span class="line">{</span></span>
<span class="line">    u8 X;</span>
<span class="line">    u32 Y;</span>
<span class="line">    u8 Z;</span>
<span class="line">    u8 U;</span>
<span class="line">    u8 V;</span>
<span class="line">};</span>
<span class="line"></span>
<span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">B</span> {</span></span>
<span class="line">    u32 Y;</span>
<span class="line">    u8 X;</span>
<span class="line">    u8 Z;</span>
<span class="line">    u8 U;</span>
<span class="line">    u8 V;</span>
<span class="line">};</span></code></pre><p>

You'll notice that these two structs are basically identical, except <code>Y</code> variable position changed. Does it matter for the struct? As it turns out, yes, order of struct components matters! struct <code>A</code> is in fact much bigger than struct <code>B</code>, 12 bytes vs. 8! 

</p><p>

It has to do with how C <em class="underscore">packs</em> and <em class="underscore">pads</em> the structs. Memory is cheap but performance? Not necessarily. If you have tens of thousands of these structs, any byte extra might be critical for the performance.

</p>
<a class="target" name="sideconsiderations">&nbsp;</a><a class="target" name="sideconsiderations">&nbsp;</a><a class="target" name="toc6">&nbsp;</a><h1>Side Considerations</h1>

<a class="target" name="safetruncation">&nbsp;</a><a class="target" name="sideconsiderations/safetruncation">&nbsp;</a><a class="target" name="toc6.1">&nbsp;</a><h2>Safe Truncation</h2>
<p>


If we pass a 64-bit value as a 32-bit parameter, the system will do what is known as &ldquo;implicit conversion&rdquo;, truncating away the upper 32 bits. This of course can be a problem if you have data in those upper 32 bits.

</p><p>

In our <code>DEBUGPlatformReadEntireFile</code>, we do such an implicit conversion from the 64-bit <code>FileSize.QuadPart</code> to the 32-bit <code>DWORD</code>. 

</p><p>

To make sure we didn't have anything in our upper bytes, we can <code>Assert</code> that our <code>QuadPart</code> isn't bigger than the maximum 32-bit value, <code>0xFFFFFFFF</code>. We can be even more explicit and <em class="underscore">cast</em> our value to (u32) ourselves.

</p><p>

Let's write a separate helper function, stored inside <code>handmade.h</code>, doing just that: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ArrayCount(Array) (sizeof(Array) / sizeof((Array)[0]))</span></span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-function"><span class="hljs-keyword">inline</span> u32</span>
<span class="line"><span class="hljs-title">SafeTruncateUInt64</span><span class="hljs-params">(u64 Value)</span></span>
<span class="line"></span>{</span>
<span class="line">    Assert(Value &lt;= <span class="hljs-number">0xFFFFFFFF</span>);</span>
<span class="line">    u32 Result = (u32)Value;</span>
<span class="line">    <span class="hljs-keyword">return</span> (Result);</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;15:</b> <file>[handmade.h]</file> Defining safe truncate of <code>u64</code>.</div></center>
<p>


We now can use this value in our code: 

</p><pre class="listing tilde"><code><span class="line">LARGE_INTEGER FileSize;</span>
<span class="line"><span class="hljs-keyword">if</span>(GetFileSizeEx(FileHandle, &amp;FileSize))</span>
<span class="line">{</span><div class=" add"><span class="line">    u32 FileSize32 = SafeTruncateUInt64(FileSize.QuadPart);</span></div><div class=" edit"><span class="line">    Result.Contents = VirtualAlloc(<span class="hljs-number">0</span>, FileSize32, MEM_RESERVE|MEM_COMMIT, PAGE_READWRITE);</span></div><span class="line">    <span class="hljs-keyword">if</span> (Result.Contents)</span>
<span class="line">    {</span>
<span class="line">        DWORD BytesRead;</span><div class=" edit"><span class="line">        <span class="hljs-keyword">if</span> (ReadFile(FileHandle, Result.Contents, FileSize32, &amp;BytesRead, <span class="hljs-number">0</span>) &amp;&amp;</span>
<span class="line">                (FileSize32 == BytesRead))</span></div><span class="line">        {</span>
<span class="line">            <span class="hljs-comment">//...</span></span>
<span class="line">        }</span>
<span class="line">    }</span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;16:</b> <file>[win32_handmade.cpp > DEBUGPlatformReadEntireFile]</file> Using our 32-bit file size.</div></center>
<p>


Why the assertion anyway? If this code is used in a way we didn't anticipate, we'll catch it in time before bigger issues arise. It's always good to catch issues at their source. Mysterious bugs happening in the middle of your multithreaded code are not fun to hunt for. 

</p><p>

<em class="underscore">(Continue to subsection  <a href="#toc2.1">2.1</a>)</em>

</p>
<a class="target" name="navigation">&nbsp;</a><a class="target" name="navigation">&nbsp;</a><a class="target" name="toc7">&nbsp;</a><h1>Navigation</h1>
<p>


Previous: <a href="../html/day14.html">Day 14. Platform-Independent Game Memory</a>

</p><p>

Previous: <a href="../html/day16.html">Day 16. Visual Studio Compiler Switches</a>

</p><p>

<a href="../index.md.html">Back to Index</a>

</p>
<div class="nonumberh1">Glossary </div>
<p>


<ul>
<li class="asterisk">Data streaming
</li>
<li class="asterisk">File I/O
</li>
<li class="asterisk">Implicit Conversion
</li>
<li class="asterisk">Thread safety</li></ul>

</p>
<div class="nonumberh1">MSDN </div>
<p>


<a href="https://docs.microsoft.com/en-us/windows/win32/api/handleapi/nf-handleapi-closehandle">CloseHandle</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea">CreateFileA</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-getfilesizeex">GetFileSizeEx</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-readfile">ReadFile</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc">VirtualAlloc</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualfree">VirtualFree</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-writefile">WriteFile</a>

</p>
<div class="nonumberh1">Articles</div>
<p>


<a href="https://gist.github.com/hellerbarde/2843375">Media latency</a>

</p><p>

<style class="fallback">
  body {
    visibility: hidden;
    font-family: sans-serif;
  }
</style>

</p><p>

<script>
  markdeepOptions = { tocStyle: 'long' };
  window.alreadyProcessedMarkdeep ||
    (document.body.style.visibility = 'visible');
</script>

</p><p>

</p></span><div id="mdContextMenu" style="visibility:hidden"></div><div class="markdeepFooter"><i>formatted by <a href="https://casual-effects.com/markdeep" style="color:#999">Markdeep&nbsp;1.10&nbsp;&nbsp;</a></i><div style="display:inline-block;font-size:13px;font-family:'Times New Roman',serif;vertical-align:middle;transform:translate(-3px,-1px)rotate(135deg);">&#x2712;</div></div>