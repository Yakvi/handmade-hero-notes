<meta charset="UTF-8"><meta http-equiv="content-type" content="text/html;charset=UTF-8"><meta name="viewport" content="width=600, initial-scale=1"><style>span.md {width: 800;display: inline-block;}body{max-width:680px;margin:auto;padding:20px;text-align:justify;line-height:140%; -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-smoothing:antialiased;color:#222;font-family:Palatino,Georgia,"Times New Roman",serif}</style><style>@media print{*{-webkit-print-color-adjust:exact;text-shadow:none !important}}body{counter-reset: h1 h2 h3 h4 h5 h6 paragraph}@page{margin:0;size:auto}#mdContextMenu{position:absolute;background:#383838;cursor:default;border:1px solid #999;color:#fff;padding:4px 0px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,"Helvetica Neue",sans-serif;font-size:85%;font-weight:600;border-radius:4px;box-shadow:0px 3px 10px rgba(0,0,0,35%)}#mdContextMenu div{padding:0px 20px}#mdContextMenu div:hover{background:#1659d1}.md code,.md pre{font-family:Menlo,Consolas,monospace;font-size:98%;text-align:left;line-height:140%}.md .mediumToc code,.md longToc code,.md .shortToc code,.md h1 code,.md h2 code,.md h3 code,.md h4 code,.md h5 code,.md h6 code{font-size:unset}.md div.title{font-size:26px;font-weight:800;line-height:120%;text-align:center}.md div.afterTitles{height:10px}.md div.subtitle{text-align:center}.md iframe.textinsert, .md object.textinsert,.md iframe:not(.markdeep){display:block;margin-top:10px;margin-bottom:10px;width:100%;height:75vh;border:1px solid #000;border-radius:4px;background:#f5f5f4}.md .image{display:inline-block}.md img{max-width:100%;page-break-inside:avoid}.md li{text-align:left;text-indent:0}.md pre.listing {width:100%;tab-size:4;-moz-tab-size:4;-o-tab-size:4;counter-reset:line;overflow-x:auto;resize:horizontal}.md pre.listing .linenumbers span.line:before{width:30px;margin-left:-28px;font-size:80%;text-align:right;counter-increment:line;content:counter(line);display:inline-block;padding-right:13px;margin-right:8px;color:#ccc}.md div.tilde{margin:20px 0 -10px;text-align:center}.md .imagecaption,.md .tablecaption,.md .listingcaption{display:inline-block;margin:7px 5px 12px;text-align:justify;font-style:italic}.md img.pixel{image-rendering:-moz-crisp-edges;image-rendering:pixelated}.md blockquote.fancyquote{margin:25px 0 25px;text-align:left;line-height:160%}.md blockquote.fancyquote::before{content:"“";color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-right:6px;vertical-align:-0.3em}.md span.fancyquote{font-size:118%;color:#777;font-style:italic}.md span.fancyquote::after{content:"”";font-style:normal;color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-left:6px;vertical-align:-0.3em}.md blockquote.fancyquote .author{width:100%;margin-top:10px;display:inline-block;text-align:right}.md small{font-size:60%}.md big{font-size:150%}.md div.title,contents,.md .tocHeader,.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .shortTOC,.md .mediumTOC,.nonumberh1,.nonumberh2,.nonumberh3,.nonumberh4,.nonumberh5,.nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;margin:13.4px 0 13.4px;padding:15px 0 3px;border-top:none;clear:both}.md .tocTop {display:none}.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .nonumberh1,.md .nonumberh2,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{page-break-after:avoid;break-after:avoid}.md svg.diagram{display:block;font-family:Menlo,Consolas,monospace;font-size:98%;text-align:center;stroke-linecap:round;stroke-width:2px;page-break-inside:avoid;stroke:#000;fill:#000}.md svg.diagram .opendot{fill:#fff}.md svg.diagram .shadeddot{fill:#CCC}.md svg.diagram .dotteddot{stroke:#000;stroke-dasharray:4;fill:none}.md svg.diagram text{stroke:none}@media print{@page{margin:1in 5mm;transform: scale(150%)}}@media print{.md .pagebreak{page-break-after:always;visibility:hidden}}.md a{font-family:Georgia,Palatino,'Times New Roman'}.md h1,.md .tocHeader,.md .nonumberh1{border-bottom:3px solid;font-size:20px;font-weight:bold;}.md h1,.md .nonumberh1{counter-reset: h2 h3 h4 h5 h6}.md h2,.md .nonumberh2{counter-reset: h3 h4 h5 h6;border-bottom:2px solid #999;color:#555;font-weight:bold;font-size:18px;}.md h3,.md h4,.md h5,.md h6,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;color:#555;font-size:16px;}.md h3{counter-reset:h4 h5 h6}.md h4{counter-reset:h5 h6}.md h5{counter-reset:h6}.md div.table{margin:16px 0 16px 0}.md table{border-collapse:collapse;line-height:140%;page-break-inside:avoid}.md table.table{margin:auto}.md table.calendar{width:100%;margin:auto;font-size:11px;font-family:Verdana,Helvetica,Arial,sans-serif}.md table.calendar th{font-size:16px}.md .today{background:#ECF8FA}.md .calendar .parenthesized{color:#999;font-style:italic}.md table.table th{color:#FFF;background-color:#AAA;border:1px solid #888;padding:8px 15px 8px 15px}.md table.table td{padding:5px 15px 5px 15px;border:1px solid #888}.md table.table tr:nth-child(even){background:#EEE}.md pre.tilde{border-top: 1px solid #CCC;border-bottom: 1px solid #CCC;padding: 5px 0 5px 20px;margin:0 0 0 0;background:#FCFCFC;page-break-inside:avoid}.md a.target{width:0px;height:0px;visibility:hidden;font-size:0px;display:inline-block}.md a:link, .md a:visited{color:#38A;text-decoration:none}.md a:link:hover{text-decoration:underline}.md dt{font-weight:700}.md dl>dd{margin-top:-8px; margin-bottom:8px}.md dl>table{margin:35px 0 30px}.md code{page-break-inside:avoid;} @media print{.md .listing code{white-space:pre-wrap}}.md .endnote{font-size:13px;line-height:15px;padding-left:10px;text-indent:-10px}.md .bib{padding-left:80px;text-indent:-80px;text-align:left}.markdeepFooter{font-size:9px;text-align:right;padding-top:80px;color:#999}.md .mediumTOC{float:right;font-size:12px;line-height:15px;border-left:1px solid #CCC;padding-left:15px;margin:15px 0px 15px 25px}.md .mediumTOC .level1{font-weight:600}.md .longTOC .level1{font-weight:600;display:block;padding-top:12px;margin:0 0 -20px}.md .shortTOC{text-align:center;font-weight:bold;margin-top:15px;font-size:14px}.md .admonition{position:relative;margin:1em 0;padding:.4rem 1rem;border-radius:.2rem;border-left:2.5rem solid rgba(68,138,255,.4);background-color:rgba(68,138,255,.15);}.md .admonition-title{font-weight:bold;border-bottom:solid 1px rgba(68,138,255,.4);padding-bottom:4px;margin-bottom:4px;margin-left: -1rem;padding-left:1rem;margin-right:-1rem;border-color:rgba(68,138,255,.4)}.md .admonition.tip{border-left:2.5rem solid rgba(50,255,90,.4);background-color:rgba(50,255,90,.15)}.md .admonition.tip::before{content:"\24d8";font-weight:bold;font-size:150%;position:relative;top:3px;color:rgba(26,128,46,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.tip>.admonition-title{border-color:rgba(50,255,90,.4)}.md .admonition.warn,.md .admonition.warning{border-left:2.5rem solid rgba(255,145,0,.4);background-color:rgba(255,145,0,.15)}.md .admonition.warn::before,.md .admonition.warning::before{content:"\26A0";font-weight:bold;font-size:150%;position:relative;top:2px;color:rgba(128,73,0,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.warn>.admonition-title,.md .admonition.warning>.admonition-title{border-color:rgba(255,145,0,.4)}.md .admonition.error{border-left: 2.5rem solid rgba(255,23,68,.4);background-color:rgba(255,23,68,.15)}.md .admonition.error>.admonition-title{border-color:rgba(255,23,68,.4)}.md .admonition.error::before{content: "\2612";font-family:"Arial";font-size:200%;position:relative;color:rgba(128,12,34,.8);top:-2px;left:-3rem;display:block;width:0;height:0}.md .admonition p:last-child{margin-bottom:0}.md li.checked,.md li.unchecked{list-style:none;overflow:visible;text-indent:-1.2em}.md li.checked:before,.md li.unchecked:before{content:"\2611";display:block;float:left;width:1em;font-size:120%}.md li.unchecked:before{content:"\2610"}</style><style>.md h1::before {
content:counter(h1) " ";
counter-increment: h1;margin-right:10px}.md h2::before {
content:counter(h1) "."counter(h2) " ";
counter-increment: h2;margin-right:10px}.md h3::before {
content:counter(h1) "."counter(h2) "."counter(h3) " ";
counter-increment: h3;margin-right:10px}.md h4::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) " ";
counter-increment: h4;margin-right:10px}.md h5::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) " ";
counter-increment: h5;margin-right:10px}.md h6::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) "."counter(h6) " ";
counter-increment: h6;margin-right:10px}</style><style>.hljs{display:block;overflow-x:auto;padding:0.5em;background:#fff;color:#000;-webkit-text-size-adjust:none}.hljs-comment{color:#006a00}.hljs-keyword{color:#02E}.hljs-literal,.nginx .hljs-title{color:#aa0d91}.method,.hljs-list .hljs-title,.hljs-tag .hljs-title,.setting .hljs-value,.hljs-winutils,.tex .hljs-command,.http .hljs-title,.hljs-request,.hljs-status,.hljs-name{color:#008}.hljs-envvar,.tex .hljs-special{color:#660}.hljs-string{color:#c41a16}.hljs-tag .hljs-value,.hljs-cdata,.hljs-filter .hljs-argument,.hljs-attr_selector,.apache .hljs-cbracket,.hljs-date,.hljs-regexp{color:#080}.hljs-sub .hljs-identifier,.hljs-pi,.hljs-tag,.hljs-tag .hljs-keyword,.hljs-decorator,.ini .hljs-title,.hljs-shebang,.hljs-prompt,.hljs-hexcolor,.hljs-rule .hljs-value,.hljs-symbol,.hljs-symbol .hljs-string,.hljs-number,.css .hljs-function,.hljs-function .hljs-title,.coffeescript .hljs-attribute{color:#A0C}.hljs-function .hljs-title{font-weight:bold;color:#000}.hljs-class .hljs-title,.smalltalk .hljs-class,.hljs-type,.hljs-typename,.hljs-tag .hljs-attribute,.hljs-doctype,.hljs-class .hljs-id,.hljs-built_in,.setting,.hljs-params,.clojure .hljs-attribute{color:#5c2699}.hljs-variable{color:#3f6e74}.css .hljs-tag,.hljs-rule .hljs-property,.hljs-pseudo,.hljs-subst{color:#000}.css .hljs-class,.css .hljs-id{color:#9b703f}.hljs-value .hljs-important{color:#ff7700;font-weight:bold}.hljs-rule .hljs-keyword{color:#c5af75}.hljs-annotation,.apache .hljs-sqbracket,.nginx .hljs-built_in{color:#9b859d}.hljs-preprocessor,.hljs-preprocessor *,.hljs-pragma{color:#643820}.tex .hljs-formula{background-color:#eee;font-style:italic}.diff .hljs-header,.hljs-chunk{color:#808080;font-weight:bold}.diff .hljs-change{background-color:#bccff9}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-comment .hljs-doctag{font-weight:bold}.method .hljs-id{color:#000}</style><style>div.title { padding-top: 40px; } div.afterTitles { height: 15px; }</style><meta charset="utf-8">
<link rel="stylesheet" href="../css/style.css">
<script type="text/x-mathjax-config">
MathJax.Hub.Register.StartupHook("TeX Jax Ready",function () {
  MathJax.Hub.Insert(MathJax.InputJax.TeX.Definitions.macros,{
    cancel: ["Extension","cancel"],
    bcancel: ["Extension","cancel"],
  });
});
</script>

<script type="text/x-mathjax-config">MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });</script><span style="display:none">$$\newcommand{\n}{\hat{n}}\newcommand{\thetai}{\theta_\mathrm{i}}\newcommand{\thetao}{\theta_\mathrm{o}}\newcommand{\d}[1]{\mathrm{d}#1}\newcommand{\w}{\hat{\omega}}\newcommand{\wi}{\w_\mathrm{i}}\newcommand{\wo}{\w_\mathrm{o}}\newcommand{\wh}{\w_\mathrm{h}}\newcommand{\Li}{L_\mathrm{i}}\newcommand{\Lo}{L_\mathrm{o}}\newcommand{\Le}{L_\mathrm{e}}\newcommand{\Lr}{L_\mathrm{r}}\newcommand{\Lt}{L_\mathrm{t}}\newcommand{\O}{\mathrm{O}}\newcommand{\degrees}{{^{\large\circ}}}\newcommand{\T}{\mathsf{T}}\newcommand{\mathset}[1]{\mathbb{#1}}\newcommand{\Real}{\mathset{R}}\newcommand{\Integer}{\mathset{Z}}\newcommand{\Boolean}{\mathset{B}}\newcommand{\Complex}{\mathset{C}}\newcommand{\un}[1]{\,\mathrm{#1}}$$
</span>
<span class="md"><p><title>Day 20. Debugging the Audio Sync</title><div class="title"> Day 20. Debugging the Audio Sync </div>

<div class="afterTitles"></div>
<em class="underscore">Video Length (including Q&A): <a href="https://hero.handmade.network/episode/code/day020/">2h46</a></em> 

</p><p>

Welcome to &ldquo;Handmade Hero Notes&rdquo;, the book where we follow the footsteps of <a href="https://handmadehero.org/">Handmade Hero</a> in making the complete game from scratch, with no external libraries. If you'd like to follow along, preorder the game on <a href="https://handmadehero.org/">handmadehero.org</a>, and you will receive access to the GitHub repository, containing complete source code (tagged day-by-day) as well as a variety of other useful resources.

</p><p>

Suppose you've got this far, congratulations! Debugging sound issues may well be among the most tedious tasks one would face (even if that's your cup of tea). However, we aren't out of the woods yet; the system we have in our hands right now is still much latent, and there's room for improvement even at this early stage. Sure, with the default sound API and the integrated sound module, audio is laggy. But what about the sound junkies who have powerful cards with close to zero latency on the sound output? We want to support them as well! And today, we need to think real hard to make it happen.

</p><p>

You might have noticed a trend throughout this series: think first, and type after. If you understand the code you're about to write at least on an assumption level, it will be much easier for you to translate your thoughts into good code. And the benefits don't stop here! You will actually be able to read and edit it after a while. That said, you never want to go too deep and define every single scrupulous detail in advance: at that point, you might as well write the code directly! Leave yourself some space for a good surprise.

</p><p>

Today, however, we will mix the two together. It's a complex topic that we can simplify by performing one step at a time instead of trying to do the whole thing at once. If we find out that we were incorrect initially, the fix shouldn't be too difficult to make.

</p>
<div class="longTOC"><p align="center">
    <span align="right"><a href="day19.html">Day 19</a></span>
    <a href="../index.html"><img src = "../media/logo.png"></a>
    <span align="left"><a href="day21.html">Day 21</a></span>
</p><p><a href="#" class="tocTop">(Top)</a><br/>
<a href="#deepdiveintotheissue" class="level1"><span class="tocNumber">1&nbsp; </span>Deep Dive into the Issue</a><br/>
&nbsp;&nbsp;<a href="#deepdiveintotheissue/definetheproblem" class="level2"><span class="tocNumber">1.1&nbsp; </span>Define the Problem</a><br/>
&nbsp;&nbsp;<a href="#deepdiveintotheissue/evaluatetheoptions" class="level2"><span class="tocNumber">1.2&nbsp; </span>Evaluate the Options</a><br/>
&nbsp;&nbsp;<a href="#deepdiveintotheissue/trackingaudiolatency" class="level2"><span class="tocNumber">1.3&nbsp; </span>Tracking Audio Latency</a><br/>
&nbsp;&nbsp;<a href="#deepdiveintotheissue/reviewtargetbytescalculation" class="level2"><span class="tocNumber">1.4&nbsp; </span>Review Target Bytes calculation</a><br/>
<a href="#implementthetwoaudiopaths" class="level1"><span class="tocNumber">2&nbsp; </span>Implement the Two Audio Paths</a><br/>
&nbsp;&nbsp;<a href="#implementthetwoaudiopaths/cleanuptheoldcode" class="level2"><span class="tocNumber">2.1&nbsp; </span>Clean Up the Old Code</a><br/>
&nbsp;&nbsp;<a href="#implementthetwoaudiopaths/changetargetcursorcalculation" class="level2"><span class="tocNumber">2.2&nbsp; </span>Change <code>TargetCursor</code> Calculation</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#implementthetwoaudiopaths/changetargetcursorcalculation/audiocardislowlatency" class="level3"><span class="tocNumber">2.2.1&nbsp; </span>AudioCardIsLowLatency</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#implementthetwoaudiopaths/changetargetcursorcalculation/expectedframeboundarybyte" class="level3"><span class="tocNumber">2.2.2&nbsp; </span>ExpectedFrameBoundaryByte</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#implementthetwoaudiopaths/changetargetcursorcalculation/expectedsoundbytesperframe" class="level3"><span class="tocNumber">2.2.3&nbsp; </span>ExpectedSoundBytesPerFrame</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#implementthetwoaudiopaths/changetargetcursorcalculation/safetybytes" class="level3"><span class="tocNumber">2.2.4&nbsp; </span>SafetyBytes</a><br/>
<a href="#introducegamegetsoundsamples" class="level1"><span class="tocNumber">3&nbsp; </span>Introduce <code>GameGetSoundSamples</code></a><br/>
<a href="#evenmoredebugging" class="level1"><span class="tocNumber">4&nbsp; </span>Even More Debugging</a><br/>
&nbsp;&nbsp;<a href="#evenmoredebugging/addglobalpausekey" class="level2"><span class="tocNumber">4.1&nbsp; </span>Add Global Pause Key</a><br/>
&nbsp;&nbsp;<a href="#evenmoredebugging/highlightlatestmarker" class="level2"><span class="tocNumber">4.2&nbsp; </span>Highlight Latest Marker</a><br/>
&nbsp;&nbsp;<a href="#evenmoredebugging/recordmorevalues" class="level2"><span class="tocNumber">4.3&nbsp; </span>Record More Values</a><br/>
&nbsp;&nbsp;<a href="#evenmoredebugging/displayexpectedframefliptime" class="level2"><span class="tocNumber">4.4&nbsp; </span>Display Expected Frame Flip Time</a><br/>
&nbsp;&nbsp;<a href="#evenmoredebugging/displayplaywindow" class="level2"><span class="tocNumber">4.5&nbsp; </span>Display Play Window</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#evenmoredebugging/displayplaywindow/fixingtheexpectedframeboundarybytecalculation." class="level3"><span class="tocNumber">4.5.1&nbsp; </span>Fixing the ExpectedFrameBoundaryByte calculation.</a><br/>
<a href="#recap" class="level1"><span class="tocNumber">5&nbsp; </span>Recap</a><br/>
<a href="#sideconsiderations" class="level1"><span class="tocNumber">6&nbsp; </span>Side Considerations</a><br/>
&nbsp;&nbsp;<a href="#sideconsiderations/bugfix:soundchangingpitch" class="level2"><span class="tocNumber">6.1&nbsp; </span>Bugfix: Sound Changing Pitch</a><br/>
<a href="#navigation" class="level1"><span class="tocNumber">7&nbsp; </span>Navigation</a><br/>
</p></div><a class="target" name="deepdiveintotheissue">&nbsp;</a><a class="target" name="deepdiveintotheissue">&nbsp;</a><a class="target" name="toc1">&nbsp;</a><h1>Deep Dive into the Issue</h1>

<a class="target" name="definetheproblem">&nbsp;</a><a class="target" name="deepdiveintotheissue/definetheproblem">&nbsp;</a><a class="target" name="toc1.1">&nbsp;</a><h2>Define the Problem</h2>
<p>


Let's go back to our favorite timeline chart. We have our video frames which update every &ldquo;frame flip&rdquo; until the game stops running.

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="288" width="496" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 8,96 L 8,128 " style="fill:none;"/>
<path d="M 8,160 L 8,192 " style="fill:none;"/>
<path d="M 136,96 L 136,128 " style="fill:none;"/>
<path d="M 136,160 L 136,192 " style="fill:none;"/>
<path d="M 192,96 L 192,128 " style="fill:none;"/>
<path d="M 224,48 L 224,64 " style="fill:none;"/>
<path d="M 248,96 L 248,128 " style="fill:none;"/>
<path d="M 280,48 L 280,64 " style="fill:none;"/>
<path d="M 304,96 L 304,136 " style="fill:none;"/>
<path d="M 304,160 L 304,192 " style="fill:none;"/>
<path d="M 360,96 L 360,128 " style="fill:none;"/>
<path d="M 416,112 L 416,128 " style="fill:none;"/>
<path d="M 416,160 L 416,192 " style="fill:none;"/>
<path d="M 160,64 L 168,64 " style="fill:none;"/>
<path d="M 216,64 L 224,64 " style="fill:none;"/>
<path d="M 272,64 L 280,64 " style="fill:none;"/>
<path d="M 328,64 L 336,64 " style="fill:none;"/>
<path d="M 8,112 L 320,112 " style="fill:none;"/>
<path d="M 344,112 L 456,112 " style="fill:none;"/>
<path d="M 192,160 L 208,192 " style="fill:none;"/>
<path d="M 248,160 L 264,192 " style="fill:none;"/>
<path d="M 328,48 L 336,64 " style="fill:none;"/>
<path d="M 168,64 L 176,48 " style="fill:none;"/>
<path d="M 344,192 L 360,160 " style="fill:none;"/>
<path d="M 160,64 C 143.2,64 144,80 144,80 " style="fill:none;"/>
<path d="M 168,64 C 184.8,64 184,80 184,80 " style="fill:none;"/>
<path d="M 216,64 C 199.2,64 200,80 200,80 " style="fill:none;"/>
<path d="M 224,64 C 240.8,64 240,80 240,80 " style="fill:none;"/>
<path d="M 272,64 C 255.2,64 256,80 256,80 " style="fill:none;"/>
<path d="M 280,64 C 296.8,64 296,80 296,80 " style="fill:none;"/>
<path d="M 328,64 C 311.2,64 312,80 312,80 " style="fill:none;"/>
<path d="M 336,64 C 352.8,64 352,80 352,80 " style="fill:none;"/>
<polygon points="464,112 452,106.4 452,117.6 "  style="stroke:none" transform="rotate(0,456,112 )"/>
<polygon points="424,160 412,154.4 412,165.6 "  style="stroke:none" transform="rotate(270,416,160 )"/>
<polygon points="368,160 356,154.4 356,165.6 "  style="stroke:none" transform="rotate(296.565051177078,360,160 )"/>
<polygon points="312,160 300,154.4 300,165.6 "  style="stroke:none" transform="rotate(270,304,160 )"/>
<polygon points="256,160 244,154.4 244,165.6 "  style="stroke:none" transform="rotate(243.43494882292202,248,160 )"/>
<polygon points="200,160 188,154.4 188,165.6 "  style="stroke:none" transform="rotate(243.43494882292202,192,160 )"/>
<polygon points="144,160 132,154.4 132,165.6 "  style="stroke:none" transform="rotate(270,136,160 )"/>
<polygon points="16,160 4,154.4 4,165.6 "  style="stroke:none" transform="rotate(270,8,160 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="168" y="4">N</text><text text-anchor="middle" x="176" y="4">e</text><text text-anchor="middle" x="184" y="4">x</text><text text-anchor="middle" x="192" y="4">t</text><text text-anchor="middle" x="208" y="4">F</text><text text-anchor="middle" x="216" y="4">r</text><text text-anchor="middle" x="224" y="4">a</text><text text-anchor="middle" x="232" y="4">m</text><text text-anchor="middle" x="240" y="4">e</text><text text-anchor="middle" x="256" y="4">P</text><text text-anchor="middle" x="264" y="4">r</text><text text-anchor="middle" x="272" y="4">e</text><text text-anchor="middle" x="280" y="4">p</text><text text-anchor="middle" x="288" y="4">a</text><text text-anchor="middle" x="296" y="4">r</text><text text-anchor="middle" x="304" y="4">a</text><text text-anchor="middle" x="312" y="4">t</text><text text-anchor="middle" x="320" y="4">i</text><text text-anchor="middle" x="328" y="4">o</text><text text-anchor="middle" x="336" y="4">n</text><text text-anchor="middle" x="104" y="20">(</text><text text-anchor="middle" x="112" y="20">U</text><text text-anchor="middle" x="120" y="20">s</text><text text-anchor="middle" x="128" y="20">e</text><text text-anchor="middle" x="136" y="20">r</text><text text-anchor="middle" x="152" y="20">I</text><text text-anchor="middle" x="160" y="20">n</text><text text-anchor="middle" x="168" y="20">p</text><text text-anchor="middle" x="176" y="20">u</text><text text-anchor="middle" x="184" y="20">t</text><text text-anchor="middle" x="200" y="20">p</text><text text-anchor="middle" x="208" y="20">r</text><text text-anchor="middle" x="216" y="20">o</text><text text-anchor="middle" x="224" y="20">c</text><text text-anchor="middle" x="232" y="20">e</text><text text-anchor="middle" x="240" y="20">s</text><text text-anchor="middle" x="248" y="20">s</text><text text-anchor="middle" x="256" y="20">i</text><text text-anchor="middle" x="264" y="20">n</text><text text-anchor="middle" x="272" y="20">g</text><text text-anchor="middle" x="280" y="20">,</text><text text-anchor="middle" x="296" y="20">W</text><text text-anchor="middle" x="304" y="20">o</text><text text-anchor="middle" x="312" y="20">r</text><text text-anchor="middle" x="320" y="20">l</text><text text-anchor="middle" x="328" y="20">d</text><text text-anchor="middle" x="344" y="20">u</text><text text-anchor="middle" x="352" y="20">p</text><text text-anchor="middle" x="360" y="20">d</text><text text-anchor="middle" x="368" y="20">a</text><text text-anchor="middle" x="376" y="20">t</text><text text-anchor="middle" x="384" y="20">e</text><text text-anchor="middle" x="392" y="20">,</text><text text-anchor="middle" x="104" y="36">G</text><text text-anchor="middle" x="112" y="36">r</text><text text-anchor="middle" x="120" y="36">a</text><text text-anchor="middle" x="128" y="36">p</text><text text-anchor="middle" x="136" y="36">h</text><text text-anchor="middle" x="144" y="36">i</text><text text-anchor="middle" x="152" y="36">c</text><text text-anchor="middle" x="160" y="36">s</text><text text-anchor="middle" x="176" y="36">r</text><text text-anchor="middle" x="184" y="36">e</text><text text-anchor="middle" x="192" y="36">n</text><text text-anchor="middle" x="200" y="36">d</text><text text-anchor="middle" x="208" y="36">e</text><text text-anchor="middle" x="216" y="36">r</text><text text-anchor="middle" x="224" y="36">i</text><text text-anchor="middle" x="232" y="36">n</text><text text-anchor="middle" x="240" y="36">g</text><text text-anchor="middle" x="256" y="36">a</text><text text-anchor="middle" x="264" y="36">n</text><text text-anchor="middle" x="272" y="36">d</text><text text-anchor="middle" x="288" y="36">w</text><text text-anchor="middle" x="296" y="36">r</text><text text-anchor="middle" x="304" y="36">i</text><text text-anchor="middle" x="312" y="36">t</text><text text-anchor="middle" x="320" y="36">i</text><text text-anchor="middle" x="328" y="36">n</text><text text-anchor="middle" x="336" y="36">g</text><text text-anchor="middle" x="352" y="36">A</text><text text-anchor="middle" x="360" y="36">u</text><text text-anchor="middle" x="368" y="36">d</text><text text-anchor="middle" x="376" y="36">i</text><text text-anchor="middle" x="384" y="36">o</text><text text-anchor="middle" x="392" y="36">)</text><text text-anchor="middle" x="448" y="100">t</text><text text-anchor="middle" x="456" y="100">i</text><text text-anchor="middle" x="464" y="100">m</text><text text-anchor="middle" x="472" y="100">e</text><text text-anchor="middle" x="328" y="116">.</text><text text-anchor="middle" x="336" y="116">.</text><text text-anchor="middle" x="136" y="148">0</text><text text-anchor="middle" x="192" y="148">1</text><text text-anchor="middle" x="248" y="148">2</text><text text-anchor="middle" x="296" y="148">.</text><text text-anchor="middle" x="304" y="148">.</text><text text-anchor="middle" x="312" y="148">.</text><text text-anchor="middle" x="360" y="148">N</text><text text-anchor="middle" x="8" y="212">g</text><text text-anchor="middle" x="16" y="212">a</text><text text-anchor="middle" x="24" y="212">m</text><text text-anchor="middle" x="32" y="212">e</text><text text-anchor="middle" x="128" y="212">f</text><text text-anchor="middle" x="136" y="212">i</text><text text-anchor="middle" x="144" y="212">r</text><text text-anchor="middle" x="152" y="212">s</text><text text-anchor="middle" x="160" y="212">t</text><text text-anchor="middle" x="200" y="212">N</text><text text-anchor="middle" x="208" y="212">e</text><text text-anchor="middle" x="216" y="212">x</text><text text-anchor="middle" x="224" y="212">t</text><text text-anchor="middle" x="240" y="212">f</text><text text-anchor="middle" x="248" y="212">r</text><text text-anchor="middle" x="256" y="212">a</text><text text-anchor="middle" x="264" y="212">m</text><text text-anchor="middle" x="272" y="212">e</text><text text-anchor="middle" x="288" y="212">i</text><text text-anchor="middle" x="296" y="212">s</text><text text-anchor="middle" x="312" y="212">d</text><text text-anchor="middle" x="320" y="212">i</text><text text-anchor="middle" x="328" y="212">s</text><text text-anchor="middle" x="336" y="212">p</text><text text-anchor="middle" x="344" y="212">l</text><text text-anchor="middle" x="352" y="212">a</text><text text-anchor="middle" x="360" y="212">y</text><text text-anchor="middle" x="368" y="212">e</text><text text-anchor="middle" x="376" y="212">d</text><text text-anchor="middle" x="416" y="212">g</text><text text-anchor="middle" x="424" y="212">a</text><text text-anchor="middle" x="432" y="212">m</text><text text-anchor="middle" x="440" y="212">e</text><text text-anchor="middle" x="8" y="228">s</text><text text-anchor="middle" x="16" y="228">t</text><text text-anchor="middle" x="24" y="228">a</text><text text-anchor="middle" x="32" y="228">r</text><text text-anchor="middle" x="40" y="228">t</text><text text-anchor="middle" x="48" y="228">s</text><text text-anchor="middle" x="128" y="228">f</text><text text-anchor="middle" x="136" y="228">r</text><text text-anchor="middle" x="144" y="228">a</text><text text-anchor="middle" x="152" y="228">m</text><text text-anchor="middle" x="160" y="228">e</text><text text-anchor="middle" x="248" y="228">&quot;</text><text text-anchor="middle" x="256" y="228">f</text><text text-anchor="middle" x="264" y="228">r</text><text text-anchor="middle" x="272" y="228">a</text><text text-anchor="middle" x="280" y="228">m</text><text text-anchor="middle" x="288" y="228">e</text><text text-anchor="middle" x="304" y="228">f</text><text text-anchor="middle" x="312" y="228">l</text><text text-anchor="middle" x="320" y="228">i</text><text text-anchor="middle" x="328" y="228">p</text><text text-anchor="middle" x="336" y="228">&quot;</text><text text-anchor="middle" x="416" y="228">e</text><text text-anchor="middle" x="424" y="228">x</text><text text-anchor="middle" x="432" y="228">i</text><text text-anchor="middle" x="440" y="228">t</text><text text-anchor="middle" x="448" y="228">s</text><text text-anchor="middle" x="8" y="244">r</text><text text-anchor="middle" x="16" y="244">u</text><text text-anchor="middle" x="24" y="244">n</text><text text-anchor="middle" x="32" y="244">n</text><text text-anchor="middle" x="40" y="244">i</text><text text-anchor="middle" x="48" y="244">n</text><text text-anchor="middle" x="56" y="244">g</text><text text-anchor="middle" x="128" y="244">i</text><text text-anchor="middle" x="136" y="244">s</text><text text-anchor="middle" x="152" y="244">d</text><text text-anchor="middle" x="160" y="244">i</text><text text-anchor="middle" x="168" y="244">s</text><text text-anchor="middle" x="176" y="244">p</text><text text-anchor="middle" x="184" y="244">l</text><text text-anchor="middle" x="192" y="244">a</text><text text-anchor="middle" x="200" y="244">y</text><text text-anchor="middle" x="208" y="244">e</text><text text-anchor="middle" x="216" y="244">d</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;1:</b> Game lifetime. Everything on it should be familiar to you by now.</div></center>

</p><p>

For the moment, we're aiming at 30 frames per second frequency of the frame flips. This means that every second (or every 1000 milliseconds), we output 30 frames. Thus each frame only has \(\frac{1000}{30} \approx 33.3\) milliseconds to do all the work. 

</p><p>

For each frame, we want to prepare the image and the sound of our next frame. In an ideal world, both would go out at the same time. 

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="256" width="496" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 8,80 L 8,112 " style="fill:none;"/>
<path d="M 40,104 L 40,160 " style="fill:none;"/>
<path d="M 120,0 L 120,32 " style="fill:none;"/>
<path d="M 120,64 L 120,128 " style="fill:none;"/>
<path d="M 152,0 L 152,32 " style="fill:none;"/>
<path d="M 232,80 L 232,96 " style="fill:none;"/>
<path d="M 344,80 L 344,96 " style="fill:none;"/>
<path d="M 120,0 L 152,0 " style="fill:none;"/>
<path d="M 120,32 L 152,32 " style="fill:none;"/>
<path d="M 8,96 L 456,96 " style="fill:none;"/>
<path d="M 40,144 L 104,144 " style="fill:none;"/>
<path d="M 104,144 C 120.8,144 120,128 120,128 " style="fill:none;"/>
<polygon points="464,96 452,90.4 452,101.6 "  style="stroke:none" transform="rotate(0,456,96 )"/>
<polygon points="128,104 116,98.4 116,109.6 "  style="stroke:none" transform="rotate(270,120,104 )"/>
<polygon points="48,104 36,98.4 36,109.6 "  style="stroke:none" transform="rotate(270,40,104 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="168" y="4">i</text><text text-anchor="middle" x="176" y="4">m</text><text text-anchor="middle" x="184" y="4">a</text><text text-anchor="middle" x="192" y="4">g</text><text text-anchor="middle" x="200" y="4">e</text><text text-anchor="middle" x="216" y="4">i</text><text text-anchor="middle" x="224" y="4">s</text><text text-anchor="middle" x="136" y="20">🕺</text><text text-anchor="middle" x="168" y="20">d</text><text text-anchor="middle" x="176" y="20">i</text><text text-anchor="middle" x="184" y="20">s</text><text text-anchor="middle" x="192" y="20">p</text><text text-anchor="middle" x="200" y="20">l</text><text text-anchor="middle" x="208" y="20">a</text><text text-anchor="middle" x="216" y="20">y</text><text text-anchor="middle" x="224" y="20">e</text><text text-anchor="middle" x="232" y="20">d</text><text text-anchor="middle" x="128" y="52">a</text><text text-anchor="middle" x="136" y="52">u</text><text text-anchor="middle" x="144" y="52">d</text><text text-anchor="middle" x="152" y="52">i</text><text text-anchor="middle" x="160" y="52">o</text><text text-anchor="middle" x="176" y="52">i</text><text text-anchor="middle" x="184" y="52">s</text><text text-anchor="middle" x="200" y="52">p</text><text text-anchor="middle" x="208" y="52">l</text><text text-anchor="middle" x="216" y="52">a</text><text text-anchor="middle" x="224" y="52">y</text><text text-anchor="middle" x="232" y="52">e</text><text text-anchor="middle" x="240" y="52">d</text><text text-anchor="middle" x="128" y="68">~</text><text text-anchor="middle" x="136" y="68">~</text><text text-anchor="middle" x="144" y="68">~</text><text text-anchor="middle" x="152" y="68">~</text><text text-anchor="middle" x="160" y="68">~</text><text text-anchor="middle" x="168" y="68">~</text><text text-anchor="middle" x="176" y="68">~</text><text text-anchor="middle" x="184" y="68">~</text><text text-anchor="middle" x="192" y="68">~</text><text text-anchor="middle" x="200" y="68">~</text><text text-anchor="middle" x="208" y="68">~</text><text text-anchor="middle" x="216" y="68">~</text><text text-anchor="middle" x="224" y="68">~</text><text text-anchor="middle" x="40" y="84">f</text><text text-anchor="middle" x="48" y="84">r</text><text text-anchor="middle" x="56" y="84">a</text><text text-anchor="middle" x="64" y="84">m</text><text text-anchor="middle" x="72" y="84">e</text><text text-anchor="middle" x="88" y="84">0</text><text text-anchor="middle" x="152" y="84">f</text><text text-anchor="middle" x="160" y="84">r</text><text text-anchor="middle" x="168" y="84">a</text><text text-anchor="middle" x="176" y="84">m</text><text text-anchor="middle" x="184" y="84">e</text><text text-anchor="middle" x="200" y="84">1</text><text text-anchor="middle" x="264" y="84">f</text><text text-anchor="middle" x="272" y="84">r</text><text text-anchor="middle" x="280" y="84">a</text><text text-anchor="middle" x="288" y="84">m</text><text text-anchor="middle" x="296" y="84">e</text><text text-anchor="middle" x="312" y="84">2</text><text text-anchor="middle" x="376" y="84">.</text><text text-anchor="middle" x="384" y="84">.</text><text text-anchor="middle" x="392" y="84">.</text><text text-anchor="middle" x="448" y="84">t</text><text text-anchor="middle" x="456" y="84">i</text><text text-anchor="middle" x="464" y="84">m</text><text text-anchor="middle" x="472" y="84">e</text><text text-anchor="middle" x="120" y="164">F</text><text text-anchor="middle" x="128" y="164">r</text><text text-anchor="middle" x="136" y="164">a</text><text text-anchor="middle" x="144" y="164">m</text><text text-anchor="middle" x="152" y="164">e</text><text text-anchor="middle" x="32" y="180">W</text><text text-anchor="middle" x="40" y="180">o</text><text text-anchor="middle" x="48" y="180">r</text><text text-anchor="middle" x="56" y="180">k</text><text text-anchor="middle" x="120" y="180">F</text><text text-anchor="middle" x="128" y="180">l</text><text text-anchor="middle" x="136" y="180">i</text><text text-anchor="middle" x="144" y="180">p</text><text text-anchor="middle" x="24" y="196">s</text><text text-anchor="middle" x="32" y="196">t</text><text text-anchor="middle" x="40" y="196">a</text><text text-anchor="middle" x="48" y="196">r</text><text text-anchor="middle" x="56" y="196">t</text><text text-anchor="middle" x="64" y="196">s</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;2:</b> Frame flip workflow in an ideal world.</div></center>

</p><p>

This work happens sometime after the frame begins: before we get started on rendering, we need to collect the user input, update our world state, etc. Even further still, we're currently writing audio just before the frame flip, at the last possible moment, in fact. The idea is that the moment we send something to the hardware, it will be reproduced to the user.

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="240" width="528" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 32,80 L 32,112 " style="fill:none;"/>
<path d="M 56,128 L 56,144 " style="fill:none;"/>
<path d="M 80,80 L 80,112 " style="fill:none;"/>
<path d="M 112,48 L 112,64 " style="fill:none;"/>
<path d="M 152,80 L 152,112 " style="fill:none;"/>
<path d="M 256,128 L 256,144 " style="fill:none;"/>
<path d="M 360,80 L 360,112 " style="fill:none;"/>
<path d="M 408,48 L 408,64 " style="fill:none;"/>
<path d="M 448,80 L 448,128 " style="fill:none;"/>
<path d="M 96,64 L 136,64 " style="fill:none;"/>
<path d="M 376,64 L 432,64 " style="fill:none;"/>
<path d="M 8,96 L 472,96 " style="fill:none;"/>
<path d="M 48,128 L 64,128 " style="fill:none;"/>
<path d="M 168,128 L 344,128 " style="fill:none;"/>
<path d="M 96,64 C 79.2,64 80,80 80,80 " style="fill:none;"/>
<path d="M 136,64 C 152.8,64 152,80 152,80 " style="fill:none;"/>
<path d="M 376,64 C 359.2,64 360,80 360,80 " style="fill:none;"/>
<path d="M 432,64 C 448.8,64 448,80 448,80 " style="fill:none;"/>
<path d="M 48,128 C 31.2,128 32,112 32,112 " style="fill:none;"/>
<path d="M 64,128 C 80.8,128 80,112 80,112 " style="fill:none;"/>
<path d="M 168,128 C 151.2,128 152,112 152,112 " style="fill:none;"/>
<path d="M 344,128 C 360.8,128 360,112 360,112 " style="fill:none;"/>
<polygon points="480,96 468,90.4 468,101.6 "  style="stroke:none" transform="rotate(0,472,96 )"/>
<polygon points="456,104 444,98.4 444,109.6 "  style="stroke:none" transform="rotate(270,448,104 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="64" y="20">U</text><text text-anchor="middle" x="72" y="20">p</text><text text-anchor="middle" x="80" y="20">d</text><text text-anchor="middle" x="88" y="20">a</text><text text-anchor="middle" x="96" y="20">t</text><text text-anchor="middle" x="104" y="20">e</text><text text-anchor="middle" x="120" y="20">g</text><text text-anchor="middle" x="128" y="20">a</text><text text-anchor="middle" x="136" y="20">m</text><text text-anchor="middle" x="144" y="20">e</text><text text-anchor="middle" x="160" y="20">w</text><text text-anchor="middle" x="168" y="20">o</text><text text-anchor="middle" x="176" y="20">r</text><text text-anchor="middle" x="184" y="20">l</text><text text-anchor="middle" x="192" y="20">d</text><text text-anchor="middle" x="64" y="36">P</text><text text-anchor="middle" x="72" y="36">r</text><text text-anchor="middle" x="80" y="36">e</text><text text-anchor="middle" x="88" y="36">p</text><text text-anchor="middle" x="96" y="36">a</text><text text-anchor="middle" x="104" y="36">r</text><text text-anchor="middle" x="112" y="36">e</text><text text-anchor="middle" x="128" y="36">f</text><text text-anchor="middle" x="136" y="36">o</text><text text-anchor="middle" x="144" y="36">r</text><text text-anchor="middle" x="160" y="36">r</text><text text-anchor="middle" x="168" y="36">e</text><text text-anchor="middle" x="176" y="36">n</text><text text-anchor="middle" x="184" y="36">d</text><text text-anchor="middle" x="192" y="36">e</text><text text-anchor="middle" x="200" y="36">r</text><text text-anchor="middle" x="400" y="36">w</text><text text-anchor="middle" x="408" y="36">a</text><text text-anchor="middle" x="416" y="36">i</text><text text-anchor="middle" x="424" y="36">t</text><text text-anchor="middle" x="464" y="84">r</text><text text-anchor="middle" x="472" y="84">e</text><text text-anchor="middle" x="480" y="84">p</text><text text-anchor="middle" x="488" y="84">e</text><text text-anchor="middle" x="496" y="84">a</text><text text-anchor="middle" x="504" y="84">t</text><text text-anchor="middle" x="416" y="148">f</text><text text-anchor="middle" x="424" y="148">r</text><text text-anchor="middle" x="432" y="148">a</text><text text-anchor="middle" x="440" y="148">m</text><text text-anchor="middle" x="448" y="148">e</text><text text-anchor="middle" x="464" y="148">f</text><text text-anchor="middle" x="472" y="148">l</text><text text-anchor="middle" x="480" y="148">i</text><text text-anchor="middle" x="488" y="148">p</text><text text-anchor="middle" x="24" y="164">g</text><text text-anchor="middle" x="32" y="164">a</text><text text-anchor="middle" x="40" y="164">t</text><text text-anchor="middle" x="48" y="164">h</text><text text-anchor="middle" x="56" y="164">e</text><text text-anchor="middle" x="64" y="164">r</text><text text-anchor="middle" x="80" y="164">i</text><text text-anchor="middle" x="88" y="164">n</text><text text-anchor="middle" x="96" y="164">p</text><text text-anchor="middle" x="104" y="164">u</text><text text-anchor="middle" x="112" y="164">t</text><text text-anchor="middle" x="240" y="164">R</text><text text-anchor="middle" x="248" y="164">e</text><text text-anchor="middle" x="256" y="164">n</text><text text-anchor="middle" x="264" y="164">d</text><text text-anchor="middle" x="272" y="164">e</text><text text-anchor="middle" x="280" y="164">r</text><text text-anchor="middle" x="8" y="180">(</text><text text-anchor="middle" x="16" y="180">k</text><text text-anchor="middle" x="24" y="180">e</text><text text-anchor="middle" x="32" y="180">y</text><text text-anchor="middle" x="40" y="180">b</text><text text-anchor="middle" x="48" y="180">o</text><text text-anchor="middle" x="56" y="180">a</text><text text-anchor="middle" x="64" y="180">r</text><text text-anchor="middle" x="72" y="180">d</text><text text-anchor="middle" x="80" y="180">,</text><text text-anchor="middle" x="96" y="180">m</text><text text-anchor="middle" x="104" y="180">o</text><text text-anchor="middle" x="112" y="180">u</text><text text-anchor="middle" x="120" y="180">s</text><text text-anchor="middle" x="128" y="180">e</text><text text-anchor="middle" x="136" y="180">,</text><text text-anchor="middle" x="40" y="196">g</text><text text-anchor="middle" x="48" y="196">a</text><text text-anchor="middle" x="56" y="196">m</text><text text-anchor="middle" x="64" y="196">e</text><text text-anchor="middle" x="72" y="196">p</text><text text-anchor="middle" x="80" y="196">a</text><text text-anchor="middle" x="88" y="196">d</text><text text-anchor="middle" x="96" y="196">)</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;3:</b> Breakdown of the work within a single frame. Proportions of game update/render times will differ. Of course, some of these tasks may run in parallel in the future.</div></center>

</p><p>

Unfortunately for us, hardware lag exists, so things do not happen immediately. Furthermore, DirectSound (on our specific machine) is not cooperating with us. Last time, we determined that the API has a delay of 30ms! That's, in fact, almost full frame! So this is what happens with our frames in reality: 

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="352" width="496" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 8,80 L 8,112 " style="fill:none;"/>
<path d="M 40,104 L 40,144 " style="fill:none;"/>
<path d="M 104,104 L 104,192 " style="fill:none;"/>
<path d="M 120,0 L 120,112 " style="fill:none;"/>
<path d="M 152,0 L 152,32 " style="fill:none;"/>
<path d="M 216,64 L 216,144 " style="fill:none;"/>
<path d="M 216,192 L 216,256 " style="fill:none;"/>
<path d="M 232,80 L 232,112 " style="fill:none;"/>
<path d="M 344,80 L 344,112 " style="fill:none;"/>
<path d="M 120,0 L 152,0 " style="fill:none;"/>
<path d="M 120,32 L 152,32 " style="fill:none;"/>
<path d="M 8,96 L 456,96 " style="fill:none;"/>
<path d="M 136,160 L 168,160 " style="fill:none;"/>
<path d="M 120,272 L 144,272 " style="fill:none;"/>
<path d="M 176,272 L 200,272 " style="fill:none;"/>
<path d="M 120,128 L 136,160 " style="fill:none;"/>
<path d="M 120,272 C 103.2,272 104,256 104,256 " style="fill:none;"/>
<path d="M 144,272 C 160.8,272 160,288 160,288 " style="fill:none;"/>
<path d="M 176,272 C 159.2,272 160,288 160,288 " style="fill:none;"/>
<path d="M 200,272 C 216.8,272 216,256 216,256 " style="fill:none;"/>
<polygon points="464,96 452,90.4 452,101.6 "  style="stroke:none" transform="rotate(0,456,96 )"/>
<polygon points="128,128 116,122.4 116,133.6 "  style="stroke:none" transform="rotate(243.43494882292202,120,128 )"/>
<polygon points="112,104 100,98.4 100,109.6 "  style="stroke:none" transform="rotate(270,104,104 )"/>
<polygon points="48,104 36,98.4 36,109.6 "  style="stroke:none" transform="rotate(270,40,104 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="168" y="4">i</text><text text-anchor="middle" x="176" y="4">m</text><text text-anchor="middle" x="184" y="4">a</text><text text-anchor="middle" x="192" y="4">g</text><text text-anchor="middle" x="200" y="4">e</text><text text-anchor="middle" x="216" y="4">i</text><text text-anchor="middle" x="224" y="4">s</text><text text-anchor="middle" x="136" y="20">🕺</text><text text-anchor="middle" x="168" y="20">d</text><text text-anchor="middle" x="176" y="20">i</text><text text-anchor="middle" x="184" y="20">s</text><text text-anchor="middle" x="192" y="20">p</text><text text-anchor="middle" x="200" y="20">l</text><text text-anchor="middle" x="208" y="20">a</text><text text-anchor="middle" x="216" y="20">y</text><text text-anchor="middle" x="224" y="20">e</text><text text-anchor="middle" x="232" y="20">d</text><text text-anchor="middle" x="224" y="52">a</text><text text-anchor="middle" x="232" y="52">u</text><text text-anchor="middle" x="240" y="52">d</text><text text-anchor="middle" x="248" y="52">i</text><text text-anchor="middle" x="256" y="52">o</text><text text-anchor="middle" x="272" y="52">i</text><text text-anchor="middle" x="280" y="52">s</text><text text-anchor="middle" x="296" y="52">p</text><text text-anchor="middle" x="304" y="52">l</text><text text-anchor="middle" x="312" y="52">a</text><text text-anchor="middle" x="320" y="52">y</text><text text-anchor="middle" x="328" y="52">e</text><text text-anchor="middle" x="336" y="52">d</text><text text-anchor="middle" x="224" y="68">~</text><text text-anchor="middle" x="232" y="68">~</text><text text-anchor="middle" x="240" y="68">~</text><text text-anchor="middle" x="248" y="68">~</text><text text-anchor="middle" x="256" y="68">~</text><text text-anchor="middle" x="264" y="68">~</text><text text-anchor="middle" x="272" y="68">~</text><text text-anchor="middle" x="280" y="68">~</text><text text-anchor="middle" x="288" y="68">~</text><text text-anchor="middle" x="296" y="68">~</text><text text-anchor="middle" x="304" y="68">~</text><text text-anchor="middle" x="312" y="68">~</text><text text-anchor="middle" x="320" y="68">~</text><text text-anchor="middle" x="40" y="84">f</text><text text-anchor="middle" x="48" y="84">r</text><text text-anchor="middle" x="56" y="84">a</text><text text-anchor="middle" x="64" y="84">m</text><text text-anchor="middle" x="72" y="84">e</text><text text-anchor="middle" x="88" y="84">0</text><text text-anchor="middle" x="144" y="84">f</text><text text-anchor="middle" x="152" y="84">r</text><text text-anchor="middle" x="160" y="84">a</text><text text-anchor="middle" x="168" y="84">m</text><text text-anchor="middle" x="176" y="84">e</text><text text-anchor="middle" x="192" y="84">1</text><text text-anchor="middle" x="264" y="84">f</text><text text-anchor="middle" x="272" y="84">r</text><text text-anchor="middle" x="280" y="84">a</text><text text-anchor="middle" x="288" y="84">m</text><text text-anchor="middle" x="296" y="84">e</text><text text-anchor="middle" x="312" y="84">2</text><text text-anchor="middle" x="376" y="84">.</text><text text-anchor="middle" x="384" y="84">.</text><text text-anchor="middle" x="392" y="84">.</text><text text-anchor="middle" x="448" y="84">t</text><text text-anchor="middle" x="456" y="84">i</text><text text-anchor="middle" x="464" y="84">m</text><text text-anchor="middle" x="472" y="84">e</text><text text-anchor="middle" x="32" y="164">W</text><text text-anchor="middle" x="40" y="164">o</text><text text-anchor="middle" x="48" y="164">r</text><text text-anchor="middle" x="56" y="164">k</text><text text-anchor="middle" x="176" y="164">e</text><text text-anchor="middle" x="184" y="164">x</text><text text-anchor="middle" x="192" y="164">p</text><text text-anchor="middle" x="200" y="164">e</text><text text-anchor="middle" x="208" y="164">c</text><text text-anchor="middle" x="216" y="164">t</text><text text-anchor="middle" x="224" y="164">e</text><text text-anchor="middle" x="232" y="164">d</text><text text-anchor="middle" x="24" y="180">s</text><text text-anchor="middle" x="32" y="180">t</text><text text-anchor="middle" x="40" y="180">a</text><text text-anchor="middle" x="48" y="180">r</text><text text-anchor="middle" x="56" y="180">t</text><text text-anchor="middle" x="64" y="180">s</text><text text-anchor="middle" x="168" y="180">f</text><text text-anchor="middle" x="176" y="180">r</text><text text-anchor="middle" x="184" y="180">a</text><text text-anchor="middle" x="192" y="180">m</text><text text-anchor="middle" x="200" y="180">e</text><text text-anchor="middle" x="216" y="180">f</text><text text-anchor="middle" x="224" y="180">l</text><text text-anchor="middle" x="232" y="180">i</text><text text-anchor="middle" x="240" y="180">p</text><text text-anchor="middle" x="72" y="212">S</text><text text-anchor="middle" x="80" y="212">e</text><text text-anchor="middle" x="88" y="212">n</text><text text-anchor="middle" x="96" y="212">d</text><text text-anchor="middle" x="112" y="212">a</text><text text-anchor="middle" x="120" y="212">u</text><text text-anchor="middle" x="128" y="212">d</text><text text-anchor="middle" x="136" y="212">i</text><text text-anchor="middle" x="144" y="212">o</text><text text-anchor="middle" x="56" y="228">s</text><text text-anchor="middle" x="64" y="228">a</text><text text-anchor="middle" x="72" y="228">m</text><text text-anchor="middle" x="80" y="228">p</text><text text-anchor="middle" x="88" y="228">l</text><text text-anchor="middle" x="96" y="228">e</text><text text-anchor="middle" x="104" y="228">s</text><text text-anchor="middle" x="120" y="228">t</text><text text-anchor="middle" x="128" y="228">o</text><text text-anchor="middle" x="144" y="228">t</text><text text-anchor="middle" x="152" y="228">h</text><text text-anchor="middle" x="160" y="228">e</text><text text-anchor="middle" x="48" y="244">O</text><text text-anchor="middle" x="56" y="244">p</text><text text-anchor="middle" x="64" y="244">e</text><text text-anchor="middle" x="72" y="244">r</text><text text-anchor="middle" x="80" y="244">a</text><text text-anchor="middle" x="88" y="244">t</text><text text-anchor="middle" x="96" y="244">i</text><text text-anchor="middle" x="104" y="244">n</text><text text-anchor="middle" x="112" y="244">g</text><text text-anchor="middle" x="128" y="244">S</text><text text-anchor="middle" x="136" y="244">y</text><text text-anchor="middle" x="144" y="244">s</text><text text-anchor="middle" x="152" y="244">t</text><text text-anchor="middle" x="160" y="244">e</text><text text-anchor="middle" x="168" y="244">m</text><text text-anchor="middle" x="72" y="308">W</text><text text-anchor="middle" x="80" y="308">i</text><text text-anchor="middle" x="88" y="308">n</text><text text-anchor="middle" x="96" y="308">d</text><text text-anchor="middle" x="104" y="308">o</text><text text-anchor="middle" x="112" y="308">w</text><text text-anchor="middle" x="120" y="308">s</text><text text-anchor="middle" x="128" y="308">/</text><text text-anchor="middle" x="136" y="308">H</text><text text-anchor="middle" x="144" y="308">a</text><text text-anchor="middle" x="152" y="308">r</text><text text-anchor="middle" x="160" y="308">d</text><text text-anchor="middle" x="168" y="308">w</text><text text-anchor="middle" x="176" y="308">a</text><text text-anchor="middle" x="184" y="308">r</text><text text-anchor="middle" x="192" y="308">e</text><text text-anchor="middle" x="208" y="308">r</text><text text-anchor="middle" x="216" y="308">o</text><text text-anchor="middle" x="224" y="308">u</text><text text-anchor="middle" x="232" y="308">t</text><text text-anchor="middle" x="240" y="308">e</text><text text-anchor="middle" x="256" y="308">a</text><text text-anchor="middle" x="264" y="308">u</text><text text-anchor="middle" x="272" y="308">d</text><text text-anchor="middle" x="280" y="308">i</text><text text-anchor="middle" x="288" y="308">o</text><text text-anchor="middle" x="104" y="324">f</text><text text-anchor="middle" x="112" y="324">o</text><text text-anchor="middle" x="120" y="324">r</text><text text-anchor="middle" x="136" y="324">r</text><text text-anchor="middle" x="144" y="324">e</text><text text-anchor="middle" x="152" y="324">p</text><text text-anchor="middle" x="160" y="324">r</text><text text-anchor="middle" x="168" y="324">o</text><text text-anchor="middle" x="176" y="324">d</text><text text-anchor="middle" x="184" y="324">u</text><text text-anchor="middle" x="192" y="324">c</text><text text-anchor="middle" x="200" y="324">t</text><text text-anchor="middle" x="208" y="324">i</text><text text-anchor="middle" x="216" y="324">o</text><text text-anchor="middle" x="224" y="324">n</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;4:</b> Frame flip workflow in our reality.</div></center>

</p><p>

As you can see, by the time audio starts playing, it's almost time for the next frame to flip! When we blindly assumed a low latency scenario, this created the audible clicks for us: information kept getting overwritten from under the Play Cursor. 

</p><p>

This means that, when we were writing audio, we were told to write way before it was safe. DirectSound API works on two cursors: Play Cursor and Write Cursor. The API reads the audio bytes from the area <em class="underscore">around</em> the Play Cursor, with the Write Cursor represents the first <em class="underscore">safe</em> point user can write to. We're ignoring the write cursor for the time being and write to wherever we feel appropriate to our needs. 

</p><p>

That's why we needed to add the additional frames of latency: simply to allow the write cursor to advance. Even further still, currently, we're asking for the cursor's location at the end of <em class="underscore">previous</em> frame. This means that, by the time we get to compute audio, the cursors have advanced even further, resulting in a whopping 3 frames of latency!

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="368" width="600" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 16,120 L 16,176 " style="fill:none;"/>
<path d="M 32,96 L 32,176 " style="fill:none;"/>
<path d="M 64,144 L 64,176 " style="fill:none;"/>
<path d="M 88,32 L 88,176 " style="fill:none;"/>
<path d="M 192,112 L 192,176 " style="fill:none;"/>
<path d="M 224,144 L 224,176 " style="fill:none;"/>
<path d="M 264,120 L 264,240 " style="fill:none;"/>
<path d="M 352,112 L 352,288 " style="fill:none;"/>
<path d="M 384,144 L 384,176 " style="fill:none;"/>
<path d="M 512,80 L 512,176 " style="fill:none;"/>
<path d="M 544,144 L 544,176 " style="fill:none;"/>
<path d="M 88,32 L 208,32 " style="fill:none;"/>
<path d="M 8,112 L 552,112 " style="fill:none;"/>
<path d="M 32,144 L 64,144 " style="fill:none;"/>
<path d="M 192,144 L 224,144 " style="fill:none;"/>
<path d="M 352,144 L 384,144 " style="fill:none;"/>
<path d="M 512,144 L 544,144 " style="fill:none;"/>
<path d="M 32,176 L 64,176 " style="fill:none;"/>
<path d="M 192,176 L 224,176 " style="fill:none;"/>
<path d="M 352,176 L 384,176 " style="fill:none;"/>
<path d="M 512,176 L 544,176 " style="fill:none;"/>
<polygon points="560,112 548,106.4 548,117.6 "  style="stroke:none" transform="rotate(0,552,112 )"/>
<polygon points="520,104 508,98.4 508,109.6 "  style="stroke:none" transform="rotate(90,512,104 )"/>
<polygon points="272,120 260,114.4 260,125.6 "  style="stroke:none" transform="rotate(270,264,120 )"/>
<polygon points="216,32 204,26.4 204,37.6 "  style="stroke:none" transform="rotate(0,208,32 )"/>
<polygon points="24,120 12,114.4 12,125.6 "  style="stroke:none" transform="rotate(270,16,120 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="216" y="20">&quot;</text><text text-anchor="middle" x="224" y="20">I</text><text text-anchor="middle" x="232" y="20">g</text><text text-anchor="middle" x="240" y="20">n</text><text text-anchor="middle" x="248" y="20">o</text><text text-anchor="middle" x="256" y="20">r</text><text text-anchor="middle" x="264" y="20">e</text><text text-anchor="middle" x="272" y="20">&quot;</text><text text-anchor="middle" x="288" y="20">t</text><text text-anchor="middle" x="296" y="20">h</text><text text-anchor="middle" x="304" y="20">e</text><text text-anchor="middle" x="320" y="20">W</text><text text-anchor="middle" x="328" y="20">r</text><text text-anchor="middle" x="336" y="20">i</text><text text-anchor="middle" x="344" y="20">t</text><text text-anchor="middle" x="352" y="20">e</text><text text-anchor="middle" x="360" y="20">C</text><text text-anchor="middle" x="368" y="20">u</text><text text-anchor="middle" x="376" y="20">r</text><text text-anchor="middle" x="384" y="20">s</text><text text-anchor="middle" x="392" y="20">o</text><text text-anchor="middle" x="400" y="20">r</text><text text-anchor="middle" x="416" y="20">a</text><text text-anchor="middle" x="424" y="20">n</text><text text-anchor="middle" x="432" y="20">d</text><text text-anchor="middle" x="448" y="20">d</text><text text-anchor="middle" x="456" y="20">e</text><text text-anchor="middle" x="464" y="20">f</text><text text-anchor="middle" x="472" y="20">i</text><text text-anchor="middle" x="480" y="20">n</text><text text-anchor="middle" x="488" y="20">e</text><text text-anchor="middle" x="504" y="20">o</text><text text-anchor="middle" x="512" y="20">u</text><text text-anchor="middle" x="520" y="20">r</text><text text-anchor="middle" x="536" y="20">o</text><text text-anchor="middle" x="544" y="20">w</text><text text-anchor="middle" x="552" y="20">n</text><text text-anchor="middle" x="224" y="36">T</text><text text-anchor="middle" x="232" y="36">a</text><text text-anchor="middle" x="240" y="36">r</text><text text-anchor="middle" x="248" y="36">g</text><text text-anchor="middle" x="256" y="36">e</text><text text-anchor="middle" x="264" y="36">t</text><text text-anchor="middle" x="272" y="36">C</text><text text-anchor="middle" x="280" y="36">u</text><text text-anchor="middle" x="288" y="36">r</text><text text-anchor="middle" x="296" y="36">s</text><text text-anchor="middle" x="304" y="36">o</text><text text-anchor="middle" x="312" y="36">r</text><text text-anchor="middle" x="328" y="36">b</text><text text-anchor="middle" x="336" y="36">a</text><text text-anchor="middle" x="344" y="36">s</text><text text-anchor="middle" x="352" y="36">e</text><text text-anchor="middle" x="360" y="36">d</text><text text-anchor="middle" x="376" y="36">o</text><text text-anchor="middle" x="384" y="36">n</text><text text-anchor="middle" x="400" y="36">e</text><text text-anchor="middle" x="408" y="36">x</text><text text-anchor="middle" x="416" y="36">p</text><text text-anchor="middle" x="424" y="36">e</text><text text-anchor="middle" x="432" y="36">c</text><text text-anchor="middle" x="440" y="36">t</text><text text-anchor="middle" x="448" y="36">e</text><text text-anchor="middle" x="456" y="36">d</text><text text-anchor="middle" x="472" y="36">f</text><text text-anchor="middle" x="480" y="36">r</text><text text-anchor="middle" x="488" y="36">a</text><text text-anchor="middle" x="496" y="36">m</text><text text-anchor="middle" x="504" y="36">e</text><text text-anchor="middle" x="520" y="36">f</text><text text-anchor="middle" x="528" y="36">l</text><text text-anchor="middle" x="536" y="36">i</text><text text-anchor="middle" x="544" y="36">p</text><text text-anchor="middle" x="552" y="36">;</text><text text-anchor="middle" x="216" y="52">o</text><text text-anchor="middle" x="224" y="52">f</text><text text-anchor="middle" x="232" y="52">f</text><text text-anchor="middle" x="240" y="52">s</text><text text-anchor="middle" x="248" y="52">e</text><text text-anchor="middle" x="256" y="52">t</text><text text-anchor="middle" x="272" y="52">i</text><text text-anchor="middle" x="280" y="52">t</text><text text-anchor="middle" x="296" y="52">b</text><text text-anchor="middle" x="304" y="52">y</text><text text-anchor="middle" x="320" y="52">a</text><text text-anchor="middle" x="336" y="52">s</text><text text-anchor="middle" x="344" y="52">p</text><text text-anchor="middle" x="352" y="52">e</text><text text-anchor="middle" x="360" y="52">c</text><text text-anchor="middle" x="368" y="52">i</text><text text-anchor="middle" x="376" y="52">f</text><text text-anchor="middle" x="384" y="52">i</text><text text-anchor="middle" x="392" y="52">c</text><text text-anchor="middle" x="408" y="52">l</text><text text-anchor="middle" x="416" y="52">a</text><text text-anchor="middle" x="424" y="52">t</text><text text-anchor="middle" x="432" y="52">e</text><text text-anchor="middle" x="440" y="52">n</text><text text-anchor="middle" x="448" y="52">c</text><text text-anchor="middle" x="456" y="52">y</text><text text-anchor="middle" x="472" y="52">t</text><text text-anchor="middle" x="480" y="52">o</text><text text-anchor="middle" x="496" y="52">a</text><text text-anchor="middle" x="504" y="52">l</text><text text-anchor="middle" x="512" y="52">w</text><text text-anchor="middle" x="520" y="52">a</text><text text-anchor="middle" x="528" y="52">y</text><text text-anchor="middle" x="536" y="52">s</text><text text-anchor="middle" x="552" y="52">b</text><text text-anchor="middle" x="560" y="52">e</text><text text-anchor="middle" x="296" y="68">i</text><text text-anchor="middle" x="304" y="68">n</text><text text-anchor="middle" x="320" y="68">t</text><text text-anchor="middle" x="328" y="68">h</text><text text-anchor="middle" x="336" y="68">e</text><text text-anchor="middle" x="352" y="68">&quot;</text><text text-anchor="middle" x="360" y="68">s</text><text text-anchor="middle" x="368" y="68">a</text><text text-anchor="middle" x="376" y="68">f</text><text text-anchor="middle" x="384" y="68">e</text><text text-anchor="middle" x="400" y="68">z</text><text text-anchor="middle" x="408" y="68">o</text><text text-anchor="middle" x="416" y="68">n</text><text text-anchor="middle" x="424" y="68">e</text><text text-anchor="middle" x="432" y="68">&quot;</text><text text-anchor="middle" x="48" y="164">🕺</text><text text-anchor="middle" x="208" y="164">🕺</text><text text-anchor="middle" x="368" y="164">🕺</text><text text-anchor="middle" x="528" y="164">🕺</text><text text-anchor="middle" x="8" y="196">A</text><text text-anchor="middle" x="16" y="196">s</text><text text-anchor="middle" x="24" y="196">k</text><text text-anchor="middle" x="40" y="196">w</text><text text-anchor="middle" x="48" y="196">h</text><text text-anchor="middle" x="56" y="196">e</text><text text-anchor="middle" x="64" y="196">r</text><text text-anchor="middle" x="72" y="196">e</text><text text-anchor="middle" x="88" y="196">t</text><text text-anchor="middle" x="96" y="196">h</text><text text-anchor="middle" x="104" y="196">e</text><text text-anchor="middle" x="16" y="212">D</text><text text-anchor="middle" x="24" y="212">i</text><text text-anchor="middle" x="32" y="212">r</text><text text-anchor="middle" x="40" y="212">e</text><text text-anchor="middle" x="48" y="212">c</text><text text-anchor="middle" x="56" y="212">t</text><text text-anchor="middle" x="64" y="212">S</text><text text-anchor="middle" x="72" y="212">o</text><text text-anchor="middle" x="80" y="212">u</text><text text-anchor="middle" x="88" y="212">n</text><text text-anchor="middle" x="96" y="212">d</text><text text-anchor="middle" x="16" y="228">c</text><text text-anchor="middle" x="24" y="228">u</text><text text-anchor="middle" x="32" y="228">r</text><text text-anchor="middle" x="40" y="228">s</text><text text-anchor="middle" x="48" y="228">o</text><text text-anchor="middle" x="56" y="228">r</text><text text-anchor="middle" x="64" y="228">s</text><text text-anchor="middle" x="80" y="228">a</text><text text-anchor="middle" x="88" y="228">r</text><text text-anchor="middle" x="96" y="228">e</text><text text-anchor="middle" x="88" y="244">|</text><text text-anchor="middle" x="56" y="260">P</text><text text-anchor="middle" x="64" y="260">l</text><text text-anchor="middle" x="72" y="260">a</text><text text-anchor="middle" x="80" y="260">y</text><text text-anchor="middle" x="88" y="260">C</text><text text-anchor="middle" x="96" y="260">u</text><text text-anchor="middle" x="104" y="260">r</text><text text-anchor="middle" x="112" y="260">s</text><text text-anchor="middle" x="120" y="260">o</text><text text-anchor="middle" x="128" y="260">r</text><text text-anchor="middle" x="224" y="260">W</text><text text-anchor="middle" x="232" y="260">r</text><text text-anchor="middle" x="240" y="260">i</text><text text-anchor="middle" x="248" y="260">t</text><text text-anchor="middle" x="256" y="260">e</text><text text-anchor="middle" x="264" y="260">C</text><text text-anchor="middle" x="272" y="260">u</text><text text-anchor="middle" x="280" y="260">r</text><text text-anchor="middle" x="288" y="260">s</text><text text-anchor="middle" x="296" y="260">o</text><text text-anchor="middle" x="304" y="260">r</text><text text-anchor="middle" x="360" y="292">~</text><text text-anchor="middle" x="368" y="292">~</text><text text-anchor="middle" x="376" y="292">~</text><text text-anchor="middle" x="384" y="292">~</text><text text-anchor="middle" x="392" y="292">~</text><text text-anchor="middle" x="400" y="292">~</text><text text-anchor="middle" x="408" y="292">~</text><text text-anchor="middle" x="416" y="292">~</text><text text-anchor="middle" x="424" y="292">~</text><text text-anchor="middle" x="432" y="292">~</text><text text-anchor="middle" x="440" y="292">~</text><text text-anchor="middle" x="448" y="292">~</text><text text-anchor="middle" x="456" y="292">~</text><text text-anchor="middle" x="464" y="292">~</text><text text-anchor="middle" x="472" y="292">~</text><text text-anchor="middle" x="480" y="292">~</text><text text-anchor="middle" x="488" y="292">~</text><text text-anchor="middle" x="496" y="292">~</text><text text-anchor="middle" x="504" y="292">~</text><text text-anchor="middle" x="288" y="308">A</text><text text-anchor="middle" x="296" y="308">u</text><text text-anchor="middle" x="304" y="308">d</text><text text-anchor="middle" x="312" y="308">i</text><text text-anchor="middle" x="320" y="308">o</text><text text-anchor="middle" x="336" y="308">w</text><text text-anchor="middle" x="344" y="308">i</text><text text-anchor="middle" x="352" y="308">l</text><text text-anchor="middle" x="360" y="308">l</text><text text-anchor="middle" x="376" y="308">p</text><text text-anchor="middle" x="384" y="308">l</text><text text-anchor="middle" x="392" y="308">a</text><text text-anchor="middle" x="400" y="308">y</text><text text-anchor="middle" x="416" y="308">u</text><text text-anchor="middle" x="424" y="308">n</text><text text-anchor="middle" x="432" y="308">t</text><text text-anchor="middle" x="440" y="308">i</text><text text-anchor="middle" x="448" y="308">l</text><text text-anchor="middle" x="464" y="308">t</text><text text-anchor="middle" x="472" y="308">h</text><text text-anchor="middle" x="480" y="308">e</text><text text-anchor="middle" x="256" y="324">T</text><text text-anchor="middle" x="264" y="324">a</text><text text-anchor="middle" x="272" y="324">r</text><text text-anchor="middle" x="280" y="324">g</text><text text-anchor="middle" x="288" y="324">e</text><text text-anchor="middle" x="296" y="324">t</text><text text-anchor="middle" x="304" y="324">C</text><text text-anchor="middle" x="312" y="324">u</text><text text-anchor="middle" x="320" y="324">r</text><text text-anchor="middle" x="328" y="324">s</text><text text-anchor="middle" x="336" y="324">o</text><text text-anchor="middle" x="344" y="324">r</text><text text-anchor="middle" x="352" y="324">,</text><text text-anchor="middle" x="368" y="324">f</text><text text-anchor="middle" x="376" y="324">o</text><text text-anchor="middle" x="384" y="324">r</text><text text-anchor="middle" x="400" y="324">e</text><text text-anchor="middle" x="408" y="324">x</text><text text-anchor="middle" x="416" y="324">a</text><text text-anchor="middle" x="424" y="324">c</text><text text-anchor="middle" x="432" y="324">t</text><text text-anchor="middle" x="440" y="324">l</text><text text-anchor="middle" x="448" y="324">y</text><text text-anchor="middle" x="464" y="324">o</text><text text-anchor="middle" x="472" y="324">n</text><text text-anchor="middle" x="480" y="324">e</text><text text-anchor="middle" x="496" y="324">f</text><text text-anchor="middle" x="504" y="324">r</text><text text-anchor="middle" x="512" y="324">a</text><text text-anchor="middle" x="520" y="324">m</text><text text-anchor="middle" x="528" y="324">e</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;5:</b> Our current approach. 🕺 represents frame flips.</div></center>

</p><p>

If we want to avoid latency, we'd ideally have to send audio data before our rendering work on a frame even starts! This isn't necessarily impossible but would introduce frame lag anyway since the new user input and world state wouldn't account for the old sound... On the surface, this seems like chasing one's own tail.

</p>
<a class="target" name="evaluatetheoptions">&nbsp;</a><a class="target" name="deepdiveintotheissue/evaluatetheoptions">&nbsp;</a><a class="target" name="toc1.2">&nbsp;</a><h2>Evaluate the Options</h2>
<p>


At the end of the day, under the current system, there's no way to compute sound for a frame and have it reproduced together with its image when we intend it to. This leaves us with the following options: 

</p><p>

<ul>
<li class="asterisk">Accept the reality that our audio will always be a couple frames behind the image. After all, so many games already do this! This would simply regress our audio to be latent by design.
</li>
<li class="asterisk">Have a &ldquo;low latency mode&rdquo; that would take over on a machine with a great sound card and low latency; do things the slow way otherwise. 
</li>
<li class="asterisk">Continue tinkering on the inner workings of our platform layer.
</li>
<li class="asterisk">Fix latency issues by essentially getting input and world state a frame before. This, however, would introduce input lag, which seems like a worse tradeoff in an action game like ours will be.</li></ul>

</p><p>

The last option in our particular case seems to be the worst of all, so we can rule it out straight away. In fact, we want to push the input capture as close to the frame flip as possible so that the user doesn't feel that the game is unresponsive.

</p><p>

Let's start with the simplest solution we might imagine. We write our sound to the hardware as soon as we have it, without waiting for frame flip. If, for instance, audio is sent out 15ms after the frame starts, it will be reproduced ~15ms after the frame flip occurred. 

</p><p>

The game won't know of this happening: the platform will lie to the game, saying that the audio will be reproduced at the frame flip. 

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="256" width="496" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 8,80 L 8,112 " style="fill:none;"/>
<path d="M 64,104 L 64,144 " style="fill:none;"/>
<path d="M 120,0 L 120,192 " style="fill:none;"/>
<path d="M 152,0 L 152,32 " style="fill:none;"/>
<path d="M 176,64 L 176,96 " style="fill:none;"/>
<path d="M 232,80 L 232,112 " style="fill:none;"/>
<path d="M 344,80 L 344,112 " style="fill:none;"/>
<path d="M 120,0 L 152,0 " style="fill:none;"/>
<path d="M 120,32 L 152,32 " style="fill:none;"/>
<path d="M 8,96 L 456,96 " style="fill:none;"/>
<polygon points="464,96 452,90.4 452,101.6 "  style="stroke:none" transform="rotate(0,456,96 )"/>
<polygon points="128,120 116,114.4 116,125.6 "  style="stroke:none" transform="rotate(270,120,120 )"/>
<polygon points="72,104 60,98.4 60,109.6 "  style="stroke:none" transform="rotate(270,64,104 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="168" y="4">i</text><text text-anchor="middle" x="176" y="4">m</text><text text-anchor="middle" x="184" y="4">a</text><text text-anchor="middle" x="192" y="4">g</text><text text-anchor="middle" x="200" y="4">e</text><text text-anchor="middle" x="216" y="4">i</text><text text-anchor="middle" x="224" y="4">s</text><text text-anchor="middle" x="136" y="20">🕺</text><text text-anchor="middle" x="168" y="20">d</text><text text-anchor="middle" x="176" y="20">i</text><text text-anchor="middle" x="184" y="20">s</text><text text-anchor="middle" x="192" y="20">p</text><text text-anchor="middle" x="200" y="20">l</text><text text-anchor="middle" x="208" y="20">a</text><text text-anchor="middle" x="216" y="20">y</text><text text-anchor="middle" x="224" y="20">e</text><text text-anchor="middle" x="232" y="20">d</text><text text-anchor="middle" x="184" y="52">a</text><text text-anchor="middle" x="192" y="52">u</text><text text-anchor="middle" x="200" y="52">d</text><text text-anchor="middle" x="208" y="52">i</text><text text-anchor="middle" x="216" y="52">o</text><text text-anchor="middle" x="232" y="52">i</text><text text-anchor="middle" x="240" y="52">s</text><text text-anchor="middle" x="256" y="52">p</text><text text-anchor="middle" x="264" y="52">l</text><text text-anchor="middle" x="272" y="52">a</text><text text-anchor="middle" x="280" y="52">y</text><text text-anchor="middle" x="288" y="52">e</text><text text-anchor="middle" x="296" y="52">d</text><text text-anchor="middle" x="184" y="68">~</text><text text-anchor="middle" x="192" y="68">~</text><text text-anchor="middle" x="200" y="68">~</text><text text-anchor="middle" x="208" y="68">~</text><text text-anchor="middle" x="216" y="68">~</text><text text-anchor="middle" x="224" y="68">~</text><text text-anchor="middle" x="232" y="68">~</text><text text-anchor="middle" x="240" y="68">~</text><text text-anchor="middle" x="248" y="68">~</text><text text-anchor="middle" x="256" y="68">~</text><text text-anchor="middle" x="264" y="68">~</text><text text-anchor="middle" x="272" y="68">~</text><text text-anchor="middle" x="280" y="68">~</text><text text-anchor="middle" x="376" y="84">.</text><text text-anchor="middle" x="384" y="84">.</text><text text-anchor="middle" x="392" y="84">.</text><text text-anchor="middle" x="448" y="84">t</text><text text-anchor="middle" x="456" y="84">i</text><text text-anchor="middle" x="464" y="84">m</text><text text-anchor="middle" x="472" y="84">e</text><text text-anchor="middle" x="8" y="164">C</text><text text-anchor="middle" x="16" y="164">a</text><text text-anchor="middle" x="24" y="164">l</text><text text-anchor="middle" x="32" y="164">c</text><text text-anchor="middle" x="40" y="164">u</text><text text-anchor="middle" x="48" y="164">l</text><text text-anchor="middle" x="56" y="164">a</text><text text-anchor="middle" x="64" y="164">t</text><text text-anchor="middle" x="72" y="164">e</text><text text-anchor="middle" x="88" y="164">a</text><text text-anchor="middle" x="96" y="164">n</text><text text-anchor="middle" x="104" y="164">d</text><text text-anchor="middle" x="8" y="180">s</text><text text-anchor="middle" x="16" y="180">e</text><text text-anchor="middle" x="24" y="180">n</text><text text-anchor="middle" x="32" y="180">d</text><text text-anchor="middle" x="48" y="180">a</text><text text-anchor="middle" x="56" y="180">u</text><text text-anchor="middle" x="64" y="180">d</text><text text-anchor="middle" x="72" y="180">i</text><text text-anchor="middle" x="80" y="180">o</text><text text-anchor="middle" x="88" y="212">f</text><text text-anchor="middle" x="96" y="212">r</text><text text-anchor="middle" x="104" y="212">a</text><text text-anchor="middle" x="112" y="212">m</text><text text-anchor="middle" x="120" y="212">e</text><text text-anchor="middle" x="136" y="212">f</text><text text-anchor="middle" x="144" y="212">l</text><text text-anchor="middle" x="152" y="212">i</text><text text-anchor="middle" x="160" y="212">p</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;6:</b> Sending the audio out as soon as it's ready.</div></center>

</p><p>

<div class="admonition trivia"><div class="admonition-title"> </div>

</p><p>

    Unfortunately, this kind of unsynchronized audio loop is customary in the industry. It's a bit sloppy but better than the alternative of pushing audio to the next frame and have a much more significant delay.</div>

</p><p>

This solution also opens the road for the &ldquo;low latency mode&rdquo; we proposed above. If we determine that we're playing on extremely performant hardware, the sound will be targeting the frame flip instead.

</p>
<a class="target" name="trackingaudiolatency">&nbsp;</a><a class="target" name="deepdiveintotheissue/trackingaudiolatency">&nbsp;</a><a class="target" name="toc1.3">&nbsp;</a><h2>Tracking Audio Latency</h2>
<p>


We calculated our latency last time by subtracting the write cursor from the play cursor. We did it on a calculator, so let's capture it in our debug output for simplicity. We can do this by simply subtracting the write cursor from the play cursor:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> HANDMADE_INTERNAL</span></span>
<span class="line">DWORD PlayCursor;</span>
<span class="line">DWORD WriteCursor;</span>
<span class="line">GlobalSecondaryBuffer-&gt;GetCurrentPosition(&amp;PlayCursor, &amp;WriteCursor);</span>
<span class="line"></span><div class=" add"><span class="line">DWORD AudioLatencyBytes = WriteCursor - PlayCursor;</span></div><span class="line"></span>
<span class="line"><span class="hljs-keyword">char</span> TextBuffer[<span class="hljs-number">256</span>];</span><div class=" edit"><span class="line">sprintf_s(TextBuffer, <span class="hljs-keyword">sizeof</span>(TextBuffer), <span class="hljs-string">"LPC:%u BTL:%u TC:%u BTW:%u - PC:%u WC:%u DELTA:%u\n"</span>,</span>
<span class="line">            LastPlayCursor, ByteToLock, TargetCursor, BytesToWrite,</span>
<span class="line">            PlayCursor, WriteCursor, AudioLatencyBytes);</span></div><span class="line">OutputDebugStringA(TextBuffer);</span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;1:</b> <file>[win32_handmade.cpp > WinMain]</file> Tracking audio delta.</div></center>
<p>


However, we need to remember that the audio buffer is circular, so the value we'll get sometimes might be negative. This happens when the write cursor &ldquo;wraps&rdquo; to the beginning of the buffer while the play cursor is still at the end. To circumvent this issue, we can &ldquo;unwrap&rdquo; the <code>WriteCursor</code> value in those cases by simply adding to it the length of the secondary buffer. It's a simple trick but quite effective. We'll use it in another instance later today.

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="160" width="552" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 16,48 L 16,80 " style="fill:none;"/>
<path d="M 32,72 L 32,96 " style="fill:none;"/>
<path d="M 208,72 L 208,96 " style="fill:none;"/>
<path d="M 232,48 L 232,80 " style="fill:none;"/>
<path d="M 248,32 L 248,48 " style="fill:none;"/>
<path d="M 448,48 L 448,80 " style="fill:none;"/>
<path d="M 16,64 L 232,64 " style="fill:none;"/>
<polygon points="256,48 244,42.4 244,53.6 "  style="stroke:none" transform="rotate(90,248,48 )"/>
<polygon points="216,72 204,66.4 204,77.6 "  style="stroke:none" transform="rotate(270,208,72 )"/>
<polygon points="40,72 28,66.4 28,77.6 "  style="stroke:none" transform="rotate(270,32,72 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="184" y="20">U</text><text text-anchor="middle" x="192" y="20">n</text><text text-anchor="middle" x="200" y="20">w</text><text text-anchor="middle" x="208" y="20">r</text><text text-anchor="middle" x="216" y="20">a</text><text text-anchor="middle" x="224" y="20">p</text><text text-anchor="middle" x="232" y="20">p</text><text text-anchor="middle" x="240" y="20">e</text><text text-anchor="middle" x="248" y="20">d</text><text text-anchor="middle" x="256" y="20">W</text><text text-anchor="middle" x="264" y="20">r</text><text text-anchor="middle" x="272" y="20">i</text><text text-anchor="middle" x="280" y="20">t</text><text text-anchor="middle" x="288" y="20">e</text><text text-anchor="middle" x="296" y="20">C</text><text text-anchor="middle" x="304" y="20">u</text><text text-anchor="middle" x="312" y="20">r</text><text text-anchor="middle" x="320" y="20">s</text><text text-anchor="middle" x="328" y="20">o</text><text text-anchor="middle" x="336" y="20">r</text><text text-anchor="middle" x="240" y="68">⋯</text><text text-anchor="middle" x="248" y="68">⋯</text><text text-anchor="middle" x="256" y="68">⋯</text><text text-anchor="middle" x="264" y="68">⋯</text><text text-anchor="middle" x="272" y="68">⋯</text><text text-anchor="middle" x="280" y="68">⋯</text><text text-anchor="middle" x="288" y="68">⋯</text><text text-anchor="middle" x="296" y="68">⋯</text><text text-anchor="middle" x="304" y="68">⋯</text><text text-anchor="middle" x="312" y="68">⋯</text><text text-anchor="middle" x="320" y="68">⋯</text><text text-anchor="middle" x="328" y="68">⋯</text><text text-anchor="middle" x="336" y="68">⋯</text><text text-anchor="middle" x="344" y="68">⋯</text><text text-anchor="middle" x="352" y="68">⋯</text><text text-anchor="middle" x="360" y="68">⋯</text><text text-anchor="middle" x="368" y="68">⋯</text><text text-anchor="middle" x="376" y="68">⋯</text><text text-anchor="middle" x="384" y="68">⋯</text><text text-anchor="middle" x="392" y="68">⋯</text><text text-anchor="middle" x="400" y="68">⋯</text><text text-anchor="middle" x="408" y="68">⋯</text><text text-anchor="middle" x="416" y="68">⋯</text><text text-anchor="middle" x="424" y="68">⋯</text><text text-anchor="middle" x="432" y="68">⋯</text><text text-anchor="middle" x="440" y="68">⋯</text><text text-anchor="middle" x="8" y="116">W</text><text text-anchor="middle" x="16" y="116">r</text><text text-anchor="middle" x="24" y="116">i</text><text text-anchor="middle" x="32" y="116">t</text><text text-anchor="middle" x="40" y="116">e</text><text text-anchor="middle" x="48" y="116">C</text><text text-anchor="middle" x="56" y="116">u</text><text text-anchor="middle" x="64" y="116">r</text><text text-anchor="middle" x="72" y="116">s</text><text text-anchor="middle" x="80" y="116">o</text><text text-anchor="middle" x="88" y="116">r</text><text text-anchor="middle" x="176" y="116">P</text><text text-anchor="middle" x="184" y="116">l</text><text text-anchor="middle" x="192" y="116">a</text><text text-anchor="middle" x="200" y="116">y</text><text text-anchor="middle" x="208" y="116">C</text><text text-anchor="middle" x="216" y="116">u</text><text text-anchor="middle" x="224" y="116">r</text><text text-anchor="middle" x="232" y="116">s</text><text text-anchor="middle" x="240" y="116">o</text><text text-anchor="middle" x="248" y="116">r</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;7:</b> If we add the circular buffer's length to the value of Write Cursor, we effectively unwrap it.</div></center>

</p><p>

This is a circular buffer, so we need to account for when the write cursor is in front.

</p><pre class="listing tilde"><code><div class=" add"><span class="line">DWORD UnwrappedWriteCursor = WriteCursor;</span>
<span class="line"><span class="hljs-keyword">if</span> (UnwrappedWriteCursor &lt; PlayCursor)</span>
<span class="line">{</span>
<span class="line">    UnwrappedWriteCursor += SoundOutput.SecondaryBufferSize;</span>
<span class="line">}</span></div><div class=" edit"><span class="line">DWORD AudioLatencyBytes = UnwrappedWriteCursor - PlayCursor;</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;2:</b> <file>[win32_handmade.cpp > WinMain]</file> Accounting for circular buffer wrap.</div></center>
<p>


Let's compile and run our program in the debugger. You should see a static DELTA value, which on our machine is 5760 bytes:

</p><pre class="listing tilde"><code><span class="line">BTL:373332 TC:379093 BTW:5761 - PC:364800 WC:370560 DELTA:5760</span>
<span class="line">BTL:379092 TC:2773 BTW:7681 - PC:372480 WC:378240 DELTA:5760</span>
<span class="line">BTL:2772 TC:8533 BTW:5761 - PC:378240 WC:0 DELTA:5760</span>
<span class="line">BTL:8532 TC:14293 BTW:5761 - PC:0 WC:5760 DELTA:5760</span>
<span class="line">BTL:14292 TC:21973 BTW:7681 - PC:7680 WC:13440 DELTA:5760</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;3:</b> <file>[Debug Output]</file> You will notice that delta is calculated correctly in case of buffer wrap, as we anticipated.</div></center>
<p>


We could go even further, and calculate how many seconds does this amount of bytes translate to. Using some dimensional analysis you can quickly derive the following: 

</p><p>

$$ bytes \times (\frac{samples}{bytes}) \times (\frac{seconds}{samples}) = $$
$$\frac{\bcancel{bytes} \times \bcancel{samples} \times seconds}{1 \times \bcancel{bytes} \times \bcancel {samples}} =$$
$$ seconds $$

</p><p>

Since we don't have SamplesPerBytes and SecondsPerSample, we'll need to invert the values we have. We will store the resulting value as a real (\({\rm I\!R}\)) number inside a float. When we pass it to the <code>sprintf_s</code> function, we can use the <code>%f</code> operator to read the float, or even <code>%.3f</code> to only display the first 3 decimal points (and round the rest).

</p><pre class="listing tilde"><code><span class="line">DWORD UnwrappedWriteCursor = WriteCursor;</span>
<span class="line"><span class="hljs-keyword">if</span> (UnwrappedWriteCursor &lt; PlayCursor)</span>
<span class="line">{</span>
<span class="line">    UnwrappedWriteCursor += SoundOutput.SecondaryBufferSize;</span>
<span class="line">}</span>
<span class="line">DWORD AudioLatencyBytes = UnwrappedWriteCursor - PlayCursor;</span><div class=" add"><span class="line">f32 AudioLatencySeconds = ((f32)AudioLatencyBytes / (f32)SoundOutput.BytesPerSample) / </span>
<span class="line">                           (f32)SoundOutput.SamplesPerSecond;</span></div><span class="line"><span class="hljs-keyword">char</span> TextBuffer[<span class="hljs-number">256</span>];</span><div class=" edit"><span class="line">sprintf_s(TextBuffer, <span class="hljs-keyword">sizeof</span>(TextBuffer), <span class="hljs-string">"LPC:%u BTL:%u TC:%u BTW:%u - PC:%u WC:%u DELTA:%u (%.3fs)\n"</span>,</span>
<span class="line">            LastPlayCursor, ByteToLock, TargetCursor, BytesToWrite,</span>
<span class="line">            PlayCursor, WriteCursor, AudioLatencyBytes, AudioLatencySeconds);</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;4:</b> <file>[win32_handmade.cpp > WinMain]</file> Displaying latency in seconds.</div></center>
<p>




<div class="admonition note"><div class="admonition-title"> </div>

</p><p>

    We've already encountered an operation where we need to divide by samples per second. In fact, it's quite prone to error, and we might want to pull out these calculations in the future. For the time being, let's place a todo for the future us to add the &ldquo;bytes per second&rdquo; field:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">win32_sound_output</span></span>
<span class="line">{</span></span>
<span class="line">    <span class="hljs-keyword">int</span> SamplesPerSecond;</span>
<span class="line">    <span class="hljs-keyword">int</span> BytesPerSample;</span>
<span class="line">    DWORD SecondaryBufferSize;</span>
<span class="line">    u32 RunningSampleIndex;</span>
<span class="line">    <span class="hljs-keyword">int</span> LatencySampleCount;</span><div class=" add"><span class="line">    <span class="hljs-comment">// TODO(casey): Math gets simpler if we add a "bytes per second" field? </span></span></div><span class="line">};</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;5:</b> <file>[win32_handmade.h]</file> Adding a todo for the future.</div></center></div>

</p><p>


<a class="target" name="reviewtargetbytescalculation">&nbsp;</a><a class="target" name="deepdiveintotheissue/reviewtargetbytescalculation">&nbsp;</a><a class="target" name="toc1.4">&nbsp;</a><h2>Review Target Bytes calculation</h2>
<p>


If you remember, we define how many samples we want to send to the buffer in the following manner:

</p><p>

<ul>
<li class="asterisk"><code>ByteToLock</code> represents the point from which we should start writing.
</li>
<li class="asterisk"><code>TargetCursor</code> defines where we're writing until. 
</li>
<li class="asterisk"><code>BytesToWrite</code> is the difference between the two (considering circular buffer wrap).</li></ul>

</p><p>

Until now, we were setting our <code>ByteToLock</code> to be whatever our <code>RunningSampleIndex</code> was. We would then calculate the target cursor, which would be the last known play cursor's location. We wouldn't really consider where the Write Cursor was. What mattered to us was just leaving enough room (<code>LatencySampleCount</code>) to surely get ahead of it. 

</p><p>

Now we will start taking into account the DirectSound's write cursor. If it's within this frame's boundaries, we can assume that we are on low latency hardware and get on the &ldquo;Low Latency Path.&rdquo; In this case, we presume that we can write up from the frame flip, so we offset the <code>TargetCursor</code> until the next frame's boundary so that audio will always go out with the image.

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="352" width="608" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 32,80 L 32,160 " style="fill:none;"/>
<path d="M 64,128 L 64,160 " style="fill:none;"/>
<path d="M 64,224 L 64,240 " style="fill:none;"/>
<path d="M 88,104 L 88,160 " style="fill:none;"/>
<path d="M 152,64 L 152,224 " style="fill:none;"/>
<path d="M 224,80 L 224,272 " style="fill:none;"/>
<path d="M 256,128 L 256,160 " style="fill:none;"/>
<path d="M 408,64 L 408,88 " style="fill:none;"/>
<path d="M 416,80 L 416,160 " style="fill:none;"/>
<path d="M 448,128 L 448,160 " style="fill:none;"/>
<path d="M 168,48 L 392,48 " style="fill:none;"/>
<path d="M 32,96 L 528,96 " style="fill:none;"/>
<path d="M 32,128 L 64,128 " style="fill:none;"/>
<path d="M 224,128 L 256,128 " style="fill:none;"/>
<path d="M 416,128 L 448,128 " style="fill:none;"/>
<path d="M 32,160 L 64,160 " style="fill:none;"/>
<path d="M 224,160 L 256,160 " style="fill:none;"/>
<path d="M 416,160 L 448,160 " style="fill:none;"/>
<path d="M 64,240 L 88,240 " style="fill:none;"/>
<path d="M 168,48 C 151.2,48 152,64 152,64 " style="fill:none;"/>
<path d="M 392,48 C 408.8,48 408,64 408,64 " style="fill:none;"/>
<polygon points="536,96 524,90.4 524,101.6 "  style="stroke:none" transform="rotate(0,528,96 )"/>
<polygon points="416,88 404,82.4 404,93.6 "  style="stroke:none" transform="rotate(90,408,88 )"/>
<polygon points="160,104 148,98.4 148,109.6 "  style="stroke:none" transform="rotate(270,152,104 )"/>
<polygon points="96,240 84,234.4 84,245.6 "  style="stroke:none" transform="rotate(0,88,240 )"/>
<polygon points="96,104 84,98.4 84,109.6 "  style="stroke:none" transform="rotate(270,88,104 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="192" y="20">S</text><text text-anchor="middle" x="200" y="20">e</text><text text-anchor="middle" x="208" y="20">t</text><text text-anchor="middle" x="224" y="20">T</text><text text-anchor="middle" x="232" y="20">a</text><text text-anchor="middle" x="240" y="20">r</text><text text-anchor="middle" x="248" y="20">g</text><text text-anchor="middle" x="256" y="20">e</text><text text-anchor="middle" x="264" y="20">t</text><text text-anchor="middle" x="272" y="20">C</text><text text-anchor="middle" x="280" y="20">u</text><text text-anchor="middle" x="288" y="20">r</text><text text-anchor="middle" x="296" y="20">s</text><text text-anchor="middle" x="304" y="20">o</text><text text-anchor="middle" x="312" y="20">r</text><text text-anchor="middle" x="184" y="36">t</text><text text-anchor="middle" x="192" y="36">o</text><text text-anchor="middle" x="208" y="36">t</text><text text-anchor="middle" x="216" y="36">h</text><text text-anchor="middle" x="224" y="36">e</text><text text-anchor="middle" x="240" y="36">e</text><text text-anchor="middle" x="248" y="36">n</text><text text-anchor="middle" x="256" y="36">d</text><text text-anchor="middle" x="272" y="36">o</text><text text-anchor="middle" x="280" y="36">f</text><text text-anchor="middle" x="296" y="36">n</text><text text-anchor="middle" x="304" y="36">e</text><text text-anchor="middle" x="312" y="36">x</text><text text-anchor="middle" x="320" y="36">t</text><text text-anchor="middle" x="336" y="36">f</text><text text-anchor="middle" x="344" y="36">r</text><text text-anchor="middle" x="352" y="36">a</text><text text-anchor="middle" x="360" y="36">m</text><text text-anchor="middle" x="368" y="36">e</text><text text-anchor="middle" x="48" y="148">🕺</text><text text-anchor="middle" x="240" y="148">🕺</text><text text-anchor="middle" x="432" y="148">🕺</text><text text-anchor="middle" x="40" y="180">A</text><text text-anchor="middle" x="48" y="180">s</text><text text-anchor="middle" x="56" y="180">k</text><text text-anchor="middle" x="72" y="180">w</text><text text-anchor="middle" x="80" y="180">h</text><text text-anchor="middle" x="88" y="180">e</text><text text-anchor="middle" x="96" y="180">r</text><text text-anchor="middle" x="104" y="180">e</text><text text-anchor="middle" x="120" y="180">t</text><text text-anchor="middle" x="128" y="180">h</text><text text-anchor="middle" x="136" y="180">e</text><text text-anchor="middle" x="48" y="196">D</text><text text-anchor="middle" x="56" y="196">i</text><text text-anchor="middle" x="64" y="196">r</text><text text-anchor="middle" x="72" y="196">e</text><text text-anchor="middle" x="80" y="196">c</text><text text-anchor="middle" x="88" y="196">t</text><text text-anchor="middle" x="96" y="196">S</text><text text-anchor="middle" x="104" y="196">o</text><text text-anchor="middle" x="112" y="196">u</text><text text-anchor="middle" x="120" y="196">n</text><text text-anchor="middle" x="128" y="196">d</text><text text-anchor="middle" x="48" y="212">c</text><text text-anchor="middle" x="56" y="212">u</text><text text-anchor="middle" x="64" y="212">r</text><text text-anchor="middle" x="72" y="212">s</text><text text-anchor="middle" x="80" y="212">o</text><text text-anchor="middle" x="88" y="212">r</text><text text-anchor="middle" x="96" y="212">s</text><text text-anchor="middle" x="112" y="212">a</text><text text-anchor="middle" x="120" y="212">r</text><text text-anchor="middle" x="128" y="212">e</text><text text-anchor="middle" x="112" y="244">W</text><text text-anchor="middle" x="120" y="244">r</text><text text-anchor="middle" x="128" y="244">i</text><text text-anchor="middle" x="136" y="244">t</text><text text-anchor="middle" x="144" y="244">e</text><text text-anchor="middle" x="152" y="244">C</text><text text-anchor="middle" x="160" y="244">u</text><text text-anchor="middle" x="168" y="244">r</text><text text-anchor="middle" x="176" y="244">s</text><text text-anchor="middle" x="184" y="244">o</text><text text-anchor="middle" x="192" y="244">r</text><text text-anchor="middle" x="48" y="260">P</text><text text-anchor="middle" x="56" y="260">l</text><text text-anchor="middle" x="64" y="260">a</text><text text-anchor="middle" x="72" y="260">y</text><text text-anchor="middle" x="80" y="260">C</text><text text-anchor="middle" x="88" y="260">u</text><text text-anchor="middle" x="96" y="260">r</text><text text-anchor="middle" x="104" y="260">s</text><text text-anchor="middle" x="112" y="260">o</text><text text-anchor="middle" x="120" y="260">r</text><text text-anchor="middle" x="232" y="276">~</text><text text-anchor="middle" x="240" y="276">~</text><text text-anchor="middle" x="248" y="276">~</text><text text-anchor="middle" x="256" y="276">~</text><text text-anchor="middle" x="264" y="276">~</text><text text-anchor="middle" x="272" y="276">~</text><text text-anchor="middle" x="280" y="276">~</text><text text-anchor="middle" x="288" y="276">~</text><text text-anchor="middle" x="296" y="276">~</text><text text-anchor="middle" x="304" y="276">~</text><text text-anchor="middle" x="312" y="276">~</text><text text-anchor="middle" x="320" y="276">~</text><text text-anchor="middle" x="328" y="276">~</text><text text-anchor="middle" x="336" y="276">~</text><text text-anchor="middle" x="344" y="276">~</text><text text-anchor="middle" x="352" y="276">~</text><text text-anchor="middle" x="360" y="276">~</text><text text-anchor="middle" x="368" y="276">~</text><text text-anchor="middle" x="376" y="276">~</text><text text-anchor="middle" x="384" y="276">~</text><text text-anchor="middle" x="392" y="276">~</text><text text-anchor="middle" x="400" y="276">~</text><text text-anchor="middle" x="408" y="276">~</text><text text-anchor="middle" x="224" y="292">a</text><text text-anchor="middle" x="232" y="292">u</text><text text-anchor="middle" x="240" y="292">d</text><text text-anchor="middle" x="248" y="292">i</text><text text-anchor="middle" x="256" y="292">o</text><text text-anchor="middle" x="272" y="292">i</text><text text-anchor="middle" x="280" y="292">s</text><text text-anchor="middle" x="296" y="292">p</text><text text-anchor="middle" x="304" y="292">l</text><text text-anchor="middle" x="312" y="292">a</text><text text-anchor="middle" x="320" y="292">y</text><text text-anchor="middle" x="328" y="292">i</text><text text-anchor="middle" x="336" y="292">n</text><text text-anchor="middle" x="344" y="292">g</text><text text-anchor="middle" x="360" y="292">f</text><text text-anchor="middle" x="368" y="292">o</text><text text-anchor="middle" x="376" y="292">r</text><text text-anchor="middle" x="392" y="292">e</text><text text-anchor="middle" x="400" y="292">x</text><text text-anchor="middle" x="408" y="292">a</text><text text-anchor="middle" x="416" y="292">c</text><text text-anchor="middle" x="424" y="292">t</text><text text-anchor="middle" x="432" y="292">l</text><text text-anchor="middle" x="440" y="292">y</text><text text-anchor="middle" x="456" y="292">o</text><text text-anchor="middle" x="464" y="292">n</text><text text-anchor="middle" x="472" y="292">e</text><text text-anchor="middle" x="488" y="292">f</text><text text-anchor="middle" x="496" y="292">r</text><text text-anchor="middle" x="504" y="292">a</text><text text-anchor="middle" x="512" y="292">m</text><text text-anchor="middle" x="520" y="292">e</text><text text-anchor="middle" x="224" y="308">r</text><text text-anchor="middle" x="232" y="308">i</text><text text-anchor="middle" x="240" y="308">n</text><text text-anchor="middle" x="248" y="308">s</text><text text-anchor="middle" x="256" y="308">e</text><text text-anchor="middle" x="272" y="308">a</text><text text-anchor="middle" x="280" y="308">n</text><text text-anchor="middle" x="288" y="308">d</text><text text-anchor="middle" x="304" y="308">r</text><text text-anchor="middle" x="312" y="308">e</text><text text-anchor="middle" x="320" y="308">p</text><text text-anchor="middle" x="328" y="308">e</text><text text-anchor="middle" x="336" y="308">a</text><text text-anchor="middle" x="344" y="308">t</text><text text-anchor="middle" x="360" y="308">f</text><text text-anchor="middle" x="368" y="308">o</text><text text-anchor="middle" x="376" y="308">r</text><text text-anchor="middle" x="392" y="308">i</text><text text-anchor="middle" x="400" y="308">n</text><text text-anchor="middle" x="408" y="308">f</text><text text-anchor="middle" x="416" y="308">i</text><text text-anchor="middle" x="424" y="308">n</text><text text-anchor="middle" x="432" y="308">i</text><text text-anchor="middle" x="440" y="308">t</text><text text-anchor="middle" x="448" y="308">e</text><text text-anchor="middle" x="464" y="308">s</text><text text-anchor="middle" x="472" y="308">o</text><text text-anchor="middle" x="480" y="308">u</text><text text-anchor="middle" x="488" y="308">n</text><text text-anchor="middle" x="496" y="308">d</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;8:</b> Low latency path idea.</div></center>

</p><p>

If the Write Cursor is beyond this frame, we assume that the latency is high. Then we won't wait until the frame flip, and the <code>TargetCursor</code> can be whatever our <code>WriteCursor</code> would be after one frame. We will offset it by but a small safety margin (a few milliseconds) to account for potential variability in the latency between now and the output.

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="368" width="608" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 32,96 L 32,176 " style="fill:none;"/>
<path d="M 64,144 L 64,176 " style="fill:none;"/>
<path d="M 64,240 L 64,256 " style="fill:none;"/>
<path d="M 88,120 L 88,176 " style="fill:none;"/>
<path d="M 224,112 L 224,176 " style="fill:none;"/>
<path d="M 256,144 L 256,176 " style="fill:none;"/>
<path d="M 296,80 L 296,240 " style="fill:none;"/>
<path d="M 360,120 L 360,288 " style="fill:none;"/>
<path d="M 416,96 L 416,176 " style="fill:none;"/>
<path d="M 448,144 L 448,176 " style="fill:none;"/>
<path d="M 512,80 L 512,104 " style="fill:none;"/>
<path d="M 312,64 L 496,64 " style="fill:none;"/>
<path d="M 32,112 L 528,112 " style="fill:none;"/>
<path d="M 32,144 L 64,144 " style="fill:none;"/>
<path d="M 224,144 L 256,144 " style="fill:none;"/>
<path d="M 416,144 L 448,144 " style="fill:none;"/>
<path d="M 32,176 L 64,176 " style="fill:none;"/>
<path d="M 224,176 L 256,176 " style="fill:none;"/>
<path d="M 416,176 L 448,176 " style="fill:none;"/>
<path d="M 64,256 L 232,256 " style="fill:none;"/>
<path d="M 312,64 C 295.2,64 296,80 296,80 " style="fill:none;"/>
<path d="M 496,64 C 512.8,64 512,80 512,80 " style="fill:none;"/>
<polygon points="536,112 524,106.4 524,117.6 "  style="stroke:none" transform="rotate(0,528,112 )"/>
<polygon points="520,104 508,98.4 508,109.6 "  style="stroke:none" transform="rotate(90,512,104 )"/>
<polygon points="304,120 292,114.4 292,125.6 "  style="stroke:none" transform="rotate(270,296,120 )"/>
<polygon points="240,256 228,250.4 228,261.6 "  style="stroke:none" transform="rotate(0,232,256 )"/>
<polygon points="96,120 84,114.4 84,125.6 "  style="stroke:none" transform="rotate(270,88,120 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="168" y="20">S</text><text text-anchor="middle" x="176" y="20">e</text><text text-anchor="middle" x="184" y="20">t</text><text text-anchor="middle" x="200" y="20">T</text><text text-anchor="middle" x="208" y="20">a</text><text text-anchor="middle" x="216" y="20">r</text><text text-anchor="middle" x="224" y="20">g</text><text text-anchor="middle" x="232" y="20">e</text><text text-anchor="middle" x="240" y="20">t</text><text text-anchor="middle" x="248" y="20">C</text><text text-anchor="middle" x="256" y="20">u</text><text text-anchor="middle" x="264" y="20">r</text><text text-anchor="middle" x="272" y="20">s</text><text text-anchor="middle" x="280" y="20">o</text><text text-anchor="middle" x="288" y="20">r</text><text text-anchor="middle" x="304" y="20">t</text><text text-anchor="middle" x="312" y="20">o</text><text text-anchor="middle" x="328" y="20">b</text><text text-anchor="middle" x="336" y="20">e</text><text text-anchor="middle" x="352" y="20">s</text><text text-anchor="middle" x="360" y="20">l</text><text text-anchor="middle" x="368" y="20">i</text><text text-anchor="middle" x="376" y="20">g</text><text text-anchor="middle" x="384" y="20">h</text><text text-anchor="middle" x="392" y="20">t</text><text text-anchor="middle" x="400" y="20">l</text><text text-anchor="middle" x="408" y="20">y</text><text text-anchor="middle" x="424" y="20">f</text><text text-anchor="middle" x="432" y="20">u</text><text text-anchor="middle" x="440" y="20">r</text><text text-anchor="middle" x="448" y="20">t</text><text text-anchor="middle" x="456" y="20">h</text><text text-anchor="middle" x="464" y="20">e</text><text text-anchor="middle" x="472" y="20">r</text><text text-anchor="middle" x="488" y="20">a</text><text text-anchor="middle" x="496" y="20">h</text><text text-anchor="middle" x="504" y="20">e</text><text text-anchor="middle" x="512" y="20">a</text><text text-anchor="middle" x="520" y="20">d</text><text text-anchor="middle" x="256" y="36">f</text><text text-anchor="middle" x="264" y="36">r</text><text text-anchor="middle" x="272" y="36">o</text><text text-anchor="middle" x="280" y="36">m</text><text text-anchor="middle" x="296" y="36">t</text><text text-anchor="middle" x="304" y="36">h</text><text text-anchor="middle" x="312" y="36">e</text><text text-anchor="middle" x="328" y="36">W</text><text text-anchor="middle" x="336" y="36">r</text><text text-anchor="middle" x="344" y="36">i</text><text text-anchor="middle" x="352" y="36">t</text><text text-anchor="middle" x="360" y="36">e</text><text text-anchor="middle" x="368" y="36">C</text><text text-anchor="middle" x="376" y="36">u</text><text text-anchor="middle" x="384" y="36">r</text><text text-anchor="middle" x="392" y="36">s</text><text text-anchor="middle" x="400" y="36">o</text><text text-anchor="middle" x="408" y="36">r</text><text text-anchor="middle" x="168" y="52">(</text><text text-anchor="middle" x="176" y="52">j</text><text text-anchor="middle" x="184" y="52">u</text><text text-anchor="middle" x="192" y="52">s</text><text text-anchor="middle" x="200" y="52">t</text><text text-anchor="middle" x="216" y="52">a</text><text text-anchor="middle" x="232" y="52">s</text><text text-anchor="middle" x="240" y="52">a</text><text text-anchor="middle" x="248" y="52">f</text><text text-anchor="middle" x="256" y="52">e</text><text text-anchor="middle" x="264" y="52">t</text><text text-anchor="middle" x="272" y="52">y</text><text text-anchor="middle" x="288" y="52">m</text><text text-anchor="middle" x="296" y="52">a</text><text text-anchor="middle" x="304" y="52">r</text><text text-anchor="middle" x="312" y="52">g</text><text text-anchor="middle" x="320" y="52">i</text><text text-anchor="middle" x="328" y="52">n</text><text text-anchor="middle" x="336" y="52">,</text><text text-anchor="middle" x="352" y="52">d</text><text text-anchor="middle" x="360" y="52">o</text><text text-anchor="middle" x="368" y="52">n</text><text text-anchor="middle" x="376" y="52">'</text><text text-anchor="middle" x="384" y="52">t</text><text text-anchor="middle" x="400" y="52">w</text><text text-anchor="middle" x="408" y="52">a</text><text text-anchor="middle" x="416" y="52">i</text><text text-anchor="middle" x="424" y="52">t</text><text text-anchor="middle" x="440" y="52">u</text><text text-anchor="middle" x="448" y="52">n</text><text text-anchor="middle" x="456" y="52">t</text><text text-anchor="middle" x="464" y="52">i</text><text text-anchor="middle" x="472" y="52">l</text><text text-anchor="middle" x="488" y="52">f</text><text text-anchor="middle" x="496" y="52">l</text><text text-anchor="middle" x="504" y="52">i</text><text text-anchor="middle" x="512" y="52">p</text><text text-anchor="middle" x="520" y="52">)</text><text text-anchor="middle" x="48" y="164">🕺</text><text text-anchor="middle" x="240" y="164">🕺</text><text text-anchor="middle" x="432" y="164">🕺</text><text text-anchor="middle" x="40" y="196">A</text><text text-anchor="middle" x="48" y="196">s</text><text text-anchor="middle" x="56" y="196">k</text><text text-anchor="middle" x="72" y="196">w</text><text text-anchor="middle" x="80" y="196">h</text><text text-anchor="middle" x="88" y="196">e</text><text text-anchor="middle" x="96" y="196">r</text><text text-anchor="middle" x="104" y="196">e</text><text text-anchor="middle" x="120" y="196">t</text><text text-anchor="middle" x="128" y="196">h</text><text text-anchor="middle" x="136" y="196">e</text><text text-anchor="middle" x="48" y="212">D</text><text text-anchor="middle" x="56" y="212">i</text><text text-anchor="middle" x="64" y="212">r</text><text text-anchor="middle" x="72" y="212">e</text><text text-anchor="middle" x="80" y="212">c</text><text text-anchor="middle" x="88" y="212">t</text><text text-anchor="middle" x="96" y="212">S</text><text text-anchor="middle" x="104" y="212">o</text><text text-anchor="middle" x="112" y="212">u</text><text text-anchor="middle" x="120" y="212">n</text><text text-anchor="middle" x="128" y="212">d</text><text text-anchor="middle" x="48" y="228">c</text><text text-anchor="middle" x="56" y="228">u</text><text text-anchor="middle" x="64" y="228">r</text><text text-anchor="middle" x="72" y="228">s</text><text text-anchor="middle" x="80" y="228">o</text><text text-anchor="middle" x="88" y="228">r</text><text text-anchor="middle" x="96" y="228">s</text><text text-anchor="middle" x="112" y="228">a</text><text text-anchor="middle" x="120" y="228">r</text><text text-anchor="middle" x="128" y="228">e</text><text text-anchor="middle" x="256" y="260">W</text><text text-anchor="middle" x="264" y="260">r</text><text text-anchor="middle" x="272" y="260">i</text><text text-anchor="middle" x="280" y="260">t</text><text text-anchor="middle" x="288" y="260">e</text><text text-anchor="middle" x="296" y="260">C</text><text text-anchor="middle" x="304" y="260">u</text><text text-anchor="middle" x="312" y="260">r</text><text text-anchor="middle" x="320" y="260">s</text><text text-anchor="middle" x="328" y="260">o</text><text text-anchor="middle" x="336" y="260">r</text><text text-anchor="middle" x="40" y="276">P</text><text text-anchor="middle" x="48" y="276">l</text><text text-anchor="middle" x="56" y="276">a</text><text text-anchor="middle" x="64" y="276">y</text><text text-anchor="middle" x="72" y="276">C</text><text text-anchor="middle" x="80" y="276">u</text><text text-anchor="middle" x="88" y="276">r</text><text text-anchor="middle" x="96" y="276">s</text><text text-anchor="middle" x="104" y="276">o</text><text text-anchor="middle" x="112" y="276">r</text><text text-anchor="middle" x="368" y="292">~</text><text text-anchor="middle" x="376" y="292">~</text><text text-anchor="middle" x="384" y="292">~</text><text text-anchor="middle" x="392" y="292">~</text><text text-anchor="middle" x="400" y="292">~</text><text text-anchor="middle" x="408" y="292">~</text><text text-anchor="middle" x="416" y="292">~</text><text text-anchor="middle" x="424" y="292">~</text><text text-anchor="middle" x="432" y="292">~</text><text text-anchor="middle" x="440" y="292">~</text><text text-anchor="middle" x="448" y="292">~</text><text text-anchor="middle" x="456" y="292">~</text><text text-anchor="middle" x="464" y="292">~</text><text text-anchor="middle" x="472" y="292">~</text><text text-anchor="middle" x="480" y="292">~</text><text text-anchor="middle" x="488" y="292">~</text><text text-anchor="middle" x="496" y="292">~</text><text text-anchor="middle" x="504" y="292">~</text><text text-anchor="middle" x="512" y="292">~</text><text text-anchor="middle" x="224" y="308">a</text><text text-anchor="middle" x="232" y="308">u</text><text text-anchor="middle" x="240" y="308">d</text><text text-anchor="middle" x="248" y="308">i</text><text text-anchor="middle" x="256" y="308">o</text><text text-anchor="middle" x="272" y="308">i</text><text text-anchor="middle" x="280" y="308">s</text><text text-anchor="middle" x="296" y="308">s</text><text text-anchor="middle" x="304" y="308">t</text><text text-anchor="middle" x="312" y="308">i</text><text text-anchor="middle" x="320" y="308">l</text><text text-anchor="middle" x="328" y="308">l</text><text text-anchor="middle" x="344" y="308">p</text><text text-anchor="middle" x="352" y="308">l</text><text text-anchor="middle" x="360" y="308">a</text><text text-anchor="middle" x="368" y="308">y</text><text text-anchor="middle" x="376" y="308">i</text><text text-anchor="middle" x="384" y="308">n</text><text text-anchor="middle" x="392" y="308">g</text><text text-anchor="middle" x="408" y="308">f</text><text text-anchor="middle" x="416" y="308">o</text><text text-anchor="middle" x="424" y="308">r</text><text text-anchor="middle" x="440" y="308">e</text><text text-anchor="middle" x="448" y="308">x</text><text text-anchor="middle" x="456" y="308">a</text><text text-anchor="middle" x="464" y="308">c</text><text text-anchor="middle" x="472" y="308">t</text><text text-anchor="middle" x="480" y="308">l</text><text text-anchor="middle" x="488" y="308">y</text><text text-anchor="middle" x="504" y="308">o</text><text text-anchor="middle" x="512" y="308">n</text><text text-anchor="middle" x="520" y="308">e</text><text text-anchor="middle" x="536" y="308">f</text><text text-anchor="middle" x="544" y="308">r</text><text text-anchor="middle" x="552" y="308">a</text><text text-anchor="middle" x="560" y="308">m</text><text text-anchor="middle" x="568" y="308">e</text><text text-anchor="middle" x="232" y="324">b</text><text text-anchor="middle" x="240" y="324">u</text><text text-anchor="middle" x="248" y="324">t</text><text text-anchor="middle" x="264" y="324">i</text><text text-anchor="middle" x="272" y="324">t</text><text text-anchor="middle" x="280" y="324">'</text><text text-anchor="middle" x="288" y="324">s</text><text text-anchor="middle" x="304" y="324">s</text><text text-anchor="middle" x="312" y="324">c</text><text text-anchor="middle" x="320" y="324">h</text><text text-anchor="middle" x="328" y="324">e</text><text text-anchor="middle" x="336" y="324">d</text><text text-anchor="middle" x="344" y="324">u</text><text text-anchor="middle" x="352" y="324">l</text><text text-anchor="middle" x="360" y="324">e</text><text text-anchor="middle" x="368" y="324">d</text><text text-anchor="middle" x="384" y="324">o</text><text text-anchor="middle" x="392" y="324">n</text><text text-anchor="middle" x="400" y="324">e</text><text text-anchor="middle" x="416" y="324">f</text><text text-anchor="middle" x="424" y="324">r</text><text text-anchor="middle" x="432" y="324">a</text><text text-anchor="middle" x="440" y="324">m</text><text text-anchor="middle" x="448" y="324">e</text><text text-anchor="middle" x="464" y="324">e</text><text text-anchor="middle" x="472" y="324">a</text><text text-anchor="middle" x="480" y="324">r</text><text text-anchor="middle" x="488" y="324">l</text><text text-anchor="middle" x="496" y="324">i</text><text text-anchor="middle" x="504" y="324">e</text><text text-anchor="middle" x="512" y="324">r</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;9:</b> High latency path.</div></center>

</p><p>

All of this wouldn't impact our <code>ByteToLock</code> or <code>BytesToWrite</code> calculation (or, at least, not directly). However, given that <code>TargetCursor</code> will move depending on the hardware's latency, the rest of these values will move accordingly.

</p>
<a class="target" name="implementthetwoaudiopaths">&nbsp;</a><a class="target" name="implementthetwoaudiopaths">&nbsp;</a><a class="target" name="toc2">&nbsp;</a><h1>Implement the Two Audio Paths</h1>

<a class="target" name="cleanuptheoldcode">&nbsp;</a><a class="target" name="implementthetwoaudiopaths/cleanuptheoldcode">&nbsp;</a><a class="target" name="toc2.1">&nbsp;</a><h2>Clean Up the Old Code</h2>
<p>


Alright, let's get cracking. First of all, let's get rid of the <code>LastPlayCursor</code>; it's gone. We'll need to remove it from the beginning of our <code>WinMain</code> and any usage we encounter along the way. We won't need it anymore because we'll do all the computations as soon as we get the cursor values.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">int</span> DebugTimeMarkerIndex = <span class="hljs-number">0</span>;</span>
<span class="line">win32_debug_time_marker DebugTimeMarkers[GameUpdateHz / <span class="hljs-number">2</span>] = {};</span>
<span class="line"></span><div class=" delete"><span class="line">DWORD LastPlayCursor = <span class="hljs-number">0</span>;</span></div><span class="line">b32 SoundIsValid = <span class="hljs-literal">false</span>;</span>
<span class="line"></span>
<span class="line"><span class="hljs-comment">// ... </span></span>
<span class="line"><span class="hljs-comment">// Towards the end of WinMain</span></span>
<span class="line"><span class="hljs-comment">// ... </span></span>
<span class="line"></span>
<span class="line">DWORD PlayCursor = <span class="hljs-number">0</span>;</span>
<span class="line">DWORD WriteCursor= <span class="hljs-number">0</span>;</span>
<span class="line"><span class="hljs-keyword">if</span> (SUCCEEDED(GlobalSecondaryBuffer-&gt;GetCurrentPosition(&amp;PlayCursor, &amp;WriteCursor)))</span>
<span class="line">{</span><div class=" delete"><span class="line">    LastPlayCursor = PlayCursor;</span></div><span class="line">    <span class="hljs-keyword">if</span> (!SoundIsValid)</span>
<span class="line">    {</span>
<span class="line">        SoundOutput.RunningSampleIndex = WriteCursor / SoundOutput.BytesPerSample;</span>
<span class="line">        SoundIsValid = <span class="hljs-literal">true</span>;</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line"><span class="hljs-comment">//... </span></span><span class="line">f32 AudioLatencySeconds = ((f32)AudioLatencyBytes / (f32)SoundOutput.BytesPerSample) /</span>
<span class="line">                            (f32)SoundOutput.SamplesPerSecond;</span>
<span class="line"><span class="hljs-keyword">char</span> TextBuffer[<span class="hljs-number">256</span>];</span><div class=" edit"><span class="line">sprintf_s(TextBuffer, <span class="hljs-keyword">sizeof</span>(TextBuffer), <span class="hljs-string">"BTL:%u TC:%u BTW:%u - PC:%u WC:%u DELTA:%u (%.2fs)\n"</span>,</span>
<span class="line">            ByteToLock, TargetCursor, BytesToWrite,</span>
<span class="line">            PlayCursor, WriteCursor, AudioLatencyBytes, AudioLatencySeconds);</span></div><span class="line">OutputDebugStringA(TextBuffer);</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;6:</b> <file>[win32_handmade.cpp > WinMain]</file> Retiring <code>LastPlayCursor</code>.</div></center>
<p>



Also, we can say goodbye to the <code>FramesOfAudioLatency</code> and <code>LatencySampleCount</code>:

</p><pre class="listing tilde"><code><div class=" delete"><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FramesOfAudioLatency 3</span></span></div><span class="line"><span class="hljs-comment">// TODO(casey): How do we reliably query on monitor refresh rate on Windows?</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MonitorRefreshHz 60</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> GameUpdateHz (MonitorRefreshHz / 2)</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-comment">// ... </span></span>
<span class="line"></span>
<span class="line"><span class="hljs-comment">// NOTE(casey): Sound test</span></span>
<span class="line">win32_sound_output SoundOutput = {};</span>
<span class="line">SoundOutput.SamplesPerSecond = <span class="hljs-number">48000</span>;</span>
<span class="line">SoundOutput.BytesPerSample = <span class="hljs-keyword">sizeof</span>(s16) * <span class="hljs-number">2</span>;</span>
<span class="line">SoundOutput.SecondaryBufferSize = <span class="hljs-number">2</span> * SoundOutput.SamplesPerSecond * SoundOutput.BytesPerSample;</span>
<span class="line">SoundOutput.RunningSampleIndex = <span class="hljs-number">0</span>;</span><div class=" delete"><span class="line">SoundOutput.LatencySampleCount = FramesOfAudioLatency *(SoundOutput.SamplesPerSecond / GameUpdateHz);</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;7:</b> <file>[win32_handmade.cpp > WinMain]</file> Removing latency tracking.</div></center>
<p>


Clean up the struct definition in <code>win32_sound_output</code>:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">win32_sound_output</span></span>
<span class="line">{</span></span>
<span class="line">    <span class="hljs-keyword">int</span> SamplesPerSecond;</span>
<span class="line">    <span class="hljs-keyword">int</span> BytesPerSample;</span>
<span class="line">    DWORD SecondaryBufferSize;</span>
<span class="line">    u32 RunningSampleIndex;</span><div class=" delete"><span class="line">    <span class="hljs-keyword">int</span> LatencySampleCount;</span></div><span class="line">    <span class="hljs-comment">// TODO(casey): Math gets simpler if we add a "bytes per second" field?</span></span>
<span class="line">};</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;8:</b> <file>[win32_handmade.h]</file> Removing latency tracking.</div></center>
<p>



We can now consolidate the blocks dealing with the audio. For our debug code capturing the markers for visual display, we will have the own position calculation. Since it will happen quite close to the frame flip, we might as well consider these cursors as the Flip Cursors. 

</p><p>

The sound initialization block can be removed for now, and we'll move it to another section in a second.

</p><pre class="listing tilde"><code><div class=" delete"><span class="line">DWORD PlayCursor = <span class="hljs-number">0</span>;</span>
<span class="line">DWORD WriteCursor= <span class="hljs-number">0</span>;</span>
<span class="line"><span class="hljs-keyword">if</span> (SUCCEEDED(GlobalSecondaryBuffer-&gt;GetCurrentPosition(&amp;PlayCursor, &amp;WriteCursor)))</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-keyword">if</span> (!SoundIsValid)</span>
<span class="line">    {</span>
<span class="line">        SoundOutput.RunningSampleIndex = WriteCursor / SoundOutput.BytesPerSample;</span>
<span class="line">        SoundIsValid = <span class="hljs-literal">true</span>;</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span></span>
<span class="line">{</span>
<span class="line">    SoundIsValid = <span class="hljs-literal">false</span>;</span>
<span class="line">}</span></div><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> HANDMADE_INTERNAL</span></span>
<span class="line"><span class="hljs-comment">// NOTE(casey): This is debug code</span></span>
<span class="line">{</span><div class=" add"><span class="line">    DWORD FlipPlayCursor = <span class="hljs-number">0</span>;</span>
<span class="line">    DWORD FlipWriteCursor= <span class="hljs-number">0</span>;</span>
<span class="line">    <span class="hljs-keyword">if</span> (SUCCEEDED(GlobalSecondaryBuffer-&gt;GetCurrentPosition(&amp;FlipPlayCursor, &amp;FlipWriteCursor)))</span>
<span class="line">    {</span></div><span class="line">        Assert(DebugTimeMarkerIndex &lt; ArrayCount(DebugTimeMarkers));</span>
<span class="line">        win32_debug_time_marker *Marker = &amp;DebugTimeMarkers[DebugTimeMarkerIndex++];</span>
<span class="line">        <span class="hljs-keyword">if</span> (DebugTimeMarkerIndex == ArrayCount(DebugTimeMarkers))</span>
<span class="line">        {</span>
<span class="line">            DebugTimeMarkerIndex = <span class="hljs-number">0</span>;</span>
<span class="line">        }</span><div class=" edit"><span class="line">        Marker-&gt;PlayCursor = FlipPlayCursor;</span>
<span class="line">        Marker-&gt;WriteCursor = FlipWriteCursor;</span></div><div class=" add"><span class="line">    }</span></div><span class="line">}</span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;9:</b> <file>[win32_handmade.cpp > WinMain]</file> Simplifying blocks structure.</div></center>
<p>


Next, we will delete the whole block where the cursors are calculated. Not all of this code is obsolete though, <code>ByteToLock</code> part is still relevant. We will recreate it further down below.

</p><pre class="listing tilde"><code><div class=" delete"><span class="line">DWORD ByteToLock = <span class="hljs-number">0</span>;</span>
<span class="line">DWORD TargetCursor = <span class="hljs-number">0</span>;</span>
<span class="line">DWORD BytesToWrite = <span class="hljs-number">0</span>;</span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">if</span> (SoundIsValid)</span>
<span class="line">{</span>
<span class="line">    ByteToLock = ((SoundOutput.RunningSampleIndex * SoundOutput.BytesPerSample)</span>
<span class="line">                    % SoundOutput.SecondaryBufferSize);</span>
<span class="line">    </span>
<span class="line">    TargetCursor = ((LastPlayCursor +</span>
<span class="line">                        (SoundOutput.LatencySampleCount * SoundOutput.BytesPerSample))</span>
<span class="line">                    % SoundOutput.SecondaryBufferSize);</span>
<span class="line">    </span>
<span class="line">    <span class="hljs-keyword">if</span>(ByteToLock &gt; TargetCursor)</span>
<span class="line">    {</span>
<span class="line">        BytesToWrite = SoundOutput.SecondaryBufferSize - ByteToLock;</span>
<span class="line">        BytesToWrite += TargetCursor;</span>
<span class="line">    }</span>
<span class="line">    <span class="hljs-keyword">else</span></span>
<span class="line">    {</span>
<span class="line">        BytesToWrite = TargetCursor - ByteToLock;</span>
<span class="line">    }</span>
<span class="line">}</span></div><span class="line"></span>
<span class="line">game_sound_output_buffer SoundBuffer = {};</span>
<span class="line">SoundBuffer.SamplesPerSecond = SoundOutput.SamplesPerSecond;</span>
<span class="line">SoundBuffer.SampleCount = BytesToWrite / SoundOutput.BytesPerSample;</span>
<span class="line">SoundBuffer.Samples = Samples;</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;10:</b> <file>[win32_handmade.cpp > WinMain]</file> Removing previous cursor calculation routine.</div></center>
<p>


Finally, a bit further below, immediately after <code>GameUpdateAndRender</code>, we will house our new code for the audio calculation. We will add here all the pieces that were useful in the past, all in one place:

</p><p>

<ol start=1>
<li class="number">Capture position of the Play and Write cursors.
</li>
<li class="number">If the sound is not valid (we've just started, or something happened), initialize the <code>RunningSampleIndex</code>. This functionality is the same as we had before.
</li>
<li class="number">Calculate <code>ByteToLock</code> (same as before).
</li>
<li class="number">Calculate <code>TargetCursor</code> (same as before, for a moment, but already set up for eventual change).
</li>
<li class="number">Calculate <code>BytesToWrite</code> (same as before).
</li>
<li class="number">Fill the sound buffer with the samples we collected during <code>GameUpdateAndRender</code>.
</li>
<li class="number">If we're in debug mode (<code>HANDMADE_INTERNAL</code>), print out the various values we computed above.
</li>
<li class="number">Last, if by any chance <code>GetCurrentPosition</code> fails, we will do nothing of the above and simply mark <code>SoundIsValid</code> false.</li></ol>

</p><pre class="listing tilde"><code><span class="line">GameUpdateAndRender(...);</span>
<span class="line"></span><div class=" add"><span class="line">DWORD PlayCursor;</span>
<span class="line">DWORD WriteCursor;</span>
<span class="line"><span class="hljs-keyword">if</span> (GlobalSecondaryBuffer-&gt;GetCurrentPosition(&amp;PlayCursor, &amp;WriteCursor) == DS_OK)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-keyword">if</span> (!SoundIsValid)</span>
<span class="line">    {</span>
<span class="line">        SoundOutput.RunningSampleIndex = WriteCursor / SoundOutput.BytesPerSample;</span>
<span class="line">        SoundIsValid = <span class="hljs-literal">true</span>;</span>
<span class="line">    }</span>
<span class="line">    </span>
<span class="line">    DWORD ByteToLock = ((SoundOutput.RunningSampleIndex * SoundOutput.BytesPerSample)</span>
<span class="line">                        % SoundOutput.SecondaryBufferSize);</span>
<span class="line">        </span>
<span class="line">    DWORD TargetCursor = <span class="hljs-number">0</span>;</span>
<span class="line">    TargetCursor = ((LastPlayCursor +</span>
<span class="line">                        (SoundOutput.LatencySampleCount * SoundOutput.BytesPerSample))</span>
<span class="line">                    % SoundOutput.SecondaryBufferSize);</span>
<span class="line">    </span>
<span class="line">    DWORD BytesToWrite = <span class="hljs-number">0</span>;</span>
<span class="line">    <span class="hljs-keyword">if</span>(ByteToLock &gt; TargetCursor)</span>
<span class="line">    {</span>
<span class="line">        BytesToWrite = SoundOutput.SecondaryBufferSize - ByteToLock;</span>
<span class="line">        BytesToWrite += TargetCursor;</span>
<span class="line">    }</span>
<span class="line">    <span class="hljs-keyword">else</span></span>
<span class="line">    {</span>
<span class="line">        BytesToWrite = TargetCursor - ByteToLock;</span>
<span class="line">    }</span></div><div class=" delete"><span class="line"><span class="hljs-keyword">if</span>(SoundIsValid)</span>
<span class="line">{</span></div><span class="line">    Win32FillSoundBuffer(&amp;SoundOutput, ByteToLock, BytesToWrite, &amp;SoundBuffer);</span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> HANDMADE_INTERNAL</span></span><div class=" delete"><span class="line">    DWORD PlayCursor;</span>
<span class="line">    DWORD WriteCursor;</span>
<span class="line">    GlobalSecondaryBuffer-&gt;GetCurrentPosition(&amp;PlayCursor, &amp;WriteCursor);</span></div><span class="line">    </span>
<span class="line">    DWORD UnwrappedWriteCursor = WriteCursor;</span>
<span class="line">    <span class="hljs-keyword">if</span> (UnwrappedWriteCursor &lt; PlayCursor)</span>
<span class="line">    {</span>
<span class="line">        UnwrappedWriteCursor += SoundOutput.SecondaryBufferSize;</span>
<span class="line">    }</span>
<span class="line">    DWORD AudioLatencyBytes = UnwrappedWriteCursor - PlayCursor;</span>
<span class="line">    f32 AudioLatencySeconds = ((f32)AudioLatencyBytes / (f32)SoundOutput.BytesPerSample) /</span>
<span class="line">                               (f32)SoundOutput.SamplesPerSecond;</span>
<span class="line">    <span class="hljs-keyword">char</span> TextBuffer[<span class="hljs-number">256</span>];</span>
<span class="line">    sprintf_s(TextBuffer, <span class="hljs-keyword">sizeof</span>(TextBuffer), </span>
<span class="line">                <span class="hljs-string">"LPC:%u BTL:%u TC:%u BTW:%u - PC:%u WC:%u DELTA:%u (%.2fs)\n"</span>,</span>
<span class="line">                LastPlayCursor, ByteToLock, TargetCursor, BytesToWrite,</span>
<span class="line">                PlayCursor, WriteCursor, AudioLatencyBytes, AudioLatencySeconds);</span>
<span class="line">    OutputDebugStringA(TextBuffer);</span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span>
<span class="line">}</span><div class=" add"><span class="line">{</span>
<span class="line">    <span class="hljs-comment">// GetCurrentPosition didn't succeed</span></span>
<span class="line">    SoundIsValid = <span class="hljs-literal">false</span>;</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;11:</b> <file>[win32_handmade.cpp > WinMain]</file> Simplifying and combining audio blocks.</div></center>
<p>


Last, we want to record our theory for the audio paths, so let's annotate what we decided: 

</p><pre class="listing tilde"><code><span class="line">DWORD PlayCursor;</span>
<span class="line">DWORD WriteCursor;</span>
<span class="line"><span class="hljs-keyword">if</span> (GlobalSecondaryBuffer-&gt;GetCurrentPosition(&amp;PlayCursor, &amp;WriteCursor) == DS_OK)</span>
<span class="line">{</span><div class=" add"><span class="line">    <span class="hljs-comment">/* NOTE(casey):</span>
<span class="line hljs-comment">       </span>
<span class="line hljs-comment">       Here is how sound output computation works.</span>
<span class="line hljs-comment">     </span>
<span class="line hljs-comment">       We define a safety value that is the number </span>
<span class="line hljs-comment">       of samples we think our game update loop </span>
<span class="line hljs-comment">       may vary by (let's say up to 2ms). </span>
<span class="line hljs-comment">     </span>
<span class="line hljs-comment">       When we wake up to write audio, we will look</span>
<span class="line hljs-comment">       and see what the play cursor position is and we</span>
<span class="line hljs-comment">       will forecast ahead where we think the</span>
<span class="line hljs-comment">       play cursor will be on the next frame boundary.</span>
<span class="line hljs-comment">     </span>
<span class="line hljs-comment">       We will then look to see if the write cursor is</span>
<span class="line hljs-comment">       before that by at least our safety value. If it is, the</span>
<span class="line hljs-comment">       target fill position is that frame boundary</span>
<span class="line hljs-comment">       plus one frame. This gives us perfect audio</span>
<span class="line hljs-comment">       sync in the case of a card that has low enough</span>
<span class="line hljs-comment">       latency.</span>
<span class="line hljs-comment">     </span>
<span class="line hljs-comment">       If the write cursor is _after_ that safety </span>
<span class="line hljs-comment">       margin, then we assume we can never sync the</span>
<span class="line hljs-comment">       audio perfectly, so we will write one frame's</span>
<span class="line hljs-comment">       worth of audio plus the safety margin's worth</span>
<span class="line hljs-comment">       of guard samples.</span>
<span class="line hljs-comment">    */</span></span></div><span class="line"><span class="hljs-keyword">if</span> (!SoundIsValid)</span>
<span class="line">{</span>
<span class="line">    SoundOutput.RunningSampleIndex = WriteCursor / SoundOutput.BytesPerSample;</span>
<span class="line">    SoundIsValid = <span class="hljs-literal">true</span>;</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;12:</b> <file>[win32_handmade.cpp > WinMain]</file> Noting down our theory.</div></center>

<a class="target" name="changetargetcursorcalculation">&nbsp;</a><a class="target" name="implementthetwoaudiopaths/changetargetcursorcalculation">&nbsp;</a><a class="target" name="toc2.2">&nbsp;</a><h2>Change <code>TargetCursor</code> Calculation</h2>
<p>


Everything is set up. Let's go ahead with the changes we need. We'll write how we imagine target cursor calculation first and think about making it happen later.

</p><p>

<ul>
<li class="asterisk">For the fast path (low latency card), we would position ourselves at the next frame's expected boundary.
</li>
<li class="asterisk">For the slow approach, the write cursor position would be moved by one frame's length (with some added safety bytes).</li></ul>

</p><p>

In both cases, the resulting value may be greater than our buffer's size, so to bind it, we'll simply <em class="underscore">modulo</em> it against the buffer size. As a reminder, <em class="underscore">modulo</em> operator (<code>%</code>) keeps the remainder of a given division.

</p><pre class="listing tilde"><code><span class="line">DWORD TargetCursor = <span class="hljs-number">0</span>;</span><div class=" add"><span class="line"><span class="hljs-keyword">if</span> (AudioCardIsLowLatency)</span>
<span class="line">{</span></div><div class=" edit"><span class="line">    TargetCursor = ExpectedFrameBoundaryByte + ExpectedSoundBytesPerFrame;</span></div><div class=" add"><span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span></span>
<span class="line">{</span>
<span class="line">    TargetCursor = WriteCursor + ExpectedSoundBytesPerFrame + SoundOutput.SafetyBytes;</span>
<span class="line">}</span>
<span class="line">TargetCursor = TargetCursor % SoundOutput.SecondaryBufferSize;</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;13:</b> <file>[win32_handmade.cpp > WinMain]</file> Preparing two cases for TargetCursor calculation.</div></center>
<p>


Now we just have to compute all those new values. 

</p>
<a class="target" name="audiocardislowlatency">&nbsp;</a><a class="target" name="implementthetwoaudiopaths/changetargetcursorcalculation/audiocardislowlatency">&nbsp;</a><a class="target" name="toc2.2.1">&nbsp;</a><h3>AudioCardIsLowLatency</h3>
<p>


Let's start with <code>AudioCardIsLowLatency</code>. We define the latency by taking <code>ExpectedFrameBoundaryByte</code> and check if it's greater than the write cursor with the safety margin.

</p><pre class="listing tilde"><code><div class=" add"><span class="line">b32 AudioCardIsLowLatency = <span class="hljs-literal">true</span>;</span>
<span class="line">DWORD SafeWriteCursor = WriteCursor + SoundOutput.SafetyBytes;</span>
<span class="line"><span class="hljs-keyword">if</span> (SafeWriteCursor &gt;= ExpectedFrameBoundaryByte)</span>
<span class="line">{</span>
<span class="line">    AudioCardIsLowLatency = <span class="hljs-literal">false</span>;</span>
<span class="line">}</span></div><span class="line">DWORD TargetCursor = <span class="hljs-number">0</span>;</span>
<span class="line"><span class="hljs-keyword">if</span> (AudioCardIsLowLatency)</span>
<span class="line"><span class="hljs-comment">//...</span></span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;14:</b> <file>[win32_handmade.cpp > WinMain]</file> Determining if our sound card is latent.</div></center>
<p>


Or, in other words, 

</p><pre class="listing tilde"><code><div class=" edit"><span class="line">DWORD SafeWriteCursor = WriteCursor + SoundOutput.SafetyBytes;</span>
<span class="line">b32 AudioCardIsLowLatency = SafeWriteCursor &lt; ExpectedFrameBoundaryByte;</span></div><span class="line"></span>
<span class="line">DWORD TargetCursor = <span class="hljs-number">0</span>;</span>
<span class="line"><span class="hljs-keyword">if</span> (AudioCardIsLowLatency)</span>
<span class="line"><span class="hljs-comment">//...</span></span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;15:</b> <file>[win32_handmade.cpp > WinMain]</file> A more concise notation of the above.</div></center>
<p>


However, there's always the circular buffer issue that we need to take into account: if the write cursor is behind the play cursor, it means the buffer wrapped, and we need to &ldquo;unwrap&rdquo; the cursor as we've done earlier: simply add the sound buffer size to write cursor's value.

</p><pre class="listing tilde"><code><div class=" edit"><span class="line">DWORD SafeWriteCursor = WriteCursor;</span></div><div class=" add"><span class="line"><span class="hljs-keyword">if</span> (SafeWriteCursor &lt; PlayCursor)</span>
<span class="line">{</span>
<span class="line">    SafeWriteCursor += SoundOutput.SecondaryBufferSize;</span>
<span class="line">}</span>
<span class="line">Assert(SafeWriteCursor &gt;= PlayCursor);</span>
<span class="line">SafeWriteCursor += SoundOutput.SafetyBytes;</span></div><span class="line">b32 AudioCardIsLowLatency = SafeWriteCursor &lt; ExpectedFrameBoundaryByte;</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;16:</b> <file>[win32_handmade.cpp > WinMain]</file> Normalizing write cursor.</div></center>

<a class="target" name="expectedframeboundarybyte">&nbsp;</a><a class="target" name="implementthetwoaudiopaths/changetargetcursorcalculation/expectedframeboundarybyte">&nbsp;</a><a class="target" name="toc2.2.2">&nbsp;</a><h3>ExpectedFrameBoundaryByte</h3>
<p>


<code>ExpectedFrameBoundaryByte</code> seems reasonably straightforward. We capture the play cursor already, which represents our current position in time. Therefore, we simply add whatever amount of sound bytes we expect per frame.

</p><p>

<div class="admonition ">If you spotted a mistake in our logic here, well done! We will return to this at the end of the chapter as it will prove key to a bug.</div>

</p><pre class="listing tilde"><code><div class=" add"><span class="line">DWORD ExpectedFrameBoundaryByte = PlayCursor + ExpectedSoundBytesPerFrame;</span></div><span class="line">DWORD SafeWriteCursor = WriteCursor + SoundOutput.SafetyBytes;</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;17:</b> <file>[win32_handmade.cpp > WinMain]</file> Calculating expected frame flip boundary.</div></center>

<a class="target" name="expectedsoundbytesperframe">&nbsp;</a><a class="target" name="implementthetwoaudiopaths/changetargetcursorcalculation/expectedsoundbytesperframe">&nbsp;</a><a class="target" name="toc2.2.3">&nbsp;</a><h3>ExpectedSoundBytesPerFrame</h3>
<p>


When it comes to calculate how many sound bytes we expect per frame, we can get help from the dimensional analysis once again: 

</p><p>

<ul>
<li class="asterisk">We want to know how many sound bytes are in a frame, or \(\frac{bytes}{frame}\)
</li>
<li class="asterisk">We know how many frames do we want to have in a second, \(\frac{frames}{second}\). We currently capture this value in <code>GameUpdateHz</code>. 
</li>
<li class="asterisk">We also know how to calculate bytes per second, we didn't capture this value just yet, but we have done this multiple times in the past: it's \(\frac{samples}{second} \times \frac{bytes}{samples} = \frac{bytes}{second}\).
</li>
<li class="asterisk">So in order to calculate the \(\frac{bytes}{frame}\), we should divide \(\frac{bytes}{second}\) over \(\frac{frames}{second}\):</li></ul>

</p><p>

$$ \frac { \frac{bytes}{second} }{ \frac{frames}{second} } = $$
$$ \frac {bytes}{second} \times \frac{seconds}{frame} = $$
$$ \frac {bytes \times \bcancel{seconds}}{\bcancel{second} \times frame} =$$
$$ \frac {bytes}{frame} $$

</p><p>

Let's put it in code:

</p><pre class="listing tilde"><code><div class=" add"><span class="line">DWORD ExpectedSoundBytesPerFrame = (SoundOutput.SamplesPerSecond * SoundOutput.BytesPerSample)</span>
<span class="line">                            / GameUpdateHz ;</span>
<span class="line"></span></div><span class="line">DWORD ExpectedFrameBoundaryByte = PlayCursor + ExpectedSoundBytesPerFrame;</span>
<span class="line">DWORD SafeWriteCursor = WriteCursor;</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;18:</b> <file>[win32_handmade.cpp > WinMain]</file> Calculating expected sound bytes per frame.</div></center>

<a class="target" name="safetybytes">&nbsp;</a><a class="target" name="implementthetwoaudiopaths/changetargetcursorcalculation/safetybytes">&nbsp;</a><a class="target" name="toc2.2.4">&nbsp;</a><h3>SafetyBytes</h3>
<p>


Finally, we need to decide what do we consider a safety margin. What is a safety margin? It's a potential variance in frame length or how much a frame can go outside of its intended frequency.

</p><p>

It would be a relatively small length but not inconsiderate: we could say it's a third of a frame. We can adjust this value later on if necessary and maybe even compute the variance in the future.

</p><p>

We already know how to calculate sound bytes per frame, so let's simply say it's that value divided by three.

</p><p>

Also, we can incorporate the result as a part of the sound output structure. 

</p><pre class="listing tilde"><code><span class="line">win32_sound_output SoundOutput = {};</span>
<span class="line">SoundOutput.SamplesPerSecond = <span class="hljs-number">48000</span>;</span>
<span class="line">SoundOutput.BytesPerSample = <span class="hljs-keyword">sizeof</span>(s16) * <span class="hljs-number">2</span>;</span>
<span class="line">SoundOutput.SecondaryBufferSize = <span class="hljs-number">2</span> * SoundOutput.SamplesPerSecond * SoundOutput.BytesPerSample;</span>
<span class="line">SoundOutput.RunningSampleIndex = <span class="hljs-number">0</span>;</span><div class=" add"><span class="line"><span class="hljs-comment">// TODO(casey): Actually compute this variance and see </span></span>
<span class="line"><span class="hljs-comment">// what the lowest reasonable value is.</span></span>
<span class="line">SoundOutput.SafetyBytes = (SoundOutput.SamplesPerSecond * SoundOutput.BytesPerSample) </span>
<span class="line">    / GameUpdateHz) / <span class="hljs-number">3</span>;</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;19:</b> <file>[win32_handmade.cpp > WinMain]</file> Calculating safety bytes.</div></center>
<pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">win32_sound_output</span></span>
<span class="line">{</span></span>
<span class="line">    <span class="hljs-keyword">int</span> SamplesPerSecond;</span>
<span class="line">    <span class="hljs-keyword">int</span> BytesPerSample;</span>
<span class="line">    DWORD SecondaryBufferSize;</span>
<span class="line">    u32 RunningSampleIndex;</span><div class=" add"><span class="line">    DWORD SafetyBytes;</span></div><span class="line">    <span class="hljs-comment">// TODO(casey): Math gets simpler if we add a "bytes per second" field?</span></span>
<span class="line">};</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;20:</b> <file>[win32_handmade.h]</file> Updating <code>win32_sound_output</code> structure.</div></center>
<p>


This should be the end of it. We would now be compilable, so take your time to fix any typing errors you might have and make sure your game is running as before.

</p>
<a class="target" name="introducegamegetsoundsamples">&nbsp;</a><a class="target" name="introducegamegetsoundsamples">&nbsp;</a><a class="target" name="toc3">&nbsp;</a><h1>Introduce <code>GameGetSoundSamples</code></h1>
<p>


Until now, we've been working based on the assumption that we know how current frame's length. But we don't really; we only have an estimate based on the previous frames' data. We already moved the target cursor calculation after <code>GameUpdateAndRender</code> to mitigate this issue, but what this does is merely preparing the target cursor for the next frame (hoping that it will be as long as the current one). It doesn't really address the core issue. 

</p><p>

This all should be fine since we know the <em class="underscore">expected</em> frame time and we have our safety margins, and we're preparing ourselves for the victory, and it's all nice and straightforward. 

</p><p>

Right?

</p><p>

Getting real audio sync is complicated. We need to sync two clocks - the game clock and the audio API clock. We also need to know the number of bytes to ask from the game; to discover that we need to prepare the samples... so it's getting into a bit of a vicious cycle.

</p><p>

Maybe it's time for a big decision. We will separate game writing audio from the game doing the world update and rendering!

</p><p>

Let's make it happen. First of all, we will introduce the new function declaration inside <code>handmade.h</code>. It will essentially be the same as <code>GameUpdateAndRender</code>, except it will take a sound buffer instead of input and render buffer.

</p><p>

We will also remove the sound buffer from <code>GameUpdateAndRender</code>, like so: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">game_memory</span></span>
<span class="line">{</span></span>
<span class="line">    u64 PermanentStorageSize;</span>
<span class="line">    <span class="hljs-keyword">void</span> *PermanentStorage;</span>
<span class="line">    u64 TransientStorageSize;</span>
<span class="line">    <span class="hljs-keyword">void</span> *TransientStorage;</span>
<span class="line">    b32 IsInitialized;</span>
<span class="line">};</span>
<span class="line"></span><div class=" edit"><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span> <span class="hljs-title">GameUpdateAndRender</span><span class="hljs-params">(game_memory *Memory, game_input *Input, game_offscreen_buffer* Buffer)</span></span>;</span></div><div class=" add"><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span> <span class="hljs-title">GameGetSoundSamples</span><span class="hljs-params">(game_memory *Memory, game_sound_output_buffer *SoundBuffer)</span></span>;</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;21:</b> <file>[handmade.h]</file> Splitting sound update from the rest of the game update.</div></center>
<p>


Next, we will move the necessary preparations of the sound buffer and call our new function after we finished writing our audio: 

</p><pre class="listing tilde"><code><div class=" delete"><span class="line">game_sound_output_buffer SoundBuffer = {};</span>
<span class="line">SoundBuffer.SamplesPerSecond = SoundOutput.SamplesPerSecond;</span>
<span class="line">SoundBuffer.SampleCount = BytesToWrite / SoundOutput.BytesPerSample;</span>
<span class="line">SoundBuffer.Samples = Samples;</span>
<span class="line"></span></div><span class="line"></span>
<span class="line">game_offscreen_buffer Buffer = {};</span>
<span class="line">Buffer.Memory = GlobalBackbuffer.Memory;</span>
<span class="line">Buffer.Width = GlobalBackbuffer.Width;</span>
<span class="line">Buffer.Height = GlobalBackbuffer.Height;</span>
<span class="line">Buffer.Pitch = GlobalBackbuffer.Pitch;</span>
<span class="line"></span><div class=" edit"><span class="line">GameUpdateAndRender(&amp;GameMemory, NewInput, &amp;Buffer);</span></div><span class="line"></span>
<span class="line">DWORD PlayCursor;</span>
<span class="line">DWORD WriteCursor;</span>
<span class="line"><span class="hljs-keyword">if</span> (GlobalSecondaryBuffer-&gt;GetCurrentPosition(&amp;PlayCursor, &amp;WriteCursor) == DS_OK)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">    DWORD BytesToWrite = <span class="hljs-number">0</span>;</span>
<span class="line">    <span class="hljs-keyword">if</span>(ByteToLock &gt; TargetCursor)</span>
<span class="line">    {</span>
<span class="line">        BytesToWrite = SoundOutput.SecondaryBufferSize - ByteToLock;</span>
<span class="line">        BytesToWrite += TargetCursor;</span>
<span class="line">    }</span>
<span class="line">    <span class="hljs-keyword">else</span></span>
<span class="line">    {</span>
<span class="line">        BytesToWrite = TargetCursor - ByteToLock;</span>
<span class="line">    }</span>
<span class="line"></span><div class=" add"><span class="line">    game_sound_output_buffer SoundBuffer = {};</span>
<span class="line">    SoundBuffer.SamplesPerSecond = SoundOutput.SamplesPerSecond;</span>
<span class="line">    SoundBuffer.SampleCount = BytesToWrite / SoundOutput.BytesPerSample;</span>
<span class="line">    SoundBuffer.Samples = Samples;</span>
<span class="line"></span>
<span class="line">    GameGetSoundSamples(&amp;GameMemory, &amp;SoundBuffer);</span></div><span class="line">    Win32FillSoundBuffer(&amp;SoundOutput, ByteToLock, BytesToWrite, &amp;SoundBuffer);</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;22:</b> <file>[win32_handmade.cpp > WinMain]</file> Using <code>GameGetSoundSamples</code>.</div></center>
<p>


Now, we shall look at what is happening inside <code>handmade.cpp</code>. Looking at it, we see that we already set ourselves for success by separating the sound logic away from most of <code>GameUpdateAndRender</code> into a single function. Let's finish the job by introducing the new function definition:

</p><pre class="listing tilde"><code><span class="line">internal <span class="hljs-keyword">void</span></span><div class=" edit"><span class="line">GameUpdateAndRender(game_memory* Memory, game_input *Input, game_offscreen_buffer* Buffer)</span></div><span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">    </span><div class=" delete"><span class="line">    GameSoundOutput(SoundBuffer, GameState-&gt;ToneHz);</span></div><span class="line">    RenderWeirdGradient(Buffer, GameState-&gt;XOffset, GameState-&gt;YOffset);</span>
<span class="line">}</span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">GameGetSoundSamples</span><span class="hljs-params">(game_memory* Memory, game_sound_output_buffer *SoundBuffer)</span></span>
<span class="line"></span>{</span>
<span class="line">    game_state *GameState = (game_state*)Memory;</span>
<span class="line">    GameSoundOutput(SoundBuffer, GameState-&gt;ToneHz);</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;23:</b> <file>[win32_handmade.cpp]</file> Defining <code>GameGetSoundSamples</code>.</div></center>
<p>


And... that's all there was to it. Our game updates the world state, and then the sound system comes in and writes the sound based on it. 

</p><p>

However, it's not over yet. We have written tons of code until now, so we can probably find some bugs to catch. 

</p>
<a class="target" name="evenmoredebugging">&nbsp;</a><a class="target" name="evenmoredebugging">&nbsp;</a><a class="target" name="toc4">&nbsp;</a><h1>Even More Debugging</h1>
<p>


Let's have some fun! We want to finish debugging sound and avoid having to spend tons of time reading our logs. On the other hand, we have our debug line drawing routine that we can leverage. 

</p>
<a class="target" name="addglobalpausekey">&nbsp;</a><a class="target" name="evenmoredebugging/addglobalpausekey">&nbsp;</a><a class="target" name="toc4.1">&nbsp;</a><h2>Add Global Pause Key</h2>
<p>


The first thing that we will do, though, is not drawing. Our graph is running quite fast, so a pause button that would stop the simulation altogether would be great for this case and potentially for the future. 

</p><p>

Currently, we have our main loop based on the global variable <code>GlobalRunning</code>. We could introduce a new global for pause purposes.

</p><pre class="listing tilde"><code><span class="line">global_variable b32 GlobalRunning;</span><div class=" add"><span class="line">global_variable b32 GlobalPause;</span></div><span class="line">global_variable win32_offscreen_buffer GlobalBackbuffer;</span>
<span class="line">global_variable IDirectSoundBuffer *GlobalSecondaryBuffer;</span>
<span class="line">global_variable s64 GlobalPerfCountFrequency;</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;24:</b> <file>[win32_handmade.cpp]</file> Introducing Global Pause.</div></center>
<p>


Now we can toggle this paused state on and off by pressing a key, say 'P'. If the pause is on, it will be toggled off, and the contrary.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == VK_BACK)</span>
<span class="line">{</span>
<span class="line">    Win32ProcessKeyboardMessages(&amp;KeyboardController-&gt;Back, IsDown);</span>
<span class="line">}</span><div class=" add"><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> HANDMADE_INTERNAL</span></span>
<span class="line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VKCode == <span class="hljs-string">'P'</span>)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-keyword">if</span> (IsDown)</span>
<span class="line">    {</span>
<span class="line">        GlobalPause = !GlobalPause;</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span>
<span class="line"></span>
<span class="line">b32 AltKeyWasDown = ((Message.lParam &amp; (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">29</span>)) != <span class="hljs-number">0</span>);</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;25:</b> <file>[win32_handmade.cpp > Win32ProcessPendingMessages]</file> Adding Global Pause Hotkey.</div></center>
<p>


As for the functionality, we will introduce a big <code>if</code> block immediately following our keyboard processing routine. If the pause is not on, we will execute the rest of the code. If it is, we will simply skip to the next iteration of the <code>GlobalRunning</code> loop, leaving our buffers in the same state as they were.

</p><pre class="listing tilde"><code><span class="line">Win32ProcessPendingMessages(NewKeyboardController);</span><div class=" add"><span class="line"><span class="hljs-keyword">if</span> (!GlobalPause)</span>
<span class="line">{</span></div><span class="line">    DWORD MaxControllerCount = XUSER_MAX_COUNT;</span>
<span class="line">    <span class="hljs-keyword">if</span>(MaxControllerCount &gt; (ArrayCount(NewInput-&gt;Controllers) - <span class="hljs-number">1</span>))</span>
<span class="line">    {</span>
<span class="line">        MaxControllerCount = (ArrayCount(NewInput-&gt;Controllers) - <span class="hljs-number">1</span>);</span>
<span class="line">    }</span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">    <span class="hljs-comment">// All of the game update</span></span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">    </span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> HANDMADE_INTERNAL</span></span>
<span class="line">    ++DebugTimeMarkerIndex;</span>
<span class="line">    <span class="hljs-keyword">if</span> (DebugTimeMarkerIndex == ArrayCount(DebugTimeMarkers))</span>
<span class="line">    {</span>
<span class="line">        DebugTimeMarkerIndex = <span class="hljs-number">0</span>;</span>
<span class="line">    }</span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span><div class=" add"><span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;26:</b> <file>[win32_handmade.cpp > WinMain]</file> Implementing Global Pause.</div></center>
<p>




<div class="admonition warning">This is not how you should make your final game pause state! Keep in mind that, with this pause, our sleep-based frame cycle goes straight out of the window. It's a quick and easy tool to help us with debugging.</div>

</p><p>

<center><div class="image" style=""><a href="../media/day20/global_pause.jpg" target="_blank"><img class="markdeep" src="../media/day20/global_pause.jpg" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;10:</b> If your <code>WinMain</code> block nesting is confusing you, this is how the end of the file should look like.</span></center></div></center> 

</p>
<a class="target" name="highlightlatestmarker">&nbsp;</a><a class="target" name="evenmoredebugging/highlightlatestmarker">&nbsp;</a><a class="target" name="toc4.2">&nbsp;</a><h2>Highlight Latest Marker</h2>
<p>


Currently, we're visualizing all the markers containing play and writing cursors at the same level. We can highlight the latest one to give it a bit more importance. Let's say there's a current marker index, and if we hit it, we draw that marker under the rest. 

</p><p>

This is how it would look in our drawing routine: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">Win32DebugSyncDisplay</span><span class="hljs-params">(win32_offscreen_buffer *Backbuffer,</span>
<span class="line">                      <span class="hljs-keyword">int</span> MarkerCount, win32_debug_time_marker *Markers,</span></span></span><div class=" add"><span class="line">                      <span class="hljs-keyword">int</span> CurrentMarkerIndex,</span></div><span class="line">                      win32_sound_output *SoundOutput, f32 TargetSecondsPerFrame)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-keyword">int</span> PadX = <span class="hljs-number">16</span>;</span>
<span class="line">    <span class="hljs-keyword">int</span> PadY = <span class="hljs-number">16</span>;</span>
<span class="line">    </span><div class=" add"><span class="line">    <span class="hljs-keyword">int</span> LineHeight = <span class="hljs-number">64</span>;</span></div><div class=" delete"><span class="line">    <span class="hljs-keyword">int</span> Top = PadY;</span>
<span class="line">    <span class="hljs-keyword">int</span> Bottom = Backbuffer-&gt;Height - PadY;</span></div><span class="line">    </span>
<span class="line">    f32 C = (f32)(Backbuffer-&gt;Width - <span class="hljs-number">2</span> * PadX) / (f32)SoundOutput-&gt;SecondaryBufferSize;</span>
<span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> MarkerIndex = <span class="hljs-number">0</span>;</span>
<span class="line">         MarkerIndex &lt; MarkerCount;</span>
<span class="line">         ++MarkerIndex)</span>
<span class="line">    {</span><div class=" add"><span class="line">        DWORD PlayColor = <span class="hljs-number">0xFFFFFFFF</span>;</span>
<span class="line">        DWORD WriteColor = <span class="hljs-number">0xFFFF0000</span>;</span>
<span class="line">        </span>
<span class="line">        <span class="hljs-keyword">int</span> Top = PadY;</span>
<span class="line">        <span class="hljs-keyword">int</span> Bottom = PadY + LineHeight;</span>
<span class="line">        </span>
<span class="line">        <span class="hljs-keyword">if</span> (MarkerIndex == CurrentMarkerIndex)</span>
<span class="line">        {</span>
<span class="line">            Top += LineHeight + PadY;</span>
<span class="line">            Bottom += LineHeight + PadY;</span>
<span class="line">        }</span></div><span class="line">        </span>
<span class="line">        win32_debug_time_marker *ThisMarker = &amp;Markers[MarkerIndex];</span><div class=" edit"><span class="line">        Win32DrawSoundBufferMarker(Backbuffer, SoundOutput, C, PadX, Top, Bottom, ThisMarker-&gt;PlayCursor, PlayColor);</span>
<span class="line">        Win32DrawSoundBufferMarker(Backbuffer, SoundOutput, C, PadX, Top, Bottom, ThisMarker-&gt;WriteCursor, WriteColor);</span></div><span class="line">    }</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;27:</b> <file>[win32_handmade.cpp]</file> Improving <code>Win32DebugSyncDisplay</code>.</div></center>
<p>


To get it to work, we need to pass the current marker index to the function. Since we're advancing <code>DebugTimeMarkerIndex</code> to write the markers, we can simply give it as is. 

</p><p>

It somewhat introduces a bug on the 0th index (as it underflows to the maximum number), but we don't really care since it's the debug code. We'll leave a todo for the time being.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> HANDMADE_INTERNAL</span></span><div class=" add"><span class="line"><span class="hljs-comment">// TODO(casey): Note, current is wrong on the zeroth index</span></span></div><span class="line">Win32DebugSyncDisplay(&amp;GlobalBackbuffer,</span>
<span class="line">                        ArrayCount(DebugTimeMarkers), DebugTimeMarkers,</span><div class=" add"><span class="line">                        DebugTimeMarkerIndex - <span class="hljs-number">1</span>,</span></div><span class="line">                        &amp;SoundOutput, TargetSecondsPerFrame);</span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;28:</b> <file>[win32_handmade.cpp > WinMain]</file> Passing current marker index.</div></center>
<p>


Compile and run to make sure that everything is working

</p>
<a class="target" name="recordmorevalues">&nbsp;</a><a class="target" name="evenmoredebugging/recordmorevalues">&nbsp;</a><a class="target" name="toc4.3">&nbsp;</a><h2>Record More Values</h2>
<p>


We have this newfound space for our current marker that we can utilize to display more values. Heck, we can even go all in and get to show as many values that we have.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">win32_debug_time_marker</span></span>
<span class="line">{</span></span><div class=" add"><span class="line">    DWORD OutputPlayCursor;</span>
<span class="line">    DWORD OutputWriteCursor;</span>
<span class="line">    DWORD OutputLocation; </span>
<span class="line">    DWORD OutputByteCount;</span>
<span class="line">    </span></div><div class=" edit"><span class="line">    DWORD FlipPlayCursor;</span>
<span class="line">    DWORD FlipWriteCursor;</span></div><span class="line">};</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;29:</b> <file>[win32_handmade.h]</file> Updating old values and adding some new ones.</div></center>
<p>


We have our play cursor and write cursor at the frame flip time (that we'll call <code>FlipPlayCursor</code> and <code>FlipWriteCursor</code>), cursors at the output time, byte to lock, and how many bytes to write. 

</p><p>

However, since we now utilize a marker in more than one place, we can't really advance the <code>DebugTimeMarkerIndex</code> when we access it. We'll do it at the very end of our frame before we're ready to flip.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> HANDMADE_INTERNAL</span></span>
<span class="line"><span class="hljs-comment">// NOTE(casey): This is debug code</span></span>
<span class="line">{</span>
<span class="line">    DWORD FlipPlayCursor = <span class="hljs-number">0</span>;</span>
<span class="line">    DWORD FlipWriteCursor= <span class="hljs-number">0</span>;</span>
<span class="line">    <span class="hljs-keyword">if</span> (SUCCEEDED(GlobalSecondaryBuffer-&gt;GetCurrentPosition(&amp;FlipPlayCursor, &amp;FlipWriteCursor)))</span>
<span class="line">    {</span>
<span class="line">        Assert(DebugTimeMarkerIndex &lt; ArrayCount(DebugTimeMarkers));</span><div class=" edit"><span class="line">        win32_debug_time_marker *Marker = &amp;DebugTimeMarkers[DebugTimeMarkerIndex];</span></div><div class=" delete"><span class="line">        <span class="hljs-keyword">if</span> (DebugTimeMarkerIndex == ArrayCount(DebugTimeMarkers))</span>
<span class="line">        {</span>
<span class="line">            DebugTimeMarkerIndex = <span class="hljs-number">0</span>;</span>
<span class="line">        }</span></div><div class=" edit"><span class="line">        Marker-&gt;FlipPlayCursor = FlipPlayCursor;</span>
<span class="line">        Marker-&gt;FlipWriteCursor = FlipWriteCursor;</span></div><span class="line">    }</span>
<span class="line">}</span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span>
<span class="line"></span>
<span class="line"><span class="hljs-comment">// ... </span></span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> 0</span></span>
<span class="line"><span class="hljs-comment">// debug timing output</span></span>
<span class="line"><span class="hljs-comment">// ...</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> HANDMADE_INTERNAL</span></span>
<span class="line">++DebugTimeMarkerIndex;</span>
<span class="line"><span class="hljs-keyword">if</span> (DebugTimeMarkerIndex == ArrayCount(DebugTimeMarkers))</span>
<span class="line">{</span>
<span class="line">    DebugTimeMarkerIndex = <span class="hljs-number">0</span>;</span>
<span class="line">}</span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;30:</b> <file>[win32_handmade.cpp > WinMain]</file> Making sure time marker index is only updated once per frame.</div></center>
<p>


Now that we have a more permanent marker index, we can access the marker from our sound code. Let's do it in the <code>HANDMADE_INTERNAL</code> section, where we print out the values to the Output console.

</p><pre class="listing tilde"><code><span class="line">GameGetSoundSamples(&amp;GameMemory, &amp;SoundBuffer);</span>
<span class="line">                        </span>
<span class="line">Win32FillSoundBuffer(&amp;SoundOutput, ByteToLock, BytesToWrite, &amp;SoundBuffer);</span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> HANDMADE_INTERNAL</span></span><div class=" add"><span class="line">win32_debug_time_marker *Marker = &amp;DebugTimeMarkers[DebugTimeMarkerIndex];</span>
<span class="line">Marker-&gt;OutputPlayCursor = PlayCursor;</span>
<span class="line">Marker-&gt;OutputWriteCursor = WriteCursor;</span>
<span class="line">Marker-&gt;OutputLocation = ByteToLock;</span>
<span class="line">Marker-&gt;OutputByteCount = BytesToWrite;</span></div><span class="line"></span>
<span class="line"><span class="hljs-comment">//... </span></span>
<span class="line">OutputDebugStringA(TextBuffer);</span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;31:</b> <file>[win32_handmade.cpp > WinMain]</file> Recording output markers.</div></center>
<p>


For what it might concern <code>Win32DebugSyncDisplay</code>, first we'll need to correct the struct members currently in use: 

</p><pre class="listing tilde"><code><span class="line">win32_debug_time_marker *ThisMarker = &amp;Markers[MarkerIndex];</span><span class="line">Win32DrawSoundBufferMarker(Backbuffer, SoundOutput, C, PadX, Top, Bottom,             </span><div class=" edit"><span class="line">                           ThisMarker-&gt;FlipPlayCursor, PlayColor);</span></div><span class="line">Win32DrawSoundBufferMarker(Backbuffer, SoundOutput, C, PadX, Top, Bottom, </span><div class=" edit"><span class="line">                           ThisMarker-&gt;FlipWriteCursor, WriteColor);</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;32:</b> <file>[win32_handmade.cpp > Win32DebugSyncDisplay]</file> Making us compilable.</div></center>
<p>


So far, we're recording the new values, but we don't display them. You can compile and test it out: now changes yet. Let's add the newly registered values to our debug display. Instead of having too many colors, we'll simply reuse the <code>PlayColor</code> and <code>WriteColor</code> we already have, merely offset those down.

</p><pre class="listing tilde"><code><div class=" add"><span class="line">win32_debug_time_marker *ThisMarker = &amp;Markers[MarkerIndex];</span></div><span class="line"></span>
<span class="line">DWORD PlayColor = <span class="hljs-number">0xFFFFFFFF</span>;</span>
<span class="line">DWORD WriteColor = <span class="hljs-number">0xFFFF0000</span>;</span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">int</span> Top = PadY;</span>
<span class="line"><span class="hljs-keyword">int</span> Bottom = PadY + LineHeight;</span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">if</span> (MarkerIndex == CurrentMarkerIndex)</span>
<span class="line">{</span>
<span class="line">    Top += LineHeight + PadY;</span>
<span class="line">    Bottom += LineHeight + PadY;</span>
<span class="line">    </span><div class=" add"><span class="line">    Win32DrawSoundBufferMarker(Backbuffer, SoundOutput, C, PadX, Top, Bottom, </span>
<span class="line">                               ThisMarker-&gt;OutputPlayCursor, PlayColor);</span>
<span class="line">    Win32DrawSoundBufferMarker(Backbuffer, SoundOutput, C, PadX, Top, Bottom, </span>
<span class="line">                               ThisMarker-&gt;OutputWriteCursor, WriteColor);</span>
<span class="line">    Top += LineHeight + PadY;</span>
<span class="line">    Bottom += LineHeight + PadY;</span>
<span class="line">    Win32DrawSoundBufferMarker(Backbuffer, SoundOutput, C, PadX, Top, Bottom, </span>
<span class="line">                               ThisMarker-&gt;OutputLocation, PlayColor);</span>
<span class="line">    Win32DrawSoundBufferMarker(Backbuffer, SoundOutput, C, PadX, Top, Bottom,       </span>
<span class="line">                               ThisMarker-&gt;OutputLocation + ThisMarker-&gt;OutputByteCount, WriteColor);</span>
<span class="line">    Top += LineHeight + PadY;</span>
<span class="line">    Bottom += LineHeight + PadY;</span></div><span class="line">}</span><div class=" delete"><span class="line">win32_debug_time_marker *ThisMarker = &amp;Markers[MarkerIndex];</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;33:</b> <file>[win32_handmade.cpp > Win32DebugSyncDisplay]</file> Displaying new values (only on the current cursor).</div></center>
<p>


Now that we're passing potentially out-of-bounds values, we must make sure that our program doesn't crash. We can do it by simply clamping the horizontal and vertical limits.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">Win32DebugDrawVertical</span><span class="hljs-params">(win32_offscreen_buffer *Backbuffer,</span>
<span class="line">                       <span class="hljs-keyword">int</span> X, <span class="hljs-keyword">int</span> Top, <span class="hljs-keyword">int</span> Bottom, u32 Color)</span></span>
<span class="line"></span>{</span><div class=" add"><span class="line">    <span class="hljs-keyword">if</span> (Top &lt;= <span class="hljs-number">0</span>)</span>
<span class="line">    {</span>
<span class="line">        Top = <span class="hljs-number">0</span>;</span>
<span class="line">    }</span>
<span class="line">    </span>
<span class="line">    <span class="hljs-keyword">if</span> (Bottom &gt; Backbuffer-&gt;Height)</span>
<span class="line">    {</span>
<span class="line">        Bottom = Backbuffer-&gt;Height;</span>
<span class="line">    }</span>
<span class="line">    </span>
<span class="line">    <span class="hljs-keyword">if</span> ((X &gt;= <span class="hljs-number">0</span>) &amp;&amp; (X &lt; Backbuffer-&gt;Width))</span>
<span class="line">    {</span></div><span class="line">        u8 *Pixel = (u8 *)Backbuffer-&gt;Memory +</span>
<span class="line">            X * Backbuffer-&gt;BytesPerPixel +</span>
<span class="line">            Top * Backbuffer-&gt;Pitch;</span>
<span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> Y = Top;</span>
<span class="line">            Y &lt; Bottom;</span>
<span class="line">            ++Y)</span>
<span class="line">        {</span>
<span class="line">            *(u32 *)Pixel = Color;</span>
<span class="line">            Pixel += Backbuffer-&gt;Pitch;</span>
<span class="line">        }</span><div class=" add"><span class="line">    }</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;34:</b> <file>[win32_handmade.cpp]</file> Making sure we never go out of bounds.</div></center>
<p>


Now that we're passing potentially out-of-bounds values, we won't be able to flat assert value correctness. Instead, we can do it for the individual values on a case-by-case basis.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">Win32DrawSoundBufferMarker</span><span class="hljs-params">(...)</span></span>
<span class="line"></span>{</span><div class=" delete"><span class="line">    Assert (Value &lt; SoundOutput-&gt;SecondaryBufferSize);</span></div><span class="line">    f32 XReal = C * (f32)Value;</span>
<span class="line">    <span class="hljs-keyword">int</span> X = PadX + (<span class="hljs-keyword">int</span>)XReal;</span>
<span class="line">    </span>
<span class="line">    Win32DebugDrawVertical(Backbuffer, X, Top, Bottom, Color);</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">Win32DebugSyncDisplay</span><span class="hljs-params">(...)</span></span>
<span class="line"></span>{</span>
<span class="line">    <span class="hljs-keyword">int</span> PadX = <span class="hljs-number">16</span>;</span>
<span class="line">    <span class="hljs-keyword">int</span> PadY = <span class="hljs-number">16</span>;</span>
<span class="line">    </span>
<span class="line">    <span class="hljs-keyword">int</span> LineHeight = <span class="hljs-number">64</span>;</span>
<span class="line">    </span>
<span class="line">    f32 C = (f32)(Backbuffer-&gt;Width - <span class="hljs-number">2</span> * PadX) / (f32)SoundOutput-&gt;SecondaryBufferSize;</span>
<span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> MarkerIndex = <span class="hljs-number">0</span>;</span>
<span class="line">         MarkerIndex &lt; MarkerCount;</span>
<span class="line">         ++MarkerIndex)</span>
<span class="line">    {</span>
<span class="line">        win32_debug_time_marker *ThisMarker = &amp;Markers[MarkerIndex];</span>
<span class="line">        </span><div class=" add"><span class="line">        Assert(ThisMarker-&gt;OutputPlayCursor &lt; SoundOutput-&gt;SecondaryBufferSize);</span>
<span class="line">        Assert(ThisMarker-&gt;OutputWriteCursor &lt; SoundOutput-&gt;SecondaryBufferSize);</span>
<span class="line">        Assert(ThisMarker-&gt;OutputLocation &lt; SoundOutput-&gt;SecondaryBufferSize);</span>
<span class="line">        Assert(ThisMarker-&gt;OutputByteCount &lt; SoundOutput-&gt;SecondaryBufferSize);</span>
<span class="line">        Assert(ThisMarker-&gt;FlipPlayCursor &lt; SoundOutput-&gt;SecondaryBufferSize);</span>
<span class="line">        Assert(ThisMarker-&gt;FlipWriteCursor &lt; SoundOutput-&gt;SecondaryBufferSize);</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;35:</b> <file>[win32_handmade.cpp]</file> Fixing the assertions.</div></center>
<p>


If you compile and run now, you'll see something like this: 

</p><p>

<center><div class="image" style=""><a href="../media/day20/output1.jpg" target="_blank"><img class="markdeep" src="../media/day20/output1.jpg" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;11:</b> Current flip frame data moved to the very bottom, and the new values are inserted in the middle.</span></center></div></center> 

</p>
<a class="target" name="displayexpectedframefliptime">&nbsp;</a><a class="target" name="evenmoredebugging/displayexpectedframefliptime">&nbsp;</a><a class="target" name="toc4.4">&nbsp;</a><h2>Display Expected Frame Flip Time</h2>
<p>


At this point, we want to see if our estimate lines up at all. We assume that the frame flip happens as close to the current frame's <code>FlipPlayCursor</code> as possible (white bottom line). Let's put our <code>FrameBoundaryByte</code> as the expected flip play cursor and see if they are even close.

</p><p>

Again, we first add the new member to <code>win32_debug_time_marker</code> structure:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">win32_debug_time_marker</span></span>
<span class="line">{</span></span>
<span class="line">    DWORD OutputPlayCursor;</span>
<span class="line">    DWORD OutputWriteCursor;</span>
<span class="line">    DWORD OutputLocation;</span>
<span class="line">    DWORD OutputByteCount;</span><div class=" add"><span class="line">    DWORD ExpectedFlipPlayCursor;</span></div><span class="line">    </span>
<span class="line">    DWORD FlipPlayCursor;</span>
<span class="line">    DWORD FlipWriteCursor;</span>
<span class="line">};</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;36:</b> <file>[win32_handmade.h]</file> Expanding <code>win32_debug_time_marker</code>.</div></center>
<p>


We then capture the cursor:

</p><pre class="listing tilde"><code><span class="line">win32_debug_time_marker *Marker = &amp;DebugTimeMarkers[DebugTimeMarkerIndex];</span>
<span class="line">Marker-&gt;OutputPlayCursor = PlayCursor;</span>
<span class="line">Marker-&gt;OutputWriteCursor = WriteCursor;</span>
<span class="line">Marker-&gt;OutputLocation = ByteToLock;</span>
<span class="line">Marker-&gt;OutputByteCount = BytesToWrite;</span><div class=" add"><span class="line">Marker-&gt;ExpectedFlipPlayCursor = ExpectedFrameBoundaryByte;</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;37:</b> <file>[win32_handmade.cpp > WinMain]</file> Recording calculated frame flip cursor.</div></center>
<p>


Finally, we display it on screen. Let's say that this line will be a big yellow one:

</p><pre class="listing tilde"><code><span class="line">DWORD PlayColor = <span class="hljs-number">0xFFFFFFFF</span>;         <span class="hljs-comment">// White</span></span>
<span class="line">DWORD WriteColor = <span class="hljs-number">0xFFFF0000</span>;        <span class="hljs-comment">// Red</span></span><div class=" add"><span class="line">DWORD ExpectedFlipColor = <span class="hljs-number">0xFFFFFF00</span>; <span class="hljs-comment">// Yellow</span></span></div><span class="line"></span>
<span class="line"><span class="hljs-keyword">int</span> Top = PadY;</span>
<span class="line"><span class="hljs-keyword">int</span> Bottom = PadY + LineHeight;</span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">if</span> (MarkerIndex == CurrentMarkerIndex)</span>
<span class="line">{</span>
<span class="line">    Top += LineHeight + PadY;</span>
<span class="line">    Bottom += LineHeight + PadY;</span>
<span class="line">    </span>
<span class="line">    Win32DrawSoundBufferMarker(..., ThisMarker-&gt;OutputPlayCursor, PlayColor);</span>
<span class="line">    Win32DrawSoundBufferMarker(..., ThisMarker-&gt;OutputWriteCursor, WriteColor);</span>
<span class="line">    </span>
<span class="line">    Top += LineHeight + PadY;</span>
<span class="line">    Bottom += LineHeight + PadY;</span>
<span class="line">    </span>
<span class="line">    Win32DrawSoundBufferMarker(..., ThisMarker-&gt;OutputLocation, PlayColor);</span>
<span class="line">    Win32DrawSoundBufferMarker(..., ThisMarker-&gt;OutputLocation + ThisMarker-&gt;OutputByteCount, WriteColor);</span>
<span class="line">    </span>
<span class="line">    Top += LineHeight + PadY;</span>
<span class="line">    Bottom += LineHeight + PadY;</span>
<span class="line">    </span><div class=" add"><span class="line">    Win32DrawSoundBufferMarker(Backbuffer, SoundOutput, C, PadX, PadY, Bottom, </span>
<span class="line">                               ThisMarker-&gt;ExpectedFlipPlayCursor, ExpectedFlipColor);</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;38:</b> <file>[win32_handmade.cpp > Win32DebugSyncDisplay]</file> Displaying expected flip play cursor.</div></center>
<p>


<center><div class="image" style=""><a href="../media/day20/output2.jpg" target="_blank"><img class="markdeep" src="../media/day20/output2.jpg" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;12:</b> Expected Flip Play Cursor.</span></center></div></center> 

</p>
<a class="target" name="displayplaywindow">&nbsp;</a><a class="target" name="evenmoredebugging/displayplaywindow">&nbsp;</a><a class="target" name="toc4.5">&nbsp;</a><h2>Display Play Window</h2>
<p>


The actual flip play cursor and the expected one don't really line up perfectly. What's going on? 

</p><p>

One possibility is that the update lag of DirectSound itself doesn't allow correct visualization. We calculated that the cursors move every 480 samples or ~3.3 times per frame, if you recall. It implies that the cursor we get is more of a <em class="underscore">window</em> in time than a <em class="underscore">point</em> in time. Let's visualize it as well, this time in a lovely magenta.

</p><pre class="listing tilde"><code><span class="line">DWORD PlayColor = <span class="hljs-number">0xFFFFFFFF</span>;</span>
<span class="line">DWORD WriteColor = <span class="hljs-number">0xFFFF0000</span>;</span>
<span class="line">DWORD ExpectedFlipColor = <span class="hljs-number">0xFFFFFF00</span>;</span><div class=" add"><span class="line">DWORD PlayWindowColor = <span class="hljs-number">0xFFFF00FF</span>;</span></div><span class="line"></span>
<span class="line"><span class="hljs-keyword">int</span> Top = PadY;</span>
<span class="line"><span class="hljs-keyword">int</span> Bottom = PadY + LineHeight;</span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">if</span> (MarkerIndex == CurrentMarkerIndex)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">Win32DrawSoundBufferMarker(..., ThisMarker-&gt;FlipPlayCursor, PlayColor);</span><div class=" add"><span class="line">Win32DrawSoundBufferMarker(Backbuffer, SoundOutput, C, PadX, Top, Bottom, </span>
<span class="line">                           ThisMarker-&gt;FlipPlayCursor + (<span class="hljs-number">480</span> * SoundOutput-&gt;BytesPerSample), </span>
<span class="line">                           PlayWindowColor);</span></div><span class="line">Win32DrawSoundBufferMarker(Backbuffer, SoundOutput, C, PadX, Top, Bottom, ThisMarker-&gt;FlipWriteCursor, WriteColor);</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;39:</b> <file>[win32_handmade.cpp > Win32DebugSyncDisplay]</file> Displaying the boundaries of the play window.</div></center>

<a class="target" name="fixingtheexpectedframeboundarybytecalculation.">&nbsp;</a><a class="target" name="evenmoredebugging/displayplaywindow/fixingtheexpectedframeboundarybytecalculation.">&nbsp;</a><a class="target" name="toc4.5.1">&nbsp;</a><h3>Fixing the ExpectedFrameBoundaryByte calculation.</h3>
<p>


If our data is correct, the <code>ExpectedFrameBoundaryByte</code> should always fall between those values. But it's not. If you look closely, it's very rarely inside the window, and more often than not, it floats away. What's going on? 

</p><p>

After giving a closer look at the <code>ExpectedFrameBoundaryByte</code>, we can see that the computation is wrong:

</p><pre class="listing tilde"><code><span class="line">DWORD ExpectedFrameBoundaryByte = PlayCursor + ExpectedSoundBytesPerFrame;</span></code></pre><p>

That's not what we set out to do! This doesn't take into account whatever amount of time has already elapsed since the frame started. Let's fix this. 

</p><p>

First, we need to introduce an exact wall clock snapshot, going off exactly at the frame flip time. Our current <code>LastCounter</code> is more liberal in this regard because it's measuring itself at every cycle, so it doesn't need precise placement at the frame flip. Flip wall clock should snap after we send the render buffer to Windows: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-comment">// Before the main loop</span></span>
<span class="line">b32 SoundIsValid = <span class="hljs-literal">false</span>;</span>
<span class="line"></span>
<span class="line">LARGE_INTEGER LastCounter = Win32GetWallClock();</span><div class=" add"><span class="line">LARGE_INTEGER FlipWallClock = Win32GetWallClock();</span></div><span class="line"></span>
<span class="line">u64 LastCycleCount = __rdtsc();</span>
<span class="line">GlobalRunning = <span class="hljs-literal">true</span>;</span>
<span class="line">win32_window_dimension Dimension = Win32GetWindowDimension(Window);</span>
<span class="line"></span>
<span class="line"><span class="hljs-comment">// ... </span></span>
<span class="line"><span class="hljs-comment">// At the end of the main loop</span></span>
<span class="line"><span class="hljs-comment">// ... </span></span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> HANDMADE_INTERNAL</span></span>
<span class="line">Win32DebugSyncDisplay(...);</span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span>
<span class="line">Win32DisplayBufferInWindow(...);</span>
<span class="line"></span><div class=" add"><span class="line">FlipWallClock = Win32GetWallClock();</span></div><span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> HANDMADE_INTERNAL</span></span>
<span class="line"><span class="hljs-comment">// ... </span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;40:</b> <file>[win32_handmade.cpp > WinMain]</file> Getting the actual frame flip timing.</div></center>
<p>


This allows us to measure the time elapsed since the beginning of the frame. Once we know how many seconds have passed since the beginning of the frame, we can derive the correct bytes until flip using a simple proportion. 

</p><pre class="listing tilde"><code><span class="line">GameUpdateAndRender(&amp;GameMemory, NewInput, &amp;Buffer);</span>
<span class="line">                        </span><div class=" add"><span class="line">LARGE_INTEGER AudioWallClock = Win32GetWallClock();</span>
<span class="line">f32 FromBeginToAudioSeconds = Win32GetSecondsElapsed(FlipWallClock, AudioWallClock);</span></div><span class="line"></span>
<span class="line"><span class="hljs-comment">// Just before the main audio block</span></span>
<span class="line">DWORD PlayCursor;</span>
<span class="line">DWORD WriteCursor;</span>
<span class="line"><span class="hljs-keyword">if</span> (GlobalSecondaryBuffer-&gt;GetCurrentPosition(&amp;PlayCursor, &amp;WriteCursor) == DS_OK)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">    DWORD ByteToLock = ((SoundOutput.RunningSampleIndex * SoundOutput.BytesPerSample)</span>
<span class="line">                                                    % SoundOutput.SecondaryBufferSize);</span>
<span class="line">                                </span>
<span class="line">    DWORD ExpectedSoundBytesPerFrame = (SoundOutput.SamplesPerSecond * SoundOutput.BytesPerSample)</span>
<span class="line">        / GameUpdateHz;</span>
<span class="line"></span><div class=" add"><span class="line">    f32 SecondsLeftUntilFlip = TargetSecondsPerFrame - FromBeginToAudioSeconds;</span>
<span class="line">    DWORD ExpectedBytesUntilFlip = (DWORD)((SecondsLeftUntilFlip / TargetSecondsPerFrame) * (f32)ExpectedSoundBytesPerFrame);</span>
<span class="line"></span></div><div class=" edit"><span class="line">    DWORD ExpectedFrameBoundaryByte = PlayCursor + ExpectedBytesUntilFlip;</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;41:</b> <file>[win32_handmade.cpp > WinMain]</file> Calculating correct frame boundary byte.</div></center>
<p>


If we compile and run now, we'll see that the flip play cursor and the calculated flip play cursor line up almost perfectly! Mission accomplished.

</p>
<a class="target" name="recap">&nbsp;</a><a class="target" name="recap">&nbsp;</a><a class="target" name="toc5">&nbsp;</a><h1>Recap</h1>
<p>


Audio is tricky to get right, and it's hard to find topics harder than this in programming. However, if you got this far, congratulations! From here on, it should be a breeze. 

</p>
<a class="target" name="sideconsiderations">&nbsp;</a><a class="target" name="sideconsiderations">&nbsp;</a><a class="target" name="toc6">&nbsp;</a><h1>Side Considerations</h1>

<a class="target" name="bugfix:soundchangingpitch">&nbsp;</a><a class="target" name="sideconsiderations/bugfix:soundchangingpitch">&nbsp;</a><a class="target" name="toc6.1">&nbsp;</a><h2>Bugfix: Sound Changing Pitch</h2>
<p>


If you listen to the game output for long enough, you'll quickly hear that it changes in pitch over time, without any user input.

</p><p>

This is due to the loss of precision of the floating-point value. It turns out that with the running sample index, <code>tSine</code> becomes less and less precise very quickly indeed. We can fix this using a straightforward operation such as showcased below.

</p><pre class="listing tilde"><code><span class="line">f32 SineValue = sinf(tSine);</span>
<span class="line">s16 SampleValue = (s16)(SineValue * ToneVolume);</span>
<span class="line"></span>
<span class="line">*SampleOut++ = SampleValue;</span>
<span class="line">*SampleOut++ = SampleValue;</span>
<span class="line">tSine += <span class="hljs-number">2.0f</span> * Pi32 * <span class="hljs-number">1.0f</span> / (f32)WavePeriod;</span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-keyword">if</span> (tSine &gt; <span class="hljs-number">2.0f</span> * Pi32)</span>
<span class="line">{</span>
<span class="line">    tSine -= <span class="hljs-number">2.0f</span> * Pi32;</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;42:</b> <file>[handmade.cpp > GameSoundOutput]</file> Normalizing <code>tSine</code>.</div></center>

<a class="target" name="navigation">&nbsp;</a><a class="target" name="navigation">&nbsp;</a><a class="target" name="toc7">&nbsp;</a><h1>Navigation</h1>
<p>


Previous: <a href="../html/day19.html">Day 19. Improving Audio Synchronization</a>

</p><p>

Up Next: <a href="../html/day21.html">Day 21. Loading Game Code Dynamically</a>

</p><p>

<a href="../index.md.html">Back to Index</a>

</p>
<div class="nonumberh1">Glossary </div>
<p>


<ul>
<li class="asterisk">Frame flip
</li>
<li class="asterisk">Dimensional analysis
</li>
<li class="asterisk">Input lag</li></ul>

</p><p>

<style class="fallback">
  body {
    visibility: hidden;
    font-family: sans-serif;
  }
</style>

</p><p>

<script>
  markdeepOptions = { tocStyle: 'long' };
  window.alreadyProcessedMarkdeep ||
    (document.body.style.visibility = 'visible');
</script>

</p><p>

</p></span><div id="mdContextMenu" style="visibility:hidden"></div><div class="markdeepFooter"><i>formatted by <a href="https://casual-effects.com/markdeep" style="color:#999">Markdeep&nbsp;1.10&nbsp;&nbsp;</a></i><div style="display:inline-block;font-size:13px;font-family:'Times New Roman',serif;vertical-align:middle;transform:translate(-3px,-1px)rotate(135deg);">&#x2712;</div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>