<meta charset="UTF-8"><meta http-equiv="content-type" content="text/html;charset=UTF-8"><meta name="viewport" content="width=600, initial-scale=1"><style>body{max-width:680px;margin:auto;padding:20px;text-align:justify;line-height:140%; -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-smoothing:antialiased;color:#222;font-family:Palatino,Georgia,"Times New Roman",serif}</style><style>@media print{*{-webkit-print-color-adjust:exact;text-shadow:none !important}}body{counter-reset: h1 h2 h3 h4 h5 h6 paragraph}@page{margin:0;size:auto}#mdContextMenu{position:absolute;background:#383838;cursor:default;border:1px solid #999;color:#fff;padding:4px 0px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,"Helvetica Neue",sans-serif;font-size:85%;font-weight:600;border-radius:4px;box-shadow:0px 3px 10px rgba(0,0,0,35%)}#mdContextMenu div{padding:0px 20px}#mdContextMenu div:hover{background:#1659d1}.md code,.md pre{font-family:Menlo,Consolas,monospace;font-size:98%;text-align:left;line-height:140%}.md .mediumToc code,.md longToc code,.md .shortToc code,.md h1 code,.md h2 code,.md h3 code,.md h4 code,.md h5 code,.md h6 code{font-size:unset}.md div.title{font-size:26px;font-weight:800;line-height:120%;text-align:center}.md div.afterTitles{height:10px}.md div.subtitle{text-align:center}.md iframe.textinsert, .md object.textinsert,.md iframe:not(.markdeep){display:block;margin-top:10px;margin-bottom:10px;width:100%;height:75vh;border:1px solid #000;border-radius:4px;background:#f5f5f4}.md .image{display:inline-block}.md img{max-width:100%;page-break-inside:avoid}.md li{text-align:left;text-indent:0}.md pre.listing {width:100%;tab-size:4;-moz-tab-size:4;-o-tab-size:4;counter-reset:line;overflow-x:auto;resize:horizontal}.md pre.listing .linenumbers span.line:before{width:30px;margin-left:-28px;font-size:80%;text-align:right;counter-increment:line;content:counter(line);display:inline-block;padding-right:13px;margin-right:8px;color:#ccc}.md div.tilde{margin:20px 0 -10px;text-align:center}.md .imagecaption,.md .tablecaption,.md .listingcaption{display:inline-block;margin:7px 5px 12px;text-align:justify;font-style:italic}.md img.pixel{image-rendering:-moz-crisp-edges;image-rendering:pixelated}.md blockquote.fancyquote{margin:25px 0 25px;text-align:left;line-height:160%}.md blockquote.fancyquote::before{content:"“";color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-right:6px;vertical-align:-0.3em}.md span.fancyquote{font-size:118%;color:#777;font-style:italic}.md span.fancyquote::after{content:"”";font-style:normal;color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-left:6px;vertical-align:-0.3em}.md blockquote.fancyquote .author{width:100%;margin-top:10px;display:inline-block;text-align:right}.md small{font-size:60%}.md big{font-size:150%}.md div.title,contents,.md .tocHeader,.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .shortTOC,.md .mediumTOC,.nonumberh1,.nonumberh2,.nonumberh3,.nonumberh4,.nonumberh5,.nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;margin:13.4px 0 13.4px;padding:15px 0 3px;border-top:none;clear:both}.md .tocTop {display:none}.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .nonumberh1,.md .nonumberh2,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{page-break-after:avoid;break-after:avoid}.md svg.diagram{display:block;font-family:Menlo,Consolas,monospace;font-size:98%;text-align:center;stroke-linecap:round;stroke-width:2px;page-break-inside:avoid;stroke:#000;fill:#000}.md svg.diagram .opendot{fill:#fff}.md svg.diagram .shadeddot{fill:#CCC}.md svg.diagram .dotteddot{stroke:#000;stroke-dasharray:4;fill:none}.md svg.diagram text{stroke:none}@media print{@page{margin:1in 5mm;transform: scale(150%)}}@media print{.md .pagebreak{page-break-after:always;visibility:hidden}}.md a{font-family:Georgia,Palatino,'Times New Roman'}.md h1,.md .tocHeader,.md .nonumberh1{border-bottom:3px solid;font-size:20px;font-weight:bold;}.md h1,.md .nonumberh1{counter-reset: h2 h3 h4 h5 h6}.md h2,.md .nonumberh2{counter-reset: h3 h4 h5 h6;border-bottom:2px solid #999;color:#555;font-weight:bold;font-size:18px;}.md h3,.md h4,.md h5,.md h6,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;color:#555;font-size:16px;}.md h3{counter-reset:h4 h5 h6}.md h4{counter-reset:h5 h6}.md h5{counter-reset:h6}.md div.table{margin:16px 0 16px 0}.md table{border-collapse:collapse;line-height:140%;page-break-inside:avoid}.md table.table{margin:auto}.md table.calendar{width:100%;margin:auto;font-size:11px;font-family:Verdana,Helvetica,Arial,sans-serif}.md table.calendar th{font-size:16px}.md .today{background:#ECF8FA}.md .calendar .parenthesized{color:#999;font-style:italic}.md table.table th{color:#FFF;background-color:#AAA;border:1px solid #888;padding:8px 15px 8px 15px}.md table.table td{padding:5px 15px 5px 15px;border:1px solid #888}.md table.table tr:nth-child(even){background:#EEE}.md pre.tilde{border-top: 1px solid #CCC;border-bottom: 1px solid #CCC;padding: 5px 0 5px 20px;margin:0 0 0 0;background:#FCFCFC;page-break-inside:avoid}.md a.target{width:0px;height:0px;visibility:hidden;font-size:0px;display:inline-block}.md a:link, .md a:visited{color:#38A;text-decoration:none}.md a:link:hover{text-decoration:underline}.md dt{font-weight:700}.md dl>dd{margin-top:-8px; margin-bottom:8px}.md dl>table{margin:35px 0 30px}.md code{page-break-inside:avoid;} @media print{.md .listing code{white-space:pre-wrap}}.md .endnote{font-size:13px;line-height:15px;padding-left:10px;text-indent:-10px}.md .bib{padding-left:80px;text-indent:-80px;text-align:left}.markdeepFooter{font-size:9px;text-align:right;padding-top:80px;color:#999}.md .mediumTOC{float:right;font-size:12px;line-height:15px;border-left:1px solid #CCC;padding-left:15px;margin:15px 0px 15px 25px}.md .mediumTOC .level1{font-weight:600}.md .longTOC .level1{font-weight:600;display:block;padding-top:12px;margin:0 0 -20px}.md .shortTOC{text-align:center;font-weight:bold;margin-top:15px;font-size:14px}.md .admonition{position:relative;margin:1em 0;padding:.4rem 1rem;border-radius:.2rem;border-left:2.5rem solid rgba(68,138,255,.4);background-color:rgba(68,138,255,.15);}.md .admonition-title{font-weight:bold;border-bottom:solid 1px rgba(68,138,255,.4);padding-bottom:4px;margin-bottom:4px;margin-left: -1rem;padding-left:1rem;margin-right:-1rem;border-color:rgba(68,138,255,.4)}.md .admonition.tip{border-left:2.5rem solid rgba(50,255,90,.4);background-color:rgba(50,255,90,.15)}.md .admonition.tip::before{content:"\24d8";font-weight:bold;font-size:150%;position:relative;top:3px;color:rgba(26,128,46,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.tip>.admonition-title{border-color:rgba(50,255,90,.4)}.md .admonition.warn,.md .admonition.warning{border-left:2.5rem solid rgba(255,145,0,.4);background-color:rgba(255,145,0,.15)}.md .admonition.warn::before,.md .admonition.warning::before{content:"\26A0";font-weight:bold;font-size:150%;position:relative;top:2px;color:rgba(128,73,0,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.warn>.admonition-title,.md .admonition.warning>.admonition-title{border-color:rgba(255,145,0,.4)}.md .admonition.error{border-left: 2.5rem solid rgba(255,23,68,.4);background-color:rgba(255,23,68,.15)}.md .admonition.error>.admonition-title{border-color:rgba(255,23,68,.4)}.md .admonition.error::before{content: "\2612";font-family:"Arial";font-size:200%;position:relative;color:rgba(128,12,34,.8);top:-2px;left:-3rem;display:block;width:0;height:0}.md .admonition p:last-child{margin-bottom:0}.md li.checked,.md li.unchecked{list-style:none;overflow:visible;text-indent:-1.2em}.md li.checked:before,.md li.unchecked:before{content:"\2611";display:block;float:left;width:1em;font-size:120%}.md li.unchecked:before{content:"\2610"}</style><style>.md h1::before {
content:counter(h1) " ";
counter-increment: h1;margin-right:10px}.md h2::before {
content:counter(h1) "."counter(h2) " ";
counter-increment: h2;margin-right:10px}.md h3::before {
content:counter(h1) "."counter(h2) "."counter(h3) " ";
counter-increment: h3;margin-right:10px}.md h4::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) " ";
counter-increment: h4;margin-right:10px}.md h5::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) " ";
counter-increment: h5;margin-right:10px}.md h6::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) "."counter(h6) " ";
counter-increment: h6;margin-right:10px}</style><style>.hljs{display:block;overflow-x:auto;padding:0.5em;background:#fff;color:#000;-webkit-text-size-adjust:none}.hljs-comment{color:#006a00}.hljs-keyword{color:#02E}.hljs-literal,.nginx .hljs-title{color:#aa0d91}.method,.hljs-list .hljs-title,.hljs-tag .hljs-title,.setting .hljs-value,.hljs-winutils,.tex .hljs-command,.http .hljs-title,.hljs-request,.hljs-status,.hljs-name{color:#008}.hljs-envvar,.tex .hljs-special{color:#660}.hljs-string{color:#c41a16}.hljs-tag .hljs-value,.hljs-cdata,.hljs-filter .hljs-argument,.hljs-attr_selector,.apache .hljs-cbracket,.hljs-date,.hljs-regexp{color:#080}.hljs-sub .hljs-identifier,.hljs-pi,.hljs-tag,.hljs-tag .hljs-keyword,.hljs-decorator,.ini .hljs-title,.hljs-shebang,.hljs-prompt,.hljs-hexcolor,.hljs-rule .hljs-value,.hljs-symbol,.hljs-symbol .hljs-string,.hljs-number,.css .hljs-function,.hljs-function .hljs-title,.coffeescript .hljs-attribute{color:#A0C}.hljs-function .hljs-title{font-weight:bold;color:#000}.hljs-class .hljs-title,.smalltalk .hljs-class,.hljs-type,.hljs-typename,.hljs-tag .hljs-attribute,.hljs-doctype,.hljs-class .hljs-id,.hljs-built_in,.setting,.hljs-params,.clojure .hljs-attribute{color:#5c2699}.hljs-variable{color:#3f6e74}.css .hljs-tag,.hljs-rule .hljs-property,.hljs-pseudo,.hljs-subst{color:#000}.css .hljs-class,.css .hljs-id{color:#9b703f}.hljs-value .hljs-important{color:#ff7700;font-weight:bold}.hljs-rule .hljs-keyword{color:#c5af75}.hljs-annotation,.apache .hljs-sqbracket,.nginx .hljs-built_in{color:#9b859d}.hljs-preprocessor,.hljs-preprocessor *,.hljs-pragma{color:#643820}.tex .hljs-formula{background-color:#eee;font-style:italic}.diff .hljs-header,.hljs-chunk{color:#808080;font-weight:bold}.diff .hljs-change{background-color:#bccff9}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-comment .hljs-doctag{font-weight:bold}.method .hljs-id{color:#000}</style><style>div.title { padding-top: 40px; } div.afterTitles { height: 15px; }</style><meta charset="utf-8">
<link rel="stylesheet" href="../css/style.css">

<script>try {
                        Object.defineProperty(screen, "availTop", { value: 0 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availLeft", { value: 0 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availWidth", { value: 1920 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availHeight", { value: 1080 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "colorDepth", { value: 24 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "pixelDepth", { value: 24 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "hardwareConcurrency", { value: 8 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "appVersion", { value: "5.0 (Windows)" });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "doNotTrack", { value: "unspecified" });
                    } catch (e) {}
                    
            try {
                window.screenY = 1072
            } catch (e) { }
        
            try {
                window.screenTop = 1072
            } catch (e) { }
        
            try {
                window.top.window.outerHeight = window.screen.height
            } catch (e) { }
        
            try {
                window.screenX = 1912
            } catch (e) { }
        
            try {
                window.screenLeft = 1912
            } catch (e) { }
        
            try {
                window.top.window.outerWidth = window.screen.width
            } catch (e) { }
        </script><script>try {
                        Object.defineProperty(screen, "availTop", { value: 0 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availLeft", { value: 0 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availWidth", { value: 1920 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availHeight", { value: 1080 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "colorDepth", { value: 24 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "pixelDepth", { value: 24 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "hardwareConcurrency", { value: 8 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "appVersion", { value: "5.0 (Windows)" });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "doNotTrack", { value: "unspecified" });
                    } catch (e) {}
                    
            try {
                window.screenY = 1072
            } catch (e) { }
        
            try {
                window.screenTop = 1072
            } catch (e) { }
        
            try {
                window.top.window.outerHeight = window.screen.height
            } catch (e) { }
        
            try {
                window.screenX = 1912
            } catch (e) { }
        
            try {
                window.screenLeft = 1912
            } catch (e) { }
        
            try {
                window.top.window.outerWidth = window.screen.width
            } catch (e) { }
        </script><script>try {
                        Object.defineProperty(screen, "availTop", { value: 0 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availLeft", { value: 0 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availWidth", { value: 1920 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availHeight", { value: 1080 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "colorDepth", { value: 24 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "pixelDepth", { value: 24 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "hardwareConcurrency", { value: 8 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "appVersion", { value: "5.0 (Windows)" });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "doNotTrack", { value: "unspecified" });
                    } catch (e) {}
                    
            try {
                window.screenY = 1072
            } catch (e) { }
        
            try {
                window.screenTop = 1072
            } catch (e) { }
        
            try {
                window.top.window.outerHeight = window.screen.height
            } catch (e) { }
        
            try {
                window.screenX = 1912
            } catch (e) { }
        
            try {
                window.screenLeft = 1912
            } catch (e) { }
        
            try {
                window.top.window.outerWidth = window.screen.width
            } catch (e) { }
        </script><script>try {
                        Object.defineProperty(screen, "availTop", { value: 0 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availLeft", { value: 0 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availWidth", { value: 1920 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availHeight", { value: 1080 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "colorDepth", { value: 24 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "pixelDepth", { value: 24 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "hardwareConcurrency", { value: 8 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "appVersion", { value: "5.0 (Windows)" });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "doNotTrack", { value: "unspecified" });
                    } catch (e) {}
                    
            try {
                window.screenY = 1072
            } catch (e) { }
        
            try {
                window.screenTop = 1072
            } catch (e) { }
        
            try {
                window.top.window.outerHeight = window.screen.height
            } catch (e) { }
        
            try {
                window.screenX = 1912
            } catch (e) { }
        
            try {
                window.screenLeft = 1912
            } catch (e) { }
        
            try {
                window.top.window.outerWidth = window.screen.width
            } catch (e) { }
        </script><script>try {
                        Object.defineProperty(screen, "availTop", { value: 0 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availLeft", { value: 0 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availWidth", { value: 1920 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "availHeight", { value: 1080 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "colorDepth", { value: 24 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(screen, "pixelDepth", { value: 24 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "hardwareConcurrency", { value: 8 });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "appVersion", { value: "5.0 (Windows)" });
                    } catch (e) {}
                    try {
                        Object.defineProperty(navigator, "doNotTrack", { value: "unspecified" });
                    } catch (e) {}
                    
            try {
                window.screenY = 1072
            } catch (e) { }
        
            try {
                window.screenTop = 1072
            } catch (e) { }
        
            try {
                window.top.window.outerHeight = window.screen.height
            } catch (e) { }
        
            try {
                window.screenX = 1912
            } catch (e) { }
        
            try {
                window.screenLeft = 1912
            } catch (e) { }
        
            try {
                window.top.window.outerWidth = window.screen.width
            } catch (e) { }
        </script><script type="text/x-mathjax-config">MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });</script><span style="display:none">$$\newcommand{\n}{\hat{n}}\newcommand{\thetai}{\theta_\mathrm{i}}\newcommand{\thetao}{\theta_\mathrm{o}}\newcommand{\d}[1]{\mathrm{d}#1}\newcommand{\w}{\hat{\omega}}\newcommand{\wi}{\w_\mathrm{i}}\newcommand{\wo}{\w_\mathrm{o}}\newcommand{\wh}{\w_\mathrm{h}}\newcommand{\Li}{L_\mathrm{i}}\newcommand{\Lo}{L_\mathrm{o}}\newcommand{\Le}{L_\mathrm{e}}\newcommand{\Lr}{L_\mathrm{r}}\newcommand{\Lt}{L_\mathrm{t}}\newcommand{\O}{\mathrm{O}}\newcommand{\degrees}{{^{\large\circ}}}\newcommand{\T}{\mathsf{T}}\newcommand{\mathset}[1]{\mathbb{#1}}\newcommand{\Real}{\mathset{R}}\newcommand{\Integer}{\mathset{Z}}\newcommand{\Boolean}{\mathset{B}}\newcommand{\Complex}{\mathset{C}}\newcommand{\un}[1]{\,\mathrm{#1}}$$
</span>
<span class="md"><p><title>Day 12. Platform-Independent Sound Output</title><div class="title"> Day 12. Platform-Independent Sound Output </div>

<div class="afterTitles"></div>
<em class="underscore">Video Length (including Q&A): <a href="https://hero.handmade.network/episode/code/day012/">1h37</a></em> 

</p><p>

Welcome to &ldquo;Handmade Hero Notes&rdquo;, the book where we follow the footsteps of <a href="https://handmadehero.org/">Handmade Hero</a> in making the complete game from scratch, with no external libraries. If you'd like to follow along, preorder the game on <a href="https://handmadehero.org/">handmadehero.org</a>, and you will receive access to the GitHub repository, containing complete source code (tagged day-by-day) as well as a variety of other useful resources.

</p><p>

Last time, we mainly covered the theory: the basics of the platform API design. We talked about the ability of abstract your code away, so that it's not tied to the operative system. We talked about writing mainly code that's used across all the platforms the game ships on, while using only a small thin layer that allows the game to run on said platforms. Ultimately, the complexity and efficiency of such an API boils down to how well you define the boundary between the platform-specific and the platform-independent code. 

</p><p>

We're now going to continue our transition towards platform-independent code that we started after we've gone through all that theory. We said that we want to support timing, user input, bitmap and sound buffer, and file data to come into our platform-independent layer, and we've only done the bitmap part so far. We also want to eventually allow the game to request file data on its side. 

</p>
<div class="longTOC"><p align="center">
    <span align="right"><a href="day11.html">Day 11</a></span>
    <a href="../index.html"><img src = "../media/logo.png"></a>
    <span align="left"><a href="day13.html">Day 13</a></span>
</p><p><a href="#" class="tocTop">(Top)</a><br/>
&nbsp;&nbsp;<a href="#/setthestagefortoday" class="level2"><span class="tocNumber">0.1&nbsp; </span>Set the Stage for Today</a><br/>
&nbsp;&nbsp;<a href="#/ourapproachtoapidesign" class="level2"><span class="tocNumber">0.2&nbsp; </span>Our Approach to API Design</a><br/>
<a href="#movesoundacrosstheapiboundary" class="level1"><span class="tocNumber">1&nbsp; </span>Move Sound Across the API Boundary</a><br/>
&nbsp;&nbsp;<a href="#movesoundacrosstheapiboundary/imaginesoundusecase" class="level2"><span class="tocNumber">1.1&nbsp; </span>Imagine Sound Use Case</a><br/>
&nbsp;&nbsp;<a href="#movesoundacrosstheapiboundary/portsinewavecode" class="level2"><span class="tocNumber">1.2&nbsp; </span>Port Sine Wave Code</a><br/>
&nbsp;&nbsp;<a href="#movesoundacrosstheapiboundary/startcompiling" class="level2"><span class="tocNumber">1.3&nbsp; </span>Start Compiling</a><br/>
&nbsp;&nbsp;<a href="#movesoundacrosstheapiboundary/fixcompilererrors" class="level2"><span class="tocNumber">1.4&nbsp; </span>Fix Compiler Errors</a><br/>
<a href="#useplatform-specificsounds" class="level1"><span class="tocNumber">2&nbsp; </span>Use Platform-Specific Sounds</a><br/>
&nbsp;&nbsp;<a href="#useplatform-specificsounds/updatewin32fillsoundbuffer" class="level2"><span class="tocNumber">2.1&nbsp; </span>Update <code>Win32FillSoundBuffer</code></a><br/>
&nbsp;&nbsp;<a href="#useplatform-specificsounds/introducewin32clearbuffer" class="level2"><span class="tocNumber">2.2&nbsp; </span>Introduce <code>Win32ClearBuffer</code></a><br/>
&nbsp;&nbsp;<a href="#useplatform-specificsounds/increasebuffersize" class="level2"><span class="tocNumber">2.3&nbsp; </span>Increase Buffer Size</a><br/>
&nbsp;&nbsp;<a href="#useplatform-specificsounds/expandsamplesbuffersize" class="level2"><span class="tocNumber">2.4&nbsp; </span>Expand <code>Samples</code> Buffer Size</a><br/>
&nbsp;&nbsp;<a href="#useplatform-specificsounds/backtofeatureparity" class="level2"><span class="tocNumber">2.5&nbsp; </span>Back to Feature Parity</a><br/>
<a href="#recap" class="level1"><span class="tocNumber">3&nbsp; </span>Recap</a><br/>
<a href="#programmingnotions" class="level1"><span class="tocNumber">4&nbsp; </span>Programming Notions</a><br/>
&nbsp;&nbsp;<a href="#programmingnotions/alloca" class="level2"><span class="tocNumber">4.1&nbsp; </span>Alloca</a><br/>
<a href="#sideconsiderations" class="level1"><span class="tocNumber">5&nbsp; </span>Side Considerations</a><br/>
&nbsp;&nbsp;<a href="#sideconsiderations/updatebuild.bat:removeerrormessage" class="level2"><span class="tocNumber">5.1&nbsp; </span>Update <code>build.bat</code>: Remove Error Message</a><br/>
&nbsp;&nbsp;<a href="#sideconsiderations/ontemporalityofsound" class="level2"><span class="tocNumber">5.2&nbsp; </span>On Temporality of Sound</a><br/>
&nbsp;&nbsp;<a href="#sideconsiderations/bufferoverruns" class="level2"><span class="tocNumber">5.3&nbsp; </span>Buffer Overruns</a><br/>
<a href="#navigation" class="level1"><span class="tocNumber">6&nbsp; </span>Navigation</a><br/>
</p></div><a class="target" name="setthestagefortoday">&nbsp;</a><a class="target" name="/setthestagefortoday">&nbsp;</a><a class="target" name="toc0.1">&nbsp;</a><h2>Set the Stage for Today</h2>
<p>


We left our code at <em class="underscore">feature parity</em> compared to where we started from. We draw the weird gradient the same way as before, if you've done the exercise we can even control its offset, and we can hear the tone.... Well, actually, we didn't touch this part. All the sound things still happen on the platform layer, and that's what we're going to focus on today.

</p><p>

There's a lot of subtlety involved in how you handle the time, and it's linked with the temporal nature of sound (more on this in subsection  <a href="#toc5.2">5.2</a>). Most games handle time poorly, with their game loops largely ignorant of what &ldquo;advancing time&rdquo; actually means. We'll try and get it correct from the get-go, albeit our model will be pretty simplistic at first (for instance, we might not always account for potential external interrupts happening from the system, or be otherwise as robust as we'd want to be... it will still be a good point to start from). 

</p>
<a class="target" name="ourapproachtoapidesign">&nbsp;</a><a class="target" name="/ourapproachtoapidesign">&nbsp;</a><a class="target" name="toc0.2">&nbsp;</a><h2>Our Approach to API Design</h2>
<p>


We'll start from looking at <code>GameUpdateAndRender</code>, state what we want to happen, and then move from there. Why not start from other way round, you might ask? 

</p><p>

The design approach that we're going for is: <strong class="asterisk">Always write the usage code first</strong> when designing something like an API. If you need to define what the platform layer gives you, you don't want to do it upfront. You'd rather write the <em class="underscore">code</em> that fakes using the thing a given API would provide in an ideal manner. You would then look at this usage case and try to implement something as close to it as you can. Any potential intricacies will remain &ldquo;under the hood&rdquo; until you can show in <em class="underscore">usage</em> that you actually need them. 

</p><p>

<style>blockquote.fancyquote {text-align:center !important;}</style><blockquote class="fancyquote"><span class="fancyquote">Always Write the Usage Code First.</span><span class="author">
      &mdash; Casey Muratori, about API design</span></blockquote>

</p>
<a class="target" name="movesoundacrosstheapiboundary">&nbsp;</a><a class="target" name="movesoundacrosstheapiboundary">&nbsp;</a><a class="target" name="toc1">&nbsp;</a><h1>Move Sound Across the API Boundary</h1>

<a class="target" name="imaginesoundusecase">&nbsp;</a><a class="target" name="movesoundacrosstheapiboundary/imaginesoundusecase">&nbsp;</a><a class="target" name="toc1.1">&nbsp;</a><h2>Imagine Sound Use Case</h2>
<p>


Let's look at our newly-created <code>handmade.cpp</code>. Inside <code>GameUpdateAndRender</code> call, we can imagine that we want to output sound. As for the parameters for such a call, we can imagine something like this:

</p><p>

<ul>
<li class="asterisk">Actual Samples (in memory): First of all, we want to specify a sound buffer to which we would have written the sound samples: this will be our second parameter.
</li>
<li class="asterisk">Sample count: Since we'll be writing a sound lasting a certain amount of time, we'll need to write a specific amount of sound samples. We don't know upfront how many however: this will depend on the time that we'll be receiving. This means that we'll need to pass the final sample count to the function. 
</li>
<li class="asterisk">Sound Format: We don't really want to specify that so we'll skip it. The format we defined in the platform layer,interleaved stereo 16-bit samples, seems like a fine one to use by default for our purposes. 
</li>
<li class="asterisk">Offset in time: This we'd want to make happen at some point. The offset would allow us to overwrite old samples or to skip ahead. We aren't going to that just yet, we want to start simple and game give us a continuos sample. So let's leave a TODO for now.</li></ul>

</p><p>

And... that seems like the whole of the call for now. This translates in the following code:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">GameUpdateAndRender</span><span class="hljs-params">(game_offscreen_buffer* Buffer, <span class="hljs-keyword">int</span> XOffset, <span class="hljs-keyword">int</span> YOffset)</span></span>
<span class="line"></span>{</span><div class=" add"><span class="line">    <span class="hljs-comment">// TODO(casey): Allow sample offsets here for more robust platform options</span></span>
<span class="line">    GameSoundOutput(SoundBuffer, SampleCountToOutput);</span></div><span class="line">    RenderWeirdGradient(Buffer, XOffset, YOffset);</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;1:</b> <file>[handmade.cpp]</file> Drafting out a possible API.</div></center>

<a class="target" name="portsinewavecode">&nbsp;</a><a class="target" name="movesoundacrosstheapiboundary/portsinewavecode">&nbsp;</a><a class="target" name="toc1.2">&nbsp;</a><h2>Port Sine Wave Code</h2>
<p>


Of course, we don't have a function called <code>GameSoundOutput</code> yet; Let's create one!

</p><p>

In <code>win32_handmade.cpp</code>, we only use the sound system to output the sine wave. The code responsible for sine wave sample generation is fairly straightforward: 
    In <code>win32_handmade.cpp</code>, we only use the sound system to output the sine wave. The code responsible for sine wave sample generation is fairly straightforward: 
In <code>win32_handmade.cpp</code>, we only use the sound system to output the sine wave. The code responsible for sine wave sample generation is fairly straightforward: 

</p><pre class="listing tilde"><code><span class="line">s16 *SampleOut = (s16 *)Region1;</span>
<span class="line">DWORD Region1SampleCount = Region1Size / SoundOutput-&gt;BytesPerSample;</span>
<span class="line"><span class="hljs-keyword">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line">        SampleIndex &lt; Region1SampleCount;</span>
<span class="line">        ++SampleIndex)</span>
<span class="line">{</span>
<span class="line">    f32 SineValue = sinf(SoundOutput-&gt;tSine);</span>
<span class="line">    s16 SampleValue = (s16)(SineValue * SoundOutput-&gt;ToneVolume);</span>
<span class="line">    </span>
<span class="line">    *SampleOut++ = SampleValue;</span>
<span class="line">    *SampleOut++ = SampleValue;</span>
<span class="line">    </span>
<span class="line">    SoundOutput-&gt;tSine += <span class="hljs-number">2.0f</span> * Pi32 * <span class="hljs-number">1.0f</span> / (f32)SoundOutput-&gt;WavePeriod;</span>
<span class="line">    ++SoundOutput-&gt;RunningSampleIndex;</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;2:</b> <file>[win32_handmade.cpp > Win32FillSoundBuffer]</file> We're currently repeating this twice to allow sample allocation to up to two regions.</div></center>
<p>


We can easily take this code and port it over to become cross-platform. Here's how we're going to approach it:

</p><p>

<ol start=1>
<li class="number">We'll define function <code>GameSoundOutput</code> inside <code>handmade.cpp</code>. As we said, it will take a <code>SoundBuffer</code>, which for now we can define to be some <code>game_sound_output_buffer *</code> and an <code>int SampleCountToOutput</code>. Inside, we'll paste the code above.</li></ol>

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">GameSoundOutput</span><span class="hljs-params">(game_sound_output_buffer *SoundBuffer, <span class="hljs-keyword">int</span> SampleCountToOutput)</span></span>
<span class="line"></span>{</span>
<span class="line">    s16 *SampleOut = (s16 *)Region1;</span>
<span class="line">    DWORD Region1SampleCount = Region1Size / SoundOutput-&gt;BytesPerSample;</span>
<span class="line">    <span class="hljs-keyword">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line">            SampleIndex &lt; Region1SampleCount;</span>
<span class="line">            ++SampleIndex)</span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// f32 SineValue = sinf(SoundOutput-&gt;tSine);</span></span>
<span class="line">        s16 SampleValue = (s16)(SineValue * SoundOutput-&gt;ToneVolume);</span>
<span class="line"></span>
<span class="line">        *SampleOut++ = SampleValue;</span>
<span class="line">        *SampleOut++ = SampleValue;</span>
<span class="line"></span>
<span class="line">        SoundOutput-&gt;tSine += <span class="hljs-number">2.0f</span> * Pi32 * <span class="hljs-number">1.0f</span> / (f32)SoundOutput-&gt;WavePeriod;</span>
<span class="line">        ++SoundOutput-&gt;RunningSampleIndex;</span>
<span class="line">    }</span>
<span class="line">}</span></div><span class="line"></span>
<span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">GameUpdateAndRender</span><span class="hljs-params">(game_offscreen_buffer* Buffer, <span class="hljs-keyword">int</span> XOffset, <span class="hljs-keyword">int</span> YOffset)</span></span>
<span class="line"></span>{</span>
<span class="line">    GameSoundOutput(SoundBuffer, SampleCountToOutput);</span>
<span class="line">    RenderWeirdGradient(Buffer, XOffset, YOffset);</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;3:</b> <file>[handmade.cpp]</file> Introducing <code>GameSoundOutput</code> and populating it with the code from <code>Win32FillSoundBuffer</code>.</div></center>
<p>



<ol start=2>
<li class="number">We need to make some changes to this code to make it cross-platform. 
<ul>
    <li class="asterisk"><code>SampleOut</code> will be coming from <code>SoundBuffer</code>.
</li>
    <li class="asterisk"><code>ToneVolume</code> can be defined as a constant variable.
</li>
    <li class="asterisk"><code>tSine</code> can be <code>local_persist</code> (i.e. <code>static</code>) for now. We're going to pull it away shortly. 
</li>
    <li class="asterisk"><code>SampleCountToOutput</code> will replace <code>Region1SampleCount</code>
</li>
    <li class="asterisk">We can also get rid of <code>SampleRunningIndex</code>, since we don't care about it here.</li></ul></li></ol>

</p><p>

This will result in the following function:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">GameSoundOutput</span><span class="hljs-params">(game_sound_output_buffer *SoundBuffer, <span class="hljs-keyword">int</span> SampleCountToOutput)</span></span>
<span class="line"></span>{</span><div class=" add"><span class="line">    local_persist f32 tSine;</span>
<span class="line">    s16 ToneVolume = <span class="hljs-number">3000</span>;</span>
<span class="line"></span></div><div class=" edit"><span class="line">    s16 *SampleOut = SoundBuffer-&gt;Samples;</span></div><div class=" delete"><span class="line">    DWORD Region1SampleCount = Region1Size / SoundOutput-&gt;BytesPerSample;</span></div><span class="line">    <span class="hljs-keyword">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span>;</span><div class=" edit"><span class="line">            SampleIndex &lt; SampleCountToOutput;</span></div><span class="line">            ++SampleIndex)</span>
<span class="line">    {</span><div class=" edit"><span class="line">        f32 SineValue = sinf(tSine);</span>
<span class="line">        s16 SampleValue = (s16)(SineValue * ToneVolume);</span></div><span class="line"></span>
<span class="line">        *SampleOut++ = SampleValue;</span>
<span class="line">        *SampleOut++ = SampleValue;</span>
<span class="line"></span><div class=" edit"><span class="line">        tSine += <span class="hljs-number">2.0f</span> * Pi32 * <span class="hljs-number">1.0f</span> / (f32)SoundOutput-&gt;WavePeriod;</span></div><div class=" delete"><span class="line">        ++SoundOutput-&gt;RunningSampleIndex;</span></div><span class="line">    }</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;4:</b> <file>[handmade.cpp]</file> Simplifying <code>GameSoundOutput</code>.</div></center>
<p>


We still have that <code>WavePeriod</code> that we were getting from the <code>SoundOutput</code> structure. Now, if you think about it, wave period is referring to our test code of the sine wave. We were calculating it in the following manner: 

</p><pre class="listing tilde"><code><span class="line">SoundOutput.SamplesPerSecond = <span class="hljs-number">48000</span>;</span>
<span class="line"><span class="hljs-comment">//...</span></span>
<span class="line">SoundOutput.ToneHz = <span class="hljs-number">256</span>;</span>
<span class="line"><span class="hljs-comment">// ... </span></span>
<span class="line">SoundOutput.WavePeriod = SoundOutput.SamplesPerSecond / SoundOutput.ToneHz;</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;5:</b> <file>[win32_handmade.cpp > WinMain]</file></div></center>
<p>


Now, we can safely bring over <code>ToneHz</code> in the same manner as we did with the <code>ToneVolume</code>. However, <code>SamplesPerSecond</code> is platform-specific code, it's being set and used for sound buffer initialization. And, because we don't know about <code>SamplePerSecond</code> in the platform-independent code, it should be a strong hint that the platform, by supplying us with the <code>game_sound_output_buffer</code> structure, should provide the samples per second value that we can use.

</p><pre class="listing tilde"><code><span class="line">local_persist f32 tSine;</span>
<span class="line">s16 ToneVolume = <span class="hljs-number">3000</span>;</span><div class=" add"><span class="line"><span class="hljs-keyword">int</span> ToneHz = <span class="hljs-number">256</span>;</span>
<span class="line"><span class="hljs-keyword">int</span> WavePeriod = SoundBuffer-&gt;SamplesPerSecond / ToneHz;</span></div><span class="line"></span>
<span class="line">s16 *SampleOut = SoundBuffer-&gt;Samples;</span>
<span class="line"><span class="hljs-keyword">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line">        SampleIndex &lt; SampleCountToOutput;</span>
<span class="line">        ++SampleIndex)</span>
<span class="line">{</span>
<span class="line">    f32 SineValue = sinf(tSine);</span>
<span class="line">    s16 SampleValue = (s16)(SineValue * ToneVolume);</span>
<span class="line">    </span>
<span class="line">    *SampleOut++ = SampleValue;</span>
<span class="line">    *SampleOut++ = SampleValue;</span><div class=" edit"><span class="line">    tSine += <span class="hljs-number">2.0f</span> * Pi32 * <span class="hljs-number">1.0f</span> / (f32)WavePeriod;</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;6:</b> <file>[handmade.cpp > GameSoundOutput]</file> Finalizing <code>GameSoundOutput</code>.</div></center>
<p>




<div class="admonition tip">This is a good example of why we said we want to write the usage code first. Simply by writing the usage code you can already tell what the API should provide, and in which manner. And you don't have to guess or presuppose, you just know because that's what you need.</div>

</p>
<a class="target" name="startcompiling">&nbsp;</a><a class="target" name="movesoundacrosstheapiboundary/startcompiling">&nbsp;</a><a class="target" name="toc1.3">&nbsp;</a><h2>Start Compiling</h2>
<p>


We can now start the compiling process, and let the compiling process guide you. 

</p><p>

<div class="admonition tip">As a reminder, by default you can quickly jump to compile errors using <code>Alt-N</code> in <a href="https://4coder.itch.io/4coder">4coder</a>, and <code>F8</code> if you use the build system in <a href="https://code.visualstudio.com/">VSCode</a>.</div>

</p><p>

The first error that you're going to hit is the missing <code>game_sound_output_buffer</code> identifier (duh). Let's add it to <code>handmade.h</code>. We know exactly what needs to go in there: <code>Samples</code> and <code>SamplesPerSecond</code>: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">game_offscreen_buffer</span></span>
<span class="line">{</span></span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">};</span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">game_sound_output_buffer</span></span>
<span class="line">{</span></span>
<span class="line">    <span class="hljs-keyword">int</span> SamplesPerSecond;</span>
<span class="line">    s16* Samples;</span>
<span class="line">};</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;7:</b> <file>[handmade.h]</file> Defining <code>game_sound_output_buffer</code>.</div></center>
<p>


On a second thought, we can make the API even simpler by also making <code>SampleCountToOutput</code> (which we can simply call <code>SampleCount</code>) part of <code>game_sound_output_buffer</code>: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">game_sound_output_buffer</span></span>
<span class="line">{</span></span>
<span class="line">    <span class="hljs-keyword">int</span> SamplesPerSecond;</span><div class=" add"><span class="line">    <span class="hljs-keyword">int</span> SampleCount;</span></div><span class="line">    s16* Samples;</span>
<span class="line">};</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;8:</b> <file>[handmade.h]</file> Expanding <code>game_sound_output_buffer</code>.</div></center>
<pre class="listing tilde"><code><span class="line">internal <span class="hljs-keyword">void</span></span><div class=" edit"><span class="line">GameSoundOutput(game_sound_output_buffer *SoundBuffer)</span></div><span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> SampleIndex = <span class="hljs-number">0</span>;</span><div class=" edit"><span class="line">         SampleIndex &lt; SoundBuffer-&gt;SampleCount;</span></div><span class="line">         ++SampleIndex)</span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// ... </span></span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">GameUpdateAndRender</span><span class="hljs-params">(game_offscreen_buffer* Buffer, <span class="hljs-keyword">int</span> XOffset, <span class="hljs-keyword">int</span> YOffset)</span></span>
<span class="line"></span>{</span><div class=" edit"><span class="line">    GameSoundOutput(SoundBuffer);</span></div><span class="line">    RenderWeirdGradient(Buffer, XOffset, YOffset);</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;9:</b> <file>[handmade.h]</file> Simplifying the API.</div></center>
<p>


We can update our <code>GameUpdateAndRender</code> call to actually receive the sound output buffer from the system. We need to make changes in <code>handmade.h</code> and <code>handmade.cpp</code>; we'll get to the platform code in a second. 

</p><pre class="listing tilde"><code><span class="line">internal <span class="hljs-keyword">void</span></span><div class=" edit"><span class="line">GameUpdateAndRender(game_offscreen_buffer* Buffer, <span class="hljs-keyword">int</span> XOffset, <span class="hljs-keyword">int</span> YOffset, </span>
<span class="line">                    game_sound_output_buffer* SoundBuffer)</span></div><span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;10:</b> <file>[handmade.cpp]</file></div></center>
<pre class="listing tilde"><code><div class=" edit"><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span> <span class="hljs-title">GameUpdateAndRender</span><span class="hljs-params">(game_offscreen_buffer* Buffer, <span class="hljs-keyword">int</span> XOffset, <span class="hljs-keyword">int</span> YOffset,</span>
<span class="line">                                  game_sound_output_buffer *SoundBuffer)</span></span>;</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;11:</b> <file>[handmade.h]</file> Receiving <code>SoundBuffer</code> from the platform.</div></center>
<p>


Our next error is the missing <code>sinf</code> function, let's simply reorder the headers around:

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-comment">// TODO(casey): Implement sine ourselves</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;math.h&gt;</span></span></span></div><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-comment">// ...</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> internal static</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> local_persist static</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> global_variable static</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> Pi32 3.14159265359f</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"handmade.cpp"</span></span></span>
<span class="line"></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;xinput.h&gt;</span></span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dsound.h&gt;</span></span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span></span><div class=" delete"><span class="line"><span class="hljs-comment">// TODO(casey): Implement sine ourselves</span></span>
<span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;math.h&gt;</span></span></span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;12:</b> <file>[win32_handmade.cpp]</file> Reshuffling header files.</div></center>

<a class="target" name="fixcompilererrors">&nbsp;</a><a class="target" name="movesoundacrosstheapiboundary/fixcompilererrors">&nbsp;</a><a class="target" name="toc1.4">&nbsp;</a><h2>Fix Compiler Errors</h2>
<p>


We finally arrive down to the platform layer. We've got the sound output buffer now which has to be filled by the game... and you'll notice that it's really not that big. Let's do a quick calculation. 

</p><p>

We're aiming to have 60 frame-per-second framerate. Our sound buffer outputs 48000 samples per second, so let's make a quick calculation: 

</p><p>

$$\frac{48000\ samples/second}{60\ frames/second} = 800\ samples/frame$$

</p><p>

We know that each sample is 2 bytes (16 bit) long, and there're 2 of them at a time, which results in \(800\times 2\times 2 = 3200 bytes\). That's <em class="underscore">really</em> not a lot. Considering modern processors are capable of moving <em class="underscore">gigabytes</em> of data per second, it's the most insignificant amount of data a modern processor has seen.

</p><p>

So what happens here is that we've elected to suffer an extra memory buffer copy as a cost of abstracting it out and presenting a cleaner interface of writing just to a single buffer, without having to think about the DirectSound's dual ring buffer. It's a tradeoff, but we choose to go for a more expensive and cleaner solution considering that some operating systems don't even have the ring buffer systems in first place! We can always return later and introduce the added complexity if it turns out we really need those extra cycles.

</p><p>

We'll be aiming to have a 30 fps sound buffer, because often we'll be locking the game to 30 frames per second for debug purposes. It's still only 6400 bytes, double of what we calculated above.

</p><p>

So, let's fill out the <code>SoundBuffer</code> to pass to our game: 

</p><p>

<ul>
<li class="asterisk"><code>SamplesPerSecond</code>: We have it already, pass it as is.
</li>
<li class="asterisk"><code>SampleCount</code>: As we said, we want 1/30<sup>th</sup> of a second worth of samples per second. It's not final shipping code by any stretch, so simply calculating it on the spot should be fine. 
</li>
<li class="asterisk"><code>Samples</code>: We'll cheese this part as well, simply allocate a large enough buffer on stack. We want \(\frac{48000\ samples}{30\ frames/second} \times 2\ channels\).</li></ul>

</p><pre class="listing tilde"><code><div class=" add"><span class="line">s16 Samples[(<span class="hljs-number">48000</span>/<span class="hljs-number">30</span>)*<span class="hljs-number">2</span>];</span>
<span class="line">game_sound_output_buffer SoundBuffer = {}; <span class="hljs-comment">// clear to zero!</span></span>
<span class="line">SoundBuffer.SamplesPerSecond = SoundOutput.SamplesPerSecond;</span>
<span class="line">SoundBuffer.SampleCount = SoundBuffer.SamplesPerSecond / <span class="hljs-number">30</span>;</span>
<span class="line">SoundBuffer.Samples = Samples;</span></div><span class="line"></span>
<span class="line">game_offscreen_buffer Buffer = {}; </span>
<span class="line"><span class="hljs-comment">//...</span></span>
<span class="line"></span><div class=" edit"><span class="line">GameUpdateAndRender(&amp;Buffer, XOffset, YOffset, &amp;SoundBuffer);</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;13:</b> <file>[win32_handmade.cpp > WinMain]</file> Defining and passing the <code>SoundBuffer</code> to the game.</div></center>
<p>


We hope it goes without saying: don't try this <del>at home</del> in your shipping code! This is super janky and error prone, and we'll be replacing this code in a short while already. But! We're now compilable, and should be running as before. 

</p><p>

<div class="admonition ">For a quick tangent regarding <em class="underscore">buffer overruns</em>, head over to subsection  <a href="#toc5.3">5.3</a>.</div>

</p>
<a class="target" name="useplatform-specificsounds">&nbsp;</a><a class="target" name="useplatform-specificsounds">&nbsp;</a><a class="target" name="toc2">&nbsp;</a><h1>Use Platform-Specific Sounds</h1>
<p>


Right now, we're still using the sine waves generated in the platform layer. The game layer is generating the sounds for the platform, but we aren't using those in any way. Let's fix this. 

</p>
<a class="target" name="updatewin32fillsoundbuffer">&nbsp;</a><a class="target" name="useplatform-specificsounds/updatewin32fillsoundbuffer">&nbsp;</a><a class="target" name="toc2.1">&nbsp;</a><h2>Update <code>Win32FillSoundBuffer</code></h2>
<p>


We have <code>Win32FillSoundBuffer</code> function which is currently creating the sounds. We could adapt it so it would simply write whatever sounds it will receive from our game: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">if</span> (SUCCEEDED(GlobalSecondaryBuffer-&gt;GetCurrentPosition(&amp;PlayCursor, &amp;WriteCursor)))</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ... </span></span><div class=" edit"><span class="line">    Win32FillSoundBuffer(&amp;SoundOutput, ByteToLock, BytesToWrite, &amp;SoundBuffer);</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;14:</b> <file>[win32_handmade.cpp > WinMain]</file> Passing the (filled) <code>SoundBuffer</code> to <code>Win32FillSoundBuffer</code>.</div></center>
<p>


In here, we would simply take the &ldquo;source samples&rdquo; and write them to the &ldquo;destination samples&rdquo;. Simple copy, nothing else: 

</p><pre class="listing tilde"><code><span class="line">internal <span class="hljs-keyword">void</span></span><div class=" edit"><span class="line">Win32FillSoundBuffer(win32_sound_output *SoundOutput, DWORD ByteToLock, DWORD BytesToWrite,</span>
<span class="line">                     game_sound_output_buffer *SourceBuffer)</span></div><span class="line">{</span>
<span class="line">    VOID *Region1;</span>
<span class="line">    DWORD Region1Size;</span>
<span class="line">    VOID *Region2;</span>
<span class="line">    DWORD Region2Size;</span>
<span class="line">    <span class="hljs-keyword">if</span>(SUCCEEDED(GlobalSecondaryBuffer-&gt;Lock(ByteToLock, BytesToWrite,</span>
<span class="line">                                             &amp;Region1, &amp;Region1Size,</span>
<span class="line">                                             &amp;Region2, &amp;Region2Size,</span>
<span class="line">                                             <span class="hljs-number">0</span>)))</span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// TODO(casey): assert that Region1Size/Region2Size are valid</span></span>
<span class="line">        DWORD Region1SampleCount = Region1Size / SoundOutput-&gt;BytesPerSample;</span><div class=" add"><span class="line">        s16 *SourceSample = SourceBuffer-&gt;Samples;</span></div><div class=" edit"><span class="line">        s16 *DestSample = (s16 *)Region1;</span></div><span class="line">        <span class="hljs-keyword">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line">             SampleIndex &lt; Region1SampleCount;</span>
<span class="line">             ++SampleIndex)</span>
<span class="line">        {</span><div class=" delete"><span class="line">            f32 SineValue = sinf(SoundOutput-&gt;tSine);</span>
<span class="line">            s16 SampleValue = (s16)(SineValue * SoundOutput-&gt;ToneVolume);</span></div><span class="line">            </span><div class=" edit"><span class="line">            *DestSample++ = *SourceSample++;</span>
<span class="line">            *DestSample++ = *SourceSample++;</span></div><span class="line">            </span><div class=" delete"><span class="line">            SoundOutput-&gt;tSine += <span class="hljs-number">2.0f</span> * Pi32 * <span class="hljs-number">1.0f</span> / (f32)SoundOutput-&gt;WavePeriod;</span></div><span class="line">            ++SoundOutput-&gt;RunningSampleIndex;</span>
<span class="line">        }</span>
<span class="line">        </span><div class=" edit"><span class="line">        DestSample = (s16 *)Region2;</span></div><span class="line">        DWORD Region2SampleCount = Region2Size / SoundOutput-&gt;BytesPerSample;</span>
<span class="line">        <span class="hljs-keyword">for</span> (DWORD SampleIndex = <span class="hljs-number">0</span>;</span>
<span class="line">             SampleIndex &lt; Region2SampleCount;</span>
<span class="line">             ++SampleIndex)</span>
<span class="line">        {</span><div class=" delete"><span class="line">            f32 SineValue = sinf(SoundOutput-&gt;tSine);</span>
<span class="line">            s16 SampleValue = (s16)(SineValue * SoundOutput-&gt;ToneVolume);</span></div><span class="line">            </span><div class=" edit"><span class="line">            *DestSample++ = *SourceSample++;</span>
<span class="line">            *DestSample++ = *SourceSample++;</span></div><span class="line">            </span><div class=" delete"><span class="line">            SoundOutput-&gt;tSine += <span class="hljs-number">2.0f</span> * Pi32 * <span class="hljs-number">1.0f</span> / (f32)SoundOutput-&gt;WavePeriod;</span></div><span class="line">            ++SoundOutput-&gt;RunningSampleIndex;</span>
<span class="line">        }</span>
<span class="line">        </span>
<span class="line">        GlobalSecondaryBuffer-&gt;Unlock(Region1, Region1Size, Region2, Region2Size);</span>
<span class="line">    }</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;15:</b> <file>[win32_handmade.cpp]</file> Simplifying <code>Win32FillSoundBuffer</code>.</div></center>

<a class="target" name="introducewin32clearbuffer">&nbsp;</a><a class="target" name="useplatform-specificsounds/introducewin32clearbuffer">&nbsp;</a><a class="target" name="toc2.2">&nbsp;</a><h2>Introduce <code>Win32ClearBuffer</code></h2>
<p>


We also need to modify our startup code. The compiler will fail since we were calling <code>Win32FillSoundBuffer</code> to run the sine wave right after initializing DirectSound. That's fine, we could update it, except now we simply want to clear the whole buffer. So what we really want here is a function which simply <em class="underscore">flushes</em> the buffer with <code>0</code>s:

</p><pre class="listing tilde"><code><span class="line">Win32InitDSound(Window, SoundOutput.SamplesPerSecond, SoundOutput.SecondaryBufferSize);</span><div class=" delete"><span class="line">Win32FillSoundBuffer(&amp;SoundOutput, <span class="hljs-number">0</span>, (SoundOutput.LatencySampleCount * SoundOutput.BytesPerSample));</span></div><div class=" add"><span class="line">Win32ClearBuffer(&amp;SoundOutput);</span></div><span class="line">GlobalSecondaryBuffer-&gt;Play(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, DSBPLAY_LOOPING);</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;16:</b> <file>[win32_handmade.cpp > WinMain]</file> Introducing <code>Win32ClearBuffer</code>.</div></center>
<p>


As for implementing this function, it should be quite straightforward. First, we lock the secondary buffer for its entire length and unlock it at the end. We could copy the necessary code straight from <code>Win32FillSoundBuffer</code>.

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">Win32ClearBuffer</span><span class="hljs-params">(win32_sound_output *SoundOutput)</span></span>
<span class="line"></span>{</span>
<span class="line">    VOID *Region1;</span>
<span class="line">    DWORD Region1Size;</span>
<span class="line">    VOID *Region2;</span>
<span class="line">    DWORD Region2Size;</span>
<span class="line">    <span class="hljs-keyword">if</span>(SUCCEEDED(GlobalSecondaryBuffer-&gt;Lock(<span class="hljs-number">0</span>, SoundOutput-&gt;SecondaryBufferSize,</span>
<span class="line">                                             &amp;Region1, &amp;Region1Size,</span>
<span class="line">                                             &amp;Region2, &amp;Region2Size,</span>
<span class="line">                                             <span class="hljs-number">0</span>)))</span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// Do the work</span></span>
<span class="line">        GlobalSecondaryBuffer-&gt;Unlock(Region1, Region1Size, Region2, Region2Size);</span>
<span class="line">    }</span>
<span class="line">}</span></div><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">Win32FillSoundBuffer</span><span class="hljs-params">(...)</span></span>
<span class="line"></span>{</span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;17:</b> <file>[win32_handmade.cpp]</file> Locking the buffer for writing.</div></center>
<p>


After we've locked our buffer, we'll take the entirety of the region 1 and fill it with zeroes. We don't even need to operate on 16-bit samples any more, we can simply go and clear bytes one by one. 

</p><pre class="listing tilde"><code><div class=" add"><span class="line">u8 *DestSample = (u8 *)Region1;</span>
<span class="line"><span class="hljs-keyword">for</span> (DWORD ByteIndex = <span class="hljs-number">0</span>;</span>
<span class="line">     ByteIndex &lt; Region1Size;</span>
<span class="line">     ++ByteIndex)</span>
<span class="line">{</span>
<span class="line">    *DestSample++ = <span class="hljs-number">0</span>;</span>
<span class="line">}</span></div><span class="line">GlobalSecondaryBuffer-&gt;Unlock(Region1, Region1Size, Region2, Region2Size);</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;18:</b> <file>[win32_handmade.cpp > Win32ClearBuffer]</file> Clearing region 1.</div></center>
<p>


We don't think we'll ever need to do anything with region 2 during startup, but just to be sure, let's clear it as well:

</p><pre class="listing tilde"><code><span class="line">u8 *DestSample = (u8 *)Region1;</span>
<span class="line"><span class="hljs-keyword">for</span> (DWORD ByteIndex = <span class="hljs-number">0</span>;</span>
<span class="line">     ByteIndex &lt; Region1Size;</span>
<span class="line">     ++ByteIndex)</span>
<span class="line">{</span>
<span class="line">    *DestSample++ = <span class="hljs-number">0</span>;</span>
<span class="line">}</span><div class=" add"><span class="line">DestSample = (u8 *)Region2;</span>
<span class="line"><span class="hljs-keyword">for</span> (DWORD ByteIndex = <span class="hljs-number">0</span>;</span>
<span class="line">     ByteIndex &lt; Region2Size;</span>
<span class="line">     ++ByteIndex)</span>
<span class="line">{</span>
<span class="line">    *DestSample++ = <span class="hljs-number">0</span>;</span>
<span class="line">}</span></div><span class="line">GlobalSecondaryBuffer-&gt;Unlock(Region1, Region1Size, Region2, Region2Size);</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;19:</b> <file>[win32_handmade.cpp > Win32ClearBuffer]</file> Clearing region 2.</div></center>
<p>




<div class="admonition ">You could potentially simplify this further. There're functions in the C Standard Library (namely, <a href="https://www.cplusplus.com/reference/cstring/memset/">memset</a>) which does this work for you, so you want need to make the iteration/clear loops yourself. 

</p><p>

    Since we're trying to do everything ourselves, we won't be using this function. We do encourage to try it out as an exercise for the reader.</div>

</p>
<a class="target" name="increasebuffersize">&nbsp;</a><a class="target" name="useplatform-specificsounds/increasebuffersize">&nbsp;</a><a class="target" name="toc2.3">&nbsp;</a><h2>Increase Buffer Size</h2>
<p>


We should be now compilable, but you will crash immediately upon running. This is due to the fact that we still use the full buffer length (or better, from where we stopped writing previously to the cursor position) to write the sound buffer, and not the 1/30<sup>th</sup> of a second that we pass as the source. 

</p><p>

There are many ways to fix this issue. Ideally, we'd be changing the length of <code>BytesToWrite</code> at each frame to something corresponding to how much we actually want to write. We might also update the samples <em class="underscore">just before</em> the play cursor. We'll do all these things given the time. For now however, let's do the simpler thing: output exactly the amount of samples the platform layer expects us to. 

</p><p>

In order to do that, we face one particular issue: the code calculating <code>BytesToWrite</code> and outputting sound is below our <code>GameUpdateAndRender</code> call. This is fine for outputting sound, we want to write the samples first, and then release them to the operating system. But the code to calculate <code>BytesToWrite</code> we can simply put above our <code>SoundBuffer</code> definition. We'll use a boolean <code>SoundIsValid</code> to verify that everything went smoothly.

</p><pre class="listing tilde"><code><div class=" add"><span class="line">DWORD PlayCursor;</span>
<span class="line">DWORD WriteCursor;</span>
<span class="line">b32 SoundIsValid = <span class="hljs-literal">false</span>;</span>
<span class="line"><span class="hljs-keyword">if</span> (SUCCEEDED(GlobalSecondaryBuffer-&gt;GetCurrentPosition(&amp;PlayCursor, &amp;WriteCursor)))</span>
<span class="line">{</span>
<span class="line">   </span>
<span class="line">    DWORD ByteToLock = ((SoundOutput.RunningSampleIndex * SoundOutput.BytesPerSample)</span>
<span class="line">                         % SoundOutput.SecondaryBufferSize);</span>
<span class="line">    DWORD TargetCursor = ((PlayCursor +</span>
<span class="line">                             (SoundOutput.LatencySampleCount * SoundOutput.BytesPerSample))</span>
<span class="line">                         % SoundOutput.SecondaryBufferSize);</span>
<span class="line">    DWORD BytesToWrite;</span>
<span class="line"></span>
<span class="line">    <span class="hljs-keyword">if</span>(ByteToLock &gt; TargetCursor)</span>
<span class="line">    {</span>
<span class="line">        BytesToWrite = SoundOutput.SecondaryBufferSize - ByteToLock;</span>
<span class="line">        BytesToWrite += TargetCursor;</span>
<span class="line">    }</span>
<span class="line">    <span class="hljs-keyword">else</span></span>
<span class="line">    {</span>
<span class="line">        BytesToWrite = TargetCursor - ByteToLock;</span>
<span class="line">    }</span>
<span class="line">    </span>
<span class="line">    SoundIsValid = <span class="hljs-literal">true</span>;</span>
<span class="line">}</span></div><span class="line"></span>
<span class="line">s16 Samples[(<span class="hljs-number">48000</span>/<span class="hljs-number">30</span>)*<span class="hljs-number">2</span>];</span>
<span class="line">game_sound_output_buffer SoundBuffer = {};</span>
<span class="line">SoundBuffer.SamplesPerSecond = SoundOutput.SamplesPerSecond;</span>
<span class="line">SoundBuffer.SampleCount = SoundBuffer.SamplesPerSecond / <span class="hljs-number">30</span>;</span>
<span class="line">SoundBuffer.Samples = Samples;</span>
<span class="line"></span>
<span class="line"><span class="hljs-comment">// Definition of the render buffer... </span></span>
<span class="line"></span>
<span class="line">GameUpdateAndRender(&amp;Buffer, XOffset, YOffset, &amp;SoundBuffer);</span>
<span class="line"></span><div class=" delete"><span class="line">DWORD PlayCursor;</span>
<span class="line">DWORD WriteCursor;</span></div><div class=" edit"><span class="line"><span class="hljs-keyword">if</span> (SoundIsValid)</span></div><span class="line">{</span><div class=" delete"><span class="line">    DWORD ByteToLock = ((SoundOutput.RunningSampleIndex * SoundOutput.BytesPerSample)</span>
<span class="line">                        % SoundOutput.SecondaryBufferSize);</span>
<span class="line">    DWORD TargetCursor = ((PlayCursor + (SoundOutput.LatencySampleCount * SoundOutput.BytesPerSample))</span>
<span class="line">                            % SoundOutput.SecondaryBufferSize);</span>
<span class="line">    DWORD BytesToWrite;</span>
<span class="line">    </span>
<span class="line">    <span class="hljs-keyword">if</span>(ByteToLock &gt; TargetCursor)</span>
<span class="line">    {</span>
<span class="line">        BytesToWrite = SoundOutput.SecondaryBufferSize - ByteToLock;</span>
<span class="line">        BytesToWrite += TargetCursor;</span>
<span class="line">    }</span>
<span class="line">    <span class="hljs-keyword">else</span></span>
<span class="line">    {</span>
<span class="line">        BytesToWrite = TargetCursor - ByteToLock;</span>
<span class="line">    }</span>
<span class="line"></span></div><div class=" C++ "><span class="line">    Win32FillSoundBuffer(&amp;SoundOutput, ByteToLock, BytesToWrite, &amp;SoundBuffer);</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;20:</b> <file>[win32_handmade.cpp > WinMain]</file> Moving up output code.</div></center>
<p>


We also want to extract higher the variables we define, such as <code>ByteToLock</code>, <code>TargetCursor</code> and <code>BytesToWrite</code>, so that they are accessible outside their scope. For instance, <code>Win32FillSoundBuffer</code> needs to see <code>ByteToLock</code> and <code>BytesToWrite</code>! 

</p><pre class="listing tilde"><code><div class=" add"><span class="line">DWORD ByteToLock;</span>
<span class="line">DWORD TargetCursor;</span>
<span class="line">DWORD BytesToWrite;</span></div><span class="line">DWORD PlayCursor;</span>
<span class="line">DWORD WriteCursor;</span>
<span class="line">b32 SoundIsValid = <span class="hljs-literal">false</span>;</span>
<span class="line"><span class="hljs-keyword">if</span> (SUCCEEDED(GlobalSecondaryBuffer-&gt;GetCurrentPosition(&amp;PlayCursor, &amp;WriteCursor)))</span>
<span class="line">{</span><div class=" edit"><span class="line">    ByteToLock = ((SoundOutput.RunningSampleIndex * SoundOutput.BytesPerSample)</span>
<span class="line">                    % SoundOutput.SecondaryBufferSize);</span>
<span class="line">    TargetCursor = ((PlayCursor +</span>
<span class="line">                        (SoundOutput.LatencySampleCount * SoundOutput.BytesPerSample))</span>
<span class="line">                    % SoundOutput.SecondaryBufferSize);</span></div><span class="line">    </span><div class=" delete"><span class="line">    DWORD BytesToWrite;</span></div><span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;21:</b> <file>[win32_handmade.cpp > WinMain]</file> Enabling variable visibility in the higher scope. We don't really <em class="underscore">need</em> to extract <code>TargetCursor</code> for now, but you never know, and it keeps things organized nice and tidy.</div></center>
<p>


Now that we've completed this refactoring step, we finally know how many samples do we need our game to write. It's simply <code>BytesToWrite</code> divided by the <code>BytesPerSample</code>:

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line">s16 Samples[(48000/30)*2];</span>
<span class="line">game_sound_output_buffer SoundBuffer = {};</span>
<span class="line">SoundBuffer.SamplesPerSecond = SoundOutput.SamplesPerSecond;</span></div><div class=" edit"><span class="line">SoundBuffer.SampleCount = BytesToWrite / SoundOutput.BytesPerSample;</span></div><span class="line">SoundBuffer.Samples = Samples;</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;22:</b> <file>[win32_handmade.cpp > WinMain]</file> Updating <code>SampleCount</code> to request from the game.</div></center>

<a class="target" name="expandsamplesbuffersize">&nbsp;</a><a class="target" name="useplatform-specificsounds/expandsamplesbuffersize">&nbsp;</a><a class="target" name="toc2.4">&nbsp;</a><h2>Expand <code>Samples</code> Buffer Size</h2>
<p>


This update creates another issue: we can no longer know in advance how big our <code>Samples</code> buffer should be. At this point we can simply say that the <code>Samples</code> is as big as our secondary buffer size is, and it will be used for however big <code>SampleCount</code> will tell. 

</p><p>

It's worth to start doing buffer allocation in the right way so that, should buffer size change, we wouldn't crash and burn and have to update all the things we set manually all over again. To do that, we could use something like <code>alloca</code> to keep allocating on the program <em class="underscore">stack</em> (more on this in subsection  <a href="#toc4.1">4.1</a>), or go ahead and use the already familiar <code>VirtualAlloc</code> to allocate on the <em class="underscore">heap</em> (virtual memory). Let's do that, right after we initialize DirectSound:

</p><pre class="listing tilde"><code><span class="line">Win32InitDSound(Window, SoundOutput.SamplesPerSecond, SoundOutput.SecondaryBufferSize);</span>
<span class="line">Win32ClearBuffer(&amp;SoundOutput);</span>
<span class="line">GlobalSecondaryBuffer-&gt;Play(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, DSBPLAY_LOOPING);</span><div class=" add"><span class="line">s16 *Samples = (s16 *)VirtualAlloc(<span class="hljs-number">0</span>, SoundOutput.SecondaryBufferSize,</span>
<span class="line">                                    MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);</span></div><span class="line"><span class="hljs-comment">// ... </span></span><div class=" delete"><span class="line">s16 Samples[(<span class="hljs-number">48000</span>/<span class="hljs-number">30</span>)*<span class="hljs-number">2</span>];</span></div><span class="line">game_sound_output_buffer SoundBuffer = {};</span>
<span class="line"><span class="hljs-comment">// ... </span></span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;23:</b> <file>[win32_handmade.cpp > WinMain]</file> Dynamically Allocating <code>Samples</code> buffer on the heap.</div></center>
<p>




<div class="admonition warning">Make sure you allocate memory outside the main loop! Or, if you do it inside the loop, remember to free that memory once you don't need it anymore.</div>

</p><p>

That's it! This should again result in working sound. However, this time you'll notice that we have no <code>sinf</code> inside <code>win32_handmade.cpp</code>: all the sound generation is happening in our cross-platform code!

</p>
<a class="target" name="backtofeatureparity">&nbsp;</a><a class="target" name="useplatform-specificsounds/backtofeatureparity">&nbsp;</a><a class="target" name="toc2.5">&nbsp;</a><h2>Back to Feature Parity</h2>
<p>


Our refactoring went well, but we aren't at the feature parity yet! When we set off porting the sound generation to the game layer, we could control the pitch with the gamepad. Let's get this functionality back! 

</p><p>

Since we've done so much work on sound already, let's make a quick and dirty job of it, and think of optimizing it better next time. We'll simply pass it to <code>GameUpdateAndRender</code>. Let's jump through the changes round!

</p><p>

First, update the call inside <code>WinMain</code>: 

</p><pre class="listing tilde"><code><span class="line">game_offscreen_buffer Buffer = {};</span>
<span class="line"><span class="hljs-comment">// ...</span></span>
<span class="line"></span><div class=" edit"><span class="line">GameUpdateAndRender(&amp;Buffer, XOffset, YOffset, &amp;SoundBuffer, SoundOutput.ToneHz);</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;24:</b> <file>[win32_handmade.cpp > WinMain]</file> Updating <code>GameUpdateAndRender</code> call to include <code>ToneHz</code>.</div></center>
<p>


Next, update the function declaration inside <code>handmade.h</code>:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span> <span class="hljs-title">GameUpdateAndRender</span><span class="hljs-params">(game_offscreen_buffer* Buffer, <span class="hljs-keyword">int</span> XOffset, <span class="hljs-keyword">int</span> YOffset,</span></span></span><div class=" edit"><span class="line">                                  game_sound_output_buffer *SoundBuffer, <span class="hljs-keyword">int</span> ToneHz);</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;25:</b> <file>[handmade.h]</file> Updating <code>GameUpdateAndRender</code> signature.</div></center>
<p>


Then, receive <code>ToneHz</code> inside the actual function definition and immediately send it to <code>GameSoundOutput</code>: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">GameUpdateAndRender</span><span class="hljs-params">(game_offscreen_buffer* Buffer, <span class="hljs-keyword">int</span> XOffset, <span class="hljs-keyword">int</span> YOffset, </span></span></span><div class=" edit"><span class="line">                    game_sound_output_buffer* SoundBuffer, <span class="hljs-keyword">int</span> ToneHz)</span></div><span class="line">{</span><div class=" edit"><span class="line">    GameSoundOutput(SoundBuffer, ToneHz);</span></div><span class="line">    RenderWeirdGradient(Buffer, XOffset, YOffset);</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;26:</b> <file>[handmade.cpp]</file> Sending <code>ToneHz</code> to the sound generating code.</div></center>
<p>


Last but not least, update <code>GameSoundOutput</code> to actually use the tone!

</p><pre class="listing tilde"><code><span class="line">internal <span class="hljs-keyword">void</span></span><div class=" edit"><span class="line">GameSoundOutput(game_sound_output_buffer *SoundBuffer, <span class="hljs-keyword">int</span> ToneHz)</span></div><span class="line">{</span>
<span class="line">    local_persist f32 tSine;</span>
<span class="line">    s16 ToneVolume = <span class="hljs-number">3000</span>;</span><div class=" delete"><span class="line">    <span class="hljs-keyword">int</span> ToneHz = <span class="hljs-number">256</span>;</span></div><span class="line">    <span class="hljs-keyword">int</span> WavePeriod = SoundBuffer-&gt;SamplesPerSecond / ToneHz;</span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;27:</b> <file>[handmade.cpp]</file> Using <code>ToneHz</code>.</div></center>
<p>


That's it! 

</p>
<a class="target" name="recap">&nbsp;</a><a class="target" name="recap">&nbsp;</a><a class="target" name="toc3">&nbsp;</a><h1>Recap</h1>
<p>


Sound API is difficult to get right for cross-platform use, as any minor inconsistency is immediately noticeable. We'll be doing more tuning and improving on the sound quite soon so that it's not only applicable to the sound waves; in the meantime, we can consider the first cross-platform transition of our sound complete, so next time we can focus on other things. For now however, let's close out with a TODO to keep up as busy in the future: 

</p><pre class="listing tilde"><code><span class="line">DWORD ByteToLock;</span>
<span class="line">DWORD TargetCursor;</span>
<span class="line">DWORD BytesToWrite;</span>
<span class="line">DWORD PlayCursor;</span>
<span class="line">DWORD WriteCursor;</span>
<span class="line">b32 SoundIsValid = <span class="hljs-literal">false</span>;</span><div class=" add"><span class="line"><span class="hljs-comment">// TODO(casey): Tighten up sound logic so that we know where we should be </span></span>
<span class="line"><span class="hljs-comment">// writing to and can anticipate the time spent in the game updates.</span></span></div><span class="line"><span class="hljs-keyword">if</span> (SUCCEEDED(GlobalSecondaryBuffer-&gt;GetCurrentPosition(&amp;PlayCursor, &amp;WriteCursor)))</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-comment">// ... </span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;28:</b> <file>[handmade.cpp]</file> Leaving some thoughts for the future.</div></center>

<a class="target" name="programmingnotions">&nbsp;</a><a class="target" name="programmingnotions">&nbsp;</a><a class="target" name="toc4">&nbsp;</a><h1>Programming Notions</h1>

<a class="target" name="alloca">&nbsp;</a><a class="target" name="programmingnotions/alloca">&nbsp;</a><a class="target" name="toc4.1">&nbsp;</a><h2>Alloca</h2>
<p>


<code>alloca</code> looks like something you'd find in a C Standard Library. However, it does not make part of the standard: many compilers simply include a function which allows to dynamically allocate some memory on the stack. 

</p><p>

Why allocate on stack, as opposed to the heap? As with anything, there're several advantages and disadvantages to it. 

</p><p>

It's advantages are: 

</p><p>

<ul>
<li class="asterisk">It's faster. Reserving a new page of virtual memory takes time since it's a kernel call; stack allocation are, for all intents and purposes, immediate.
</li>
<li class="asterisk">You don't need to think about freeing the memory. Once you go out of the scope of the function allocating the memory, the stack is popped back automatically, and the memory is freed. (Not the local scope, mind you! You can't run <code>alloca</code> inside a loop indefinitely!)</li></ul>

</p><p>

The downside is the following: 

</p><p>

<ul>
<li class="asterisk">Since allocation happens on stack, it's limited by the stack size. Stack is shared with all the functions parameters, local variables, etc., and once it's gone, it's gone. There's only Stack Overflow and the inevitable program crash waiting at the end.</li></ul>

</p><p>

For this reason, this is again one of those tools which might be useful for a quick task usually happening inside the debug code. 

</p><p>

<em class="underscore">(Back to subsection  <a href="#toc2.4">2.4</a>)</em>

</p>
<a class="target" name="sideconsiderations">&nbsp;</a><a class="target" name="sideconsiderations">&nbsp;</a><a class="target" name="toc5">&nbsp;</a><h1>Side Considerations</h1>

<a class="target" name="updatebuild.bat:removeerrormessage">&nbsp;</a><a class="target" name="sideconsiderations/updatebuild.bat:removeerrormessage">&nbsp;</a><a class="target" name="toc5.1">&nbsp;</a><h2>Update <code>build.bat</code>: Remove Error Message</h2>
<p>


Let's quickly tweak our <code>build.bat</code> file. Right now, if we try to compile, we're usually greeted with the following message: 

</p><pre class="listing tilde"><code><span class="line">A subdirectory or file build already exists.</span></code></pre><p>

This is because we try to create a <code>build</code> directory each time we run our <code>build.bat</code>! Let's fix this since batch scripting allows us to add some logic: 

</p><pre class="listing tilde"><code><span class="line">@echo off</span>
<span class="line"></span><div class=" edit"><span class="line">if not exist build (mkdir build)</span></div><span class="line">pushd build</span>
<span class="line"></span>
<span class="line">cl -DHANDMADE_WIN32=1 -FC -Zi ..\code\win32_handmade.cpp user32.lib gdi32.lib</span>
<span class="line"></span>
<span class="line">popd</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;29:</b> <file>[build.bat]</file> Adding a condition for command execution.</div></center>
<p>


You can also write it in all caps, <code>IF NOT EXIST</code>. Both methods work fine.

</p>
<a class="target" name="ontemporalityofsound">&nbsp;</a><a class="target" name="sideconsiderations/ontemporalityofsound">&nbsp;</a><a class="target" name="toc5.2">&nbsp;</a><h2>On Temporality of Sound</h2>
<p>


We can't think about sound without thinking about time. The thing about sound is that it's <em class="underscore">temporal</em> in nature. While video frames are prepared one at a time, and you can reason about each frame as a standalone painting, audio <em class="underscore">always</em> happens over time. Therefore, in a game it's not optional for how long a sound would be playing for: the reproduction must be continuos.

</p><p>

Let's take an example. If you write sound for 1/16<sup>th</sup> of a second (62.5ms), and then play it for 1/8<sup>th</sup> of a second (125ms), the user will hear silence or noise for the second half of the period. 

</p><p>

With sound, you're bound to stick with a specific sample speed or your brain will immediately pick up the error. It won't sound &ldquo;slower&rdquo; or &ldquo;at a lower sample rate&rdquo;. What you'll hear is a flat-out bug: clickiness, screeching, etc. You'll need to say: the sound will start at a given point in time, and you'll need a very specific amount of it. 

</p><p>

Contrast this with video: if you put up an image on a screen, it can stay there for as long as you want. The only thing that will be perceived if you hold it for too long is that the perceived <em class="underscore">framerate</em> will start to go down, and users might perceive the video as less smooth. That said, that single frame won't disappear or glitch out in some other way if it stays up a bit longer.

</p><p>

That said, video frames could also be bound by time if you use some advanced rendering techniques. Some motion blur may be calculated based on the amount of time that, you anticipate, that frame will be on screen. In that case the renderer needs to know exactly this time, to properly calculate the blur between the start and end points of all the entities, otherwise there might be teleporting glitches that the user might see in the frame after. 

</p><p>

<em class="underscore">(Back to subsection  <a href="#toc0.1">0.1</a>)</em>

</p>
<a class="target" name="bufferoverruns">&nbsp;</a><a class="target" name="sideconsiderations/bufferoverruns">&nbsp;</a><a class="target" name="toc5.3">&nbsp;</a><h2>Buffer Overruns</h2>
<p>


If you set a buffer to less than its intended size and then try to write to it, the program will compile just fine. However, when you try to run it, it will quickly crash. Depending on the debugger you're using, you might get a window pop-up, or simply a message in the <code>Output</code> window of the debugger, informing you of a &ldquo;Buffer Overrun&rdquo; or &ldquo;Access violation writing location 0x....&rdquo;

</p><p>

For instance, we can quickly get such an overrun if, instead of passing <code>(48000/30)*2</code> as our <code>Samples</code> buffer size, we set it to simply <code>(48000/30)</code>, i.e. half its intended size. If you compile and run, you'll see something similar in Visual Studio:

</p><p>

<center><div class="image" style=""><a href="../media/day12/vs_crash.jpg" target="_blank"><img class="markdeep" src="../media/day12/vs_crash.jpg" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;1:</b> Buffer Overrun in Visual Studio. In RemedyBG, the error message simply appears in the Output window.</span></center></div></center>

</p><p>

The reason for why the program halted is because the debugger inserts some checking code to see if you overwrote some memory somewhere. This is quite helpful, even if it doesn't happen all that frequently. Many people are afraid of pointers, because &ldquo;They can corrupt memory!&rdquo;, &ldquo;They can overwrite some data&rdquo; and so on. These concerns are legitimate but there're many ways to minimize the risks, and we'll introduce many of these in the future. Furthermore, if you operate in a safe environment such a debugger, there are even more safety nets already written for you, so you can find and fix all the potential errors during the development. 

</p><p>

<em class="underscore">(Back to subsection  <a href="#toc1.4">1.4</a>)</em>

</p>
<a class="target" name="navigation">&nbsp;</a><a class="target" name="navigation">&nbsp;</a><a class="target" name="toc6">&nbsp;</a><h1>Navigation</h1>
<p>


Previous: <a href="../html/day11.html">Day 11. The Basics of Platform API Design</a>

</p><p>

<a href="../index.md.html">Back to Index</a>

</p>
<div class="nonumberh1">Glossary </div>
<p>


<ul>
<li class="asterisk">Buffer overrun</li></ul>

</p>
<div class="nonumberh1">References </div>

<div class="nonumberh1">C Standard Library</div>
<p>


<a href="https://www.cplusplus.com/reference/cstring/memset/">memset</a>

</p>
<div class="nonumberh1">MSDN</div>
<p>










































<style class="fallback">
  body {
    visibility: hidden;
    font-family: sans-serif;
  }
</style>

</p><p>

<script>
  markdeepOptions = { tocStyle: 'long' };
  window.alreadyProcessedMarkdeep ||
    (document.body.style.visibility = 'visible');
</script>
</math.h></windows.h></dsound.h></xinput.h></stdio.h></stdint.h></math.h></p></span><div id="mdContextMenu" style="visibility:hidden"></div><div class="markdeepFooter"><i>formatted by <a href="https://casual-effects.com/markdeep" style="color:#999">Markdeep&nbsp;1.10&nbsp;&nbsp;</a></i><div style="display:inline-block;font-size:13px;font-family:'Times New Roman',serif;vertical-align:middle;transform:translate(-3px,-1px)rotate(135deg);">&#x2712;</div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>