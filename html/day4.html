<meta charset="UTF-8"><meta http-equiv="content-type" content="text/html;charset=UTF-8"><meta name="viewport" content="width=600, initial-scale=1"><style>span.md {width: 800;display: inline-block;}body{max-width:680px;margin:auto;padding:20px;text-align:justify;line-height:140%; -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-smoothing:antialiased;color:#222;font-family:Palatino,Georgia,"Times New Roman",serif}</style><style>@media print{*{-webkit-print-color-adjust:exact;text-shadow:none !important}}body{counter-reset: h1 h2 h3 h4 h5 h6 paragraph}@page{margin:0;size:auto}#mdContextMenu{position:absolute;background:#383838;cursor:default;border:1px solid #999;color:#fff;padding:4px 0px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,"Helvetica Neue",sans-serif;font-size:85%;font-weight:600;border-radius:4px;box-shadow:0px 3px 10px rgba(0,0,0,35%)}#mdContextMenu div{padding:0px 20px}#mdContextMenu div:hover{background:#1659d1}.md code,.md pre{font-family:Menlo,Consolas,monospace;font-size:98%;text-align:left;line-height:140%}.md .mediumToc code,.md longToc code,.md .shortToc code,.md h1 code,.md h2 code,.md h3 code,.md h4 code,.md h5 code,.md h6 code{font-size:unset}.md div.title{font-size:26px;font-weight:800;line-height:120%;text-align:center}.md div.afterTitles{height:10px}.md div.subtitle{text-align:center}.md iframe.textinsert, .md object.textinsert,.md iframe:not(.markdeep){display:block;margin-top:10px;margin-bottom:10px;width:100%;height:75vh;border:1px solid #000;border-radius:4px;background:#f5f5f4}.md .image{display:inline-block}.md img{max-width:100%;page-break-inside:avoid}.md li{text-align:left;text-indent:0}.md pre.listing {width:100%;tab-size:4;-moz-tab-size:4;-o-tab-size:4;counter-reset:line;overflow-x:auto;resize:horizontal}.md pre.listing .linenumbers span.line:before{width:30px;margin-left:-28px;font-size:80%;text-align:right;counter-increment:line;content:counter(line);display:inline-block;padding-right:13px;margin-right:8px;color:#ccc}.md div.tilde{margin:20px 0 -10px;text-align:center}.md .imagecaption,.md .tablecaption,.md .listingcaption{display:inline-block;margin:7px 5px 12px;text-align:justify;font-style:italic}.md img.pixel{image-rendering:-moz-crisp-edges;image-rendering:pixelated}.md blockquote.fancyquote{margin:25px 0 25px;text-align:left;line-height:160%}.md blockquote.fancyquote::before{content:"“";color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-right:6px;vertical-align:-0.3em}.md span.fancyquote{font-size:118%;color:#777;font-style:italic}.md span.fancyquote::after{content:"”";font-style:normal;color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-left:6px;vertical-align:-0.3em}.md blockquote.fancyquote .author{width:100%;margin-top:10px;display:inline-block;text-align:right}.md small{font-size:60%}.md big{font-size:150%}.md div.title,contents,.md .tocHeader,.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .shortTOC,.md .mediumTOC,.nonumberh1,.nonumberh2,.nonumberh3,.nonumberh4,.nonumberh5,.nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;margin:13.4px 0 13.4px;padding:15px 0 3px;border-top:none;clear:both}.md .tocTop {display:none}.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .nonumberh1,.md .nonumberh2,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{page-break-after:avoid;break-after:avoid}.md svg.diagram{display:block;font-family:Menlo,Consolas,monospace;font-size:98%;text-align:center;stroke-linecap:round;stroke-width:2px;page-break-inside:avoid;stroke:#000;fill:#000}.md svg.diagram .opendot{fill:#fff}.md svg.diagram .shadeddot{fill:#CCC}.md svg.diagram .dotteddot{stroke:#000;stroke-dasharray:4;fill:none}.md svg.diagram text{stroke:none}@media print{@page{margin:1in 5mm;transform: scale(150%)}}@media print{.md .pagebreak{page-break-after:always;visibility:hidden}}.md a{font-family:Georgia,Palatino,'Times New Roman'}.md h1,.md .tocHeader,.md .nonumberh1{border-bottom:3px solid;font-size:20px;font-weight:bold;}.md h1,.md .nonumberh1{counter-reset: h2 h3 h4 h5 h6}.md h2,.md .nonumberh2{counter-reset: h3 h4 h5 h6;border-bottom:2px solid #999;color:#555;font-weight:bold;font-size:18px;}.md h3,.md h4,.md h5,.md h6,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;color:#555;font-size:16px;}.md h3{counter-reset:h4 h5 h6}.md h4{counter-reset:h5 h6}.md h5{counter-reset:h6}.md div.table{margin:16px 0 16px 0}.md table{border-collapse:collapse;line-height:140%;page-break-inside:avoid}.md table.table{margin:auto}.md table.calendar{width:100%;margin:auto;font-size:11px;font-family:Verdana,Helvetica,Arial,sans-serif}.md table.calendar th{font-size:16px}.md .today{background:#ECF8FA}.md .calendar .parenthesized{color:#999;font-style:italic}.md table.table th{color:#FFF;background-color:#AAA;border:1px solid #888;padding:8px 15px 8px 15px}.md table.table td{padding:5px 15px 5px 15px;border:1px solid #888}.md table.table tr:nth-child(even){background:#EEE}.md pre.tilde{border-top: 1px solid #CCC;border-bottom: 1px solid #CCC;padding: 5px 0 5px 20px;margin:0 0 0 0;background:#FCFCFC;page-break-inside:avoid}.md a.target{width:0px;height:0px;visibility:hidden;font-size:0px;display:inline-block}.md a:link, .md a:visited{color:#38A;text-decoration:none}.md a:link:hover{text-decoration:underline}.md dt{font-weight:700}.md dl>dd{margin-top:-8px; margin-bottom:8px}.md dl>table{margin:35px 0 30px}.md code{page-break-inside:avoid;} @media print{.md .listing code{white-space:pre-wrap}}.md .endnote{font-size:13px;line-height:15px;padding-left:10px;text-indent:-10px}.md .bib{padding-left:80px;text-indent:-80px;text-align:left}.markdeepFooter{font-size:9px;text-align:right;padding-top:80px;color:#999}.md .mediumTOC{float:right;font-size:12px;line-height:15px;border-left:1px solid #CCC;padding-left:15px;margin:15px 0px 15px 25px}.md .mediumTOC .level1{font-weight:600}.md .longTOC .level1{font-weight:600;display:block;padding-top:12px;margin:0 0 -20px}.md .shortTOC{text-align:center;font-weight:bold;margin-top:15px;font-size:14px}.md .admonition{position:relative;margin:1em 0;padding:.4rem 1rem;border-radius:.2rem;border-left:2.5rem solid rgba(68,138,255,.4);background-color:rgba(68,138,255,.15);}.md .admonition-title{font-weight:bold;border-bottom:solid 1px rgba(68,138,255,.4);padding-bottom:4px;margin-bottom:4px;margin-left: -1rem;padding-left:1rem;margin-right:-1rem;border-color:rgba(68,138,255,.4)}.md .admonition.tip{border-left:2.5rem solid rgba(50,255,90,.4);background-color:rgba(50,255,90,.15)}.md .admonition.tip::before{content:"\24d8";font-weight:bold;font-size:150%;position:relative;top:3px;color:rgba(26,128,46,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.tip>.admonition-title{border-color:rgba(50,255,90,.4)}.md .admonition.warn,.md .admonition.warning{border-left:2.5rem solid rgba(255,145,0,.4);background-color:rgba(255,145,0,.15)}.md .admonition.warn::before,.md .admonition.warning::before{content:"\26A0";font-weight:bold;font-size:150%;position:relative;top:2px;color:rgba(128,73,0,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.warn>.admonition-title,.md .admonition.warning>.admonition-title{border-color:rgba(255,145,0,.4)}.md .admonition.error{border-left: 2.5rem solid rgba(255,23,68,.4);background-color:rgba(255,23,68,.15)}.md .admonition.error>.admonition-title{border-color:rgba(255,23,68,.4)}.md .admonition.error::before{content: "\2612";font-family:"Arial";font-size:200%;position:relative;color:rgba(128,12,34,.8);top:-2px;left:-3rem;display:block;width:0;height:0}.md .admonition p:last-child{margin-bottom:0}.md li.checked,.md li.unchecked{list-style:none;overflow:visible;text-indent:-1.2em}.md li.checked:before,.md li.unchecked:before{content:"\2611";display:block;float:left;width:1em;font-size:120%}.md li.unchecked:before{content:"\2610"}</style><style>.md h1::before {
content:counter(h1) " ";
counter-increment: h1;margin-right:10px}.md h2::before {
content:counter(h1) "."counter(h2) " ";
counter-increment: h2;margin-right:10px}.md h3::before {
content:counter(h1) "."counter(h2) "."counter(h3) " ";
counter-increment: h3;margin-right:10px}.md h4::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) " ";
counter-increment: h4;margin-right:10px}.md h5::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) " ";
counter-increment: h5;margin-right:10px}.md h6::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) "."counter(h6) " ";
counter-increment: h6;margin-right:10px}</style><style>.hljs{display:block;overflow-x:auto;padding:0.5em;background:#fff;color:#000;-webkit-text-size-adjust:none}.hljs-comment{color:#006a00}.hljs-keyword{color:#02E}.hljs-literal,.nginx .hljs-title{color:#aa0d91}.method,.hljs-list .hljs-title,.hljs-tag .hljs-title,.setting .hljs-value,.hljs-winutils,.tex .hljs-command,.http .hljs-title,.hljs-request,.hljs-status,.hljs-name{color:#008}.hljs-envvar,.tex .hljs-special{color:#660}.hljs-string{color:#c41a16}.hljs-tag .hljs-value,.hljs-cdata,.hljs-filter .hljs-argument,.hljs-attr_selector,.apache .hljs-cbracket,.hljs-date,.hljs-regexp{color:#080}.hljs-sub .hljs-identifier,.hljs-pi,.hljs-tag,.hljs-tag .hljs-keyword,.hljs-decorator,.ini .hljs-title,.hljs-shebang,.hljs-prompt,.hljs-hexcolor,.hljs-rule .hljs-value,.hljs-symbol,.hljs-symbol .hljs-string,.hljs-number,.css .hljs-function,.hljs-function .hljs-title,.coffeescript .hljs-attribute{color:#A0C}.hljs-function .hljs-title{font-weight:bold;color:#000}.hljs-class .hljs-title,.smalltalk .hljs-class,.hljs-type,.hljs-typename,.hljs-tag .hljs-attribute,.hljs-doctype,.hljs-class .hljs-id,.hljs-built_in,.setting,.hljs-params,.clojure .hljs-attribute{color:#5c2699}.hljs-variable{color:#3f6e74}.css .hljs-tag,.hljs-rule .hljs-property,.hljs-pseudo,.hljs-subst{color:#000}.css .hljs-class,.css .hljs-id{color:#9b703f}.hljs-value .hljs-important{color:#ff7700;font-weight:bold}.hljs-rule .hljs-keyword{color:#c5af75}.hljs-annotation,.apache .hljs-sqbracket,.nginx .hljs-built_in{color:#9b859d}.hljs-preprocessor,.hljs-preprocessor *,.hljs-pragma{color:#643820}.tex .hljs-formula{background-color:#eee;font-style:italic}.diff .hljs-header,.hljs-chunk{color:#808080;font-weight:bold}.diff .hljs-change{background-color:#bccff9}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-comment .hljs-doctag{font-weight:bold}.method .hljs-id{color:#000}</style><style>div.title { padding-top: 40px; } div.afterTitles { height: 15px; }</style><meta charset="utf-8">
<link rel="stylesheet" href="../css/style.css">

<script type="text/x-mathjax-config">MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });</script><span style="display:none">$$\newcommand{\n}{\hat{n}}\newcommand{\thetai}{\theta_\mathrm{i}}\newcommand{\thetao}{\theta_\mathrm{o}}\newcommand{\d}[1]{\mathrm{d}#1}\newcommand{\w}{\hat{\omega}}\newcommand{\wi}{\w_\mathrm{i}}\newcommand{\wo}{\w_\mathrm{o}}\newcommand{\wh}{\w_\mathrm{h}}\newcommand{\Li}{L_\mathrm{i}}\newcommand{\Lo}{L_\mathrm{o}}\newcommand{\Le}{L_\mathrm{e}}\newcommand{\Lr}{L_\mathrm{r}}\newcommand{\Lt}{L_\mathrm{t}}\newcommand{\O}{\mathrm{O}}\newcommand{\degrees}{{^{\large\circ}}}\newcommand{\T}{\mathsf{T}}\newcommand{\mathset}[1]{\mathbb{#1}}\newcommand{\Real}{\mathset{R}}\newcommand{\Integer}{\mathset{Z}}\newcommand{\Boolean}{\mathset{B}}\newcommand{\Complex}{\mathset{C}}\newcommand{\un}[1]{\,\mathrm{#1}}$$
</span>
<span class="md"><p><title>Day 4. Animating the Back Buffer</title><div class="title"> Day 4. Animating the Back Buffer </div>

<div class="afterTitles"></div>
<em class="underscore">Video Length: <a href="https://hero.handmade.network/episode/code/day004/">1h02</a> (before Q&A)</em>

</p><p>

Welcome to Day 4 of &ldquo;Handmade Hero Notes&rdquo;, the book where we follow the footsteps of <a href="https://handmadehero.org/">Handmade Hero</a> in making the complete game from scratch, with no external libraries. If you'd like to follow along, preorder the game on <a href="https://handmadehero.org/">handmadehero.org</a>, and you will receive access to the GitHub repository, containing complete source code (tagged day-by-day) as well as a variety of other useful resources.

</p><p>

Last time, we started laying out the ground work for our back buffer, a place to which we will render our game. In a few words, we drafted two functions: <code>Win32ResizeDIBSection</code> and <code>Win32UpdateWindow</code>. We use the first one when processing <code>WM_SIZE</code> window message, and the other when processing <code>WM_PAINT</code>.

</p><p>

Now, we shall finish the back buffer setup and do a simple animation to it.

</p>
<div class="longTOC">
    <p align="center">
        <span align="left"><a href="day3.html">Day 3</a></span>
        <a href="../index.html"><img src = "../media/logo.png"></a>
        <span align="right"><a href="day5.html">Day 5</a></span>
    </p><p><a href="#" class="tocTop">(Top)</a><br/>
<a href="#reviewandsimplifybuffer-relatedfunctions" class="level1"><span class="tocNumber">1&nbsp; </span>Review and Simplify Buffer-related Functions</a><br/>
<a href="#ourcustombitmapmemoryallocator" class="level1"><span class="tocNumber">2&nbsp; </span>Our Custom Bitmap Memory Allocator</a><br/>
&nbsp;&nbsp;<a href="#ourcustombitmapmemoryallocator/allocatethebitmapmemory" class="level2"><span class="tocNumber">2.1&nbsp; </span>Allocate the Bitmap Memory</a><br/>
&nbsp;&nbsp;<a href="#ourcustombitmapmemoryallocator/cleanup" class="level2"><span class="tocNumber">2.2&nbsp; </span>Cleanup</a><br/>
&nbsp;&nbsp;<a href="#ourcustombitmapmemoryallocator/forfuturereference:changememoryprotection" class="level2"><span class="tocNumber">2.3&nbsp; </span>For Future Reference: Change Memory Protection</a><br/>
&nbsp;&nbsp;<a href="#ourcustombitmapmemoryallocator/compileandtest" class="level2"><span class="tocNumber">2.4&nbsp; </span>Compile and Test</a><br/>
<a href="#revisitwin32updatewindow" class="level1"><span class="tocNumber">3&nbsp; </span>Revisit <code>Win32UpdateWindow</code></a><br/>
&nbsp;&nbsp;<a href="#revisitwin32updatewindow/updatestretchdibits" class="level2"><span class="tocNumber">3.1&nbsp; </span>Update <code>StretchDIBits</code></a><br/>
&nbsp;&nbsp;<a href="#revisitwin32updatewindow/propagatethechangesoutside" class="level2"><span class="tocNumber">3.2&nbsp; </span>Propagate the Changes Outside</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#revisitwin32updatewindow/propagatethechangesoutside/bitmapwidthandheight" class="level3"><span class="tocNumber">3.2.1&nbsp; </span>Bitmap Width and Height</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#revisitwin32updatewindow/propagatethechangesoutside/windowwidthandheight" class="level3"><span class="tocNumber">3.2.2&nbsp; </span>Window Width and Height</a><br/>
<a href="#drawpixelstothebitmap" class="level1"><span class="tocNumber">4&nbsp; </span>Draw Pixels to the Bitmap</a><br/>
&nbsp;&nbsp;<a href="#drawpixelstothebitmap/understandthereadorderofthestretchdibits" class="level2"><span class="tocNumber">4.1&nbsp; </span>Understand the Read Order of the StretchDIBits</a><br/>
&nbsp;&nbsp;<a href="#drawpixelstothebitmap/startpixelloop" class="level2"><span class="tocNumber">4.2&nbsp; </span>Start Pixel Loop</a><br/>
&nbsp;&nbsp;<a href="#drawpixelstothebitmap/setupbasictypes" class="level2"><span class="tocNumber">4.3&nbsp; </span>Set Up Basic Types</a><br/>
&nbsp;&nbsp;<a href="#drawpixelstothebitmap/calculaterowandpixelpositions" class="level2"><span class="tocNumber">4.4&nbsp; </span>Calculate Row and Pixel positions</a><br/>
&nbsp;&nbsp;<a href="#drawpixelstothebitmap/pixelcomponentlayoutinmemory" class="level2"><span class="tocNumber">4.5&nbsp; </span>Pixel Component Layout in Memory</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#drawpixelstothebitmap/pixelcomponentlayoutinmemory/possiblearrangmentsinmemory" class="level3"><span class="tocNumber">4.5.1&nbsp; </span>Possible Arrangments in Memory</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#drawpixelstothebitmap/pixelcomponentlayoutinmemory/trytosetredchannel" class="level3"><span class="tocNumber">4.5.2&nbsp; </span>Try to Set Red Channel</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#drawpixelstothebitmap/pixelcomponentlayoutinmemory/correctthestructuredart" class="level3"><span class="tocNumber">4.5.3&nbsp; </span>Correct the Structured Art</a><br/>
&nbsp;&nbsp;<a href="#drawpixelstothebitmap/drawcolorsbasedonpixelposition" class="level2"><span class="tocNumber">4.6&nbsp; </span>Draw Colors Based on Pixel Position</a><br/>
<a href="#renderingapattern" class="level1"><span class="tocNumber">5&nbsp; </span>Rendering a Pattern</a><br/>
&nbsp;&nbsp;<a href="#renderingapattern/introducerenderweirdgradient" class="level2"><span class="tocNumber">5.1&nbsp; </span>Introduce <code>RenderWeirdGradient</code></a><br/>
&nbsp;&nbsp;<a href="#renderingapattern/preparethemainwindowloopforcontinuousanimation" class="level2"><span class="tocNumber">5.2&nbsp; </span>Prepare the Main Window Loop for Continuous Animation</a><br/>
&nbsp;&nbsp;<a href="#renderingapattern/ourfirstanimation" class="level2"><span class="tocNumber">5.3&nbsp; </span>Our First Animation</a><br/>
&nbsp;&nbsp;<a href="#renderingapattern/recompresspixelto32-bitvalue" class="level2"><span class="tocNumber">5.4&nbsp; </span>Recompress Pixel to 32-bit Value</a><br/>
<a href="#recap" class="level1"><span class="tocNumber">6&nbsp; </span>Recap</a><br/>
<a href="#exercises" class="level1"><span class="tocNumber">7&nbsp; </span>Exercises</a><br/>
&nbsp;&nbsp;<a href="#exercises/drawotherweirdgradients" class="level2"><span class="tocNumber">7.1&nbsp; </span>Draw Other Weird Gradients</a><br/>
<a href="#programmingbasics" class="level1"><span class="tocNumber">8&nbsp; </span>Programming Basics</a><br/>
&nbsp;&nbsp;<a href="#programmingbasics/virtualmemoryvs.physicalmemory" class="level2"><span class="tocNumber">8.1&nbsp; </span>Virtual Memory vs. Physical Memory</a><br/>
&nbsp;&nbsp;<a href="#programmingbasics/typecasting" class="level2"><span class="tocNumber">8.2&nbsp; </span>Type Casting</a><br/>
&nbsp;&nbsp;<a href="#programmingbasics/hexadecimal" class="level2"><span class="tocNumber">8.3&nbsp; </span>Hexadecimal</a><br/>
&nbsp;&nbsp;<a href="#programmingbasics/pre-incrementandpost-incrementoperator" class="level2"><span class="tocNumber">8.4&nbsp; </span>Pre-increment and Post-increment operator</a><br/>
<a href="#sideconsiderations" class="level1"><span class="tocNumber">9&nbsp; </span>Side Considerations</a><br/>
&nbsp;&nbsp;<a href="#sideconsiderations/build.bat:requestmsvctogivefullpaths" class="level2"><span class="tocNumber">9.1&nbsp; </span><code>build.bat</code>: Request MSVC to Give Full Paths</a><br/>
&nbsp;&nbsp;<a href="#sideconsiderations/introductiontoalignment" class="level2"><span class="tocNumber">9.2&nbsp; </span>Introduction to Alignment</a><br/>
&nbsp;&nbsp;<a href="#sideconsiderations/raii" class="level2"><span class="tocNumber">9.3&nbsp; </span>RAII</a><br/>
&nbsp;&nbsp;<a href="#sideconsiderations/bitblit" class="level2"><span class="tocNumber">9.4&nbsp; </span>Bit Blit</a><br/>
<a href="#navigation" class="level1"><span class="tocNumber">10&nbsp; </span>Navigation</a><br/>
</p></div><a class="target" name="reviewandsimplifybuffer-relatedfunctions">&nbsp;</a><a class="target" name="reviewandsimplifybuffer-relatedfunctions">&nbsp;</a><a class="target" name="toc1">&nbsp;</a><h1>Review and Simplify Buffer-related Functions</h1>
<p>


Before we get going, let's look back at the two functions we defined last time. We went a bit fast with implementing our plan, so there might be something we missed along the way.

</p><p>

<ul>
<li class="asterisk"><code>Win32ResizeDIBSection</code> would serve to initialize and, if necessary, to resize the buffer.
<ul>
    <li class="asterisk">This function would take a width and a height of our client area rectangle.
</li>
    <li class="asterisk">Instead of returning anything, we work with the global variables representing a bitmap device context, a bitmap handle, bitmap info and a pointer to the actual bitmap memory. 
<ul>
        <li class="asterisk">You could also imagine these as some additional pointers passed to our function.
</li></ul>
    <li class="asterisk">At its core, we use a couple of Windows calls:
<ul>
        <li class="asterisk"><a href="https://docs.microsoft.com/en-us/windows/win32/api/wingdi/nf-wingdi-createcompatibledc">CreateCompatibleDC</a> to initialize the bitmap device context.
</li>
        <li class="asterisk">Bitmap info is filled out by us using some constant values that we won't change unless the size changes.
</li>
        <li class="asterisk"><a href="https://docs.microsoft.com/en-us/windows/win32/api/wingdi/nf-wingdi-createdibsection">CreateDIBSection</a> used to initialize the bitmap memory.
</li></ul>
</li></ul>
<li class="asterisk">Inside <code>Win32UpdateWindow</code>, we would store the device context to copy pixels from the bitmap memory to the window.
<ul>
    <li class="asterisk">This function would take the coordinates of our client area rectangle, and a device context.
</li>
    <li class="asterisk">As of now, it would only pass these to the <a href="https://docs.microsoft.com/en-us/windows/win32/api/wingdi/nf-wingdi-stretchdibits">StretchDIBits</a> function from Windows.</li></ul></li></ul>

</p><p>

There's a bit more to it than meets the eye.

</p><p>

Windows is an old platform. Over years, various tools were created to solve similar problems. One of these problems was outputting a bitmap image to screen or, taken more broadly, from one bitmap to another. Remember that, for the operating system, there's no major difference drawing to your window, a .bmp image file or the whole screen! The process which oversees it is generally called <em class="underscore">bit blit</em>. 

</p><p>

<div class="admonition ">If you'd like to experiment a bit with <code>BitBlt</code>, head out to subsection  <a href="#toc9.4">9.4</a>.</div>

</p><p>

Since we're displaying our bitmap on screen using <code>StretchDIBits</code>, we can make a number of simplifications:

</p><p>

<ul>
<li class="asterisk">We don't need a bitmap handle or bitmap DC, these can go away. 
</li>
<li class="asterisk">We don't even need a DIB section! Bitmap Memory can be allocated directly by us.
<ul>
    <li class="asterisk">Yeah, it's actually a simplification. We have all the control that we want over this allocation process. 
</li>
    <li class="asterisk">As long as it's right size, Windows will accept this memory with no issues.</li></ul></li></ul>

</p><p>

This results in a following refactoring from the get-go:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-comment">//...</span></span>
<span class="line">global_variable BITMAPINFO BitmapInfo;</span>
<span class="line">global_variable <span class="hljs-keyword">void</span> *BitmapMemory;</span><div class=" delete"><span class="line">global_variable HBITMAP BitmapHandle;</span>
<span class="line">global_variable HDC BitmapDeviceContext;</span></div><span class="line"></span>
<span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">Win32ResizeDIBSection</span><span class="hljs-params">(<span class="hljs-keyword">int</span> Width, <span class="hljs-keyword">int</span> Height)</span> </span>
<span class="line"></span>{</span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">    BitmapInfo.bmiHeader.biCompression = BI_RGB;</span><div class=" delete"><span class="line">    <span class="hljs-keyword">if</span>(BitmapHandle)</span>
<span class="line">    {</span>
<span class="line">        DeleteObject(BitmapHandle);</span>
<span class="line">    } </span>
<span class="line">    </span>
<span class="line">    <span class="hljs-keyword">if</span>(!BitmapDeviceContext)</span>
<span class="line">    {</span>
<span class="line">        BitmapDeviceContext = CreateCompatibleDC(<span class="hljs-number">0</span>);</span>
<span class="line">    }</span>
<span class="line">    BitmapHandle = CreateDIBSection(BitmapDeviceContext,</span>
<span class="line">                                    &amp;BitmapInfo,</span>
<span class="line">                                    DIB_RGB_COLORS,</span>
<span class="line">                                    &amp;BitmapMemory,</span>
<span class="line">                                    <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);</span></div><div class=" add"><span class="line">    BitmapMemory = ; <span class="hljs-comment">// TODO allocation</span></span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;1:</b> <file>[win32_handmade.cpp]</file> Simplifying <code>Win32ResizeDIBSection</code>. That's a lot of removed lines!</div></center>

<a class="target" name="ourcustombitmapmemoryallocator">&nbsp;</a><a class="target" name="ourcustombitmapmemoryallocator">&nbsp;</a><a class="target" name="toc2">&nbsp;</a><h1>Our Custom Bitmap Memory Allocator</h1>
<p>


In the code above, we left a stub for the <code>BitmapMemory</code> allocation. Let's actually write a custom memory allocator that would give us the memory we need!

</p>
<a class="target" name="allocatethebitmapmemory">&nbsp;</a><a class="target" name="ourcustombitmapmemoryallocator/allocatethebitmapmemory">&nbsp;</a><a class="target" name="toc2.1">&nbsp;</a><h2>Allocate the Bitmap Memory</h2>
<p>


We now have everything in place to determine the amount of the memory we will need for our buffer. 

</p><p>

<ul>
<li class="asterisk">Each pixel should be 4 bytes wide. 
<ul>
    <li class="asterisk">Why do we need 4 if we only need 3 bytes to store RGB values? You can find our considerations in subsection  <a href="#toc9.2">9.2</a>.
</li></ul>
<li class="asterisk">We need <code>Width</code> amount of pixels for each row.
</li>
<li class="asterisk">We need <code>Height</code> amount of rows to form the full picture.</li></ul>

</p><p>

In other words, we are calculating the area of the rectangle \(A = x \cdot\ y\). This gives us the total amount of pixels, and by multiplying by 4 (which is our Bytes per Pixel), we get the final <em class="underscore">Bitmap Memory Size</em>, i.e. \(A = 4x \cdot\ y\). 

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-keyword">int</span> BytesPerPixel = <span class="hljs-number">4</span>;</span>
<span class="line"><span class="hljs-keyword">int</span> BitmapMemorySize = BytesPerPixel * Width * Height;</span></div><span class="line">BitmapMemory = ; <span class="hljs-comment">// TODO allocation</span></span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;2:</b> <file>[win32_handmade.cpp > Win32ResizeDIBSection]</file> Calculating buffer size.</div></center>
<p>


As you can imagine, in Windows there are several ways of allocating some memory. We have seen <code>CreateDIBSection</code> already but its quite specific in its use. The general-purpose allocators include CRT's <code>malloc</code>, C++ <code>new</code> and several others Windows-specific calls. You can find an overview <a href="https://docs.microsoft.com/en-us/windows/win32/memory/comparing-memory-allocation-methods">here</a>.

</p><p>

We could use <a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc">VirtualAlloc</a> or <a href="https://docs.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapalloc">HeapAlloc</a>: 

</p><p>

<ul>
<li class="asterisk"><code>VirtualAlloc</code> is the lowest level function available in Windows API, it allocates <em class="underscore">pages</em> of memory at a time and clears them to <code>0</code>. 
</li>
<li class="asterisk"><code>HeapAlloc</code> is a higher-level function. It allows for sub-allocating smaller amounts of memory from a system page or calls <code>VirtualAlloc</code> when the amount requested is significant.</li></ul>

</p><p>

<div class="admonition note"><div class="admonition-title"> Memory Pages</div>

</p><p>

    Many operating systems, including Windows, subdivide available memory in regions known as &ldquo;pages&rdquo;. These are the regions of at least 4KiB (4096 bytes), sometimes they can be 64KiB (a.k.a. <code>LARGE_PAGE</code>)... Page sizes vary. Overall it's a handy way of thinking about the memory since, if transfer between hard disk and the main memory is required, it will happen in these Pages.

</p><p>

    For more information about Pages on Windows, check out <a href="https://docs.microsoft.com/en-us/windows/win32/memory/working-with-pages">this article</a>.</div>

</p><p>

We will be doing most of the memory allocation and management ourselves, so for asking memory from the system <code>VirtualAlloc</code> would do perfectly. It's a nice handy function that's pretty simple to use. 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">LPVOID <span class="hljs-title">VirtualAlloc</span><span class="hljs-params">(</span>
<span class="line">  LPVOID lpAddress,</span>
<span class="line">  SIZE_T dwSize,</span>
<span class="line">  DWORD  flAllocationType,</span>
<span class="line">  DWORD  flProtect</span>
<span class="line">)</span></span>;</span></code></pre><center><div class="listingcaption tilde"><file>[MSDN]</file> VirtualAlloc Syntax.</div></center>
<p>


As you can see, it returns a simple <code>void *</code> (we've seen what void pointers are <a href="day3.html#implementlogic/createdibsectionimplementation">last time</a>). This pointer represents the base of the newly allocated memory, and its parameters are:

</p><p>

<ul>
<li class="asterisk"><code>lpAddress</code>: The starting address inside the the Virtual Address Space. We don't care where our buffer memory will reside so we'll leave it at <code>0</code>.
</li>
<li class="asterisk"><code>dwSize</code>: The size of the region to allocate in bytes. Since <code>VirtualAlloc</code> only returns full pages, this size will be rounded up to the next page boundary (which is perfect for us). This is where we pass our <code>BitmapMemorySize</code>.
</li>
<li class="asterisk"><code>flAllocationType</code>: a <em class="underscore">bit field</em> telling Windows the action we want to take. You can find the various possible values on <a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc">MSDN</a>. We're interested in the two top ones, chaining them as usual: <code>MEM_RESERVE | MEM_COMMIT</code>.
<ul>
    <li class="asterisk"><code>MEM_COMMIT</code> actually requests the memory to become available right now.
</li>
    <li class="asterisk"><code>MEM_RESERVE</code> lets the OS know that we will eventually make use of a specific amount of memory. Windows requires us to reserve the memory before using it, so we must specify it as well.
</li></ul>
<li class="asterisk"><code>flProtect</code>: another bit field specifying the &ldquo;access priviliges&rdquo;. You can find them <a href="https://docs.microsoft.com/en-us/windows/win32/memory/memory-protection-constants">here</a>. We only want to use the memory as a data bank, so <code>PAGE_READWRITE</code> is sufficient for our purposes.</li></ul>

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">int</span> BytesPerPixel = <span class="hljs-number">4</span>;</span>
<span class="line"><span class="hljs-keyword">int</span> BitmapMemorySize = BytesPerPixel * Width * Height;</span><div class=" edit"><span class="line">BitmapMemory = VirtualAlloc(<span class="hljs-number">0</span>, BitmapMemorySize, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE); </span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;3:</b> <file>[win32_handmade.cpp > Win32ResizeDIBSection]</file> Allocating Bitmap Memory.</div></center>
<p>


What does it all mean in practice? If we have a significant <code>Memory</code> returned (non-zero), it means we can access any location within the <code>dwSize</code> we provided, as well as read and write data to it. So we can access the location <code>Memory</code>, <code>Memory + 1</code>, <code>Memory + dwSize</code>... and even a bit more (but you shouldn't count on it!), but we can't access the memory <code>Memory - 1</code> as it's outside of the &ldquo;authorized&rdquo; boundaries.

</p><p>

<div class="admonition tip"><code>VirtualAlloc</code> has <code>Virtual</code> in it because we're reserving <em class="underscore">virtual</em> memory. If you're unfamiliar with the concept of virtual memory, read more in the <a href="#virtualmemoryvs.physicalmemory">Virtual Memory vs. Physical Memory</a> subsection.</div>

</p>
<a class="target" name="cleanup">&nbsp;</a><a class="target" name="ourcustombitmapmemoryallocator/cleanup">&nbsp;</a><a class="target" name="toc2.2">&nbsp;</a><h2>Cleanup</h2>
<p>


Now, if you remember, we had a cleanup stage at the beginning of our function which prevented us from requesting more and more memory each time we entered <code>Win32ResizeDIBSection</code>. We removed it because we no longer made use of neither <code>BITMAPHANDLE</code> nor the related objects. Now, however, we need a similar device to free our memory each time before reserving some new one. Which function to use? 

</p><p>

MSDN comes to the rescue! If you look at the <a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc">VirtualAlloc</a> page, you will see a &ldquo;See also&rdquo; section. In there, you can find a number of useful related articles, including one called <a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualfree">VirtualFree</a>:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">BOOL <span class="hljs-title">VirtualFree</span><span class="hljs-params">(</span>
<span class="line">  LPVOID lpAddress,</span>
<span class="line">  SIZE_T dwSize,</span>
<span class="line">  DWORD  dwFreeType</span>
<span class="line">)</span></span>;</span></code></pre><center><div class="listingcaption tilde"><file>[MSDN]</file> VirtualFree Syntax.</div></center>
<p>


You can also find a reference to this function inside the &ldquo;Remarks&rdquo; section. This is exactly what we need. <code>VirtualFree</code> returns a non-zero value if it succeeds. As for its parameters, for our purposes it's even simpler: 

</p><p>

<ul>
<li class="asterisk"><code>lpAddress</code>: The pointer to the &ldquo;base&rdquo; of our memory (that we received from <code>VirtualAlloc</code>).
</li>
<li class="asterisk"><code>dwSize</code>: Size of memory to be freed. Usually this would require us to keep track of the memory we allocated, but since we want to release that memory in its entirety, we must pass <code>0</code> to it instead.
</li>
<li class="asterisk"><code>dwFreeType</code>: Operation requested. We want to get rid of the entire &ldquo;package&rdquo; of pages provided by <code>VirtualAlloc</code> and to make them available for Windows to use. The constant we are after is <code>MEM_RELEASE</code> that does just that.
<ul>
    <li class="asterisk">The other constant showcased is <code>MEM_DECOMMIT</code>. While this is not something we are interested in right now, it's a useful operation which removes access from a memory block while retaining its reserved state. In other words, Windows will be aware that we might require this amount of memory in the future.</li></ul></li></ul>

</p><p>

We will call <code>VirtualFree</code> at the beginning of <code>Win32ResizeDIBSection</code>, provided that we have a valid (non-zero) <code>BitmapMemory</code> pointer.

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-keyword">if</span> (BitmapMemory) <span class="hljs-comment">// Same as writing (BitmapMemory != 0) or (BitmapMemory != NULL)</span></span>
<span class="line">{</span>
<span class="line">    VirtualFree(BitmapMemory, <span class="hljs-number">0</span>, MEM_RELEASE);</span>
<span class="line">    <span class="hljs-comment">// Optionally, you can check if the result of VirtualFree is not zero.</span></span>
<span class="line">    <span class="hljs-comment">// Print out an error message if it is.</span></span>
<span class="line">}</span></div><span class="line"><span class="hljs-keyword">int</span> BytesPerPixel = <span class="hljs-number">4</span>;</span>
<span class="line"><span class="hljs-keyword">int</span> BitmapMemorySize = BytesPerPixel * Width * Height;</span>
<span class="line">BitmapMemory = VirtualAlloc(<span class="hljs-number">0</span>, BitmapMemorySize, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE); </span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;4:</b> <file>[win32_handmade.cpp > Win32ResizeDIBSection]</file> Allocating Bitmap Memory.</div></center>

<a class="target" name="forfuturereference:changememoryprotection">&nbsp;</a><a class="target" name="ourcustombitmapmemoryallocator/forfuturereference:changememoryprotection">&nbsp;</a><a class="target" name="toc2.3">&nbsp;</a><h2>For Future Reference: Change Memory Protection</h2>
<p>


While we are at the topic of memory, let's cover a case where we need to change a memory block's access priviliges. We won't need it right now, but there might come a situation where we would need to set the memory to read-only, or to allow code execution from it. 

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-VirtualProtect">VirtualProtect</a> does just that. It allows to change the protection level of the previously allocated memory block. 

</p><p>

One use case when we could make use of it is for debugging purposes. If you simply free the memory, a function accessing that memory would sometimes get correct data, sometimes it will get garbage, and sometimes it will get access violation (when the memory gets reserved by another process). Such &ldquo;use after free&rdquo; bugs can be super hard to track. If, instead of freeing the memory, you set that memory block to <code>PAGE_NOACCESS</code> (which results in an access violation if someone tries to access that memory), you can then go hunting for a place in your code which tried to access memory after it's been freed. 

</p>
<a class="target" name="compileandtest">&nbsp;</a><a class="target" name="ourcustombitmapmemoryallocator/compileandtest">&nbsp;</a><a class="target" name="toc2.4">&nbsp;</a><h2>Compile and Test</h2>
<p>


We now should have a compilable program at hand. Try to compile the application, fix eventual compile errors if necessary, and run it through the debugger.

</p><p>

<ol start=1>
<li class="number">Create a breakpoint at the start of <code>Win32ResizeDIBSection</code> (<code>F9</code>).
</li>
<li class="number">Start the debugging session (<code>F5</code>).
<ul>
    <li class="asterisk">Unless you have any other breakpoints before that, the program should halt at the one you've set. 
</li></ul>
<li class="number">Continue by stepping over (<code>F10</code>).
<ul>
    <li class="asterisk">If it's the first time you run through <code>Win32ResizeDIBSection</code>, you shouldn't have any <code>BitmapMemory</code>. So the <code>if</code> evaluation should resolve in <code>false</code>, and the <code>VirtualFree</code> block should be skipped.
</li></ul>
<li class="number">We set <code>BytesPerPixel</code> to be 4.
</li>
<li class="number">We calculate <code>BitmapMemorySize</code>. With the <code>Width</code> of 1424 and <code>Height</code> of 728, we get to almost 4MiB of memory (4 146 688 bytes)! 
<ul>
    <li class="asterisk">You can quickly test if it's correct by typing the math function in the <code>Watch</code> window.
</li></ul>
<li class="number">We finally get to <code>BitmapMemory</code>. After you step over <code>VirtualAlloc</code>, its value should result in a pointer to memory.
<ul>
    <li class="asterisk">If you type this <code>BitmapMemory</code> in the <code>Memory</code> window, you will see a page full of zeros.
</li>
    <li class="asterisk">Notice how you can see the next pages (also zeroed out) but not the previous ones (all question marks).</li></ul></li></ol>

</p><p>

<center><div class="image" style=""><a href="../media/day4/debug1.png" target="_blank"><img class="markdeep" src="../media/day4/debug1.png" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;1:</b> Stepping through <code>Win32ResizeDIBSection</code>. Notice the <code>Memory</code> window at the bottom.</span></center></div></center>

</p>
<a class="target" name="revisitwin32updatewindow">&nbsp;</a><a class="target" name="revisitwin32updatewindow">&nbsp;</a><a class="target" name="toc3">&nbsp;</a><h1>Revisit <code>Win32UpdateWindow</code></h1>
<p>


The essence of this programming method is constantly revisiting the old places we've been to. Each new optimization makes our program (hopefully) better and closer to its final, shipped state.

</p><p>

Now that we're happy with the <code>Win32ResizeDIBSection</code>, let's have a better look at the <code>Win32UpdateWindow</code>:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">Win32UpdateWindow</span><span class="hljs-params">(HDC DeviceContext, <span class="hljs-keyword">int</span> X, <span class="hljs-keyword">int</span> Y, <span class="hljs-keyword">int</span> Width, <span class="hljs-keyword">int</span> Height)</span></span>
<span class="line"></span>{</span>
<span class="line">    </span>
<span class="line">    StretchDIBits(DeviceContext,</span>
<span class="line">                  X, Y, Width, Height,</span>
<span class="line">                  X, Y, Width, Height,</span>
<span class="line">                  BitmapMemory,</span>
<span class="line">                  &amp;BitmapInfo,</span>
<span class="line">                  DIB_RGB_COLORS, SRCCOPY);</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;5:</b> <file>[win32_handmade.cpp]</file> <code>Win32UpdateWindow</code>.</div></center>
<p>


Let's even take one step back, and see where does the <code>X, Y, Width</code> and <code>Height</code> come from: 

</p><pre class="listing tilde"><code><span class="line">PAINTSTRUCT Paint;</span>
<span class="line">HDC DeviceContext = BeginPaint(Window, &amp;Paint);</span>
<span class="line"></span>
<span class="line"><span class="hljs-keyword">int</span> X = Paint.rcPaint.left;</span>
<span class="line"><span class="hljs-keyword">int</span> Y = Paint.rcPaint.top;</span>
<span class="line"><span class="hljs-keyword">int</span> Width = Paint.rcPaint.right - Paint.rcPaint.left;</span>
<span class="line"><span class="hljs-keyword">int</span> Height = Paint.rcPaint.bottom - Paint.rcPaint.top;</span>
<span class="line">Win32UpdateWindow(DeviceContext, X, Y, Width, Height);</span>
<span class="line"></span>
<span class="line">EndPaint(Window, &amp;Paint);</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;6:</b> <file>[win32_handmade.cpp > Win32MainWindowCallback > case WM_PAINT]</file> Bigger picture for Win32UpdateWindow.</div></center>
<p>


It's important to understand that the paint area here is <strong class="asterisk">not the whole window</strong>. What we are doing here is what's called <em class="underscore">dirty rectangle update</em>: we only repaint the area that the Operating System considers &ldquo;dirty&rdquo; (e.g. a portion of the window previously hidden by another window). In fact, if we look at the &ldquo;Remarks&rdquo; section of <a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-beginpaint">BeginPaint</a> on MSDN, we find the following: 
<blockquote class="fancyquote"><span class="fancyquote">The update region is set by the <a href="https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-invalidaterect">InvalidateRect</a> or <a href="https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-invalidatergn">InvalidateRgn</a> function and by the system after sizing, moving, creating, scrolling, or any other operation that affects the client area. If the update region is marked for erasing, <code>BeginPaint</code> sends a <code>WM_ERASEBKGND</code> message to the window.</span></blockquote>
<code>BeginPaint</code> is a <code>WM_PAINT</code>-specific call. In fact, further below you can see: 
<blockquote class="fancyquote"><span class="fancyquote">An application should not call <code>BeginPaint</code> except in response to a <code>WM_PAINT</code> message.</span></blockquote>
The bottom line for us is that <em class="underscore">we don't have control</em> over the area of the window we're repainting. As such, we'd need to properly resize our buffer if we want to paint over a smaller area. It's not necessarily a bad thing as it improves the rendering times. However, this can introduce some bugs here and make things harder for us to debug if we are to use this dirty rectangle from the beginning. 

</p><p>

Instead, we are going to change our <code>Win32UpdateWindow</code> to repaint the whole window every time, make sure that our buffer-related operations work properly, and then we can worry about only processing the sub-regions that Windows wants us to take care of in <code>WM_PAINT</code>. 

</p><p>

This will allow us to start simple, and then get more complicated.

</p>
<a class="target" name="updatestretchdibits">&nbsp;</a><a class="target" name="revisitwin32updatewindow/updatestretchdibits">&nbsp;</a><a class="target" name="toc3.1">&nbsp;</a><h2>Update <code>StretchDIBits</code></h2>
<p>


First, we are going to update <code>StretchDIBits</code>. Let's get a refresher on what its syntax is: 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">StretchDIBits</span><span class="hljs-params">(</span>
<span class="line">  HDC              hdc,</span>
<span class="line">  <span class="hljs-keyword">int</span>              xDest,</span>
<span class="line">  <span class="hljs-keyword">int</span>              yDest,</span>
<span class="line">  <span class="hljs-keyword">int</span>              DestWidth,</span>
<span class="line">  <span class="hljs-keyword">int</span>              DestHeight,</span>
<span class="line">  <span class="hljs-keyword">int</span>              xSrc,</span>
<span class="line">  <span class="hljs-keyword">int</span>              ySrc,</span>
<span class="line">  <span class="hljs-keyword">int</span>              SrcWidth,</span>
<span class="line">  <span class="hljs-keyword">int</span>              SrcHeight,</span>
<span class="line">  <span class="hljs-keyword">const</span> VOID       *lpBits,</span>
<span class="line">  <span class="hljs-keyword">const</span> BITMAPINFO *lpbmi,</span>
<span class="line">  UINT             iUsage,</span>
<span class="line">  DWORD            rop</span>
<span class="line">)</span></span>;</span></code></pre><center><div class="listingcaption tilde"><file>[MSDN]</file> StretchDIBits Syntax.</div></center>
<p>


Ah yes, first we pass the destination coordinates, and then the source. At the moment, these are the same values: 

</p><pre class="listing tilde"><code><span class="line">StretchDIBits(DeviceContext,</span>
<span class="line">              X, Y, Width, Height, <span class="hljs-comment">// destination rectangle (window)</span></span>
<span class="line">              X, Y, Width, Height, <span class="hljs-comment">// source rectangle (bitmap buffer)</span></span>
<span class="line">              BitmapMemory,</span>
<span class="line">              &amp;BitmapInfo,</span>
<span class="line">              DIB_RGB_COLORS, SRCCOPY);</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;7:</b> <file>[win32_handmade.cpp > Win32UpdateWindow]</file> StretchDIBits call.</div></center>
<p>


We're going to make the following changes: 

</p><p>

<ul>
<li class="asterisk"><code>X</code> and <code>Y</code> for both source and destination will be <code>0</code>. We will be starting from the top left corner of our buffer and window.
</li>
<li class="asterisk">For the destination, we will go for the full <code>WindowWidth</code> and <code>WindowHeight</code>
</li>
<li class="asterisk">For the source, we will go for the full <code>BitmapWidth</code> and <code>BitmapHeight</code></li></ul>

</p><pre class="listing tilde"><code><span class="line">StretchDIBits(DeviceContext,</span><div class=" delete"><span class="line">              X, Y, Width, Height,</span>
<span class="line">              X, Y, Width, Height,</span></div><div class=" add"><span class="line">              <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, WindowWidth, WindowHeight, <span class="hljs-comment">// destination rectangle (window)</span></span>
<span class="line">              <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, BitmapWidth, BitmapHeight, <span class="hljs-comment">// source rectangle (bitmap buffer)</span></span></div><span class="line">              BitmapMemory,</span>
<span class="line">              &amp;BitmapInfo,</span>
<span class="line">              DIB_RGB_COLORS, SRCCOPY);</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;8:</b> <file>[win32_handmade.cpp > Win32UpdateWindow]</file> Edits to StretchDIBits.</div></center>
<p>


We will also use the same <code>BitmapWidth</code> and <code>BitmapHeight</code> inside our <code>BitmapInfo</code> header.
</p><pre class="listing tilde"><code><span class="line">    BITMAPINFO BitmapInfo = {};</span>
<span class="line"></span>
<span class="line">    BitmapInfo.bmiHeader.biSize = <span class="hljs-keyword">sizeof</span>(BitmapInfo.bmiHeader);</span><div class=" edit"><span class="line">    BitmapInfo.bmiHeader.biWidth = BitmapWidth;</span>
<span class="line">    BitmapInfo.bmiHeader.biHeight = BitmapHeight;</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;9:</b> <file>[win32_handmade.cpp > Win32ResizeDIBSection]</file> Updating BitmapInfo.</div></center>

<a class="target" name="propagatethechangesoutside">&nbsp;</a><a class="target" name="revisitwin32updatewindow/propagatethechangesoutside">&nbsp;</a><a class="target" name="toc3.2">&nbsp;</a><h2>Propagate the Changes Outside</h2>

<a class="target" name="bitmapwidthandheight">&nbsp;</a><a class="target" name="revisitwin32updatewindow/propagatethechangesoutside/bitmapwidthandheight">&nbsp;</a><a class="target" name="toc3.2.1">&nbsp;</a><h3>Bitmap Width and Height</h3>
<p>


We don't have any of these sizes for now. Let's focus on the bitmap width and height now, we can get it from global scope.

</p><pre class="listing tilde"><code><span class="line">global_variable <span class="hljs-keyword">void</span> *BitmapMemory;</span><div class=" add"><span class="line">global_variable <span class="hljs-keyword">int</span> BitmapWidth;</span>
<span class="line">global_variable <span class="hljs-keyword">int</span> BitmapHeight;</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;10:</b> <file>[win32_handmade.cpp]</file> Introducing new global variables (for now).</div></center>
<p>




<div class="admonition warning">It's important to note once again that these global variables are not permanent. We're only storing them as globals while we are in the &ldquo;exploration mode&rdquo;. 

</p><p>

    You should always strive to put the global variables only while you're getting things working. Once you know how the things should go, clean it up and make sure that only the things that should be global remain such.</div>

</p><p>

<code>BitmapWidth</code> and <code>BitmapHeight</code> will be initialized inside <code>Win32ResizeDIBSection</code>. We can also start using them right away:

</p><pre class="listing tilde"><code><div class=" add"><span class="line">BitmapWidth = Width; </span>
<span class="line">BitmapHeight = Height; </span></div><span class="line"><span class="hljs-keyword">int</span> BytesPerPixel = <span class="hljs-number">4</span>;</span><div class=" edit"><span class="line"><span class="hljs-keyword">int</span> BitmapMemorySize = BytesPerPixel * BitmapWidth * BitmapHeight;</span></div><span class="line"><span class="hljs-comment">// ...</span></span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;11:</b> <file>[win32_handmade.cpp > Win32ResizeDIBSection]</file> Initializing new globals.</div></center>

<a class="target" name="windowwidthandheight">&nbsp;</a><a class="target" name="revisitwin32updatewindow/propagatethechangesoutside/windowwidthandheight">&nbsp;</a><a class="target" name="toc3.2.2">&nbsp;</a><h3>Window Width and Height</h3>
<p>


<code>WindowWidth</code> and <code>WindowHeight</code>, on the other hand, can be calculated based on a window rectangle that we will pass into the function. We can also get rid of the now-unused parameters <code>X, Y, Width</code> and <code>Height</code>. 

</p><pre class="listing tilde"><code><span class="line">internal <span class="hljs-keyword">void</span></span><div class=" edit"><span class="line">Win32UpdateWindow(HDC DeviceContext, RECT *WindowRect)</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;12:</b> <file>[win32_handmade.cpp]</file> Changing <code>Win32UpdateWindow</code> signature.</div></center>
<p>




<div class="admonition note"><div class="admonition-title"> Passing by pointer vs. passing by value.</div>

</p><p>

    Note that instead of passing the entire <code>RECT</code> structure, we're passing a <em class="underscore">pointer</em> to it. This allows us to save space on the <em class="underscore">stack</em>. We'll talk more about it in the next lesson, but the bottom line is that the bigger the structure, the more it makes sense to pass a pointer to it, instead of a 64-bit pointer.

</p><p>

    One thing to note however, if we try to access members of a struct passed by pointer, we should <em class="underscore">dereference</em> them with the <code>-&gt;</code> operator, instead of accessing them via <code>.</code> operator. 

</p><p>

    Another reason you sometimes want to receive a structure by pointer is the one we've seen before: if you want the changes to the structure propagate outside the function itself.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dim</span></span>
<span class="line">{</span></span>
<span class="line">    <span class="hljs-keyword">int</span> Width;</span>
<span class="line">    <span class="hljs-keyword">int</span> Height;</span>
<span class="line">};</span>
<span class="line"></span>
<span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">CalculateDimension</span> <span class="hljs-params">(dim Dim, dim* PointerDim)</span></span>
<span class="line"></span>{</span>
<span class="line">    PointerDim-&gt;Width = Dim.Width;</span>
<span class="line">    PointerDim-&gt;Height = Dim.Height;        <span class="hljs-comment">// If dereferenced values are modified, the edits persist outside this function</span></span>
<span class="line"></span>
<span class="line">    Dim.Height = <span class="hljs-number">0</span>;                         <span class="hljs-comment">// If values are modified, the edits have no effect outside this function (unless we return it)</span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><file>[Example]</file> Passing by value and by reference.</div></center></div>

</p><p>

<p>


Once we have our <code>WindowRect</code> (which, <a href="https://docs.microsoft.com/en-us/windows/win32/api/windef/ns-windef-rect">as we remember</a>, has <code>left, top, right</code> and <code>bottom</code> components), we can calculate the <code>WindowWidth</code> and <code>WindowHeight</code>: 

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-keyword">int</span> WindowWidth = WindowRect-&gt;right - WindowRect-&gt;left;</span>
<span class="line"><span class="hljs-keyword">int</span> WindowHeight = WindowRect-&gt;bottom - WindowRect-&gt;top;</span></div><span class="line">StretchDIBits(...);</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;13:</b> <file>[win32_handmade.cpp > Win32UpdateWindow]</file> Calculating <code>WindowWidth</code> and <code>WindowHeight</code>.</div></center>
<p>


We need to pass our <code>Win32UpdateWindow</code> the WindowRect, and to that we can simply copy and paste related code from <code>WM_SIZE</code>. While we are at it, let's also clean up the <code>rcPaint</code>-related parameters since we won't need them anymore.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">switch</span> (Message)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-keyword">case</span> WM_SIZE:</span>
<span class="line">    {</span>
<span class="line">        RECT ClientRect;                        <span class="hljs-comment">// Copy this</span></span>
<span class="line">        GetClientRect(Window, &amp;ClientRect);     <span class="hljs-comment">// Copy this</span></span>
<span class="line">        <span class="hljs-comment">// ... </span></span>
<span class="line">    } <span class="hljs-keyword">break</span>;</span>
<span class="line"></span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line"></span>
<span class="line">    <span class="hljs-keyword">case</span> WM_PAINT:</span>
<span class="line">    {</span>
<span class="line">        PAINTSTRUCT Paint;</span>
<span class="line">        HDC DeviceContext = BeginPaint(Window, &amp;Paint);</span>
<span class="line"></span><div class=" delete"><span class="line">        <span class="hljs-keyword">int</span> X = Paint.rcPaint.left;</span>
<span class="line">        <span class="hljs-keyword">int</span> Y = Paint.rcPaint.top;</span>
<span class="line">        <span class="hljs-keyword">int</span> Width = Paint.rcPaint.right - Paint.rcPaint.left;</span>
<span class="line">        <span class="hljs-keyword">int</span> Height = Paint.rcPaint.bottom - Paint.rcPaint.top;</span></div><div class=" add"><span class="line">        RECT ClientRect;</span>
<span class="line">        GetClientRect(Window, &amp;ClientRect);</span>
<span class="line"></span></div><div class=" edit"><span class="line">        Win32UpdateWindow(DeviceContext, &amp;ClientRect);</span></div><span class="line">        EndPaint(Window, &amp;Paint);</span>
<span class="line">    } <span class="hljs-keyword">break</span>;</span>
<span class="line"></span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;14:</b> <file>[win32_handmade.cpp > Win32MainWindowCallback]</file> Requesting <code>WindowRect</code>.</div></center>
<p>


Last thing, let's rename our <code>WindowRect</code> inside <code>Win32UpdateWindow</code> to <code>ClientRect</code>, to be consistent with the names. In Windows, <code>WindowRect</code> exists, and it means the whole window area including the borders, so we don't want future us to be confused: 

</p><pre class="listing tilde"><code><span class="line">internal <span class="hljs-keyword">void</span></span><div class=" edit"><span class="line">Win32UpdateWindow(HDC DeviceContext, RECT *ClientRect)</span></div><span class="line">{</span>
<span class="line">    <span class="hljs-comment">//...</span></span><div class=" edit"><span class="line">    <span class="hljs-keyword">int</span> WindowWidth = ClientRect-&gt;right - ClientRect-&gt;left;</span>
<span class="line">    <span class="hljs-keyword">int</span> WindowHeight = ClientRect-&gt;bottom - ClientRect-&gt;top;</span></div><span class="line">    <span class="hljs-comment">//... </span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;15:</b> <file>[win32_handmade.cpp]</file> Correcting <code>ClientRect</code> name in <code>Win32UpdateWindow</code>.</div></center>

<a class="target" name="drawpixelstothebitmap">&nbsp;</a><a class="target" name="drawpixelstothebitmap">&nbsp;</a><a class="target" name="toc4">&nbsp;</a><h1>Draw Pixels to the Bitmap</h1>
<p>


Now we should be compilable. Let's quickly build and run our program, our window should result nice and black as before. You can also check it for the memory leaks like we did it <a href="day3.html#inspectyourwork">last time</a>, just to be sure. 

</p><p>

We're finally ready to draw some pixels! Let's go ahead and do it. 

</p>
<a class="target" name="understandthereadorderofthestretchdibits">&nbsp;</a><a class="target" name="drawpixelstothebitmap/understandthereadorderofthestretchdibits">&nbsp;</a><a class="target" name="toc4.1">&nbsp;</a><h2>Understand the Read Order of the StretchDIBits</h2>
<p>


We have our <code>BitmapMemory</code> pointer, it will be drawn in full to the window, but before we're ready to do so, there's one question: how will it be <em class="underscore">read</em> by <code>StretchDIBits</code>? How is <code>StretchDIBits</code> going to access this memory? 

</p><p>

Memory is just a (giant) series of bytes, one following the other. On the other hand, Bitmap is a 2D grid, each square representing one pixel. We'll therefore need a convention to represent our 2D bitmap in 1D memory. 

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="256" width="640" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 8,112 L 8,144 " style="fill:none;"/>
<path d="M 40,112 L 40,144 " style="fill:none;"/>
<path d="M 72,112 L 72,144 " style="fill:none;"/>
<path d="M 104,112 L 104,144 " style="fill:none;"/>
<path d="M 136,112 L 136,144 " style="fill:none;"/>
<path d="M 168,112 L 168,144 " style="fill:none;"/>
<path d="M 200,112 L 200,144 " style="fill:none;"/>
<path d="M 232,112 L 232,144 " style="fill:none;"/>
<path d="M 264,112 L 264,144 " style="fill:none;"/>
<path d="M 328,32 L 328,224 " style="fill:none;"/>
<path d="M 360,32 L 360,224 " style="fill:none;"/>
<path d="M 392,32 L 392,224 " style="fill:none;"/>
<path d="M 424,32 L 424,224 " style="fill:none;"/>
<path d="M 456,32 L 456,224 " style="fill:none;"/>
<path d="M 488,32 L 488,224 " style="fill:none;"/>
<path d="M 520,32 L 520,224 " style="fill:none;"/>
<path d="M 552,32 L 552,224 " style="fill:none;"/>
<path d="M 584,32 L 584,224 " style="fill:none;"/>
<path d="M 616,32 L 616,224 " style="fill:none;"/>
<path d="M 328,32 L 616,32 " style="fill:none;"/>
<path d="M 328,64 L 616,64 " style="fill:none;"/>
<path d="M 328,96 L 616,96 " style="fill:none;"/>
<path d="M 8,112 L 264,112 " style="fill:none;"/>
<path d="M 328,128 L 616,128 " style="fill:none;"/>
<path d="M 8,144 L 264,144 " style="fill:none;"/>
<path d="M 328,160 L 616,160 " style="fill:none;"/>
<path d="M 328,192 L 616,192 " style="fill:none;"/>
<path d="M 328,224 L 616,224 " style="fill:none;"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="56" y="4">M</text><text text-anchor="middle" x="64" y="4">e</text><text text-anchor="middle" x="72" y="4">m</text><text text-anchor="middle" x="80" y="4">o</text><text text-anchor="middle" x="88" y="4">r</text><text text-anchor="middle" x="96" y="4">y</text><text text-anchor="middle" x="104" y="4">:</text><text text-anchor="middle" x="120" y="4">a</text><text text-anchor="middle" x="136" y="4">l</text><text text-anchor="middle" x="144" y="4">o</text><text text-anchor="middle" x="152" y="4">n</text><text text-anchor="middle" x="160" y="4">g</text><text text-anchor="middle" x="168" y="4">,</text><text text-anchor="middle" x="184" y="4">l</text><text text-anchor="middle" x="192" y="4">o</text><text text-anchor="middle" x="200" y="4">n</text><text text-anchor="middle" x="208" y="4">g</text><text text-anchor="middle" x="312" y="4">|</text><text text-anchor="middle" x="416" y="4">B</text><text text-anchor="middle" x="424" y="4">i</text><text text-anchor="middle" x="432" y="4">t</text><text text-anchor="middle" x="440" y="4">m</text><text text-anchor="middle" x="448" y="4">a</text><text text-anchor="middle" x="456" y="4">p</text><text text-anchor="middle" x="464" y="4">:</text><text text-anchor="middle" x="480" y="4">A</text><text text-anchor="middle" x="496" y="4">2</text><text text-anchor="middle" x="504" y="4">D</text><text text-anchor="middle" x="520" y="4">g</text><text text-anchor="middle" x="528" y="4">r</text><text text-anchor="middle" x="536" y="4">i</text><text text-anchor="middle" x="544" y="4">d</text><text text-anchor="middle" x="72" y="20">s</text><text text-anchor="middle" x="80" y="20">t</text><text text-anchor="middle" x="88" y="20">r</text><text text-anchor="middle" x="96" y="20">i</text><text text-anchor="middle" x="104" y="20">n</text><text text-anchor="middle" x="112" y="20">g</text><text text-anchor="middle" x="128" y="20">o</text><text text-anchor="middle" x="136" y="20">f</text><text text-anchor="middle" x="152" y="20">b</text><text text-anchor="middle" x="160" y="20">y</text><text text-anchor="middle" x="168" y="20">t</text><text text-anchor="middle" x="176" y="20">e</text><text text-anchor="middle" x="184" y="20">s</text><text text-anchor="middle" x="416" y="20">d</text><text text-anchor="middle" x="424" y="20">r</text><text text-anchor="middle" x="432" y="20">a</text><text text-anchor="middle" x="440" y="20">w</text><text text-anchor="middle" x="448" y="20">i</text><text text-anchor="middle" x="456" y="20">n</text><text text-anchor="middle" x="464" y="20">g</text><text text-anchor="middle" x="480" y="20">a</text><text text-anchor="middle" x="496" y="20">p</text><text text-anchor="middle" x="504" y="20">i</text><text text-anchor="middle" x="512" y="20">c</text><text text-anchor="middle" x="520" y="20">t</text><text text-anchor="middle" x="528" y="20">u</text><text text-anchor="middle" x="536" y="20">r</text><text text-anchor="middle" x="544" y="20">e</text><text text-anchor="middle" x="312" y="36">|</text><text text-anchor="middle" x="312" y="68">|</text><text text-anchor="middle" x="408" y="84">▉</text><text text-anchor="middle" x="536" y="84">▉</text><text text-anchor="middle" x="312" y="100">|</text><text text-anchor="middle" x="88" y="132">▉</text><text text-anchor="middle" x="216" y="132">▉</text><text text-anchor="middle" x="312" y="132">|</text><text text-anchor="middle" x="408" y="148">▉</text><text text-anchor="middle" x="536" y="148">▉</text><text text-anchor="middle" x="312" y="164">|</text><text text-anchor="middle" x="440" y="180">▉</text><text text-anchor="middle" x="472" y="180">▉</text><text text-anchor="middle" x="504" y="180">▉</text><text text-anchor="middle" x="312" y="196">|</text><text text-anchor="middle" x="312" y="228">|</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_diagram">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;2:</b> Memory vs. bitmap</div></center>

</p><p>

A single row is simple to do. If you get a pointer to bytes, you start reading them one after the other, considering each consecutive byte (or series of bytes) as the next pixel. But when you get to the end of the row, what happens? Is the next byte the first pixel of the row below? The row above? There's some pointer math happening there? 

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="288" width="424" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 64,0 L 64,32 " style="fill:none;"/>
<path d="M 64,64 L 64,96 " style="fill:none;"/>
<path d="M 64,128 L 64,160 " style="fill:none;"/>
<path d="M 64,224 L 64,256 " style="fill:none;"/>
<path d="M 96,0 L 96,32 " style="fill:none;"/>
<path d="M 96,64 L 96,96 " style="fill:none;"/>
<path d="M 96,128 L 96,160 " style="fill:none;"/>
<path d="M 96,224 L 96,256 " style="fill:none;"/>
<path d="M 128,0 L 128,32 " style="fill:none;"/>
<path d="M 128,64 L 128,96 " style="fill:none;"/>
<path d="M 128,128 L 128,160 " style="fill:none;"/>
<path d="M 128,224 L 128,256 " style="fill:none;"/>
<path d="M 160,0 L 160,32 " style="fill:none;"/>
<path d="M 160,64 L 160,96 " style="fill:none;"/>
<path d="M 160,128 L 160,160 " style="fill:none;"/>
<path d="M 160,224 L 160,256 " style="fill:none;"/>
<path d="M 192,0 L 192,32 " style="fill:none;"/>
<path d="M 192,64 L 192,96 " style="fill:none;"/>
<path d="M 192,128 L 192,160 " style="fill:none;"/>
<path d="M 192,224 L 192,256 " style="fill:none;"/>
<path d="M 224,0 L 224,32 " style="fill:none;"/>
<path d="M 224,64 L 224,96 " style="fill:none;"/>
<path d="M 224,128 L 224,160 " style="fill:none;"/>
<path d="M 224,224 L 224,256 " style="fill:none;"/>
<path d="M 256,0 L 256,32 " style="fill:none;"/>
<path d="M 256,64 L 256,96 " style="fill:none;"/>
<path d="M 256,128 L 256,160 " style="fill:none;"/>
<path d="M 256,224 L 256,256 " style="fill:none;"/>
<path d="M 288,0 L 288,32 " style="fill:none;"/>
<path d="M 288,64 L 288,96 " style="fill:none;"/>
<path d="M 288,128 L 288,160 " style="fill:none;"/>
<path d="M 288,224 L 288,256 " style="fill:none;"/>
<path d="M 320,0 L 320,32 " style="fill:none;"/>
<path d="M 320,64 L 320,96 " style="fill:none;"/>
<path d="M 320,128 L 320,160 " style="fill:none;"/>
<path d="M 320,224 L 320,256 " style="fill:none;"/>
<path d="M 352,0 L 352,32 " style="fill:none;"/>
<path d="M 352,64 L 352,96 " style="fill:none;"/>
<path d="M 352,128 L 352,160 " style="fill:none;"/>
<path d="M 352,224 L 352,256 " style="fill:none;"/>
<path d="M 376,64 L 376,192 " style="fill:none;"/>
<path d="M 64,0 L 288,0 " style="fill:none;"/>
<path d="M 320,0 L 352,0 " style="fill:none;"/>
<path d="M 40,16 L 56,16 " style="fill:none;"/>
<path d="M 64,32 L 288,32 " style="fill:none;"/>
<path d="M 320,32 L 352,32 " style="fill:none;"/>
<path d="M 40,48 L 360,48 " style="fill:none;"/>
<path d="M 64,64 L 288,64 " style="fill:none;"/>
<path d="M 320,64 L 352,64 " style="fill:none;"/>
<path d="M 40,80 L 56,80 " style="fill:none;"/>
<path d="M 360,80 L 376,80 " style="fill:none;"/>
<path d="M 64,96 L 288,96 " style="fill:none;"/>
<path d="M 320,96 L 352,96 " style="fill:none;"/>
<path d="M 40,112 L 376,112 " style="fill:none;"/>
<path d="M 64,128 L 288,128 " style="fill:none;"/>
<path d="M 320,128 L 352,128 " style="fill:none;"/>
<path d="M 40,144 L 56,144 " style="fill:none;"/>
<path d="M 64,160 L 288,160 " style="fill:none;"/>
<path d="M 320,160 L 352,160 " style="fill:none;"/>
<path d="M 40,208 L 64,208 " style="fill:none;"/>
<path d="M 352,208 L 360,208 " style="fill:none;"/>
<path d="M 64,224 L 288,224 " style="fill:none;"/>
<path d="M 320,224 L 352,224 " style="fill:none;"/>
<path d="M 40,240 L 56,240 " style="fill:none;"/>
<path d="M 64,256 L 288,256 " style="fill:none;"/>
<path d="M 320,256 L 352,256 " style="fill:none;"/>
<path d="M 40,16 C 23.2,16 24,32 24,32 " style="fill:none;"/>
<path d="M 40,48 C 23.2,48 24,32 24,32 " style="fill:none;"/>
<path d="M 360,48 C 376.8,48 376,64 376,64 " style="fill:none;"/>
<path d="M 40,112 C 23.2,112 24,128 24,128 " style="fill:none;"/>
<path d="M 40,144 C 23.2,144 24,128 24,128 " style="fill:none;"/>
<path d="M 96,176 C 79.2,176 80,192 80,192 " style="fill:none;"/>
<path d="M 96,176 C 112.8,176 112,192 112,192 " style="fill:none;"/>
<path d="M 160,176 C 143.2,176 144,192 144,192 " style="fill:none;"/>
<path d="M 160,176 C 176.8,176 176,192 176,192 " style="fill:none;"/>
<path d="M 256,176 C 239.2,176 240,192 240,192 " style="fill:none;"/>
<path d="M 256,176 C 272.8,176 272,192 272,192 " style="fill:none;"/>
<path d="M 320,176 C 303.2,176 304,192 304,192 " style="fill:none;"/>
<path d="M 320,176 C 336.8,176 336,192 336,192 " style="fill:none;"/>
<path d="M 40,208 C 23.2,208 24,224 24,224 " style="fill:none;"/>
<path d="M 64,208 C 80.8,208 80,192 80,192 " style="fill:none;"/>
<path d="M 128,208 C 111.2,208 112,192 112,192 " style="fill:none;"/>
<path d="M 128,208 C 144.8,208 144,192 144,192 " style="fill:none;"/>
<path d="M 224,208 C 207.2,208 208,192 208,192 " style="fill:none;"/>
<path d="M 224,208 C 240.8,208 240,192 240,192 " style="fill:none;"/>
<path d="M 288,208 C 271.2,208 272,192 272,192 " style="fill:none;"/>
<path d="M 288,208 C 304.8,208 304,192 304,192 " style="fill:none;"/>
<path d="M 352,208 C 335.2,208 336,192 336,192 " style="fill:none;"/>
<path d="M 360,208 C 376.8,208 376,192 376,192 " style="fill:none;"/>
<path d="M 40,240 C 23.2,240 24,224 24,224 " style="fill:none;"/>
<polygon points="64,240 52,234.4 52,245.6 "  style="stroke:none" transform="rotate(0,56,240 )"/>
<polygon points="64,144 52,138.4 52,149.6 "  style="stroke:none" transform="rotate(0,56,144 )"/>
<polygon points="64,80 52,74.4 52,85.6 "  style="stroke:none" transform="rotate(0,56,80 )"/>
<polygon points="64,16 52,10.4 52,21.6 "  style="stroke:none" transform="rotate(0,56,16 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="40" y="4">?</text><text text-anchor="middle" x="296" y="20">.</text><text text-anchor="middle" x="304" y="20">.</text><text text-anchor="middle" x="312" y="20">.</text><text text-anchor="middle" x="0" y="68">P</text><text text-anchor="middle" x="8" y="68">o</text><text text-anchor="middle" x="16" y="68">i</text><text text-anchor="middle" x="24" y="68">n</text><text text-anchor="middle" x="32" y="68">t</text><text text-anchor="middle" x="40" y="68">e</text><text text-anchor="middle" x="48" y="68">r</text><text text-anchor="middle" x="384" y="68">?</text><text text-anchor="middle" x="8" y="84">-</text><text text-anchor="middle" x="24" y="84">-</text><text text-anchor="middle" x="80" y="84">1</text><text text-anchor="middle" x="112" y="84">2</text><text text-anchor="middle" x="144" y="84">3</text><text text-anchor="middle" x="176" y="84">4</text><text text-anchor="middle" x="208" y="84">5</text><text text-anchor="middle" x="240" y="84">6</text><text text-anchor="middle" x="272" y="84">7</text><text text-anchor="middle" x="296" y="84">.</text><text text-anchor="middle" x="304" y="84">.</text><text text-anchor="middle" x="312" y="84">.</text><text text-anchor="middle" x="336" y="84">N</text><text text-anchor="middle" x="392" y="84">?</text><text text-anchor="middle" x="384" y="100">?</text><text text-anchor="middle" x="40" y="132">?</text><text text-anchor="middle" x="296" y="148">.</text><text text-anchor="middle" x="304" y="148">.</text><text text-anchor="middle" x="312" y="148">.</text><text text-anchor="middle" x="184" y="196">.</text><text text-anchor="middle" x="192" y="196">.</text><text text-anchor="middle" x="200" y="196">.</text><text text-anchor="middle" x="40" y="228">?</text><text text-anchor="middle" x="296" y="244">.</text><text text-anchor="middle" x="304" y="244">.</text><text text-anchor="middle" x="312" y="244">.</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_diagram">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;3:</b> We need to know where the next row's bits are. </div></center>

</p><p>

The passage from one row to another is called <em class="underscore">pitch</em> or a <em class="underscore">stride</em>. It's typically a value that you add to the pointer to move the base from one row to another. Keep in mind that sometimes it can be greater then the total length of the pixels. 

</p><p>

<div class="admonition ">For more information, check out <a href="https://docs.microsoft.com/en-us/windows/win32/medfound/image-stride">the article on Image Stride on MSDN</a>.</div>

</p><p>

The most intutive way would be just go in sequence: one row, then the next row, then the next row, and so on (usually from top to bottom). But what would Windows do? Let's check out the on MSDN: 
<blockquote class="fancyquote"><span class="fancyquote">The origin of a bottom-up DIB is the lower-left corner; the origin of a top-down DIB is the upper-left corner. [...] <code>StretchDIBits</code> creates a top-down image if the sign of the <code>biHeight</code> member of the <code>BITMAPINFOHEADER</code> structure for the DIB is negative.</span><span class="author">
                <a href="https://docs.microsoft.com/en-us/windows/win32/api/wingdi/nf-wingdi-stretchdibits">StretchDIBits</a>, Remarks</span></blockquote>
What does it mean? If we want the rows to go sequentially from top-down, we need to update our <code>BitmapInfo</code> header height. Let's do it now: 

</p><pre class="listing tilde"><code><span class="line">BitmapInfo.bmiHeader.biSize = <span class="hljs-keyword">sizeof</span>(BitmapInfo.bmiHeader);</span>
<span class="line">BitmapInfo.bmiHeader.biWidth = BitmapWidth;</span><div class=" edit"><span class="line">BitmapInfo.bmiHeader.biHeight = -BitmapHeight; <span class="hljs-comment">// negative value: top-down pitch</span></span></div><span class="line">BitmapInfo.bmiHeader.biPlanes = <span class="hljs-number">1</span>;</span>
<span class="line">BitmapInfo.bmiHeader.biBitCount = <span class="hljs-number">32</span>;</span>
<span class="line">BitmapInfo.bmiHeader.biCompression = BI_RGB;</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;16:</b> <file>[win32_handmade.cpp > Win32ResizeDIBSection]</file> Setting pitch to be vertical.</div></center>
<p>




<div class="admonition trivia"><div class="admonition-title"> Why top-down pitch?</div>

</p><p>

    This is partly a matter of preference on our side, but also it's a simpler way of thinking about how code is arranged in memory. It's also in-line with the way Windows thinks about the coordinate system. We have already seen that Windows intends the top-left corner to be the beginning of the coordinates. Last but not least, it's reminiscing of the oldschool frame buffers which started in top-left and went down. 

</p><p>

    It might not be the most common way of thinking about the newer technologies like OpenGL (which are rendering in bottom-up) but this is ways off, and thinking top-down is a clearer way to begin with.</div>

</p>
<a class="target" name="startpixelloop">&nbsp;</a><a class="target" name="drawpixelstothebitmap/startpixelloop">&nbsp;</a><a class="target" name="toc4.2">&nbsp;</a><h2>Start Pixel Loop</h2>
<p>


Inside the <code>Win32ResizeDIBSection</code>, at the very end, let's create our first rendering. 

</p><p>

<ol start=1>
<li class="number">We are going to go row by row using a <code>for</code> loop. 
</li>
<li class="number">We will then make another <code>for</code> loop to go pixel by pixel inside each row.</li></ol>

</p><p>

This will give us the <code>X</code> and <code>Y</code> coordinates for each pixel. 

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line"><span class="hljs-keyword">BitmapMemory </span>= VirtualAlloc(<span class="hljs-number">0</span>, <span class="hljs-keyword">BitmapMemorySize, </span>MEM_RESERVE <span class="hljs-title">| MEM_COMMIT, PAGE_READWRITE);</span></span></div><div class=" add"><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> Y = <span class="hljs-number">0</span>;</span>
<span class="line">         Y &lt; BitmapHeight;</span>
<span class="line">         ++Y)</span>
<span class="line">{</span>
<span class="line">    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> X = <span class="hljs-number">0</span>;</span>
<span class="line">            X &lt; BitmapWidth;</span>
<span class="line">            ++X)</span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// Write color to pixel</span></span>
<span class="line">    }</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;17:</b> <file>[win32_handmade.cpp > Win32ResizeDIBSection]</file> Setting up rendering loops.</div></center>
<p>


We have our <code>BitmapMemory</code>. It's a huge block of memory that Windows gave us specifically for the purpose of drawing pixels into. Unfortunately, it's also a <code>void *</code>, something that C doesn't really know how to work with. So in order to start writing to <code>BitmapMemory</code>, we have to change it to a pointer C does understand. 

</p><p>

We want to set up control over the pointer and how it's going to move, so we can <em class="underscore">cast</em> our <code>void *</code> to <code>unsigned char *</code> to have control over every single byte in our memory (On x86 processors, <code>char</code> is long exactly 1 byte, or 8 bits). For more about type casting, check out subsection  <a href="#toc8.2">8.2</a>.

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line"><span class="hljs-keyword">BitmapMemory </span>= VirtualAlloc(<span class="hljs-number">0</span>, <span class="hljs-keyword">BitmapMemorySize, </span>MEM_RESERVE <span class="hljs-title">| MEM_COMMIT, PAGE_READWRITE);</span></span></div><div class=" add"><span class="line"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *Row = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *)BitmapMemory;</span></div><div class=" C++ "><span class="line">for (int Y = 0;</span>
<span class="line">         Y &lt; BitmapHeight;</span>
<span class="line">         ++Y)</span>
<span class="line">{</span>
<span class="line">    // ...</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;18:</b> <file>[win32_handmade.cpp > Win32ResizeDIBSection]</file> Casting <code>BitmapMemory</code> to <code>Row</code>.</div></center>

<a class="target" name="setupbasictypes">&nbsp;</a><a class="target" name="drawpixelstothebitmap/setupbasictypes">&nbsp;</a><a class="target" name="toc4.3">&nbsp;</a><h2>Set Up Basic Types</h2>
<p>


Let's hold on to this thought for a moment and do one important thing. We will throw in a few convenient <code>typedef</code>s to work with the numbers. Typing <code>unsigned char *</code> is tedious, but even more than that, you can't really be sure that it represents exactly an 8-bit block of memory. Unfortunately for us, standard C does not guarantee that types like <code>char</code>, <code>short</code> or <code>int</code> correspond to 8, 16 or 32 bits. The lengths of these are defined by the platform.

</p><p>

So we want to have something that a) is easier to type and b) means what we want to mean. Luckily for us, standard C did provide several types that must correspond to a specific amount of bits. These are defined in the <a href="https://www.cplusplus.com/reference/cstdint/">stdint.h</a> header and have names like <code>uint8_t</code>, <code>int32_t</code>, etc. You can use them as is, but we will make them even shorter and <code>typedef</code> the ones we're going to use as follows: 

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span></span></div><div class=" add"><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="hljs-comment">// unsigned integers</span></span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint8_t</span> u8;     <span class="hljs-comment">// 1-byte long unsigned integer</span></span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint16_t</span> u16;   <span class="hljs-comment">// 2-byte long unsigned integer</span></span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint32_t</span> u32;   <span class="hljs-comment">// 4-byte long unsigned integer</span></span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint64_t</span> u64;   <span class="hljs-comment">// 8-byte long unsigned integer</span></span>
<span class="line"><span class="hljs-comment">// signed integers</span></span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int8_t</span> s8;      <span class="hljs-comment">// 1-byte long signed integer</span></span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int16_t</span> s16;    <span class="hljs-comment">// 2-byte long signed integer</span></span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int32_t</span> s32;    <span class="hljs-comment">// 4-byte long signed integer</span></span>
<span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int64_t</span> s64;    <span class="hljs-comment">// 8-byte long signed integer</span></span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;19:</b> <file>[win32_handmade.cpp]</file> <code>typedef</code>ing base integer types.</div></center>
<p>


We can now set our <code>Row</code> type appropriately:

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line"><span class="hljs-keyword">BitmapMemory </span>= VirtualAlloc(<span class="hljs-number">0</span>, <span class="hljs-keyword">BitmapMemorySize, </span>MEM_RESERVE <span class="hljs-title">| MEM_COMMIT, PAGE_READWRITE);</span></span></div><div class=" edit"><span class="line">u8 *Row = (u8 *)BitmapMemory;</span></div><div class=" C++ "><span class="line">for (int Y...)</span>
<span class="line">{</span>
<span class="line">    // ...</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;20:</b> <file>[win32_handmade.cpp > Win32ResizeDIBSection]</file> Changing type of <code>Row</code> and relevant cast.</div></center>
<p>




<div class="admonition tip">Why are we shortening these types? They are so fundamental (and we will add a few more) and used so often that there's a real benefit in having terse names. We can still quickly grasp what they mean, and we won't need to tediously type them in every time.

</p><p>

    As everything in this course, giving these exact names is our own preference. In your own code, you're the creator, so you can name your types as you like!</div>

</p>
<a class="target" name="calculaterowandpixelpositions">&nbsp;</a><a class="target" name="drawpixelstothebitmap/calculaterowandpixelpositions">&nbsp;</a><a class="target" name="toc4.4">&nbsp;</a><h2>Calculate Row and Pixel positions</h2>
<p>


This is how we're going to approach it: 

</p><p>

<ol start=1>
<li class="number">Calculate our <code>Pitch</code> (BitmapWidth * BytesPerPixel)
</li>
<li class="number">Set <code>Row</code> to point to <code>BitmapMemory</code>.
</li>
<li class="number">Set <code>Pixel</code> to point to row.
</li>
<li class="number">Advance <code>Pixel</code> by 1 until you reach the end of the row (represented by <code>BitmapWidth</code>).
</li>
<li class="number">Move to the next row, by adding <code>Pitch</code> to the <code>Row</code> value.
</li>
<li class="number">Repeat steps 2-5 until we reach the end of our bitmap.</li></ol>

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="528" width="568" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 104,64 L 104,112 " style="fill:none;"/>
<path d="M 104,192 L 104,240 " style="fill:none;"/>
<path d="M 104,320 L 104,368 " style="fill:none;"/>
<path d="M 104,448 L 104,480 " style="fill:none;"/>
<path d="M 184,16 L 184,32 " style="fill:none;"/>
<path d="M 192,48 L 192,80 " style="fill:none;"/>
<path d="M 192,176 L 192,208 " style="fill:none;"/>
<path d="M 192,304 L 192,336 " style="fill:none;"/>
<path d="M 192,432 L 192,464 " style="fill:none;"/>
<path d="M 216,88 L 216,120 " style="fill:none;"/>
<path d="M 216,216 L 216,248 " style="fill:none;"/>
<path d="M 216,344 L 216,376 " style="fill:none;"/>
<path d="M 224,48 L 224,80 " style="fill:none;"/>
<path d="M 224,176 L 224,208 " style="fill:none;"/>
<path d="M 224,304 L 224,336 " style="fill:none;"/>
<path d="M 224,432 L 224,464 " style="fill:none;"/>
<path d="M 248,88 L 248,112 " style="fill:none;"/>
<path d="M 248,216 L 248,240 " style="fill:none;"/>
<path d="M 248,344 L 248,368 " style="fill:none;"/>
<path d="M 256,48 L 256,80 " style="fill:none;"/>
<path d="M 256,176 L 256,208 " style="fill:none;"/>
<path d="M 256,304 L 256,336 " style="fill:none;"/>
<path d="M 256,432 L 256,464 " style="fill:none;"/>
<path d="M 280,88 L 280,112 " style="fill:none;"/>
<path d="M 280,216 L 280,240 " style="fill:none;"/>
<path d="M 280,344 L 280,368 " style="fill:none;"/>
<path d="M 288,48 L 288,80 " style="fill:none;"/>
<path d="M 288,176 L 288,208 " style="fill:none;"/>
<path d="M 288,304 L 288,336 " style="fill:none;"/>
<path d="M 288,432 L 288,464 " style="fill:none;"/>
<path d="M 312,88 L 312,112 " style="fill:none;"/>
<path d="M 312,216 L 312,240 " style="fill:none;"/>
<path d="M 312,344 L 312,368 " style="fill:none;"/>
<path d="M 320,48 L 320,80 " style="fill:none;"/>
<path d="M 320,176 L 320,208 " style="fill:none;"/>
<path d="M 320,304 L 320,336 " style="fill:none;"/>
<path d="M 320,432 L 320,464 " style="fill:none;"/>
<path d="M 344,88 L 344,112 " style="fill:none;"/>
<path d="M 344,216 L 344,240 " style="fill:none;"/>
<path d="M 344,344 L 344,368 " style="fill:none;"/>
<path d="M 352,48 L 352,80 " style="fill:none;"/>
<path d="M 352,176 L 352,208 " style="fill:none;"/>
<path d="M 352,304 L 352,336 " style="fill:none;"/>
<path d="M 352,432 L 352,464 " style="fill:none;"/>
<path d="M 376,88 L 376,112 " style="fill:none;"/>
<path d="M 376,216 L 376,240 " style="fill:none;"/>
<path d="M 376,344 L 376,368 " style="fill:none;"/>
<path d="M 384,48 L 384,80 " style="fill:none;"/>
<path d="M 384,176 L 384,208 " style="fill:none;"/>
<path d="M 384,304 L 384,336 " style="fill:none;"/>
<path d="M 384,432 L 384,464 " style="fill:none;"/>
<path d="M 408,88 L 408,112 " style="fill:none;"/>
<path d="M 408,216 L 408,240 " style="fill:none;"/>
<path d="M 408,344 L 408,368 " style="fill:none;"/>
<path d="M 416,48 L 416,80 " style="fill:none;"/>
<path d="M 416,176 L 416,208 " style="fill:none;"/>
<path d="M 416,304 L 416,336 " style="fill:none;"/>
<path d="M 416,432 L 416,464 " style="fill:none;"/>
<path d="M 448,48 L 448,80 " style="fill:none;"/>
<path d="M 448,176 L 448,208 " style="fill:none;"/>
<path d="M 448,304 L 448,336 " style="fill:none;"/>
<path d="M 448,432 L 448,464 " style="fill:none;"/>
<path d="M 472,88 L 472,112 " style="fill:none;"/>
<path d="M 472,216 L 472,240 " style="fill:none;"/>
<path d="M 472,344 L 472,368 " style="fill:none;"/>
<path d="M 480,48 L 480,80 " style="fill:none;"/>
<path d="M 480,176 L 480,208 " style="fill:none;"/>
<path d="M 480,304 L 480,336 " style="fill:none;"/>
<path d="M 480,432 L 480,464 " style="fill:none;"/>
<path d="M 488,16 L 488,32 " style="fill:none;"/>
<path d="M 520,80 L 520,144 " style="fill:none;"/>
<path d="M 520,208 L 520,272 " style="fill:none;"/>
<path d="M 520,336 L 520,400 " style="fill:none;"/>
<path d="M 520,464 L 520,480 " style="fill:none;"/>
<path d="M 184,16 L 416,16 " style="fill:none;"/>
<path d="M 448,16 L 488,16 " style="fill:none;"/>
<path d="M 192,48 L 416,48 " style="fill:none;"/>
<path d="M 448,48 L 480,48 " style="fill:none;"/>
<path d="M 24,64 L 40,64 " style="fill:none;"/>
<path d="M 88,64 L 184,64 " style="fill:none;"/>
<path d="M 488,64 L 504,64 " style="fill:none;"/>
<path d="M 192,80 L 416,80 " style="fill:none;"/>
<path d="M 448,80 L 480,80 " style="fill:none;"/>
<path d="M 120,128 L 136,128 " style="fill:none;"/>
<path d="M 192,128 L 224,128 " style="fill:none;"/>
<path d="M 112,160 L 288,160 " style="fill:none;"/>
<path d="M 408,160 L 432,160 " style="fill:none;"/>
<path d="M 456,160 L 504,160 " style="fill:none;"/>
<path d="M 192,176 L 416,176 " style="fill:none;"/>
<path d="M 448,176 L 480,176 " style="fill:none;"/>
<path d="M 112,192 L 184,192 " style="fill:none;"/>
<path d="M 488,192 L 504,192 " style="fill:none;"/>
<path d="M 192,208 L 416,208 " style="fill:none;"/>
<path d="M 448,208 L 480,208 " style="fill:none;"/>
<path d="M 120,256 L 136,256 " style="fill:none;"/>
<path d="M 192,256 L 224,256 " style="fill:none;"/>
<path d="M 112,288 L 288,288 " style="fill:none;"/>
<path d="M 408,288 L 432,288 " style="fill:none;"/>
<path d="M 456,288 L 504,288 " style="fill:none;"/>
<path d="M 192,304 L 416,304 " style="fill:none;"/>
<path d="M 448,304 L 480,304 " style="fill:none;"/>
<path d="M 112,320 L 184,320 " style="fill:none;"/>
<path d="M 488,320 L 504,320 " style="fill:none;"/>
<path d="M 192,336 L 416,336 " style="fill:none;"/>
<path d="M 448,336 L 480,336 " style="fill:none;"/>
<path d="M 120,384 L 136,384 " style="fill:none;"/>
<path d="M 192,384 L 224,384 " style="fill:none;"/>
<path d="M 112,416 L 288,416 " style="fill:none;"/>
<path d="M 408,416 L 432,416 " style="fill:none;"/>
<path d="M 456,416 L 504,416 " style="fill:none;"/>
<path d="M 192,432 L 416,432 " style="fill:none;"/>
<path d="M 448,432 L 480,432 " style="fill:none;"/>
<path d="M 112,448 L 184,448 " style="fill:none;"/>
<path d="M 488,448 L 504,448 " style="fill:none;"/>
<path d="M 192,464 L 416,464 " style="fill:none;"/>
<path d="M 448,464 L 480,464 " style="fill:none;"/>
<path d="M 24,64 C 7.199999999999999,64 8,48 8,48 " style="fill:none;"/>
<path d="M 504,64 C 520.8,64 520,80 520,80 " style="fill:none;"/>
<path d="M 120,128 C 103.2,128 104,112 104,112 " style="fill:none;"/>
<path d="M 200,128 C 216.8,128 216,112 216,112 " style="fill:none;"/>
<path d="M 112,160 C 95.2,160 96,176 96,176 " style="fill:none;"/>
<path d="M 504,160 C 520.8,160 520,144 520,144 " style="fill:none;"/>
<path d="M 112,192 C 95.2,192 96,176 96,176 " style="fill:none;"/>
<path d="M 504,192 C 520.8,192 520,208 520,208 " style="fill:none;"/>
<path d="M 120,256 C 103.2,256 104,240 104,240 " style="fill:none;"/>
<path d="M 200,256 C 216.8,256 216,240 216,240 " style="fill:none;"/>
<path d="M 112,288 C 95.2,288 96,304 96,304 " style="fill:none;"/>
<path d="M 504,288 C 520.8,288 520,272 520,272 " style="fill:none;"/>
<path d="M 112,320 C 95.2,320 96,304 96,304 " style="fill:none;"/>
<path d="M 504,320 C 520.8,320 520,336 520,336 " style="fill:none;"/>
<path d="M 120,384 C 103.2,384 104,368 104,368 " style="fill:none;"/>
<path d="M 200,384 C 216.8,384 216,368 216,368 " style="fill:none;"/>
<path d="M 112,416 C 95.2,416 96,432 96,432 " style="fill:none;"/>
<path d="M 504,416 C 520.8,416 520,400 520,400 " style="fill:none;"/>
<path d="M 112,448 C 95.2,448 96,432 96,432 " style="fill:none;"/>
<path d="M 504,448 C 520.8,448 520,464 520,464 " style="fill:none;"/>
<polygon points="480,344 468,338.4 468,349.6 "  style="stroke:none" transform="rotate(270,472,344 )"/>
<polygon points="480,216 468,210.4 468,221.6 "  style="stroke:none" transform="rotate(270,472,216 )"/>
<polygon points="480,88 468,82.4 468,93.6 "  style="stroke:none" transform="rotate(270,472,88 )"/>
<polygon points="416,416 404,410.4 404,421.6 "  style="stroke:none" transform="rotate(180,408,416 )"/>
<polygon points="416,344 404,338.4 404,349.6 "  style="stroke:none" transform="rotate(270,408,344 )"/>
<polygon points="416,288 404,282.4 404,293.6 "  style="stroke:none" transform="rotate(180,408,288 )"/>
<polygon points="416,216 404,210.4 404,221.6 "  style="stroke:none" transform="rotate(270,408,216 )"/>
<polygon points="416,160 404,154.4 404,165.6 "  style="stroke:none" transform="rotate(180,408,160 )"/>
<polygon points="416,88 404,82.4 404,93.6 "  style="stroke:none" transform="rotate(270,408,88 )"/>
<polygon points="384,344 372,338.4 372,349.6 "  style="stroke:none" transform="rotate(270,376,344 )"/>
<polygon points="384,216 372,210.4 372,221.6 "  style="stroke:none" transform="rotate(270,376,216 )"/>
<polygon points="384,88 372,82.4 372,93.6 "  style="stroke:none" transform="rotate(270,376,88 )"/>
<polygon points="352,344 340,338.4 340,349.6 "  style="stroke:none" transform="rotate(270,344,344 )"/>
<polygon points="352,216 340,210.4 340,221.6 "  style="stroke:none" transform="rotate(270,344,216 )"/>
<polygon points="352,88 340,82.4 340,93.6 "  style="stroke:none" transform="rotate(270,344,88 )"/>
<polygon points="320,344 308,338.4 308,349.6 "  style="stroke:none" transform="rotate(270,312,344 )"/>
<polygon points="320,216 308,210.4 308,221.6 "  style="stroke:none" transform="rotate(270,312,216 )"/>
<polygon points="320,88 308,82.4 308,93.6 "  style="stroke:none" transform="rotate(270,312,88 )"/>
<polygon points="288,344 276,338.4 276,349.6 "  style="stroke:none" transform="rotate(270,280,344 )"/>
<polygon points="288,216 276,210.4 276,221.6 "  style="stroke:none" transform="rotate(270,280,216 )"/>
<polygon points="288,88 276,82.4 276,93.6 "  style="stroke:none" transform="rotate(270,280,88 )"/>
<polygon points="256,344 244,338.4 244,349.6 "  style="stroke:none" transform="rotate(270,248,344 )"/>
<polygon points="256,216 244,210.4 244,221.6 "  style="stroke:none" transform="rotate(270,248,216 )"/>
<polygon points="256,88 244,82.4 244,93.6 "  style="stroke:none" transform="rotate(270,248,88 )"/>
<polygon points="224,344 212,338.4 212,349.6 "  style="stroke:none" transform="rotate(270,216,344 )"/>
<polygon points="224,216 212,210.4 212,221.6 "  style="stroke:none" transform="rotate(270,216,216 )"/>
<polygon points="224,88 212,82.4 212,93.6 "  style="stroke:none" transform="rotate(270,216,88 )"/>
<polygon points="192,448 180,442.4 180,453.6 "  style="stroke:none" transform="rotate(0,184,448 )"/>
<polygon points="192,320 180,314.4 180,325.6 "  style="stroke:none" transform="rotate(0,184,320 )"/>
<polygon points="192,192 180,186.4 180,197.6 "  style="stroke:none" transform="rotate(0,184,192 )"/>
<polygon points="192,64 180,58.4 180,69.6 "  style="stroke:none" transform="rotate(0,184,64 )"/>
<polygon points="144,384 132,378.4 132,389.6 "  style="stroke:none" transform="rotate(0,136,384 )"/>
<polygon points="144,256 132,250.4 132,261.6 "  style="stroke:none" transform="rotate(0,136,256 )"/>
<polygon points="144,128 132,122.4 132,133.6 "  style="stroke:none" transform="rotate(0,136,128 )"/>
<polygon points="48,64 36,58.4 36,69.6 "  style="stroke:none" transform="rotate(0,40,64 )"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="304" y="4">P</text><text text-anchor="middle" x="312" y="4">i</text><text text-anchor="middle" x="320" y="4">t</text><text text-anchor="middle" x="328" y="4">c</text><text text-anchor="middle" x="336" y="4">h</text><text text-anchor="middle" x="424" y="20">.</text><text text-anchor="middle" x="432" y="20">.</text><text text-anchor="middle" x="440" y="20">.</text><text text-anchor="middle" x="0" y="36">B</text><text text-anchor="middle" x="8" y="36">i</text><text text-anchor="middle" x="16" y="36">t</text><text text-anchor="middle" x="24" y="36">m</text><text text-anchor="middle" x="32" y="36">a</text><text text-anchor="middle" x="40" y="36">p</text><text text-anchor="middle" x="48" y="36">M</text><text text-anchor="middle" x="56" y="36">e</text><text text-anchor="middle" x="64" y="36">m</text><text text-anchor="middle" x="72" y="36">o</text><text text-anchor="middle" x="80" y="36">r</text><text text-anchor="middle" x="88" y="36">y</text><text text-anchor="middle" x="56" y="68">R</text><text text-anchor="middle" x="64" y="68">o</text><text text-anchor="middle" x="72" y="68">w</text><text text-anchor="middle" x="424" y="68">.</text><text text-anchor="middle" x="432" y="68">.</text><text text-anchor="middle" x="440" y="68">.</text><text text-anchor="middle" x="152" y="132">P</text><text text-anchor="middle" x="160" y="132">i</text><text text-anchor="middle" x="168" y="132">x</text><text text-anchor="middle" x="176" y="132">e</text><text text-anchor="middle" x="184" y="132">l</text><text text-anchor="middle" x="240" y="132">+</text><text text-anchor="middle" x="248" y="132">1</text><text text-anchor="middle" x="272" y="132">+</text><text text-anchor="middle" x="280" y="132">2</text><text text-anchor="middle" x="304" y="132">+</text><text text-anchor="middle" x="312" y="132">3</text><text text-anchor="middle" x="336" y="132">+</text><text text-anchor="middle" x="344" y="132">4</text><text text-anchor="middle" x="368" y="132">+</text><text text-anchor="middle" x="376" y="132">5</text><text text-anchor="middle" x="400" y="132">+</text><text text-anchor="middle" x="408" y="132">6</text><text text-anchor="middle" x="424" y="132">+</text><text text-anchor="middle" x="432" y="132">B</text><text text-anchor="middle" x="440" y="132">i</text><text text-anchor="middle" x="448" y="132">t</text><text text-anchor="middle" x="456" y="132">m</text><text text-anchor="middle" x="464" y="132">a</text><text text-anchor="middle" x="472" y="132">p</text><text text-anchor="middle" x="480" y="132">W</text><text text-anchor="middle" x="488" y="132">i</text><text text-anchor="middle" x="496" y="132">d</text><text text-anchor="middle" x="504" y="132">t</text><text text-anchor="middle" x="512" y="132">h</text><text text-anchor="middle" x="304" y="164">R</text><text text-anchor="middle" x="312" y="164">o</text><text text-anchor="middle" x="320" y="164">w</text><text text-anchor="middle" x="336" y="164">+</text><text text-anchor="middle" x="344" y="164">=</text><text text-anchor="middle" x="360" y="164">P</text><text text-anchor="middle" x="368" y="164">i</text><text text-anchor="middle" x="376" y="164">t</text><text text-anchor="middle" x="384" y="164">c</text><text text-anchor="middle" x="392" y="164">h</text><text text-anchor="middle" x="440" y="164">.</text><text text-anchor="middle" x="448" y="164">.</text><text text-anchor="middle" x="424" y="196">.</text><text text-anchor="middle" x="432" y="196">.</text><text text-anchor="middle" x="440" y="196">.</text><text text-anchor="middle" x="152" y="260">P</text><text text-anchor="middle" x="160" y="260">i</text><text text-anchor="middle" x="168" y="260">x</text><text text-anchor="middle" x="176" y="260">e</text><text text-anchor="middle" x="184" y="260">l</text><text text-anchor="middle" x="240" y="260">+</text><text text-anchor="middle" x="248" y="260">1</text><text text-anchor="middle" x="272" y="260">+</text><text text-anchor="middle" x="280" y="260">2</text><text text-anchor="middle" x="304" y="260">+</text><text text-anchor="middle" x="312" y="260">3</text><text text-anchor="middle" x="336" y="260">+</text><text text-anchor="middle" x="344" y="260">4</text><text text-anchor="middle" x="368" y="260">+</text><text text-anchor="middle" x="376" y="260">5</text><text text-anchor="middle" x="400" y="260">+</text><text text-anchor="middle" x="408" y="260">6</text><text text-anchor="middle" x="424" y="260">+</text><text text-anchor="middle" x="432" y="260">B</text><text text-anchor="middle" x="440" y="260">i</text><text text-anchor="middle" x="448" y="260">t</text><text text-anchor="middle" x="456" y="260">m</text><text text-anchor="middle" x="464" y="260">a</text><text text-anchor="middle" x="472" y="260">p</text><text text-anchor="middle" x="480" y="260">W</text><text text-anchor="middle" x="488" y="260">i</text><text text-anchor="middle" x="496" y="260">d</text><text text-anchor="middle" x="504" y="260">t</text><text text-anchor="middle" x="512" y="260">h</text><text text-anchor="middle" x="304" y="292">R</text><text text-anchor="middle" x="312" y="292">o</text><text text-anchor="middle" x="320" y="292">w</text><text text-anchor="middle" x="336" y="292">+</text><text text-anchor="middle" x="344" y="292">=</text><text text-anchor="middle" x="360" y="292">P</text><text text-anchor="middle" x="368" y="292">i</text><text text-anchor="middle" x="376" y="292">t</text><text text-anchor="middle" x="384" y="292">c</text><text text-anchor="middle" x="392" y="292">h</text><text text-anchor="middle" x="440" y="292">.</text><text text-anchor="middle" x="448" y="292">.</text><text text-anchor="middle" x="424" y="324">.</text><text text-anchor="middle" x="432" y="324">.</text><text text-anchor="middle" x="440" y="324">.</text><text text-anchor="middle" x="152" y="388">P</text><text text-anchor="middle" x="160" y="388">i</text><text text-anchor="middle" x="168" y="388">x</text><text text-anchor="middle" x="176" y="388">e</text><text text-anchor="middle" x="184" y="388">l</text><text text-anchor="middle" x="240" y="388">+</text><text text-anchor="middle" x="248" y="388">1</text><text text-anchor="middle" x="272" y="388">+</text><text text-anchor="middle" x="280" y="388">2</text><text text-anchor="middle" x="304" y="388">+</text><text text-anchor="middle" x="312" y="388">3</text><text text-anchor="middle" x="336" y="388">+</text><text text-anchor="middle" x="344" y="388">4</text><text text-anchor="middle" x="368" y="388">+</text><text text-anchor="middle" x="376" y="388">5</text><text text-anchor="middle" x="400" y="388">+</text><text text-anchor="middle" x="408" y="388">6</text><text text-anchor="middle" x="424" y="388">+</text><text text-anchor="middle" x="432" y="388">B</text><text text-anchor="middle" x="440" y="388">i</text><text text-anchor="middle" x="448" y="388">t</text><text text-anchor="middle" x="456" y="388">m</text><text text-anchor="middle" x="464" y="388">a</text><text text-anchor="middle" x="472" y="388">p</text><text text-anchor="middle" x="480" y="388">W</text><text text-anchor="middle" x="488" y="388">i</text><text text-anchor="middle" x="496" y="388">d</text><text text-anchor="middle" x="504" y="388">t</text><text text-anchor="middle" x="512" y="388">h</text><text text-anchor="middle" x="304" y="420">R</text><text text-anchor="middle" x="312" y="420">o</text><text text-anchor="middle" x="320" y="420">w</text><text text-anchor="middle" x="336" y="420">+</text><text text-anchor="middle" x="344" y="420">=</text><text text-anchor="middle" x="360" y="420">P</text><text text-anchor="middle" x="368" y="420">i</text><text text-anchor="middle" x="376" y="420">t</text><text text-anchor="middle" x="384" y="420">c</text><text text-anchor="middle" x="392" y="420">h</text><text text-anchor="middle" x="440" y="420">.</text><text text-anchor="middle" x="448" y="420">.</text><text text-anchor="middle" x="424" y="452">.</text><text text-anchor="middle" x="432" y="452">.</text><text text-anchor="middle" x="440" y="452">.</text><text text-anchor="middle" x="104" y="500">:</text><text text-anchor="middle" x="520" y="500">:</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_diagram">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;4:</b> Outer and Inner loops, visualized.</div></center>

</p><p>

Let's implement exactly that. We want to cast our <code>BitmapMemory</code> to a 1-byte value so that we can do <em class="underscore">pointer arithmetic</em> with it. This is a battle-proven way of approaching pixel operations, it helps preventing unaligned strides issues, or pixel boundaries and other advanced things that we will cover later... It's just a better way of writing these loops, and we hope that in time you will see why. 

</p><p>

The key to the outer loop is defining <code>Row</code> outside of the loop, and incrementing it inside the outer loop, right after the inner loop. The positioning is important.
* If you increment the <code>Row</code> inside the inner loop, you will quickly fly out of memory bounds. 
* If you increment the <code>Row</code> before the inner loop, you will skip the first row (and will fly out of memory bounds when you reach the last one).
* If you define <code>Row</code> inside the loop, it will never update its position.

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-keyword">int</span> Pitch = Width * BytesPerPixel;</span></div><div class=" C++ "><span class="line">u8 *Row = (u8 *)BitmapMemory;</span>
<span class="line">for (int Y...) // Outer loop</span>
<span class="line">{</span>
<span class="line">    for (int X...) // Inner loop</span>
<span class="line">         {</span>
<span class="line">             // Write color to pixel</span>
<span class="line">         }</span></div><div class=" add"><span class="line">    Row += Pitch;</span></div><div class=" C++ "><span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;21:</b> <file>[win32_handmade.cpp > Win32ResizeDIBSection]</file> Advancing the <code>Row</code> pointer.</div></center>
<p>




<div class="admonition note"><div class="admonition-title"> Pointer Arithmetic</div>

</p><p>

    If you are familiar with pointer arithmetic, you know that pointer values (the addresses in memory) can be added, multiplied, subtracted and divided just like any other integer. 

</p><p>

    Please be mindful that C will also silently multiply that movement by the size of the thing it's pointing to. 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">void</span> *MyPointer = <span class="hljs-number">1000</span>;</span>
<span class="line"></span>
<span class="line">u8 *ByteMover =      (u8 *)MyPointer;       </span>
<span class="line">u16 *TwoByteMover =  (u16 *)MyPointer;  </span>
<span class="line">u32 *FourByteMover = (u32 *)MyPointer; <span class="hljs-comment">// All three initially point to the same location in memory</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-built_in">printf</span>(ByteMover + <span class="hljs-number">1</span>);      <span class="hljs-comment">// 1001</span></span>
<span class="line"><span class="hljs-built_in">printf</span>(TwoByteMover + <span class="hljs-number">1</span>);   <span class="hljs-comment">// 1002</span></span>
<span class="line"><span class="hljs-built_in">printf</span>(FourByteMover + <span class="hljs-number">1</span>);  <span class="hljs-comment">// 1004</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-built_in">printf</span>(ByteMover * <span class="hljs-number">2</span>);      <span class="hljs-comment">// 2000</span></span>
<span class="line"><span class="hljs-built_in">printf</span>(TwoByteMover * <span class="hljs-number">2</span>);   <span class="hljs-comment">// 4000</span></span>
<span class="line"><span class="hljs-built_in">printf</span>(FourByteMover * <span class="hljs-number">2</span>);  <span class="hljs-comment">// 8000</span></span></code></pre><center><div class="listingcaption tilde"><file>[Example]</file> Pointer arithmetics</div></center></div>

</p><p>

<p>



As of <code>Pixel</code> pointer, we can make it 32-bit, so that by increasing it by one we can go pixel by pixel. Similar to <code>Row</code>, we initially define it outside of the inner loop and then increase inside.

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line"><span class="hljs-keyword">int</span> Pitch = Width * BytesPerPixel;</span>
<span class="line">u8 *Row = (u8 *)BitmapMemory;</span>
<span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> Y...)</span>
<span class="line">{</span></div><div class=" add"><span class="line">    u32 *Pixel = (u32 *)Row;</span></div><div class=" C++ "><span class="line">    for (int X...)</span>
<span class="line">         {</span>
<span class="line">             // Write color to pixel</span></div><div class=" add"><span class="line">            ++Pixel; <span class="hljs-comment">// advance to the next pixel (by 4 bytes)</span></span></div><div class=" C++ "><span class="line">         }</span>
<span class="line">    Row += Pitch;</span>
<span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;22:</b> <file>[win32_handmade.cpp > Win32ResizeDIBSection]</file> Defining and advancing the <code>Pixel</code> pointer.</div></center>
<p>


You might say: wait a second. Why do we need to remember and increase the <code>Row</code> if by the end of the inner loop <code>Pixel</code> will be at the next row anyway? We could just keep writing! 

</p><p>

While this might be inefficient, there's a couple of reasons of doing it this way. First, due to alignment <code>Pitch</code> might not align with the <code>Pixel</code> position. Of course, we might add the eventual <em class="underscore">padding</em> to it, and you might try doing it that way. We prefer it this way also because it lines up nicely with the notions &ldquo;Row&rdquo; and &ldquo;Pixel&rdquo;, thus simulating better memory's 2D-ness. Each time we start a new row, we reset our notions of the pixel, even if it was just next to the previous one.

</p>
<a class="target" name="pixelcomponentlayoutinmemory">&nbsp;</a><a class="target" name="drawpixelstothebitmap/pixelcomponentlayoutinmemory">&nbsp;</a><a class="target" name="toc4.5">&nbsp;</a><h2>Pixel Component Layout in Memory</h2>
<p>


We now can write to each pixel (by <em class="underscore">deferencing</em> our pointer with the <code>*</code> operator). But what are we going to right to it? 

</p>
<a class="target" name="possiblearrangmentsinmemory">&nbsp;</a><a class="target" name="drawpixelstothebitmap/pixelcomponentlayoutinmemory/possiblearrangmentsinmemory">&nbsp;</a><a class="target" name="toc4.5.1">&nbsp;</a><h3>Possible Arrangments in Memory</h3>
<p>


Each of the pixels contains <em class="underscore">packed</em> values for Red, Green and Blue channels. 

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="80" width="208" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 16,16 L 16,48 " style="fill:none;"/>
<path d="M 56,16 L 56,48 " style="fill:none;"/>
<path d="M 96,16 L 96,48 " style="fill:none;"/>
<path d="M 136,16 L 136,48 " style="fill:none;"/>
<path d="M 176,16 L 176,48 " style="fill:none;"/>
<path d="M 16,16 L 176,16 " style="fill:none;"/>
<path d="M 16,48 L 176,48 " style="fill:none;"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="48" y="4">0</text><text text-anchor="middle" x="88" y="4">1</text><text text-anchor="middle" x="128" y="4">2</text><text text-anchor="middle" x="168" y="4">3</text><text text-anchor="middle" x="32" y="36">0</text><text text-anchor="middle" x="40" y="36">0</text><text text-anchor="middle" x="72" y="36">0</text><text text-anchor="middle" x="80" y="36">0</text><text text-anchor="middle" x="112" y="36">0</text><text text-anchor="middle" x="120" y="36">0</text><text text-anchor="middle" x="152" y="36">0</text><text text-anchor="middle" x="160" y="36">0</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_pixel">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;5:</b> 32-bit value in hexadecimal.</div></center>

</p><p>

<div class="admonition ">To learn more about hexadecimal, check out Subsection  <a href="#toc8.3">8.3</a>.</div>

</p><p>

We know that we have to write <code>RGB</code> values to it. We also know that we have one byte per color channel <code>R</code>, <code>G</code> and <code>B</code>, and one unused (<code>XX</code>). But which one do we write where? In the <a href="#figure_pixel">figure&nbsp;5</a>, numbers above the bytes represent their location in memory, or offset in bytes from the pointer. You can also read it as <code>Pixel + 0</code>, <code>Pixel + 1</code>, <code>Pixel + 2</code>, <code>Pixel + 3</code>, if <code>Pixel</code> was an 8-bit value. 

</p><p>

You could try and dig through documentation to find the actual bytes arrangement but let's go the fun way! In the figure below you can see the ways in which it makes sense to pack a color.

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="272" width="208" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 16,16 L 16,48 " style="fill:none;"/>
<path d="M 16,80 L 16,112 " style="fill:none;"/>
<path d="M 16,144 L 16,176 " style="fill:none;"/>
<path d="M 16,208 L 16,240 " style="fill:none;"/>
<path d="M 56,16 L 56,48 " style="fill:none;"/>
<path d="M 56,80 L 56,112 " style="fill:none;"/>
<path d="M 56,144 L 56,176 " style="fill:none;"/>
<path d="M 56,208 L 56,240 " style="fill:none;"/>
<path d="M 96,16 L 96,48 " style="fill:none;"/>
<path d="M 96,80 L 96,112 " style="fill:none;"/>
<path d="M 96,144 L 96,176 " style="fill:none;"/>
<path d="M 96,208 L 96,240 " style="fill:none;"/>
<path d="M 136,16 L 136,48 " style="fill:none;"/>
<path d="M 136,80 L 136,112 " style="fill:none;"/>
<path d="M 136,144 L 136,176 " style="fill:none;"/>
<path d="M 136,208 L 136,240 " style="fill:none;"/>
<path d="M 176,16 L 176,48 " style="fill:none;"/>
<path d="M 176,80 L 176,112 " style="fill:none;"/>
<path d="M 176,144 L 176,176 " style="fill:none;"/>
<path d="M 176,208 L 176,240 " style="fill:none;"/>
<path d="M 16,16 L 176,16 " style="fill:none;"/>
<path d="M 16,48 L 176,48 " style="fill:none;"/>
<path d="M 16,80 L 176,80 " style="fill:none;"/>
<path d="M 16,112 L 176,112 " style="fill:none;"/>
<path d="M 16,144 L 176,144 " style="fill:none;"/>
<path d="M 16,176 L 176,176 " style="fill:none;"/>
<path d="M 16,208 L 176,208 " style="fill:none;"/>
<path d="M 16,240 L 176,240 " style="fill:none;"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="48" y="4">0</text><text text-anchor="middle" x="88" y="4">1</text><text text-anchor="middle" x="128" y="4">2</text><text text-anchor="middle" x="168" y="4">3</text><text text-anchor="middle" x="32" y="36">R</text><text text-anchor="middle" x="40" y="36">R</text><text text-anchor="middle" x="72" y="36">G</text><text text-anchor="middle" x="80" y="36">G</text><text text-anchor="middle" x="112" y="36">B</text><text text-anchor="middle" x="120" y="36">B</text><text text-anchor="middle" x="152" y="36">X</text><text text-anchor="middle" x="160" y="36">X</text><text text-anchor="middle" x="32" y="100">B</text><text text-anchor="middle" x="40" y="100">B</text><text text-anchor="middle" x="72" y="100">G</text><text text-anchor="middle" x="80" y="100">G</text><text text-anchor="middle" x="112" y="100">R</text><text text-anchor="middle" x="120" y="100">R</text><text text-anchor="middle" x="152" y="100">X</text><text text-anchor="middle" x="160" y="100">X</text><text text-anchor="middle" x="32" y="164">X</text><text text-anchor="middle" x="40" y="164">X</text><text text-anchor="middle" x="72" y="164">R</text><text text-anchor="middle" x="80" y="164">R</text><text text-anchor="middle" x="112" y="164">G</text><text text-anchor="middle" x="120" y="164">G</text><text text-anchor="middle" x="152" y="164">B</text><text text-anchor="middle" x="160" y="164">B</text><text text-anchor="middle" x="32" y="228">X</text><text text-anchor="middle" x="40" y="228">X</text><text text-anchor="middle" x="72" y="228">B</text><text text-anchor="middle" x="80" y="228">B</text><text text-anchor="middle" x="112" y="228">G</text><text text-anchor="middle" x="120" y="228">G</text><text text-anchor="middle" x="152" y="228">R</text><text text-anchor="middle" x="160" y="228">R</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_pixel2">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;6:</b> Possible packing of color for <code>StretchDIBits</code>.</div></center>

</p>
<a class="target" name="trytosetredchannel">&nbsp;</a><a class="target" name="drawpixelstothebitmap/pixelcomponentlayoutinmemory/trytosetredchannel">&nbsp;</a><a class="target" name="toc4.5.2">&nbsp;</a><h3>Try to Set Red Channel</h3>
<p>


To better illustrate this, let's actually change our pixel to an 8-bit pointer (for the time being), and write to it a specific scheme. We'll need to advance Pixel 4 times inside a single loop so that it moves by full 32 bits! We'll try to be as explicit as possible so that you can follow along.

</p><pre class="listing tilde"><code><div class=" edit"><span class="line">u8 *Pixel = (u8 *)Row;</span></div><div class=" C++ "><span class="line">for (int X...)</span>
<span class="line">{</span></div><div class=" add"><span class="line">    *Pixel = ; <span class="hljs-comment">// write to byte 0</span></span>
<span class="line">    ++Pixel;   <span class="hljs-comment">// advance by total of one byte</span></span>
<span class="line"></span>
<span class="line">    *Pixel = ; <span class="hljs-comment">// write to byte 1</span></span>
<span class="line">    ++Pixel;   <span class="hljs-comment">// advance by total of two bytes</span></span>
<span class="line"></span>
<span class="line">    *Pixel = ; <span class="hljs-comment">// write to byte 2</span></span>
<span class="line">    ++Pixel;   <span class="hljs-comment">// advance by total of three bytes</span></span>
<span class="line"></span>
<span class="line">    *Pixel = ; <span class="hljs-comment">// write to byte 3 </span></span>
<span class="line">    ++Pixel;   <span class="hljs-comment">// advance by total of four bytes -&gt; full pixel!</span></span></div><div class=" C++ "><span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;23:</b> <file>[win32_handmade.cpp > Win32ResizeDIBSection]</file> Setting up writing to pixel.</div></center>
<p>


Right now we're tentively testing arrangement <code>RR GG BB XX</code>. To test which value is which we need something called <em class="underscore">Structured Art</em> which is always a good thing to do when debugging/experimenting. We want to see if we're writing to this thing properly. So we're just going to write to (what we believe to be) the red channel, leave the green and blue channels black for now, and see if it produces the results we expected. This translates in writing the maximum value you can give an <code>unsigned char</code> to red (<code>255</code>), and <code>0</code> to the rest.

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> X...)</span>
<span class="line">{</span></div><div class=" edit"><span class="line">    <span class="hljs-comment">//</span></span>
<span class="line">    <span class="hljs-comment">//Pixel in memory: RR GG BB XX</span></span>
<span class="line">    <span class="hljs-comment">//</span></span>
<span class="line"></span>
<span class="line">    <span class="hljs-comment">// Byte 0, red?</span></span>
<span class="line">    *Pixel = <span class="hljs-number">255</span>;</span>
<span class="line">    ++Pixel;  </span>
<span class="line"></span>
<span class="line">    <span class="hljs-comment">// Byte 1, green?</span></span>
<span class="line">    *Pixel = <span class="hljs-number">0</span>;</span>
<span class="line">    ++Pixel;  </span>
<span class="line"></span>
<span class="line">    <span class="hljs-comment">// Byte 2, blue?</span></span>
<span class="line">    *Pixel = <span class="hljs-number">0</span>;</span>
<span class="line">    ++Pixel;  </span>
<span class="line"></span>
<span class="line">    <span class="hljs-comment">// Byte 3, pad? </span></span>
<span class="line">    *Pixel = <span class="hljs-number">0</span>;</span>
<span class="line">    ++Pixel;  </span></div><div class=" C++ "><span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;24:</b> <file>[win32_handmade.cpp > Win32ResizeDIBSection]</file> Testing <code>RGBx</code> arrangement.</div></center>
<p>




Let's compile and run, to see if we get anything on the screen at all. 

</p><p>

<center><div class="image" style=""><a href="../media/day4/colortest_1.png" target="_blank"><img class="markdeep" src="../media/day4/colortest_1.png" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;7:</b> Hm, this doesn't seem very red.</span></center></div></center>

</p><p>

We do see something on the screen, but it's not red! It is blue. 

</p><p>

But why?

</p><p>

There are of course experts out there who know why it is blue. Those are grizzled veterans who spent thousands of hours graphics programming. But if your only knowledge of graphics is limited to what we covered in these notes so far, you might be thoroughly confused. &ldquo;Why is Blue first, if it's RGB?&rdquo;

</p><p>

<center><div class="image" style=""><a href="../media/day4/debug2.png" target="_blank"><img class="markdeep" src="../media/day4/debug2.png" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;8:</b> Inspecting the Row pointer in Memory window.</span></center></div></center>

</p><p>

The answer to that has to do with <code>x86</code> architecture <a href="https://en.wikipedia.org/wiki/Endianness">Endianness</a>.

</p><p>

<div class="admonition note"><div class="admonition-title"> Endianness</div>

</p><p>

    Fun fact, the name takes origin from the <code>Gulliver's Travels</code>, where Lilliputians discute where the egg's &ldquo;end&rdquo; is. In computer architecture, the discussion is roughly the same, except each architecture's stance is set in silica inside microprocessors.

</p><p>

    Simply put, endianness has to do with in which order are the bytes written in the registry. In <em class="underscore">big-endian</em> systems, the bytes are written from the most significant to the least significant, while <em class="underscore">little-endian</em> systems write their bytes from the least significant to the most significant.</div>

</p><p>

<code>x86</code> systems are little-endian. This means that when, for example, the processor loads a 32-bit value to read a pixel, the first byte is read first, then the second, the third, and the fourth. So if you load <code>11 22 33 44</code> it's loaded as <code>0x______11</code> &rarr; <code>0x____2211</code> &rarr; <code>0x__332211</code> &rarr; <code>0x44332211</code>. 

</p><p>

In our case, this means that, when we load <code>RR GG BB XX</code> into memory, it becomes <code>0xXXBBGGRR</code>. Well, the architects who wrote Windows didn't like that very much, they wanted to read colors in the <em class="underscore">registers</em> as <code>RR BB GG XX</code>, so they actually swapped the bytes in the memory of the machine to <code>BB GG RR XX</code> (padding byte remained at the end). Thus the output becomes <code>0xXXRRGGBB</code>. So now all the Windows bitmaps have to have the <code>Blue</code> byte first, <code>Green</code> byte second, <code>Red</code> byte after, and then the padding.

</p>
<a class="target" name="correctthestructuredart">&nbsp;</a><a class="target" name="drawpixelstothebitmap/pixelcomponentlayoutinmemory/correctthestructuredart">&nbsp;</a><a class="target" name="toc4.5.3">&nbsp;</a><h3>Correct the Structured Art</h3>
<p>


So this is the correct arrangement of the colors, and if we want to have our screen to be red, we should refactor our program as follows: 

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> X...)</span>
<span class="line">{</span></div><div class=" edit"><span class="line">    <span class="hljs-comment">//</span></span>
<span class="line">    <span class="hljs-comment">//Pixel in memory: BB GG RR XX</span></span>
<span class="line">    <span class="hljs-comment">//</span></span>
<span class="line"></span>
<span class="line">    <span class="hljs-comment">// Byte 0, blue</span></span>
<span class="line">    *Pixel = <span class="hljs-number">0</span>;</span>
<span class="line">    ++Pixel;  </span>
<span class="line"></span>
<span class="line">    <span class="hljs-comment">// Byte 1, green</span></span>
<span class="line">    *Pixel = <span class="hljs-number">0</span>;</span>
<span class="line">    ++Pixel;  </span>
<span class="line"></span>
<span class="line">    <span class="hljs-comment">// Byte 2, red</span></span>
<span class="line">    *Pixel = <span class="hljs-number">255</span>;</span>
<span class="line">    ++Pixel;  </span>
<span class="line"></span>
<span class="line">    <span class="hljs-comment">// Byte 3, pad</span></span>
<span class="line">    *Pixel = <span class="hljs-number">0</span>;</span>
<span class="line">    ++Pixel;  </span></div><div class=" C++ "><span class="line">}</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;25:</b> <file>[win32_handmade.cpp > Win32ResizeDIBSection]</file> <code>BGRx</code> arrangement.</div></center>
<p>


If we compile and run it now, we get a nice red bitmap. 

</p>
<a class="target" name="drawcolorsbasedonpixelposition">&nbsp;</a><a class="target" name="drawpixelstothebitmap/drawcolorsbasedonpixelposition">&nbsp;</a><a class="target" name="toc4.6">&nbsp;</a><h2>Draw Colors Based on Pixel Position</h2>
<p>


Let's have some fun! Let's take our <code>X</code> coordinate, cast it down (truncate) to 8-bit and assign the resulting into the <code>Blue</code> channel. We can do the same for <code>Y</code> into the <code>Green</code> channel. <code>Red</code> channel can be left out at zero. 

</p><p>

<center><div class="image" style=""><a href="../media/day4/colortest_2.png" target="_blank"><img class="markdeep" src="../media/day4/colortest_2.png" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;9:</b> Our first pattern.</span></center></div></center>

</p><p>

The resulting image definitely has something more going for it. Still not a game, but at least something, and it looks like it's working correctly. 

</p><p>

What happens here is a simple color combination. As the rows grow, the green channel becomes more prevalent, same thing for the blue for columns. However both <code>Red</code> and <code>Green</code> can only go until 255, and we simply truncate the higher bits for <code>X</code> and <code>Y</code>, thus restarting from the beginning. 

</p>
<a class="target" name="renderingapattern">&nbsp;</a><a class="target" name="renderingapattern">&nbsp;</a><a class="target" name="toc5">&nbsp;</a><h1>Rendering a Pattern</h1>
<p>


This is a great achievement right there. You have now enough knowledge to return yourself to 1980! We have just turned this modern and beastly computer running a hugely complicated, difficult to wield operating system into something where we just have a bitmap, that we can draw to, and get back to the Joy of Coding. There is no stopping us now, we can draw any world of our imagination into that. 

</p>
<a class="target" name="introducerenderweirdgradient">&nbsp;</a><a class="target" name="renderingapattern/introducerenderweirdgradient">&nbsp;</a><a class="target" name="toc5.1">&nbsp;</a><h2>Introduce <code>RenderWeirdGradient</code></h2>
<p>


Let's do something crazy. We can take acout all the pixel drawing code out and into a separate function. Let's call it... <code>RenderWeirdGradient</code> or something. Because honestly, that's what it is doing. And the <code>RenderWeirdGradient</code> call will take a couple of integers that will be called <code>XOffset</code> and <code>YOffset</code>. The only difference in the operation will be that, when we'll be ready to render, we'll add our <code>X</code> and <code>Y</code> for <code>Blue</code> and <code>Green</code> channels, and add them to the offsets before truncating them. Thus, we'll be able to animate our gradient around the screen. And, to replicate the functionality, we will simply call this function from <code>Win32ResizeDIBSection</code>.

</p><p>

What can possibly go wrong? 

</p><pre class="listing tilde"><code><span class="line">global_variable <span class="hljs-keyword">int</span> BitmapHeight;</span>
<span class="line"></span><div class=" add"><span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span></span>
<span class="line"><span class="hljs-title">RenderWeirdGradient</span><span class="hljs-params">(<span class="hljs-keyword">int</span> XOffset, <span class="hljs-keyword">int</span> YOffset)</span></span>
<span class="line"></span>{</span>
<span class="line">    <span class="hljs-keyword">int</span> Pitch = BitmapWidth * BytesPerPixel;</span>
<span class="line">    u8 *Row = (u8 *)BitmapMemory;</span>
<span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> Y = <span class="hljs-number">0</span>;</span>
<span class="line">         Y &lt; BitmapHeight;</span>
<span class="line">         ++Y)</span>
<span class="line">    {</span>
<span class="line">        u8 *Pixel = (u8 *)Row;</span>
<span class="line">        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> X = <span class="hljs-number">0</span>;</span>
<span class="line">            X &lt; BitmapWidth;</span>
<span class="line">            ++X)</span>
<span class="line">        {</span>
<span class="line">            *Pixel = (u8)(X + XOffset);</span>
<span class="line">            ++Pixel;</span>
<span class="line">            </span>
<span class="line">            *Pixel = (u8)(Y + YOffset);</span>
<span class="line">            ++Pixel;</span>
<span class="line">            </span>
<span class="line">            *Pixel = (u8)Row;</span>
<span class="line">            ++Pixel;</span>
<span class="line">            </span>
<span class="line">            *Pixel = <span class="hljs-number">0</span>;</span>
<span class="line">            ++Pixel;</span>
<span class="line">        }</span>
<span class="line">        Row += Pitch;</span>
<span class="line">    }</span>
<span class="line">}</span></div><span class="line"></span>
<span class="line"><span class="hljs-comment">//...</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span> </span>
<span class="line"><span class="hljs-title">Win32ResizeDIBSection</span><span class="hljs-params">(...)</span></span>
<span class="line"></span>{</span>
<span class="line">    <span class="hljs-comment">// ...</span></span>
<span class="line">    <span class="hljs-keyword">int</span> BytesPerPixel = <span class="hljs-number">4</span>;</span>
<span class="line">    <span class="hljs-keyword">int</span> BitmapMemorySize = BytesPerPixel * BitmapWidth * BitmapHeight;</span>
<span class="line"></span>
<span class="line">    BitmapMemory = VirtualAlloc(<span class="hljs-number">0</span>, BitmapMemorySize, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);</span><div class=" delete"><span class="line">    <span class="hljs-keyword">int</span> Pitch = Width * BytesPerPixel;</span>
<span class="line">    <span class="hljs-comment">//... </span></span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">//...</span></span>
<span class="line">        Row += Pitch;</span>
<span class="line">    }</span></div><div class=" add"><span class="line">    RenderWeirdGradient(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;26:</b> <file>[win32_handmade.cpp]</file> Extracting our rendering code into <code>RenderWeirdGradient</code>.</div></center>
<p>


Compile, and... <code>W:\handmade\code\win32_handmade.cpp(28): error C2065: 'BytesPerPixel': undeclared identifier</code> 

</p><p>

Right, we need to pull out <code>BytesPerPixel</code> as well, that's a constant for now... 

</p><pre class="listing tilde"><code><span class="line">global_variable <span class="hljs-keyword">int</span> BitmapHeight;</span><div class=" add"><span class="line">global_variable <span class="hljs-keyword">int</span> BytesPerPixel;</span></div><span class="line"></span>
<span class="line"><span class="hljs-comment">//...</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-function">internal <span class="hljs-keyword">void</span> </span>
<span class="line"><span class="hljs-title">Win32ResizeDIBSection</span><span class="hljs-params">(...)</span></span>
<span class="line"></span>{</span>
<span class="line">    <span class="hljs-comment">// ...</span></span><div class=" edit"><span class="line">    BytesPerPixel = <span class="hljs-number">4</span>;</span></div><span class="line">    <span class="hljs-keyword">int</span> BitmapMemorySize = BytesPerPixel * BitmapWidth * BitmapHeight;</span>
<span class="line"></span>
<span class="line">    BitmapMemory = VirtualAlloc(<span class="hljs-number">0</span>, BitmapMemorySize, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);</span>
<span class="line">    RenderWeirdGradient(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;27:</b> <file>[win32_handmade.cpp]</file> We have a plan for all these constants we keep extracting, by the way. They won't remain there global forever.</div></center>
<p>


... And we compile and run again! That's a successful refactoring.  Now, where were we? Oh right, we can test if our offset does anything. We can do it by simply supplying it <em class="underscore">some</em> value. Let's give <code>XOffset</code> of 128, to see if the bitmap moves left halfway. 

</p><pre class="listing tilde"><code><div class=" edit"><span class="line">RenderWeirdGradient(<span class="hljs-number">128</span>, <span class="hljs-number">0</span>);</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;28:</b> <file>[win32_handmade.cpp > Win32ResizeDIBSection]</file> Add a half-size horizontal offset.</div></center>
<p>


Compile, run... looks fine!

</p><p>

<center><div class="image" style=""><a href="../media/day4/colortest_3.png" target="_blank"><img class="markdeep" src="../media/day4/colortest_3.png" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;10:</b> Notice how the pattern moved to the right (left?).</span></center></div></center>

</p>
<a class="target" name="preparethemainwindowloopforcontinuousanimation">&nbsp;</a><a class="target" name="renderingapattern/preparethemainwindowloopforcontinuousanimation">&nbsp;</a><a class="target" name="toc5.2">&nbsp;</a><h2>Prepare the Main Window Loop for Continuous Animation</h2>
<p>


One thing that prevents us from running a smooth animation right away is our message loop. You might remember from <a href="day2.html#createwindow/windowmessagequeue">Day 2</a> that <code>GetMessage</code> function inside our <code>WinMain</code> will sit and wait for new messages forever if there aren't any. (actually, Windows will simply halt our process and use the CPU power for some other process). We don't want to wait for Windows to give us work, we're a game which is animating even if there're no messages. So we need to change this call to something that keeps running even if we didn't receive any messages.

</p><p>

We need to implement <a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-peekmessagea">PeekMessageA</a> instead of <code>GetMessage</code>. 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-function">BOOL <span class="hljs-title">PeekMessageA</span><span class="hljs-params">(</span>
<span class="line">  LPMSG lpMsg,</span>
<span class="line">  HWND  hWnd,</span>
<span class="line">  UINT  wMsgFilterMin,</span>
<span class="line">  UINT  wMsgFilterMax, </span>
<span class="line">  UINT  wRemoveMsg</span>
<span class="line">)</span></span>;</span></code></pre><center><div class="listingcaption tilde"><file>MSDN</file> <code>PeekMessageA</code> Syntax</div></center>
<p>


As you can see, it has almost the exact same syntax as <code>GetMessage</code> and mostly the same functionality. The only difference is that, as opposed to <code>GetMessage</code>, it only checks the message queue and, if there're no messages, it keeps running. 

</p><p>

The new parameter at the end is <code>wRemoveMsg</code>, which tells <code>PeekMessage</code> what to do with the message peeked. We want to remove the message from the queue, so we pass <code>PM_REMOVE</code>. 

</p><pre class="listing tilde"><code><span class="line">MSG Message;</span><div class=" edit"><span class="line">BOOL MessageResult = PeekMessageA(&amp;Message, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, PM_REMOVE);</span></div><span class="line"><span class="hljs-keyword">if</span>(MessageResult &gt; <span class="hljs-number">0</span>)</span>
<span class="line">{</span>
<span class="line">    TranslateMessage(&amp;Message);</span>
<span class="line">    DispatchMessage(&amp;Message);</span>
<span class="line">}</span>
<span class="line"><span class="hljs-keyword">else</span></span>
<span class="line">{</span>
<span class="line">    <span class="hljs-keyword">break</span>;</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;29:</b> <file>[win32_handmade.cpp > WinMain]</file> Replacing <code>GetMessage</code> with <code>PeekMessage</code>.</div></center>
<p>


Moreover, if you check the return type, you can see that <code>MessageResult</code> doesn't throw negative values in case invalid handles. It simply returns <code>0</code> if we don't have any messages to process. This means that we can simplify significantly our code. We can say &ldquo;While there're messages in the queue, we'll process them, and then we'll get back to our business.&rdquo; We also don't need to break out of our main <code>Running</code> loop any more, since this is managed by our <code>Win32MainWindowCallback</code>. 

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">while</span> (Running) </span>
<span class="line">{</span>
<span class="line">    MSG Message;</span><div class=" edit"><span class="line">    <span class="hljs-keyword">while</span>(PeekMessageA(&amp;Message, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, PM_REMOVE))</span></div><div class=" delete"><span class="line">    <span class="hljs-keyword">if</span>(MessageResult &gt; <span class="hljs-number">0</span>)</span></div><span class="line">    {</span>
<span class="line">        TranslateMessage(&amp;Message);</span>
<span class="line">        DispatchMessage(&amp;Message);</span>
<span class="line">    }</span><div class=" delete"><span class="line">    <span class="hljs-keyword">else</span></span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-keyword">break</span>;</span>
<span class="line">    }</span></div><span class="line">    <span class="hljs-comment">// We dealt with our messages, now do the rest of our game loop here.</span></span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;30:</b> <file>[win32_handmade.cpp > WinMain]</file> Simplifying message loop.</div></center>
<p>


At one point we might want to limit how many messages are processed at a time, so that a flood of messages doesn't slow down or outright block our program, but this will be a problem that future us will have to tackle. We got to process that queue anyway at some point, might as well do it once per game cycle. 

</p><p>

One thing that we could do to bullet-proof our <code>Running</code> loop, is to double-check each message. If it's <code>WM_QUIT</code>, we set <code>Running</code> to <code>false</code> and subsequently break out: 

</p><pre class="listing tilde"><code><span class="line">MSG Message;</span>
<span class="line"><span class="hljs-keyword">while</span> (PeekMessageA(&amp;Message, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, PM_REMOVE))</span>
<span class="line">{</span><div class=" add"><span class="line">    <span class="hljs-keyword">if</span> (Message.message == WM_QUIT)</span>
<span class="line">    {</span>
<span class="line">        Running = <span class="hljs-literal">false</span>;</span>
<span class="line">    }</span></div><span class="line">    </span>
<span class="line">    TranslateMessage(&amp;Message);</span>
<span class="line">    DispatchMessage(&amp;Message);</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;31:</b> <file>[win32_handmade.cpp > WinMain]</file> Adding an additional check to quit the game.</div></center>

<a class="target" name="ourfirstanimation">&nbsp;</a><a class="target" name="renderingapattern/ourfirstanimation">&nbsp;</a><a class="target" name="toc5.3">&nbsp;</a><h2>Our First Animation</h2>
<p>


If we compile and run, we'll see that the things are roughly exactly the same as they were before. Let's now get to our animation. 

</p><p>

First, let's introduce a couple of variables <code>XOffset</code> and <code>YOffset</code> just outside our main loop. We can then call <code>RenderWeirdGradient</code> after we're done with our message queue and use these variables. Let's say we increment our <code>XOffset</code> at the end of each frame (our main <code>Running</code> loop) so that there's some horizontal movement.

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-keyword">int</span> XOffset = <span class="hljs-number">0</span>; </span>
<span class="line"><span class="hljs-keyword">int</span> YOffset = <span class="hljs-number">0</span>; </span>
<span class="line"></span></div><span class="line">Running = <span class="hljs-literal">true</span>;</span>
<span class="line"><span class="hljs-keyword">while</span> (Running)</span>
<span class="line">{</span>
<span class="line">    MSG Message;</span>
<span class="line">    <span class="hljs-keyword">while</span> (PeekMessageA(...))</span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// ... </span></span>
<span class="line">    }</span>
<span class="line">    </span><div class=" add"><span class="line">    RenderWeirdGradient(XOffset, YOffset);</span>
<span class="line">    ++XOffset;</span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;32:</b> <file>[win32_handmade.cpp > WinMain]</file></div></center>
<p>


We also can remove <code>RenderWeirdGradient</code> from <code>Win32ResizeDIBSection</code>: 

</p><pre class="listing tilde"><code><div class=" delete"><span class="line">RenderWeirdGradient(<span class="hljs-number">128</span>, <span class="hljs-number">0</span>);</span></div></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;33:</b> <file>[win32_handmade.cpp > Win32ResizeDIBSection]</file> Moving <code>RenderWeirdGradient</code> to our main loop.</div></center>
<p>


Now, to our animation! We compile and run! And... nothing happens. We're greeted with some suprematist art of the early XX Century:

</p><p>

<center><div class="image" style=""><a href="../media/day4/colortest_4.png" target="_blank"><img class="markdeep" src="../media/day4/colortest_4.png" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;11:</b> Black Rectangle, bytes on memory, by yourself, 20XX.</span></center></div></center>

</p><p>

Oh, right. We forgot to blit it to the screen. Sure we render our weird gradient to the bitmap, but the bitmap needs to be translated to the window! We call <code>Win32UpdateWindow</code> when we process our <code>WM_PAINT</code> message, but we <em class="underscore">also</em> need to call it when <code>WM_PAINT</code> is not being processed, at the end of each frame. 

</p><p>

So. We call <code>Win32UpdateWindow</code> which takes a Device Context and a client rect. Now, right now we're too busy making our animation happen so we will simply copy and paste the necessary code as we did it before, but we did cut and paste of the same code enough times to realize that we can optimize getting <code>ClientRect</code> out into a separate function. We'll tackle it some other time, just a mental note for the future us.

</p><p>

As for the <code>DeviceContext</code>, we can use <a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getdc">GetDC</a> to get the DC we reserved with our window, and <a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-releasedc">ReleaseDC</a> to return it back to the domain of our window.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">while</span> (Running)</span>
<span class="line">{</span>
<span class="line">    MSG Message;</span>
<span class="line">    <span class="hljs-keyword">while</span> (PeekMessageA(...))</span>
<span class="line">    {</span>
<span class="line">        <span class="hljs-comment">// ... </span></span>
<span class="line">    }</span>
<span class="line">    </span>
<span class="line">    RenderWeirdGradient(XOffset, YOffset);</span>
<span class="line">    ++XOffset;</span><div class=" add"><span class="line"></span>
<span class="line">    HDC DeviceContext = GetDC(Window);</span>
<span class="line">    RECT ClientRect;</span>
<span class="line">    GetClientRect(Window, &amp;ClientRect);</span>
<span class="line">            </span>
<span class="line">    Win32UpdateWindow(DeviceContext, &amp;ClientRect);</span>
<span class="line"></span>
<span class="line">    ReleaseDC(Window, DeviceContext);    </span></div><span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;34:</b> <file>[win32_handmade.cpp > WinMain]</file> Blitting to our window at the end of each frame.</div></center>
<p>


Compile, fix all your errors and run and... we finally have our animation!

</p>
<a class="target" name="recompresspixelto32-bitvalue">&nbsp;</a><a class="target" name="renderingapattern/recompresspixelto32-bitvalue">&nbsp;</a><a class="target" name="toc5.4">&nbsp;</a><h2>Recompress Pixel to 32-bit Value</h2>
<p>


Last quick refactoring for today. If you remember, in Subsection  <a href="#toc4.4">4.4</a> we first set up the <code>Pixel</code> to be a 32-bit value. Now that we know what the color arrangement in memory is, we can return to write 32 bits at a time (this is much faster). We will pack the pixel values on the fly when we'll be writing to the pixel

</p><pre class="listing tilde"><code><div class=" C++ "><span class="line"><span class="hljs-built_in">u8</span>* Row = (<span class="hljs-built_in">u8</span>*)BitmapMemory;</span>
<span class="line"><span class="hljs-keyword">for</span> (int Y...)</span>
<span class="line">{</span></div><div class=" edit"><span class="line">    u32* Pixel = (u32*)Row;</span></div><div class=" C++ "><span class="line">~~~~~~~ C++ </span></div><div class=" C++ "><span class="line">    for (int X...)</span>
<span class="line">    {</span>
<span class="line">        // </span>
<span class="line">        // Pixel in memory: BB GG RR XX</span>
<span class="line">        // </span></div><div class=" delete"><span class="line">        <span class="hljs-comment">// Byte 0, blue</span></span>
<span class="line">        *Pixel = (u8)(X + XOffset);</span>
<span class="line">        ++Pixel;  </span>
<span class="line">    ++Pixel;  </span>
<span class="line">        ++Pixel;  </span>
<span class="line"></span>
<span class="line">        <span class="hljs-comment">// Byte 1, green</span></span>
<span class="line">        *Pixel = (u8)(Y + YOffset);</span>
<span class="line">        ++Pixel;  </span>
<span class="line">    ++Pixel;  </span>
<span class="line">        ++Pixel;  </span>
<span class="line"></span>
<span class="line">        <span class="hljs-comment">// Byte 2, red</span></span>
<span class="line">        *Pixel = <span class="hljs-number">0</span>;</span>
<span class="line">        ++Pixel;  </span>
<span class="line">    ++Pixel;  </span>
<span class="line">        ++Pixel;  </span>
<span class="line"></span>
<span class="line">        <span class="hljs-comment">// Byte 3, pad</span></span>
<span class="line">        *Pixel = <span class="hljs-number">0</span>;</span>
<span class="line">        ++Pixel;  </span>
<span class="line">    ++Pixel;  </span>
<span class="line">        ++Pixel;  </span></div><div class=" add"><span class="line">        u8 Red = <span class="hljs-number">0</span>;</span>
<span class="line">        u8 Green = (u8)(Y + YOffset);</span>
<span class="line">        u8 Blue = (u8)(X + XOffset);</span>
<span class="line"></span>
<span class="line">        *Pixel++ = ; <span class="hljs-comment">// TODO</span></span></div><span class="line">    }</span>
<span class="line">}</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;35:</b> <file>[win32_handmade.cpp > RenderWeirdGradient]</file> Compressing the pixel</div></center>
<p>


We will need to do some <em class="underscore">bit shifting</em>. Using the <code>&lt;&lt;</code> or <code>&gt;&gt;</code> operator we can actually move the bits left or right in the memory by the amount of bits specified. Now, we know that our <code>Pixel</code>'s bits are arranged in the following manner: 

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="144" width="280" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 88,16 L 88,48 " style="fill:none;"/>
<path d="M 88,80 L 88,112 " style="fill:none;"/>
<path d="M 128,16 L 128,48 " style="fill:none;"/>
<path d="M 128,80 L 128,112 " style="fill:none;"/>
<path d="M 168,16 L 168,48 " style="fill:none;"/>
<path d="M 168,80 L 168,112 " style="fill:none;"/>
<path d="M 208,16 L 208,48 " style="fill:none;"/>
<path d="M 208,80 L 208,112 " style="fill:none;"/>
<path d="M 248,16 L 248,48 " style="fill:none;"/>
<path d="M 248,80 L 248,112 " style="fill:none;"/>
<path d="M 88,16 L 248,16 " style="fill:none;"/>
<path d="M 88,48 L 248,48 " style="fill:none;"/>
<path d="M 88,80 L 248,80 " style="fill:none;"/>
<path d="M 88,112 L 248,112 " style="fill:none;"/>
<g transform="translate(0,0)"><text text-anchor="middle" x="88" y="4">0</text><text text-anchor="middle" x="128" y="4">8</text><text text-anchor="middle" x="168" y="4">1</text><text text-anchor="middle" x="176" y="4">6</text><text text-anchor="middle" x="208" y="4">2</text><text text-anchor="middle" x="216" y="4">4</text><text text-anchor="middle" x="248" y="4">3</text><text text-anchor="middle" x="256" y="4">2</text><text text-anchor="middle" x="8" y="36">R</text><text text-anchor="middle" x="16" y="36">e</text><text text-anchor="middle" x="24" y="36">g</text><text text-anchor="middle" x="32" y="36">i</text><text text-anchor="middle" x="40" y="36">s</text><text text-anchor="middle" x="48" y="36">t</text><text text-anchor="middle" x="56" y="36">e</text><text text-anchor="middle" x="64" y="36">r</text><text text-anchor="middle" x="72" y="36">:</text><text text-anchor="middle" x="104" y="36">x</text><text text-anchor="middle" x="112" y="36">x</text><text text-anchor="middle" x="144" y="36">R</text><text text-anchor="middle" x="152" y="36">R</text><text text-anchor="middle" x="184" y="36">G</text><text text-anchor="middle" x="192" y="36">G</text><text text-anchor="middle" x="224" y="36">B</text><text text-anchor="middle" x="232" y="36">B</text><text text-anchor="middle" x="24" y="100">M</text><text text-anchor="middle" x="32" y="100">e</text><text text-anchor="middle" x="40" y="100">m</text><text text-anchor="middle" x="48" y="100">o</text><text text-anchor="middle" x="56" y="100">r</text><text text-anchor="middle" x="64" y="100">y</text><text text-anchor="middle" x="72" y="100">:</text><text text-anchor="middle" x="104" y="100">B</text><text text-anchor="middle" x="112" y="100">B</text><text text-anchor="middle" x="144" y="100">G</text><text text-anchor="middle" x="152" y="100">G</text><text text-anchor="middle" x="184" y="100">R</text><text text-anchor="middle" x="192" y="100">R</text><text text-anchor="middle" x="224" y="100">X</text><text text-anchor="middle" x="232" y="100">X</text></g></g></svg><center><div class="imagecaption"><a class="target" name="figure_pixel3">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;12:</b> Pixel bits as seen in memory and in register.</div></center>

</p><p>

If you look at the memory layout in the figure above, we will know exactly by how many bits must we shift to the left each value to pack our pixel in one go. Let's compute this in, combining the shifted values with the bitwise OR: <code>|</code>

</p><pre class="listing tilde"><code><span class="line">u8 Red = <span class="hljs-number">0</span>;</span>
<span class="line">u8 Green = (u8)(Y + YOffset);</span>
<span class="line">u8 Blue = (u8)(X + XOffset);</span>
<span class="line"></span><div class=" edit"><span class="line">~~~~~~~ C++ edit</span></div></code></pre><p>
~~~~~~~

</p>
<a class="target" name="recap">&nbsp;</a><a class="target" name="recap">&nbsp;</a><a class="target" name="toc6">&nbsp;</a><h1>Recap</h1>
<p>


We've came a long way in this course already. From when we've got our environment up and running to get an animated window on the screen using our own code on the Win32, where we can write now anything we want.... People say that it takes a lot of work to get something running on Windows but we proved otherwise. It's a lot of knowledge, yes, but once you've got the knowledge you can run through all the chapters pretty quickly. To recap only today, this is what we did: 

</p><p>

<ol start=1>
<li class="number">We removed some unnecessary stuff from our buffer functions.
</li>
<li class="number">Allocated some memory for our buffer.
</li>
<li class="number">Updated <code>StretchDIBits</code> to take full window width and height instead of just a piece.
</li>
<li class="number">Defined the way we would draw our bitmap
</li>
<li class="number">Created our pixel loop
</li>
<li class="number">Made a simple gradient rendering function and
</li>
<li class="number">Animated it!</li></ol>

</p><p>

Next time, we will be do a massive cleanup of the work done so far, so that we can move to new subjects the chapter after.

</p><p>

<center><div class="image" style=""><a href="../media/day4/animation.gif" target="_blank"><img class="markdeep" src="../media/day4/animation.gif" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;13:</b> Animated weird gradient.</span></center></div></center>

</p>
<a class="target" name="exercises">&nbsp;</a><a class="target" name="exercises">&nbsp;</a><a class="target" name="toc7">&nbsp;</a><h1>Exercises</h1>

<a class="target" name="drawotherweirdgradients">&nbsp;</a><a class="target" name="exercises/drawotherweirdgradients">&nbsp;</a><a class="target" name="toc7.1">&nbsp;</a><h2>Draw Other Weird Gradients</h2>
<p>


Get creative! What happens if you change the <code>RenderWeirdGradient</code> formula? For example, if you put <code>XOffset</code> in the red channel? What if you do some other math operation on them? Play around and see which bizarre animations can you get.

</p>
<a class="target" name="programmingbasics">&nbsp;</a><a class="target" name="programmingbasics">&nbsp;</a><a class="target" name="toc8">&nbsp;</a><h1>Programming Basics</h1>

<a class="target" name="virtualmemoryvs.physicalmemory">&nbsp;</a><a class="target" name="programmingbasics/virtualmemoryvs.physicalmemory">&nbsp;</a><a class="target" name="toc8.1">&nbsp;</a><h2>Virtual Memory vs. Physical Memory</h2>
<p>


Physical memory is a complicated thing. If you think of it, memory constantly moves around the HDD/SSDs, Main Memory, &ldquo;Cache&rdquo; memory of the CPU, etc. This is confusing and complicated. So what the operating systems usually do is to abstract it all away for the benefit of the programs into the Virtual Memory.

</p><p>

Virtual Memory is simple. It's a flat array of addresses, and programs (and therefore, programmers such as yourself) don't care where exactly your data currently sits. Each program has a 64-bit address space (in the 64-bit OSes, of course) where all its data, functions, and other good stuff resides. Even stuff belonging to the other running programs! Programs have access only access to some pieces of this address space at a time, and the OS manages allocation of more or less memory for them. 

</p><p>

<em class="underscore">(Continue to Subsection  <a href="#toc2.2">2.2</a>)</em>

</p>
<a class="target" name="typecasting">&nbsp;</a><a class="target" name="programmingbasics/typecasting">&nbsp;</a><a class="target" name="toc8.2">&nbsp;</a><h2>Type Casting</h2>
<p>

Converting one data type into another is known as <em class="underscore">casting</em>. It is performed by using the cast operator (<code>()</code>) placed before the value to cast. From there on, C will treat the bits in that value as if they were of the casted type.

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">int</span> Value = <span class="hljs-number">56523565</span>;       <span class="hljs-comment">// 32-bit value</span></span>
<span class="line"><span class="hljs-keyword">char</span> Byte = (<span class="hljs-keyword">char</span>)Value;    <span class="hljs-comment">// Take only in the first 8 bits of our value</span></span></code></pre><center><div class="listingcaption tilde"><file>[Example]</file> The simplest application of type casting</div></center>
<p>


A common application of type casting is to perform floating-point math or pointer arithmetic, but there're many others that we will see throughout this course.

</p><p>

<em class="underscore">(Continue to Subsection  <a href="#toc4.3">4.3</a>)</em>

</p>
<a class="target" name="hexadecimal">&nbsp;</a><a class="target" name="programmingbasics/hexadecimal">&nbsp;</a><a class="target" name="toc8.3">&nbsp;</a><h2>Hexadecimal</h2>
<p>

When reading bytes, it's common to use the so-called &ldquo;hex format&rdquo;, where the numbers are represented with 16 distinct symbols, as opposed to the common 10. 

</p><p>

The reason for it is that 8 bits of binary translate very nicely to hexadecimal. Any value of a single byte can be represented with a pair of hexadecimal numbers ranging from <code>00</code> to <code>FF</code>. In decimal, the same byte would range from <code>000</code> to <code>255</code>, while in binary it obviously ranges from <code>0000 0000</code> to <code>1111 1111</code>.

</p><p>

If you are completely unfamiliar with Hexadecimal, you can simply boot up Windows Calculator and select Programmer Mode. You can type in different values in Decimal and convert them to Hex, and vice versa.

</p><p>

<center><div class="image" style=""><a href="../media/day4/calculator.png" target="_blank"><img class="markdeep" src="../media/day4/calculator.png" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;14:</b> Calculator in Windows 10. Note that you can click <code>HEX</code> and <code>DEC</code> buttons to switch from one base to another.</span></center></div></center>

</p><p>

Another common application for hex format that you might be familiar with is RGB color representation in image editors and on the web. 

</p><p>

<center><div class="image" style=""><a href="../media/day3/colorcop.png" target="_blank"><img class="markdeep" src="../media/day3/colorcop.png" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;15:</b> Hex color value in Color cop. Red's <code>255</code> corresponds to <code>FF</code>, Green's <code>0</code> to <code>00</code>, while Blue's <code>255</code> to <code>FF</code>.</span></center></div></center>

</p><p>

You can quickly distinguish the &ldquo;Hex code&rdquo; of a color by a <code>#</code> follow by six hexadecimal characters (<code>0 1 2 3 4 5 6 7 8 9 A B C D E F</code>). 

</p><p>

<em class="underscore">(Back to Subsection  <a href="#toc4.5.1">4.5.1</a>)</em>

</p>
<a class="target" name="pre-incrementandpost-incrementoperator">&nbsp;</a><a class="target" name="programmingbasics/pre-incrementandpost-incrementoperator">&nbsp;</a><a class="target" name="toc8.4">&nbsp;</a><h2>Pre-increment and Post-increment operator</h2>
<p>


You'll notice that sometimes we put <code>++</code> operator before the variable, and sometimes after. This actually has a meaning. 

</p><p>

In and of itself, <code>++</code> operator increases the value by 1 and reassigns the result to the variable. That is, it's analagous to writing <code>Value = Value + 1;</code>. However, its position before or after the variable can matter if the increment happens during another operation.

</p><p>

Consider two examples:

</p><pre class="listing tilde"><code><span class="line"><span class="hljs-keyword">int</span> ExampleOne = <span class="hljs-number">7</span>;</span>
<span class="line"><span class="hljs-keyword">int</span> ExampleTwo = <span class="hljs-number">7</span>;</span>
<span class="line"></span>
<span class="line"><span class="hljs-built_in">printf</span>(++ExampleOne);</span>
<span class="line"><span class="hljs-built_in">printf</span>(ExampleTwo++);</span></code></pre><p>

What will be the print output? 

</p><p>

In <code>ExampleOne</code>, the result would be <code>8</code>. This is because the addition happens first, and the rest of the operation after. However, in <code>ExampleTwo</code> the addition will happen <em class="underscore">after</em> <code>printf</code>, so the result that will be printed will be <code>7</code>. At the end of the day, both values would be <code>8</code>, but we used them in a different way in the meantime.

</p><p>

Also, <code>--</code> operator functions in the similar way but with the decrement.

</p>
<a class="target" name="sideconsiderations">&nbsp;</a><a class="target" name="sideconsiderations">&nbsp;</a><a class="target" name="toc9">&nbsp;</a><h1>Side Considerations</h1>

<a class="target" name="build.bat:requestmsvctogivefullpaths">&nbsp;</a><a class="target" name="sideconsiderations/build.bat:requestmsvctogivefullpaths">&nbsp;</a><a class="target" name="toc9.1">&nbsp;</a><h2><code>build.bat</code>: Request MSVC to Give Full Paths</h2>
<p>


If you ever encountered compiler errors so far (if you are following along we're fairly confident you did!), you might have noticed that each error is prefixed by its <em class="underscore">relative</em> path to the code: 

</p><pre class="listing tilde"><code><span class="line">..\code\win32_handmade.cpp(##): error C####</span></code></pre><p>

Now, if you use <a href="https://4coder.itch.io/4coder">4coder</a>, you have an option to use <code>Alt-N</code> to jump to the next or <code>Alt-Shift-N</code> to jump to the previous error in your <code>build.bat</code> (in <a href="https://code.visualstudio.com/">vscode</a>, you can jump to the next error by <code>Ctrl-Click</code> on the address inside Terminal). In order to do so however, you need to provide <em class="underscore">absolute</em> paths to the source files. Luckily, there's an option to do just that: <a href="https://docs.microsoft.com/en-us/cpp/build/reference/fc-full-path-of-source-code-file-in-diagnostics">-FC</a>. Let's quickly edit our <code>build.bat</code> before we move on: 

</p><pre class="listing tilde"><code><span class="line">@echo off</span>
<span class="line"></span>
<span class="line">mkdir build</span>
<span class="line">pushd build</span>
<span class="line"></span><div class=" edit"><span class="line">cl -FC -Zi ..\code\win32_handmade.cpp user32.lib gdi32.lib</span></div><span class="line"></span>
<span class="line">popd</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;36:</b> <file>[build.bat]</file> Adding -FC compiler option.</div></center>
<p>


<center><div class="image" style=""><a href="../media/day4/build_fc.png" target="_blank"><img class="markdeep" src="../media/day4/build_fc.png" /></a><center><span class="imagecaption"><a class="target" name="figure_x">&nbsp;</a><b style="font-style:normal;">Figure&nbsp;16:</b> You can now jump to your errors.</span></center></div></center>

</p>
<a class="target" name="introductiontoalignment">&nbsp;</a><a class="target" name="sideconsiderations/introductiontoalignment">&nbsp;</a><a class="target" name="toc9.2">&nbsp;</a><h2>Introduction to Alignment</h2>
<p>


Let's review our Bitmap Info Header:

</p><pre class="listing tilde"><code><span class="line">BITMAPINFO BitmapInfo = {};</span>
<span class="line"></span>
<span class="line">BitmapInfo.bmiHeader.biSize = <span class="hljs-keyword">sizeof</span>(BitmapInfo.bmiHeader);</span>
<span class="line">BitmapInfo.bmiHeader.biWidth = Width;</span>
<span class="line">BitmapInfo.bmiHeader.biHeight = Height;</span>
<span class="line">BitmapInfo.bmiHeader.biPlanes = <span class="hljs-number">1</span>;</span>
<span class="line">BitmapInfo.bmiHeader.biBitCount = <span class="hljs-number">32</span>;</span>
<span class="line">BitmapInfo.bmiHeader.biCompression = BI_RGB;</span></code></pre><center><div class="listingcaption tilde"><a class="target" name="listing_x">&nbsp;</a><b style="font-style:normal;">Listing&nbsp;37:</b> <file>[win32_handmade.cpp > Win32ResizeDIBSection]</file> BitmapInfo header structure.</div></center>
<p>


One thing to note is that <code>biBitCount</code>. We said that we need 3 bytes to draw an RGB pixel: one for red, one for green, and one for blue channels. \(3 \cdot\ 8 = 24\), so where does the extra byte come from? 

</p><p>

It has to do what memory alignment. In general, on the <code>x86</code> architecture there is often a penalty for doing the so-called <em class="underscore">unaligned memory access</em>. Whenever you make an operation on a value, its actual position in memory should begin at the multiple of its size (8 bit, 16 bit, 32 bit, etc.). For instance, the 32-bit values (which are 4 bytes long) should start at the bytes 0, 4, 8, 12, etc. They shouldn't begin at, for example, the 2nd byte, or the 5th byte. 

</p><p>

In other words, the processor will spend (quite a bit of) time realigning any non-aligned value before processing it. 

</p><p>

In our case, whenever we do an operation on a pixel, especially to simplify the things, we want to access it on an 4-byte boundary. So if we want to ask only for the bits we need to insert R, G and B values, i.e. 24 bytes, 3 bytes are in no way aligned to 4, so constant adjustment will be required. So the extra 8 bits will simply be padding. They don't mean anything and they will not be used, and their sole purpose will be to align the rest of the pixel to the 4-byte boundary.

</p><p>

<em class="underscore">(Back to Subsection  <a href="#toc2.1">2.1</a>)</em>

</p>
<a class="target" name="raii">&nbsp;</a><a class="target" name="sideconsiderations/raii">&nbsp;</a><a class="target" name="toc9.3">&nbsp;</a><h2>RAII</h2>
<p>


If you would like to try RAII (Resource Acquisition Is Initialization), Subsection  <a href="#toc5.3">5.3</a> would be one of the few places where it would be appropriate. You could then have something like: 

</p><pre class="listing tilde"><code><div class=" add"><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DC</span></span>
<span class="line">{</span></span>
<span class="line">    <span class="hljs-keyword">public</span>:</span>
<span class="line">        HDC Handle;</span>
<span class="line">        DC(HWND Window) <span class="hljs-comment">// Constructor, called during object creation</span></span>
<span class="line">        {</span>
<span class="line">            m_Window = Window;</span>
<span class="line">            Handle = GetDC(m_Window);</span>
<span class="line">        }</span>
<span class="line">        ~DC()           <span class="hljs-comment">// Destructor, called when exiting scope</span></span>
<span class="line">        {</span>
<span class="line">            ReleaseDC(m_Window, Handle);</span>
<span class="line">        }</span>
<span class="line">    <span class="hljs-keyword">private</span>:</span>
<span class="line">        HWND m_Window;</span>
<span class="line">};</span></div><span class="line"><span class="hljs-comment">//...</span></span>
<span class="line"></span>
<span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> CALLBACK</span>
<span class="line"><span class="hljs-title">WinMain</span><span class="hljs-params">(...)</span></span>
<span class="line"></span>{</span>
<span class="line">    <span class="hljs-comment">//...</span></span><div class=" edit    "><span class="line">    {</span>
<span class="line">        DC DeviceContext {Window};</span>
<span class="line"></span>
<span class="line">        RECT ClientRect;</span>
<span class="line">        GetClientRect(Window, &amp;ClientRect);</span>
<span class="line">        </span>
<span class="line">        Win32UpdateWindow(DeviceContext.Handle, &amp;ClientRect);</span>
<span class="line">    } <span class="hljs-comment">// No need to call destructor, it will be called automatically when exiting the block</span></span></div><span class="line">}</span></code></pre><p>

Every programming pattern, feature or system has its place; it's the dogma that catches you. Try not to get into the dogma because you don't want to go the same route all the time, you need to know <em class="underscore">when</em> to use things. 

</p>
<a class="target" name="bitblit">&nbsp;</a><a class="target" name="sideconsiderations/bitblit">&nbsp;</a><a class="target" name="toc9.4">&nbsp;</a><h2>Bit Blit</h2>
<p>


There's a function which does direct blitting to the screen, called <code>BitBlt</code>. <a href="https://docs.microsoft.com/en-us/windows/win32/api/wingdi/nf-wingdi-bitblt">BitBlt</a> was born around Windows 3.x in the early '90s, with an API <a href="https://en.wikipedia.org/wiki/WinG">WinG</a> created to write &ldquo;directly to display memory&rdquo; from a bitmap, which resulted in much faster game rendering times. Of course, at this point it largely makes no difference, but <em class="underscore">it is</em> marginably faster than <code>StretchDIBits</code>, simply because there's no resizing required, it's a straight DC to DC copy.

</p><p>

<div class="admonition ">Specifically for Windows, it's <b>D</b>evice <b>C</b>ontexts (DC) all the way down until we hit the <em class="underscore">drivers</em>.</div>

</p><p>

As our program is written right now, it's a matter of a personal taste which blitting method to use. Our plan is anyway to transition away from GDI and to the hardware-accelerated rendering anyway, so whichever you pick is fine. We will stick to <code>StretchDIBits</code> but, if you'd like to transition to <code>BitBlt</code>, keep in mind the following: 

</p><p>

<ul>
<li class="asterisk">Bitmap Info doesn't need to be stored globally, we can have it as a local variable inside <code>Win32ResizeDIBSection</code>.
</li>
<li class="asterisk">You need to <em class="underscore">select</em> your bitmap before drawing it. You can do it by using <code>SelectObject</code> function (<a href="https://docs.microsoft.com/en-us/windows/win32/api/wingdi/nf-wingdi-selectobject">MSDN</a>).</li></ul>

</p><p>

This is how a potential refactoring would look like: 

</p><p>

<div class="admonition warning"><div class="admonition-title"> </div>

</p><p>

    Keep in mind that you will then need to still keep track of Windows-specific DeviceContext, Bitmap Handle! The following section would not necessarily apply to you then, and additional ramifications might appear to your code in the future.</div>

</p><pre class="listing tilde"><code><div class=" delete"><span class="line">    SelectObject(BitmapDeviceContext, BitmapHandle);</span>
<span class="line">    BitBlt(DeviceContext,</span>
<span class="line">           X, Y, Width, Height,</span>
<span class="line">           BitmapDeviceContext, X, Y, SRCCOPY);</span></div></code></pre><center><div class="listingcaption tilde"><file>[Hypothetic win32_handmade.cpp > Win32UpdateWindow]</file> A possible <code>BitBlt</code> implementation.</div></center>
<p>






<div class="admonition trivia"><div class="admonition-title"> Why so many similar calls? </div>

</p><p>

    It's easy to sit in 2020 and wonder why would someone need multiple blit calls in 1994. But the reality at the time was that <code>BitBlt</code> was objectively faster at the time, and allowed the DOS games to run on Windows <em class="underscore">almost</em> at the same framerate as on DOS. Since Windows could do the allocation of memory and had the correct device context already selected, it was a faster path than going through <code>StretchDIBits</code>. 

</p><p>

    For the original discussion on this point, check out <a href="https://twitter.com/checker/status/535316695330873344">this tweet</a> by <a href="https://en.wikipedia.org/wiki/Chris_Hecker">Chris Hecker</a>, the creator of WinG. For more some more info regarding the bitmap functions, <a href="https://hero.handmade.network/forums/code-discussion/t/3444-bitmap_functions">check out this discussion</a> on Handmade.Network.</div>

</p>
<a class="target" name="navigation">&nbsp;</a><a class="target" name="navigation">&nbsp;</a><a class="target" name="toc10">&nbsp;</a><h1>Navigation</h1>
<p>


Previous: <a href="day3.html">Day 3. Allocating a Back Buffer</a>

</p><p>

Up Next: <a href="day5.html">Day 5. Windows Graphics Review</a>

</p><p>

<a href="../index.md.html">Back to Index</a>

</p>
<div class="nonumberh1">Glossary</div>
<p>


<ul>
<li class="asterisk">Bit Blit: a data operation commonly used in computer graphics in which several bitmaps are combined into one using a boolean function. 
</li>
<li class="asterisk">Dirty Rectangle Update
</li>
<li class="asterisk">Hardware Driver
</li>
<li class="asterisk">Hexadecimal
</li>
<li class="asterisk">Pitch / Stride
</li>
<li class="asterisk">Pointer Arithmetic
</li>
<li class="asterisk">Type Casting
</li>
<li class="asterisk">Unaligned Memory Access</li></ul>

</p>
<div class="nonumberh1">References</div>

<div class="nonumberh1">Articles</div>
<p>


<a href="https://en.wikipedia.org/wiki/Endianness">Endianness</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/medfound/image-stride">Image Stride</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/memory/comparing-memory-allocation-methods">Comparing Memory Allocation Methods</a>

</p><p>

<a href="https://www.cplusplus.com/reference/cstdint/">stdint.h</a>

</p><p>

<a href="https://en.cppreference.com/w/cpp/language/raii">RAII</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/memory/working-with-pages">Working With Pages</a>

</p>
<div class="nonumberh1">API Reference</div>
<p>


<a href="https://docs.microsoft.com/en-us/windows/win32/api/wingdi/nf-wingdi-bitblt">BitBlt</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/wingdi/nf-wingdi-createdibsection">CreateDIBSection</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getdc">GetDC</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapalloc">HeapAlloc</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-peekmessagea">PeekMessageA</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-releasedc">ReleaseDC</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/wingdi/nf-wingdi-selectobject">SelectObject</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/wingdi/nf-wingdi-stretchdibits">StretchDIBits</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc">VirtualAlloc</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualfree">VirtualFree</a>

</p><p>

<a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-VirtualProtect">VirtualProtect</a>

</p>
<div class="nonumberh1">Compiler Options</div>
<p>


<a href="https://docs.microsoft.com/en-us/cpp/build/reference/fc-full-path-of-source-code-file-in-diagnostics">-FC</a> Provides full path of source code file in diagnostics

</p><p>

<style class="fallback">
  body {
    visibility: hidden;
    font-family: sans-serif;
  }
</style>

</p><p>

<script>markdeepOptions = { tocStyle: 'long' }; window.alreadyProcessedMarkdeep || (document.body.style.visibility = 'visible');</script>
</stdint.h></windows.h></p></span><div id="mdContextMenu" style="visibility:hidden"></div><div class="markdeepFooter"><i>formatted by <a href="https://casual-effects.com/markdeep" style="color:#999">Markdeep&nbsp;1.10&nbsp;&nbsp;</a></i><div style="display:inline-block;font-size:13px;font-family:'Times New Roman',serif;vertical-align:middle;transform:translate(-3px,-1px)rotate(135deg);">&#x2712;</div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>